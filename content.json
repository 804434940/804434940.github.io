{"pages":[{"title":"æ–‡ç« åˆ†ç±»","text":"","link":"/categories/index.html"},{"title":"","text":"å›¾ç‰‡æœé›†äºäº’è”ç½‘ï¼Œä¾µæƒè¯·ç•™è¨€ï¼Œé©¬ä¸Šå¤„ç†ğŸ˜Šã€‚","link":"/gallery/index.html"},{"title":"ç›¸å†Œ","text":"","link":"/photo/index.html"},{"title":"æ ‡ç­¾","text":"","link":"/tags/index.html"}],"posts":[{"title":"dockerå®‰è£…ES","text":"123456789101112131415161718192021222324docker pull elasticsearch:6.4.0 //å†ä½å°±æ˜¯5.xäº†1.vim /etc/security/limits.d/90-nproc.conf æ·»åŠ ï¼šsoft nproc 40962. vim /etc/sysctl.conf æ·»åŠ vm.max_map_count=655360 æ‰§è¡Œsysctl -påˆ·æ–°é…ç½®//æ ¹æ®è‡ªå·±çš„å†…å­˜å¤§å°é€‚å½“è°ƒæ•´ï¼Œå¤ªå¤§ä¼šå¯åŠ¨å¤±è´¥3.docker run -e ES_JAVA_OPTS=\"-Xms512m -Xmx512m\" -d -p 9200:9200 -p 9300:9300 --name=myES å®¹å™¨id4.docker exec -it å®¹å™¨å /bin/bash è¿›å…¥å®¹å™¨å‘½ä»¤è¡Œ5.vim config/elasticsearch.yml åœ°å€æ”¹ä¸º0.0.0.0å¯èƒ½ä¼švimä¸å¯ç”¨ æ‰§è¡Œ yum update yum install -y vim6.å®‰è£…ikåˆ†è¯å™¨å…ˆä¸Šä¼ åˆ°å®¿ä¸»æœºï¼Œå†ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤copyåˆ°å®¹å™¨ä¸­docker cp å®¿ä¸»æœºikåˆ†è¯å™¨åœ°å€ å®¹å™¨å:/usr/share/elasticsearch/plugins/ik","link":"/posts/20200106-docker_es.html"},{"title":"centos7æŸ¥çœ‹é˜²ç«å¢™ä»¥åŠå¼€æ”¾å’Œå…³é—­ç«¯å£","text":"æŸ¥çœ‹æŸä¸ªç«¯å£æ˜¯å¦å¼€æ”¾ 1firewall-cmd --query-port=22122/tcp yes/no å¼€æ”¾/æœªå¼€æ”¾ å¼€æ”¾æŒ‡å®šç«¯å£1firewall-cmd --add-port=22122/tcp --permanent firewall-cmd â€“zone=public â€“add-port=80/tcp â€“permanent-zone #ä½œç”¨åŸŸ-permanent æ²¡æœ‰è¯¥å‚æ•°é‡å¯åå¤±æ•ˆ é‡æ–°åŠ è½½ç«¯å£ï¼š 1firewall-cmd --reload 3.å…³é—­æŸä¸ªç«¯å£ 1firewall-cmd --permanent --remove-port=22122/tcp é‡æ–°åŠ è½½ 4. æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ 123firewall-cmd --stateæˆ–è€…:systemctl status firewalld æ‰“å¼€/å…³é—­é˜²ç«å¢™ å¯åŠ¨ï¼šsystemctl start firewalldå…³é—­ï¼š systemctl stop firewalldå¼€æœºå¯ç”¨ ï¼š systemctl enable firewalldç¦æ­¢firewallå¼€æœºå¯åŠ¨ ï¼šsystemctl disable firewalld.serviceå¯åŠ¨æœåŠ¡ï¼šsystemctl start firewalld.serviceå…³é—­æœåŠ¡ï¼šsystemctl stop firewalld.serviceé‡å¯æœåŠ¡ï¼šsystemctl restart firewalld.service æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ 1netstat -anp æŸ¥çœ‹é˜²ç«å¢™å·²å¼€æ”¾çš„ç«¯å£ 1firewall-cmd --list-ports","link":"/posts/20200107-centos7_firewall.html"},{"title":"hexoå‹ç¼©é™æ€èµ„æº","text":"1.å®‰è£…gulp1.1é¦–å…ˆå…¨å±€å®‰è£…gulp1npm install gulp -g 1.2 å†å±€éƒ¨å®‰è£…ç›¸å…³æ’ä»¶1npm install gulp-imagemin gulp gulp-minify-css gulp-minify-html gulp-uglify -- 1234567# è§£å†³ã€Gulpæ‰“åŒ…é—®é¢˜ã€‘ GulpUglifyError: unable to minify JavaScript# è§£å†³ gulp-uglify å‹ç¼©JavaScript ä¸å…¼å®¹ es5 è¯­æ³•çš„é—®é¢˜npm install babel-core@6.26.3 --savenpm install gulp-babel@7.0.1 --savenpm install babel-preset-es2015@6.24.1 --save# gulp-babel å–æ¶ˆä¸¥æ ¼æ¨¡å¼æ–¹æ³•(\"use strict\")npm install babel-plugin-transform-remove-strict-mode --save 2.åœ¨ç½‘ç«™æ ¹ç›®å½•åˆ›å»ºgulpfile.jsæ–‡ä»¶ï¼Œç”¨æ¥é…ç½®å‹ç¼©1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859var gulp = require('gulp');//Pluginsæ¨¡å—è·å–var minifycss = require('gulp-minify-css');var uglify = require('gulp-uglify');var minifyhtml = require('gulp-minify-html');var imagemin = require('gulp-imagemin')var babel = require('gulp-babel');// å‹ç¼© public ç›®å½• cssæ–‡ä»¶gulp.task('minify-css', function () { return gulp.src('./public/**/*.css') .pipe(minifycss()) .pipe(gulp.dest('./public'));});// å‹ç¼© public ç›®å½• htmlæ–‡ä»¶gulp.task('minify-html', function () { return gulp.src('./public/**/*.html') .pipe(minifyhtml()) .pipe(gulp.dest('./public'))});// å‹ç¼©jsæ–‡ä»¶gulp.task('minify-js', function (done) { return gulp.src(['./public/**/*.js', '!./public/**/*.min.js','!./public/js/src/snow.js']) .pipe(babel({ //å°†ES6ä»£ç è½¬è¯‘ä¸ºå¯æ‰§è¡Œçš„JSä»£ç  presets: [['es2015',{strict:false}]] // es5æ£€æŸ¥æœºåˆ¶ })) .pipe(uglify()) .pipe(gulp.dest('./public')); done();});// å‹ç¼©public/posts ç›®å½• å›¾ç‰‡æ–‡ä»¶gulp.task('minify-img', function () { return gulp.src(['./public/images/**/*.*','./source/gallery/**']) .pipe(imagemin( [ imagemin.gifsicle({ 'optimizationLevel': 3 }), imagemin.jpegtran({ 'progressive': true }), imagemin.optipng({ 'optimizationLevel': 7 }), imagemin.svgo() ], { 'verbose': true })) .pipe(gulp.dest('./public'))});// åˆ†åˆ«æ‰§è¡Œcssã€hemlã€jså’Œå›¾ç‰‡çš„å‹ç¼©ä»»åŠ¡gulp.task('build', gulp.series('minify-css', 'minify-html', 'minify-js', 'minify-img')); 3.åœ¨ç½‘ç«™æ ¹ç›®å½•åˆ›å»º.babelrc1234{ 'presets': ['es2015'], \"plugins\": [\"transform-remove-strict-mode\"]} 4.æ‰§è¡Œå‹ç¼©1hexo clean&amp;&amp;hexo g &amp;&amp;gulp build ä¸å…¼å®¹ES5çš„è§£å†³å‚è€ƒ:https://segmentfault.com/a/1190000019842178?utm_source=tag-newest","link":"/posts/20200111-hexo-gulp.html"},{"title":"jibæ‰“åŒ…é¡¹ç›®åˆ°é˜¿é‡Œé•œåƒ","text":"â€‹ Jib å°†å¤„ç†å°†åº”ç”¨æ‰“åŒ…åˆ°å®¹å™¨é•œåƒè¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼Œå®ƒç›´æ¥ä¸ Maven å’Œ Gradle Java å¼€å‘ç¯å¢ƒé›†æˆï¼Œä¸éœ€è¦ä½ ç¼–å†™ Dockerfile æˆ–å®‰è£… Dockerï¼ˆä½†æƒ³è¦è¿è¡Œè¿˜æ˜¯è¦æœ¬åœ°å®‰è£…dockerï¼‰ ï¼Œåªéœ€å°†å…¶ä½œä¸ºæ’ä»¶æ·»åŠ åˆ°ä½ çš„æ„å»ºä¸­ï¼Œå°±å¯ä»¥ç«‹å³å°† Java åº”ç”¨å®¹å™¨åŒ–ã€‚ å›¾ç‰‡æ¥æºäºhttps://www.oschina.net/news/97892/google-opensource-jib ä¸€ã€åœ¨pomæ–‡ä»¶ä¸­å¼•å…¥jibæ’ä»¶1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;com.google.cloud.tools&lt;/groupId&gt; &lt;artifactId&gt;jib-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.7.0&lt;/version&gt; &lt;configuration&gt; &lt;!--æ‹‰å–çš„é•œåƒçš„é…ç½®ï¼Œé»˜è®¤ä¸ºgcr.io/distroless/java--&gt; &lt;from&gt; &lt;image&gt;åŸºç¡€é•œåƒåœ°å€&lt;/image&gt; &lt;auth&gt; &lt;username&gt;é˜¿é‡Œäº‘ç”¨æˆ·å&lt;/username&gt; &lt;password&gt;é˜¿é‡Œäº‘å¯†ç &lt;/password&gt; &lt;/auth&gt; &lt;/from&gt; &lt;to&gt; &lt;image&gt;åŸºç¡€é•œåƒåœ°å€&lt;/image&gt; &lt;auth&gt; &lt;username&gt;é˜¿é‡Œäº‘ç”¨æˆ·å&lt;/username&gt; &lt;password&gt;é˜¿é‡Œäº‘å¯†ç &lt;/password&gt; &lt;/auth&gt; &lt;tags&gt; &lt;tag&gt;ç‰ˆæœ¬å·&lt;/tag&gt; &lt;/tags&gt; &lt;/to&gt; &lt;allowInsecureRegistries&gt;true&lt;/allowInsecureRegistries&gt; &lt;/configuration&gt; &lt;executions&gt; &lt;execution&gt; &lt;phase&gt;package&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;build&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; ç‰ˆæœ¬å·è¿™é‡Œä¸€å¼€å§‹æŒ‡å®šçš„è‡ªå®šä¹‰ç‰ˆæœ¬ï¼Œä½†æ˜¯ä½¿ç”¨jib:buildæ—¶æŠ¥é”™ï¼Œè¯´æ‰¾ä¸åˆ°latestç‰ˆæœ¬ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯é»˜è®¤æ‹‰å–latestï¼Œä½†æ˜¯ç½‘ä¸Šå…¶ä»–åšä¸»å¥½åƒå¹¶æ²¡æœ‰è¿™ä¸ªæƒ…å†µï¼Œè¿™é‡Œå°±åªå¥½å°†tagè®¾ä¸ºlatestäº† äºŒã€githubåˆ›å»ºä»“åº“æ·»åŠ Dockerfileæ–‡ä»¶ ä¸‰ã€é˜¿é‡Œäº‘åˆ›å»ºé•œåƒä»“åº“3.1 åˆ›å»ºä»“åº“ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œæ ¹æ®æç¤ºé€‰æ‹©Dockerfileæ‰€åœ¨ä»“åº“ è¿›å…¥æ–°åˆ›å»ºçš„ä»“åº“ï¼Œç‚¹å‡»æ·»åŠ è§„åˆ™è¿™é‡Œç‰ˆæœ¬èµ·ålatestï¼ŒåŸå› ä¸Šé¢è§£é‡Šäº†ï¼Œæœ‰çŸ¥é“çš„ä¼™ä¼´è¿˜è¯·å‘ŠçŸ¥ æ„Ÿè°¢~ ç‚¹å‡»æ„å»ºï¼Œç­‰å¾…ä¸€ä¼šï¼Œä¸‹æ–¹æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºæ„å»ºçš„é•œåƒå’ŒçŠ¶æ€ æœ€åè¿”å›åŸºæœ¬ä¿¡æ¯ï¼Œå¤åˆ¶å…¬ç½‘åœ°å€ï¼Œæ”¾åœ¨fromå’Œtoçš„imageä¸­ï¼Œä¸€å®šè¦å¡«å†™usernameå’Œpasswordæœ€åæ‰§è¡Œ jib:buildå³å¯æˆåŠŸ æˆåŠŸ! æœ€ååœ¨dockerä¸­æ‹‰å–å°±å¯ä»¥äº† 1docker run -d --name testjib-p 8081:8081 åˆšåˆšå¤åˆ¶çš„å…¬ç½‘åœ°å€:latest(å¯¹åº”çš„é•œåƒç‰ˆæœ¬å·)","link":"/posts/20200106-jib_ali.html"},{"title":"mavon-editor+springboot+fdfsä¸Šä¼ æ–‡ä»¶","text":"ä¸€ã€å®‰è£…mavonç›´æ¥npm installä¸‹å°±å¯ä»¥äº†ï¼Œç„¶ååœ¨main.jså¼•å…¥ï¼š12import mavonEditor from 'mavon-editor'Vue.use(mavonEditor) äºŒã€é¡µé¢ä½¿ç”¨1234567891011&lt;mavon-editor v-show=\"!articleModal\" id=\"editor\" v-model=\"value\" fontSize=\"16px\" ref=\"md\" @imgAdd=\"$imgAdd\" @imgDel=\"$imgDel\" @change=\"handleChange\" @fullScreen=\"handleFullScreen\" /&gt; è¿™é‡Œåªéœ€è¦å…³æ³¨@imgAddï¼Œä¸ºæ·»åŠ å›¾ç‰‡çš„äº‹ä»¶ ä¸‰ã€ä¸Šä¼ æ–‡ä»¶è¿™é‡Œä½¿ç”¨çš„æ˜¯æ‰¹é‡ä¸Šä¼ ï¼Œæ‰€ä»¥æ¯è§¦å‘ä¸€æ¬¡@imgAddå°±å‘æ–‡ä»¶é›†åˆæ·»åŠ ä¸€æ¬¡ 1234567/** * æ·»åŠ æ–‡ä»¶åˆ°æ–‡ä»¶é›†åˆä¸­ */ $imgAdd(pos, $file) { // ç¼“å­˜å›¾ç‰‡ä¿¡æ¯ this.img_file[pos] = $file; }, dataä¸­å®šä¹‰å¦‚ä¸‹ï¼š 1img_file: {}, //æ–‡ä»¶é›†åˆ ä¸Šä¼ æ–‡ä»¶æ–¹æ³•ï¼š 123456789101112131415161718192021222324/** * ä¸Šä¼ æ–‡ä»¶ */ uploadimg($e) { var formdata = new FormData(); for (var _img in this.img_file) { formdata.append(\"files\", this.img_file[_img]); } uploadApi.uploadFileList(formdata).then(res =&gt; { console.log(res); const resData = res.data.data; /** * ä¾‹å¦‚ï¼šè¿”å›æ•°æ®ä¸º res = [[pos, url], [pos, url]...] * pos ä¸ºåŸå›¾ç‰‡æ ‡å¿—ï¼ˆ0ï¼‰ * url ä¸ºä¸Šä¼ åå›¾ç‰‡çš„urlåœ°å€ */ // ç¬¬äºŒæ­¥.å°†è¿”å›çš„urlæ›¿æ¢åˆ°æ–‡æœ¬åŸä½ç½®![...](0) -&gt; ![...](url) for (var i = 0; i &lt; resData.length; i++) { this.$refs.md.$img2Url(i + 1, resData[i]); } }); } ç„¶ååœ¨éœ€è¦ä¸Šä¼ çš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å•¦ å››ã€åå°è¿›è¡Œä¸Šä¼ 4.1Controller123456789101112131415/** * æ–‡ç« å¤šæ–‡ä»¶ä¸Šä¼  * @param files * @return è¿”å›å›¾ç‰‡åœ°å€ */ @PostMapping(value = \"/files\",produces = MediaType.APPLICATION_JSON_UTF8_VALUE) public Result uploadMultiFiles(@RequestParam(\"files\") MultipartFile[] files){ try { List&lt;String&gt; resultList = uploadService.uploadMultiFiles(files); return new Result(true,StatusCode.OK,\"ä¸Šä¼ æˆåŠŸ\",resultList); }catch (Exception e){ return new Result(false,StatusCode.ERROR,\"å•Šå“¦~å›¾ç‰‡ä¸Šä¼ å‡ºç°äº†ç‚¹å°é”™è¯¯ï¼Œè¯·ç¨åå†ä¸Šä¼ \"); } } 4.2ã€Service123456789101112131415161718192021222324252627282930313233343536/** * æ‰¹é‡ä¸Šä¼  * @param files */ public List&lt;String&gt; uploadMultiFiles(MultipartFile[] files) { List&lt;String&gt; resultList=new ArrayList&lt;&gt;(); for (MultipartFile file : files) { try { //æ ¡éªŒæ–‡ä»¶å†…å®¹ BufferedImage image = ImageIO.read(file.getInputStream()); if (image == null) { throw new MyException(ExceptionEnum.INVALID_FILE_TYPE); } //è·å–æ‹“å±•å String extension = StringUtils.substringAfterLast(file.getOriginalFilename(), \".\"); //ä¸Šä¼ åˆ°FastDFS StorePath storePath = storageClient.uploadFile(file.getInputStream(), file.getSize(), extension, null); //ä¸åŠ http://å‰ç«¯æ— æ³•æ˜¾ç¤º resultList.add(\"http://\"+uploadProperties.getBaseUrl() + storePath.getFullPath()); //è¿”å›è·¯å¾„ } catch (IOException e) { //ä¸Šä¼ å¤±è´¥ LOGGER.error(\"[æ–‡ä»¶ä¸Šä¼ ]æ–‡ä»¶\"+file.getOriginalFilename()+\"ä¸Šä¼ å¤±è´¥!\", e); throw new MyException(ExceptionEnum.UPLOAD_FILE_ERROR); } } return resultList; } Fdfsçš„ç›¸å…³é…ç½®åœ¨è¿™ç¯‡æ–‡ç« å†™å•¦(ä¸å¥½æ„æ€æ¯”è¾ƒæ‡’)ï¼šhttps://blog.csdn.net/weixin_43696529/article/details/102727220","link":"/posts/20200106-mavon_boot_fdfs.html"},{"title":"å†’æ³¡æ’åº---------javaå®ç°","text":"ä¸€ã€å†’æ³¡æ’åº å¹³å‡æ—¶é—´å¤æ‚åº¦: O(nÂ²)æœ€å·®æ—¶ï¼š O(nÂ²)æ˜¯å¦ç¨³å®šï¼š ç¨³å®šç©ºé—´å¼€é”€ï¼šOï¼ˆ1ï¼‰é€‚åˆnè¾ƒå°æ—¶ åŸå§‹æ•°ç»„ï¼š3 ï¼Œ 9ï¼Œ -1ï¼Œ 8, 2 ç¬¬ä¸€è¶Ÿæ’åºï¼šï¼ˆ1ï¼‰ 3ï¼Œ 9ï¼Œ -1ï¼Œ 8ï¼Œ2ï¼ˆ2ï¼‰ 3ï¼Œ -1ï¼Œ 9ï¼Œ8ï¼Œ 2ï¼ˆ3ï¼‰ 3ï¼Œ -1ï¼Œ 8ï¼Œ 9ï¼Œ 2ï¼ˆ4ï¼‰3ï¼Œ -1ï¼Œ 8ï¼Œ 2ï¼Œ 9 9ç¡®å®š ç¬¬äºŒè¶Ÿæ’åºï¼šï¼ˆ1ï¼‰-1ï¼Œ3ï¼Œ 8ï¼Œ 2ï¼Œ 9ï¼ˆ2ï¼‰-1, 3ï¼Œ 8ï¼Œ 2ï¼Œ 9ï¼ˆ3ï¼‰-1ï¼Œ3ï¼Œ2ï¼Œ 8ï¼Œ 9 8 , 9ç¡®å®šç¬¬ä¸‰è¶Ÿæ’åºï¼šï¼ˆ1ï¼‰-1ï¼Œ3 ï¼Œ2 ï¼Œ8 ï¼Œ 9ï¼ˆ2ï¼‰-1ï¼Œ 2ï¼Œ 3 ï¼Œ8 ï¼Œ9 3ï¼Œ 8ï¼Œ 9ç¡®å®šç¬¬å››è¶Ÿæ’åºï¼šï¼ˆ1ï¼‰-1ï¼Œ 2ï¼Œ 3ï¼Œ 8ï¼Œ 9 (2ï¼Œ 3ï¼Œ 8ï¼Œ 9ç¡®å®š) å®ç°ï¼š 123456789101112131415161718int[] array = {3, 9, -1, 8, 2}; int temp=0; for (int i=0; i&lt; array.length-1;i++){ System.out.println(\"å¼€å§‹ç¬¬\"+(i+1)+\"è¶Ÿæ’åº\"); for (int j=0;j&lt;array.length-1-i;j++){ if (array[j]&gt;array[j+1]){ temp=array[j]; array[j]=array[j+1]; array[j+1]=temp; } System.out.println(Arrays.toString(array)); } System.out.println(\"ç¬¬\"+(i+1)+\"è¶Ÿæ’åºç»“æœï¼š\"); System.out.println(Arrays.toString(array)); System.out.println(\"------------------\"); } ç»“æœï¼š1234567891011121314151617181920212223242526å¼€å§‹ç¬¬1è¶Ÿæ’åº[3, 9, -1, 8, 2][3, -1, 9, 8, 2][3, -1, 8, 9, 2][3, -1, 8, 2, 9]ç¬¬1è¶Ÿæ’åºç»“æœï¼š[3, -1, 8, 2, 9]------------------å¼€å§‹ç¬¬2è¶Ÿæ’åº[-1, 3, 8, 2, 9][-1, 3, 8, 2, 9][-1, 3, 2, 8, 9]ç¬¬2è¶Ÿæ’åºç»“æœï¼š[-1, 3, 2, 8, 9]------------------å¼€å§‹ç¬¬3è¶Ÿæ’åº[-1, 3, 2, 8, 9][-1, 2, 3, 8, 9]ç¬¬3è¶Ÿæ’åºç»“æœï¼š[-1, 2, 3, 8, 9]------------------å¼€å§‹ç¬¬4è¶Ÿæ’åº[-1, 2, 3, 8, 9]ç¬¬4è¶Ÿæ’åºç»“æœï¼š[-1, 2, 3, 8, 9]------------------ æ€»ç»“ï¼š1.å…±è¿›è¡Œæ•°ç»„å¤§å°-1æ¬¡å¾ªç¯2.æ¯æ¬¡æ’åºçš„æ¬¡æ•°é€æ¸å‡å°‘ ä¼˜åŒ–ï¼šè‹¥ä¸€è¶Ÿæ’åºä¸­æ²¡æœ‰ä¸€æ¬¡äº¤æ¢ï¼Œåˆ™åœæ­¢å¾ªç¯å¢åŠ æ ‡å¿—å˜é‡flag=falseï¼Œå‘ç”Ÿäº¤æ¢æ—¶ï¼Œç½®flagä¸ºtrueï¼Œä¸€æ¬¡å¾ªç¯ååˆ¤æ–­flagï¼Œè‹¥ä¸ºtrueï¼Œåˆ™é‡ç½®flagä¸ºfalseç»§ç»­å¾ªç¯ï¼Œå¦åˆ™breakï¼› 1234567891011121314151617181920212223242526272829int[] array = {3, 9, -1, 8, 2}; boolean flag=false; int temp=0; for (int i=0; i&lt; array.length-1;i++){ System.out.println(\"å¼€å§‹ç¬¬\"+(i+1)+\"è¶Ÿæ’åº\"); for (int j=0;j&lt;array.length-1-i;j++){ if (array[j]&gt;array[j+1]){ temp=array[j]; array[j]=array[j+1]; array[j+1]=temp; flag=true; } System.out.println(Arrays.toString(array)); } System.out.println(\"ç¬¬\"+(i+1)+\"è¶Ÿæ’åºç»“æœï¼š\"); System.out.println(Arrays.toString(array)); System.out.println(\"------------------\"); if (!flag){ //æœªå‘ç”Ÿä¸€æ¬¡äº¤æ¢ï¼Œflagä¸ºfalse break; }else { //å‘ç”Ÿäº†äº¤æ¢ï¼Œflagè¢«ç½®ä¸ºtrue flag=false; //é‡ç½®flagï¼Œç»§ç»­å¾ªç¯ } } è¿™é‡Œå› ä¸ºæ•°æ®åŸå› ä»ç„¶æ‰§è¡Œäº†4æ¬¡å¯ä»¥æ¢ä¸€ç»„æ•°æ®:{3,9,-1,8,10}ç»“æœï¼š 123456789101112131415161718192021å¼€å§‹ç¬¬1è¶Ÿæ’åº[3, 9, -1, 8, 10][3, -1, 9, 8, 10][3, -1, 8, 9, 10][3, -1, 8, 9, 10]ç¬¬1è¶Ÿæ’åºç»“æœï¼š[3, -1, 8, 9, 10]------------------å¼€å§‹ç¬¬2è¶Ÿæ’åº[-1, 3, 8, 9, 10][-1, 3, 8, 9, 10][-1, 3, 8, 9, 10]ç¬¬2è¶Ÿæ’åºç»“æœï¼š[-1, 3, 8, 9, 10]------------------å¼€å§‹ç¬¬3è¶Ÿæ’åº[-1, 3, 8, 9, 10][-1, 3, 8, 9, 10]ç¬¬3è¶Ÿæ’åºç»“æœï¼š[-1, 3, 8, 9, 10]------------------ å¯ä»¥çœ‹åˆ°åªæ‰§è¡Œäº†ä¸‰æ¬¡æ’åº æµ‹è¯•åä¸‡æ¡æ•°æ®æ‰§è¡Œæ—¶é—´:12345678910111213//åˆ›å»º50000ä¸ªéšæœºæ•°ç»„ int[] array =new int[100000]; for (int i=0;i&lt;100000;i++){ array[i]=(int)(Math.random()*100000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); bubbleSort(array); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572061280770ç»“æŸæ—¶é—´1572061302883ç”¨æ—¶ï¼š22113ms å½“ç„¶æ¯æ¬¡æ‰§è¡Œæ—¶é—´ä¸ä¸€æ ·ï¼Œä½†å½“æ•°æ®å¤§çš„æ—¶å€™æ€»ä½“æ•ˆç‡è¿˜æ˜¯å¾ˆä½çš„","link":"/posts/20200107-bubbleSort.html"},{"title":"åŸºæ•°æ’åº-------------javaå®ç°","text":"ä¸€ã€åŸºæœ¬æ€æƒ³1.åŸºæ•°æ’åº(Radix Sort)å±äºåˆ†é…å¼æ’åºï¼ˆdistribution sortï¼‰ï¼Œåˆç§°â€æ¡¶å­æ³•â€(Bucket Sortæˆ–Bin Sort)ï¼Œå®ƒæ˜¯é€šè¿‡é”®å€¼çš„å„ä¸ªä½çš„å€¼ï¼Œå°†è¦æ’åºçš„å…ƒç´ åˆ†é…è‡³æŸäº›â€œæ¡¶â€ä¸­ï¼Œè¾¾åˆ°æ’åºçš„ä½œç”¨ã€‚2.åŸºæ•°æ’åºå±äºç¨³å®šçš„æ’åºï¼ŒåŸºæ•°æ’åºæ³•çš„æ˜¯æ•ˆç‡é«˜çš„ç¨³å®šæ€§æ’åºæ³• 3.åŸºæ•°æ’åº(Radix Sort)æ˜¯æ¡¶æ’åºçš„æ‰©å±•4.å°†æ‰€æœ‰å¾…æ¯”è¾ƒæ•°å€¼ç»Ÿä¸€ä¸ºåŒæ ·çš„æ•°ä½é•¿åº¦ï¼Œæ•°ä½è¾ƒçŸ­çš„æ•°å‰é¢è¡¥é›¶ã€‚ç„¶åï¼Œä»æœ€ä½ä½å¼€å§‹ï¼Œä¾æ¬¡è¿›è¡Œä¸€æ¬¡æ’åºã€‚è¿™æ ·ä»æœ€ä½ä½æ’åºä¸€ç›´åˆ°æœ€é«˜ä½æ’åºå®Œæˆä»¥å, æ•°åˆ—å°±å˜æˆä¸€ä¸ªæœ‰åºåºåˆ—ã€‚ å¹³å‡æ—¶é—´å¤æ‚åº¦ï¼š O(n+k) æœ€ä¼˜æƒ…å†µï¼š O(n+k) æœ€åæƒ…å†µï¼š O(nÂ²) ç©ºé—´å¤æ‚åº¦: O(n+k) ç¨³å®šæ€§ï¼š ç¨³å®š äºŒã€ä¸¾ä¾‹è¯´æ˜ç°æœ‰ä¸€ç»„æ•°æ®ï¼š{43,3,535,738,14,21,0} ç¬¬ä¸€è½®æ’åºï¼š ç¬¬1è½®æ’åºåï¼š0,21,43,4,14,535,738 ç¬¬äºŒè½®æ’åºï¼šç¬¬äºŒè½®æ’åºç»“æœï¼š0,4ï¼Œ14,21,535,738,43 ç¬¬ä¸‰è½®æ’åºï¼šç¬¬ä¸‰è½®æ’åºç»“æœï¼š0,4ï¼Œ14,21,43,535,738 ä¸‰ã€ä»£ç å®ç°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768package com.wml.sort;import java.util.Arrays;/** * @author MaoLin Wang * @date 2019/10/3012:53 */public class RadixSort { public static void main(String[] args) { int[] arr={53,3,542,748,14,21,0}; radixSort(arr); } public static void radixSort(int[] arr){ //æ±‚æœ€å¤§æ•°çš„ä½æ•° int max = arr[0]; for (int i = 1;i &lt; arr.length; i++){ if (arr[i] &gt;max){ max = arr[i]; } } //å¾—åˆ°æœ€å¤§æ•°çš„ä½æ•° int maxLength = (max+\"\").length(); //ä¸ºé˜²æ­¢æ•°æ®æº¢å‡ºï¼Œåº”å°†åˆ—æ•°è®¾ä¸ºæ•°ç»„é•¿åº¦ int [][] bucket=new int[10][arr.length]; //è®°å½•æ¯ä¸ªæ¡¶ä¸­å®é™…å­˜æ”¾äº†å¤šå°‘æ•°æ® int[] bucketElementCounts=new int[10]; /** * nä»£è¡¨ä½æ•°ï¼Œåˆå§‹åŒ–ä¸º1ï¼Œä»£è¡¨ä¸ªä½ */ for (int i=0 ,n = 1;i&lt; maxLength;i++,n *=10){ for (int j=0;j&lt;arr.length;j++){ //å–å‡ºä¸ªä½çš„å€¼ int value= arr[j] /n %10; //æ”¾å…¥ä¸ªä½å€¼ä¸ºvalueçš„æ¡¶çš„ç¬¬bucketElementCounts[value]ä¸ªä½ç½®ï¼Œåˆšå¼€å§‹bucketElementCounts[value]ä¸º0ï¼Œæ¯æ”¾å…¥ä¸€ä¸ªæ•°æ®å°±+1 bucket[value][bucketElementCounts[value]]=arr[j]; bucketElementCounts[value]++; } int index = 0;//åŸå§‹æ•°ç»„ä¸‹è¾¹ï¼Œåˆå§‹ä¸º0 // System.out.println(Arrays.toString(bucketElementCounts)); //éå†æ¯ä¸ªæ¡¶ï¼Œå°†æ¡¶ä¸­æ•°æ®æ”¾å›åŸæ¥æ•°ç»„ for (int k=0;k&lt;bucketElementCounts.length;k++){ //ç¬¬kä¸ªæ¡¶ ä¸ç­‰äº0ï¼Œå³è¯¥æ¡¶æœ‰æ•°æ® if (bucketElementCounts[k] !=0){ //éå†è¯¥æ¡¶æ•°æ®ï¼Œæ”¾å…¥åŸæ•°ç»„ for (int m=0;m&lt;bucketElementCounts[k];m++){ //å–å‡ºå…ƒç´ æ”¾åˆ°arr arr[index++] = bucket[k][m]; } } //ç¬¬i+1è½®å¤„ç†åï¼Œéœ€è¦å°†æ¯ä¸ªbucketElementCounts[k] = 0 bucketElementCounts[k]=0; } System.out.println(\"ç¬¬\"+(i+1)+\"è½®ç»“æœ\"+ Arrays.toString(arr)); } }} ç»“æœï¼šç¬¬1è½®ç»“æœ[0, 21, 542, 53, 3, 14, 748]ç¬¬2è½®ç»“æœ[0, 3, 14, 21, 542, 748, 53]ç¬¬3è½®ç»“æœ[0, 3, 14, 21, 53, 542, 748] æµ‹è¯•80wæ¡æ•°æ®è€—æ—¶12345678910111213int[] arr =new int[800000]; for (int i=0;i&lt;800000;i++){ arr[i]=(int)(Math.random()*800000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); radixSort(arr); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼šå¼€å§‹æ—¶é—´1572416316975ç»“æŸæ—¶é—´1572416317084ç”¨æ—¶ï¼š109ms å¾ˆæ˜æ˜¾æ¯”ä¹‹å‰çš„å½’å¹¶ã€å¿«é€Ÿæ’åºéƒ½å¿«çš„å¤šï¼Œä½†æ˜¯å…¶ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå¯¹äºä»»ä½•ä½æ•°ä¸Šçš„åŸºæ•°è¿›è¡Œâ€œè£…æ¡¶â€æ“ä½œæ—¶ï¼Œéƒ½éœ€è¦n+kä¸ªä¸´æ—¶ç©ºé—´(kä¸ºæ¡¶æ•°)ï¼Œéå¸¸è€—è´¹ç©ºé—´","link":"/posts/20200107-jishuSort.html"},{"title":"å¸Œå°”æ’åº-----------javaå®ç°","text":"é¦–å…ˆçœ‹ä¸€ä¸‹ä¹‹å‰ä½¿ç”¨ç®€å•æ’å…¥æ’åºå­˜åœ¨çš„é—®é¢˜ï¼š å½“å­˜åœ¨ä¸€ä¸ªæ•°ç»„ï¼Œå…¶æœ€åä¸€ä¸ªæ•°æ®ä¸ºæœ€å°å€¼ï¼Œå¦‚ï¼šarr={5,6,16,34,33,2} è¿™æ ·çš„è¯éœ€è¦å¾ªç¯åˆ°æœ€åä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯ç¬¬6æ¬¡çš„æ—¶å€™ï¼Œæ‰å¯ä»¥å°†2æ’åˆ°å‰è¾¹ï¼Œæ•ˆç‡éå¸¸ä½ ä½†æ˜¯å¸Œå°”æ’åºå¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶æ˜¯ç®€å•æ’å…¥æ’åºæ”¹è¿›åçš„ä¸€ä¸ªæ•ˆç‡è¾ƒé«˜çš„æ’åºæ–¹å¼ï¼Œä¹Ÿå«ç¼©å°å¢é‡æ’åº å¤æ‚åº¦ï¼š å¹³å‡æ—¶é—´ï¼š Oï¼ˆnlognï¼‰ æœ€å·®: O(nÂ²) æœ€ä¼˜: O(n^1/3) ç©ºé—´å¤æ‚åº¦ï¼šO(1) ç¨³å®šæ€§ï¼š ä¸ç¨³å®š ä¸€ã€åŸºæœ¬æ€æƒ³å¸Œå°”æ’åºæŒ‰æŸä¸ªå¢é‡åˆ†ç»„ï¼Œå¯¹æ¯ä¸ªåˆ†ç»„ä½¿ç”¨ç›´æ¥æ’å…¥æ’åºå®ç°ï¼Œéšç€å¢é‡é€æ¸å‡å°ï¼Œæ¯ç»„æ•°æ®é€æ¸å¢åŠ ï¼Œå½“å¢é‡å‡å°‘è‡³1æ—¶ï¼Œä»…å‰©ä¸‹å®Œæ•´çš„ä¸€ç»„ï¼Œæ’åºç»“æŸã€‚ äºŒã€æ’åºåˆ†æ) å›¾ç‰‡å¼•ç”¨è‡ªhttps://blog.csdn.net/qq_28081081/article/details/80598960 ä¸‰ã€ä»£ç å®ç°1234567891011121314151617181920212223242526272829303132/** * å¸Œå°”æ’åº * @author MaoLin Wang * @date 2019/10/2817:43 */public class ShellSort { public static void main(String[] args) { int[] arr={214,32,11,2,3,2,66,33,54,12}; shellSort(arr); } public static void shellSort(int[]arr){ int temp=0; int count=0; for (int group =arr.length/2;group&gt;0;group/=2){ for (int i=group;i&lt;arr.length;i++){ for (int j=i-group;j&gt;=0;j-=group){ if (arr[j]&gt;arr[j+group]){ temp=arr[j]; arr[j]=arr[j+group]; arr[j+group]=temp; } } } System.out.println(\"ç¬¬\"+(++count)+\"æ¬¡æ’åºç»“æœï¼š\"); System.out.println(Arrays.toString(arr)); } }} ç»“æœï¼š 123456ç¬¬1æ¬¡æ’åºç»“æœï¼š[2, 32, 11, 2, 3, 214, 66, 33, 54, 12]ç¬¬2æ¬¡æ’åºç»“æœï¼š[2, 2, 3, 12, 11, 32, 54, 33, 66, 214]ç¬¬3æ¬¡æ’åºç»“æœï¼š[2, 2, 3, 11, 12, 32, 33, 54, 66, 214] æµ‹è¯•100000æ¡æ•°æ®è€—æ—¶ï¼š 123456789101112int[] arr =new int[100000];for (int i=0;i&lt;100000;i++){ arr[i]=(int)(Math.random()*100000);}long begintime=System.currentTimeMillis();System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime);shellSort(arr);long endtime=System.currentTimeMillis();System.out.println(\"ç»“æŸæ—¶é—´\"+endtime);System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572260920132ç»“æŸæ—¶é—´1572260930389ç”¨æ—¶ï¼š10257ms å‘ç°ç”¨äº†10000å¤šmsï¼Œä¸ä½†æ²¡æœ‰æé«˜æ•ˆç‡ï¼Œåè€Œä½äº†éå¸¸å¤šï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ ä»”ç»†çœ‹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œäº¤æ¢çš„æ¡ä»¶ï¼Œå‘ç°åªè¦æ»¡è¶³arr[j]&gt;arr[j+group]å°±è¦è¿›è¡Œäº¤æ¢ï¼Œæ— ç–‘å¢åŠ äº†ç³»ç»Ÿå¼€é”€ æ¥ä¸‹æ¥å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼š 123456789101112131415161718192021222324252627282930313233public static void shellSort2(int arr[]) { for (int group = arr.length / 2; group &gt; 0; group /= 2) { for (int i = group; i &lt; arr.length; i++) { int j = i; int temp = arr[j]; if (arr[j] &lt; arr[j - group]) { while ((j - group) &gt;= 0 &amp;&amp; temp &lt; arr[j - group]) { /** * å¼€å§‹ç§»åŠ¨ï¼Œå°†æ¯”arr[j]å¤§çš„arr[j-group]ã€arr[j-group-group]......æŒ‰é¡ºåºç§»åŠ¨åˆ°åä¸€ä¸ªå¢é‡çš„ä½ç½® * å¦‚ 3, 2, 11, 21, 66, 32, 214, 4 * åœ¨groupå‡å°‘åˆ°2ï¼Œæ¯”è¾ƒ32å’Œ4çš„æ—¶å€™ * 1. 4&lt;32 ä¸”æ»¡è¶³whileæ¡ä»¶ï¼Œ æ‰€ä»¥å°†32ç§»åŠ¨åˆ°4,temp=4ï¼Œj=5ï¼ŒæŒ‡å‘32çš„ä½ç½® * æ­¤æ—¶çš„æ•°æ®ä¸º:3, 2, 11, 21, 66, 32, 214, 32 * 2.ç»§ç»­whileå¾ªç¯ * j-group=3&gt;0 temp=4&lt;arr[3]=21ï¼Œæ»¡è¶³whileæ¡ä»¶ * æ‰§è¡Œarr[j]=arr[j-group] -&gt; å°†21çš„ä½ç½®ç§»åŠ¨åˆ°32,tempä»ç„¶ä¸ºä¸€å¼€å§‹çš„4,j=3ï¼ŒæŒ‡å‘21çš„ä½ç½® * æ­¤æ—¶æ•°æ®ä¸ºï¼š3, 2, 11, 21, 66, 21, 214, 32 * 3.ç»§ç»­å¾ªç¯while * j-group=1&gt;0 temp=4&gt;arr[1]=2 ä¸æ»¡è¶³whileæ¡ä»¶ï¼Œé€€å‡ºå¾ªç¯ * 4.æ­¤æ—¶j=3ï¼Œå°†temp=4èµ‹å€¼ç»™arr[j] * æ­¤æ—¶æ•°æ®ä¸ºï¼š3, 2, 11, 4, 66, 21, 214, 32 */ arr[j] = arr[j - group]; j -= group; } //ç»“æŸwhileå¾ªç¯åï¼Œå°†tempæ’å…¥åˆ°arr[j] arr[j] = temp; } } } } åŒæ ·æµ‹è¯•10000æ¡æ•°æ®æ’åºçš„è€—æ—¶ï¼š 123å¼€å§‹æ—¶é—´1572264172662ç»“æŸæ—¶é—´1572264172692ç”¨æ—¶ï¼š30ms è€—æ—¶ä»1wå¤šmså‡å°åˆ°30msï¼Œå¤šæ¬¡æµ‹è¯•ä¸Šä¸‹æ³¢åŠ¨ä¹Ÿä¸ä¼šè¶…è¿‡20ms","link":"/posts/20200107-shellSort.html"},{"title":"å½’å¹¶æ’åº-------------javaå®ç°","text":"å½’å¹¶æ’åºé‡‡ç”¨åˆ†æ²»ç­–ç•¥å®ç° å¹³å‡æ—¶é—´å¤æ‚åº¦ : Oï¼ˆnlognï¼‰ æœ€å·®æ—¶é—´å¤æ‚åº¦: O(nlogn) ç¨³å®šæ€§ï¼š ç¨³å®š ç©ºé—´å¤æ‚åº¦ï¼šO(n) å½’å¹¶æ’åºæ—¶ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ’åºæ–¹æ³•ï¼Œç©ºé—´æ¶ˆè€—å¾ˆå¤§ï¼Œä¸€èˆ¬å†…éƒ¨æ’åºä½¿ç”¨å¿«é€Ÿæ’åºè¾ƒå¤š å‡è®¾æœ‰è¿™æ ·ä¸€ç»„æ•°æ®ï¼š[10,4,8,7,1,3,2,9] ä¸€ã€åˆ†) å¦‚ä¸Šå°†8ä¸ªæ•°ç»„åˆ†æˆ8ä¸ªå•ç‹¬çš„æ•°æ® äºŒã€åˆ1.å°† 10å’Œ 4åˆå¹¶ ) 2.å°†8å’Œ7åˆå¹¶ ) 3. å°†4,10å’Œ7,8åˆå¹¶ )ã€ 4.åŒæ ·å°†å³åŠéƒ¨åˆ†ä¹ŸæŒ‰æ­¤åˆå¹¶å¾—åˆ°å¦‚ä¸‹ä¸¤ç»„æ•°æ® ) 5.æœ€åå°†ä¸¤ç»„æ•°æ®åˆå¹¶åœ¨ä¸€èµ· ) ä¸‰ã€ä»£ç å®ç°12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879package com.wml.sort;import java.util.Arrays;/** * @author * @date 2019/10/2919:17 */public class MergeSort { public static void main(String[] args) { int arr[] = {10,4,8,7,1,3,2}; int[] temp=new int[arr.length]; mergeSort(arr,0,arr.length-1,temp); System.out.println(Arrays.toString(arr)); } public static void mergeSort(int[] arr,int left,int right,int[] temp){ if (left &lt; right){ int mid= (left + right ) / 2; //å‘å·¦é€’å½’åˆ†è§£ mergeSort(arr,left,mid,temp); //å‘å³é€’å½’åˆ†è§£ mergeSort(arr,mid+1,right,temp); //åˆå¹¶ merge(arr,left,right,mid,temp); } } /** * * @param arr å¾…æ’åºæ•°ç»„ * @param left å·¦è¾¹æœ‰åºåºåˆ—çš„åˆå§‹ç´¢å¼• * @param right å³è¾¹ç´¢å¼• * @param mid * @param temp ä¸´æ—¶æ•°ç»„ */ public static void merge(int[] arr,int left, int right,int mid,int[] temp){ int l = left; //åˆå§‹åŒ–iï¼Œå·¦è¾¹æœ‰åºåºåˆ—çš„åˆå§‹ç´¢å¼• int r = mid+1; //å³è¾¹æœ‰åºåºåˆ—çš„åˆå§‹ç´¢å¼• int current = 0; // æŒ‡å‘ä¸´æ—¶æ•°ç»„çš„å½“å‰ç´¢å¼• //1.å…ˆæŠŠå·¦è¾¹ä¸¤è¾¹çš„æœ‰åºæ•°æ®æŒ‰è§„åˆ™å¡«å……åˆ°ä¸´æ—¶æ•°ç»„ï¼Œç›´åˆ°ä»»æ„ä¸€æ–¹å¤„ç†å®Œæ¯• while ( l&lt;= mid &amp;&amp; r &lt;= right){ if (arr[l] &lt;= arr[r]){ //å½“å‰å·¦è¾¹çš„å…ƒç´ å°äºç­‰äºå³è¾¹çš„ï¼Œå°†å·¦è¾¹çš„æ•°æ®æ‹·è´åˆ°ä¸´æ—¶æ•°ç»„ temp[current] = arr[l]; current +=1; //currentåç§» l +=1; //å·¦è¾¹æŒ‡é’ˆå³ç§» }else { //å³è¾¹çš„å…ƒç´ ç§»åˆ°ä¸´æ—¶æ•°ç»„ temp[current] = arr[r]; current += 1; r +=1; } } //2.å°†æœ‰å‰©ä½™çš„ä¸€è¾¹å…¨éƒ¨ç§»åŠ¨åˆ°ä¸´æ—¶æ•°ç»„ while ( l &lt;= mid){//å·¦è¾¹æœ‰å‰©ä½™ temp[current] = arr[l]; current+=1; l+=1; } while ( r &lt;= right){//å³è¾¹æœ‰å‰©ä½™ temp[current] = arr[r]; current+=1; r+=1; } //3.å°†ä¸´æ—¶æ•°ç»„æ‹·è´åˆ°åŸå§‹æ•°ç»„ current = 0; int tempLeft=left; while (tempLeft &lt;= right){ arr[tempLeft] = temp[current]; current+=1; tempLeft +=1; } }} ç»“æœï¼š [1, 2, 3, 4, 7, 8, 10]","link":"/posts/20200107-guibingSort.html"},{"title":"å¿«é€Ÿæ’åº-------------javaå®ç°","text":"ä¸€ã€åŸºæœ¬æ€æƒ³é€‰æ‹©ä¸€ä¸ªåŸºå‡†æ•°ï¼Œé€šè¿‡ä¸€è¶Ÿæ’åºå°†å¾…æ’åºæ•°æ®åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°éƒ½æ¯”åŸºå‡†æ•°å°ï¼Œå¦ä¸€éƒ¨åˆ†éƒ½æ¯”åŸºå‡†æ•°å¤§ï¼Œç„¶åå†ä½¿ç”¨æ­¤æ–¹æ³•é€’å½’å¯¹ä¸¤éƒ¨åˆ†æ•°æ®è¿›è¡Œå¿«æ’ï¼Œæœ€ç»ˆå®ç°æ•´ä¸ªæ•°æ®çš„æœ‰åºã€‚ äºŒã€è¯¦è§£æ’åºè¿‡ç¨‹ç°æœ‰å¾…æ’åºæ•°æ®ï¼š 1{-21, 312, 44, 11, -23, 2, 10}; è“è‰²ä¸ºå·¦å“¨å…µï¼Œè®°ä¸ºleftï¼Œé»„è‰²ä¸ºå³å“¨å…µè®°ä¸ºrightï¼Œçº¢è‰²ä¸ºåŸºæ•° åŸºæ•°=(å·¦å“¨å…µåæ ‡+å³åæ ‡)/2 ç¬¬ä¸€è½®æ’åºï¼š â€‹ â†“ â†“ â€‹ -21ï¼Œ 312ï¼Œ 44ï¼Œ 11ï¼Œ -23ï¼Œ 2ï¼Œ 10 â€‹ å·¦å“¨å…µæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºæ•°11å¤§çš„æ•°åœæ­¢ï¼Œå³åœ¨312åœæ­¢ï¼Œæ­¤æ—¶left=1 â€‹ å³å“¨å…µæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºæ•°å°çš„æ•°åœæ­¢ï¼Œå³åœ¨10åœæ­¢ï¼Œæ­¤æ—¶right=6 â€‹ æ­¤æ—¶ä¸¤ä¸ªå“¨å…µå°šæœªç›¸é‡ï¼Œäº¤æ¢ 312 å’Œ 10 äº¤æ¢åï¼š â€‹ â†“ â†“ â€‹ -21ï¼Œ 10ï¼Œ 44ï¼Œ 11ï¼Œ -23ï¼Œ 2ï¼Œ 312 å·¦å“¨å…µç»§ç»­ç§»åŠ¨ï¼Œåˆ°æ¯”11å¤§çš„44æ—¶åœæ­¢ï¼Œæ­¤æ—¶left=2 å³å“¨å…µç»§ç»­ç§»åŠ¨ï¼Œåˆ°æ¯”11å°çš„2å¤„åœæ­¢ï¼Œæ­¤æ—¶right=5 ä¸¤ä¸ªå“¨å…µä»ç„¶æœªç›¸é‡ ï¼Œä¸éœ€è¦breakï¼›äº¤æ¢ 44 å’Œ 2 äº¤æ¢åï¼š â€‹ â†“ â†“ â€‹ -21ï¼Œ 10ï¼Œ 2ï¼Œ 11ï¼Œ -23ï¼Œ 44ï¼Œ 312 å·¦å“¨å…µç»§ç»­ç§»åŠ¨ï¼Œåˆ°åŸºæ•°11åœæ­¢ï¼Œå› ä¸ºå·¦è¾¹å·²ç»æ²¡æœ‰æ¯”11å°çš„æ•°äº†ï¼Œæ­¤æ—¶left=3 å³å“¨å…µç»§ç»­ç§»åŠ¨ï¼Œåˆ°æ¯” 11å°çš„ -23å¤„åœæ­¢ï¼Œæ­¤æ—¶right = 4 äº¤æ¢11 å’Œ-23 äº¤æ¢åï¼š â€‹ â†“ â†“ â€‹ -21ï¼Œ 10ï¼Œ 2ï¼Œ -23ï¼Œ 11ï¼Œ 44ï¼Œ 312 æ­¤æ—¶å†ç»§ç»­ç§»åŠ¨ï¼Œä¸¤ä¸ªå“¨å…µç›¸é‡ï¼Œä¸€è½®ç»“æŸ å½“å“¨å…µç›¸é‡æ—¶ï¼Œè®©rightâ€“ï¼Œleft++ï¼Œåˆ†åˆ«æŒ‡å‘-23 å’Œ44 æ­¤æ—¶å·¦åŠéƒ¨åˆ†ä¸ºï¼š-21, 10, 2, -23 leftä¸º-21ï¼Œrightä¸º-23 å³åŠéƒ¨åˆ†ä¸ºï¼š 44ï¼Œ 312 leftä¸º44ï¼Œrightä¸º312 ä¸¤è¾¹ç»§ç»­æŒ‰ä¸Šè¿°æ­¥éª¤é€’å½’æ’åº ä¸‰ã€ä»£ç å®ç°ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667/** * å¿«é€Ÿæ’åº * @author * @date 2019/10/2917:06 */public class QuickSort { public static void main(String[] args) { int[] arr={-21,312,44,11,-23,2,10}; quickSort(arr,0,arr.length-1); System.out.println(Arrays.toString(arr)); } public static void quickSort(int[] arr, int left, int right) { int l = left; int r = right; //åŸºå‡†æ•° int pivot = arr[(left + right) / 2]; int temp=0;//ä¸´æ—¶å˜é‡ //è®©æ¯”åŸºæ•°å°çš„æ”¾åœ¨å·¦è¾¹ï¼Œæ¯”åŸºæ•°å¤§çš„æ”¾åœ¨å³è¾¹ while (l &lt; r){ //åœ¨åŸºæ•°å·¦è¾¹æ‰¾åˆ°å¤§äºç­‰äºåŸºæ•°çš„å€¼æ‰é€€å‡º while (arr[l] &lt; pivot){ l += 1; } //åœ¨åŸºæ•°å³è¾¹æ‰¾åˆ°å°äºç­‰äºåŸºæ•°çš„å€¼æ‰é€€å‡º while (arr[r] &gt; pivot){ r -=1; } //å·¦å³ä¸¤ä¸ªå“¨å…µç›¸é‡ï¼Œå³è¯´æ˜åŸºæ•°å·¦è¾¹çš„æ•°å·²ç»å…¨éƒ¨å°äºåŸºæ•°ï¼Œå³è¾¹çš„æ•°å·²ç»å…¨éƒ¨å¤§äºåŸºæ•° if( l &gt;= r){ break; } //å¦åˆ™è¿›è¡Œäº¤æ¢ temp = arr[l]; arr[l] = arr[r]; arr[r] = temp; //å¦‚æœäº¤æ¢å®Œåï¼Œå‘ç°arr[l] == åŸºæ•°ï¼Œrå‘å·¦ç§» if (arr[l] == pivot){ r -= 1; } //å¦‚æœäº¤æ¢å®Œåï¼Œå‘ç°arr[r] == åŸºæ•°ï¼Œlå‘å³ç§» if (arr[r] == pivot){ l += 1; } } if (l == r){ l +=1; r -=1; } //å‘å·¦é€’å½’ if (left&lt;r){ quickSort(arr,left,r); } //å‘å³é€’å½’ if (right &gt; l){ quickSort(arr,l,right); } }} ç»“æœï¼š [-23, -21, 2, 10, 11, 44, 312] å››ã€æµ‹è¯•10Wæ¡æ•°æ®è€—æ—¶123456789101112int[] arr =new int[100000];for (int i=0;i&lt;100000;i++){ arr[i]=(int)(Math.random()*100000);}long begintime=System.currentTimeMillis();System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime);quickSort(arr,0,arr.length-1);long endtime=System.currentTimeMillis();System.out.println(\"ç»“æŸæ—¶é—´\"+endtime);System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572344644967ç»“æŸæ—¶é—´1572344645031ç”¨æ—¶ï¼š64ms æ­¤æ—¶ä¸å¸Œå°”æ’åºçœ‹ä¸å‡ºå¾ˆå¤§çš„å·®è·ï¼Œå°†æ•°æ®å¢åŠ åˆ°80Wæ¡æµ‹è¯•ç»“æœï¼š å¸Œå°”ï¼š å¼€å§‹æ—¶é—´1572344777821ç»“æŸæ—¶é—´1572344778134ç”¨æ—¶ï¼š313ms å¿«é€Ÿï¼š å¼€å§‹æ—¶é—´1572344758536ç»“æŸæ—¶é—´1572344758711ç”¨æ—¶ï¼š175ms ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼Œå¶å°”ä¼šæœ‰å¸Œå°”æ’åºæ¯”å¿«é€Ÿå¿«çš„æƒ…å†µï¼Œä½†æ˜¯å¤šæ•°æƒ…å†µä¸‹è¿˜æ˜¯å¿«é€Ÿæ¯”å¸Œå°”å¿«","link":"/posts/20200107-quickSort.html"},{"title":"æ’å…¥æ’åº-----------javaå®ç°","text":"ä¸€ã€å¤æ‚åº¦12345å¹³å‡æ—¶é—´å¤æ‚åº¦ï¼š O(nÂ²)æœ€å·®æ—¶ï¼š O(nÂ²)æ˜¯å¦ç¨³å®šï¼š ç¨³å®šç©ºé—´å¼€é”€ï¼š O(1)åœ¨å¤§éƒ¨åˆ†æ•°æ®å·²ç»æ’å¥½åºæ—¶æ€§èƒ½è¾ƒå¥½ äºŒã€åŸºæœ¬æ€æƒ³å°†nä¸ªå¾…æ’åºå…ƒç´ çœ‹æˆä¸€ä¸ªæœ‰åºè¡¨å’Œä¸€ä¸ªæ— åºè¡¨ï¼Œå¼€å§‹æœ‰åºè¡¨åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ¯æ¬¡æ’åºä»æ— éœ€è¡¨ä¸­å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå°†å®ƒçš„å€¼ä¾æ­¤å’Œæœ‰åºè¡¨å…ƒç´ çš„æ•°æ®æ¯”è¾ƒï¼Œæ’å…¥åˆ°æœ‰åºè¡¨çš„é€‚å½“ä½ç½®ï¼Œå½¢æˆæ–°çš„æœ‰åºè¡¨ è¯¦è§£ï¼š åˆå§‹æ•°æ®ï¼š18, 5, 54, 2, 33, 12 ç¬¬ä¸€æ¬¡æ’åºï¼š5ï¼Œ 18ï¼Œ 54ï¼Œ 2ï¼Œ 33ï¼Œ12 ç¬¬äºŒæ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ 18ï¼Œ 54ï¼Œ 33ï¼Œ12 ç¬¬ä¸‰æ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ12 18ï¼Œ 54ï¼Œ 33 ç¬¬å››æ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ12 18ï¼Œ33ï¼Œ 54 ç¬¬äº”æ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ12 18ï¼Œ33ï¼Œ54 ä¸‰ã€ä»£ç å®ç°12345678910111213141516171819202122232425262728293031323334353637/** * æ’å…¥æ’åº * @author ** * @date 2019/10/2816:55 */public class InsertSort { public static void main(String[] args) { int[] arr= {213,43,22,11,324,11,4}; insertSort(arr); } public static void insertSort(int[] arr){ for (int i=1;i&lt;arr.length;i++){ //å¾…æ’å…¥æ•°æ® int insertVal=arr[i]; //å¾…æ’å…¥ä½ç½®ä¸‹æ ‡ int insertIndex=i-1; /** * å¦‚æœå¾…æ’å…¥ä¸‹æ ‡å°äºé›¶ï¼Œè¯´æ˜å¾…æ’å…¥æ•°æ®æœ€å°ï¼Œåº”æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½® * å¦‚æœå¾…æ’å…¥å€¼å¤§äºarr[inserIndex]ï¼Œåˆ™åœæ­¢å¾ªç¯ï¼Œè¯´æ˜å¾…æ’å…¥å€¼åœ¨æœ‰åºè¡¨ä¸­æ˜¯æœ€å¤§çš„ï¼Œåº”æ’å…¥åˆ°å½“å‰insertIndexåä¸€ä¸ªä½ç½® */ while (insertIndex&gt;=0 &amp;&amp; insertVal&lt;arr[insertIndex]){ arr[insertIndex+1]=arr[insertIndex]; insertIndex--; } arr[insertIndex+1]=insertVal; System.out.println(\"ç¬¬\"+i+\"æ¬¡æ’åºç»“æœï¼š\"); System.out.println(Arrays.toString(arr)); } }} ç»“æœï¼š 123456789101112ç¬¬1æ¬¡æ’åºç»“æœï¼š[43, 213, 22, 11, 324, 11, 4]ç¬¬2æ¬¡æ’åºç»“æœï¼š[22, 43, 213, 11, 324, 11, 4]ç¬¬3æ¬¡æ’åºç»“æœï¼š[11, 22, 43, 213, 324, 11, 4]ç¬¬4æ¬¡æ’åºç»“æœï¼š[11, 22, 43, 213, 324, 11, 4]ç¬¬5æ¬¡æ’åºç»“æœï¼š[11, 11, 22, 43, 213, 324, 4]ç¬¬6æ¬¡æ’åºç»“æœï¼š[4, 11, 11, 22, 43, 213, 324] å››ã€æµ‹è¯•100000æ¡æ•°æ®è€—æ—¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.wml.sort;import java.util.Arrays;/** * @author *** * @date 2019/10/2816:55 */public class InsertSort { public static void main(String[] args) { int[] array =new int[100000]; for (int i=0;i&lt;100000;i++){ array[i]=(int)(Math.random()*100000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); insertSort(array); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); } public static void insertSort(int[] arr){ for (int i=1;i&lt;arr.length;i++){ //å¾…æ’å…¥æ•°æ® int insertVal=arr[i]; //å¾…æ’å…¥ä½ç½®ä¸‹æ ‡ int insertIndex=i-1; /** * å¦‚æœå¾…æ’å…¥ä¸‹æ ‡å°äºé›¶ï¼Œè¯´æ˜å¾…æ’å…¥æ•°æ®æœ€å°ï¼Œåº”æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½® * å¦‚æœå¾…æ’å…¥å€¼å¤§äºarr[inserIndex]ï¼Œåˆ™åœæ­¢å¾ªç¯ï¼Œè¯´æ˜å¾…æ’å…¥å€¼åœ¨æœ‰åºè¡¨ä¸­æ˜¯æœ€å¤§çš„ï¼Œåº”æ’å…¥åˆ°å½“å‰insertIndexåä¸€ä¸ªä½ç½® */ while (insertIndex&gt;=0 &amp;&amp; insertVal&lt;arr[insertIndex]){ arr[insertIndex+1]=arr[insertIndex]; insertIndex--; } arr[insertIndex+1]=insertVal; } }} ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572254640158ç»“æŸæ—¶é—´1572254641586ç”¨æ—¶ï¼š1428ms ç›¸æ¯”ä¸Šä¸€ç¯‡çš„é€‰æ‹©æ’åºçš„5811msæ€»ä½“åˆå¿«äº†è®¸å¤š","link":"/posts/20200107-insertSort.html"},{"title":"é€‰æ‹©æ’åº  ------javaå®ç°","text":"ä¸€ã€é€‰æ‹©æ’åºçš„æ€æƒ³ç¬¬ä¸€æ¬¡ä»arr[0]~arr[n-1]ä¸­é€‰å–æœ€å°å€¼ä¸arr[0]äº¤æ¢ï¼Œç¬¬äºŒæ¬¡ä»arr[1]åˆ°arr[n-1]ä¸­é€‰å–æœ€å°å€¼ä¸arr[1]äº¤æ¢ï¼Œç¬¬ä¸‰æ¬¡ä»arr[2]åˆ°arr[n-1]ä¸­é€‰å–æœ€å°å€¼ä¸arr[2]äº¤æ¢ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæ€»å…±å¾ªç¯n-1æ¬¡ï¼Œå¾—åˆ°ä¸€ä¸ªä»å°åˆ°å¤§çš„æœ‰åºåºåˆ—ã€‚ äºŒã€æ€è·¯è¯¦è§£å¾…æ’åºå…ƒç´ ï¼š [34] 54 123 55 11 22 ç¬¬ä¸€æ¬¡æ’åºï¼š [11,34] 54 123 55 22ç¬¬äºŒæ¬¡æ’åº : [11,22,34] 54 123 55ç¬¬ä¸‰æ¬¡æ’åºï¼š [11,22,34,54] 123 55ç¬¬å››æ¬¡æ’åºï¼š [11,22,34,54,55] 123 è¯´æ˜(è¿™é‡ŒæŒ‰ä»å°åˆ°å¤§)ï¼š 1.é€‰æ‹©æ’åºå…±è¿›è¡Œæ•°ç»„å¤§å°-1æ¬¡æ’åº2.æ¯æ¬¡æ’åºä¸­ï¼Œå…ˆè®¾å½“å‰çš„æ•°æ˜¯æœ€å°å€¼ï¼Œç„¶åä¾æ¬¡å’Œåé¢çš„æ•°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°æœ‰æ¯”è¿™ä¸ªæ•°å°çš„ï¼Œå°±è®©æœ€å°çš„æ•°ä¸ºè¿™ä¸ªæ•°ï¼Œå¾—åˆ°æœ€å°å€¼ä¸‹æ ‡ï¼Œéå†ä¸€ä¸ªå¾ªç¯åï¼Œå¾—åˆ°æœ€å°å€¼å’Œä¸‹æ ‡3.å¦‚æœè¯¥å°æ ‡ä¸ä¸€å¼€å§‹çš„ä¸ä¸€æ ·ï¼Œè¯´æ˜å­˜åœ¨æ¯”å¼€å§‹è®¾å®šçš„æœ€å°çš„æ•°è¿˜å°çš„æ•°ï¼Œå°†äºŒè€…äº¤æ¢ï¼Œè¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯ ä¸‰ã€ä»£ç å®ç°12345678910111213141516171819202122232425public static void selectSort(int[] arr){ for (int i=0;i&lt;arr.length-1;i++){ int minIndex=i; int min=arr[i]; for (int j=i+1;j&lt;arr.length;j++){ if (min&gt;arr[j]){ min=arr[j]; minIndex=j; } } //å°†æœ€å°å€¼æ”¾åœ¨arr[0]ã€‚å³äº¤æ¢ if (minIndex!=i){ arr[minIndex]=arr[i]; arr[i]=min; } System.out.println(\"ç¬¬\"+(i+1)+\"è½®åç»“æœ\"); System.out.println(Arrays.toString(arr)); } } public static void main(String[] args) { int[] array={101,222,119,1}; SelectSort.selectSort(array); } ç»“æœï¼š 123456ç¬¬1è½®åç»“æœ[1, 222, 119, 101]ç¬¬2è½®åç»“æœ[1, 101, 119, 222]ç¬¬3è½®åç»“æœ[1, 101, 119, 222] æµ‹è¯•100000æ¡æ•°æ®æ‰§è¡Œæ—¶é—´ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.wml.sort;import java.util.Arrays;/** * é€‰æ‹©æ’åº * @author MaoLin Wang * @date 2019/10/2811:24 */public class SelectSort { public static void main(String[] args) { //int[] array={101,222,119,1}; int[] array =new int[100000]; for (int i=0;i&lt;100000;i++){ array[i]=(int)(Math.random()*100000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); SelectSort.selectSort(array); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); } public static void selectSort(int[] arr){ for (int i=0;i&lt;arr.length-1;i++){ int minIndex=i; int min=arr[i]; for (int j=i+1;j&lt;arr.length;j++){ if (min&gt;arr[j]){ min=arr[j]; minIndex=j; } } //å°†æœ€å°å€¼æ”¾åœ¨arr[0]ã€‚å³äº¤æ¢ if (minIndex!=i){ arr[minIndex]=arr[i]; arr[i]=min; } //System.out.println(\"ç¬¬\"+(i+1)+\"è½®åç»“æœ\"); //System.out.println(Arrays.toString(arr)); } }} ç»“æœï¼šç”¨æ—¶ï¼š 123å¼€å§‹æ—¶é—´1572251978745ç»“æŸæ—¶é—´1572251984556ç”¨æ—¶ï¼š5811ms ç›¸æ¯”ä¸Šä¸€ç¯‡å†’æ³¡æ’åºçš„22113mså¿«äº†è®¸å¤š å¹³å‡æ—¶é—´ï¼š O(nÂ²)æœ€å·®ï¼š Oï¼ˆnÂ²ï¼‰æ˜¯å¦ç¨³å®šï¼š ä¸ç¨³å®šç©ºé—´å¤æ‚åº¦ï¼š Oï¼ˆ1ï¼‰å¤‡æ³¨ï¼š nå°æ—¶è¾ƒå¥½","link":"/posts/20200107-selectSort.html"},{"title":"Linuxå‘½ä»¤æ•´ç†-------------æ–‡ä»¶ç®¡ç†ç›¸å…³(ä¸€)","text":"catè¯´æ˜ï¼šç”¨æ¥æ˜¾ç¤ºæ–‡æœ¬å†…å®¹(å°æ–‡ä»¶)ï¼Œå¯¹äºå¤§æ–‡ä»¶æ¨èä½¿ç”¨moreå‘½ä»¤ æ ¼å¼ï¼š cat +é€‰é¡¹+æŒ‡å®šæ–‡ä»¶ â€‹ é€‰é¡¹ï¼š 123&gt; -n æˆ– --numberï¼šæ˜¾ç¤ºè¡Œå·ï¼›&gt; -b æˆ– --number-nonblankï¼šç¼–å·æ—¶å¿½ç•¥ç©ºç™½è¡Œ&gt; -Aï¼šæ˜¾ç¤ºä¸å¯æ‰“å°å­—ç¬¦ï¼Œè¡Œå°¾æ˜¾ç¤ºâ€œ$â€ï¼› å¦‚ï¼š 1234567echo xxx&gt;test è‹¥testä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºtestå¹¶å†™å…¥xxxï¼Œå¦åˆ™ç›´æ¥å†™å…¥cat 123.txt å±å¹•æ˜¾ç¤º123.txtå†…å®¹cat æ–‡æœ¬1 æ–‡æœ¬2 ... æ˜¾ç¤ºå¤šä¸ªæ–‡æœ¬å†…å®¹cat æ–‡æœ¬1 æ–‡æœ¬2 &gt; æ–‡æœ¬3 å°†æ–‡æœ¬1å’Œ2çš„å†…å®¹åˆå¹¶åˆ°æ–‡æœ¬3ä¸­cat æ–‡æœ¬1 &gt; æ–‡æœ¬2 å°†æ–‡æœ¬1å†…å®¹æ‹·è´åˆ°æ–‡æœ¬2cat /dev/null &gt; æ–‡æœ¬1 æ¸…ç©ºæ–‡æœ¬1çš„å†…å®¹cat &gt;test1.txt &lt;&lt;stop å‘test1.txtå†™å…¥å†…å®¹ï¼Œè¾“å…¥stopç»“æŸ æ³¨æ„ï¼šæ¯æ¬¡åˆå¹¶æ—¶ï¼Œæ–‡æœ¬3çš„å†…å®¹ä¼šè¢«é‡æ–°è¦†ç›– moreå…¨å±å¹•æ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶å†…å®¹ é€‰é¡¹ï¼š12345-æ•°å­—ï¼šæ¯å±æ˜¾ç¤ºæŒ‡å®šè¡Œ-cï¼šä¸è¿›è¡Œæ»šå±æ“ä½œã€‚æ¯æ¬¡åˆ·æ–°è¿™ä¸ªå±å¹•ï¼›-sï¼šå°†å¤šä¸ªç©ºè¡Œå‹ç¼©æˆä¸€è¡Œæ˜¾ç¤ºï¼›-uï¼šç¦æ­¢ä¸‹åˆ’çº¿ï¼›+æ•°å­—ï¼šä»æŒ‡å®šæ•°å­—çš„è¡Œå¼€å§‹æ˜¾ç¤ºã€‚ æŸ¥çœ‹æ—¶å¯ç”¨å‘½ä»¤ï¼š Spaceé”®ï¼šæ˜¾ç¤ºæ–‡æœ¬çš„ä¸‹ä¸€å±å†…å®¹ã€‚ Enteré”®ï¼šæ¯æ¬¡åˆ·æ–°ä¸€è¡Œ Hé”®ï¼šæ˜¾ç¤ºç›¸å…³çš„å¸®åŠ©ä¿¡æ¯ Bé”®ï¼šæŸ¥çœ‹ä¸Šä¸€å± qé”®ï¼šé€€å‡º â€‹â€‹ cd1.cd : è¿›å…¥ç›®å½• 2.cd ~: è¿›å…¥ç”¨æˆ·ç›®å½• 3.cd - : è¿›å…¥å†å²ä¸Šä¸€çº§ç›®å½•ï¼Œå³è¿›æ­¤ç›®å½•ä¹‹å‰çš„é‚£ä¸ªç›®å½• 4.cd .. ï¼šè¿”å›ä¸Šçº§ç›®å½• cd ../../ æœ‰å‡ ä¸ª.../å°±è¿”å›ä¸Šå‡ çº§ç›®å½• ls æ˜¾ç¤ºç›®æ ‡åˆ—è¡¨ é€‰é¡¹ -a æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼ˆåœ¨linuxä¸­ä»¥.å¼€å¤´çš„æ–‡ä»¶ä¸ºéšè—æ–‡ä»¶ï¼‰ -l æ˜¾ç¤ºæ–‡æœ¬çš„è¯¦æƒ…åŒ…æ‹¬(æƒé™ã€æ‹¥æœ‰è€…ã€æ–‡ä»¶å¤§å°ã€æœ€åä¿®æ”¹æ—¶é—´ç­‰) -r å°†æ–‡ä»¶ååºæ˜¾ç¤º(é»˜è®¤æŒ‰ç…§è‹±æ–‡å­—æ¯é¡ºåº) -t æŒ‰ç…§åˆ›å»ºæ—¶é—´åˆ—å‡º -A åŒ -a ï¼Œä½†ä¸åˆ—å‡º &quot;.&quot; (ç›®å‰ç›®å½•) åŠ &quot;..&quot; (çˆ¶ç›®å½•) -F åœ¨æ–‡ä»¶åç§°ååŠ ä¸€ä¸ªç¬¦å·ï¼š *ï¼šä»£è¡¨å¯æ‰§è¡Œæ¡£ /ï¼š ä»£è¡¨ç›®å½• -R æœ‰æ–‡ä»¶çš„ç›®å½•ï¼Œä¹Ÿä¼šå°†å…¶å­æ–‡ä»¶åˆ—å‡º â€‹ -Rä¸¾ä¾‹ï¼š -Fä¸¾ä¾‹ï¼štest2æ˜¯ä¸€ä¸ªç›®å½•ã€‚æ‰€ä»¥åœ¨åè¾¹æ˜¾ç¤ºäº†ä¸€ä¸ª/ pwd æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰ head æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶å‰Nè¡Œ é€‰é¡¹ï¼š -nï¼šæŒ‡å®šæ˜¾ç¤ºå‰nè¡Œ -vï¼šæ˜¾ç¤ºæ–‡ä»¶åçš„å¤´ä¿¡æ¯ï¼› -qï¼šä¸æ˜¾ç¤ºæ–‡ä»¶åçš„å¤´ä¿¡æ¯ã€‚ tail æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶çš„æœ«å°¾Nè¡Œï¼Œé»˜è®¤10è¡Œ é€‰é¡¹ï¼š -c,â€“bytes=ï¼šæ˜¾ç¤ºæ–‡ä»¶å°¾éƒ¨çš„Nï¼ˆNä¸ºæ•´æ•°ï¼‰ä¸ªå­—èŠ‚å†… -f&lt;name/descriptor&gt;ï¼šåŠ¨æ€æ˜¾ç¤ºæ–‡ä»¶å°¾éƒ¨å†…å®¹ï¼Œå¦‚æŸä¸ªåŠ¨æ€æ›´æ–°çš„æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨-fæŸ¥çœ‹æœ€æ–°çš„å†…å®¹ -nï¼šè¾“å‡ºæ–‡ä»¶çš„å°¾éƒ¨Nï¼ˆNä½æ•°å­—ï¼‰è¡Œå†…å®¹ã€‚ â€“pid=&lt;è¿›ç¨‹å·&gt;ï¼šä¸â€œ-fâ€é€‰é¡¹è¿ç”¨ï¼Œå½“æŒ‡å®šçš„è¿›ç¨‹å·çš„è¿›ç¨‹ç»ˆæ­¢æ—¶é€€å‡ºè¯¥å‘½ä»¤-q,â€“quiet,â€“silentï¼šå½“æœ‰å¤šä¸ªæ–‡ä»¶å‚æ•°æ—¶ï¼Œä¸è¾“å‡ºå„ä¸ªæ–‡ä»¶åï¼› -s&lt;ç§’æ•°&gt;,â€“sleep-interal=&lt;ç§’æ•°&gt;ï¼šä¸â€œ-fâ€è¿ç”¨ï¼ŒæŒ‡å®šæ–‡ä»¶å˜åŒ–æ—¶é—´éš”(s) -v,â€“verboseï¼šå½“æœ‰å¤šä¸ªæ–‡ä»¶å‚æ•°æ—¶ï¼Œæ€»æ˜¯è¾“å‡ºå„ä¸ªæ–‡ä»¶åï¼› â€“helpï¼šå¸®åŠ©ä¿¡æ¯ â€“versionï¼šæŒ‡ä»¤ç‰ˆæœ¬ ä¸¾ä¾‹ï¼š 12345tail test ä¸æŒ‡å®šè¡Œæ•°é»˜è®¤æ˜¾ç¤ºæ–‡ä»¶testçš„æœ€å10è¡Œtail -n +10 test ä»ç¬¬10è¡Œåˆ°æœ€åtail -c 10 test æ˜¾ç¤ºè¯¥æ–‡ä»¶çš„æœ€å10ä¸ªå­—ç¬¦tail -25 nginx.log æ˜¾ç¤ºæœ€åçš„ 25 è¡Œtail -f nginx.log åŠ¨æ€åˆ·æ–°è¯¥æ–‡ä»¶æœ€åçš„å†…å®¹ chmodä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•çš„æƒé™ æƒé™èŒƒå›´ï¼šu: â€“&gt; User ï¼Œå½“å‰æ–‡ä»¶/ç›®å½•çš„æ‹¥æœ‰è€…g: â€“&gt; Group ï¼Œ æ‰€å±ç»„o: â€“&gt; Other ï¼Œ é™¤Userå’Œæ‰€å±ç¾¤ç»„ä¹‹å¤–çš„æ‰€æœ‰ç”¨æˆ·a: â€“&gt; All ï¼Œ æ‰€æœ‰ç”¨æˆ·r: â€“&gt; è¯»æƒé™ï¼Œæ•°å­— 4w:â€“&gt; å†™æƒé™ï¼Œæ•°å­— 2x: æ‰§è¡Œ/åˆ‡æ¢æƒé™ï¼Œæ•°å­— 1- æ— æƒé™ï¼Œæ•°å­— 0 è¯­æ³•ï¼š chmod [options][å‚æ•°] é€‰é¡¹ï¼š 1234567891011121314151617+ æ·»åŠ æŸäº›æƒé™- å–æ¶ˆæŸäº›æƒé™= æŒ‡å®šæ–‡ä»¶æƒé™r è¯»æƒé™w å†™æƒé™x å¯æ‰§è¡Œæƒé™- æ— æƒé™X ç»™å¯æ‰§è¡Œæ–‡ä»¶è®¾ç½®å¯æ‰§è¡Œæƒé™t åªæœ‰ç›®å½•æˆ–æ–‡ä»¶çš„æ‰€æœ‰è€…æ‰å¯ä»¥åˆ é™¤ç›®å½•ä¸‹çš„æ–‡ä»¶-c ,--changes æ•ˆæœç±»ä¼¼â€œ-vâ€å‚æ•°ï¼Œä½†ä»…å›æŠ¥æ›´æ”¹çš„éƒ¨åˆ†ï¼Œå¦‚æœæ–‡ä»¶æƒé™å·²ç»æ”¹å˜ï¼Œæ˜¾ç¤ºå…¶æ“ä½œä¿¡æ¯ï¼›-f , --quiet, --silent æ“ä½œè¿‡ç¨‹ä¸­ä¸æ˜¾ç¤ºä»»ä½•é”™è¯¯ä¿¡æ¯ï¼›-R, --recursive ä»¥é€’å½’æ›´æ”¹å…¶æœ¬èº«åŠå­ç›®å½•-v, --verbose æ˜¾ç¤ºè¯¦æƒ…ä¿¡æ¯--reference=&lt;å‚è€ƒæ–‡ä»¶æˆ–ç›®å½•&gt; æŒ‡å®šå‚è€ƒæ–‡ä»¶ï¼Œéè‡ªå®šä¹‰æƒé™--help æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯--version æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ æƒé™ç»“æ„ï¼š 1-rwxr--r-- 1 user staff 651 Nov 11 11:02 .ignore ç¬¬ä¸€ä¸ª -: ä»£è¡¨æ˜¯æ™®é€šæ–‡ä»¶ï¼Œè‹¥æ˜¯ dï¼Œåˆ™ä»£è¡¨ç›®å½• ç¬¬ä¸€ç»„rwxï¼šå³ä¸Šè¾¹çš„rw-,è¡¨ç¤ºuå±ç»„ ç¬¬äºŒç»„rwx: å³ä¸Šè¾¹ä¸­é—´çš„râ€“ï¼Œè¡¨ç¤ºgå±ç»„ ç¬¬ä¸‰ç»„rwx: å³ä¸Šè¾¹æœ€åçš„râ€“ï¼Œ è¡¨ç¤ºå…¶ä»–äººçš„æƒé™ r:è¯» 4 wï¼šå†™ 2 xï¼šæ‰§è¡Œ 1 ä¸¾ä¾‹: 1234567chmod u+w,g+r test1 ä¸ºtest1è®¾ç½®å½“å‰ç”¨æˆ·å¯å†™ï¼Œç»„å¯è¯»çš„æƒé™chmod u=rwx,g=rw,o=r test1 å½“å‰ç”¨æˆ·å¯è¯»å†™æ‰§è¡Œï¼Œç»„å¯è¯»å†™ï¼Œå…¶ä»–ç”¨æˆ·åªèƒ½è¯»chmod 764 test1 å½“å‰ç”¨æˆ·è¯»å†™æ‰§è¡Œï¼Œç»„è¯»å†™ï¼Œå…¶ä»–åªå¯è¯»chmod a+r test1 æ‰€æœ‰ç”¨æˆ·éƒ½åªå¯è¯»test1chmod ugo-r test1 æ‰€æœ‰ç”¨æˆ·å‡æ‰å¯è¯»æƒé™ chmod -R 755 /usr/local/test/ é€’å½’ä¿®æ”¹testç›®å½•ä¸‹çš„å­æ–‡ä»¶çš„æƒé™ä¸º 755,7å³4+2+1ï¼Œ5å³4+1chown john:student test1 æŠŠtest1ç»™Johnï¼Œæ·»åŠ åˆ°studentç»„ chown æ”¹å˜æ–‡ä»¶æˆ–ç›®å½•çš„æ‹¥æœ‰è€…æˆ–æ‰€å±ç¾¤ç»„ å¯ä»¥ç»™æŸä¸ªç”¨æˆ·æˆæƒï¼Œä½¿è¯¥ç”¨æˆ·å˜æˆæŒ‡å®šæ–‡ä»¶çš„æ‰€æœ‰è€…æˆ–è€…æ”¹å˜æ–‡ä»¶æ‰€å±çš„ç»„ã€‚ è¯­æ³•ï¼š chown [options][å‚æ•°] é€‰é¡¹ï¼š 12345-cï¼Œ--changesï¼šæ˜¾ç¤ºä¿®æ”¹çš„éƒ¨åˆ†ï¼›-f ï¼šä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼›-hï¼šåªå¯¹ç¬¦å·è¿æ¥çš„æ–‡ä»¶ä½œä¿®æ”¹ï¼Œè€Œä¸æ›´æ”¹å…¶ä»–ä»»ä½•ç›¸å…³æ–‡ä»¶ï¼›-Rï¼šé€’å½’å¤„ç†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠå­ç›®å½•-vï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¿¡æ¯ 123chown -R wml:mygroup /usr/local/test1 å°†/usr/local/testä¸‹é¢çš„æ‰€æœ‰æ–‡ä»¶ä»¥åŠå­ç›®å½•çš„æ–‡ä»¶æ‹¥æœ‰è€…æ”¹ä¸ºwml,ç¾¤ç»„ä¸ºmygroup - ## cmp æ¯”è¾ƒä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦æœ‰å·®å¼‚ï¼Œè‹¥æ— å·®å¼‚åˆ™ä¸æ˜¾ç¤ºä»»ä½•ä¿¡æ¯ï¼Œè‹¥æœ‰å·®å¼‚åˆ™æ˜¾ç¤ºç¬¬ä¸€ä¸ªä¸åŒçš„åœ°æ–¹çš„å­—ç¬¦å’Œåˆ—æ•° **è¯­æ³•ï¼š** cmp [options][å‚æ•°] **é€‰é¡¹ï¼š** 12-lï¼šå¯¹äºæ¯å¤„ä¸åŒï¼Œæ˜¾ç¤ºåè¿›åˆ¶çš„å­—èŠ‚æ•°å’Œå…«è¿›åˆ¶çš„ä¸åŒå­—èŠ‚ã€‚ï¼›-sï¼Œ--quitï¼Œ--silentï¼šä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼› **ä¸¾ä¾‹:** 123.txt ï¼š æˆ‘æ˜¯123 222 222.txt: æˆ‘æ˜¯222 222 1cmp 123.txt 222.txt --ç»“æœ--&gt;123.txt 222.txt differ: byte 1, line 1 - ## diff æ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒï¼Œè¯¥å‘½ä»¤æ˜¯é‡‡å–é€è¡Œæ¯”è¾ƒçš„æ–¹å¼ï¼Œ **é€‰é¡¹ï¼š** 12345678910111213-&lt;è¡Œæ•°&gt;ï¼šæŒ‡å®šæ˜¾ç¤ºå¤šå°‘è¡Œçš„æ–‡æœ¬-aï¼Œ--textï¼šå°†æ–‡ä»¶å½“åšæ–‡æœ¬æ–‡ä»¶å¤„ç†-bï¼šå¿½ç•¥ç©ºæ ¼å­—ç¬¦é€ æˆçš„ä¸åŒï¼›-Bï¼Œ--ignore-blank-linesï¼šå¿½ç•¥ç©ºç™½è¡Œï¼›-cï¼šæ˜¾ç¤ºä¸¤ä¸ªæ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ï¼Œå¹¶æ ‡å‡ºä¸åŒä¹‹å¤„-Hï¼Œ--speed-large-filesï¼šåŠ é€Ÿå¤§æ–‡ä»¶æ£€ç´¢-iï¼Œ--ignore-caseï¼šå¿½ç•¥å¤§å°å†™ä¸åŒ-læˆ–â€”â€”paginateï¼šåˆ†é¡µ-qæˆ–--briefï¼šä»…æ˜¾ç¤ºæœ‰æ— å·®å¼‚ï¼Œä¸æ˜¾ç¤ºè¯¦ç»†çš„ä¿¡æ¯ æœ‰ä¸åŒçš„ç»“æœ:Files 123.txt and 222.txt differ-rï¼Œ--recursiveï¼šæ¯”è¾ƒå­ç›®å½•ä¸­çš„æ–‡ä»¶-Tï¼šæ¯è¡Œå¯¹é½è¾“å‡º-yï¼šå¹¶åˆ—æ‰“å° ä¸¾ä¾‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20191028231857879.png) - ## file æ£€æµ‹ç›®æ ‡æ–‡ä»¶ç±»å‹ **é€‰é¡¹ï¼š** 1234-bï¼šä¸æ˜¾ç¤ºæ–‡ä»¶åç§°L-Lï¼šç›´æ¥æ˜¾ç¤ºç¬¦å·è¿æ¥æ‰€æŒ‡å‘çš„æ–‡ä»¶ç±»åˆ«ï¼›-vï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼›-zï¼šå°è¯•å»è§£è¯»å‹ç¼©æ–‡ä»¶çš„å†…å®¹ã€‚ **ä¸¾ä¾‹ï¼š** 123[admin@ test]$ file 123.txt 222.txt123.txt: UTF-8 Unicode text222.txt: UTF-8 Unicode text findæŸ¥è¯¢æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶é€‰é¡¹ï¼š 123456789101112131415161718192021-depthï¼šä»æŒ‡å®šç›®å½•çš„æœ€æ·±å±‚çš„å­ç›®å½•å¼€å§‹æŸ¥æ‰¾-maxdepth&lt;ç›®å½•æ·±åº¦&gt;ï¼šæœ€å¤§ç›®å½•æ·±åº¦-mindepth&lt;ç›®å½•æ·±åº¦&gt;ï¼šæœ€å°ç›®å½•å±‚çº§ï¼›-emptyï¼šæŸ¥æ‰¾å¤§å°ä¸º0 çš„æ–‡ä»¶æˆ–ç©ºç›®å½•-exec&lt;è¦æ‰§è¡Œçš„æŒ‡ä»¤&gt;ï¼šè‹¥findæŒ‡ä»¤è¿”å›Trueï¼Œå°±æ‰§è¡Œç›®æ ‡æŒ‡ä»¤(å¦‚æ‰¾åˆ°ç©ºçš„å°±æ‰§è¡Œrmåˆ é™¤ç›®æ ‡æ–‡ä»¶)-fstype&lt;æ–‡ä»¶ç³»ç»Ÿç±»å‹&gt;ï¼šåªå¯»æ‰¾è¯¥æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸‹çš„æ–‡ä»¶æˆ–ç›®å½•ï¼›-lsï¼šå°†æ–‡ä»¶æˆ–ç›®å½•åç§°åˆ—å‡ºåˆ°æ ‡å‡†è¾“å‡º(æƒé™ä¿¡æ¯ï¼Œæ‰€å±ç”¨æˆ·ã€ç»„ï¼Œæ—¶é—´ä¿¡æ¯ç­‰)-name&lt;inputname&gt;ï¼Œ-inameï¼šæŸ¥è¯¢åç§°ç¬¦åˆinputnameçš„æ–‡ä»¶ï¼Œ-inameå¿½ç•¥å¤§å°å†™-anewer test : æ¯”æ–‡ä»¶ file æ›´æ™šè¢«è¯»å–è¿‡çš„æ–‡ä»¶-path&lt;testPath&gt;ï¼Œ-ipath&lt;testPath&gt;ï¼šè·¯å¾„ç¬¦åˆtestPathçš„æ–‡ä»¶,-ipath å¿½ç•¥å¤§å°å†™-perm&lt;æƒé™å€¼&gt;ï¼šæŸ¥æ‰¾ç¬¦åˆæŒ‡å®šçš„æƒé™æ•°å€¼çš„æ–‡ä»¶-printï¼šå°†æ–‡ä»¶æˆ–ç›®å½•åç§°åˆ—å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚æ ¼å¼ä¸ºæ¯åˆ—ä¸€ä¸ªåç§°ï¼Œæ¯ä¸ªåç§°å‰çš†æœ‰â€œ./â€å­—ç¬¦ä¸²ï¼›-printf&lt;è¾“å‡ºæ ¼å¼&gt;ï¼šè‡ªå®šä¹‰æ ¼å¼è¾“å‡º-size&lt;æ–‡ä»¶å¤§å°&gt;ï¼šæŸ¥æ‰¾ç¬¦åˆæŒ‡å®šå¤§å°çš„æ–‡ä»¶-type&lt;æ–‡ä»¶ç±»å‹&gt;ï¼šæŒ‡å®šçš„æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶-user&lt;æ‹¥æœ‰è€…åç§°&gt;ï¼šæŒ‡å®šç”¨æˆ·æ‹¥æœ‰çš„æ–‡ä»¶ ä¸¾ä¾‹ï¼š 1.find. åˆ—å‡ºå½“å‰ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶åŠå…¶å­æ–‡ä»¶ 123456789 find . ç»“æœï¼š../333.txt./222.txt./test2./test2/123.txt./123.txt./empty.txt 2.find /usr/test -name â€œ*.txtâ€ï¼šæŸ¥æ‰¾testç›®å½•ä¸‹åç¼€åä¸ºtxtçš„æ–‡ä»¶ 1234567find /usr/test -name \"*.txt\"ç»“æœï¼š/usr/test/333.txt/usr/test/222.txt/usr/test/test2/123.txt/usr/test/123.txt/usr/test/empty.txt 3.find /usr/test ! -name â€œ*.txtâ€ï¼šæŸ¥æ‰¾testç›®å½•ä¸‹åç¼€åä¸æ˜¯txtçš„æ–‡ä»¶ 4.æ ¹æ®æ–‡ä»¶ç±»å‹æŸ¥æ‰¾ -type: 1find . -type å‚æ•° ç±»å‹å‚æ•°ï¼š f ï¼šæ™®é€šæ–‡ä»¶ l ï¼šç¬¦å·è¿æ¥ d ï¼šç›®å½• c ï¼šå­—ç¬¦è®¾å¤‡ b ï¼šå—è®¾å¤‡ s ï¼šå¥—æ¥å­— p ï¼šFifo 5.æŸ¥æ‰¾å°äº3kçš„æ–‡ä»¶ 1find . -size -3k ç»“æœï¼š ./333.txt ./222.txt ./test2/123.txt ./123.txt ./empty.txt 6.æŸ¥æ‰¾å¤§å°ä¸º0çš„æ–‡ä»¶ 12[root@ test] find -empty./empty.txt 7.æŸ¥æ‰¾æŒ‡å®šæƒé™çš„æ–‡ä»¶ é¦–å…ˆç»™123.txtèµ‹äºˆ77æƒé™ï¼š 1chmod 777 123.txt æŸ¥çœ‹ä¸‹ç»“æœï¼š 12345-rwxrwxrwx 1 777 root 21 Oct 28 23:08 123.txt-rw-r--r-- 1 root root 15 Oct 28 22:57 222.txt-rw-r--r-- 1 root root 23 Oct 27 22:46 333.txt-rw-r--r-- 1 root root 0 Oct 29 15:20 empty.txtdrwxr-xr-x 2 root root 4096 Oct 27 19:52 test2 åªæœ‰123.txtçš„æƒé™ä¸º777, æ‰§è¡ŒæŸ¥æ‰¾ï¼š 1find -perm 777 ç»“æœï¼š 1./123.txt â€‹ æŒç»­æ›´æ–°â€¦â€¦â€¦","link":"/posts/20200106-linux_file_1.html"},{"title":"ï¼ˆå¤ä¹ ï¼‰äºŒå‰æ ‘çš„ä¸‰ç§éå†æ–¹å¼ã€æŸ¥æ‰¾å’Œåˆ é™¤----------Javaå®ç°","text":"ä¸€ã€æ¦‚å¿µï¼šäºŒå‰æ ‘äºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåªèƒ½ç”±ä¸¤ä¸ªå­èŠ‚ç‚¹ æ€§è´¨ï¼š äºŒå‰æ ‘çš„ç¬¬ i å±‚æœ€å¤šæœ‰ 2 ^ (i-1) ä¸ªèŠ‚ç‚¹ æ·±åº¦ä¸º k ï¼ˆ kâ‰¥0 ï¼‰çš„äºŒå‰æ ‘æœ€å°‘æœ‰ k ä¸ªèŠ‚ç‚¹(ä¸€å±‚ä¸€ä¸ª)ï¼Œæœ€å¤šæœ‰ ï¼ˆ2^k ï¼‰-1 ä¸ªèŠ‚ç‚¹ ï¼ˆç©ºæ ‘k=0ï¼Œåªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹k=1ï¼‰ å¯¹äºä»»æ„ä¸€ä¸ªéç©ºäºŒå‰æ ‘ï¼Œè‹¥å…¶ å¶å­èŠ‚ç‚¹æ•°ä¸º nï¼Œåº¦ä¸º2çš„éå¶å­èŠ‚ç‚¹æ•°ä¸º mï¼Œåˆ™ ==n=m+1==ï¼Œï¼ˆåº¦ å³èŠ‚ç‚¹æ‰€æ‹¥æœ‰çš„å­æ ‘çš„ä¸ªæ•°ï¼‰ å¦‚æœèŠ‚ç‚¹æ€»æ•°ä¸º 2^n-1 ä¸”æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨æœ€åä¸€å±‚ï¼Œåˆ™è¯¥æ ‘ä¸º==æ»¡äºŒå‰æ ‘== å¦‚æœè¯¥äºŒå‰æ ‘çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨æœ€åä¸€å±‚æˆ–è€…å€’æ•°ç¬¬äºŒå±‚ï¼Œè€Œä¸”æœ€åä¸€å±‚çš„å¶å­èŠ‚ç‚¹åœ¨å·¦è¾¹è¿ç»­ï¼Œå€’æ•°ç¬¬äºŒå±‚çš„å¶å­èŠ‚ç‚¹åœ¨å³è¾¹è¿ç»­ï¼Œåˆ™ç§°ä¸º==å®Œå…¨äºŒå‰æ ‘==ã€‚å¦‚ä¸‹ï¼š äºŒã€ä¸‰ç§éå†æ–¹å¼2.1å‰åºéå†æ ¹èŠ‚ç‚¹ â€”&gt; å·¦å­©å­ â€”&gt; å³å­©å­ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå‰åºéå†ç»“æœä¸ºï¼š11ï¼Œ21,14,81,91,15,31ï¼Œ61,71 2.2 ä¸­åºéå†å·¦å­©å­ â€“&gt; æ ¹èŠ‚ç‚¹ â€”&gt; å³å­©å­ ä¸Šå›¾ä¸ºä¾‹ï¼Œç»“æœä¸ºï¼š81,14,91,21,15,11,61,31,71 2.3 ååºéå†å·¦å­©å­ â€“&gt; å³å­©å­ â€”&gt; æ ¹èŠ‚ç‚¹ ä¸Šå›¾ä¸ºä¾‹ï¼Œç»“æœä¸ºï¼š81,91,14,15,21,61,71,31,11 ä¸‰ã€ä»£ç å®ç°éå†3.1é¦–å…ˆåˆ›å»ºTreeNodeç±»ä½œä¸ºæ•°èŠ‚ç‚¹è¿™é‡Œæ–¹ä¾¿ä½¿ç”¨ç›´æ¥éƒ½è®¾ä¸ºäº†public 12345678910111213141516171819class TreeNode { public int no;//èŠ‚ç‚¹ç¼–å· public TreeNode lchild;//å·¦å­©å­ public TreeNode rchild;//å³å­©å­ public TreeNode() { } public TreeNode(int no) { this.no = no; } @Override public String toString() { return \"TreeNode{\" + \"no=\" + no + '}'; }} 3.2 åˆ›å»ºäºŒå‰æ ‘ç±»12345678//å®šä¹‰äºŒå‰æ ‘class BinaryTree { private TreeNode root; public void setRoot(TreeNode root) { this.root = root; }} 3.3 å‰åºéå†æ–¹æ³•ï¼š 1.é¦–å…ˆè¾“å‡ºæ ¹èŠ‚ç‚¹ 2.å·¦å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å·¦å­©å­ 3.å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å³å­©å­ 1234567891011121314/** * å‰åºéå†ï¼š æ ¹èŠ‚ç‚¹-&gt;å·¦èŠ‚ç‚¹-&gt;å³èŠ‚ç‚¹ */ public void preOrder() { System.out.println(this);//å…ˆè¾“å‡ºçˆ¶èŠ‚ç‚¹ //å‘å·¦é€’å½’ if (this.lchild != null) { this.lchild.preOrder(); } //å‘å³é€’å½’ if (this.rchild != null) { this.rchild.preOrder(); } } 3.4 ä¸­åºéå†æ–¹æ³•ï¼š 1.å·¦å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å·¦å­©å­ 2.é¦–å…ˆè¾“å‡ºæ ¹èŠ‚ç‚¹ 3.å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å³å­©å­ 123456789101112131415/** * ä¸­åºéå†ï¼š å·¦èŠ‚ç‚¹-&gt;æ ¹èŠ‚ç‚¹-&gt;å³èŠ‚ç‚¹ */ public void midOrder() { //å‘å·¦é€’å½’ if (this.lchild != null) { this.lchild.midOrder(); } System.out.println(this);//è¾“å‡ºæ ¹èŠ‚ç‚¹ //å‘å³é€’å½’ if (this.rchild != null) { this.rchild.midOrder(); } } 3.5 ååºéå†æ–¹æ³•ï¼š 1.å·¦å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å·¦å­©å­ 2.å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å³å­©å­ 3.é¦–å…ˆè¾“å‡ºæ ¹èŠ‚ç‚¹ 12345678910111213141516/** * ååºéå†ï¼š å·¦èŠ‚ç‚¹-&gt;å³èŠ‚ç‚¹-&gt;æ ¹èŠ‚ç‚¹ */ public void postOrder() { //å‘å·¦é€’å½’ if (this.lchild != null) { this.lchild.postOrder(); } //å‘å³é€’å½’ if (this.rchild != null) { this.rchild.postOrder(); } System.out.println(this);//è¾“å‡ºæ ¹èŠ‚ç‚¹ } å…¶å®å°±æ˜¯æŠŠè¾“å‡ºæ ¹èŠ‚ç‚¹çš„ä½ç½®æŒ‰å…ˆä¸­åçš„é¡ºåºæ¢æ¥æ¢å» 3.6 åœ¨äºŒå‰æ ‘ä¸­è°ƒç”¨ä¸€ä¸‹æ–¹æ³•åº”å…ˆåˆ¤æ–­æ ¹èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºæ—¶æ‰éå† 123456789101112131415161718192021222324//å‰åºéå† public void preOrder(){ if (this.root!=null){ this.root.preOrder(); }else { System.out.println(\"äºŒå‰æ ‘ä¸ºç©º\"); } } //ä¸­åºéå† public void midOrder(){ if (this.root!=null){ this.root.midOrder(); }else { System.out.println(\"äºŒå‰æ ‘ä¸ºç©º\"); } } //åç»­éå† public void postOrder(){ if (this.root!=null){ this.root.postOrder(); }else { System.out.println(\"äºŒå‰æ ‘ä¸ºç©º\"); } } æµ‹è¯•æŒ‰ç…§ä¸€å¼€å§‹çš„é‚£ä¸ªå›¾åˆ›å»ºäºŒå‰æ ‘ï¼š 12345678910111213141516171819202122232425262728293031BinaryTree binaryTree=new BinaryTree(); //åˆ›å»ºæ ¹èŠ‚ç‚¹ TreeNode root = new TreeNode(11); TreeNode treeNode2 = new TreeNode(21); TreeNode treeNode3 = new TreeNode(31); TreeNode treeNode4 = new TreeNode(14); TreeNode treeNode5 = new TreeNode(15); TreeNode treeNode6 = new TreeNode(61); TreeNode treeNode7 = new TreeNode(71); TreeNode treeNode8 = new TreeNode(81); TreeNode treeNode9 = new TreeNode(91); root.lchild =treeNode2; root.rchild =treeNode3; treeNode3.rchild =treeNode7; treeNode3.lchild =treeNode6; treeNode2.lchild =treeNode4; treeNode2.rchild =treeNode5; treeNode4.lchild =treeNode8; treeNode4.rchild =treeNode9; binaryTree.setRoot(root); System.out.println(\"ä¸­åº-------\"); binaryTree.midOrder(); System.out.println(\"å‰åº--------\"); binaryTree.preOrder(); System.out.println(\"åç»­--------\"); binaryTree.postOrder(); ç»“æœï¼š 123456789101112131415161718192021222324252627282930ä¸­åº-------TreeNode{no=81}TreeNode{no=14}TreeNode{no=91}TreeNode{no=21}TreeNode{no=15}TreeNode{no=11}TreeNode{no=61}TreeNode{no=31}TreeNode{no=71}å‰åº--------TreeNode{no=11}TreeNode{no=21}TreeNode{no=14}TreeNode{no=81}TreeNode{no=91}TreeNode{no=15}TreeNode{no=31}TreeNode{no=61}TreeNode{no=71}åç»­--------TreeNode{no=81}TreeNode{no=91}TreeNode{no=14}TreeNode{no=15}TreeNode{no=21}TreeNode{no=61}TreeNode{no=71}TreeNode{no=31}TreeNode{no=11} å››ã€ä¸‰ç§éå†æŸ¥è¯¢æŸä¸ªèŠ‚ç‚¹è¿”å›èŠ‚ç‚¹ç¼–å·4.1 å‰åºéå†æ–¹æ³•ï¼š1.åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ï¼Œæ»¡è¶³çš„è¯è¿”å›è¯¥èŠ‚ç‚¹ï¼Œä¸æ»¡è¶³è¿›è¡Œ 22.åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºçš„è¯é€’å½’å‰åºéå†å·¦å­©å­3.åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºçš„è¯é€’å½’å‰åºéå†å³å­©å­å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132/** * å‰åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode preOrderFind(int no){ if (this.no==no){ return this; } TreeNode treeNode=null; /** * åˆ¤æ–­å½“å‰å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º -&gt; é€’å½’å‰åºéå†æŸ¥æ‰¾ï¼Œ * è‹¥æ‰¾åˆ°ï¼Œå°±è¿”å› */ if (this.lchild !=null){ treeNode=this.lchild.preOrderFind(no); } if (treeNode!=null){ return treeNode; } /** * åˆ¤æ–­å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º-&gt;é€’å½’å‰åºéå†ï¼Œæ— è®ºæ‰¾æ²¡æ‰¾åˆ°éƒ½è¿”å›treeNode */ if (this.rchild !=null){ treeNode=this.rchild.preOrderFind(no); } return treeNode; } 4.2 ä¸­åºéå†æ–¹æ³•ï¼šå°†å½“å‰èŠ‚ç‚¹æ”¾åœ¨å·¦å­©å­å’Œå³å­©å­ä¸­é—´å°±å¥½äº†ï¼Œå…¶ä»–åŒä¸Šå®ç°ï¼š 1234567891011121314151617181920212223242526272829303132/** * ä¸­åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode midOrderFind(int no){ TreeNode treeNode=null; /** * åˆ¤æ–­å½“å‰å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º -&gt; é€’å½’å‰åºéå†æŸ¥æ‰¾ï¼Œ * è‹¥æ‰¾åˆ°ï¼Œå°±è¿”å› */ if (this.lchild !=null){ treeNode=this.lchild.midOrderFind(no); } if (treeNode!=null){ return treeNode; } if (this.no==no){ return this; } /** * åˆ¤æ–­å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º-&gt;é€’å½’å‰åºéå†ï¼Œæ— è®ºæ‰¾æ²¡æ‰¾åˆ°éƒ½è¿”å›treeNode */ if (this.rchild !=null){ treeNode=this.rchild.midOrderFind(no); } return treeNode; } 4.3 ååºéå†æ–¹æ³•ï¼šå°†å½“å‰èŠ‚ç‚¹çš„æ¯”è¾ƒæ”¾åœ¨æœ€åå°±å¥½äº†ï¼Œå…¶ä»–åŒä¸Šå®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738/** * ååºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode postOrderFind(int no){ TreeNode treeNode=null; /** * åˆ¤æ–­å½“å‰å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º -&gt; é€’å½’å‰åºéå†æŸ¥æ‰¾ï¼Œ * è‹¥æ‰¾åˆ°ï¼Œå°±è¿”å› */ if (this.lchild !=null){ treeNode=this.lchild.postOrderFind(no); } if (treeNode!=null){ return treeNode; } /** * åˆ¤æ–­å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º-&gt;é€’å½’å‰åºéå†ï¼Œæ— è®ºæ‰¾æ²¡æ‰¾åˆ°éƒ½è¿”å›treeNode */ if (this.rchild !=null){ treeNode=this.rchild.postOrderFind(no); } if (treeNode!=null){ return treeNode; } //å·¦å³å­©å­éƒ½æ²¡æ‰¾åˆ°ï¼Œæ‰¾æ ¹èŠ‚ç‚¹ if (this.no==no){ return this; } return treeNode; } 4.4 äºŒå‰æ ‘è°ƒç”¨æŸ¥æ‰¾æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637/** * å‰åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode preOrderFind(int no){ if (root!=null){ return root.preOrderFind(no); }else { return null; } } /** * ä¸­åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode midOrderFind(int no){ if (root!=null){ return root.midOrderFind(no); }else { return null; } } /** * ååºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode postOrderFind(int no){ if (root!=null){ return root.postOrderFind(no); }else { return null; } } æµ‹è¯•ï¼šæŸ¥æ‰¾6112345678910111213141516171819202122232425//å‰åºéå†æŸ¥æ‰¾ System.out.println(\"å‰åºéå†æŸ¥æ‰¾==============\"); TreeNode treeNode = binaryTree.preOrderFind(61); if (treeNode!=null){ System.out.println(\"æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º\"+treeNode.no); }else { System.out.println(\"æ²¡æ‰¾åˆ°\"); } //ä¸­åºéå†æŸ¥æ‰¾ System.out.println(\"ä¸­åºéå†æŸ¥æ‰¾====================\") TreeNode midOrderFind = binaryTree.midOrderFind(61); if (midOrderFind!=null){ System.out.println(\"æ‰¾åˆ°äº†ï¼šç¼–å·ä¸ºï¼š\"+midOrderFind.no); }else { System.out.println(\"æ²¡æ‰¾åˆ°\"); } //ååºéå†æŸ¥æ‰¾ System.out.println(\"ååºéå†æŸ¥æ‰¾=============\"); TreeNode postOrderFind = binaryTree.postOrderFind(61); if (postOrderFind!=null){ System.out.println(\"æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º\"+postOrderFind.no); }else { System.out.println(\"æ²¡æ‰¾åˆ°\"); } ç»“æœï¼š 123456å‰åºéå†æŸ¥æ‰¾==============æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º61ä¸­åºéå†æŸ¥æ‰¾====================æ‰¾åˆ°äº†ï¼šç¼–å·ä¸ºï¼š61ååºéå†æŸ¥æ‰¾=============æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º61 äº”ã€åˆ é™¤èŠ‚ç‚¹å½“èŠ‚ç‚¹ä¸ºå¶å­èŠ‚ç‚¹æ—¶ç›´æ¥åˆ é™¤å½“èŠ‚ç‚¹ä¸ºéå¶å­èŠ‚ç‚¹æ—¶è¿åŒå…¶å­æ ‘ä¸€èµ·åˆ é™¤ï¼›(ä¸åˆ é™¤å­æ ‘çš„æ–¹æ³•åç»­è¡¥å……)æ–¹æ³•ï¼šæ¯æ¬¡çš„æ¯”è¾ƒå¯¹è±¡ä¸ºå½“å‰èŠ‚ç‚¹çš„å·¦å³å­©å­ï¼Œå½“å·¦å­©å­éç©ºä¸”ç¼–å·ä¸ç›®æ ‡èŠ‚ç‚¹ç›¸åŒï¼Œè®©å·¦å­©å­ä¸ºnullå½“å³å­©å­éç©ºä¸”ç¼–å·ä¸ç›®æ ‡èŠ‚ç‚¹ç›¸åŒï¼Œè®©å³å­©å­ä¸ºnullå½“å·¦å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå† 12345678910111213141516171819/** * é€’å½’åˆ é™¤ */ public void deleteNode(int no){ if (this.lchild !=null &amp;&amp; this.lchild.no==no){ this.lchild =null; return; } if (this.rchild !=null &amp;&amp;this.rchild.no==no){ this.rchild =null; return; } if (this.lchild !=null){ this.lchild.deleteNode(no); } if (this.rchild !=null){ this.rchild.deleteNode(no); } }","link":"/posts/20200107-binarytree.html"},{"title":"æ¨¡æ‹Ÿå…ˆæ¥å…ˆæœåŠ¡ã€çŸ­ä½œä¸šä¼˜å…ˆã€æ—¶é—´ç‰‡è½®è½¬ä»¥åŠæœ€é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•çš„JAVAå®ç°","text":"è¿™é‡Œè®°å½•ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„å®éªŒï¼Œå‡ ä¸ªè°ƒåº¦ç®—æ³•çš„åŸç†å¾ˆå¥½ç†è§£ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šè§£é‡Šï¼Œè¿™é‡Œä¸å†è§£é‡Šï¼Œç›´æ¥ä¸Šä»£ç ã€‚ ä¸€ã€JCBç±»1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class JCB { public int id; /** * å‰©ä½™æœåŠ¡æ—¶é—´ */ public int leftTime; /** * è¦æ±‚æœåŠ¡æ—¶é—´ */ public int serviceTime; /** * åˆ°è¾¾æ—¶é—´ */ public int arriveTime; /** * å¼€å§‹æ—¶é—´ */ public int beginTime; /** * ç»“æŸæ—¶é—´ */ public int finishTime; /** * ä¼˜å…ˆæƒ */ public float priority; public JCB(int id, int serviceTime, int arriveTime,float priority) { this.id = id; this.leftTime = serviceTime; this.serviceTime = serviceTime; this.arriveTime = arriveTime; beginTime =0; this.priority=priority; finishTime=0; } @Override public String toString() { return \"JCB{\" + \"id=\" + id + \", serviceTime=\" + serviceTime + \", arriveTime=\" + arriveTime + \", priority=\" + priority + '}'; }} äºŒã€å®šä¹‰æ‰€éœ€æ•°æ®ç»“æ„1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/** * æ—¶é—´ç‰‡è½®è½¬ç®—æ³• * * @author MaoLin Wang * @date 2019/11/3020:03 */public class SchedulingAlgorithm { /** * å°±ç»ªé˜Ÿåˆ— */ LinkedList&lt;JCB&gt; readyQueue = null; /** * ç»“æŸè°ƒåº¦é˜Ÿåˆ— */ LinkedList&lt;JCB&gt; finishQueue = null; /** * æ—¶é—´æ®µ */ private int cpuTime; /** * æ—¶é—´ç‰‡å¤§å° */ private int timeSize; /** * ä½œä¸šæ•° */ private int jobNum; private String dispatchName;//è°ƒåº¦ç®—æ³•å /** * ä½œä¸šå‘¨è½¬æ—¶é—´ */ private int[] turnoverTime; /** * ä½œä¸šå¸¦æƒå‘¨è½¬æ—¶é—´Â· */ private float[] turnoverTimeWithWeight; /** * å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ */ private float ave;} ä¸‰ã€åˆå§‹åŒ–è¿™é‡Œå°†æœ€é«˜å“åº”æ¯”çš„åˆå§‹åŒ–æ‹‰äº†å‡ºæ¥ï¼Œå› ä¸ºè¦è®¾ç½®å“åº”æ¯” 12345678910111213141516171819202122232425262728293031323334353637383940414243444546/** * åˆå§‹åŒ– */ public void init(int jobNum, int timeSize, String dispatchName) { System.out.println(\"å¼€å§‹\" + dispatchName + \"è°ƒåº¦\"); readyQueue = new LinkedList&lt;&gt;(); finishQueue = new LinkedList&lt;&gt;(); this.turnoverTime = new int[jobNum]; this.turnoverTimeWithWeight = new float[jobNum]; this.cpuTime = 0; JCB jcb; for (int i = 1; i &lt;= jobNum; i++) { jcb = new JCB(i, (int) (Math.random() * 10 + 1), i - 1, 0); readyQueue.offer(jcb); } this.timeSize = timeSize; this.jobNum = jobNum; this.dispatchName = dispatchName; printInitQueue(); } /** * åˆå§‹åŒ–é«˜å“åº”æ¯”ä¼˜å…ˆé˜Ÿåˆ— * * @param jobNum * @param timeSize * @param dispatchName */ public void HRNInit(int jobNum, int timeSize, String dispatchName) { System.out.println(\"å¼€å§‹\" + dispatchName + \"è°ƒåº¦\"); readyQueue = new LinkedList&lt;&gt;(); finishQueue = new LinkedList&lt;&gt;(); this.turnoverTime = new int[jobNum]; this.turnoverTimeWithWeight = new float[jobNum]; this.cpuTime = 0; JCB jcb; for (int i = 1; i &lt;= jobNum; i++) { float v = (float) (Math.random() * 5 + 1); jcb = new JCB(i, (int) (Math.random() * 10 + 1), i - 1, (float) (Math.random() * 5 + 1)); readyQueue.offer(jcb); } this.timeSize = timeSize; this.jobNum = jobNum; this.dispatchName = dispatchName; printInitQueue(); } ä½œä¸šidé»˜è®¤ä¸ºåºå·iï¼Œæ‰€éœ€æœåŠ¡æ—¶é—´éšæœºç”Ÿæˆï¼Œåˆ°è¾¾æ—¶é—´é»˜è®¤ä»0å¼€å§‹ï¼Œå“åº”æ¯”å…¶ä»–è°ƒåº¦ç®—æ³•ä¸º0ï¼Œé«˜å“åº”æ¯”ç®—æ³•ä¸ºéšæœºç”Ÿæˆã€‚ å››ã€é«˜å“åº”æ¯”ä¼˜å…ˆç®—æ³•å®ç°é€»è¾‘å¾ˆç®€å•ï¼Œä½¿ç”¨é€’å½’å®ç°ï¼Œå‚æ•°åˆå§‹ä¸º0ï¼Œæ¯æ¬¡å–å‡ºå¯¹å¤´ä½œä¸šï¼Œå› ä¸ºè¿™é‡Œæ‰€æœ‰çš„ä½œä¸šåœ¨åˆå§‹åŒ–æ—¶æ•°æ®éƒ½åˆå§‹åŒ–å¥½äº†ï¼Œæ‰€ä»¥éœ€åˆ¤æ–­ä½œä¸šåˆ°è¾¾æ—¶é—´æ˜¯å¦å°äºcpuæ—¶é—´ç‰‡ï¼Œå› ä¸ºåªæœ‰å°äºæ—¶é—´ç‰‡ï¼Œè¯´æ˜å…¶å®é™…æ˜¯åˆ°è¾¾çš„ã€‚ å¦‚æœå°äºï¼Œåˆ™è®¾ç½®å…¶å¼€å§‹æ—¶é—´ä¸ºcpuå½“å‰æ—¶é—´ï¼Œç»“æŸæ—¶é—´ä¸ºå¼€å§‹æ—¶é—´+æœåŠ¡æ—¶é—´ï¼Œå‰©ä½™æ—¶é—´è®¾ä¸º0ï¼ŒåŒæ—¶å¢åŠ cpuæ—¶é—´ï¼Œå°†è¯¥ä½œä¸šåŠ å…¥å·²å®Œæˆé˜Ÿåˆ—ä¸­ï¼Œå¦åˆ™ï¼Œé€’å½’è°ƒç”¨è¯¥ç®—æ³•ï¼Œå‚æ•°ä¸ºindex+1ï¼Œä¸€è½®ç»“æŸåï¼Œå¯¹ä½œä¸šæŒ‰å“åº”æ¯”æ’åºï¼Œç»§ç»­é€’å½’ï¼ŒçŸ¥é“å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºã€‚ 12345678910111213141516171819202122232425262728293031323334 /** * æœ€é«˜å“åº”æ¯”ä¼˜å…ˆç®—æ³• */public void HRNAlgorithm(int index) { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•!\"); return; } JCB head = readyQueue.get(index); if (head.arriveTime &lt;= cpuTime) { readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; head.finishTime = head.beginTime + head.serviceTime; head.leftTime = 0; cpuTime += head.serviceTime; finishQueue.offer(head); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); } else { HRNAlgorithm(index++); } sortByPriority(); HRNAlgorithm(0);}/** * æ ¹æ®å“åº”æ¯”æ’åº */private void sortByPriority() { readyQueue.sort((o1, o2) -&gt; o1.priority &gt; o2.priority ? -1 : 1);} äº”ã€çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³•åŒé«˜å“åº”æ¯”ä¼˜å…ˆç±»ä¼¼ï¼Œåªæ˜¯æŒ‰ç…§è¦æ±‚æœåŠ¡æ—¶é—´æ’åºã€‚ 123456789101112131415161718192021222324252627282930313233343536/** * çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³• */ public void SJFAlgorithm(int index) { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼\"); return; } JCB head = readyQueue.get(index); if (head.arriveTime &lt;= cpuTime) { readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; head.finishTime = head.beginTime + head.serviceTime; head.leftTime = 0; cpuTime += head.serviceTime; finishQueue.offer(head); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); } else { sortByServiceTime(); SJFAlgorithm(index++); } sortByServiceTime(); SJFAlgorithm(0); } /** * æ ¹æ®è¦æ±‚æœåŠ¡æ—¶é—´ä»å°åˆ°å¤§æ’åº */ private void sortByServiceTime() { readyQueue.sort((o1, o2) -&gt; o1.serviceTime &lt; o2.serviceTime ? -1 : 1); } å…­ã€å…ˆæ¥å…ˆæœåŠ¡ æœ€ç®€å•çš„ä¸€ä¸ªç®—æ³•ï¼Œç›´æ¥æŒ‰é¡ºåºå–å‡ºé˜Ÿå¤´ä½œä¸šæ‰§è¡Œã€‚ 12345678910111213141516171819202122/** * å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç®—æ³• */ public void FCFSAlgorithm() { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼\"); return; } JCB head = readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; head.leftTime = 0; head.finishTime = head.beginTime + head.serviceTime; cpuTime += head.serviceTime; finishQueue.offer(head); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); FCFSAlgorithm(); } ä¸ƒã€æ—¶é—´ç‰‡è½®è½¬ç®—æ³• è¿™é‡Œéœ€è¦æ ¹æ®ä½œä¸šå‰©ä½™éœ€è¦æœåŠ¡çš„æ—¶é—´è·Ÿæ—¶é—´ç‰‡å¤§å°åšå¯¹æ¯”ï¼Œä»£ç å¾ˆå¥½ç†è§£ã€‚ 123456789101112131415161718192021222324252627282930313233343536/** * æ—¶é—´ç‰‡è½®è½¬ç®—æ³• */ public void RRAlgorithm() { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼\"); return; } JCB head = readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; if (head.leftTime &gt; timeSize) { //æœåŠ¡æ—¶é—´å¤§äºæ—¶é—´ç‰‡å¤§å° head.leftTime -= timeSize; //é‡æ–°åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—å°¾éƒ¨ readyQueue.offer(head); cpuTime += timeSize; } else if (head.leftTime == timeSize) { //æœåŠ¡æ—¶é—´ç­‰äºæ—¶é—´ç‰‡å¤§å° cpuTime += timeSize; head.finishTime = cpuTime; head.leftTime = 0; //åŠ å…¥ç»“æŸé˜Ÿåˆ— finishQueue.offer(head); } else { //æœåŠ¡æ—¶é—´å°äºæ—¶é—´ç‰‡å¤§å° head.finishTime = cpuTime + head.leftTime; head.leftTime = 0; cpuTime += head.leftTime; finishQueue.offer(head); } System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); RRAlgorithm(); } å…«ã€è®¡ç®—å‘¨è½¬æ—¶é—´å’Œå¸¦æƒå‘¨è½¬æ—¶é—´12345678910111213141516171819/** * è®¡ç®—å‘¨è½¬æ—¶é—´å’Œå¸¦æƒå‘¨è½¬æ—¶é—´ * @param finishQueue */ public void R_Dis(Queue&lt;JCB&gt; finishQueue) { Queue&lt;JCB&gt;temp=finishQueue; JCB tempJcb; float sum = 0; for (int i = 0; i &lt; jobNum; i++) { tempJcb=temp.poll(); turnoverTime[i] = tempJcb.finishTime - tempJcb.arriveTime; turnoverTimeWithWeight[i] =(float) turnoverTime[i] / tempJcb.serviceTime; sum += turnoverTimeWithWeight[i]; temp.offer(tempJcb); } float ave = sum / jobNum; this.ave = ave; } ä¹ã€æ‰“å°ç»“æœ123456789101112131415161718192021222324252627282930313233343536public void printResult(boolean isHRN) { R_Dis(this.finishQueue); System.out.println(\"=====================\" + this.dispatchName + \"è°ƒåº¦ç»“æœä¸º=========================\"); if (isHRN) { System.out.println(\"è¿›ç¨‹å\\t\" + \"åˆ°è¾¾æ—¶é—´\\t\" + \"è¦æ±‚æœåŠ¡æ—¶é—´\\t\" + \"å“åº”æ¯”\\t\" + \"å¼€å§‹æ—¶é—´\\t\" + \"å®Œæˆæ—¶é—´\\t\" + \"å‘¨è½¬æ—¶é—´\\t\" + \"å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"+\"å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"); } else { System.out.println(\"è¿›ç¨‹å\\t\" + \"åˆ°è¾¾æ—¶é—´\\t\" + \"è¦æ±‚æœåŠ¡æ—¶é—´\\t\" + \"å¼€å§‹æ—¶é—´\\t\" + \"å®Œæˆæ—¶é—´\\t\" + \"å‘¨è½¬æ—¶é—´\\t\" + \"å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"+\"å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"); } int count = 0; for (JCB jcb : this.finishQueue) { if (isHRN) { System.out.println(\" \" + jcb.id + \"\\t\\t\\t\" + jcb.arriveTime + \"\\t\\t\" + jcb.serviceTime + \"\\t\\t\" + jcb.priority + \"\\t\\t\" + jcb.beginTime + \"\\t\\t\" + jcb.finishTime + \"\\t\\t\" + turnoverTime[count] + \"\\t\\t\" + turnoverTimeWithWeight[count]+\"\\t\\t\"+this.ave); count = count + 1; } else { System.out.println(\" \" + jcb.id + \"\\t\\t\\t\" + jcb.arriveTime + \"\\t\\t\" + jcb.serviceTime + \"\\t\\t\" + jcb.beginTime + \"\\t\\t\" + jcb.finishTime + \"\\t\\t\" + turnoverTime[count] + \"\\t\\t\" + turnoverTimeWithWeight[count]+\"\\t\\t\"+this.ave); count = count + 1; } } } /** * æ‰“å°åˆå§‹åŒ–é˜Ÿåˆ— */ private void printInitQueue() { System.out.println(\"å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:\"); for (JCB jcb2 : readyQueue) { System.out.println(jcb2); } } æµ‹è¯•1234567891011121314151617181920212223public class Test { public static void main(String[] args) { SchedulingAlgorithm schedulingAlgorithm = new SchedulingAlgorithm(); schedulingAlgorithm.init(5, 2,\"è½®è½¬\"); schedulingAlgorithm.RRAlgorithm(); schedulingAlgorithm.printResult(false); schedulingAlgorithm.init(5,3,\"å…ˆæ¥å…ˆæœåŠ¡\"); schedulingAlgorithm.FCFSAlgorithm(); schedulingAlgorithm.printResult(false); schedulingAlgorithm.init(5,3,\"çŸ­ä½œä¸šä¼˜å…ˆæœåŠ¡\"); schedulingAlgorithm.SJFAlgorithm(0); schedulingAlgorithm.printResult(false); schedulingAlgorithm.HRNInit(5,3,\"é«˜å“åº”æ¯”ä¼˜å…ˆ\"); schedulingAlgorithm.HRNAlgorithm(0); schedulingAlgorithm.printResult(true); }} ç»“æœï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141å¼€å§‹è½®è½¬è°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=1, arriveTime=0, priority=0.0}JCB{id=2, serviceTime=5, arriveTime=1, priority=0.0}JCB{id=3, serviceTime=4, arriveTime=2, priority=0.0}JCB{id=4, serviceTime=6, arriveTime=3, priority=0.0}JCB{id=5, serviceTime=6, arriveTime=4, priority=0.0}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 0ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 5æ—¶é—´ç‰‡: 2ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 3-----------------------------------------------------æ—¶é—´ç‰‡: 2å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 4æ—¶é—´ç‰‡: 4ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 2-----------------------------------------------------æ—¶é—´ç‰‡: 4å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 6ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 4-----------------------------------------------------æ—¶é—´ç‰‡: 6å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 8ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 4-----------------------------------------------------æ—¶é—´ç‰‡: 8å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 3æ—¶é—´ç‰‡: 10ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 1-----------------------------------------------------æ—¶é—´ç‰‡: 10å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 2æ—¶é—´ç‰‡: 12ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 12å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 4æ—¶é—´ç‰‡: 14ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 2-----------------------------------------------------æ—¶é—´ç‰‡: 14å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 4æ—¶é—´ç‰‡: 16ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 2-----------------------------------------------------æ—¶é—´ç‰‡: 16å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 16ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 16å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 2æ—¶é—´ç‰‡: 18ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 18å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 2æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼=====================è½®è½¬è°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 1 0 1 1 1.0 2.3733335 3 2 4 10 12 10 2.5 2.3733335 2 1 5 16 17 16 3.2 2.3733335 4 3 6 16 18 15 2.5 2.3733335 5 4 6 18 20 16 2.6666667 2.3733335å¼€å§‹å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=3, arriveTime=0, priority=0.0}JCB{id=2, serviceTime=10, arriveTime=1, priority=0.0}JCB{id=3, serviceTime=7, arriveTime=2, priority=0.0}JCB{id=4, serviceTime=1, arriveTime=3, priority=0.0}JCB{id=5, serviceTime=1, arriveTime=4, priority=0.0}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 3æ—¶é—´ç‰‡: 3ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 3å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 10æ—¶é—´ç‰‡: 13ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 13å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 7æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 20å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 21ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 21å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 22ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼=====================å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 3 0 3 3 1.0 8.154286 2 1 10 3 13 12 1.2 8.154286 3 2 7 13 20 18 2.5714285 8.154286 4 3 1 20 21 18 18.0 8.154286 5 4 1 21 22 18 18.0 8.154286å¼€å§‹çŸ­ä½œä¸šä¼˜å…ˆæœåŠ¡è°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=8, arriveTime=0, priority=0.0}JCB{id=2, serviceTime=10, arriveTime=1, priority=0.0}JCB{id=3, serviceTime=1, arriveTime=2, priority=0.0}JCB{id=4, serviceTime=10, arriveTime=3, priority=0.0}JCB{id=5, serviceTime=1, arriveTime=4, priority=0.0}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 8æ—¶é—´ç‰‡: 8ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 8å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 9ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 9å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 10ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 10å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 10æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 20å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 10æ—¶é—´ç‰‡: 30ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼=====================çŸ­ä½œä¸šä¼˜å…ˆæœåŠ¡è°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 8 0 8 8 1.0 3.72 3 2 1 8 9 7 7.0 3.72 5 4 1 9 10 6 6.0 3.72 2 1 10 10 20 19 1.9 3.72 4 3 10 20 30 27 2.7 3.72å¼€å§‹é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=1, arriveTime=0, priority=5.41018}JCB{id=2, serviceTime=6, arriveTime=1, priority=5.1338425}JCB{id=3, serviceTime=6, arriveTime=2, priority=3.1670618}JCB{id=4, serviceTime=6, arriveTime=3, priority=2.0463989}JCB{id=5, serviceTime=1, arriveTime=4, priority=4.711568}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 1ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 1å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 7ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 7å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 8ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 8å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 14ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 14å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•!=====================é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å“åº”æ¯” å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 1 5.41018 0 1 1 1.0 2.1666665 2 1 6 5.1338425 1 7 6 1.0 2.1666665 5 4 1 4.711568 7 8 4 4.0 2.1666665 3 2 6 3.1670618 8 14 12 2.0 2.1666665 4 3 6 2.0463989 14 20 17 2.8333333 2.1666665","link":"/posts/20200107-OS_dispatch.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹Fork-Joinåˆ†æ²»ç¼–ç¨‹","text":"ä¸€ã€Fork-Joinæ¡†æ¶ forkjoinå³åˆ†è€Œæ²»ä¹‹ï¼Œåœ¨å‡ å¤§æ’åºç®—æ³•ä¸­ï¼Œå¿«é€Ÿæ’åºã€å½’å¹¶æ’åºã€äºŒåˆ†æŸ¥æ‰¾å‡ç”¨åˆ°äº†åˆ†æ²»çš„æ€æƒ³ï¼Œå³å°†ä¸€ä¸ªå¤§é—®é¢˜ï¼Œé€ä¸€åˆ†è§£ä¸ºä¸€ä¸ªä¸ªå°é—®é¢˜ï¼Œå°†å„ä¸ªå­é—®é¢˜çš„è§£æœ€ç»ˆåˆå¹¶ä¸ºæœ€ç»ˆè§£ã€‚è¿™é‡Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå°†ä¸€ä¸ªå¤§ä»»åŠ¡åˆ†è§£æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼ˆforkï¼‰ï¼Œå†å°†è¿™è‹¥å¹²çš„å°ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œåˆå¹¶ï¼ˆjoinï¼‰ã€‚ äºŒã€å·¥ä½œå¯†å–fork-joiné‡‡ç”¨å·¥ä½œå¯†å–çš„æ–¹å¼å®ç°çº¿ç¨‹çš„å·¥ä½œè´Ÿè½½ã€‚forkjoinPoolä¸­ç»´æŠ¤äº†å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ†ä¸‹çš„å°ä»»åŠ¡ï¼Œå½“å½“å‰çº¿ç¨‹çš„ä»»åŠ¡ç»“æŸåï¼Œä¼šè‡ªåŠ¨è·å–å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶ä¹Ÿä¼šæ ¹æ®å½“å‰å·¥ä½œçº¿ç¨‹çš„ç©ºé—²æƒ…å†µå»è·å–ä»»åŠ¡è¾ƒå¤šçš„çº¿ç¨‹çš„taskï¼Œä»¥è¾¾åˆ°çº¿ç¨‹é—´çš„å¹³è¡¡ï¼Œæä¾›CPUåˆ©ç”¨ç‡ã€‚ ä¸‰ã€fork-joinçš„å®ç°forkjoinæ¡†æ¶æä¾›äº†ä¸¤ä¸ªå­ç±»ä¾›æˆ‘ä»¬ç»§æ‰¿ä½¿ç”¨ã€‚åˆ†åˆ«æ˜¯ï¼š1.RecursiveActionæ­¤ç±»ä¸»è¦ç”¨äºæ²¡æœ‰è¿”å›å€¼çš„ä»»åŠ¡ã€‚2.RecursiveTaskæ­¤ç±»ä¸»è¦ç”¨äºæœ‰è¿”å›å€¼çš„ä»»åŠ¡ ä¸¤ä¸ªç±»éƒ½æä¾›äº†computeçš„æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆã€è°ƒç”¨å­ä»»åŠ¡ï¼Œå®Œæˆåˆ†æ²»è¿ç®—ã€‚åœ¨computeæ–¹æ³•ä¸­ï¼Œéœ€è¦åˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦è¾¾åˆ°è®¾ç½®çš„é˜ˆå€¼ï¼Œå¦‚æœå°äºè¯¥å€¼ï¼Œåˆ™ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™ï¼Œå°†è¯¥ä»»åŠ¡åˆ†å‰²æˆä¸¤ä¸ªå°ä»»åŠ¡ï¼Œå†è®©ä¸¤ä¸ªå°ä»»åŠ¡è°ƒç”¨invokeAllæ–¹æ³•ï¼Œä¼šå†æ¬¡è¿›å…¥computeæ–¹æ³•ï¼Œé‡å¤ä»¥ä¸Šå·¥ä½œã€‚æœ€åä½¿ç”¨joinæ–¹æ³•ç­‰åˆ°å­ä»»åŠ¡æ‰§è¡Œç»“æŸè·å–å…¶è¿è¡Œçš„ç»“æœï¼Œåˆå¹¶å³å¯ã€‚ è¿™é‡Œä½¿ç”¨invokeAllè€Œä¸æ˜¯ç”¨invokeä¸»è¦æ˜¯å› ä¸ºï¼Œå¦‚æœä½¿ç”¨invokeä¼šä½¿ä»»åŠ¡åˆ†ç¦»å¼€ï¼Œä¸¤ä¸ªä»»åŠ¡ä¸­åªå·¥ä½œä¸€ä¸ªä»»åŠ¡ï¼Œè€Œä½¿ç”¨invokeAllå¯ä»¥è®©ä¸¤ä¸ªä»»åŠ¡åŒæ—¶å·¥ä½œï¼Œæé«˜æ•ˆç‡ã€‚ fork-joinçš„ä»»åŠ¡æ˜¯é€šè¿‡ForkJoinPoolæ± æ¥æ‰§è¡Œï¼Œå…¶æä¾›äº†ä¸¤ç§æäº¤æ–¹å¼ï¼Œsubmitå’Œinvokeï¼Œå…¶ä¸­ï¼Œsubmitæ˜¯å¼‚æ­¥æäº¤ï¼Œä¸éœ€è¦ç­‰å¾…ä»»åŠ¡è¿è¡Œå®Œæ¯•å³å¯è¿è¡Œsumbitä¹‹åçš„ä»£ç ï¼›ç›¸åï¼Œinvokeæ˜¯åŒæ­¥æ‰§è¡Œï¼Œå¿…é¡»ç­‰å¾…ä»»åŠ¡å®Œæˆæ‰ä¼šæ‰§è¡Œinvokeä¹‹åçš„ä»£ç ã€‚ å››ã€ä½¿ç”¨Foke-Joinå®ç°æ•°ç»„æ±‚å’Œ 4.1åˆ›å»ºæ±‚å’Œä»»åŠ¡ç±»è‡ªå®šä¹‰é˜ˆå€¼ï¼Œå½“ä»»åŠ¡ä½äºè¯¥é˜ˆå€¼æ—¶ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™è¿›è¡Œåˆ†å‰²ï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•åè¿”å›å­ä»»åŠ¡åˆå¹¶çš„ç»“æœã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public class AddTask extends RecursiveTask&lt;Integer&gt; { /** * é˜ˆå€¼ */ private static final int THRESHOLD=10; private int[] nums; //å·¦è¾¹ç•Œ private int left; //å³è¾¹ç•Œ private int right; public AddTask(int[] nums, int left, int right) { this.nums = nums; this.left = left; this.right = right; } /** * ç”Ÿæˆéšæœºæ•°ç»„ * @return */ public static int[] randomNum(){ Random r = new Random(); int[] nums = new int[100]; for(int i=0;i&lt;100;i++){ nums[i] = r.nextInt(100); } return nums; } @Override protected Integer compute() { if (right-left&lt;THRESHOLD){ //ä»»åŠ¡åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼Œç¬¦åˆè¦æ±‚ï¼Œæ‰§è¡Œæ‰§è¡Œä»»åŠ¡ int sum=0; for (int i = left; i &lt;= right; i++) { try { TimeUnit.MILLISECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); } sum+=nums[i]; } return sum; }else { //ä»»åŠ¡å¤ªå¤§ï¼Œéœ€è¦åˆ†å‰²æˆå°ä»»åŠ¡ int mid=(left+right)/2; AddTask leftTask=new AddTask(nums,left,mid); AddTask rightTask=new AddTask(nums,mid+1,right); invokeAll(leftTask,rightTask); //è¿”å›å­ä»»åŠ¡åˆå¹¶çš„ç»“æœ return leftTask.join()+rightTask.join(); } }} 4.2åˆ›å»ºAddç±»è°ƒç”¨ä»»åŠ¡ç±»12345678910111213141516 */public class Add { public static void main(String[] args) { ForkJoinPool forkJoinPool=new ForkJoinPool(); int[] nums = AddTask.randomNum(); System.out.println(\"å¾…æ±‚å’Œæ•°ç»„:\"+ Arrays.toString(nums)); //åˆ›å»ºæ±‚å’Œä»»åŠ¡ AddTask addTask=new AddTask(nums,0,nums.length-1); forkJoinPool.invoke(addTask); System.out.println(\"æ±‚å’Œä¸­ã€‚ã€‚\"); System.out.println(\"å’Œä¸º:\"+addTask.join()); }} ç»“æœï¼šå¾…æ±‚å’Œæ•°ç»„:[34, 38, 71, 98, 38, 51, 35, 67, 59, 58, 33, 64, 65, 40, 30, 49, 67, 15, 4, 3, 5, 10, 94, 17, 24, 43, 94, 52, 53, 81, 7, 70, 25, 90, 96, 3, 84, 73, 54, 11, 42, 97, 18, 11, 95, 28, 14, 74, 95, 91, 53, 48, 69, 71, 91, 64, 25, 72, 3, 74, 77, 90, 22, 36, 77, 86, 41, 53, 92, 15, 30, 5, 51, 86, 60, 49, 76, 91, 15, 38, 55, 37, 24, 58, 53, 58, 75, 77, 34, 41, 88, 50, 91, 25, 56, 83, 14, 3, 75, 7]æ±‚å’Œä¸­ã€‚ã€‚å’Œä¸º:5134 è€Œå¦‚æœä½¿ç”¨submitæäº¤ï¼Œå°†æ•°ç»„å¤§å°æ”¹ä¸º10000ï¼Œå°±å¯çœ‹åˆ°æ±‚å’Œä¸­ä¸€å¥è¯æ˜¯åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰ä¼šæ‰“å°ï¼Œä½“ç°åŒæ­¥æ€§ã€‚","link":"/posts/20200123-ForkJoin.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹CountDownLatch,CyclicBarrierå’ŒSemaphore","text":"ä¸€ã€CountDownLatch CountDownLatchèƒ½å¤Ÿè®©ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹å…¨éƒ¨å®Œæˆå„è‡ªä»»åŠ¡åå†æ‰§è¡Œã€‚è€ŒCountDownLatchæ˜¯é€šè¿‡è®¡æ•°å™¨æ¥å®ç°çš„ï¼Œè®¡æ•°å™¨çš„åˆå§‹å€¼å³ä¸ºä»»åŠ¡çš„æ€»æ•°ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚ï¼ŒåŒå­¦èšä¼šç»“æŸå›å®¶ï¼Œæ¯ä¸ªäººéƒ½è¦å›å„è‡ªçš„å®¶ï¼Œæ­¤æ—¶è®¡æ•°å™¨çš„åˆå§‹å€¼ä¸ºå‚åŠ èšä¼šçš„æ€»äººæ•°ï¼Œè€Œæ¯ä¸ªäººéƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªåŒå­¦åˆ°å®¶åï¼Œéƒ½éœ€è¦è°ƒç”¨countDownæ–¹æ³•ï¼Œå¯¹è®¡æ•°å™¨å‡ä¸€ï¼Œè¡¨ç¤ºå®Œæˆå›å®¶çš„ä»»åŠ¡ï¼Œå½“æ‰€æœ‰åŒå­¦éƒ½åˆ°å®¶åï¼Œä¸»çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œé€šçŸ¥ç­é•¿å…¨éƒ¨åˆ°å®¶çš„ä»»åŠ¡ã€‚å†æ¯”å¦‚ï¼Œæ‰€ç¼–å†™çš„åº”ç”¨ç¨‹åºï¼Œå¸Œæœ›ç­‰å¾…å¯åŠ¨æ¡†æ¶çš„çº¿ç¨‹å¯åŠ¨å®Œæ¯•åå†æ‰§è¡Œã€‚ 1.1 æ„é€ æ–¹æ³•1234public CountDownLatch(int count) { if (count &lt; 0) throw new IllegalArgumentException(\"count &lt; 0\"); this.sync = new Sync(count); } CountDownLatchçš„æ„é€ æ–¹æ³•éœ€è¦ä¸€ä¸ªcountå‚æ•°ï¼Œä»£è¡¨åˆå§‹ä»»åŠ¡çš„æ•°é‡ï¼Œå¾€åæ¯å½“è°ƒç”¨ä¸€æ¬¡ï¼ˆCountDownLatch.countDown()æ–¹æ³•ï¼Œcountéƒ½å‡ä¸€ï¼Œå½“countå‡åˆ°0çš„æ—¶å€™ï¼Œè°ƒç”¨CountDownLatch.await()æ–¹æ³•çš„çº¿ç¨‹å°±å¯ä»¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒCountDownLatchè¿˜æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š 1.await(long timeout,TimeUnit unit) 1234public boolean await(long timeout, TimeUnit unit) throws InterruptedException { return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout)); } æ­¤æ–¹æ³•åœ¨await()çš„åŸºç¡€ä¸Šæ·»åŠ äº†æ—¶é—´é™åˆ¶ï¼Œå¦‚æœè°ƒç”¨awaitçš„çº¿ç¨‹åœ¨åˆ°è¾¾è¯¥æ—¶é—´åï¼Œcountä»ç„¶æ²¡æœ‰0ï¼Œå…¶ä¼šç»§ç»­æ‰§è¡Œï¼Œä¸å†ç­‰åˆ°countåˆ°0ã€‚ 2. public long getCount() 123public long getCount() { return sync.getCount(); } å³è·å–è¯¥CountDownLatchå½“å‰çš„countå€¼ äºŒã€Demoåº”ç”¨12345678910111213141516171819202122232425262728293031323334353637383940414243package com.wml.test1.countdownlatch;import java.util.concurrent.CountDownLatch;/** * @author Wang * @date 2020/1/2317:27 */public class CountDownLatchTest { //1. private static CountDownLatch finishEat=new CountDownLatch(1); //2. private static CountDownLatch friends=new CountDownLatch(10); public static void main(String[] args) throws InterruptedException { //3. for (int i = 0; i &lt;10; i++) { new Thread(()-&gt;{ try { //4. finishEat.await(); System.out.println(Thread.currentThread().getName()+\"æ­£åœ¨å›å®¶\"); //5. friends.countDown(); System.out.println(Thread.currentThread().getName()+\"åˆ°å®¶å•¦\"); } catch (InterruptedException e) { e.printStackTrace(); } },\"åŒå­¦\"+(i+1)).start(); } System.out.println(\"èšä¼šç»“æŸï¼ŒåŒå­¦ä»¬å‡†å¤‡å›å®¶\"); //6. finishEat.countDown(); //7. friends.await(); //8. System.out.println(\"åŒå­¦å…¨éƒ¨åˆ°å®¶\"); }} è¯´æ˜ï¼š1.ä»£ç 1åˆ›å»ºä¸€ä¸ªç»“æŸèšé¤çš„CountDownLatchï¼ŒfinishEatã€‚åˆå§‹å€¼ä¸º1ï¼Œä»£è¡¨æ­£åœ¨èšé¤ï¼Œå½“ä¸»çº¿ç¨‹è°ƒç”¨countDown()æ—¶ï¼ˆä»£ç 6ï¼‰ï¼Œcountå€¼ä»1å˜ä¸º0ï¼Œä»£è¡¨ç»“æŸèšé¤ã€‚è¿™æ—¶ï¼Œå…¶ä»–è°ƒç”¨finishEat.await();çš„çº¿ç¨‹ï¼ˆå„ä¸ªåŒå­¦å›å®¶çš„çº¿ç¨‹ï¼‰ç”±é˜»å¡çŠ¶æ€å˜ä¸ºæ‰§è¡Œã€‚2.ä»£ç 2åˆ›å»ºä¸€ä¸ªåŒå­¦å›å®¶çš„CountDownLatchï¼Œfriendsã€‚åˆå§‹å€¼ä¸º10ï¼Œä»£è¡¨å‚åŠ èšä¼šçš„10ä¸ªåŒå­¦ï¼Œå³10ä¸ªåŒå­¦éœ€è¦æ‰§è¡Œå›å®¶ä»»åŠ¡ã€‚å›å®¶çš„ä»»åŠ¡éœ€è¦åœ¨ä»£ç 4finishEat.await();åæ‰§è¡Œã€‚3.ä»£ç 3åˆ›å»º10ä¸ªå›å®¶çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æ‰§è¡Œä¸€æ¬¡friends.countDown();ï¼Œè®©friendsçš„countå‡ä¸€4.ä»£ç 7friends.await();ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…friendsçš„countå˜ä¸º0æ—¶å¼€å§‹æ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚ç»“æœï¼š 1234567891011121314èšä¼šç»“æŸï¼ŒåŒå­¦ä»¬å‡†å¤‡å›å®¶åŒå­¦1æ­£åœ¨å›å®¶åŒå­¦1åˆ°å®¶å•¦åŒå­¦2æ­£åœ¨å›å®¶åŒå­¦2åˆ°å®¶å•¦åŒå­¦4æ­£åœ¨å›å®¶åŒå­¦4åˆ°å®¶å•¦åŒå­¦3æ­£åœ¨å›å®¶åŒå­¦3åˆ°å®¶å•¦åŒå­¦5æ­£åœ¨å›å®¶åŒå­¦5åˆ°å®¶å•¦åŒå­¦6æ­£åœ¨å›å®¶åŒå­¦6åˆ°å®¶å•¦åŒå­¦å…¨éƒ¨åˆ°å®¶ ä¸‰ã€CyclicBarrierCyclicï¼ˆå¾ªç¯çš„ï¼‰Barrierï¼ˆå±éšœï¼‰ï¼Œè¯¥å·¥å…·åšçš„äº‹æƒ…æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆåŒæ­¥ç‚¹/ä¸´ç•Œç‚¹ï¼‰æ—¶ä¼šè¢«é˜»å¡ï¼Œç­‰å¾…åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾è¯¥ç‚¹åï¼Œè¢«æ‹¦æˆªé˜»å¡çš„çº¿ç¨‹æ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚æ¯”å¦‚ï¼šåŒå­¦èšé¤ï¼Œä¸ä¼šæ˜¯åˆ°ä¸€ä¸ªå°±åƒä¸€ä¸ªï¼Œè€Œæ˜¯åˆ°çš„äººå…ˆç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰äººéƒ½è¾¾åˆ°é¥­æ¡Œåï¼Œæ‰å¼€å§‹åƒé¥­ã€‚è¿™é‡Œé¤æ¡Œå°±ç±»ä¼¼barrierï¼Œæ¯ä¸ªåŒå­¦éƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªäººåˆ°é¥­æ¡Œåéƒ½è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªåŒå­¦åˆ°è¾¾ã€‚è€Œå› ä¸ºCyclicBarrieræ˜¯å¯å¾ªç¯çš„ï¼Œå½“ä¸€ç»„çº¿ç¨‹åˆ°è¾¾åï¼Œå…¶ä»ç„¶æœ‰æ•ˆï¼Œå¯ä»¥ç»§ç»­ä¸‹ä¸€ç»„å¾ªç¯ã€‚ 3.1æ„é€ æ–¹æ³•1.é»˜è®¤æ„é€ æ–¹æ³• 123public CyclicBarrier(int parties) { this(parties, null); } ä¼ å…¥çš„å‚æ•°è¡¨ç¤ºéœ€è¦æ‹¦æˆªçš„çº¿ç¨‹æ€»æ•°ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨CyclicBarrier.await()æ–¹æ³•åï¼Œä¼šé€šçŸ¥CyclicBarrierè¯¥çº¿ç¨‹å·²åˆ°è¾¾å±éšœã€‚ä¸CountDownLatchä¸€æ ·ï¼ŒCyclicBarrierä¹Ÿä¸ºawaitæä¾›äº†è¶…æ—¶æ—¶é—´è®¾ç½®ã€‚ 123456public int await(long timeout, TimeUnit unit) throws InterruptedException, BrokenBarrierException, TimeoutException { return dowait(true, unit.toNanos(timeout)); } çº¿ç¨‹é˜»å¡ç›´åˆ°åˆ°è¾¾è¶…æ—¶æ—¶é—´ã€‚2.é«˜çº§æ„é€ æ–¹æ³• 1public CyclicBarrier(int parties, Runnable barrierAction) è¯¥æ–¹æ³•ä½¿å¾—çº¿ç¨‹åˆ°è¾¾éšœç¢åï¼Œä¼˜å…ˆæ‰§è¡ŒbarrierActionçš„æ“ä½œã€‚ 3.2 CyclicBarrierçš„æ–¹æ³•3.2.1 await1234567public int await() throws InterruptedException, BrokenBarrierException { try { return dowait(false, 0L); } catch (TimeoutException toe) { throw new Error(toe); // cannot happen } } è¯¥æ–¹æ³•ç­‰å¾…æ‰€æœ‰çš„çº¿ç¨‹éƒ½åˆ°è¾¾æŒ‡å®šçš„ä¸´ç•Œç‚¹ã€‚ä½†å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æœ€ååˆ°è¾¾çš„çº¿ç¨‹ï¼Œåˆ™å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„å°†å…¶ç¦ç”¨ï¼Œå¹¶ä½¿å…¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ å…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ å…¶ä»–çº¿ç¨‹ä¸­æ–­ç­‰å¾…çº¿ç¨‹ä¹‹ä¸€ åœ¨å±éšœç­‰å¾…æ—¶å…¶ä»–çº¿ç¨‹è¶…æ—¶ å…¶ä»–çº¿ç¨‹åœ¨æ­¤å±éšœä¸Šè°ƒç”¨resetæ–¹æ³• åœ¨awaitæ–¹æ³•ä¸­è°ƒç”¨çš„dowaitæ–¹æ³•ä»¥ä¸‹æ˜¯dowaitæºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566private int dowait(boolean timed, long nanos) throws InterruptedException, BrokenBarrierException, TimeoutException { final ReentrantLock lock = this.lock; lock.lock(); try { final Generation g = generation; if (g.broken) throw new BrokenBarrierException(); //ä»£ç 1 if (Thread.interrupted()) { breakBarrier(); throw new InterruptedException(); } //ä»£ç 2 int index = --count; if (index == 0) { // tripped boolean ranAction = false; try { final Runnable command = barrierCommand; if (command != null) command.run(); ranAction = true; nextGeneration(); return 0; } finally { if (!ranAction) breakBarrier(); } } // ä»£ç 3 for (;;) { try { if (!timed) trip.await(); else if (nanos &gt; 0L) nanos = trip.awaitNanos(nanos); } catch (InterruptedException ie) { if (g == generation &amp;&amp; ! g.broken) { breakBarrier(); throw ie; } else { // We're about to finish waiting even if we had not // been interrupted, so this interrupt is deemed to // \"belong\" to subsequent execution. Thread.currentThread().interrupt(); } } if (g.broken) throw new BrokenBarrierException(); if (g != generation) return index; if (timed &amp;&amp; nanos &lt;= 0L) { breakBarrier(); throw new TimeoutException(); } } } finally { lock.unlock(); } } è¯´æ˜ï¼šä»£ç 1ï¼šå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œä¼šè°ƒç”¨breakBarrieræ–¹æ³•å¹¶æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚breakBarrieræ–¹æ³•å¦‚ä¸‹ï¼š 12345private void breakBarrier() { generation.broken = true; count = parties; trip.signalAll(); } 1.breakBarrieré¦–å…ˆå°†è¯¥ä»£çš„brokenè®¾ç½®ä¸ºtrueï¼Œä»£è¡¨å…¶è¢«æ‰“ç ´ã€‚2.generationæ˜¯CyclicBarrierçš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»Generationçš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä»£è¡¨å±éšœçš„å½“å‰ä»£ï¼Œå¯ä»¥å®ç°å¾ªç¯ç­‰å¾…ã€‚brokenä¸ºtrueï¼Œåˆ™è¯¥å¾ªç¯ç»“æŸã€‚3.åŒæ—¶å°†counté‡ç½®ä¸ºpartiesï¼› countä¸ºè®¡æ•°å™¨ï¼Œpartiesæ˜¯CyclicBarrierçš„æ„é€ å‚æ•°ï¼Œä»£è¡¨æ‹¦æˆªçš„çº¿ç¨‹æ•°4.è°ƒç”¨tripçš„signalAll()æ–¹æ³•ï¼Œå°†æ‰€æœ‰é˜»å¡çš„çº¿ç¨‹å”¤é†’ tripæ˜¯æˆå‘˜å˜é‡Conditionçš„å¯¹è±¡ï¼Œå¯è§æ˜¯ä½¿ç”¨Conditionå®ç°é˜»å¡é˜Ÿåˆ—çš„ã€‚ä»£ç 2ï¼šè®¡æ•°å™¨countå‡ä¸€å¹¶èµ‹å€¼ç»™intå˜é‡indexï¼Œå¦‚æœæ­¤æ—¶indexå€¼ä¸º0ï¼Œåˆ™åˆ¤æ–­å½“å‰barrierCommandæ˜¯å¦ä¸ºç©ºï¼Œï¼ˆbarrierCommandä¹Ÿæ˜¯CyclicBarrierçš„æˆå‘˜å˜é‡ï¼Œä¸ºæ¢ä»£å‰ä¼˜å…ˆæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå…¶åœ¨CyclicBarrieræ„é€ æ–¹æ³•ä¸­ä¼ å…¥ï¼Œå¦‚ä¸‹ï¼š 12345public CyclicBarrier(int parties, Runnable barrierAction) { .......... ........... this.barrierCommand = barrierAction; } ï¼‰ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œè¯¥æ“ä½œçš„run()æ–¹æ³•ã€‚æœ€åç½®ranActionä¸ºtrueï¼Œä¸ªäººç†è§£ä»£è¡¨ç»§ç»­æ‰§è¡Œï¼Œå¹¶æ‰§è¡ŒnextGeneration()è¿›å…¥ä¸‹ä¸€ä»£ï¼ˆä¸‹ä¸€ä¸ªå¾ªç¯ï¼‰ã€‚nextGeneration()ä»£ç å¦‚ä¸‹ï¼š 1234567private void nextGeneration() { // signal completion of last generation trip.signalAll(); // set up next generation count = parties; generation = new Generation(); } åœ¨nextGeneration()ä¸­å”¤é†’æ‰€æœ‰é˜»å¡è¿›ç¨‹ï¼Œé‡ç½®è®¡æ•°å™¨ï¼Œå¹¶é‡æ–°newäº†ä¸€ä¸ªGenerationã€‚è€Œåœ¨finallyä¸­ï¼Œå¦‚æœbarrierCommandæ‰§è¡Œå‡ºé”™ï¼Œæˆ–å…¶ä»–åŸå› ï¼Œä¼šæ‰§è¡ŒbreakBaåœ¨è¿™é‡Œæ’å…¥ä»£ç ç‰‡rrier()æ–¹æ³•ã€‚ä»£ç 3ï¼šæ— é™å¾ªç¯ç›´åˆ°å‘ç”Ÿtrippedï¼Œæ–­å¼€ï¼Œä¸­æ–­æˆ–è¶…æ—¶ã€‚timedä»£è¡¨æ˜¯å¦å¼€å¯è¶…æ—¶æ—¶é—´ï¼Œnanos ä¸ºè®¾å®šçš„è¶…æ—¶æ—¶é—´ 3.2.2 getNumberWaiting123456789public int getNumberWaiting() { final ReentrantLock lock = this.lock; lock.lock(); try { return parties - count; } finally { lock.unlock(); }} è¿”å›å½“å‰æœ‰å¤šå°‘ä¸ªçº¿ç¨‹é˜»å¡ç­‰å¾…åœ¨å±éšœä¸Š 3.3 isBroken1boolean isBroken() è¿”å›æŸ¥è¯¢é˜»å¡ç­‰å¾…çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­æ‰“ç ´ å››ã€CyclicBarrier ä¾‹å­12345678910111213141516171819202122232425262728293031323334353637package com.wml.test1.cyclicbarrier;import java.util.concurrent.*;/** * @author Wang * @date 2020/1/2317:44 */public class CyclicBarrierTest { //ä»£ç 1 private static CyclicBarrier barrier=new CyclicBarrier(6,()-&gt;{ System.out.println(\"åŒå­¦ä»¬éƒ½åˆ°é½äº†ï¼Œå’±ä»¬å¼€é¥­\"); }); public static void main(String[] args) { ExecutorService pool = new ThreadPoolExecutor(6,100,0L,TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); for (int i = 1; i &lt;= 6; i++) { pool.execute(() -&gt; { try { System.out.println(Thread.currentThread().getName() + \"åˆ°äº†\"); //ä»£ç 2 barrier.await(); System.out.println(Thread.currentThread().getName() + \"å¼€åƒ\"); } catch (InterruptedException e) { e.printStackTrace(); } catch (BrokenBarrierException e) { e.printStackTrace(); } }); } }} è¯´æ˜ï¼šè¯¥ä¾‹å­ä¸ºåŒå­¦èšé¤ï¼Œæ¯åˆ°ä¸€ä¸ªåŒå­¦ä¾¿é˜»å¡è‡ªå·±ï¼Œå½“æ‰€æœ‰åŒå­¦éƒ½åˆ°é½åï¼Œè¾“å‡ºâ€œå¼€é¥­â€ï¼Œç„¶åå”¤é†’æ‰€æœ‰åŒå­¦ï¼Œæ‰§è¡Œâ€œåƒé¥­â€ ä»£ç 1ï¼šæ„é€ ä¸€ä¸ªCyclicBarrier å±éšœï¼Œæ‹¦æˆªçº¿ç¨‹æ•°ä¸º6ï¼Œåœ¨è¿›å…¥ä¸‹ä¸€ä»£å‰æ‰§è¡ŒSystem.out.println(&quot;åŒå­¦ä»¬éƒ½åˆ°é½äº†ï¼Œå’±ä»¬å¼€é¥­&quot;);è¿™ä¸€barrierCommandï¼Œå³å½“å‰ä»£ç»“æŸï¼ˆæ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœæ—¶æˆ–å…¶ä»–åŸå› ï¼‰åä¼˜å…ˆæ‰§è¡Œè¯¥æ“ä½œã€‚ä»£ç 2ï¼šæ¯ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœåæ‰§è¡Œawaitæ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾ï¼Œawaitä¸­ä¼šæ‰§è¡Œå”¤é†’æ‰€æœ‰é˜»å¡çº¿ç¨‹çš„æ–¹æ³•ï¼Œæœ€åæ‰ä¼šæ‰§è¡Œåé¢çš„ä»£ç ã€‚ç»“æœï¼š 12345678910111213pool-1-thread-1åˆ°äº†pool-1-thread-2åˆ°äº†pool-1-thread-3åˆ°äº†pool-1-thread-4åˆ°äº†pool-1-thread-5åˆ°äº†pool-1-thread-6åˆ°äº†åŒå­¦ä»¬éƒ½åˆ°é½äº†ï¼Œå’±ä»¬å¼€é¥­pool-1-thread-6å¼€åƒpool-1-thread-2å¼€åƒpool-1-thread-3å¼€åƒpool-1-thread-5å¼€åƒpool-1-thread-4å¼€åƒpool-1-thread-1å¼€åƒ äº”ã€CountDownLatchå’ŒCyclicBarrierçš„å¼‚åŒ1.CountDownLatchæŠ€æœ¯å™¨åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ŒCyclicBarrierçš„å¯ä»¥å¾ªç¯ä½¿ç”¨ã€‚2.CountDownLatchæ˜¯ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆä»»åŠ¡åæ‰ä¼šæ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼Œæ˜¯é˜»å¡å·¥ä½œçº¿ç¨‹ã€‚CyclicBarrieræ˜¯æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾æŸä¸ªå±éšœï¼ˆä¸´ç•Œç‚¹ï¼‰åäº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾åå†å…±åŒè¿›è¡Œä¸‹é¢çš„ä»»åŠ¡ã€‚3.CountDownLatchè°ƒç”¨countDownæ–¹æ³•å¯ä»¥ç»§ç»­æ‰§è¡Œåé¢çš„ï¼Œåªæ˜¯è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨countDownï¼›CyclicBarrieræ˜¯æ‰€æœ‰çš„çº¿ç¨‹è°ƒç”¨awaitè¿›è¡Œè‡ªé˜»å¡ï¼Œç­‰åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨ä¸€æ¬¡awaitåä¸€èµ·ç»§ç»­æ‰§è¡Œåé¢æ“ä½œã€‚4.CyclicBarrierå¯ä»¥åœ¨æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœåæ‰§è¡ŒbarrierActionæ“ä½œï¼Œå®Œæˆå¤æ‚çš„é€»è¾‘åœºæ™¯ã€‚ å…­ã€SemaphoreSemaphoreå³ä¿¡å·é‡ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œæˆ–åŒæ—¶æ‰§è¡ŒæŸä¸ªæŒ‡å®šæ“ä½œçš„æ•°é‡ã€‚æ¯”å¦‚å¯ä»¥ç”¨æ¥å®ç°æ•°æ®åº“çš„è¿æ¥æ± ç­‰ã€‚å¦‚æ•°æ®åº“çš„è¿æ¥æ•°ä¸º20ä¸ªï¼Œè¿™æ—¶åªèƒ½æœ‰20ä¸ªçº¿ç¨‹åŒæ—¶è·å–æ•°æ®é‡è¿æ¥ï¼Œå†å¤šçš„çº¿ç¨‹åªèƒ½é˜»å¡ç­‰å¾…ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å½’è¿˜è¿æ¥åï¼Œé˜»å¡çš„çº¿ç¨‹æ‰èƒ½ç»§ç»­è·å–ã€‚ Semaphoreçš„æ„é€ æ–¹æ³•ï¼š 1public Semaphore(int permits) ä¼ å…¥ä¸€ä¸ªæ•´å‹permitsï¼Œä»£è¡¨å¯ç”¨çš„è®¸å¯è¯æ•°é‡ã€‚æ“ä½œæ—¶å¿…é¡»å…ˆè·å–è®¸å¯è¯ï¼Œæ‰èƒ½ç»§ç»­æ“ä½œï¼Œå½“æ“ä½œå®Œæˆåéœ€é‡Šæ”¾è®¸å¯è¯ï¼Œå…¶ä½™æ²¡æœ‰è·å¾—è®¸å¯è¯çš„ä¾¿é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾äº†è®¸å¯è¯ã€‚çº¿ç¨‹ä½¿ç”¨Semaphoreçš„acquire()æ–¹æ³•è·å–è®¸å¯è¯ï¼Œä½¿ç”¨release()æ–¹æ³•é‡Šæ”¾è®¸å¯è¯ï¼Œä½¿ç”¨tryAcquire()æ–¹æ³•å°è¯•è·å–è®¸å¯è¯. å…¶ä»–æ–¹æ³•ï¼š 12345intavailablePermits() //è¿”å›æ­¤ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯è¯æ•°ã€‚intgetQueueLength() //è¿”å›æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹æ•°ã€‚booleanhasQueuedThreads()//æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯ã€‚void reducePermitsï¼ˆ int reductionï¼‰ //å‡å°‘ reduction ä¸ªè®¸å¯è¯Collection getQueuedThreads() //è¿”å›æ‰€æœ‰ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹é›†åˆ semaphoreç¤ºä¾‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566package com.wml.test1.semphore;import java.sql.Connection;import java.util.LinkedList;import java.util.Random;import java.util.concurrent.*;/** * @author Wang * @date 2020/1/2416:31 */public class SemphoreTest { private final static int POOL_SIZE=10; private final Semaphore connections; //è¿æ¥æ±  private static LinkedList&lt;Integer&gt;pool; public SemphoreTest() { pool=new LinkedList&lt;&gt;(); //åˆå§‹åŒ–è¿æ¥æ±  for (int i = 0; i &lt; POOL_SIZE; i++) { pool.addLast(i); } this.connections = new Semaphore(POOL_SIZE); } //é‡Šæ”¾è¿æ¥ public void release(Integer conn){ if(conn!=null) { System.out.println(\"å½“å‰æœ‰\"+connections.getQueueLength()+\"ä¸ªçº¿ç¨‹ç­‰å¾…æ•°æ®åº“è¿æ¥!!\" +\"å¯ç”¨è¿æ¥æ•°ï¼š\"+connections.availablePermits()); synchronized (pool) { pool.addLast(conn); } connections.release(); } } //è·å–è¿æ¥ public Integer acquire() throws InterruptedException { connections.acquire(); Integer conn; synchronized (pool){ conn=pool.removeFirst(); } return conn; } public static void main(String[] args) { SemphoreTest dbPool=new SemphoreTest(); ExecutorService pool = new ThreadPoolExecutor(50,100,0L, TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); //50ä¸ªçº¿ç¨‹è·å–è¿æ¥ for (int i = 0; i &lt; 50; i++) { pool.execute(()-&gt;{ try { Integer conn=dbPool.acquire(); System.out.println(Thread.currentThread().getName() +\"--------è·å–æ•°æ®åº“è¿æ¥\"); Thread.sleep(1000); System.out.println(\"å½’è¿˜è¿æ¥\"); dbPool.release(conn); } catch (InterruptedException e) { } }); } }}","link":"/posts/20200124-cdlcbs.html"},{"title":"javaå¤šçº¿ç¨‹ä¹‹Callable+Future+FutureTaskåŸç†è¯¦è§£å’Œç®€å•ä½¿ç”¨","text":"ä¸€ã€Runnableå’ŒCallableRunnableæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªå£°æ˜äº†ä¸€ä¸ªrun()æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸ºvoidç±»å‹ï¼Œæ‰€ä»¥åªèƒ½æ‰§è¡Œæ— è¿”å›å€¼çš„ä»»åŠ¡ã€‚ 123public interface Runnable { public abstract void run();} Callableæ˜¯java.util.concurrentåŒ…ä¸‹çš„ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†ä¸€ä¸ªcall()æ–¹æ³•: 12345678910@FunctionalInterfacepublic interface Callable&lt;V&gt; { /** * Computes a result, or throws an exception if unable to do so. * * @return computed result * @throws Exception if unable to compute a result */ V call() throws Exception;} è¯¥æ–¹æ³•è¿”å›çš„æ•°æ®ç±»å‹å°±æ˜¯ä¼ è¿›æ¥çš„æ³›å‹ç±»å‹ï¼Œä¸»è¦ç”¨äºè®¡ç®—äº§ç”Ÿç»“æœã€‚å¦‚æœæ²¡æœ‰è®¡ç®—å‡ºç»“æœï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ äºŒã€FutureFutureåˆ™æ˜¯å¯¹äºå…·ä½“çš„Runnableæˆ–Callableä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€åˆ¤æ–­æ˜¯å¦å®Œæˆã€è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚Futureæ¥å£å£°æ˜äº†5ä¸ªæ–¹æ³•ï¼š 1boolean cancel(boolean mayInterruptIfRunning); å°è¯•å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚å¦‚æœå–æ¶ˆæˆåŠŸåˆ™è¿”å›trueï¼Œå–æ¶ˆå¤±è´¥åˆ™è¿”å›falseã€‚ å¦‚æœä»»åŠ¡å·²å®Œæˆã€å·²å–æ¶ˆæˆ–ç”±äºå…¶ä»–åŸå› æ— æ³•å–æ¶ˆï¼Œåˆ™æ­¤å°è¯•å°†å¤±è´¥ï¼Œè¿”å›falseã€‚ä¼ å…¥çš„å‚æ•°å¦‚æœä¸ºtrueï¼Œåˆ™ç›´æ¥ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿”å›trueï¼›å¦‚æœä¸ºfalseï¼Œåˆ™å…è®¸æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡å®Œæˆã€‚ 1boolean isCancelled(); ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆæˆåŠŸï¼Œå¦‚æœæ­¤ä»»åŠ¡åœ¨æ­£å¸¸å·¥ä½œä¹‹å‰è¢«å–æ¶ˆï¼Œåˆ™è¿”å›trueã€‚ 1boolean isDone(); å¦‚æœæ­¤ä»»åŠ¡å·²å®Œæˆï¼Œåˆ™è¿”å›trueã€‚å®Œæˆå¯èƒ½æ˜¯ç”±äºæ­£å¸¸ç»ˆæ­¢ã€å¼‚å¸¸æˆ–å–æ¶ˆ - åœ¨æ‰€æœ‰è¿™äº›æƒ…å†µä¸‹ï¼Œæ­¤æ–¹æ³•å°†è¿”å› trueã€‚ 1V get() throws InterruptedException, ExecutionException; ä»¥é˜»å¡çš„æ–¹å¼è·å–ä»»åŠ¡æ‰§è¡Œç»“æœï¼ŒçŸ¥é“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•è¿”å›ã€‚å¦å¤–åœ¨ä»¥ä¸‹æƒ…å†µä¼šæŠ›å‡ºå¼‚å¸¸ï¼š1.ä»»åŠ¡è¢«å–æ¶ˆï¼šæŠ›å‡º CancellationException å¼‚å¸¸2.è®¡ç®—å¼•å‘å¼‚å¸¸ï¼šæŠ›å‡º ExecutionException å¼‚å¸¸3.å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼šæŠ›å‡º InterruptedException å¼‚å¸¸ 12V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException; åŒä¸Šï¼Œä½†è§„å®šäº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰è®¡ç®—å‡ºç»“æœï¼Œä¼šæŠ›å‡ºTimeoutExceptionå¼‚å¸¸ã€‚ ä¸‰ã€FutureTaskFutureTaskç±»å®ç°äº†RunnableFutureæ¥å£ï¼Œè€ŒRunnableFutureç»§æ‰¿äº†Runnableå’ŒFutureæ¥å£ï¼Œå¯çŸ¥FutureTaskå¯åšRunnableå’ŒFutureä¸€æ ·çš„äº‹æƒ…ã€‚ 123public class FutureTask&lt;V&gt; implements RunnableFuture&lt;V&gt; public interface RunnableFuture&lt;V&gt; extends Runnable, Future&lt;V&gt; 3.1 é¦–å…ˆçœ‹FutureTaskçš„æˆå‘˜å˜é‡1234567891011121314private volatile int state; private static final int NEW = 0; private static final int COMPLETING = 1; private static final int NORMAL = 2; private static final int EXCEPTIONAL = 3; private static final int CANCELLED = 4; private static final int INTERRUPTING = 5; private static final int INTERRUPTED = 6; private Callable&lt;V&gt; callable; private Object outcome; // non-volatile, protected by state reads/writes private volatile Thread runner; private volatile WaitNode waiters; 1.stateï¼šstateä¿å­˜äº†FutureTaskä»»åŠ¡çš„çŠ¶æ€å€¼ï¼Œä¸ºvolatileç±»å‹ï¼Œä¿è¯äº†åŸå­æ€§ï¼Œå³ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†stateçš„å€¼ï¼Œéƒ½å¯ä»¥ä¿è¯å…¶ä»–çº¿ç¨‹çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚stateå…±æœ‰å¦‚ä¸‹å‡ ä¸ªå–å€¼ï¼ˆå¯¹åº”çš„å€¼ä¾æ­¤ä¸º0åˆ°6ï¼‰ï¼š NEWï¼šä¸ºstateçš„åˆå§‹å€¼ã€‚è¡¨ç¤ºè¯¥ä»»åŠ¡æ˜¯ä¸ªæ–°ä»»åŠ¡ã€‚COMPLETING:å½“å‰ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•æˆ–æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œä½†ç»“æœå°šæœªä¿å­˜åˆ°outcomeï¼ˆoutcomeç”¨æ¥ä¿å­˜è®¡ç®—ç»“æœæˆ–è€…æ˜¯å¼‚å¸¸ä¿¡æ¯ï¼‰ä¸­ï¼Œå±äºä¸­é—´çŠ¶æ€ã€‚NORMAL: ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä¸”ç»“æœä¿å­˜åˆ°outcomeä¸­ã€‚æ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚EXCEPTIONAL: ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œä¸”å¼‚å¸¸ä¿¡æ¯å·²ä¿å­˜åˆ°outcomeä¸­ã€‚æ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚CANCELLEDï¼šä»»åŠ¡å°šæœªå¼€å§‹æˆ–ä»»åŠ¡æ‰§è¡Œæ—¶è°ƒç”¨äº†cancel(false)æ–¹æ³•ã€‚æ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚INTERRUPTINGï¼šä»»åŠ¡å°šæœªå¼€å§‹æˆ–ä»»åŠ¡æ‰§è¡Œæ—¶è°ƒç”¨äº†cancel(true)æ–¹æ³•ã€‚æ­¤ä¸ºä¸­é—´çŠ¶æ€ã€‚INTERRUPTED: åœ¨è°ƒç”¨cancel(true)æ—¶ï¼Œä¼šè°ƒç”¨: 123Thread t = runner; if (t != null) t.interrupt(); stateä¼šå˜ä¸ºINTERRUPTEDï¼Œæ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚ä½†å¦‚æœè¢«ç»ˆç«¯çš„çº¿ç¨‹æ­£åœ¨sleep()ã€wait()ã€æˆ–join()ï¼Œåˆ™ä¼šæŠ›å‡ºInterruptedException()å¼‚å¸¸ï¼Œå› æ­¤cancel(true)ï¼ˆæ³¨æ„ï¼šä¸­é—´çŠ¶æ€æ—¶é—´çŸ­æš‚ï¼Œä¸ä»£è¡¨ä»»åŠ¡ä»åœ¨æ‰§è¡Œï¼Œè€Œæ˜¯ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå°šæœªè®¾ç½®æ‰§è¡Œç»“æœï¼Œå› æ­¤é™¤äº†NEWçŠ¶æ€ï¼Œå…¶ä½™çŠ¶æ€éƒ½ä»£è¡¨å·²ç»æ‰§è¡Œç»“æŸï¼‰å¯èƒ½å‡ºç°çš„è½¬å˜çŠ¶æ€ä¸ºï¼š 1234NEW -&gt; COMPLETING -&gt; NORMALNEW -&gt; COMPLETING -&gt; EXCEPTIONALNEW -&gt; CANCELLEDNEW -&gt; INTERRUPTING -&gt; INTERRUPTED 2.callableï¼šè¦æ‰§è¡Œçš„taskä»»åŠ¡ã€‚3.outcome: ä¿å­˜æ‰§è¡Œç»“æœæˆ–å‡ºç°å¼‚å¸¸æ—¶ä¿å­˜å¼‚å¸¸ä¿¡æ¯4.runner:æ‰§è¡Œtaskçš„çº¿ç¨‹ï¼Œåœ¨å–æ¶ˆå’Œä¸­æ–­çº¿ç¨‹æ—¶éœ€è¦çŸ¥é“æ˜¯å“ªä¸ªçº¿ç¨‹ã€‚5.waitersï¼šä¸ºWaitNode çš„å¯¹è±¡ã€‚WaitNode ä¸ºä¸€ä¸ªç®€å•çš„å•å‘é“¾è¡¨ç»“æ„çš„é˜Ÿåˆ—ï¼Œå½“ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰çº¿ç¨‹æƒ³è¦è°ƒç”¨get()è·å–ç»“æœæ—¶ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šè¢«é˜»å¡åŠ å…¥WaitNodeï¼Œç›´åˆ°è¯¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ä»¥ä¸‹ä¸ºWaitNodeçš„ç»“æ„ï¼š 12345static final class WaitNode { volatile Thread thread; volatile WaitNode next; WaitNode() { thread = Thread.currentThread(); } } ä»…ç”±ä¸€ä¸ªThreadå’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„nextç»„æˆï¼Œthreadå³ä¸ºå½“å‰çº¿ç¨‹ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªTreiberæ ˆã€‚ 3.2é™æ€ä»£ç å—ä¸­åˆå§‹åŒ–éœ€è¦CASæ“ä½œçš„å±æ€§çš„åç§»é‡12345678910111213141516171819// Unsafe mechanics private static final sun.misc.Unsafe UNSAFE; private static final long stateOffset; private static final long runnerOffset; private static final long waitersOffset; static { try { UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = FutureTask.class; stateOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(\"state\")); runnerOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(\"runner\")); waitersOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(\"waiters\")); } catch (Exception e) { throw new Error(e); } } CASæ“ä½œè°ƒç”¨çš„æ˜¯compareAndSwap***æ–¹æ³• 3.3 æ„é€ æ–¹æ³•3.3.1 123456public FutureTask(Callable&lt;V&gt; callable) { if (callable == null) throw new NullPointerException(); this.callable = callable; this.state = NEW; // ensure visibility of callable } å°†ä¼ å…¥çš„callableèµ‹å€¼ç»™ä¸Šé¢è¯´çš„æˆå‘˜å˜é‡callableï¼Œå°†stateåˆå§‹åŒ–ä¸ºNEWï¼›3.3.2 1234public FutureTask(Runnable runnable, V result) { this.callable = Executors.callable(runnable, result); this.state = NEW; // ensure visibility of callable } ä¼ å…¥Runnableå¯¹è±¡ï¼Œé€šè¿‡Executors.callable()æ–¹æ³•å°†runnableè½¬ä¸ºcallableä¿å­˜ç»™callableå˜é‡ï¼ŒåŒæ—¶ä¼šè¿”å›ä¼ å…¥çš„resultã€‚å°†runnableè½¬ä¸ºcallableçš„æ–¹æ³•å¦‚ä¸‹ï¼š 12345public static &lt;T&gt; Callable&lt;T&gt; callable(Runnable task, T result) { if (task == null) throw new NullPointerException(); return new RunnableAdapter&lt;T&gt;(task, result); } è¿™é‡Œè°ƒç”¨RunnableAdapter()é€‚é…,ä»£ç å¦‚ä¸‹ï¼š 12345678910111213static final class RunnableAdapter&lt;T&gt; implements Callable&lt;T&gt; { final Runnable task; final T result; RunnableAdapter(Runnable task, T result) { this.task = task; this.result = result; } public T call() { task.run(); return result; } } } RunnableAdapterå®ç°äº†Callableæ¥å£ï¼Œåœ¨call()ä¸­è°ƒç”¨task.run()ï¼Œå°†ä¼ å…¥çš„resultè¿”å›ã€‚ 3.4 æ–¹æ³•3.4.1 run()1234567891011121314151617181920212223242526272829303132333435public void run() { //ä»£ç 1 if (state != NEW || !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread())) return; try { Callable&lt;V&gt; c = callable; if (c != null &amp;&amp; state == NEW) { //ä»£ç 2 V result; boolean ran; try { result = c.call(); ran = true; } catch (Throwable ex) { result = null; ran = false; setException(ex); } if (ran) set(result); } } finally { // runner must be non-null until state is settled to // prevent concurrent calls to run() //ä»£ç 3 runner = null; // state must be re-read after nulling runner to prevent // leaked interrupts int s = state; if (s &gt;= INTERRUPTING) handlePossibleCancellationInterrupt(s); } } ä»£ç 1ï¼š1.state!=NEW: å¦‚æœstateä¸ä¸ºNEWï¼Œå³ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•æˆ–è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›ã€‚2. è‹¥stateæ˜¯NEWï¼Œåˆ™å°è¯•å°†å½“å‰çº¿ç¨‹ä¿å­˜åˆ°runnerä¸­ï¼Œå³å¦‚æœrunnerä¸ºç©ºå°±å°†å½“å‰çº¿ç¨‹ä¿å­˜ç»™runnerï¼Œè‹¥runnerä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜å·²ç»æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œï¼Œç›´æ¥return,å¦åˆ™è¿›å…¥try-catchã€‚ ä»£ç 2ï¼š1.å®šä¹‰V resultä¿å­˜callableçš„æ‰§è¡Œç»“æœï¼Œç½®ranä¸ºtrueï¼Œä»£è¡¨æ‰§è¡ŒæˆåŠŸã€‚2.è‹¥å‡ºç°å¼‚å¸¸ï¼Œåˆ™åœ¨catchä¸­æ•è·ï¼Œå°†resultç½®ä¸ºnullï¼Œranç½®ä¸ºfalseä»£è¡¨å‡ºç°å¼‚å¸¸ï¼ŒåŒæ—¶é€šè¿‡setException(ex)è®¾ç½®å¼‚å¸¸ã€‚setException(ex)ä»£ç å¦‚ä¸‹ï¼š 1234567protected void setException(Throwable t) { if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) { outcome = t; UNSAFE.putOrderedInt(this, stateOffset, EXCEPTIONAL); // final state finishCompletion(); } } æ­¤æ–¹æ³•ä¸­ï¼Œå°è¯•å°†stateçš„å€¼ä»NEWæ”¹ä¸ºCOMPLETING,å¦‚æœæˆåŠŸï¼Œåˆ™å°†å¼‚å¸¸ä¿¡æ¯ä¿å­˜åˆ°outcomeä¸­ï¼Œç„¶åå†å°†çŠ¶æ€æ”¹ä¸ºæœ€ç»ˆæ€EXCEPTIONALï¼Œæœ€åè°ƒç”¨finishCompletion()ç§»é™¤å¹¶å”¤é†’WaitNodeä¸­æ‰€æœ‰é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œè°ƒç”¨done()ï¼Œå¹¶è®©callableæ— æ•ˆï¼Œæºç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122private void finishCompletion() { // assert state &gt; COMPLETING; for (WaitNode q; (q = waiters) != null;) { if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) { for (;;) { Thread t = q.thread; if (t != null) { q.thread = null; LockSupport.unpark(t); } WaitNode next = q.next; if (next == null) break; q.next = null; // unlink to help gc q = next; } break; } } done(); callable = null; } å¦‚æœranä¸ºtrueï¼Œå³æ­£å¸¸æ‰§è¡Œï¼Œé€šè¿‡set(result)ï¼Œset()æºç å¦‚ä¸‹ï¼š 1234567protected void set(V v) { if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) { outcome = v; UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state finishCompletion(); } } åœ¨set()ä¸­ï¼Œå°è¯•å°†çŠ¶æ€ä»NEWå˜ä¸ºCOMPLETINGä¸­é—´æ€(è¿™é‡Œå†é‡æ–°ç†è§£ä¸Šé¢è¯´çš„stateçš„7ä¸ªçŠ¶æ€ä¼šæ›´æ·±åˆ»ä¸€ç‚¹)ï¼Œå¹¶å°†ç»“æœä¿å­˜ç»™outcomeï¼Œæ¥ç€å°†stateç”±COMPLETINGè½¬ä¸ºNORMALæœ€ç»ˆçŠ¶æ€ï¼ŒåŒä¸Šè°ƒç”¨ finishCompletion()ã€‚ ä»£ç 3ï¼š1.åœ¨finallyä¸­é‡æ–°å°†runnerç½®ç©ºï¼Œè¡¨æ˜å½“å‰çº¿ç¨‹è¿è¡Œå®Œæ¯•ï¼Œåœ¨ä¸‹ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åˆ°run()ï¼ˆä»£ç 1ï¼‰æ–¹æ³•æ—¶ï¼Œä¾¿å¯é€šè¿‡CASé‡æ–°å°†çº¿ç¨‹ä¿å­˜åˆ°runnerã€‚2.è‹¥ranä¸ºfalseï¼Œå³å‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨handlePossibleCancellationInterrupt(state)å¤„ç†å¼‚å¸¸ï¼Œ 1234567891011121314151617private void handlePossibleCancellationInterrupt(int s) { // It is possible for our interrupter to stall before getting a // chance to interrupt us. Let's spin-wait patiently. if (s == INTERRUPTING) while (state == INTERRUPTING) Thread.yield(); // wait out pending interrupt // assert state == INTERRUPTED; // We want to clear any interrupt we may have received from // cancel(true). However, it is permissible to use interrupts // as an independent mechanism for a task to communicate with // its caller, and there is no way to clear only the // cancellation interrupt. // // Thread.interrupted(); } åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå¦‚æœçŠ¶æ€ä¸€ç›´æ˜¯INTERUPINGï¼Œåˆ™ä¸€ç›´è¿›è¡Œyield()ã€‚ 3.4.2 get()çº¿ç¨‹å¯è°ƒç”¨get()æ–¹æ³•è·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœï¼Œå¦‚æœå½“å‰ä»»åŠ¡å°šæœªæ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é˜»å¡è°ƒç”¨get()æ–¹æ³•çš„çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œç»“æŸã€‚ 123456789/** * @throws CancellationException {@inheritDoc} */ public V get() throws InterruptedException, ExecutionException { int s = state; if (s &lt;= COMPLETING) s = awaitDone(false, 0L); return report(s); } get()æ–¹æ³•ä¸­é¦–å…ˆåˆ¤æ–­å½“å‰çš„çŠ¶æ€æ˜¯å¦å°äºç­‰äºCOMPLETINGï¼Œå³ä»»åŠ¡æ˜¯å¦å¤„äºå°šæœªå¼€å§‹æˆ–å°šæœªç»“æŸæˆ–ç»“æœå°šæœªä¿å­˜åˆ°outcomeçš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨awaitDone(false, 0L);é˜»å¡ç­‰å¾…ï¼Œå¦åˆ™è°ƒç”¨report(s)è¿”å›æ‰§è¡Œç»“æœã€‚ report()12345678private V report(int s) throws ExecutionException { Object x = outcome; if (s == NORMAL) return (V)x; if (s &gt;= CANCELLED) throw new CancellationException(); throw new ExecutionException((Throwable)x); } è·å–å½“å‰ç»“æœoutcomeï¼Œå¦‚æœå½“å‰çŠ¶æ€ä¸ºNORMALï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœï¼Œå¦‚æœå½“å‰çŠ¶æ€å¤§äºç­‰äºCANCELLEDï¼Œåˆ™æŠ›å‡ºCancellationException()å¼‚å¸¸ï¼Œå…¶ä»–çŠ¶æ€åˆ™æŠ›å‡ºExecutionException()å¼‚å¸¸ã€‚ 3.4.3 awaitDone()çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•é˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445private int awaitDone(boolean timed, long nanos) throws InterruptedException { //è‹¥å¼€å¯è¶…æ—¶ï¼Œåˆ™è®¡ç®—æˆªæ­¢æ—¶é—´ final long deadline = timed ? System.nanoTime() + nanos : 0L; //åˆ›å»ºä¸€ä¸ªWaitNodeèŠ‚ç‚¹ WaitNode q = null; //æ˜¯å¦è¿›å…¥é˜»å¡é˜Ÿåˆ— boolean queued = false; for (;;) { //ä»£ç 1 if (Thread.interrupted()) { removeWaiter(q); throw new InterruptedException(); } int s = state; //ä»£ç 2 if (s &gt; COMPLETING) { if (q != null) q.thread = null; return s; } //ä»£ç 3 else if (s == COMPLETING) // cannot time out yet Thread.yield(); //ä»£ç 4 else if (q == null) q = new WaitNode(); //ä»£ç 5 else if (!queued) queued = UNSAFE.compareAndSwapObject(this, waitersOffset, q.next = waiters, q); //ä»£ç 6 else if (timed) { nanos = deadline - System.nanoTime(); if (nanos &lt;= 0L) { removeWaiter(q); return state; } LockSupport.parkNanos(this, nanos); } else LockSupport.park(this); }} æ–¹æ³•çš„å‚æ•°ä¸º timed(æ˜¯å¦å¼€å¯è¶…æ—¶æ—¶é—´)å’Œnanos(è‹¥å¼€å¯è¶…æ—¶æ—¶é—´ï¼Œåˆ™æ­¤å‚æ•°ä¸ºè¶…æ—¶æ—¶é—´)ï¼ˆä»£ç 1åˆ°ä»£ç 6åœ¨ä¸€ä¸ªæ— é™forå¾ªç¯ä¸­ï¼Œä¸åœçš„è¿›è¡Œå¾ªç¯åˆ¤æ–­ï¼‰ ä»£ç 1ï¼šå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™å°†é˜»å¡é˜Ÿåˆ—waitNodeä¸­çš„è¯¥èŠ‚ç‚¹ç»™ç§»é™¤ï¼Œå¹¶æŠ›å‡ºInterruptedException()å¼‚å¸¸ã€‚ä»£ç 2ï¼šåˆ¤æ–­å½“å‰é˜»å¡çº¿ç¨‹çš„çŠ¶æ€æ˜¯å¦å¤§äºCOMPLETINGï¼Œå¦‚æœå¤§äºï¼Œåˆ™è¯¥ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹éç©ºï¼Œåˆ™åˆ é™¤è¯¥èŠ‚ç‚¹çš„threadï¼Œå¹¶è¿”å›çŠ¶æ€ã€‚ä»£ç 3ï¼š å¦‚æœå½“å‰çŠ¶æ€ä¸ºCOMPLETINGï¼Œåˆ™è¯´æ˜ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯æ‰§è¡Œç»“æœå°šæœªèµ‹å€¼ç»™outcomeï¼Œæ­¤æ—¶æ‰§è¡Œyieldè®©å‡ºCPUã€‚ä»£ç 4ï¼šå¦‚æœå½“å‰é˜»å¡ç­‰å¾…èŠ‚ç‚¹qä¸ºç©ºï¼Œåˆ™æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ã€‚ä»£ç 5ï¼šå¦‚æœå°šæœªå…¥é˜Ÿåˆ—ï¼Œåˆ™å°†ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„nextæŒ‡å‘waitersï¼Œç„¶åå°è¯•è®©æ–°çš„èŠ‚ç‚¹qæ›¿æ¢waitersï¼Œå¦‚æœå°è¯•æˆåŠŸåˆ™queuedä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseã€‚ä»£ç 6ï¼šå¦‚æœå¼€å¯äº†è¶…æ—¶é™åˆ¶ï¼Œåˆ™é‡æ–°è®¡ç®—ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœ nanos&lt;=0Lï¼Œå³è¶…æ—¶äº†ï¼Œåˆ™ç§»é™¤ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯¥èŠ‚ç‚¹ï¼Œå¹¶è¿”å›å½“å‰stateï¼›å¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œåˆ™ç»§ç»­é˜»å¡é‡æ–°è®¡ç®—åçš„æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰å¼€å¯è¶…æ—¶é™åˆ¶ï¼Œåˆ™ç›´æ¥é˜»å¡ç­‰å¾…ç›´åˆ°è¢«å”¤é†’ã€‚ 3.4.4 cancel()1234567891011121314151617181920212223public boolean cancel(boolean mayInterruptIfRunning) { //ä»£ç 1 if (!(state == NEW &amp;&amp; UNSAFE.compareAndSwapInt(this, stateOffset, NEW, mayInterruptIfRunning ? INTERRUPTING : CANCELLED))) return false; try { //ä»£ç 2 if (mayInterruptIfRunning) { try { Thread t = runner; if (t != null) t.interrupt(); } finally { // final state UNSAFE.putOrderedInt(this, stateOffset, INTERRUPTED); } } } finally { //ä»£ç 3 finishCompletion(); } return true; } ä»£ç 1ï¼š1.å¦‚æœstateä¸ç­‰äºNEWï¼Œåˆ™ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•æˆ–å‡ºç°å¼‚å¸¸æˆ–è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›falseï¼›2.å¦‚æœä»»åŠ¡å°šæœªå¼€å§‹ï¼Œåˆ™é€šè¿‡CASå°è¯•å°†çŠ¶æ€ä»NEWæ”¹ä¸ºmayInterruptIfRunningï¼Œè‹¥mayInterruptIfRunningä¸ºtrueï¼Œä»£è¡¨éœ€è¦ä¸­æ–­ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ï¼Œåˆ™æ”¹ä¸ºINTERRUPTINGä¸­é—´çŠ¶æ€ï¼Œå¦åˆ™æ”¹ä¸ºCANCELLEDæœ€ç»ˆçŠ¶æ€ï¼Œå¦‚æœå°è¯•æ›´æ–°æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ä»£ç 2ï¼šå¦‚æœè¿›è¡Œäº†ä¸­æ–­ï¼Œåˆ™è·å–å½“å‰çš„çº¿ç¨‹runnerï¼Œä¸­æ–­ä¹‹ã€‚æœ€åå°†çŠ¶æ€ç”±INTERRUPTINGæ”¹ä¸ºINTERRUPTEDä»£ç 3ï¼šæ‰§è¡ŒfinishCompltion()(ä»»åŠ¡å‡ºç°å¼‚å¸¸æˆ–æ­£å¸¸æ‰§è¡Œå®Œæ¯•æˆ–æˆåŠŸå–æ¶ˆä»»åŠ¡éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¸Šæ–‡å·²æåˆ°)ï¼Œè¿”å›true 3.4.5 isCancelled()123public boolean isCancelled() { return state &gt;= CANCELLED; } åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆã€‚åªè¦çŠ¶æ€å¤§äºç­‰äºCANCELLEDéƒ½è¿”å›trueã€‚ 3.4.6 isDone()123public boolean isDone() { return state != NEW; } åªè¦ä¸æ˜¯NEWï¼Œéƒ½è¿”å›trueï¼Œä»£è¡¨ä»»åŠ¡å·²å®Œæˆã€‚ å››.Callable+Futureç¤ºä¾‹12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package com.wml.test2.future;import java.util.concurrent.*;/** * @author MaoLin Wang * @date 2020/1/2723:18 */public class FutureDemo { public static class Task implements Callable&lt;Integer&gt;{ private int sum; @Override public Integer call() throws Exception { System.out.println(\"Callableçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡\"); Thread.sleep(1500); for (int i = 0; i &lt; 50; i++) { if (Thread.currentThread().isInterrupted()){ System.out.println(\"Callableçº¿ç¨‹è®¡ç®—ä»»åŠ¡ä¸­æ–­\"); return null; } if (i%2==0){ sum=sum+i; System.out.println(\"sum=\"+sum); } } System.out.println(\"Callableçº¿ç¨‹æ‰§è¡Œå®Œæ¯• è®¡ç®—ç»“æœä¸º\"+sum); return sum; } } public static void main(String[] args) { Task task=new Task(); ExecutorService pool = new ThreadPoolExecutor(6,100,0L,TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); Future&lt;Integer&gt;future=pool.submit(task); pool.shutdown(); try { Thread.sleep(3000L); System.out.println(\"ä¸»çº¿ç¨‹æ‰§è¡Œå…¶ä»–ä»»åŠ¡ä¸­.....\"); if (future.get()!=null){ System.out.println(\"ä¸»çº¿ç¨‹è·å–Callableæ‰§è¡Œç»“æœ:\"+future.get()); }else { System.out.println(\"å°šæœªè·å–åˆ°ç»“æœ\"); } } catch (InterruptedException e) { e.printStackTrace(); } catch (ExecutionException e) { e.printStackTrace(); } }} ç»“æœï¼š 1234567891011121314151617181920212223242526272829Callableçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡sum=0sum=2sum=6sum=12sum=20sum=30sum=42sum=56sum=72sum=90sum=110sum=132sum=156sum=182sum=210sum=240sum=272sum=306sum=342sum=380sum=420sum=462sum=506sum=552sum=600Callableçº¿ç¨‹æ‰§è¡Œå®Œæ¯• è®¡ç®—ç»“æœä¸º600ä¸»çº¿ç¨‹æ‰§è¡Œå…¶ä»–ä»»åŠ¡ä¸­.....ä¸»çº¿ç¨‹è·å–Callableæ‰§è¡Œç»“æœ:600 äº”ã€Callable+FutureTaskç¤ºä¾‹Taskç±»åŒä¸Š 12345678910111213141516171819202122public static void main(String[] args) { ExecutorService pool = new ThreadPoolExecutor(6,100,0L, TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); Task task=new Task(); //åˆ›å»ºFutureTaskä»»åŠ¡ FutureTask futureTask=new FutureTask(task); pool.submit(futureTask); pool.shutdown(); try { Thread.sleep(3000L); System.out.println(\"ä¸»çº¿ç¨‹æ‰§è¡Œå…¶ä»–ä»»åŠ¡ä¸­.....\"); if (futureTask.get()!=null){ System.out.println(\"ä¸»çº¿ç¨‹è·å–Callableæ‰§è¡Œç»“æœ:\"+futureTask.get()); }else { System.out.println(\"å°šæœªè·å–åˆ°ç»“æœ\"); } } catch (InterruptedException e) { e.printStackTrace(); } catch (ExecutionException e) { e.printStackTrace(); } } ç»“æœï¼š 1234567891011Callableå­çº¿ç¨‹å¼€å§‹è®¡ç®—ï¼sum=0sum=1sum=3sum=6sum=10sum=15sum=21Cancel................. sum=28Callableå­çº¿ç¨‹è®¡ç®—ä»»åŠ¡ä¸­æ–­ï¼","link":"/posts/20200127-runcalfutask.html"},{"title":"javaå¤šçº¿ç¨‹ä¹‹CASæ“ä½œåŠç›¸å…³åŸå­æ“ä½œç±»è¯¦è§£","text":"ä¸€ã€åŸå­æ“ä½œæ˜¯ä»€ä¹ˆåŸå­æ“ä½œå³ä¸å¯è¢«ä¸­æ–­ï¼ˆåˆ†å‰²ï¼‰çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œï¼Œå¦‚å¯¹äºA,Bä¸¤ä¸ªæ“ä½œï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ“ä½œAï¼Œè‹¥å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒBæ“ä½œæ—¶ï¼Œè¦ä¹ˆå°†Bæ‰§è¡Œåˆ°ç»“æŸï¼Œè¦ä¹ˆå®Œå…¨ä¸è®©Bæ‰§è¡Œï¼Œæ­¤æ—¶å¯¹äºAå’ŒBæ¥è¯´ï¼Œå°±æ˜¯åŸå­çš„ã€‚ äºŒã€æ‚²è§‚é”å’Œä¹è§‚é”å¦‚synchronizedå°±æ˜¯æ‚²è§‚é”ï¼Œè§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼Œä»¥ä¿è¯äº‹åŠ¡çš„å®Œæ•´æ€§ã€‚å…¶æ˜¯åŸºäºé˜»å¡çš„é”æœºåˆ¶ï¼Œå¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰é”åï¼Œè®¿é—®è¯¥èµ„æºçš„å…¶ä»–çº¿ç¨‹å°±éœ€è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°è·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚CASæ“ä½œå³æ˜¯ä¹è§‚é”ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œåªæœ‰åœ¨æäº¤æ•°æ®çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦è¿åäº†æ•°æ®çš„å®Œæ•´æ€§ï¼Œå³æ¯æ¬¡éƒ½å°è¯•å»å®ŒæˆæŸä¸ªæ“ä½œï¼Œå¦‚æœå†²çªå’Œé€ æˆæ“ä½œå¤±è´¥ï¼Œå°±å¾ªç¯é‡è¯•ï¼Œç›´åˆ°æ“ä½œæˆåŠŸä¸ºæ­¢ã€‚ ä½¿ç”¨synchronizedä¼šå¼•å‡ºå¾ˆå¤šé—®é¢˜ï¼Œå¦‚ï¼šè·å¾—é”çš„çº¿ç¨‹ä¸€ç›´ä¸é‡Šæ”¾é”ï¼›å¤§é‡çº¿ç¨‹ç«äº‰èµ„æºï¼Œå¯èƒ½ä¼šé€ æˆæ­»é”ï¼›è¢«é˜»å¡çš„çº¿ç¨‹å¯èƒ½ä¼˜å…ˆçº§å¾ˆé«˜å´ä¸€ç›´æ— æ³•è·å–é”ã€‚ å› æ­¤å®ç°åŸå­æ“ä½œå¯ä½¿ç”¨CASæŒ‡ä»¤ã€‚ ä¸‰ã€CASCAS å³Compare and Swapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ã€‚æ¯ä¸ªCASæ“ä½œè¿‡ç¨‹éƒ½åŒ…æ‹¬ä¸‰ä¸ªè¿ç®—ç¬¦ï¼šå†…å­˜åœ°å€Vã€æœŸæœ›å€¼Aã€æ–°çš„å€¼Bå¦‚æœæ“ä½œçš„æ—¶å€™åœ°å€Vä¸Šçš„å€¼ç­‰äºæœŸæœ›çš„å€¼Aï¼Œåˆ™å°†åœ°å€Vä¸Šçš„å€¼æ›´æ–°ä¸ºBï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œï¼Œä½†è¦è¿”å›åŸå€¼ã€‚å¾ªç¯CASå°±æ˜¯ä¸æ–­çš„è¿›è¡ŒCASæ“ä½œç›´åˆ°æ“ä½œæˆåŠŸã€‚å¯é˜²æ­¢å†…å­˜ä¸­å…±äº«å˜é‡å‡ºç°è„è¯»è„å†™çš„é—®é¢˜ã€‚CASæ˜¯é€šè¿‡ç¡¬ä»¶CPUå’Œå†…å­˜ï¼Œåˆ©ç”¨CPUçš„å¤šå¤„ç†èƒ½åŠ›å®ç°ç¡¬ä»¶å±‚é¢çš„é˜»å¡ï¼Œå†åŠ ä¸Švolatileå˜é‡çš„ç‰¹æ€§æ¥å®ç°åŸºäºåŸå­æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚ ï¼ˆ1ï¼‰getå˜é‡å€¼(æ—§å€¼)â€”â€“&gt;ï¼ˆ2ï¼‰è®¡ç®—åå¾—åˆ°æ–°å€¼â€”â€”&gt;ï¼ˆ3ï¼‰æ¯”è¾ƒå†…å­˜ä¸­å˜é‡å€¼å’Œæ—§å€¼â€”â€“&gt;ï¼ˆ4ï¼‰å¦‚æœï¼ˆ3ï¼‰ç›¸ç­‰ï¼Œåˆ™è®©æ–°å€¼æ›¿æ¢æ—§å€¼ï¼Œå¦åˆ™ç»§ç»­ï¼ˆ1ï¼‰ å››ã€CASå®ç°åŸå­æ“ä½œçš„ä¸‰å¤§é—®é¢˜4.1ABAé—®é¢˜ç”±äºCASåœ¨æ“ä½œå€¼çš„æ—¶å€™éœ€è¦æ£€æŸ¥æ—§å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæœªå˜åŒ–åˆ™æ›´æ–°å€¼ï¼Œä½†å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œç„¶ååˆå˜ä¸ºäº†Aï¼Œè¿™æ ·è™½ç„¶å€¼å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†ä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„æ—§å€¼â€œæœªå˜åŒ–â€ã€‚è€Œè¦è§£å†³è¯¥é—®é¢˜ï¼Œå°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚å³ç»™å˜é‡æ·»åŠ ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ›´æ–°å˜é‡éƒ½å»æ›´æ–°å®ƒçš„ç‰ˆæœ¬å·ï¼Œå¦‚åˆšåˆšA-&gt;B-&gt;Aï¼Œä¾¿å˜æˆäº† 1A-&gt;2B-&gt;3Aã€‚å°±åƒåœ¨å®¶é‡Œå€’äº†ä¸€æ¯æ°´ï¼Œä½ è¿˜æ²¡æ¥å¾—åŠå–ï¼Œä½†æ˜¯è¢«å®¶äººå–æ‰ï¼Œ ç„¶ååˆç»™ä½ æ¥æ»¡äº†ä¸€æ¯æ°´ï¼Œè¿™æ ·å¦‚æœåœ¨ä¸çŸ¥é“çš„æƒ…å†µä¸‹ï¼Œä½ ä¼šè®¤ä¸ºè¿™ä»ç„¶æ˜¯ä¹‹å‰é‚£æ¯æ°´ã€‚åˆæˆ–è€…ä½ çš„èµ„é‡‘è¢«åˆ«äººæŒªç”¨äº†ï¼Œç„¶ååˆè¿˜ç»™äº†ä½ ï¼Œè™½ç„¶é’±æ²¡æœ‰å˜ï¼Œä½†é€ æˆçš„é—®é¢˜æ—¶é‚£ä¸ªäººå·²ç»çŠ¯ç½ªäº†ã€‚ 4.2å¾ªç¯æ—¶é—´é•¿ï¼Œå¼€é”€å¤§å¦‚æœCASä¸€ç›´å¤„äºè‡ªæ—‹ä¸æˆåŠŸçŠ¶æ€ï¼ŒCPUçš„å¼€é”€ä¼šå¤§å¤§å¢åŠ ã€‚ 4.3åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œå½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå¯ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œå½“ç„¶å¯ä»¥ç”¨é”ã€‚ä¹Ÿå¯ä»¥æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚å¦‚ï¼Œæœ‰ä¸¤ä¸ªå…±äº«å˜é‡ iï¼aï¼Œj=bï¼Œåˆå¹¶ä¸€ä¸‹ ij=abï¼Œç„¶åç”¨ CAS æ¥æ“ä½œ ijï¼Œç„¶åé€šè¿‡AtomicReference ç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œä¾¿å®ç°äº†å¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡Œ CAS æ“ä½œã€‚ äº”ã€JDKä¸­ç›¸å…³åŸå­æ“ä½œç±»çš„ä½¿ç”¨5.1æ¦‚è§ˆæ›´æ–°åŸºæœ¬ç±»å‹ç±»ï¼šAtomicBooleanï¼ŒAtomicIntegerï¼ŒAtomicLongæ›´æ–°æ•°ç»„ç±»ï¼šAtomicIntegerArrayï¼ŒAtomicLongArrayï¼ŒAtomicReferenceArrayæ›´æ–°å¼•ç”¨ç±»å‹ï¼šAtomicReferenceï¼ŒAtomicMarkableReferenceï¼ŒAtomicStampedReferenceåŸå­æ›´æ–°å­—æ®µç±»ï¼š AtomicReferenceFieldUpdaterï¼ŒAtomicIntegerFieldUpdaterï¼ŒAtomicLongFieldUpdater åŸºæœ¬æ•°æ®ç±»å‹çš„åŸå­æ“ä½œç±»ä»¥AtomicIntegerä¸ºä¾‹ï¼Œå…¶ä½™å·®ä¸å¤šã€‚ 5.2 AtomicIntegerå¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112public class AtomicInteger extends Number implements java.io.Serializable { private static final long serialVersionUID = 6214790243416807050L; //è·å–æŒ‡é’ˆç±»Unsafe private static final Unsafe unsafe = Unsafe.getUnsafe(); //å†…å­˜åç§»é‡ private static final long valueOffset; static { try { //é€šè¿‡objectFieldOffset()æ–¹æ³•ï¼Œè·å–å¯¹è±¡å±æ€§çš„åç§»é‡ valueOffset = unsafe.objectFieldOffset (AtomicInteger.class.getDeclaredField(\"value\")); } catch (Exception ex) { throw new Error(ex); } } //å½“å‰çš„å˜é‡å€¼ private volatile int value; public AtomicInteger(int initialValue) { //åˆå§‹åŒ–å˜é‡å€¼ value = initialValue; } //valueåˆå§‹åŒ–ä¸º0 public AtomicInteger() { } //è¿”å›å½“å‰å€¼ public final int get() { return value; } //è®¾ç½®å½“å‰å€¼ public final void set(int newValue) { value = newValue; } //æ‡’è®¾ç½®ï¼Œä½¿ç”¨Unsafe.putOrderedObjectæ–¹æ³•å®ç°ï¼Œå®ç°éå µå¡çš„å†™å…¥ï¼Œæœ€ç»ˆä¼šå°†valueç½®ä¸ºnewValueã€‚ //è¯¥æ–¹æ³•å¯èƒ½å‡ºç°å…¶ä»–çº¿ç¨‹åœ¨æœªæ¥å¾ˆå°çš„ä¸€æ®µæ—¶é—´å†…æ— æ³•è·å–åˆ°æ–°å€¼ï¼Œä½†å¯è·å–åˆ°æ—§å€¼ public final void lazySet(int newValue) { unsafe.putOrderedInt(this, valueOffset, newValue); } //ä»¥åŸå­æ–¹å¼è®¾ç½®ä¸ºç»™å®šå€¼å¹¶è¿”å›æ—§å€¼ã€‚ public final int getAndSet(int newValue) { return unsafe.getAndSetInt(this, valueOffset, newValue); } //ä»¥ä¸‹æ˜¯getAndSetIntæºç ï¼Œé€šè¿‡whileå¾ªç¯é‡è¯•æ›´æ–°å€¼ï¼Œç›´åˆ°æˆåŠŸï¼Œä¹Ÿæ˜¯é€šè¿‡CASå®ç°(JDK8ç‰ˆæœ¬) /*public final int getAndSetInt(Object var1, long var2, int var4) { int var5; do { var5 = this.getIntVolatile(var1, var2); } while(!this.compareAndSwapInt(var1, var2, var5, var4)); return var5; }*/ //åŸå­æ›´æ–°valueï¼Œå¦‚æœå½“å‰å€¼ç­‰äºexpectï¼Œåˆ™è®¾ç½®ä¸ºupdate public final boolean compareAndSet(int expect, int update) { return unsafe.compareAndSwapInt(this, valueOffset, expect, update); } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼å¢åŠ ä¸€ //è¿”å›æ—§å€¼ï¼Œåº•å±‚åŒgetAndSetIntä¸€æ ·ä½¿ç”¨CASæ“ä½œ public final int getAndIncrement() { return unsafe.getAndAddInt(this, valueOffset, 1); } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼å‡ä¸€ //è¿”å›æ—§å€¼ï¼ŒCASæ“ä½œ public final int getAndDecrement() { return unsafe.getAndAddInt(this, valueOffset, -1); } //ä»¥åŸå­æ–¹å¼å°†ç»™å®šå€¼deltaæ·»åŠ åˆ°å½“å‰å€¼ //è¿”å›æ—§å€¼ï¼ŒCASæ“ä½œ public final int getAndAdd(int delta) { return unsafe.getAndAddInt(this, valueOffset, delta); } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ 1ï¼Œè¿”å›æ–°å€¼ public final int incrementAndGet() { return unsafe.getAndAddInt(this, valueOffset, 1) + 1; } //å½“å‰å€¼å‡1ï¼Œè¿”å›æ–°å€¼ public final int decrementAndGet() { return unsafe.getAndAddInt(this, valueOffset, -1) - 1; } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼å¢åŠ deltaï¼Œè¿”å›æ–°å€¼ public final int addAndGet(int delta) { return unsafe.getAndAddInt(this, valueOffset, delta) + delta; } //ä½¿ç”¨ç»™å®šå‡½æ•°çš„ç»“æœä»¥åŸå­æ–¹å¼æ›´æ–°å½“å‰å€¼ï¼Œè¿”å›æ›´æ–°åçš„å€¼ã€‚ç»™çš„å‡½æ•°æ˜¯æ— å‰¯ä½œç”¨çš„ï¼Œå› ä¸ºå½“å°è¯•æ›´æ–°ç”±äºçº¿ç¨‹ä¹‹é—´çš„äº‰ç”¨è€Œå¤±è´¥æ—¶ï¼Œå®ƒå¯èƒ½ä¼šé‡æ–°åº”ç”¨ public final int updateAndGet(IntUnaryOperator updateFunction) { int prev, next; do { prev = get(); next = updateFunction.applyAsInt(prev); } while (!compareAndSet(prev, next)); return next; } //åŒä¸Šï¼Œä½¿ç”¨ç»™å®šå‡½æ•°çš„ç»“æœä»¥åŸå­æ–¹å¼æ›´æ–°å½“å‰å€¼ï¼Œè¿”å›æ›´æ–°å‰çš„å€¼ã€‚åº”ç”¨è¯¥å‡½æ•°æ—¶ï¼Œå°†å½“å‰å€¼ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¹¶å°†ç»™å®šçš„updateä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚ public final int getAndAccumulate(int x, IntBinaryOperator accumulatorFunction) { int prev, next; do { prev = get(); next = accumulatorFunction.applyAsInt(prev, x); } while (!compareAndSet(prev, next)); return prev; } //åŒgetAndAccumulateï¼Œä½†è¿”å›æ›´æ–°åçš„å€¼ public final int accumulateAndGet(int x, IntBinaryOperator accumulatorFunction) { int prev, next; do { prev = get(); next = accumulatorFunction.applyAsInt(prev, x); } while (!compareAndSet(prev, next)); return next; }} ä½¿ç”¨æ¼”ç¤ºï¼š 123456789101112131415161718192021222324252627public class UseAtomicInt { static AtomicInteger atomicInteger = new AtomicInteger(10); public static void main(String[] args) { //è¿”å›æ—§å€¼10 System.out.println(atomicInteger.getAndIncrement()); //è¿”å›æ–°å€¼12 System.out.println(atomicInteger.incrementAndGet()); atomicInteger.compareAndSet(12,1); //åŠ 24 è¿”å›25 System.out.println(atomicInteger.addAndGet(24)); //è‡ªå®šä¹‰å‡½æ•° IntBinarOperImpl intBinarOper=new IntBinarOperImpl(); //ä¼ å…¥è‡ªå®šä¹‰å‡½æ•°ï¼Œä¼ å…¥æ›´æ–°å€¼ atomicInteger.accumulateAndGet(1, intBinarOper); //è¿”å›26 System.out.println(atomicInteger.get()); }}//è‡ªå®šä¹‰å‡½æ•°ï¼Œå®ç°IntBinaryOperatoræ¥å£public class IntBinarOperImpl implements IntBinaryOperator { @Override public int applyAsInt(int left, int right) { //ç®€å•å®šä¹‰åŸæ¥çš„æ•°åŠ ä¸Šè¦æ›´æ–°çš„æ•° return left+right; }} 5.3 AtomicIntegerArrayæ˜¯æä¾›åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æ•´å‹ï¼Œè¿˜åŒ…æ‹¬é«˜çº§åŸå­æ“ä½œã€‚å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384public class AtomicIntegerArray implements java.io.Serializable { private static final long serialVersionUID = 2862133569453604235L; //åŒä¸Š private static final Unsafe unsafe = Unsafe.getUnsafe(); //è·å–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€ private static final int base = unsafe.arrayBaseOffset(int[].class); //å­˜å‚¨ç§»ä½ä¸ªæ•° private static final int shift; //ä¿å­˜çš„æ•°ç»„ private final int[] array; static { //è·å–è¯¥ç±»å‹çš„æ•°ç»„ä¸­å…ƒç´ çš„å¤§å°(å­—èŠ‚)ã€‚ int scale = unsafe.arrayIndexScale(int[].class); //scaleå¦‚æœä¸æ˜¯2çš„æ¬¡å¹‚åˆ™æŠ›å‡ºå¼‚å¸¸ if ((scale &amp; (scale - 1)) != 0) throw new Error(\"data type scale not a power of two\"); //è®¡ç®—å¾—åˆ°éœ€è¦ç§»ä½çš„ä¸ªæ•°ï¼Œå³scaleçš„æ¬¡å¹‚æ•° shift = 31 - Integer.numberOfLeadingZeros(scale); } //è¿”å›ç¬¬iä¸ªå…ƒç´ çš„åœ°å€ private static long byteOffset(int i) { //shiftä¸ºåç§»ä½æ•°ï¼Œbaseä¸ºç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ï¼Œiç§»shiftä¸ªä½å+åŸºä½ç½®å¾—åˆ°ç¬¬iä¸ªå…ƒç´ ä½ç½® return ((long) i &lt;&lt; shift) + base; } //å…ˆæ£€æµ‹iæ˜¯å¦è¶Šç•Œï¼Œå†è°ƒç”¨byteOffset(i)è¿”å› private long checkedByteOffset(int i) { if (i &lt; 0 || i &gt;= array.length) throw new IndexOutOfBoundsException(\"index \" + i); return byteOffset(i); } //æ„é€ åˆå§‹åŒ–ç»™å®šé•¿åº¦æ•°ç»„ public AtomicIntegerArray(int length) { array = new int[length]; } //åˆ›å»ºä¸€ä¸ªæ–°AtomicIntegerArrayï¼Œå…¶é•¿åº¦ä¸ä¼ å…¥æ•°ç»„ç›¸åŒï¼Œå¹¶ä»ç»™å®šæ•°ç»„ä¸­å¤åˆ¶æ‰€æœ‰å…ƒç´ ã€‚æ‰€ä»¥å½“ AtomicIntegerArray å¯¹å†…éƒ¨çš„æ•°ç»„å…ƒç´ è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¸ä¼šå½±å“ä¼ å…¥çš„æ•°ç»„ã€‚ public AtomicIntegerArray(int[] array) { this.array = array.clone(); } //è¿”å›å½“å‰ä½ç½®çš„å…ƒç´  public final int get(int i) { //è°ƒç”¨checkedByteOffsetè·å–å½“å‰ä½ç½®çš„å…ƒç´ åœ°å€ return getRaw(checkedByteOffset(i)); } //getIntVolatileæ–¹æ³•è·å–æ•°ç»„ä¸­offsetåç§»åœ°å€å¯¹åº”çš„æ•´å‹fieldçš„å€¼,æ”¯æŒvolatile loadè¯­ä¹‰ã€‚è¿”å›è¯¥å€¼ã€‚ private int getRaw(long offset) { return unsafe.getIntVolatile(array, offset); } //æ›´æ–°ç¬¬iä¸ªä½ç½®çš„å€¼ï¼Œä¹Ÿéœ€å…ˆè®¡ç®—å½“å‰ä½ç½®çš„å…ƒç´ çš„offset public final void set(int i, int newValue) { unsafe.putIntVolatile(array, checkedByteOffset(i), newValue); } //åŒAtomicIntegerçš„lazySet,è¿™é‡Œæ›´æ–°ç¬¬iä¸ªä½ç½®çš„å…ƒç´  public final void lazySet(int i, int newValue) { unsafe.putOrderedInt(array, checkedByteOffset(i), newValue); } public final int getAndSet(int i, int newValue) { return unsafe.getAndSetInt(array, checkedByteOffset(i), newValue); } //å¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†æ•°ç»„ä½ç½® i çš„å…ƒç´ è®¾ç½®æˆ update å€¼ã€‚ public final boolean compareAndSet(int i, int expect, int update) { return compareAndSetRaw(checkedByteOffset(i), expect, update); } private boolean compareAndSetRaw(long offset, int expect, int update) { return unsafe.compareAndSwapInt(array, offset, expect, update); } //åŸå­çš„æ–¹å¼è®©ç¬¬iä¸ªå…ƒç´ åŠ 1 public final int getAndIncrement(int i) { return getAndAdd(i, 1); } //åŸå­çš„æ–¹å¼è®©ç¬¬iä¸ªå…ƒç´ å‡1 public final int getAndDecrement(int i) { return getAndAdd(i, -1); } //åŸå­çš„æ–¹å¼è®©ç¬¬iä¸ªå…ƒç´ åŠ delta public final int getAndAdd(int i, int delta) { return unsafe.getAndAddInt(array, checkedByteOffset(i), delta); } //è¿˜æœ‰å…¶ä»–ä¸€äº›æ–¹æ³•éƒ½å’ŒIntegeråŸå­ç±»åŸºæœ¬ä¸€æ · ç®€å•ä½¿ç”¨ï¼š 123456789101112131415161718192021public class AtomicArray { static int[] value = new int[] { 1, 2,3 }; static AtomicIntegerArray atomicIntegerArray = new AtomicIntegerArray(value); public static void main(String[] args) { //è¿”å›ç¬¬ä¸€ä¸ªä½ç½®çš„å…ƒç´  2 System.out.println(atomicIntegerArray.get(1)); //æ›´æ–°ç¬¬1ä¸ªä½ç½®çš„å…ƒç´  atomicIntegerArray.set(1,4); //è¿”å›4 System.out.println(atomicIntegerArray.get(1)); //è®¾ç½®ç¬¬0ä¸ªä½ç½®ä¸º3ï¼Œè¿”å›æ›´æ–°å‰çš„å€¼ 1 System.out.println( atomicIntegerArray.getAndSet(0, 3)); //è¿”å›æ›´æ–°åçš„3 System.out.println(atomicIntegerArray.get(0)); //è¿”å›1ï¼ŒåŸæ•°ç»„ä¸ä¼šå˜åŒ– System.out.println(value[0]); atomicIntegerArray.compareAndSet(0,3,4); System.out.println(atomicIntegerArray.get(0)); }} 5.4 æ›´æ–°å¼•ç”¨ç±»å‹åŸå­æ›´æ–°åŸºæœ¬ç±»å‹çš„ AtomicIntegerï¼Œåªèƒ½æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœè¦åŸå­æ›´æ–°å¤šä¸ªå˜é‡ï¼Œå°±éœ€è¦ä½¿ç”¨è¿™ä¸ªåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æä¾›çš„ç±»ã€‚Atomic åŒ…æä¾›äº†ä»¥ä¸‹ 3ç±»ã€‚AtomicReferenceï¼ŒAtomicStampedReferenceï¼ŒAtomicMarkableReference 5.5 AtomicReferenceæ–¹æ³•åŒå‰é¢å‡ ä¸ªç±»åŸºæœ¬ä¸€æ ·ï¼Œä½†æ”¯æŒæ³›å‹ï¼Œå¯ä¼ å…¥å¯¹è±¡,æ”¯æŒå¯¹å¯¹è±¡çš„åŸå­æ“ä½œã€‚ 5.6 AtomicStampedReferenceå’ŒAtomicMarkableReferenceAtomicStampedReference ä½¿ç”¨ç‰ˆæœ¬æˆ³çš„è®°å½•æ¯æ¬¡æ”¹å˜åçš„ç‰ˆæœ¬å·ï¼Œè¿™æ ·çš„è¯å°±ä¸ä¼šå­˜åœ¨ ABAé—®é¢˜äº†ã€‚AtomicMarkableReferenceè·Ÿ AtomicStampedReference åŸºæœ¬ç›¸åŒï¼ŒAtomicStampedReference åœ¨Pairç±» ä¸­ä½¿ç”¨ intç±»å‹çš„stamp ä½œä¸ºè®¡æ•°å™¨ï¼Œæ¯æ¬¡æ“ä½œéƒ½æ›´æ–°ç‰ˆæœ¬ï¼Œå…³æ³¨çš„çš„æ˜¯åŠ¨è¿‡å‡ æ¬¡ã€‚AtomicMarkableReference åœ¨ Pairç±» ä½¿ç”¨çš„æ˜¯ boolean ç±»å‹çš„markï¼Œå…³æ³¨çš„çš„æ˜¯æœ‰æ²¡æœ‰è¢«åŠ¨è¿‡ã€‚ AtomicStampedReferenceæºç å¦‚ä¸‹ï¼š é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªPairå†…éƒ¨ç±»ï¼š 1234567891011private static class Pair&lt;T&gt; { final T reference; final int stamp; private Pair(T reference, int stamp) { this.reference = reference; this.stamp = stamp; } static &lt;T&gt; Pair&lt;T&gt; of(T reference, int stamp) { return new Pair&lt;T&gt;(reference, stamp); } } è¯¥ç±»å°†å…ƒç´ çš„å€¼(reference)å’Œç‰ˆæœ¬å·(stamp)éƒ½ç»´æŠ¤åœ¨è‡ªå·±èº«ä¸Šã€‚ æˆå‘˜å˜é‡ 12345678910111213141516171819//å£°æ˜Pairç±»å‹å˜é‡private volatile Pair&lt;V&gt; pair;//è·å–Unsafeprivate static final sun.misc.Unsafe UNSAFE = sun.misc.Unsafe.getUnsafe();//ä½¿ç”¨unsafeè·å–åç§»é‡ä¿å­˜åˆ°pairOffsetprivate static final long pairOffset = objectFieldOffset(UNSAFE, \"pair\", AtomicStampedReference.class); static long objectFieldOffset(sun.misc.Unsafe UNSAFE, String field, Class&lt;?&gt; klazz) { try { return UNSAFE.objectFieldOffset(klazz.getDeclaredField(field)); } catch (NoSuchFieldException e) { // Convert Exception to corresponding Error NoSuchFieldError error = new NoSuchFieldError(field); error.initCause(e); throw error; //åé¢ä¸¤ä¸ªæ”¾åœ¨æºç çš„æœ€åï¼Œä¸å¤ªå¥½æ‰¾ æ„é€ æ–¹æ³• 123public AtomicStampedReference(V initialRef, int initialStamp) { pair = Pair.of(initialRef, initialStamp); } ä¼ å…¥åˆå§‹å€¼å’Œåˆå€¼ç‰ˆæœ¬æˆ³ä¿å­˜åˆ°pairã€‚ æ–¹æ³• 4.1. getReference()å’ŒgetStamp()ï¼šè¿”å›å…ƒç´ å€¼å’Œè¿”å›ç‰ˆæœ¬æˆ³ 123456public V getReference() { return pair.reference; } public int getStamp() { return pair.stamp; } 4.2 get() 123456//è¿”å›å½“å‰å…ƒç´ çš„å€¼ï¼Œå¹¶å°†å½“å‰å…ƒç´ çš„ç‰ˆæœ¬å·ä¿å­˜åˆ°ä¼ å…¥çš„æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®public V get(int[] stampHolder) { Pair&lt;V&gt; pair = this.pair; stampHolder[0] = pair.stamp; return pair.reference; } 4.3 casPair() 12345//cmp:æœŸæœ›çš„pair,valï¼šæ–°çš„pair//CASæ›´æ–°å½“å‰çš„pairprivate boolean casPair(Pair&lt;V&gt; cmp, Pair&lt;V&gt; val) { return UNSAFE.compareAndSwapObject(this, pairOffset, cmp, val); } 4.4 compareAndSet() è¯¥æ–¹æ³•é¦–å…ˆåˆ¤æ–­æœŸæœ›çš„å€¼å’Œç‰ˆæœ¬æˆ³æ˜¯å¦å’Œå½“å‰çš„å€¼å’Œç‰ˆæœ¬æˆ³ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒåˆ™ç›´æ¥è¿”å›falseï¼Œå¦‚æœç›¸åŒåˆ™ç»§ç»­æ¯”è¾ƒæ–°çš„å€¼å’Œç‰ˆæœ¬æˆ³æ˜¯å¦å’Œå½“å‰å€¼ç›¸åŒï¼Œå¦‚æœç›¸åŒåˆ™ç›´æ¥è¿”å›trueï¼Œå¦åˆ™å¯¹å½“å‰çš„pairè¿›è¡ŒCASæ“ä½œã€‚ 12345678910111213141516171819/** * åŸå­çš„ä¿®æ”¹å…ƒç´ çš„å€¼å’Œç‰ˆæœ¬æˆ³ * @param æœŸæœ›å€¼ * @param æ–°å€¼ * @param æœŸæœ›ç‰ˆæœ¬æˆ³ * @param æ–°ç‰ˆæœ¬æˆ³ */ public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) { Pair&lt;V&gt; current = pair; return expectedReference == current.reference &amp;&amp; expectedStamp == current.stamp &amp;&amp; ((newReference == current.reference &amp;&amp; newStamp == current.stamp) || casPair(current, Pair.of(newReference, newStamp))); } 4.5 weakCompareAndSet() å…¶ä»£ç åŒcompareAndSetæ— å·®åˆ«ï¼Œä½†åœ¨JDK9ä¸­ï¼Œä¸¤ä¸ªæ–¹æ³•éƒ½æ·»åŠ äº†@HotSpotIntrinsicCandidateæ³¨è§£ï¼Œä½¿ç”¨è¯¥æ³¨è§£çš„æ–¹æ³•åœ¨JVMä¸­éƒ½æœ‰ä¸€å¥—åŸºäºCPUæŒ‡ä»¤çš„é«˜æ•ˆçš„å®ç°ï¼Œä¸”ä¼šåœ¨è¿è¡Œæ—¶ä¼šæ›¿ä»£JDKçš„æºç å®ç°ï¼Œä»è€Œè·å¾—æ›´é«˜çš„æ•ˆç‡ã€‚å³HotSpotå¯èƒ½ä¼šæ‰‹åŠ¨å®ç°è¿™ä¸ªæ–¹æ³•ã€‚å‚è€ƒï¼šhttps://blog.csdn.net/lzcaqde/article/details/80868854çš„è§£è¯»ã€‚ 12345678// åŒcompareAndSetï¼Œä½†å¯èƒ½ä¸èƒ½ä¿è¯åŸå­æ€§public boolean weakCompareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) { return compareAndSet(expectedReference, newReference, expectedStamp, newStamp); } 4.6 set() 12345678910/** * æºç è§£é‡Šæ— æ¡ä»¶æ›´æ–°å½“å‰å…ƒç´ çš„å€¼å’Œç‰ˆæœ¬æˆ³ * @param newReference æ–°å€¼ * @param newStamp æ–°ç‰ˆæœ¬æˆ³ */public void set(V newReference, int newStamp) { Pair&lt;V&gt; current = pair; if (newReference != current.reference || newStamp != current.stamp) this.pair = Pair.of(newReference, newStamp); } 4.7 attemptStamp() å¦‚æœå¼•ç”¨å¯¹è±¡ä¸ºæœŸæœ›å€¼ï¼Œåˆ™é‡æ–°è®¾ç½®æ–°çš„ç‰ˆæœ¬æˆ³ã€‚ 1234567public boolean attemptStamp(V expectedReference, int newStamp) { Pair&lt;V&gt; current = pair; return expectedReference == current.reference &amp;&amp; (newStamp == current.stamp || casPair(current, Pair.of(expectedReference, newStamp))); } ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class UseAtomicStampedReference { /** * è®¾ç½®åˆå§‹å€¼å’Œåˆå§‹ç‰ˆæœ¬æˆ³ */ static AtomicStampedReference&lt;String&gt; asr = new AtomicStampedReference(\"wml\",0); public static void main(String[] args) throws InterruptedException { //æ‹¿åˆ°å½“å‰çš„ç‰ˆæœ¬å·(æ—§) final int oldStamp = asr.getStamp(); final String oldReference = asr.getReference(); System.out.println(\"æ—§å€¼ï¼š\"+oldReference+\"ï¼Œæ—§ç‰ˆæœ¬æˆ³ï¼š\"+oldStamp); Thread rightStampThread = new Thread(() -&gt; { System.out.println(Thread.currentThread().getName()+\":å½“å‰å˜é‡å€¼ï¼š\" +oldReference + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + oldStamp ); //æ›´æ–°å¼•ç”¨å¯¹è±¡å€¼å’Œç‰ˆæœ¬æˆ³ asr.compareAndSet(oldReference, \"wml222\", oldStamp, oldStamp + 1); int[] stampHolder=new int[2]; stampHolder[0]=0; //è°ƒç”¨getï¼Œè¿”å›å½“å‰å€¼ï¼Œå¹¶å°†ç‰ˆæœ¬ä¿å­˜åˆ°stampHolder[0]ä¸­ asr.get(stampHolder); //æ‰“å°å½“å‰ç‰ˆæœ¬ System.out.println(\"ä½¿ç”¨get()è·å–ç‰ˆæœ¬ï¼š\"+stampHolder[0]); }); Thread errorStampThread = new Thread(() -&gt; { String reference = asr.getReference(); System.out.println(Thread.currentThread().getName()+\":å½“å‰å˜é‡å€¼ï¼š\" +reference + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + asr.getStamp()); //æ›´æ–°å¼•ç”¨å¯¹è±¡å€¼å’Œç‰ˆæœ¬æˆ³ asr.compareAndSet(reference, \"wml333\", oldStamp, oldStamp + 1); }); rightStampThread.start(); rightStampThread.join(); errorStampThread.start(); errorStampThread.join(); System.out.println(\"Mainçº¿ç¨‹:å½“å‰å˜é‡å€¼ï¼š\" +asr.getReference() + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + asr.getStamp()); asr.set(\"setæ–°å€¼\",3); System.out.println(\"ä½¿ç”¨setæ›´æ–°:å½“å‰å˜é‡å€¼ï¼š\" +asr.getReference() + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + asr.getStamp()); }} çº¿ç¨‹errorStampThreadæ²¡æœ‰ä½¿ç”¨æ›´æ–°åçš„ç‰ˆæœ¬æˆ³ä½œä¸ºæœŸæœ›ç‰ˆæœ¬ï¼Œå› æ­¤è¯¥çº¿ç¨‹CASå¤±è´¥ã€‚ 5.7 åŸå­æ›´æ–°å­—æ®µç±»atomicåŒ…æä¾›äº†AtomicIntegerFieldUpdaterï¼ŒAtomicLongFieldUpdaterï¼ŒAtomicReferenceFieldUpdaterä¸‰ä¸ªç±»å®ç°åŸå­çš„æ›´æ–°æŸä¸ªç±»çš„æŸä¸ªå­—æ®µã€‚ä»¥AtomicReferenceFieldUpdaterä¸ºä¾‹ï¼šæ›´æ–°å­—æ®µç±»éœ€è¦ä¸¤æ­¥ï¼š1.ç”±äºåŸå­æ›´æ–°å­—æ®µç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ¯æ¬¡å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”ä¼ å…¥è¦æ›´æ–°çš„ç±»ï¼Œå­—æ®µç±»å‹å’Œå­—æ®µåã€‚2.æ›´æ–°ç±»çš„å­—æ®µï¼ˆå±æ€§ï¼‰å¿…é¡»ä½¿ç”¨ public volatileä¿®é¥°ç¬¦ã€‚å…¶ä»–æ³¨æ„ç‚¹ï¼š1.å˜é‡ä¸å¯ä½¿ç”¨staticã€finalå…³é”®å­—ã€‚2.å˜é‡çš„æè¿°ç¬¦ç±»å‹å¿…é¡»ä¸è°ƒç”¨è€…ä¸€è‡´ã€‚å¦åˆ™è°ƒç”¨è€…ä¸èƒ½è°ƒç”¨å˜é‡ä¹Ÿå°±ä¸èƒ½é€šè¿‡åå°„æ“ä½œä¿è¯åŸå­æ€§ã€‚ æ¯ä¸ªæ›´æ–°å­—æ®µç±»éƒ½æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªAtomicXXXXFieldUpdaterImplå®ç°ç±»ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485 private static final class AtomicReferenceFieldUpdaterImpl&lt;T,V&gt; extends AtomicReferenceFieldUpdater&lt;T,V&gt; { // è·å–Unsafe private static final sun.misc.Unsafe U = sun.misc.Unsafe.getUnsafe(); // å½“å‰å˜é‡çš„å†…å­˜åç§»é‡ private final long offset; // å¦‚æœè¦æ“ä½œçš„ç±»çš„å­—æ®µè¢«protectedä¿®é¥°ï¼Œåˆ™cclassä¸ºè°ƒç”¨è€…ç±»çš„classå¯¹è±¡ï¼Œå¦åˆ™cclassä¸ºtclassã€‚ private final Class&lt;?&gt; cclass; // è¦æ“ä½œçš„ç±»çš„classå¯¹è±¡ private final Class&lt;T&gt; tclass; // è¦æ“ä½œçš„ç±»å­—æ®µçš„classå¯¹è±¡ private final Class&lt;V&gt; vclass; /** * @param tclass å³ä¸Šé¢çš„tclass * @param vclass è¦æ“ä½œçš„ç±»å­—æ®µçš„classå¯¹è±¡ * @param fieldName è¢«æ“ä½œçš„å­—æ®µå * @param caller è°ƒç”¨è€…ç±»çš„classå¯¹è±¡ */ AtomicReferenceFieldUpdaterImpl(final Class&lt;T&gt; tclass, final Class&lt;V&gt; vclass, final String fieldName, final Class&lt;?&gt; caller) { //åŸå­æ›´æ–°çš„å­—æ®µ final Field field; //åŸå­æ›´æ–°å­—æ®µçš„classå¯¹è±¡ final Class&lt;?&gt; fieldClass; //åŸå­æ›´æ–°å­—æ®µçš„ä¿®é¥°ç¬¦ final int modifiers; try { //åˆ©ç”¨åå°„æœºåˆ¶è·å–tclassçš„field field = AccessController.doPrivileged( new PrivilegedExceptionAction&lt;Field&gt;() { public Field run() throws NoSuchFieldException { return tclass.getDeclaredField(fieldName); } }); //è·å–è¯¥å­—æ®µçš„ä¿®é¥°ç¬¦ modifiers = field.getModifiers(); //æ£€æŸ¥è¯¥å­—æ®µçš„è®¿é—®æƒé™ï¼Œæ— æ³•è®¿é—®åˆ™æŠ›å‡ºå¯¹åº”å¼‚å¸¸ä¿¡æ¯ sun.reflect.misc.ReflectUtil.ensureMemberAccess( caller, tclass, null, modifiers); //è·å–å¯¹åº”classçš„ç±»åŠ è½½å™¨ ClassLoader cl = tclass.getClassLoader(); ClassLoader ccl = caller.getClassLoader(); if ((ccl != null) &amp;&amp; (ccl != cl) &amp;&amp; ((cl == null) || !isAncestor(cl, ccl))) { sun.reflect.misc.ReflectUtil.checkPackageAccess(tclass); } fieldClass = field.getType(); } catch (PrivilegedActionException pae) { throw new RuntimeException(pae.getException()); } catch (Exception ex) { throw new RuntimeException(ex); } if (vclass != fieldClass) throw new ClassCastException(); if (vclass.isPrimitive()) throw new IllegalArgumentException(\"Must be reference type\"); if (!Modifier.isVolatile(modifiers)) throw new IllegalArgumentException(\"Must be volatile type\"); //é¦–å…ˆåˆ¤æ–­å­—æ®µä¿®é¥°ç¬¦æ˜¯å¦ä¸ºprotected // å†åˆ¤æ–­tclasså’Œcalleræ˜¯å¦ç›¸åŒæˆ–è€…æ˜¯å¦ä¸€ä¸ªç±»çš„å­ç±» this.cclass = (Modifier.isProtected(modifiers) &amp;&amp; tclass.isAssignableFrom(caller) &amp;&amp; !isSamePackage(tclass, caller)) ? caller : tclass; this.tclass = tclass; this.vclass = vclass; this.offset = U.objectFieldOffset(field); } //å¦‚æœå¯ä»¥åœ¨ç¬¬ä¸€ä¸ªç±»åŠ è½½å™¨çš„å§”æ‰˜é“¾ä¸­æ‰¾åˆ°ç¬¬äºŒä¸ªç±»åŠ è½½å™¨ï¼Œåˆ™è¿”å›true private static boolean isAncestor(ClassLoader first, ClassLoader second) { ClassLoader acl = first; do { acl = acl.getParent(); if (second == acl) { return true; } } while (acl != null); return false; } åŸå­æ›´æ–°ç±»çš„æ–¹æ³•åŒatomicåŒ…ä¸‹çš„å…¶ä»–ç±»åŸºæœ¬ç›¸åŒï¼Œä½†æ˜¯è¯¥ç±»åœ¨è¿›è¡ŒCASå‰ï¼Œéœ€è¦å…ˆè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå¦‚ä¸‹ï¼š 123456789101112131415//æ£€æŸ¥ç›®æ ‡å‚æ•°æ˜¯å¦æ˜¯ç±»çš„å®ä¾‹ã€‚å¤±è´¥æ—¶ï¼ŒæŠ›å‡ºåŸå› ã€‚ private final void accessCheck(T obj) { if (!cclass.isInstance(obj)) throwAccessCheckException(obj);}//æ£€æŸ¥ç›®æ ‡å‚æ•°æ˜¯å¦æ˜¯å¯¹åº”å­—æ®µçš„ç±»å‹ï¼Œå¦‚æœä¸æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸private final void valueCheck(V v) { if (v != null &amp;&amp; !(vclass.isInstance(v))) throwCCE(); } public final boolean compareAndSet(T obj, V expect, V update) { accessCheck(obj); valueCheck(update); return U.compareAndSwapObject(obj, offset, expect, update);} ä½¿ç”¨ç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class AtomicReferenceFieldUpdaterDemo { /** * å®šä¹‰AtomicReferenceFieldUpdaterï¼Œä¼ å…¥è¦æ“ä½œçš„ç±»Userï¼Œä»¥åŠåŸå­æ“ä½œçš„å­—æ®µageçš„classå¯¹è±¡Integer.classå’Œå­—æ®µåageï¼Œè¿™é‡Œå­—æ®µå¿…é¡»ä¸ºå¼•ç”¨ç±»å‹ï¼Œå¦‚æœæ˜¯intç±»å‹çš„åˆ™éœ€ä½¿ç”¨ */ static AtomicReferenceFieldUpdater arf = AtomicReferenceFieldUpdater.newUpdater(User.class, Integer.class, \"age\"); /** * å®šä¹‰AtomicIntegerFieldUpdaterï¼Œä¼ å…¥è¦æ“ä½œçš„ç±»Userï¼Œä»¥åŠåŸå­æ“ä½œçš„å­—æ®µågrade */ static AtomicIntegerFieldUpdater aif=AtomicIntegerFieldUpdater.newUpdater(User.class,\"grade\"); public static void main(String[] args) throws InterruptedException { User user = new User(); user.age=19; user.grade=0; //CASä¿®æ”¹ä¸º20 arf.compareAndSet(user, 19, 20); //è¾“å‡º20 System.out.println(arf.get(user)); //ä¿®æ”¹ä¸º21ï¼Œè¿”å›ä¿®æ”¹å‰çš„ 20 System.out.println(arf.getAndSet(user,21)); //ä¿®æ”¹åä¸º21 System.out.println(user.age); ThreadPoolExecutor poolExecutor = new ThreadPoolExecutor(500, 1000, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingDeque()); //å¼€500ä¸ªçº¿ç¨‹å¢åŠ gradeå­—æ®µ for (int i = 0; i &lt; 500; i++) { poolExecutor.execute(()-&gt;{ aif.incrementAndGet(user); }); } poolExecutor.shutdown(); Thread.sleep(2000L); System.out.println(\"å¢åŠ åçš„gradeä¸º:\"+aif.get(user)); aif.compareAndSet(user,500,1000); System.out.println(\"ä¿®æ”¹åçš„gradeä¸º\"+aif.get(user)); }}class User { protected volatile Integer age; protected volatile int grade;} ç»“æœï¼š 12345202021å¢åŠ åçš„gradeä¸º:500ä¿®æ”¹åçš„gradeä¸º1000 å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/65240318","link":"/posts/20200130-atomicClass.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹æ˜¾ç¤ºé”Lockã€Conditionæ¥å£ã€LockSupportä»¥åŠAQSï¼ˆåŒæ­¥é˜Ÿåˆ—ã€æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼‰è¯¦è§£","text":"ä¸€ã€æ˜¾å¼é”synchronizedå…³é”®å­—æ˜¯javaå†…ç½®çš„è¯­è¨€ç‰¹æ€§ï¼Œä½¿ç”¨synchronizedå…³é”®å­—ä¼šéšå¼çš„è·å–é”ï¼Œåœ¨è·å–é”çš„çº¿ç¨‹æ‰§è¡Œæ‰§è¡Œå®Œä»»åŠ¡æˆ–æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚ä½†ä¸ºä»€ä¹ˆè¿˜éœ€è¦Lockå‘¢ï¼Ÿ å¦‚ï¼Œç›®å‰ç»å¤§å¤šæ•°çš„ä¸šåŠ¡åœºæ™¯åŸºæœ¬éƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œå¦‚è¯»å†™æ¯”ä¾‹ä¸º10:1ï¼Œå€˜è‹¥ä½¿ç”¨synchronizedï¼Œè‹¥æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œåˆ™å› ä¸ºå…¶çš„ç‹¬å æ€§ï¼Œå…¶ä»–çš„çº¿ç¨‹éƒ½åªèƒ½ç­‰å¾…ï¼Œé€ æˆå¤§é‡çš„èµ„æºæµªè´¹ï¼Œä½†Lockçš„å®ç°ç±»ReentrantReadWriteLockè¯»å†™é”ä¾¿å¯ä»¥å®Œç¾çš„è§£å†³è¿™ä¸€é—®é¢˜ã€‚ åˆå¦‚ï¼Œsynchronizedæ— æ³•è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè€Œå¦‚æœè·å–è¯¥é”çš„çº¿ç¨‹å› ä¸ºI/Oè¯·æ±‚æˆ–æ˜¯å…¶ä»–åŸå› å¯¼è‡´ä¸€ç›´æ— æ³•é‡Šæ”¾é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹ä¾¿ä¼šè¿›å…¥â€œæ— é™ç­‰å¾…â€çš„çŠ¶æ€ï¼Œè€ŒLockè·å–é”æ—¶å¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨æˆªæ­¢æ—¶é—´ä¹‹åä»æœªè·å–åˆ°é”ï¼Œåˆ™è¿”å›ã€‚ ä½†ä¸ªäººè®¤ä¸ºå¦‚æœä¸ä½¿ç”¨lock.trylockæˆ–è€…lockInterruptbly()ä¸­æ–­è·å–é”çš„çº¿ç¨‹ç­‰ï¼Œå°½é‡ä½¿ç”¨synchronizedå…³é”®å­—ï¼Œsynchronizedå› ä¸ºæ˜¯ä¸€ä¸ªè¯­è¨€ç‰¹æ€§ï¼Œè€ŒLockæ˜¯ä¸€ä¸ªç±»ï¼Œä½¿ç”¨å°±éœ€è¦åˆ›å»ºå¯¹è±¡å®ä¾‹å¿…ç„¶ä¼šæ¯”synchronizedæœ‰æ‰€æ¶ˆè€—ï¼Œjdkå¯¹synchronizedä¹Ÿè¿›è¡Œäº†è®¸å¤šä¼˜åŒ–ã€‚ äºŒã€Lockå…ˆçœ‹lockçš„æ ‡å‡†ç”¨æ³•ï¼š 123456789101112private Lock lock = new ReentrantLock();private int num= 1; .............public void test() { lock.lock(); //å¦‚æœä¸­é—´æŠ›äº†ä¸ªå¼‚å¸¸ï¼Œunlockå°±ä¸ä¼šæ‰§è¡Œï¼Œå› æ­¤é‡Šæ”¾é”å¿…é¡»æ”¾åœ¨finallyä¸­ try{ age++; }finally { lock.unlock(); }} è¿™é‡Œä¸èƒ½å°†è·å–é”æ”¾åœ¨tryä¸­ï¼Œå› ä¸ºå¦‚æœæ”¾åœ¨tryä¸­ï¼Œå½“è·å–é”æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¿…ç„¶ä¼šæ‰§è¡Œunlock()é‡Šæ”¾é”ï¼Œè€Œé—®é¢˜æ˜¯å½“å‰å¹¶æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆå¿…ç„¶ä¼šå¯¼è‡´ç¨‹åºå¼‚å¸¸ã€‚ Lockçš„å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š lock() è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹ä¼šè·å–åˆ°é”ï¼Œå¦‚æœè·å–åˆ°é”ï¼Œä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ä¼šè¿›è¡Œç­‰å¾…ã€‚ void lockInterruptibly() throws InterruptedException;è¯¥æ–¹æ³•æ”¯æŒä¸­æ–­çš„è·å–é”ã€‚å³åœ¨è·å–é”æ—¶ï¼Œå¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™å½“å‰çº¿ç¨‹åªèƒ½è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œä½† æ˜¯å¯ä»¥è°ƒç”¨è¯¥çº¿ç¨‹çš„interrupt()æ–¹æ³•ä¸­æ–­å½“å‰çº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€ï¼Œåœæ­¢è·å–é”ã€‚ boolean tryLock() è¯¥æ–¹æ³•å®ç°éé˜»å¡çš„è·å–é”ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•ä¼šç«‹å³è¿”å›ï¼Œå¦‚æœè·å–åˆ°ï¼Œåˆ™è¿”å›trueï¼Œå¦‚æœæœªè·å–åˆ°åˆ™è¿”å›falseå®˜æ–¹ç»™å‡ºçš„èŒƒä¾‹å¦‚ä¸‹ï¼š 12345678910Lock lock = ...; if (lock.tryLock()) { try { //å¦‚æœè·å–åˆ°é”å°±å¤„ç†ç›¸å…³ä»»åŠ¡ } finally { lock.unlock(); } } else { //æœªè·å–åˆ°æ‰§è¡Œå…¶ä»–ä»»åŠ¡ }} boolean tryLock(long time, TimeUnit unit) throws InterruptedException;åŒ3ä¸€æ ·ï¼Œä½†å¢åŠ äº†è¶…æ—¶æ—¶é—´ã€‚å½“ï¼šï¼ˆ1ï¼‰å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è·å–åˆ°é”ï¼Œåˆ™ç›´æ¥è¿”å›trueï¼ˆ2ï¼‰å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼ˆ3ï¼‰å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…æœªè·å–åˆ°é”ï¼Œè¿”å›false void unlock();é‡Šæ”¾é”ã€‚ Condition newCondition(); è¿”å›ä¸€ä¸ªConditionå®ä¾‹ï¼Œè¯¥å®ä¾‹ä¸è°ƒç”¨å…¶çš„çš„é”ç»‘å®šï¼Œè°ƒç”¨åï¼Œå¯ä½¿ç”¨conditionçš„`await()`ã€`signal()`ç­‰æ–¹æ³•å¯¹è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹è¿›è¡Œç­‰å¾…å’Œå”¤é†’ï¼Œä¸€ä¸ªLockå¯¹è±¡å¯ä»¥ä½¿ç”¨å¤šä¸ª`Condition`ä¸‰ã€Conditionsynchronizedå…³é”®å­—å¯é€šè¿‡wait()ã€notify()å®ç°ç­‰å¾…-é€šçŸ¥çš„æ¨¡å¼ï¼Œè€ŒLockä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯å…¶æ˜¯å€ŸåŠ©Conditionæ¥å£å®ç°çš„ï¼Œé€šè¿‡Lock.newCondition()å°±å¯ä»¥çœ‹å‡ºã€‚ä¸synchronizedä¸åŒçš„æ˜¯ï¼Œä¸€ä¸ªLockå¯¹è±¡å¯ä»¥åˆ›å»ºå¤šä¸ªConditionå®ä¾‹ï¼Œå› æ­¤ï¼Œæ¯ä¸ªConditionå®ä¾‹å¯ä»¥ç»´æŠ¤å•ç‹¬çš„çº¿ç¨‹ï¼Œåœ¨è°ƒç”¨condition.await()å’Œsignal()æ—¶ï¼Œåªä¼šæ§åˆ¶æ³¨å†Œåœ¨è¯¥conditionå®ä¾‹ä¸Šçš„çº¿ç¨‹ï¼ŒsignalAll()ä¹Ÿä¸ä¼šåƒsynchronizedè°ƒç”¨notifyAll()ä¸€æ ·é€šçŸ¥æ‰€æœ‰é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œåªæ˜¯å”¤é†’æ‰€æœ‰æ³¨å†Œåœ¨è¯¥å®ä¾‹çš„çº¿ç¨‹ã€‚Conditionçš„å¸¸ç”¨æ–¹æ³•ï¼š void await() throws InterruptedException;ä¸æ­¤Conditionå…³è”çš„é”ä¼šè¢«åŸå­é‡Šæ”¾ï¼Œå¹¶ä¸”å‡ºäºçº¿ç¨‹è°ƒåº¦çš„ç›®çš„ï¼Œå½“å‰çº¿ç¨‹è¢«ç¦ç”¨ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹å››ç§æƒ…å†µä¹‹ä¸€ï¼š1.å…¶ä»–ä¸€äº›çº¿ç¨‹è°ƒç”¨æ­¤Conditionçš„signal()æˆ–signalAll()æ–¹æ³•ï¼Œè€Œå½“å‰çº¿ç¨‹æ°å¥½è¢«é€‰æ‹©ä¸ºè¦å”¤é†’çš„çº¿ç¨‹2.å…¶ä»–çº¿ç¨‹è°ƒç”¨interrupt() æ–¹æ³•ä¸­æ–­å½“å‰çº¿ç¨‹3.å‘ç”Ÿè™šå‡å”¤é†’å¦‚æœ å½“å‰çº¿ç¨‹è¢«å”¤é†’ï¼Œä»await()æ–¹æ³•è¿”å›ï¼Œåˆ™æ„å‘³ç€å½“å‰çº¿ç¨‹å·²ç»è·å–äº†è¯¥Conditionå¯¹è±¡ç»‘å®šçš„é”ã€‚ void awaitUninterruptibly(); åŒawait()ä¸€æ ·ï¼Œä½†æ˜¯ä¸å“åº”ä¸­æ–­ã€‚å³å¦‚æœå½“å‰çº¿ç¨‹è¿›å…¥æ­¤æ–¹æ³•æ—¶å·²è®¾ç½®å…¶ä¸­æ–­çŠ¶æ€ï¼Œæˆ–è€…åœ¨ç­‰å¾…æ—¶å…¶ä»–çº¿ç¨‹è°ƒç”¨`interrupt()` æ–¹æ³•ï¼Œå®ƒä»ç»§ç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°signal()æˆ–signalAll()ã€‚å½“å®ƒæœ€ç»ˆä»è¯¥æ–¹æ³•è¿”å›æ—¶ï¼Œå…¶ä¸­æ–­çŠ¶æ€ä»å°†è¢«è®¾ç½®ã€‚ long awaitNanos(long nanosTimeout) throws InterruptedException; å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ã€ä¸­æ–­æˆ–è¶…å‡ºè¶…æ—¶æ—¶é—´ã€‚ æ­¤æ–¹æ³•è¿”å›å‰©ä½™æ—¶é—´ã€‚å› æ­¤å¦‚æœè¿”å›å°äºç­‰äº0çš„æ•°ï¼Œè¯´æ˜å·²ç»è¶…æ—¶ã€‚ boolean await(long time, TimeUnit unit) throws InterruptedException;åŒä¸Šï¼Œä½†å¦‚æœè¶…æ—¶è¿”å›falseï¼Œå¦åˆ™è¿”å›true boolean awaitUntil(Date deadline) throws InterruptedException; å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ã€ä¸­æ–­æˆ–è¶…å‡ºæˆªæ­¢æ—¶é—´ã€‚è¶…æ—¶è¿”å›falseï¼Œå¦åˆ™è¿”å›trueã€‚ void signal();å”¤é†’ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚å¦‚æœæœ‰çº¿ç¨‹åœ¨è¯¥Conditionä¸‹ç­‰å¾…ï¼Œåˆ™é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹å”¤é†’ã€‚è¯¥çº¿ç¨‹ä»await()è¿”å›å‰ï¼Œå¿…é¡»é‡æ–°è·å–Conditonç»‘å®šçš„é”ã€‚ void signalAll(); å”¤é†’æ‰€æœ‰åœ¨è¯¥Conditionä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚åŒæ ·éœ€è¦å…ˆè·å–ç»‘å®šçš„é”ã€‚ Conditionç®€å•ä½¿ç”¨ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134package com.wml.test4.conditon;/** * @author Wang * @date 2020/2/117:27 */public class ConditionDemo { private static Delivery delivery = new Delivery(\"wml\", \"å—äº¬è·¯1å·\", \"å¾·åŸºå¹¿åœºä¸‰å±‚\", 1000); public static void main(String[] args) throws InterruptedException { for (int i = 0; i &lt; 3; i++) { new Thread(() -&gt; { delivery.sms300(); }, \"distance\").start(); } for (int i = 0; i &lt; 3; i++) { new Thread(() -&gt; { delivery.smsArrived(); }, \"address\").start(); } System.out.println(\"é…é€ä¸­\"); Thread.sleep(3000L); delivery.arive300(); Thread.sleep(1000L); delivery.completeDelivery(); }}//é…é€ç±»class Delivery { private Lock lock = new ReentrantLock(); //ä½¿ç”¨lockåˆ›å»ºä¸€ä¸ªç”¨äºå®ç°è·ç¦»çš„ç­‰å¾…é€šçŸ¥çš„condition private Condition distConditon = lock.newCondition(); //ä½¿ç”¨lockåˆ›å»ºä¸€ä¸ªç”¨äºå®ç°åœ°ç‚¹çš„ç­‰å¾…é€šçŸ¥çš„condition private Condition addrCondition = lock.newCondition(); /** * æ”¶é¤äºº */ private String recipient; /** * é…é€åœ°å€ */ private String address; /** * å½“å‰ä½ç½® */ private String currentAddress; /** * è·ç¦» */ private int distance; public Delivery(String recipient, String address, String currentAddress, int distance) { this.recipient = recipient; this.address = address; this.currentAddress = currentAddress; this.distance = distance; } /** * è·ç¦»é€é¤åœ°ç‚¹è¿˜æœ‰300ç±³ï¼Œé€šçŸ¥è®¢é¤äººåˆ°æŒ‡å®šåœ°ç‚¹å–é¤ */ public void arive300() { lock.lock(); try { this.distance = 300; //å‘é€é€šçŸ¥ï¼Œå”¤é†’ç­‰å¾…çº¿ç¨‹ distConditon.signal(); } finally { lock.unlock(); } } /** * å®Œæˆé…é€ï¼Œæ›´æ–°è·ç¦»å’Œä½ç½®ï¼Œå”¤é†’çº¿ç¨‹å‘é€ç›¸å…³é€šçŸ¥ */ public void completeDelivery() { lock.lock(); try { this.distance = 0; this.currentAddress = this.address; //å”¤é†’å½“å‰conditionå®ä¾‹çš„ç­‰å¾…çº¿ç¨‹ addrCondition.signal(); } finally { lock.unlock(); } } /** * åˆ°è¾¾300ç±³å¤„å‘é€é€šçŸ¥ */ public void sms300() { lock.lock(); try { while (this.distance &gt; 300) { try { distConditon.await(); System.out.println(\"åˆ°è¾¾300ç±³å¤„ï¼ŒdistConditonæ‰§è¡Œsignalå”¤é†’äº†\" + Thread.currentThread().getName() + \"çº¿ç¨‹\"); } catch (InterruptedException e) { e.printStackTrace(); } } } finally { lock.unlock(); } System.out.println(\"äº²çˆ±çš„\" + this.recipient + \"å…ˆç”Ÿ/å¥³å£«ï¼Œæ‚¨çš„å¤–å–è¿˜æœ‰300ç±³é€è¾¾\"); } //è®¢é¤é€è¾¾ç›®çš„åœ° public void smsArrived() { lock.lock(); try { try { while (!this.currentAddress.equals(this.address)) { //æŒ‡å®šè¶…æ—¶æ—¶é—´ addrCondition.await(); System.out.println(\"addressCOnditionçš„\" + Thread.currentThread().getName() + \"çº¿ç¨‹è¢«å”¤é†’\"); System.out.println(\"è®¢é¤å·²é€è‡³ç›®çš„åœ°:\" + this.address); } } catch (InterruptedException e) { e.printStackTrace(); } } finally { lock.unlock(); } System.out.println(\"å®Œæˆé…é€\"); }} ç»“æœï¼š 123456é…é€ä¸­åˆ°è¾¾300ç±³å¤„ï¼ŒdistConditonæ‰§è¡Œsignalå”¤é†’äº†distanceçº¿ç¨‹äº²çˆ±çš„wmlå…ˆç”Ÿ/å¥³å£«ï¼Œæ‚¨çš„å¤–å–è¿˜æœ‰300ç±³é€è¾¾addressCOnditionçš„addressçº¿ç¨‹è¢«å”¤é†’è®¢é¤å·²é€è‡³ç›®çš„åœ°:å—äº¬è·¯1å·å®Œæˆé…é€ è¯¥ä¾‹å­ä½¿ç”¨Lockå¯¹è±¡åˆ›å»ºäº†ä¸€ä¸ªè·ç¦»conditionå’Œåœ°å€conditionï¼Œå¤–æ´¾é…é€è‡³è·ç¦»é€é¤ç‚¹300ç±³å’Œé€è¾¾åˆ°æŒ‡å®šåœ°ç‚¹æ—¶éƒ½éœ€è¦å‘é€é€šçŸ¥ï¼Œå‘é€é€šçŸ¥éœ€è¦åˆ†åˆ«è°ƒç”¨è·ç¦»å’Œåœ°å€conditionçš„await()æ–¹æ³•ç­‰å¾…ï¼Œå½“åˆ°è¾¾300ç±³å’ŒæŒ‡å®šåœ°ç‚¹æ—¶å†åˆ†åˆ«è°ƒç”¨å¯¹åº”çš„condition.signal()å”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹ã€‚ å››ã€LockSupportåœ¨å°†Lockçš„å®ç°ç±»å‰ï¼Œéœ€è¦å…ˆå°†AQSï¼Œä½†æ˜¯äº†è§£AQSåˆéœ€è¦å…ˆäº†è§£LockSupportã€‚LockSupport å®šä¹‰äº†ä¸€ç»„ä»¥ park å¼€å¤´çš„æ–¹æ³•ç”¨æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä»¥åŠunpark(Thread thread)æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚ LockSupportç±»æ— æ³•è¢«å®ä¾‹åŒ–ï¼ˆä»ä»¥ä¸‹æºç å¯çœ‹å‡ºï¼Œåªæœ‰ä¸€ä¸ªç§æœ‰çš„æ„é€ å‡½æ•°ï¼‰ä¸”æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯é™æ€çš„ï¼Œè¿™äº›æ–¹æ³•æä¾›äº†æœ€åŸºæœ¬çš„çº¿ç¨‹é˜»å¡å’Œå”¤é†’åŠŸèƒ½ã€‚ 123public class LockSupport { private LockSupport() {} } å†æ¥çœ‹çœ‹LockSupportçš„æˆå‘˜å˜é‡ï¼š 123456private static final sun.misc.Unsafe UNSAFE;//æŒ‚èµ·çº¿ç¨‹å¯¹è±¡çš„åç§»åœ°å€,å¯¹åº”Threadç±»çš„parkBlockerå­—æ®µprivate static final long parkBlockerOffset;private static final long SEED;private static final long PROBE;private static final long SECONDARY; å¯¹åº”çš„èµ‹å€¼åœ¨é™æ€ä»£ç å—ä¸­: 1234567891011121314static { try { UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; tk = Thread.class; parkBlockerOffset = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"parkBlocker\")); SEED = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"threadLocalRandomSeed\")); PROBE = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"threadLocalRandomProbe\")); SECONDARY = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"threadLocalRandomSecondarySeed\")); } catch (Exception ex) { throw new Error(ex); } } å¯ä»¥çœ‹åˆ°éƒ½æ˜¯å…ˆè·å–Threadç±»ä¸‹çš„å¯¹åº”çš„å­—æ®µï¼Œå¦‚parkBlockerï¼Œç„¶åé€šè¿‡UNFAFEçš„objectFieldOffset()æ–¹æ³•è·å–å¯¹åº”å­—æ®µçš„åç§»é‡ï¼ˆæŸå­—æ®µåœ¨å…¶ç±»ä¸­çš„å†…å­˜åç§»é‡æ˜¯å§‹ç»ˆç›¸åŒçš„ï¼‰ å†æ¥çœ‹çœ‹LockSupportçš„é™æ€æ–¹æ³•ï¼š è¯´åœ¨å‰é¢ï¼šLockSupportçš„park()å’Œunpark()åº•å±‚åœ¨ç»´æŠ¤ä¸€ä¸ªè®¸å¯è¯ï¼Œparkç›¸å½“äºæ¶ˆè´¹è€…ï¼Œunparkç›¸å½“äºç”Ÿäº§è€…ï¼ˆç”Ÿäº§ä¸€ä¸ªè®¸å¯è¯ï¼‰ï¼Œparkåœ¨æ²¡è¢«ä¸­æ–­æˆ–å…¶ä»–åŸå› å¯¼è‡´åœæ­¢ç­‰å¾…çš„æƒ…å†µä¸‹ï¼Œå¿…é¡»æ¶ˆè´¹ä¸€ä¸ªè®¸å¯è¯æ‰å¯ä»¥ç»§ç»­æ‰§è¡Œ 1.parkç›¸å…³æ–¹æ³•: 123public static void park() { UNSAFE.park(false, 0L); } å…¶åº•å±‚è°ƒç”¨çš„UNSAFE.park(boolean isAbsolute, long time)æ–¹æ³•ï¼Œå…¶åº•å±‚åŸç†è§£æå¯å‚è€ƒæ­¤æ–‡ç« ï¼šhttps://juejin.im/post/5bdc1142e51d45052c6fede7#heading-1ï¼Œç®€å•çš„è®²ï¼Œå°±æ˜¯å…¶åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªvolatile int _counterå˜é‡ï¼Œè¯¥å˜é‡å°±ç›¸å½“äºè®¸å¯è¯ï¼Œpark()æ–¹æ³•å°±æ˜¯å°†å…¶ä»1æ”¹ä¸º0æ¶ˆè´¹æ‰ã€‚å…¶ä¼šé¦–å…ˆå°è¯•è·å–è®¸å¯ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œå¦‚æœè·å–åˆ°åˆ™è¯´æ˜æœ‰çº¿ç¨‹è°ƒç”¨unpark()é‡Šæ”¾äº†ä¸€ä¸ªè®¸å¯ï¼Œå†è¿›è¡Œä»¥ä¸‹æƒ…å†µçš„åˆ¤æ–­ï¼š å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç›´æ¥è¿”å› å½“å‰çº¿ç¨‹åˆ°æœŸï¼Œç›´æ¥è¿”å›ï¼Œå…·ä½“å¯åˆ†ä¸ºï¼ˆä»¥ä¸‹æƒ…å†µå‘ç”Ÿä¸­æ–­æˆ–å‡ºç°æœªçŸ¥åŸå› ä¹Ÿéƒ½ä¼šè¿”å›ï¼‰:a.`isAbsolute`ä¸ºtrueï¼Œå¦‚æœ`time`å°äºç­‰äº0ï¼Œç›´æ¥è¿”å›ï¼›å¦‚æœå¤§äº0ï¼Œè¿›è¡Œç²—ç²¾åº¦è¶…æ—¶è®¡ç®—ï¼Œè¶…æ—¶æ—¶é—´å†…æœªè·å–åˆ°è®¸å¯åˆ™è¿”å› b.`isAbsolute`ä¸ºfalseï¼Œ`time`ä¸º0Lï¼Œä¸è¿›è¡Œè¶…æ—¶è®¡ç®—ï¼Œä¸€ç›´ç­‰å¾…unparké‡Šæ”¾è®¸å¯ c..`isAbsolute`ä¸ºfalseï¼Œ`time`å¤§äº0ï¼Œè¿›è¡Œç»†ç²¾åº¦è¶…æ—¶è®¡ç®—ï¼Œå¦‚æœåœ¨timeæ—¶é—´å†…ä»æœªè·å–åˆ°è®¸å¯ï¼Œåˆ™ç›´æ¥è¿”å› è¶…æ—¶ç›¸å…³æ–¹æ³•ï¼š 1234567public static void parkUntil(long deadline) { UNSAFE.park(true, deadline);}public static void parkNanos(long nanos) { if (nanos &gt; 0) UNSAFE.park(false, nanos);} 2. å¸¦æœ‰blockerçš„parkç›¸å…³æ–¹æ³•: 123456public static void park(Object blocker) { Thread t = Thread.currentThread(); setBlocker(t, blocker); UNSAFE.park(false, 0L); setBlocker(t, null); } è¯¥æ–¹æ³•ä¹Ÿæ˜¯ç”¨äºé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå…¶ä¸­blockeræ˜¯ç”¨æ¥æ ‡è¯†å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…çš„å¯¹è±¡ï¼ˆé˜»å¡å¯¹è±¡ï¼‰ï¼Œç”¨äºé—®é¢˜çš„æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§ã€‚ setBlocker()æ–¹æ³•å¦‚ä¸‹ï¼š 123private static void setBlocker(Thread t, Object arg) { UNSAFE.putObject(t, parkBlockerOffset, arg); } å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†UNSAFE.putObject()æ–¹æ³•ï¼Œå®ç°å°†ä¼ å…¥çš„blockerï¼Œï¼ˆè¿™é‡Œæ˜¯argï¼‰ï¼Œèµ‹å€¼ç»™å½“å‰çº¿ç¨‹çš„parkBlockerå¯¹åº”åç§»é‡ä¸‹çš„æ•°æ®ã€‚å›è¿‡å¤´çœ‹park(Object blocker) æ–¹æ³•ï¼Œå…¶åœ¨è°ƒç”¨UNSAFE.park()å‰è®¾ç½®äº†blockerï¼Œåœ¨è¢«å”¤é†’ååˆè°ƒç”¨äº†setBlockerå°†å¯¹åº”ä½ç½®çš„blockeræ¸…ç©ºã€‚å› æ­¤å½“å‰çº¿ç¨‹åœ¨é˜»å¡å‰ï¼Œæˆ‘ä»¬ä»å¯ä»¥è·å–åˆ°å½“å‰çš„blockerã€‚è·å–Blockeræ–¹æ³•å¦‚ä¸‹ï¼š 12345public static Object getBlocker(Thread t) { if (t == null) throw new NullPointerException(); return UNSAFE.getObjectVolatile(t, parkBlockerOffset); } å¸¦blockerçš„è¶…æ—¶çš„park()æ–¹æ³•å¦‚ä¸‹ï¼š 1234567891011121314public static void parkNanos(Object blocker, long nanos) { if (nanos &gt; 0) { Thread t = Thread.currentThread(); setBlocker(t, blocker); UNSAFE.park(false, nanos); setBlocker(t, null); } }public static void parkUntil(Object blocker, long deadline) { Thread t = Thread.currentThread(); setBlocker(t, blocker); UNSAFE.park(true, deadline); setBlocker(t, null); } 3.unparkç›¸å…³æ–¹æ³•: 1234public static void unpark(Thread thread) { if (thread != null) UNSAFE.unpark(thread); } å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚åº•å±‚å°±æ˜¯å°†_counterå˜é‡è®¾ä¸º1ï¼Œå¦‚æœ_counteræœ¬æ¥æ˜¯0ï¼Œåˆ™ä¼šå”¤é†’åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚unparkå¯ä»¥åœ¨parkä¹‹å‰ä½¿ç”¨ï¼Œè¿™æ ·è°ƒç”¨parkæ—¶å‘ç°_counterä¸º1ï¼Œåˆ™å¯ä»¥ç›´æ¥æ¶ˆè´¹ä½¿ç”¨ï¼›unpark()å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œä½†_counterå€¼æœ€å¤šä¸º1ï¼Œä¸ä¼šç´¯åŠ ï¼Œå› æ­¤è¿ç»­è°ƒç”¨ä¸¤æ¬¡park()åªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œç¬¬äºŒæ¬¡å°±ä¼šç­‰å¾…ã€‚ ä¸‹é¢å†™ä¸€ä¸ªå°ä¾‹å­éªŒè¯ä¸Šé¢çš„è¯´æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273public class LockSupportDemo { /** * æµ‹è¯•blockeråœ¨å¯¹åº”çº¿ç¨‹è¢«å”¤é†’åæ¸…ç©º */ public static void testBlocker(){ Thread threadA = new Thread(()-&gt;{ System.out.println(\"ThreadAè¢«é˜»å¡å‰\"); LockSupport.park(\"threadA_Blocker\"); try { Thread.sleep(1000L); } catch (InterruptedException e) { e.printStackTrace(); } }); threadA.start(); new Thread(()-&gt;{ try { Thread.sleep(2000L); } catch (InterruptedException e) { e.printStackTrace(); } String blocker = (String) LockSupport.getBlocker(threadA); System.out.println(\"çº¿ç¨‹Aå³å°†è¢«å”¤é†’\"); System.out.println(\"è·å–åˆ°çº¿ç¨‹Açš„blocker:\"+blocker); //é‡Šæ”¾çº¿ç¨‹A LockSupport.unpark(threadA); System.out.println(\"çº¿ç¨‹Aè¢«å”¤é†’äº†\"); System.out.println(\"å†æ¬¡è·å–çº¿ç¨‹Açš„blocker\"); String blocker2=(String)LockSupport.getBlocker(threadA); System.out.println(\"è·å–åˆ°çº¿ç¨‹Açš„blocker:\"+blocker2); }).start(); } public static void main(String[] args) throws InterruptedException { //testBlocker(); Thread thread = new Thread(() -&gt; { unparkFirst(); }); thread.start(); new Thread(()-&gt;{ try { Thread.sleep(2000L); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\"ç¬¬ä¸‰æ¬¡æ‰§è¡Œunpark\"); LockSupport.unpark(thread); }).start(); } /** * æµ‹è¯•å…ˆæ‰§è¡Œunparkï¼Œå†parkå¯ç»§ç»­æ‰§è¡Œï¼Œä½†æ˜¯æ‰§è¡Œä¸¤æ¬¡unparkï¼Œä¹Ÿåªèƒ½æ‰§è¡Œä¸€æ¬¡parkï¼Œç¬¬äºŒæ¬¡parkè¢«é˜»å¡ */ public static Thread unparkFirst(){ Thread curThread = Thread.currentThread(); LockSupport.unpark(curThread); LockSupport.unpark(curThread); System.out.println(\"æ‰§è¡Œä¸¤æ¬¡unparkå\"); LockSupport.park(); System.out.println(\"ç¬¬ä¸€æ¬¡æ‰§è¡Œparkå\"); LockSupport.park(); System.out.println(\"ç¬¬äºŒæ¬¡æ‰§è¡Œparkå\"); return curThread; }} æ‰§è¡ŒtestBlocker()ç»“æœï¼š 123456ThreadAè¢«é˜»å¡å‰çº¿ç¨‹Aå³å°†è¢«å”¤é†’è·å–åˆ°çº¿ç¨‹Açš„blocker:threadA_Blockerçº¿ç¨‹Aè¢«å”¤é†’äº†å†æ¬¡è·å–çº¿ç¨‹Açš„blockerè·å–åˆ°çº¿ç¨‹Açš„blocker:null å‘ç°åœ¨çº¿ç¨‹Aè¢«å”¤é†’åï¼Œå¯¹åº”çš„blockerä¸ºç©ºæ‰§è¡ŒunparkFirst()ç»“æœï¼š 1234æ‰§è¡Œä¸¤æ¬¡unparkåç¬¬ä¸€æ¬¡æ‰§è¡Œparkåç¬¬ä¸‰æ¬¡æ‰§è¡Œunparkç¬¬äºŒæ¬¡æ‰§è¡Œparkå å‘ç°ç¬¬äºŒæ¬¡æ‰§è¡Œparkåï¼Œçº¿ç¨‹è¢«é˜»å¡ç­‰å¾…ï¼Œåªæœ‰å†æ¬¡æ‰§è¡Œunparkåï¼Œåé¢çš„ä»£ç æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤parkå’Œunparkåº”æˆå¯¹å‡ºç°ï¼Œå¦åˆ™çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚ äº”ã€AQSè®²å®Œäº†LockerSupportï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è®²è§£AQSäº†ã€‚ 5.1 CLHé˜Ÿåˆ—é”CLH é˜Ÿåˆ—é”æ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹ä»…ä»…åœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå‡è®¾å‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ï¼Œè·å–å¯¹åº”çš„é”ã€‚ CLHé˜Ÿåˆ—é”ç”±ä¸€ä¸ªå‰é©±èŠ‚ç‚¹preï¼Œä¸€ä¸ªå½“å‰èŠ‚ç‚¹curNodeï¼Œä¸€ä¸ªtailå°¾èŠ‚ç‚¹å’Œä¸€ä¸ªlockedä½æ„æˆ 5.1.1 è·å–é”è‹¥å½“å‰çº¿ç¨‹Aéœ€è¦è·å–é”ï¼Œåˆ™çº¿ç¨‹Aåˆ›å»ºä¸€ä¸ªæ–°çš„QNodeï¼Œå…ˆå°†å…¶lockedä½è®¾ä¸ºtrueï¼Œè¡¨ç¤ºéœ€è¦è·å–é”ï¼Œåœ¨è°ƒç”¨tail.getAndSet(curNode)ï¼ŒCASçš„æ–¹å¼å°†è‡ªå·±è®¾ä¸ºå°¾éƒ¨ï¼ˆè¿™æ ·åé¢å†æœ‰éœ€è¦è·å–é”çš„å°±å¿…é¡»åœ¨çº¿ç¨‹Aåæ’é˜Ÿï¼‰ï¼ŒåŒæ—¶è¯¥æ–¹æ³•è¿”å›åŸæ¥çš„å°¾èŠ‚ç‚¹ï¼Œè®©è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘åŸå°¾èŠ‚ç‚¹ï¼ˆå³æŒ‡å‘å‰ä¸€ä¸ªçº¿ç¨‹çš„nodeèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè·å–é”çš„çº¿ç¨‹ï¼Œåˆ™preæŒ‡å‘nullï¼Œå› ä¸ºtailåˆå§‹åŒ–ä¸ºnullï¼‰ï¼Œæœ€åå¾ªç¯è®¿é—®åŸå°¾èŠ‚ç‚¹çš„lockedä½ï¼Œå½“å…¶ä¸ºfalseæ—¶ï¼Œåœæ­¢å¾ªç¯ï¼Œå³åœæ­¢è‡ªæ—‹ï¼Œè·å¾—åˆ°é”ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼šè¿™æ ·åªè¦å‰é¢çš„çº¿ç¨‹ä½¿ç”¨é”ç»“æŸï¼Œlockedä½å˜ä¸ºfalseï¼Œåé¢æ’é˜Ÿçš„çº¿ç¨‹å°±å¯ä»¥è·å–åˆ°é”ã€‚ 5.1.2 é‡Šæ”¾é”é‡Šæ”¾é”æ¯”è¾ƒç®€å•ï¼Œç›´æ¥å°†å½“å‰èŠ‚ç‚¹çš„lockedä½è®¾ä¸ºfalseï¼Œç„¶åè®©å½“å‰èŠ‚ç‚¹è®¾ä¸ºå‰é©±èŠ‚ç‚¹ï¼Œä»£è¡¨å‡ºé˜Ÿã€‚ç®€å•å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233/** * @author Wang * @date 2020/2/216:19 */public class CLH { private final AtomicReference&lt;QNode&gt; tail= new AtomicReference&lt;&gt;(new QNode());; private final ThreadLocal&lt;QNode&gt; pre; private final ThreadLocal&lt;QNode&gt; curNode; private static class QNode { volatile boolean locked = false; } public CLH() { curNode = ThreadLocal.withInitial(() -&gt; new QNode()); pre = ThreadLocal.withInitial(() -&gt; null); } public void lock() { QNode node = curNode.get(); node.locked = true; QNode pred = tail.getAndSet(node); pre.set(pred); while (pred.locked) {} } public void unlock() { QNode qnode = curNode.get(); qnode.locked = false; curNode.set(pre.get()); }} 5.2 AQS AQSå³é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œæ˜¯ç”¨æ¥æ„å»ºé”å’Œå…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå¦‚å³å°†è¦å°†çš„Lockçš„å‡ ä¸ªå®ç°ç±»ï¼ŒReentrantLockã€ReentrantReadWriteLockä»¥åŠå‰é¢æ–‡ç« æåˆ°çš„CountDownLatchã€Semaphoreç­‰éƒ½æ˜¯åŸºäºAQSæ¡†æ¶å®ç°çš„ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©AQSå®ç°è‡ªå·±çš„åŒæ­¥å™¨ã€‚ä½¿ç”¨æ–¹å¼ï¼šå­ç±»é€šè¿‡ç»§æ‰¿AQSï¼Œå®ç°AQSæä¾›çš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œåœ¨AQSä¸­ç»´æŠ¤äº†ä¸€ä¸ªintç±»å‹çš„stateä»£è¡¨è¯¥çŠ¶æ€ï¼Œå¹¶æä¾›äº†getState()ã€setState(int newState)å’Œ compareAndSetState(int expect,int update)ç­‰æ–¹æ³•å®ç°å¯¹å…±äº«èµ„æºstateçš„è·å–å’Œé‡Šæ”¾ï¼›è€Œè¯¥å­ç±»æ¨èä½¿ç”¨é™æ€å†…éƒ¨ç±»çš„æ–¹å¼å®ç°ï¼ŒAQSåªæ˜¯å®šä¹‰äº†è‹¥å¹²åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•æä¾›è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ä½¿ç”¨ï¼Œå…¶æ”¯æŒç‹¬å å¼å’Œå…±äº«å¼ä¸¤ç§æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ã€‚åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚é”å’ŒåŒæ­¥å™¨å¾ˆå¥½åœ°éš”ç¦»äº†ä½¿ç”¨è€…å’Œå®ç°è€…æ‰€éœ€å…³æ³¨çš„é¢†åŸŸã€‚å®ç°è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ï¼Œéšåå°†åŒæ­¥å™¨ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•å°†ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚ æ¨¡æ¿æ–¹æ³•AQSçš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯æ¨¡æ¿æ–¹æ³•å‘¢ï¼Ÿç®€å•çš„è¯´å°±æ˜¯åœ¨æ–¹æ³•ä¸­åªå®šä¹‰äº†è¯¥æ–¹æ³•çš„éª¨æ¶ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°æ­¥éª¤æ”¾åœ¨äº†å…¶å­ç±»ä¸­ã€‚å¦‚Springä¸­çš„å„ç§å„æ ·çš„Templateæ¨¡æ¿ã€‚å¦‚è¿˜ä¸æ‡‚ä»€ä¹ˆæ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œè¯·çœ‹ä»¥ä¸‹ä¾‹å­ï¼š 1.å®šä¹‰ä¸€ä¸ªæ”¹å·å­çš„æŠ½è±¡ç±»ï¼š 12345678910111213141516171819202122232425262728293031public abstract class AbstractMarking { //æ”¹å·å­ protected abstract void check(); //è®¡ç®—æ€»åˆ† protected abstract void compute(); //åˆ’åˆ†ç­‰ç¬¬ protected abstract void rank(); /** * æ‰¹å·çš„æ¨¡æ¿æ–¹æ³• * æä¾›äº†ä»¥ä¸Šä¸‰ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“å®ç°åœ¨å­ç±» */ public final void marking(){ check(); compute(); if (shouldRank()){ rank(); } } /** * æ˜¯å¦è¦æ‰“ç­‰çº§(æœ‰çš„ç§‘ç›®æ ¹æ®åˆ†æ•°è¦åˆ’åˆ†ç­‰çº§ï¼Œæœ‰çš„åˆ™æŒ‰åˆ†æ•°è¯„) * @return */ protected boolean shouldRank(){ return false; }} 2.åˆ†åˆ«å®šä¹‰æ•°å­¦ã€è‹±è¯­å’Œå®è®­ç±»å®ç°æ”¹å·å­çš„æŠ½è±¡ç±» 1234567891011121314151617181920212223242526272829303132333435363738public class English extends AbstractMarking { @Override protected void check() { System.out.println(\"æ”¹è‹±è¯­å·å­\"); } @Override protected void compute() { System.out.println(\"è®¡ç®—è‹±è¯­åˆ†æ•°\"); } @Override protected void rank() { System.out.println(\"ä¸éœ€æ‰“è‹±è¯­\"); }}public class Practical extends AbstractMarking { @Override protected void check() { System.out.println(\"æ”¹å®è®­æˆæœ\"); } @Override protected void compute() { System.out.println(\"è®¡ç®—å®è®­åˆ†æ•°\"); } @Override protected void rank() { System.out.println(\"æ‰“å®è®­ç­‰çº§\"); } @Override protected boolean shouldRank() { return true; }} è°ƒç”¨ï¼š 12345678910public class Main { public static void main(String[] args) { AbstractMarking englishMarking=new English(); englishMarking.marking(); AbstractMarking mathMarking=new Math(); mathMarking.marking(); AbstractMarking pracMarking=new Practical(); pracMarking.marking(); }} ç»“æœï¼š 1234567æ”¹è‹±è¯­å·å­è®¡ç®—è‹±è¯­åˆ†æ•°æ”¹é«˜æ•°å·å­è®¡ç®—é«˜æ•°åˆ†æ•°æ”¹å®è®­æˆæœè®¡ç®—å®è®­åˆ†æ•°æ‰“å®è®­ç­‰çº§ AQSä¸­çš„æ¨¡æ¿æ–¹æ³•ï¼šå®ç°è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ã€‚ ç‹¬å æ¨¡å¼ï¼š void acquire(int arg)ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç”±è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨é‡å†™çš„tryAcquire(int arg)æ–¹æ³• void acquireInterruptibly(int arg)åŒä¸Šï¼Œä½†ç›¸åº”ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€è€Œè¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œä½†å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸å¹¶è¿”å›ã€‚ boolean tryAcquireNanos(int arg, long nanosTimeout)åŒ2ï¼Œä½†å¢åŠ äº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…æœªè·å¾—åˆ°åŒæ­¥çŠ¶æ€ï¼Œåˆ™è¿”å›falseï¼Œåä¹‹è¿”å›true protected boolean tryAcquire(int arg)ä»¥åŠtryRelease(int arg) ï¼ˆå¯é‡å†™ï¼‰tryAcquireç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå®ç°è¯¥æ–¹æ³•éœ€è¦æŸ¥è¯¢å½“å‰çŠ¶æ€å¹¶åˆ¤æ–­åŒæ­¥è½¬é˜¿æ ¹å»·æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç„¶åå†è¿›è¡ŒCASè®¾ç½®åŒæ­¥çŠ¶æ€ã€‚è·å–æˆåŠŸè¿”å›trueï¼Œåä¹‹è¿”å›falseã€‚tryReleaseåº¦å±•ç¤ºé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†æœ‰æœºä¼šè·å–åŒæ­¥çŠ¶æ€ boolean release(int arg)ç‹¬å å¼åœ°é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹å”¤é†’ã€‚ å…±äº«æ¨¡å¼ï¼šæä¾›äº†ä¸ç‹¬å æ¨¡å¼å¯¹åº”çš„å¸¦æœ‰Sharedçš„å…±äº«å¼ç›¸å…³çš„æ–¹æ³•ã€‚ä»¥void acquireShared(int arg)ä¸ºä¾‹ï¼Œå…±äº«å¼çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœæœªè·å–åˆ°ï¼Œåˆ™å°†å½“å‰çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œä¸ç‹¬å å¼ä¸åŒçš„æ˜¯è¯¥æ–¹æ³•å…è®¸åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚ AQSä¸­çš„èŠ‚ç‚¹å’ŒåŒæ­¥é˜Ÿåˆ—æ•°æ®ç»“æ„åœ¨ä»‹ç»CLHé”æ—¶å€™å·²ç»æåˆ°äº†ï¼ŒAQSæ˜¯åŸºäºCLHçš„å˜ç§å®ç°ï¼Œå¯¹åº”çš„å°±æ˜¯é™æ€å†…éƒ¨ç±»Nodeï¼Œå®šä¹‰å¦‚ä¸‹ï¼š å…ˆçœ‹Nodeçš„ä¸¤ä¸ªç­‰å¾…æ¨¡å¼å’Œå‡ ä¸ªçŠ¶æ€ï¼š 1234567891011121314151617static final class Node { //æ ‡æ˜çº¿ç¨‹ä»¥å…±äº«æ¨¡å¼ç­‰å¾…é”ï¼Œå¦‚è¯»é”ReadLock static final Node SHARED = new Node(); //æ ‡æ˜çº¿ç¨‹ä»¥ç‹¬å æ¨¡å¼ç­‰å¾…é”ï¼Œå¦‚å¯é‡å…¥é”ReetrantLock(å³ä¸€æŠŠé”ä¸€æ¬¡åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œè€Œå…±äº«é”å…è®¸ä¸€æŠŠé”ä¸€æ¬¡è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰) static final Node EXCLUSIVE = null; /** *ä»¥ä¸‹å‡ ä¸ªæ˜¯çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ */ // è¡¨ç¤ºçº¿ç¨‹è·å–é”çš„è¯·æ±‚å·²ç» å–æ¶ˆ static final int CANCELLED = 1; // åé©±èŠ‚ç‚¹å…¥é˜Ÿç­‰å¾…åä¼šæ›´æ–°å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºSIGNALï¼Œç­‰å¾…å‰é©±èŠ‚ç‚¹é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå‰é©±èŠ‚ç‚¹é‡Šæ”¾åä¼šå”¤é†’åé©±èŠ‚ç‚¹ static final int SIGNAL = -1; //è¡¨ç¤ºèŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå½“å…¶ä»–çº¿ç¨‹è°ƒç”¨çš„condition.signal()åï¼ŒCONDITION static final int CONDITION = -2; //åœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œå‰é©±èŠ‚ç‚¹åœ¨å”¤é†’åé©±èŠ‚ç‚¹çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ— æ¡ä»¶çš„å”¤é†’åé©±èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ï¼Œä¸€ç›´ä¼ é€’ä¸‹å» static final int PROPAGATE = -3; é™¤æ­¤ä¹‹å¤–ã€‚è¿˜æœ‰ä¸€ä¸ªå€¼ä¸º0çš„çŠ¶æ€ï¼Œä»£è¡¨åˆå§‹åŒ–Nodeå¯¹è±¡çš„é»˜è®¤å€¼ã€‚ä»ä»¥ä¸Šå˜é‡å¯çœ‹å‡ºï¼Œå½“å€¼ä¸ºè´Ÿçš„æ—¶å€™ï¼Œè¡¨ç¤ºç»“ç‚¹ç­‰å¾…çŠ¶æ€æœ‰æ•ˆï¼Œè€Œæ­£å€¼è¡¨ç¤ºç»“ç‚¹å·²è¢«å–æ¶ˆã€‚å› æ­¤å¯é€šè¿‡åˆ¤æ–­çŠ¶æ€çš„å€¼æ˜¯å¦å°äº0æ¥åˆ¤å®šå…¶æ˜¯å¦æ­£å¸¸ã€‚ æˆå‘˜å˜é‡ï¼š 1234567891011//çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çŠ¶æ€ï¼Œ å€¼ä¸ºä»¥ä¸Šå‡ ä¸ªvolatile int waitStatus;//å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹volatile Node prev;//å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹volatile Node next;//å½“å‰èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹volatile Thread thread;//Nodeä½œä¸ºåŒæ­¥é˜Ÿåˆ—èŠ‚ç‚¹æ—¶ï¼ŒnextWaiteræœ‰ä¸¤ä¸ªå€¼ï¼šEXCLUSIVEã€SHAREDæ ‡è¯†å½“å‰èŠ‚ç‚¹æ˜¯ç‹¬å æ¨¡å¼è¿˜æ˜¯å…±äº«æ¨¡å¼//Nodeä½œä¸ºç­‰å¾…é˜Ÿåˆ—èŠ‚ç‚¹æ—¶ï¼ŒnextWaiterè¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ã€‚Node nextWaiter; å¦å¤–ï¼ŒAQSè¿˜æä¾›äº†å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹çš„å¼•ç”¨ã€‚ 12private transient volatile Node head;private transient volatile Node tail; ä½†è¿™é‡Œçš„headèŠ‚ç‚¹ä¸ä¿å­˜çº¿ç¨‹ä¿¡æ¯ã€‚å¦‚ä¸‹ï¼š 12345private void setHead(Node node) { head = node; node.thread = null; node.prev = null; } headèŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„èŠ‚ç‚¹ï¼ŒheadèŠ‚ç‚¹çš„çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œä¼šå”¤é†’å…¶åé©±èŠ‚ç‚¹ï¼Œè€Œåé©±èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºheadèŠ‚ç‚¹ã€‚è®¾ç½®é¦–èŠ‚ç‚¹æ¯æ¬¡éƒ½æ˜¯é€šè¿‡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„é‚£ä¸ªçº¿ç¨‹å®ç°çš„ï¼Œå› ä¸ºä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œæ‰€ä»¥è®¾ç½®å¤´èŠ‚ç‚¹çš„æ–¹æ³•å¹¶ä¸éœ€è¦ä½¿ç”¨ CAS ï¼Œåªéœ€è¦å°†å¤´èŠ‚ç‚¹è®¾ç½®æˆä¸ºåŸå¤´èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹å¹¶æ–­å¼€ä¸åŸå¤´èŠ‚ç‚¹çš„è¿æ¥ã€‚ ç‹¬å å¼åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾1.è·å–12345public final void acquire(int arg) { if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); } 1.é¦–å…ˆè°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°çš„ tryAcquire(int arg)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œè‹¥æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å›ï¼Œè‹¥å¤±è´¥ï¼Œåˆ™è¿”å›falseï¼Œç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ã€‚2.å¦‚æœåŒæ­¥çŠ¶æ€è·å–å¤±è´¥ï¼Œåˆ™æ„é€ åŒæ­¥èŠ‚ç‚¹å¹¶é€šè¿‡addWaiter(Node node)æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425Node(Thread thread, Node mode) { this.nextWaiter = mode; this.thread = thread;}private Node addWaiter(Node mode) { //é€šè¿‡å½“å‰çº¿ç¨‹å’Œmodeï¼ˆNode.EXCLUSIVEï¼‰æ„é€ ä¸€ä¸ªNodeèŠ‚ç‚¹ï¼Œåœ¨ä¸Šé¢çš„æ„é€ æ–¹æ³•ä¸­å¯çœ‹å‡ºmodeè¢«èµ‹å€¼ç»™nextWaiterï¼Œä¹Ÿå°è¯äº†ä¸Šé¢æˆå‘˜å˜é‡ä¸­å¯¹nextWaiterçš„è§£é‡Š Node node = new Node(Thread.currentThread(), mode); //è·å–åŸæ¥çš„å°¾èŠ‚ç‚¹ Node pred = tail; if (pred != null) { //å°¾èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè®©å½“å‰èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘tail node.prev = pred; //é€šè¿‡CASæ›´æ–°å°¾èŠ‚ç‚¹ if (compareAndSetTail(pred, node)) { //CASæˆåŠŸï¼ŒåŸtailèŠ‚ç‚¹çš„åé©±æŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼Œå®ç°åŒå‘é“¾è¡¨ pred.next = node; //è¿”å›å½“å‰èŠ‚ç‚¹ return node; } } //å¦‚æœå°¾èŠ‚ç‚¹ä¸ºç©ºæˆ–CASå¤±è´¥ï¼Œåˆ™è°ƒç”¨enq(node)å°†å½“å‰èŠ‚ç‚¹å…¥é˜Ÿï¼Œè¿”å›node enq(node); return node; } å…¥é˜Ÿæ“ä½œå¦‚ä¸‹ï¼šé€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸åœçš„CASè®¾ç½®å°¾èŠ‚ç‚¹ 123456789101112131415161718private Node enq(final Node node) { for (;;) { Node t = tail; if (t == null) { //å°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆå§‹åŒ–é˜Ÿåˆ—ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶è®©å°¾èŠ‚ç‚¹ç­‰äºå¤´æ¥åœ°é‚£ if (compareAndSetHead(new Node())) tail = head; } else { //å°¾èŠ‚ç‚¹ä¸ä¸ºç©º node.prev = t; //CASè®¾ç½®å°¾èŠ‚ç‚¹ if (compareAndSetTail(t, node)) { t.next = node; return t; } } } } å³å…¥é˜Ÿæ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªåŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ™é€šè¿‡compareAndSetHead(new Node())åˆå§‹åŒ–é˜Ÿåˆ—å¤´ å¦åˆ™ï¼Œè¿›è¡Œè‡ªæ—‹ä¸æ–­CASå°†èŠ‚ç‚¹æ’å…¥å°¾èŠ‚ç‚¹ 3.æœ€åè°ƒç”¨ acquireQueued(Node node,int arg)æ–¹æ³•ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹ä»¥â€œæ­»å¾ªç¯â€çš„æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœè·å–ä¸åˆ°åˆ™é˜»å¡èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œåˆ™åªèƒ½ç­‰å¾…å‰é©±èŠ‚ç‚¹å‡ºé˜Ÿæˆ–é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­æ‰èƒ½å”¤é†’é˜»å¡çº¿ç¨‹ã€‚ 123456789101112131415161718192021222324252627final boolean acquireQueued(final Node node, int arg) { boolean failed = true; try { boolean interrupted = false; for (;;) { //è·å–å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); //åªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹æ‰å¯ä»¥tryAcquire if (p == head &amp;&amp; tryAcquire(arg)) { //å¦‚æœè·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™å°†å¤´èŠ‚ç‚¹æ¢ä¸ºå½“å‰èŠ‚ç‚¹ setHead(node); p.next = null; // help GC failed = false; //è¿”å›ä¸­æ–­çŠ¶æ€ï¼Œæ­¤æ—¶ä¸éœ€è¦ä¸­æ–­ return interrupted; } //å‰é©±èŠ‚ç‚¹éå¤´èŠ‚ç‚¹æˆ–è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ if (shouldParkAfterFailedAcquire(p, node) //åˆ¤æ–­è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åæ˜¯å¦éœ€è¦é˜»å¡ &amp;&amp; parkAndCheckInterrupt())//å¦‚æœéœ€è¦é˜»å¡ï¼Œ interrupted = true;//ç½®ä¸­æ–­æ ‡å¿—ä¸ºtrue } } finally { //å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™å°†å½“å‰èŠ‚ç‚¹å–æ¶ˆ if (failed) cancelAcquire(node); } } shouldParkAfterFailedAcquireå¦‚ä¸‹ï¼š 12345678910111213141516171819private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) { //è·å–å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ int ws = pred.waitStatus; //å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯SIGNAL(å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”åä¼šé€šçŸ¥åé©±èŠ‚ç‚¹)ï¼Œåˆ™å½“å‰èŠ‚ç‚¹å¯ä»¥è¿›è¡Œå®‰å…¨ç­‰å¾… if (ws == Node.SIGNAL) return true; //wså¤§äº0å³å¤„äºCANCELçŠ¶æ€ if (ws &gt; 0) { //å¾ªç¯å°†å½“å‰èŠ‚ç‚¹ä¸å‰é©±èŠ‚ç‚¹ä¸ºéCANCELçŠ¶æ€çš„èŠ‚ç‚¹è¿æ¥ï¼Œå³å¾ªç¯éå†æ‰¾åˆ°æœ‰æ•ˆçŠ¶æ€èŠ‚ç‚¹ do { node.prev = pred = pred.prev; } while (pred.waitStatus &gt; 0); pred.next = node; } else { //å¤„äºå…¶ä»–çŠ¶æ€æ—¶ï¼Œå°†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ›´æ–°å°¾SIGNALï¼Œç„¶åè¿”å›falseï¼Œä¼šåœ¨acquireQueuedä¸­ç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œç›´åˆ°å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºSIGNALæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªæ–¹æ³• compareAndSetWaitStatus(pred, ws, Node.SIGNAL); } return false; } å¯è§ï¼Œè¯¥æ–¹æ³•åªæœ‰åœ¨å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºSIGNALæ—¶æ‰ä¼šè¿”å›trueï¼Œå¯ä»¥è¿›è¡Œå®‰å…¨ç­‰å¾…ã€‚æ¥ç€ä¼šè°ƒç”¨parkAndCheckInterrupt()ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶è¿”å›ä¸­æ–­çŠ¶æ€ 1234private final boolean parkAndCheckInterrupt() { LockSupport.park(this); return Thread.interrupted(); } æµç¨‹æ€»ç»“ï¼š1.è°ƒç”¨tryAcquireå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¦åˆ™è¿›å…¥ 22.è°ƒç”¨addWaiterå°†å½“å‰çº¿ç¨‹æ„é€ ä¸€ä¸ªæ–°èŠ‚ç‚¹åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æœªåˆå§‹åŒ–åˆ™å…ˆåˆå§‹åŒ–ï¼Œå¦åˆ™ç›´æ¥å°†æ–°èŠ‚ç‚¹åŠ å…¥é˜Ÿå°¾3.æ¥ç€è°ƒç”¨acquireQueuedè®©åŠ å…¥é˜Ÿåˆ—çš„èŠ‚ç‚¹å¼€å§‹è‡ªæ—‹ï¼Œåªæœ‰è¯¥èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºheadæ—¶æ‰å¯ä»¥å°è¯•è·å–çŠ¶æ€ï¼ˆè¿™é‡Œä¸€æ˜¯å› ä¸ºå¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¤´èŠ‚ç‚¹é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¼šå”¤é†’åé©±èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¦åŠ æ­¤åˆ¤æ–­ï¼ŒäºŒæ˜¯å› ä¸ºé˜Ÿåˆ—çš„FIFOï¼‰ï¼Œå¦åˆ™è·³è¿‡å¤„äºCANCELçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ›´æ–°ä¸ºSIGNALï¼Œåªæœ‰å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºSIGNALæ—¶ï¼Œè¯¥èŠ‚ç‚¹æ‰å¯ä»¥è¿›è¡Œparkç­‰å¾…ï¼Œè¿”å›ä¸­æ–­çŠ¶æ€4. å¦‚æœè¢«ä¸­æ–­ï¼Œåˆ™è°ƒç”¨selfInterrupt()ä¸­æ–­å½“å‰çº¿ç¨‹ 2.é‡Šæ”¾é‡Šæ”¾åŒæ­¥çŠ¶æ€é€šè¿‡releaseæ–¹æ³•ï¼Œé‡Šæ”¾åä¼šå”¤é†’åé©±èŠ‚ç‚¹ï¼Œè®©åé©±èŠ‚ç‚¹é‡æ–°å°è¯•è·å–åŒæ­¥çŠ¶æ€ 12345678910public final boolean release(int arg) { if (tryRelease(arg)) {///è°ƒç”¨æ¨¡æ¿æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false å…·ä½“å®ç°åœ¨å­ç±» Node h = head; //å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”çŠ¶æ€é0æ—¶å”¤é†’åé©±èŠ‚ç‚¹ if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; } return false; } unparkSuccessorå¦‚ä¸‹ï¼š 12345678910111213141516171819202122private void unparkSuccessor(Node node) { //è·å–å¤´èŠ‚ç‚¹ï¼ˆè¦é‡Šæ”¾åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼‰çš„çŠ¶æ€ int ws = node.waitStatus; if (ws &lt; 0) //å°†çŠ¶æ€æ”¹ä¸º0 compareAndSetWaitStatus(node, ws, 0); //è·å–åé©±èŠ‚ç‚¹ Node s = node.next; //å¦‚æœåé©±èŠ‚ç‚¹ä¸ºç©ºæˆ–å·²ç»è¢«å–æ¶ˆ if (s == null || s.waitStatus &gt; 0) { //é‡æ–°ç½®ä¸ºnull s = null; //ä»å°¾éƒ¨å¾ªç¯è·å–å¤„äºç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹ä½œä¸ºåé©±æ¥åœ°é‚£ for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; } if (s != null) //åé©±èŠ‚ç‚¹éç©ºæ—¶ï¼Œå”¤é†’è¯¥èŠ‚ç‚¹ LockSupport.unpark(s.thread); } é‚£ä¹ˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦ä»å°¾éƒ¨éå†å‘¢ï¼Ÿä»Nodeç±»çš„æºç ç»™å‡ºå¦‚ä¸‹è§£é‡Šï¼šé¦–å…ˆçœ‹ä¸€ä¸‹ä¹‹å‰è®²çš„addWaiter 12345678910111213private Node addWaiter(Node mode) { Node node = new Node(Thread.currentThread(), mode); Node pred = tail; if (pred != null) { node.prev = pred; if (compareAndSetTail(pred, node)) { pred.next = node; return node; } } enq(node); return node; } åœ¨æ’å…¥åˆ°å°¾èŠ‚ç‚¹æ—¶ï¼Œå…ˆæ‰§è¡Œçš„æ˜¯node.prev=predï¼Œå°†å½“å‰èŠ‚ç‚¹ä¸å‰é©±èŠ‚ç‚¹è¿æ¥ï¼Œç„¶åcompareAndSetTail(pred, node)åŸå­æ›´æ–°å°¾èŠ‚ç‚¹åæ‰æ‰§è¡Œpred.next = node;å°†å‰é©±èŠ‚ç‚¹çš„nextå¼•ç”¨ä¸æ–°çš„å°¾èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œå¦‚æœåœ¨è¯¥æ“ä½œæ‰§è¡Œå‰è°ƒç”¨äº†unparkSuccessorå°±æ— æ³•ä»å‰å¾€åå®Œå…¨éå† å…±äº«æ¨¡å¼åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾è·å–ä»¥å…±äº«æ¨¡å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¿½ç•¥ä¸­æ–­ 12345public final void acquireShared(int arg) { if (tryAcquireShared(arg) &lt; 0) doAcquireShared(arg); } tryAcquireShared(int arg)æ¨¡æ¿æ–¹æ³•è¿”å›å€¼ä¸º int ç±»å‹ï¼Œå½“è¿”å›å€¼å¤§äºç­‰äº 0 æ—¶ï¼Œè¡¨ç¤ºèƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚å¯ä»¥ç®€å•çœ‹ä¸€ä¸‹Semphoreä¸­éå…¬å¹³é”å¯¹è¯¥æ–¹æ³•çš„å®ç°ï¼š 12345678910111213141516protected int tryAcquireShared(int acquires) { return nonfairTryAcquireShared(acquires); }final int nonfairTryAcquireShared(int acquires) { //é€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯è·å–åŒæ­¥çŠ¶æ€ for (;;) { //è·å–å½“å‰åŒæ­¥çŠ¶æ€ï¼Œè¿™é‡Œè¡¨ç¤ºå½“å‰å¯ç”¨è®¸å¯æ•° int available = getState(); //å‡å»æœ¬æ¬¡ç”³è¯·è®¸å¯æ•°acquiresï¼Œå¾—åˆ°ç”³è¯·æˆåŠŸåçš„å‰©ä½™è®¸å¯æ•°remaining int remaining = available - acquires; if (remaining &lt; 0 || //å¦‚æœremainingå°äº0ï¼Œåˆ™æœ¬æ¬¡ç”³è¯·æ²¡æœ‰è·å–æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œåç»­åŠ å…¥ç­‰å¾…é˜Ÿåˆ— //å¦‚æœremaining&gt;0ï¼Œåˆ™CASåœ°é‡æ–°è®¾ç½®çŠ¶æ€ï¼Œæ›´æ–°å°¾remainingï¼Œè¿”å›remaining compareAndSetState(available, remaining)) return remaining; } } å›åˆ°acquireShared()ï¼Œå¦‚æœè·å–åŒæ­¥å¤±è´¥ï¼Œåˆ™æ‰§è¡ŒdoAcquireShared()è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè‡ªæ—‹è·å– 1234567891011121314151617181920212223242526272829303132333435private void doAcquireShared(int arg) { //æ„é€ ä¸€ä¸ªå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨ final Node node = addWaiter(Node.SHARED); //è·å–æˆåŠŸå¦ boolean failed = true; try { //æ˜¯å¦è¢«ä¸­æ–­ boolean interrupted = false; for (;;) { //è·å–å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); if (p == head) { //åªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹æ—¶æ‰å¯ä»¥å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼ŒåŸå› å‰é¢å·²è®²è¿‡ int r = tryAcquireShared(arg); //è¿”å›å€¼å¤§äº0ä»£è¡¨è·å–æˆåŠŸ if (r &gt;= 0) { //å°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¦‚æœè¿˜æœ‰å‰©ä½™èµ„æºï¼Œåˆ™ç»§ç»­ä¼ æ’­å”¤é†’åé©±èŠ‚ç‚¹ä¸­å±äºå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹ setHeadAndPropagate(node, r); p.next = null; // help GC if (interrupted) selfInterrupt(); failed = false; return; } } //è·å–å¤±è´¥ï¼Œåˆ™åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åº”è¯¥é˜»å¡ï¼Œå¦‚æœåº”è¯¥é˜»å¡ï¼Œåˆ™å°†å…¶é˜»å¡å¹¶æ£€æŸ¥ä¸­æ–­ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; } } finally { if (failed) cancelAcquire(node); } } æ€»ä½“é€»è¾‘å’Œç‹¬å å¼çš„ç›¸åŒï¼Œä½†å› æ˜¯å…±äº«å¼çš„ï¼Œæ‰€æœ‰åœ¨è·å–äº†åŒæ­¥çŠ¶æ€åéœ€è¦ç»§ç»­å”¤é†’åé©±èŠ‚ç‚¹ï¼Œæ— æ¡ä»¶ä¼ æ’­ä¸‹å»ã€‚æ¥ä¸‹æ¥çœ‹setHeadAndPropagateçš„å®ç°ï¼š 12345678910111213private void setHeadAndPropagate(Node node, int propagate) { //è·å–æ—§çš„å¤´èŠ‚ç‚¹åé¢ä¼šç”¨åˆ° Node h = head; //å°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ setHead(node); //propagate &gt; 0 ä»£è¡¨è¿˜æœ‰å‰©ä½™åŒæ­¥çŠ¶æ€ if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) { Node s = node.next; if (s == null || s.isShared()) doReleaseShared(); } } å…³äºä¸ºä»€ä¹ˆä¸åªç”¨propagate &gt; 0 æ¥åˆ¤æ–­ï¼Œä»¥åŠPROPAGATEçš„æ„ä¹‰ï¼Œå¦ä¸€ä¸ªåšä¸»çš„è¿™ç¯‡æ–‡ç« åšäº†å¾ˆè¯¦ç»†çš„è§£é‡Šï¼šhttps://www.cnblogs.com/micrari/p/6937995.html é‡Šæ”¾ï¼š1234567public final boolean releaseShared(int arg) { if (tryReleaseShared(arg)) {//å°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€ doReleaseShared(); return true; } return false; } doReleaseShared() å¦‚ä¸‹ï¼šå…±äº«æ¨¡å¼ä¸‹ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€ 1234567891011121314151617181920212223private void doReleaseShared() { for (;;) { Node h = head; //å¤´èŠ‚ç‚¹éç©ºä¸”ä¸ç­‰äºå°¾èŠ‚ç‚¹ if (h != null &amp;&amp; h != tail) { //è·å–å¤´èŠ‚ç‚¹çŠ¶æ€ int ws = h.waitStatus; //å¦‚æœçŠ¶æ€ä¸ºSIGNALï¼Œåˆ™CASå°†å…¶çŠ¶æ€æ”¹ä¸º0ï¼Œå¦‚æœCASå¤±è´¥ï¼Œåˆ™ä¸€ç›´å¾ªç¯ï¼Œå¦‚æœæˆåŠŸåˆ™å”¤é†’åé©±èŠ‚ç‚¹ if (ws == Node.SIGNAL) { if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; unparkSuccessor(h); } else if (ws == 0 &amp;&amp; //å¦‚æœçŠ¶æ€ä¸º0ï¼Œåˆ™æ”¹ä¸ºPROPAGATEï¼Œä»¥ç¡®ä¿é‡Šæ”¾åç»§ç»­ä¼ æ’­ !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; // loop on failed CAS } //è¿™é‡Œï¼Œå¦‚æœå¤´èŠ‚ç‚¹åœ¨æ”¹å˜äº†ï¼Œåˆ™ç»§ç»­å¾ªç¯ï¼Œå¦åˆ™ç›´æ¥break if (h == head) break; } } AQSä¸­çš„æ¡ä»¶é˜Ÿåˆ—ConditionObjectå‰é¢å·²ç»ä»‹ç»äº†Conditionæ¥å£ï¼Œè€ŒConditionObjectæ˜¯Conditionçš„ä¸€ä¸ªå®ç°ç±»ï¼Œä¸ºå•å‘é“¾è¡¨ã€‚è¯¥æ¡ä»¶é˜Ÿåˆ—çš„èŠ‚ç‚¹ä¹Ÿæ˜¯ä½¿ç”¨äº†å†…éƒ¨ç±»Nodeï¼Œå¯ä»¥åœ¨ä¸æ»¡è¶³æŸä¸ªæ¡ä»¶çš„æ—¶å€™æŒ‚èµ·çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶çš„æ—¶å€™åœ¨å”¤é†’çº¿ç¨‹ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹è¯¥ç±»çš„æˆå‘˜å˜é‡ï¼š 12345678//ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹private transient Node firstWaiter;//ç­‰å¾…é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹private transient Node lastWaiter; //åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°ä¸­æ–­ private static final int REINTERRUPT = 1;//åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºInterruptedExceptionprivate static final int THROW_IE = -1; ä¸€ä¸ª Condition åŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ã€‚Condition.await()æ–¹æ³•ï¼Œå°†ä¼šä»¥å½“å‰çº¿ç¨‹æ„é€ èŠ‚ç‚¹ï¼Œå¹¶å°†èŠ‚ç‚¹ä»å°¾éƒ¨åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚ 1.å…ˆçœ‹await()æ–¹æ³•ï¼š12345678910111213141516171819202122232425262728public final void await() throws InterruptedException { //1,å¦‚æœä¸­æ–­ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ if (Thread.interrupted()) throw new InterruptedException(); //2.å°†å½“å‰çº¿ç¨‹åŠ å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ— Node node = addConditionWaiter(); //3.é‡Šæ”¾å½“å‰é”ï¼Œå¹¶å”¤é†’åé©±èŠ‚ç‚¹ï¼Œè¿”å›é‡Šæ”¾å‰çš„åŒæ­¥çŠ¶æ€ int savedState = fullyRelease(node); int interruptMode = 0; //4.å¾ªç¯åˆ¤æ–­å½“å‰nodeæ˜¯å¦å·²ç»è½¬ç§»åˆ°AQSé˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°æˆåŠŸè½¬ç§»åˆ°AQSé˜Ÿåˆ—ç»“æŸå¾ªç¯ while (!isOnSyncQueue(node)) { //4.1 é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¢«unparkæˆ–ä¸­æ–­ LockSupport.park(this); //4.2å¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼Œåˆ™è¦æ£€æŸ¥ä¸­æ–­ï¼Œå¹¶æ£€æŸ¥èŠ‚ç‚¹å·²ç»åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚å·²åŠ å…¥ï¼Œåˆ™break if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; } if (acquireQueued(node, savedState) //5.æ­»å¾ªç¯é‡æ–°è·å–åŒæ­¥çŠ¶æ€ï¼ˆåˆšåˆšé‡Šæ”¾äº†å¤šå°‘è¿™é‡Œå°±è·å–å¤šå°‘ï¼‰ï¼Œè¿”å›falseè·å–æˆåŠŸï¼Œè¿”å›trueè·å–å¤±è´¥ &amp;&amp; interruptMode != THROW_IE) //6.å¦‚æœè¢«signalåå‘ç”Ÿä¸­æ–­ interruptMode = REINTERRUPT;//å°†ä¸­æ–­æ¨¡å¼æ”¹ä¸ºREINTERRUPT if (node.nextWaiter != null) //7. åˆ é™¤å–æ¶ˆçš„åé©±èŠ‚ç‚¹ unlinkCancelledWaiters(); if (interruptMode != 0) //8.å¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœä¸ºREINTERRUPTåˆ™ä¸­æ–­å½“å‰çº¿ç¨‹ reportInterruptAfterWait(interruptMode); } æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—çš„æ–¹æ³•addConditionWaiter()ï¼š 1234567891011121314151617181920212223242526Node(Thread thread, int waitStatus) { // Used by Condition this.waitStatus = waitStatus; this.thread = thread; } private Node addConditionWaiter() { //è·å–å°¾èŠ‚ç‚¹ Node t = lastWaiter; //å¦‚æœå°¾èŠ‚ç‚¹çŠ¶æ€ä¸ºCANCELï¼Œåˆ™ç§»é™¤å®ƒ if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) { //æ¸…é™¤CANCELçš„èŠ‚ç‚¹ï¼Œå°†æ‰€æœ‰CONDITIONçš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ unlinkCancelledWaiters(); //é‡æ–°æŒ‡å‘lastWaiter t = lastWaiter; } //æ„å»ºä¸€ä¸ªæ–°çš„conditionç±»å‹NodeåŠ å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ— Node node = new Node(Thread.currentThread(), Node.CONDITION); //å¦‚æœå°¾èŠ‚ç‚¹æ­¤æ—¶ä¸ºç©ºï¼Œåˆ™é‡æ–°åˆå§‹åŒ–é¦–å°¾ç›¸åŒçš„é˜Ÿåˆ— if (t == null) firstWaiter = node; else //å°†å°¾èŠ‚ç‚¹çš„åé©±å¼•ç”¨æŒ‡å‘å½“å‰èŠ‚ç‚¹ t.nextWaiter = node; //æ›´æ–°å°¾èŠ‚ç‚¹ lastWaiter = node; return node; } ä¸Šè¿°èŠ‚ç‚¹å¼•ç”¨æ›´æ–°çš„è¿‡ç¨‹å¹¶æ²¡æœ‰ä½¿ç”¨ CAS ä¿è¯ï¼ŒåŸå› åœ¨äºè°ƒç”¨ await()æ–¹æ³•çš„çº¿ç¨‹å¿…å®šæ˜¯è·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥è¿‡ç¨‹æ˜¯ç”±é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚ unlinkCancelledWaiters()æºç ï¼š 123456789101112131415161718192021222324252627private void unlinkCancelledWaiters() { //è·å–é¦–èŠ‚ç‚¹ Node t = firstWaiter; //ä¿å­˜å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„å¼•ç”¨ Node trail = null; while (t != null) { //è·å–åé©±èŠ‚ç‚¹ Node next = t.nextWaiter; //å¦‚æœå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€éCONDITIONï¼Œåˆ™ç§»é™¤å¹¶å°†æ•´ä¸ªé“¾è¡¨è¿æ¥èµ·æ¥ if (t.waitStatus != Node.CONDITION) { //æ–­å¼€å½“å‰èŠ‚ç‚¹çš„åé©±å¼•ç”¨ t.nextWaiter = null; if (trail == null) //é¦–èŠ‚ç‚¹æŒ‡å‘ä¸‹å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ firstWaiter = next; else //å‰é©±èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™è®©å‰é©±èŠ‚ç‚¹ç›´æ¥è·¨è¿‡å½“å‰èŠ‚ç‚¹æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ trail.nextWaiter = next; if (next == null) lastWaiter = trail; } else //å½“å‰èŠ‚ç‚¹çŠ¶æ€ä¸ºCONDITIONï¼Œåˆ™è®©trailæŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹é¡ºä¸ºä¸‹ä¸ªèŠ‚ç‚¹ trail = t; t = next; } } å½»åº•é‡Šæ”¾é”fullyRelease(Node node)å³æ— è®ºå¤šå°‘æ¬¡é‡å…¥ï¼Œé€šé€šæ¸…é›¶ 12345678910111213141516171819final int fullyRelease(Node node) { boolean failed = true; try { //è·å–å½“å‰åŒæ­¥çŠ¶æ€ int savedState = getState(); //è°ƒç”¨releaseæ–¹æ³•é‡Šæ”¾å¹¶å”¤é†’ä¸‹ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹ if (release(savedState)) { failed = false; return savedState; } else { //å¦‚æœé‡Šæ”¾å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ throw new IllegalMonitorStateException(); } } finally { if (failed) //å¦‚æœå¤±è´¥ï¼Œåˆ™å–æ¶ˆå½“å‰èŠ‚ç‚¹ node.waitStatus = Node.CANCELLED; } } isOnSyncQueue(Node node):å¦‚æœè¯¥èŠ‚ç‚¹ä¹‹å‰åœ¨æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œä½†ç°åœ¨åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåˆ™è¿”å›trueï¼›å¦‚æœä¸åœ¨åŒæ­¥é˜Ÿåˆ—è¿”å›false 12345678910111213141516171819202122//nodeä¸ºå½“å‰å°¾èŠ‚ç‚¹final boolean isOnSyncQueue(Node node) { //nodeçš„çŠ¶æ€ä¸ºCONDITIONæˆ–nodeçš„å‰é©±ä¸ºç©ºï¼Œåˆ™è¯´æ˜ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºé˜Ÿåˆ—é™¤å¤´èŠ‚ç‚¹å¤–çš„å…¶ä»–èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹éƒ½ä¸ä¸º if (node.waitStatus == Node.CONDITION || node.prev == null) return false; //å¦‚æœå½“å‰node æœ‰åç»§èŠ‚ç‚¹ï¼Œåˆ™è¯´æ˜å…¶åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ if (node.next != null) return true; //åˆ°æ­¤æ–¹æ³•å°±è¯´æ˜å½“å‰å°¾èŠ‚ç‚¹å‰é©±ä¸ä¸ºç©ºï¼Œä¸”åé©±ä¸ºç©ºï¼Œæ­¤æ—¶å¯ä»¥è®¤ä¸ºnodeæ­£å¤„äºæ”¾å…¥åŒæ­¥é˜Ÿåˆ—enqæ–¹æ³•ä¸­çš„compareAndSetTail(t, node)æ“ä½œä¸­ï¼Œå‰é¢å·²ç»åˆ†æè¿‡ï¼Œæ­¤æ—¶å·²ç»è¿æ¥å¥½äº†preä½†æ²¡æœ‰è¿æ¥nextï¼Œè€Œè¿™ä¸ªCASæ“ä½œæœ‰å¯èƒ½å¤±è´¥ï¼Œæ‰€ä»¥é€šè¿‡findNodeFromTailå†å°è¯•ä¸€æ¬¡åˆ¤æ–­ã€‚ return findNodeFromTail(node); } //è¯¥æ–¹æ³•ä¸­é€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯ä»åŒæ­¥é˜Ÿåˆ—çš„å°¾åˆ°å‰éå†å¯»æ‰¾å½“å‰èŠ‚ç‚¹ï¼Œå¦‚æœæ‰¾åˆ°è¿”å›tureï¼Œå¦åˆ™è¿”å›false private boolean findNodeFromTail(Node node) { Node t = tail; for (;;) { if (t == node) return true; if (t == null) return false; t = t.prev; } } checkInterruptWhileWaiting(Node node)æ£€æŸ¥æ˜¯å¦ä¸­æ–­ï¼Œå¦‚æœåœ¨signalä¹‹å‰ä¸­æ–­ï¼Œåˆ™è¿”å›THROW_IEï¼Œå¦‚æœåœ¨signalä¹‹åï¼Œåˆ™è¿”å›REINTERRUPTï¼Œå¦‚æœæ²¡æœ‰ä¸­æ–­ï¼Œåˆ™ä¸º0ã€‚ 123456private int checkInterruptWhileWaiting(Node node) { return Thread.interrupted() ? //å¦‚æœå‘ç”Ÿäº†ä¸­æ–­éœ€è¦è°ƒç”¨transferAfterCancelledWaitä¿è¯ä¸­æ–­çš„çº¿ç¨‹å·²ç»åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ— (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0; } transferAfterCancelledWait(Node node)ä¿è¯ä¸­æ–­çš„çº¿ç¨‹å·²ç»åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ¤æ–­ä¸­æ–­çš„æ—¶å€™ï¼Œæ˜¯å¦æœ‰signalæ–¹æ³•çš„è°ƒç”¨ï¼Œå¦‚æœè¿”å›falseè¡¨ç¤ºåœ¨ä¸­æ–­å‰è¢«signalï¼Œä¹‹åcheckInterruptWhileWaitingè¿”å›REINTERRUPTé‡æ–°ä¸­æ–­ï¼›å¦‚æœè¿”å›trueè¡¨ç¤ºåœ¨ä¸­æ–­åè¢«signalï¼Œä¹‹åcheckInterruptWhileWaitingè¿”å›THROW_IE æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚ 12345678910111213final boolean transferAfterCancelledWait(Node node) { //å°†å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ä»CONDITIONæ”¹ä¸º0ï¼ˆä»è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºisOnSyncQueueæ–¹æ³•ä¸­é€šè¿‡åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸ºCONDITIONæ¥åˆ¤æ–­æ˜¯å¦è¢«è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼‰ if (compareAndSetWaitStatus(node, Node.CONDITION, 0)) { //å¦‚æœCASæˆåŠŸï¼Œè¯´æ˜æ²¡æœ‰è¢«signalï¼Œå¦‚æœè¢«signalï¼Œå…¶çŠ¶æ€ä¼šæ”¹ä¸ºSIGNALï¼ˆåè¾¹ä¼šè®²åˆ°ï¼‰ï¼Œåˆ™åŠ å…¥åŒæ­¥é˜Ÿåˆ— enq(node); return true; } //å¦‚æœçŠ¶æ€CASå¤±è´¥ï¼Œå³nodeçŠ¶æ€ä¸ä¸ºCONDITIONï¼Œè¯´æ˜å·²ç»è¢«signalæˆ–è¢«ä¸­æ–­ï¼Œä½†ä¸èƒ½ä¿è¯å…ˆåé¡ºåºï¼Œé€šè¿‡whileå¾ªç¯ç­‰å¾…nodeå·²ç»è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ— while (!isOnSyncQueue(node)) Thread.yield(); //è¿”å›falseé‡æ–°ä¸­æ–­ return false; } awaitçš„å¸¦è¶…æ—¶æ—¶é—´çš„å…¶ä»–å‡ ä¸ªæ–¹æ³•åŒè¿™ä¸ªåŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯åŠ äº†è¶…æ—¶æ—¶é—´ï¼Œå…·ä½“ä½œç”¨çœ‹ä¸Šé¢çš„Conditionçš„ä»‹ç» 2.å†çœ‹signalç›¸å…³ å°†ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰,ä»æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ç§»è‡³æ‹¥æœ‰é”çš„ç­‰å¾…é˜Ÿåˆ—ã€‚ 12345678public final void signal() { //1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯ç‹¬å æ¨¡å¼ï¼Œå¦‚æœä¸æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); Node first = firstWaiter; if (first != null) doSignal(first); } doSignal(Node first)ä¼šä»ä»é¦–èŠ‚ç‚¹å¼€å§‹éå†ï¼ŒæŠŠç¬¬ä¸€ä¸ªéç©ºã€æ²¡å–æ¶ˆçš„èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ— 123456789private void doSignal(Node first) { do { //åˆ é™¤firstæ¥åœ°é‚£ if ( (firstWaiter = first.nextWaiter) == null) lastWaiter = null; first.nextWaiter = null; } while (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != null); } transferForSignal(Node node) ä¼šå°†èŠ‚ç‚¹ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°AQSé˜Ÿåˆ— 123456789101112131415final boolean transferForSignal(Node node) { //å°è¯•å°†Nodeçš„çŠ¶æ€ä»CONDITIONæ”¹ä¸º0, if (!compareAndSetWaitStatus(node, Node.CONDITION, 0)) //å¦‚æœCASå¤±è´¥ï¼Œè¯´æ˜èŠ‚ç‚¹åœ¨signalå‰è¢«å–æ¶ˆï¼Œè¿”å›falseï¼Œè½¬ç§»å¤±è´¥ return false; //CASæˆåŠŸï¼Œåˆ™å°†è¯¥èŠ‚ç‚¹åŠ å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶è¿”å›ä¹‹å‰çš„tail Node p = enq(node); //è·å–ä¹‹å‰çš„tailçš„çŠ¶æ€ int ws = p.waitStatus; if (ws &gt; 0 //&gt;0ï¼Œå³ä¹‹å‰çš„tailè¢«å–æ¶ˆï¼Œ åˆ™ç›´è¿”å›å”¤é†’å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹ || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))//å¦‚æœæ²¡æœ‰è¢«å–æ¶ˆï¼Œåˆ™å°†åŸtailèŠ‚ç‚¹çŠ¶æ€è®¾ä¸ºSIGNAL,å¦‚æœå¤±è´¥äº†åˆ™ç›´æ¥å”¤é†’å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæˆåŠŸäº†åˆ™å‰é©±èŠ‚ç‚¹è¢«è®¾ä¸ºSIGNAL LockSupport.unpark(node.thread);//å”¤é†’å½“å‰èŠ‚ç‚¹ï¼Œå½“å‰çº¿ç¨‹å¯ä»await()ä¸­çš„park()è¿”å› return true; } å¦å¤–è¿˜æœ‰signalAll()æ–¹æ³•ã€‚å®ç°å°†Conditioné˜Ÿåˆ—ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹è½¬ç§»åˆ°AQSåŒæ­¥é˜Ÿåˆ—å»ç«äº‰é”ï¼ˆç‹¬å ï¼‰ã€‚ æ€»ç»“ï¼šä¸€ä¸ªåŒæ­¥å™¨æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼ˆåŒå‘ï¼‰å’Œå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ˆå•å‘ï¼‰ã€‚è°ƒç”¨ await()ç›¸å…³çš„æ–¹æ³•ï¼Œä¼šè®©å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶é‡Šæ”¾é”ï¼ŒåŒæ—¶çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ä» await()æ–¹æ³•è¿”å›æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¸€å®šè·å–äº† Condition ç»‘å®šçš„é”ã€‚1.è°ƒç”¨ await()ç›¸å…³æ–¹æ³•æ—¶ï¼Œå°†åŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹çš„çº¿ç¨‹è·å–åˆ°äº†é”ï¼Œå°†é€šè¿‡addConditionWaiter()æ–¹æ³•æŠŠå½“å‰çº¿ç¨‹æ„é€ æˆä¸€ä¸ªæ–°çš„èŠ‚ç‚¹å¹¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„åé©±èŠ‚ç‚¹ï¼Œéšåå½“å‰çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚2.ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹é€šè¿‡å…¶ä»–çº¿ç¨‹è°ƒç”¨Condition.signal()æ–¹æ³•è¢«å”¤é†’åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å¼€å§‹å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœæ˜¯é€šè¿‡ä¸­æ–­å”¤é†’ï¼Œåˆ™ä¼šæŠ›å‡ºInterruptedExceptionï¼Œå¦‚æœä¸æ˜¯ï¼Œå°†ä¸­æ–­æ¨¡å¼è®¾ä¸ºREINTERRUPTï¼Œå¹¶å°†è¢«å–æ¶ˆçš„åé©±èŠ‚ç‚¹æ¸…é™¤ã€‚3.è°ƒç”¨signal()æ–¹æ³•ï¼Œä¼šå”¤é†’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼ˆé¦–èŠ‚ç‚¹ï¼‰ï¼Œåœ¨å”¤é†’èŠ‚ç‚¹ä¹‹å‰ï¼Œä¼šå°†è¯¥èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚ä½†å½“å‰çº¿ç¨‹å¿…é¡»æ˜¯è·å–äº†é” ã€‚4.æ¥ç€è·å–ç­‰å¾…é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼Œå°†å…¶å…¨åœ°è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—åå¹¶ä½¿ç”¨ LockSupport .unparkå”¤é†’è¯¥èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ã€‚5.è¢«å”¤é†’çš„çº¿ç¨‹å°±ä¼šä» await()æ–¹æ³•ä¸­çš„ while (!isOnSyncQueue(node))å¾ªç¯ä¸­é€€å‡ºã€‚ï¼ˆisOnSyncQueue(Node node)æ–¹æ³•è¿”å› trueï¼ŒèŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼‰ï¼Œ6.ç„¶åè°ƒç”¨ acquireQueued()æ–¹æ³•åŠ å…¥åˆ°è·å–åŒæ­¥çŠ¶æ€çš„ç«äº‰ä¸­ã€‚æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…è¯´é”ï¼‰ä¹‹åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°†ä»å…ˆå‰è°ƒç”¨çš„ await()æ–¹æ³•è¿”å›ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å·²ç»æˆåŠŸåœ°è·å–äº†é”ã€‚ ï¼ˆéƒ¨åˆ†åˆ†æå¯èƒ½æœ‰ç‘•ç–µï¼Œè¿˜è¯·æŒ‡æ­£ï¼Œæ„Ÿè°¢~ï¼‰ ä¸‹ä¸€ç¯‡è®²Lockçš„å®ç°ç±»ï¼š javaå¹¶å‘ç¼–ç¨‹ä¹‹ReentrantLockå’Œè¯»å†™é”","link":"/posts/20200204-lcAQS.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹ReentrantLockå’Œè¯»å†™é”ReentrantReadWriteLock","text":"åœ¨å‰æ–‡javaå¹¶å‘ç¼–ç¨‹ä¹‹æ˜¾ç¤ºé”Lockã€Conditionæ¥å£ã€LockSupportä»¥åŠAQSï¼ˆåŒæ­¥é˜Ÿåˆ—ã€æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼‰è¯¦è§£å·²ç»å¯¹Lockã€Conditionä»¥åŠAQSç›¸å…³è¿›è¡Œäº†ä»‹ç»ï¼Œæ¥ä¸‹æ¥å°±è¦è®²ä¸€è®²Lockæ¥å£çš„å‡ ä¸ªå®ç°ç±»ï¼šReentrantLockã€ReentrantReadWriteLockåŠå…¶å†…éƒ¨ç±»ReadLockå’ŒWriteLockã€‚æœ¬æ–‡ä¸­å¸¦â–³â–³çš„æ ‡æ³¨ä»£è¡¨å‰æ–‡å·²è®²è¿‡ï¼Œä¸è¯¦è¿°ã€‚ é¦–å…ˆäº†è§£ä¸‹é”çš„å¯é‡å…¥çš„æ¦‚å¿µï¼š ä¸€ã€é”çš„å¯é‡å…¥â€œé‡å…¥â€œæ˜¯æŒ‡çº¿ç¨‹åœ¨è·å–åˆ°é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«é˜»å¡ï¼Œå› æ­¤ï¼š1ï¼‰çº¿ç¨‹å†æ¬¡è·å–é”æ—¶ï¼Œéœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡æˆåŠŸè·å–ã€‚2ï¼‰çº¿ç¨‹è·å–äº†å‡ æ¬¡é”ï¼Œå°±éœ€è¦é‡Šæ”¾å‡ æ¬¡é”ï¼Œåªæœ‰å…¨éƒ¨é‡Šæ”¾å®Œæ¯•ï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½è·å¾—é”ï¼Œå› æ­¤éœ€è¦å¯¹é”çš„è·å–è¿›è¡Œè‡ªå¢è®¡ç®—ï¼Œè‡ªå¢æ¬¡æ•°è¡¨ç¤ºå½“å‰é”è¢«é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œé”è¢«é‡Šæ”¾æ—¶ï¼Œæ¯æ¬¡é‡Šæ”¾è¯¥è®¡æ•°éƒ½è‡ªå‡1ç›´åˆ°å‡åˆ°0æ—¶è¡¨ç¤ºæˆåŠŸé‡Šæ”¾é”ã€‚ äºŒã€ReentrantLock2.1 ç±»å›¾ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼š1.ReentrantLockå®ç°äº†Lockæ¥å£2.å†…éƒ¨ç±»Syncç»§æ‰¿äº†AQS3. FairSyncå’ŒNocfairSyncç»§æ‰¿äº†Sync å¦å¤–ï¼ŒReentrantLockæ˜¯å¯é‡å…¥çš„ç‹¬å é”ï¼Œå› æ­¤ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯è·å–é”ï¼Œè€Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡åœ¨AQSé˜Ÿåˆ—ï¼Œé’ˆå¯¹è·å–é”ï¼Œå…¶æä¾›äº†å…¬å¹³å’Œéå…¬å¹³çš„å®ç°ï¼Œè€Œå…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼ä¸»è¦é€šè¿‡ReentrantLockçš„æ„é€ æ–¹æ³•ç¡®å®šçš„ï¼Œå¦‚ä¸‹ï¼š 123456public ReentrantLock() { sync = new NonfairSync();}public ReentrantLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync();} é»˜è®¤æ„é€ å‡½æ•°ä¸­ï¼Œå®ç°äº†éå…¬å¹³çš„å®ç°ï¼Œè€Œå¸¦å‚çš„æ„é€ å‡½æ•°ï¼Œå‚æ•°fairä¸ºtrueæ—¶ä¸ºå…¬å¹³å®ç°ï¼Œä¸ºfalseæ—¶ä¸ºéå…¬å¹³å®ç°ã€‚ ReentrantLockçš„æˆå‘˜å˜é‡åªæœ‰ä¸€ä¸ªSyncå¯¹è±¡ï¼š 1private final Sync sync; å…¶æˆå‘˜å‡½æ•°é™¤äº†å®ç°Lockæ¥å£æä¾›çš„å‡ ä¸ªæ–¹æ³•å¤–ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå…¶ä»–æ–¹æ³•éƒ½æ˜¯å¾ˆç®€å•ï¼Œå¦‚è·å–ç­‰å¾…é˜Ÿåˆ—é•¿åº¦ã€è·å–ç­‰å¾…çš„çº¿ç¨‹ç­‰å¾…ã€‚ï¼ˆè¿™å‡ ä¸ªæ–¹æ³•çš„ä»‹ç»åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ‰ä»‹ç»ï¼‰è€Œå¯¹è¿™å‡ ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼Œéƒ½æ˜¯æ ¹æ®Syncå®ç°äº†å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚ ä¸‹é¢å…ˆè®²éå…¬å¹³é”çš„ç›¸å…³æ–¹æ³•ï¼š 2.2 éå…¬å¹³æ¨¡å¼ä»¥ä¸‹æ˜¯éå…¬å¹³é”çš„lock()æ–¹æ³•ï¼š 2.2.1 lock()123456final void lock() { if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else acquire(1);} è¯¥æ–¹æ³•ä¸­ï¼š1.é¦–å…ˆè°ƒç”¨compareAndSetState(0, 1)å°è¯•å°†çŠ¶æ€å€¼ä»0æ”¹ä¸º1ï¼Œå¦‚æœCASæˆåŠŸï¼Œè¡¨ç¤ºé”å·²ç»è¢«å½“å‰çº¿ç¨‹å ç”¨ï¼Œåˆ™å°†å½“å‰çº¿ç¨‹è®¾ä¸ºæœ‰ç‹¬å è®¿é—®æƒçš„çº¿ç¨‹2.å¦‚æœCASå¤±è´¥ï¼Œè¡¨ç¤ºé”å·²ç»è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œåˆ™è°ƒç”¨acquire(1)æ–¹æ³•å°è¯•è·å–é”ã€‚ â–³â–³acquire(1)ä¸ºAQSä¸­çš„æ–¹æ³•ï¼š 12345public final void acquire(int arg) { if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); } å…¶ä¸­tryAcquire()ä¸ºå°è¯•è·å–é”çš„æ¨¡æ¿æ–¹æ³•ï¼Œè¿™é‡Œçš„å…·ä½“å®ç°å°±æ˜¯è°ƒç”¨äº†NonfairSyncä¸‹çš„éå…¬å¹³å®ç°æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334protected final boolean tryAcquire(int acquires) { return nonfairTryAcquire(acquires); }final boolean nonfairTryAcquire(int acquires) { //è·å–å½“å‰çº¿ç¨‹ final Thread current = Thread.currentThread(); //å½“å‰å½“å‰åŒæ­¥çŠ¶æ€ int c = getState(); //å¦‚æœçŠ¶æ€ä¸º0ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰é” if (c == 0) { //é‡å¤lock()ä¸­çš„ç¬¬ä¸€ä¸ªifè¯­å¥ if (compareAndSetState(0, acquires)) { setExclusiveOwnerThread(current); return true; } } //å¦‚æœçŠ¶æ€ä¸ä¸º0ï¼Œä»£è¡¨å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é” // åˆ™åˆ¤æ–­å½“å‰æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ else if (current == getExclusiveOwnerThread()) { // å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é” // 1.è®©å½“å‰çŠ¶æ€åŠ ä¸Šacquires(å¯é‡å…¥å°±åœ¨è¿™é‡Œä½“ç°ï¼Œè¿›è¡Œè‡ªå¢) int nextc = c + acquires; //2. å¦‚æœåŠ ä¸Šacquiresåçš„çŠ¶æ€å€¼ä»å°äº0 if (nextc &lt; 0) //è¯´æ˜æº¢å‡ºäº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new Error(\"Maximum lock count exceeded\"); // å¦‚æœå¤§äº0ï¼Œåˆ™æ›´æ–°å½“å‰çŠ¶æ€ setState(nextc); //è¿”å›true return true; } // å¦‚æœä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›falseï¼Œå°è¯•è·å–å¤±è´¥ return false; } ç®€å•æ€»ç»“ä¸€ä¸‹æµç¨‹ï¼š1.é¦–å…ˆåˆ¤æ–­å½“å‰çŠ¶æ€å€¼stateæ˜¯å¦ç­‰äº0ï¼Œå¦‚æœç­‰äº0åˆ™è¯´æ˜æ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œè¿›å…¥2ï¼Œå¦åˆ™è¿›å…¥32. CASæ›´æ–°çŠ¶æ€å€¼ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„3.åˆ¤æ–­å½“å‰æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™è‡ªå¢çŠ¶æ€å€¼ï¼Œå¦åˆ™è¿”å›falseï¼›è‡ªå¢çŠ¶æ€æ—¶éœ€æ£€æŸ¥è‡ªå¢åçš„çŠ¶æ€å€¼ï¼Œå¦‚æœå¤§äº0ï¼Œåˆ™æ›´æ–°stateï¼Œå¦‚æœå°äº0ï¼Œè¯´æ˜æº¢å‡ºï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ è€Œå¦‚æœè·å–å¤±è´¥äº†åˆ™ä¼šæ‰§è¡ŒAQSçš„acquireQueued(addWaiter(Node.EXCLUSIVE), arg))æ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹æ„é€ ä¸ºä¸€ä¸ªç‹¬å æ¨¡å¼çš„èŠ‚ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºé¦–èŠ‚ç‚¹ï¼Œæ‰å¯ä»¥å°è¯•è·å–é”ï¼Œå¦åˆ™è·³è¿‡å¤„äºCANCELçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ›´æ–°ä¸ºSIGNALé˜»å¡è‡ªèº«ç­‰å¾…å”¤é†’ã€‚ä»¥ä¸Šå°±æ˜¯lock()çš„éå…¬å¹³å®ç°ï¼Œäº†è§£äº†å…¶å¯é‡å…¥çš„å®ç°æ ¸å¿ƒï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªè‡ªå·±çš„ä¸å¯é‡å…¥çš„ç‹¬å é”ï¼Œå°±å¾ˆç®€å•äº†ã€‚ä¸»è¦å°±æ˜¯ä¿®æ”¹tryAcquire(int arg) æ–¹æ³•ï¼Œå¦‚æœCASæˆåŠŸï¼Œåˆ™å°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„ï¼Œå¦åˆ™ç›´æ¥è¿”å›falseï¼Œä¸è¿›è¡ŒæŒæœ‰é”æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹çš„åˆ¤æ–­ç­‰ç›¸å…³æ“ä½œã€‚ 123456789/*è·å¾—é”*/ @Override protected boolean tryAcquire(int arg) { if(compareAndSetState(0,1)){ setExclusiveOwnerThread(Thread.currentThread()); return true; } return false; } 2.2.2 unlock()ReentrantLockçš„unlock()ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨äº†AQSçš„â–³â–³release()æ–¹æ³•ï¼š 123456789101112ï¼ˆReentrantLockï¼‰public void unlock() { sync.release(1); }ï¼ˆAQSï¼‰public final boolean release(int arg) { if (tryRelease(arg)) { Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; } return false;} è¯¥æ–¹æ³•çš„tryRelease(arg)ä¹Ÿæ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œåœ¨ReentrantLockçš„å®ç°å¦‚ä¸‹ï¼šï¼ˆéå…¬å¹³å’Œå…¬å¹³æ¨¡å¼åªæ˜¯é’ˆå¯¹lockè¿‡ç¨‹ï¼Œreleaseçš„å®ç°æ˜¯ç›¸åŒçš„ï¼‰ 12345678910111213141516171819protected final boolean tryRelease(int releases) { // è®¡ç®—å½“å‰çŠ¶æ€å‡å»releasesåçš„å€¼ int c = getState() - releases; // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ç‹¬å æ¨¡å¼çš„ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); // å¯ä»¥ç†è§£ä¸ºæ˜¯å¦å½»åº•é‡Šæ”¾ boolean free = false; // å¦‚æœcä¸º0ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹å·²ç»å°†é”é‡Šæ”¾å®Œæ¯•ï¼Œå³é‡å…¥çš„æ¬¡æ•°éƒ½å·²é‡Šæ”¾ if (c == 0) { // ç½®ä¸ºtrueï¼Œè¡¨ç¤ºå·²å½»åº•é‡Šæ”¾ free = true; // å°†å½“å‰ç‹¬å çº¿ç¨‹æ¸…ç©º setExclusiveOwnerThread(null); } // å¦‚æœè‡ªå‡ä¸€åçš„stateä¸ä¸º0ï¼Œè¯´æ˜å°šæœªé‡Šæ”¾å®Œæ¯•ï¼Œè¿”å›false setState(c); return free; } æµç¨‹ç®€å•çš„å°†å°±æ˜¯ï¼šå¦‚æœå½“å‰çŠ¶æ€è‡ªå‡1åä¸º0ï¼Œåˆ™è¯´æ˜é”é‡Šæ”¾å®Œæ¯•ï¼Œæƒ…å†µç‹¬å é”ï¼›å¦‚æœä¸ä¸º0ï¼Œåˆ™è¯´æ˜é‡å…¥é”æœªé‡Šæ”¾å®Œæ¯•ï¼Œä»æŒæœ‰èµ„æº å¦‚æœè¿”å›falseï¼Œå°±ä¼šç»§ç»­æ‰§è¡Œrelease()çš„â–³â–³unparkSuccessor(h);æ–¹æ³•å”¤é†’åé©±èŠ‚ç‚¹ã€‚è€Œåé©±èŠ‚ç‚¹è¢«å”¤é†’åå°±ä¼šå†æ¬¡æ‰§è¡ŒacquireQueued() 1234567891011121314final boolean acquireQueued(final Node node, int arg) { .............. boolean interrupted = false; for (;;) { final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) { setHead(node); p.next = null; // help GC failed = false; return interrupted; } ............. } } æ­¤æ—¶p==headæˆç«‹ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºheadï¼Œä¸åŸheadæ–­å¼€ï¼Œå¹¶è¿”å›ä¸­æ–­æ ‡å¿—ï¼Œæ­¤æ—¶å¦‚æ²¡æœ‰è¢«ä¸­æ–­ï¼Œå°±ç›´æ¥ä»acquire()æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚ 2.3 å…¬å¹³æ¨¡å¼lock()æ–¹æ³•ï¼šè¯¥lockæ–¹æ³•ä¹Ÿæ˜¯å®ç°äº†AQSçš„acquire()æ–¹æ³•ï¼Œä½†æ˜¯æ˜¯åœ¨FairSyncå®ç°äº†å…¬å¹³æ¨¡å¼è·å–é”ï¼š 1234567891011121314151617181920protected final boolean tryAcquire(int acquires) { final Thread current = Thread.currentThread(); int c = getState(); if (c == 0) { if (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(0, acquires)) { setExclusiveOwnerThread(current); return true; } } else if (current == getExclusiveOwnerThread()) { int nextc = c + acquires; if (nextc &lt; 0) throw new Error(\"Maximum lock count exceeded\"); setState(nextc); return true; } return false; } } ä»æºç å¯ä»¥çœ‹å‡ºï¼Œåªæ˜¯åœ¨å½“å‰çŠ¶æ€å€¼ä¸º0æ—¶ï¼Œå³æ²¡æœ‰çº¿ç¨‹æŒæœ‰é”æ—¶å¢åŠ äº†ä¸€ä¸ªhasQueuedPredecessors()åˆ¤æ–­ï¼Œæºç å¦‚ä¸‹ï¼š 12345678public final boolean hasQueuedPredecessors() { Node t = tail; Node h = head; Node s; return h != t &amp;&amp; //1.å¤´å°¾èŠ‚ç‚¹ä¸ç›¸åŒï¼Œè¯´æ˜é˜Ÿåˆ—éç©ºï¼Œå¦‚æœé˜Ÿåˆ—ç©ºï¼Œåˆ™è¿”å›falseï¼Œè¯´æ˜æ²¡æœ‰çº¿ç¨‹åœ¨ç­‰å¾… ((s = h.next) == null || s.thread != Thread.currentThread());//2. é˜Ÿåˆ—éç©ºï¼Œå¦‚æœç­‰å¾…çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›trueï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›true } è¯¥æ–¹æ³•è¿”å›å½“å‰ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œtrueè¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œfalseè¡¨ç¤ºæ²¡æœ‰å¦‚æœè¿”å›falseï¼Œåˆ™ç»§ç»­è¿›è¡Œåé¢çš„æ­¥éª¤ï¼ŒåŒéå…¬å¹³æ­¥éª¤ç›¸åŒ å¯è§ï¼Œå…¬å¹³é”ä¼šè€ƒè™‘çº¿ç¨‹ç­‰å¾…çš„ä¼˜å…ˆé¡ºåºï¼Œè€Œéå…¬å¹³é”ä¸è€ƒè™‘é¡ºåºï¼Œè°æ¥è°å°±å»äº‰å¤ºé”ã€‚ ä¸‰ã€è¯»å†™é”ReentrantReadWriteLockåœ¨è¯»å¤šå†™çš„åœºæ™¯ä¸‹ï¼Œè¯¥é”å°±éå¸¸é€‚ç”¨ã€‚è¯¥ç±»ç»´æŠ¤äº†ä¸€ä¸ªè¯»é”ReadLockå’Œä¸€ä¸ªå†™é”WriteLockã€‚ å…³äºå†™é”ï¼š1.å†™é”æ˜¯ä¸€ä¸ªæ”¯æŒå¯é‡å…¥çš„æ’å®ƒé”ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å¢åŠ å†™çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–å†™é”æ—¶ï¼Œè¯»é”å·²ç»è¢«è·å–ï¼ˆè¯»çŠ¶æ€ä¸ä¸º 0ï¼‰æˆ–è€…è¯¥çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚2.å¦‚æœè¯»é”è¢«è·å–ï¼Œåˆ™å†™é”ä¸èƒ½è¢«è·å–ã€‚ å› ä¸ºè¯»å†™é”è¦ä¿è¯å†™é”çš„æ“ä½œå¯¹è¯»é”å¯è§ï¼Œå¦‚æœè¯»é”å·²è¢«è·å–ï¼Œåˆå¯¹å†™é”è·å–ï¼Œé‚£ä¹ˆå…¶ä»–è¯»çº¿ç¨‹å°±æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚å› æ­¤ï¼Œå†™é”è¢«å½“å‰çº¿ç¨‹è·å–çš„å‰ææ˜¯å…¶ä»–è¯»çº¿ç¨‹å…¨éƒ¨é‡Šæ”¾è¯»é”ï¼Œ3.å†™é”ä¸€æ—¦è¢«è·å–ï¼Œåˆ™å…¶ä»–è¯»å†™çº¿ç¨‹çš„è®¿é—®å‡è¢«é˜»å¡ã€‚å…³äºè¯»é”ï¼š1.è¯»é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„å…±äº«é”ï¼Œå®ƒèƒ½å¤Ÿè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–ã€‚2.åœ¨å†™é”æ²¡æœ‰è¢«è·å–æ—¶ï¼Œè¯»é”å¯ä»¥è¢«å¤šæ¬¡è·å–ã€‚è·å–æˆåŠŸåˆ™å®‰å…¨åœ°å¢åŠ è¯»çŠ¶æ€ï¼ˆè¯¥çŠ¶æ€æ˜¯æ‰€æœ‰çº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°å’Œï¼Œä½†æ¯ä¸ªçº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°ä¿å­˜åœ¨ThreadLocalä¸­ï¼‰3.å¦‚æœåœ¨è·å–è¯»é”æ—¶ï¼Œå†™é”è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™å½“å‰çº¿ç¨‹é˜»å¡ç­‰å¾… å…³äºé”çš„å‡é™çº§ï¼š1.é”é™çº§æŒ‡çš„æ˜¯å†™é”é™çº§ä¸ºè¯»é”ï¼šå½“å‰æŒæœ‰å†™é”ï¼ŒåŒæ—¶å†å»è·å–è¯»é”ï¼Œæœ€åå†é‡Šæ”¾å†™é”2.é”å‡çº§æŒ‡çš„æ˜¯è¯»é”å‡çº§ä¸ºå†™é”ï¼šå½“å‰æŒæœ‰è¯»é”ï¼Œè·å–å†™é”ï¼Œæœ€åé‡Šæ”¾è¯»é”ï¼Œä½†RentrantReadWriteLockä¸æ”¯æŒé”çš„å‡çº§ï¼Œå› ä¸ºå¦‚æœå¤šä¸ªçº¿ç¨‹æŒæœ‰è¯»é”ï¼Œä»»æ„ä¸€ä¸ªçº¿ç¨‹å‡çº§åˆ°äº†å†™é”ï¼Œè¿™æ ·å°±ä¸èƒ½ä¿è¯å†™çº¿ç¨‹çš„æ›´æ–°å¯¹å…¶ä»–è¯»çº¿ç¨‹çš„å¯è§æ€§ã€‚ 3.1 ç±»ç»“æ„ä»å›¾ä¸­å¯ä»¥è§å‡ºï¼š1.ReentrantReadWriteLockå®ç°äº†ReadWriteLockæ¥å£ï¼Œåœ¨è¯¥æ¥å£ä¸­æä¾›äº†ä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”ï¼Œå…¶å…·ä½“å®ç°å°±ReentrantReadWriteLockä¸­çš„è¯»é”å’Œå†™é”ã€‚2.ReentrantReadWriteLockæœ‰5ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«ä¸ºReadLockã€WriteLockã€FairSyncã€NonfairSyncå’ŒSyncï¼Œå…¶ä¸­FairSyncå’ŒNonfairSyncæ˜¯Syncçš„å…¬å¹³å’Œéå…¬å¹³çš„å®ç°ï¼ŒSyncå®ç°äº†AQSï¼Œè¯»é”å’Œå†™é”å®ç°äº†Lockæ¥å£ã€‚3.åœ¨Syncä¸‹åˆæœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼šThreadLocalHoldCounterå’ŒHoldCounter 3.2 Syncé¦–å…ˆçœ‹Syncç±»ï¼šå®ƒçš„ä¸¤ä¸ªå†…éƒ¨ç±»æºç å¦‚ä¸‹ï¼š 123456789101112static final class HoldCounter { int count = 0; final long tid = getThreadId(Thread.currentThread()); }static final class ThreadLocalHoldCounter extends ThreadLocal&lt;HoldCounter&gt; { public HoldCounter initialValue() { return new HoldCounter(); } } å…¶ä¸­HoldCounter å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªcountå˜é‡å’Œä¸€ä¸ªtidï¼Œå…¶ä¸­countè¡¨ç¤ºä¸€ä¸ªè¯»çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°ï¼Œtidè¡¨ç¤ºæŒæœ‰è¯»é”çš„å½“å‰çº¿ç¨‹çš„idï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªçº¿ç¨‹ã€‚è€ŒThreadLocalHoldCounterç»§æ‰¿äº†ThreadLocalï¼Œå¹¶ä¸”å°†HoldCounterä½œä¸ºæ³›å‹ï¼Œé‡å†™äº†ThreadLocalçš„initialValue()æ–¹æ³•ï¼Œå¯ç›´æ¥é€šè¿‡getè·å–å½“å‰çº¿ç¨‹çš„countå€¼ã€‚ åœ¨çœ‹èµ·ç±»å±æ€§å‰ï¼Œå…ˆäº†è§£å…¶è¯»å†™çŠ¶æ€çš„è®¾è®¡ï¼š è¯»å†™çŠ¶æ€çš„è®¾è®¡ï¼šReentrantLock ä¸­ï¼ŒåŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œè¯»å†™é”çš„è‡ªå®šä¹‰åŒæ­¥å™¨éœ€è¦åœ¨åŒæ­¥çŠ¶æ€ï¼ˆæ•´å‹å˜é‡ï¼‰ä¸Šç»´æŠ¤å¤šä¸ªè¯»çº¿ç¨‹å’Œä¸€ä¸ªå†™çº¿ç¨‹çš„çŠ¶æ€ï¼Œå› æ­¤å°±éœ€è¦å¯¹è¯¥éå†è¿›è¡Œâ€œæŒ‰ä½åˆ‡å‰²ä½¿ç”¨â€ã€‚åŒæ­¥çŠ¶æ€çš„é«˜ 16 ä½è¡¨ç¤ºè¯»ï¼ˆè¯»é”çº¿ç¨‹æ•°ï¼‰ï¼Œä½ 16 ä½è¡¨ç¤ºå†™ï¼ˆå†™é”é‡å…¥æ­¤æ•°ï¼‰è¯»å†™é”é€šè¿‡ä½è¿ç®—ç¡®å®šå½“å‰çŠ¶æ€ã€‚å‡è®¾å½“å‰åŒæ­¥çŠ¶æ€å€¼ä¸º Sï¼Œå†™çŠ¶æ€ç­‰äº S&amp;0x0000FFFFï¼ˆå°†é«˜ 16 ä½å…¨éƒ¨æŠ¹å»ï¼‰ï¼Œè¯»çŠ¶æ€ç­‰äº S&gt;&gt;&gt;16ï¼ˆæ— ç¬¦å·è¡¥ 0 å³ç§» 16 ä½ï¼‰ã€‚å½“å†™çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+1ï¼Œå½“è¯»çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+(1&lt;&lt;16)ï¼Œä¹Ÿå°±æ˜¯S+0x00010000ã€‚æ ¹æ®çŠ¶æ€çš„åˆ’åˆ†èƒ½å¾—å‡ºä¸€ä¸ªæ¨è®ºï¼šS ä¸ç­‰äº 0 æ—¶ï¼Œå½“å†™çŠ¶æ€ï¼ˆS&amp;0x0000FFFFï¼‰ç­‰äº 0 æ—¶ï¼Œåˆ™è¯»çŠ¶æ€ï¼ˆS&gt;&gt;&gt;16ï¼‰å¤§äº 0ï¼Œå³è¯»é”å·²è¢«è·å–ã€‚ï¼ˆå›¾ç‰‡æ¥æºäºç½‘ç»œï¼‰ Syncçš„æˆå‘˜å±æ€§å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627 è¯»å†™é”å…±ç”¨åŒæ­¥çŠ¶æ€ï¼Œé«˜16ç”¨äºè¯»ï¼Œä½16ä½ç”¨äºå†™ static final int SHARED_SHIFT = 16;// è¯»é”çš„å•ä½ï¼ˆå› ä¸ºè¯»é”æ˜¯é«˜16ä½ï¼Œå› æ­¤æ¯æ¬¡è¦åŠ ä¸Š2^16ï¼‰ static final int SHARED_UNIT = (1 &lt;&lt; SHARED_SHIFT); // å†™é”çš„æœ€å¤§å¯é‡å…¥æ¬¡æ•°æˆ–è¯»é”å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•° static final int MAX_COUNT = (1 &lt;&lt; SHARED_SHIFT) - 1; // å†™é”æ©ç ï¼Œç”¨äºçŠ¶æ€çš„ä½16ä½æœ‰æ•ˆå€¼ static final int EXCLUSIVE_MASK = (1 &lt;&lt; SHARED_SHIFT) - 1; //è¯»é”çš„è®¡æ•°ï¼Œå½“å‰åŒæ­¥çŠ¶æ€å³ç§»16ä½è·å–è¯»é”è®¡æ•° static int sharedCount(int c) { return c &gt;&gt;&gt; SHARED_SHIFT; } //è·å–å†™çº¿ç¨‹çš„æ•°é‡ï¼ˆè·å–å†™é”çš„é‡å…¥æ¬¡æ•°ï¼‰ static int exclusiveCount(int c) { return c &amp; EXCLUSIVE_MASK; }// ä¿å­˜æœ¬åœ°çº¿ç¨‹è·å–è¯»é”çš„é‡å…¥æ¬¡æ•°ï¼Œå½“å‰çº¿ç¨‹çš„è®¡æ•°å˜ä¸º0æ—¶åˆ é™¤ä¹‹ private transient ThreadLocalHoldCounter readHolds; // è¡¨ç¤ºæœ€åä¸€ä¸ªæˆåŠŸè·å–è¯»é”çš„çº¿ç¨‹çš„è®¡æ•°çš„ç¼“å­˜ /* è·å–å’Œé‡Šæ”¾è¯»é”çš„æ—¶å€™ï¼Œéœ€è¦æ›´æ–°HoldCountï¼Œä¼šå…ˆæ£€æµ‹ç¼“å­˜çš„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­çº¿ç¨‹IDæ˜¯å¦å’Œå½“å‰çº¿ç¨‹IDç›¸åŒ å¦‚æœç›¸åŒï¼Œå°±ç›´æ¥é€šè¿‡ç¼“å­˜æ›´æ–°HoldCount å¦åˆ™ï¼Œä»readHoldsä¸­è·å–HoldCounterå¯¹è±¡ï¼Œèµ‹å€¼ç»™è¯¥ç¼“å­˜ï¼Œæœ€åå†æ›´æ–°HoldCounterçš„è®¡æ•°ï¼ˆä¸ç†è§£çš„è¯éœ€è¦å…ˆçœ‹ä¸‹é¢çš„æºç åˆ†æï¼Œå›å¤´å†çœ‹å°±ç†è§£äº†ï¼‰ */ private transient HoldCounter cachedHoldCounter; //ç¬¬ä¸€ä¸ªè·å¾—è¯»å–é”çš„çº¿ç¨‹ã€‚ï¼ˆè¿™é‡Œä½¿ç”¨æ­¤å˜é‡åº”è¯¥å°±æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå½“åªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–è¯»é”æ—¶ï¼Œå¯ç›´æ¥ä»æ­¤å˜é‡è·å–ï¼Œä¸éœ€è¦æ“ä½œreadHolds.get()äº†ï¼‰ private transient Thread firstReader = null; //æ˜¯firstReaderçš„é‡å…¥æ•°ã€‚ private transient int firstReaderHoldCount; Syncçš„æ„é€ å‡½æ•°ï¼š 123456Sync() { // åˆå§‹åŒ–æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨ readHolds = new ThreadLocalHoldCounter(); //ç¡®ä¿readHoldsçš„å¯è§æ€§ setState(getState()); } Syncæ˜¯å…¬å¹³çš„è¿˜æ˜¯éå…¬å¹³çš„æ˜¯åœ¨ReentrantReadWriteLockçš„æ„é€ ä¸­ç¡®å®šçš„ï¼š 12345public ReentrantReadWriteLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync(); readerLock = new ReadLock(this); writerLock = new WriteLock(this); } fairä¸ºtrueæ—¶å®ç°å…¬å¹³æ¨¡å¼ï¼Œä¸ºfalseæ—¶å®ç°éå…¬å¹³æ¨¡å¼ï¼ŒåŒæ—¶åˆå§‹åŒ–è¯»é”å’Œå†™é”ã€‚ å†™é”ï¼šå†™é”å†…éƒ¨å°±ç»´æŠ¤äº†ä¸€ä¸ªSyncï¼Œå…¶å…·ä½“å®ç°ç”±ReentrantReadWriteLockä¸­çš„syncå†³å®šï¼š 123456789public static class WriteLock implements Lock, java.io.Serializable { private static final long serialVersionUID = -4992448646407690164L; private final Sync sync; protected WriteLock(ReentrantReadWriteLock lock) { sync = lock.sync; }} å†™é”çš„lock():lock()ä¹Ÿæ˜¯è°ƒç”¨äº†AQSçš„lock()æ–¹æ³•ï¼Œå…·ä½“å®ç°ä¸ºSyncä¸‹çš„tryAcquire() 12345678910111213141516171819202122232425262728293031protected final boolean tryAcquire(int acquires) { //è·å–å½“å‰çº¿ç¨‹ Thread current = Thread.currentThread(); //è·å–åŒæ­¥çŠ¶æ€ int c = getState(); // è·å–å†™çº¿ç¨‹æ•°é‡ int w = exclusiveCount(c); //çŠ¶æ€ä¸ä¸º0ï¼Œè¡¨ç¤ºå·²æœ‰å…¶ä»–çº¿ç¨‹è·å–è¯»é”æˆ–å†™é” if (c != 0) { //a.è€Œå¦‚æœæ­¤æ—¶w==0å³å†™é”æ²¡æœ‰è¢«å ç”¨ï¼Œè¯´æ˜è¯»é”è¢«å ç”¨ï¼Œå› æ­¤ç›´æ¥è¿”å›falseï¼Œè·å–å¤±è´¥ if (w == 0 || //b.å¦‚æœå½“å‰å†™é”è¢«æŒæœ‰ï¼Œåˆ™åˆ¤æ–­æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯åˆ™è¿”å›falseï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­ current != getExclusiveOwnerThread()) return false; //å¦‚æœæŒæœ‰å†™é”çš„çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ // åˆ™é‡æ–°è®¡ç®—å½“å‰å†™é”é‡å…¥æ¬¡æ•°åæ˜¯å¦å¤§äºæœ€å¤§é‡å…¥æ¬¡æ•°(2^16-1) if (w + exclusiveCount(acquires) &gt; MAX_COUNT) //å¦‚æœè¶…å‡ºæœ€å¤§é‡å…¥æ¬¡æ•°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ throw new Error(\"Maximum lock count exceeded\"); //å¦åˆ™æ›´æ–°åŒæ­¥çŠ¶æ€ï¼Œå³è‡ªå¢é‡å…¥æ¬¡æ•° setState(c + acquires); return true; } //å¦‚æœçŠ¶æ€ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹è·å–è¯»å†™é” if (writerShouldBlock() || //æ˜¯å¦åº”è¯¥é˜»å¡å½“å‰è·å–å†™é”çš„çº¿ç¨‹ !compareAndSetState(c, c + acquires))//å¦‚æœä¸éœ€è¦é˜»å¡ï¼Œåˆ™CASæ›´æ–°åŒæ­¥çŠ¶æ€ return false; //CASæˆåŠŸï¼Œå°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„ setExclusiveOwnerThread(current); return true; } writerShouldBlock()çš„å…¬å¹³å®ç°éœ€è¦è°ƒç”¨hasQueuedPredecessorsåˆ¤æ–­æœ‰æ²¡æœ‰å·²ç»åœ¨ç­‰å¾…è·å–å†™é”çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰åˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›trueï¼›è€Œéå…¬å¹³å®ç°ç›´æ¥è¿”å›false 1234567891011static final class NonfairSync extends Sync { final boolean writerShouldBlock() { return false; }}static final class FairSync extends Sync { final boolean writerShouldBlock() { return hasQueuedPredecessors(); } } æµç¨‹æ€»ç»“ï¼šè·å–å½“å‰åŒæ­¥çŠ¶æ€stateï¼Œå’Œå†™é”é‡å…¥æ¬¡æ•°w å¦‚æœstateä¸ä¸º0.è¯´æ˜è¯»é”æˆ–å†™é”è¢«å ç”¨1.1 å¦‚æœwä¸º0è¯´æ˜å†™é”è¢«æŒæœ‰ï¼Œå› æ­¤è¯»é”å·²ç»è¢«æŒæœ‰ï¼Œç›´æ¥è¿”å›false1.2 å¦‚æœwä¸ä¸º0ï¼Œè¯´æ˜å½“å‰å†™é”è¢«æŒæœ‰ï¼Œåˆ™åˆ¤æ–­å½“å‰å†™é”çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™åˆ¤æ–­é‡å…¥æ¬¡æ•°æ˜¯å¦æº¢å‡ºï¼Œå¦‚æœæ²¡æº¢å‡ºåˆ™æ›´æ–°åŒæ­¥çŠ¶æ€è¿”å›trueï¼›å¦‚æœä¸æ˜¯åˆ™ç›´æ¥è¿”å›false å¦‚æœä¸º0ï¼Œè¯´æ˜è¯»å†™é”éƒ½æ²¡æœ‰è¢«å ç”¨ï¼Œåˆ™æ ¹æ®syncæ˜¯å…¬å¹³è¿˜æ˜¯éå…¬å¹³å®ç°åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦é˜»å¡ï¼Œå¦‚æœä¸éœ€è¦é˜»å¡åˆ™CASæ›´æ–°åŒæ­¥çŠ¶æ€ï¼ŒæˆåŠŸåå°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„ï¼Œå¹¶è¿”å›trueï¼Œè·å–å†™é”æˆåŠŸ å†™é”çš„unlock():åŒæ ·è°ƒç”¨AQSçš„unlockï¼ŒtryReleaseçš„å®ç°å¦‚ä¸‹ï¼š 12345678910111213protected final boolean tryRelease(int releases) { //1.å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰å†™é”çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); //2.è®¡ç®—å½“å‰çŠ¶æ€å‡å»releasesåçš„å€¼ int nextc = getState() - releases; boolean free = exclusiveCount(nextc) == 0; if (free) //å¦‚æœé‡å…¥æ¬¡æ•°ä¸º0ï¼Œåˆ™ç›´æ¥æ¸…ç©ºé”çš„æŒæœ‰è€…ã€‚å› æ­¤é‡å…¥é”å¿…é¡»å°†é‡å…¥æ¬¡æ•°å…¨éƒ¨é‡Šæ”¾åæ‰å¯çœŸæ­£é‡Šæ”¾é”,è¿”å›true setExclusiveOwnerThread(null); //å¦åˆ™æ›´æ–°é‡å…¥æ¬¡æ•°ï¼Œè¿”å›false setState(nextc); return free; æµç¨‹æ€»ç»“ï¼š1.å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰å†™é”çš„çº¿ç¨‹ç›´æ¥æŠ›å‡ºå¼‚å¸¸2.å¦‚æœè·å–å†™é”æ•°é‡ä¸º0è¡¨ç¤ºæˆåŠŸé‡Šæ”¾ï¼Œç½®ç‹¬å çº¿ç¨‹ä¸ºç©ºï¼Œè¿”å›true2.å¦‚æœä¸ä¸º0ï¼Œåˆ™æ›´æ–°åŒæ­¥çŠ¶æ€ï¼Œè¿”å›false è¯»é”ï¼šç»“æ„åŒå†™é”ç›¸åŒ è¯»é”çš„lock():å¯¹åº”Syncçš„tryAcquireShared ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243protected final int tryAcquireShared(int unused) { //è·å–å½“å‰çº¿ç¨‹ Thread current = Thread.currentThread(); // è·å–å½“å‰çŠ¶æ€ int c = getState(); // å¦‚æœå½“å‰å†™é”è¢«æŒæœ‰ï¼Œä¸”ä¸æ˜¯å½“å‰çº¿ç¨‹,è¿”å›-1ï¼Œå°äº0è¡¨ç¤ºè·å–å¤±è´¥ // è€Œå¦‚æœå†™é”è¢«æŒæœ‰ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œè¯´æ˜æ­£åœ¨è¿›è¡Œé”é™çº§ if (exclusiveCount(c) != 0 &amp;&amp; getExclusiveOwnerThread() != current) return -1; // è·å–å½“å‰è·å–è¯»é”çš„çº¿ç¨‹æ•°é‡ int r = sharedCount(c); if (!readerShouldBlock() &amp;&amp; //å…·ä½“æ ¹æ®å…¬å¹³æˆ–éå…¬å¹³åŸåˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡å½“å‰çº¿ç¨‹ r &lt; MAX_COUNT &amp;&amp; //è¯»é”çº¿ç¨‹å°äºæœ€å¤§å€¼ compareAndSetState(c, c + SHARED_UNIT)) {//CASæ›´æ–°æˆåŠŸ if (r == 0) { //æŒæœ‰è¯»é”çº¿ç¨‹ä¸º0 // å°†å½“å‰çº¿ç¨‹è®¾ä¸ºç¬¬ä¸€ä¸ªæŒæœ‰è¯»é”çš„çº¿ç¨‹ï¼Œå³å°†è¯»é”çŠ¶æ€ä»0å˜ä¸º1 firstReader = current; firstReaderHoldCount = 1; } else if (firstReader == current) {//å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œå³è¯¥çº¿ç¨‹é‡å…¥ //é‡å…¥æ•°è‡ªå¢ firstReaderHoldCount++; } else {//å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹ //å…ˆæŸ¥å–ç¼“å­˜ï¼Œè·å–ç¼“å­˜è®¡æ•° HoldCounter rh = cachedHoldCounter; //1.ç¼“å­˜ä¸ºç©º //2.ç¼“å­˜ä¸ä¸ºç©ºï¼Œä½†å¯¹åº”çš„çº¿ç¨‹idéå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹id if (rh == null || rh.tid != getThreadId(current)) // ä»threadLocalä¸­è·å–è®¡æ•° cachedHoldCounter = rh = readHolds.get(); //å¦‚æœè®¡æ•°ä¸º0 else if (rh.count == 0) //åˆ™åŠ å…¥åˆ°readHoldsä¸­ readHolds.set(rh); //è®¡æ•°è‡ªå¢ rh.count++; } //è·å–æˆåŠŸï¼Œè¿”å›1 return 1; } return fullTryAcquireShared(current); } å¦‚æœå½“å‰çº¿ç¨‹éœ€è¦é˜»å¡ï¼Œæˆ–è¯»çº¿ç¨‹è¶…è¿‡æœ€å¤§å€¼ï¼Œæˆ–CASå¤±è´¥ï¼Œè¿›å…¥fullTryAcquireSharedæ–¹æ³•ï¼Œå¾ªç¯è·å–è¯»é” 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556final int fullTryAcquireShared(Thread current) { HoldCounter rh = null; //æ­»å¾ªç¯è‡ªæ—‹ for (;;) { //è·å–å½“å‰çŠ¶æ€ int c = getState(); if (exclusiveCount(c) != 0) {//æœ‰çº¿ç¨‹æŒæœ‰å†™é” if (getExclusiveOwnerThread() != current) //ä¸”ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›-1 return -1; } else if (readerShouldBlock()) {//å¦‚æœéœ€è¦é˜»å¡ if (firstReader == current) {///å½“å‰çº¿ç¨‹ä¸ºç¬¬ä¸€ä¸ªè·å–è¯»é”çš„ // assert firstReaderHoldCount &gt; 0; } else {//å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„ if (rh == null) { //è®¡æ•°ä¸ºç©ºï¼Œåˆ™å°†ç¼“å­˜èµ‹å€¼ç»™å®ƒ rh = cachedHoldCounter; //ç¼“å­˜ä¸ºç©ºæˆ–è¿è¡Œçº¿ç¨‹tidä¸æ˜¯å½“å‰è¿è¡Œçš„çº¿ç¨‹ if (rh == null || rh.tid != getThreadId(current)) { //ä»threadlocalä¸­è·å– rh = readHolds.get(); if (rh.count == 0) readHolds.remove(); } } if (rh.count == 0) return -1; } } // è¯»é”çº¿ç¨‹è¶…è¿‡æœ€å¤§å€¼ï¼ŒæŠ›å‡ºå¼‚å¸¸ if (sharedCount(c) == MAX_COUNT) throw new Error(\"Maximum lock count exceeded\"); //CASæ›´æ–°çŠ¶æ€å€¼ if (compareAndSetState(c, c + SHARED_UNIT)) { //ä¸‹é¢é€»è¾‘è·Ÿä¸Šé¢åŸºæœ¬ç›¸åŒï¼Œä¸èµ˜è¿° if (sharedCount(c) == 0) { firstReader = current; firstReaderHoldCount = 1; } else if (firstReader == current) { firstReaderHoldCount++; } else { if (rh == null) rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) rh = readHolds.get(); else if (rh.count == 0) readHolds.set(rh); rh.count++; cachedHoldCounter = rh; // cache for release } return 1; } } } è¯»é”çš„unlock():æ¶‰åŠçš„ç±»å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839protected final boolean tryReleaseShared(int unused) { Thread current = Thread.currentThread(); //å¦‚æœç¬¬ä¸€ä¸ªè¯»é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ if (firstReader == current) { //å¦‚æœåªé‡å…¥ä¸€æ¬¡ if (firstReaderHoldCount == 1) //ç›´æ¥ç½®ç©º firstReader = null; else //å¦åˆ™è®¡æ•°è‡ªå‡ firstReaderHoldCount--; } else {//å½“å‰çº¿ç¨‹éç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹ //è·å–ç¼“è®¡æ•° HoldCounter rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) //ç¼“å­˜ä¸ºç©ºæˆ–éå½“å‰çº¿ç¨‹åˆ™ä»threadlocalè·å– rh = readHolds.get(); //è·å–å½“å‰çº¿ç¨‹çš„è·å–è¯»é”æ¬¡æ•° int count = rh.count; if (count &lt;= 1) {//å¦‚æœè®¡æ•°å°äºç­‰äº1 readHolds.remove();//å½»åº•é‡Šæ”¾èµ„æº if (count &lt;= 0)//å°äºç­‰äº-æ—¶æŠ›å‡ºå¼‚å¸¸ throw unmatchedUnlockException(); } // å½“å‰çº¿ç¨‹çš„è¯»é”çš„å¯é‡å…¥æ¬¡æ•°è‡ªå‡ --rh.count; } for (;;) { //è·å–å½“å‰çŠ¶æ€ int c = getState(); //é‡Šæ”¾åçš„çŠ¶æ€ int nextc = c - SHARED_UNIT; //casæ›´æ–°çŠ¶æ€ if (compareAndSetState(c, nextc)) //å¦‚æœä¸º0ï¼Œè¡¨ç¤ºå½»åº•é‡Šæ”¾ï¼Œè¿”å›tureï¼Œå¦åˆ™è¿”å›false return nextc == 0; } } é‡Šæ”¾æµç¨‹ï¼š1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ï¼Œåˆ™åˆ¤æ–­å…¶å æœ‰çš„èµ„æºæ˜¯å¦ä¸º1ï¼Œå³æ˜¯å¦åªé‡å…¥ä¸€æ¬¡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®©ç¬¬ä¸€ä¸ªè¯»é”çš„çº¿ç¨‹ç½®ç©ºï¼Œå¦åˆ™è®©ç¬¬ä¸€ä¸ªè¯»é”çš„çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°è‡ªå‡ä¸€2.å¦‚æœå½“å‰çº¿ç¨‹éç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹ï¼Œåˆ™é¦–å…ˆè·å–ç¼“å­˜è®¡æ•°ï¼Œå¦‚æœä¸ºç©ºæˆ–éå½“å‰çº¿ç¨‹ï¼Œåˆ™ä»threadLocalä¸­è·å–å½“å‰çº¿ç¨‹çš„è®¡æ•°ï¼Œå¦‚æœè®¡æ•°å°äºç­‰äº1ï¼Œåˆ™ç§»é™¤è®¡æ•°ï¼Œå¦‚æœâ‰¤0ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼›æœ€åå†è®©countè‡ªå‡ä¸€3.è¿›å…¥æ­»å¾ªç¯CASæ›´æ–°åŒæ­¥çŠ¶æ€","link":"/posts/20200207-reentrant_read_write_lock.html"}],"tags":[{"name":"elasticsearch","slug":"elasticsearch","link":"/tags/elasticsearch/"},{"name":"docker","slug":"docker","link":"/tags/docker/"},{"name":"centos7","slug":"centos7","link":"/tags/centos7/"},{"name":"firewall","slug":"firewall","link":"/tags/firewall/"},{"name":"linux","slug":"linux","link":"/tags/linux/"},{"name":"gulp,å‹ç¼©é™æ€èµ„æº","slug":"gulp-å‹ç¼©é™æ€èµ„æº","link":"/tags/gulp-%E5%8E%8B%E7%BC%A9%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90/"},{"name":"jib","slug":"jib","link":"/tags/jib/"},{"name":"æ–‡ä»¶ä¸Šä¼ ","slug":"æ–‡ä»¶ä¸Šä¼ ","link":"/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"},{"name":"fdfs","slug":"fdfs","link":"/tags/fdfs/"},{"name":"æ’åº","slug":"æ’åº","link":"/tags/%E6%8E%92%E5%BA%8F/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","link":"/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"äºŒå‰æ ‘","slug":"äºŒå‰æ ‘","link":"/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/"},{"name":"è°ƒåº¦ç®—æ³•","slug":"è°ƒåº¦ç®—æ³•","link":"/tags/%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/"},{"name":"åˆ†æ²»","slug":"åˆ†æ²»","link":"/tags/%E5%88%86%E6%B2%BB/"},{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","link":"/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"name":"fork/join","slug":"fork-join","link":"/tags/fork-join/"},{"name":"CountDownLatch","slug":"CountDownLatch","link":"/tags/CountDownLatch/"},{"name":"CyclicBarrier","slug":"CyclicBarrier","link":"/tags/CyclicBarrier/"},{"name":"Semaphore","slug":"Semaphore","link":"/tags/Semaphore/"},{"name":"Runnable","slug":"Runnable","link":"/tags/Runnable/"},{"name":"Callable","slug":"Callable","link":"/tags/Callable/"},{"name":"Future","slug":"Future","link":"/tags/Future/"},{"name":"FutureTask","slug":"FutureTask","link":"/tags/FutureTask/"},{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","link":"/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"},{"name":"CAS","slug":"CAS","link":"/tags/CAS/"},{"name":"åŸå­æ“ä½œç±»","slug":"åŸå­æ“ä½œç±»","link":"/tags/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%B1%BB/"},{"name":"AtomicXXX","slug":"AtomicXXX","link":"/tags/AtomicXXX/"},{"name":"AQS","slug":"AQS","link":"/tags/AQS/"},{"name":"æ˜¾ç¤ºé”Lock","slug":"æ˜¾ç¤ºé”Lock","link":"/tags/%E6%98%BE%E7%A4%BA%E9%94%81Lock/"},{"name":"LockSupport","slug":"LockSupport","link":"/tags/LockSupport/"},{"name":"ReentrantLock","slug":"ReentrantLock","link":"/tags/ReentrantLock/"},{"name":"ReentrantReadWriteLock","slug":"ReentrantReadWriteLock","link":"/tags/ReentrantReadWriteLock/"},{"name":"è¯»å†™é”","slug":"è¯»å†™é”","link":"/tags/%E8%AF%BB%E5%86%99%E9%94%81/"}],"categories":[{"name":"docker","slug":"docker","link":"/categories/docker/"},{"name":"linux","slug":"linux","link":"/categories/linux/"},{"name":"å·¥å…·","slug":"å·¥å…·","link":"/categories/%E5%B7%A5%E5%85%B7/"},{"name":"springboot","slug":"springboot","link":"/categories/springboot/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"æ’åº","slug":"æ•°æ®ç»“æ„/æ’åº","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8E%92%E5%BA%8F/"},{"name":"äºŒå‰æ ‘","slug":"æ•°æ®ç»“æ„/äºŒå‰æ ‘","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91/"},{"name":"æ“ä½œç³»ç»Ÿ","slug":"æ“ä½œç³»ç»Ÿ","link":"/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"name":"å¹¶å‘å·¥å…·ç±»","slug":"å¹¶å‘ç¼–ç¨‹/å¹¶å‘å·¥å…·ç±»","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"åŸå­æ“ä½œCAS","slug":"å¹¶å‘ç¼–ç¨‹/åŸå­æ“ä½œCAS","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9CCAS/"},{"name":"æ˜¾ç¤ºé”å’ŒAQS","slug":"å¹¶å‘ç¼–ç¨‹/æ˜¾ç¤ºé”å’ŒAQS","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%98%BE%E7%A4%BA%E9%94%81%E5%92%8CAQS/"}]}