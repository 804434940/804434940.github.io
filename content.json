{"pages":[{"title":"æ–‡ç« åˆ†ç±»","text":"","link":"/categories/index.html"},{"title":"","text":"å›¾ç‰‡æœé›†äºäº’è”ç½‘ï¼Œä¾µæƒè¯·ç•™è¨€ï¼Œé©¬ä¸Šå¤„ç†ğŸ˜Šã€‚","link":"/gallery/index.html"},{"title":"ç›¸å†Œ","text":"","link":"/photo/index.html"},{"title":"æ ‡ç­¾","text":"","link":"/tags/index.html"}],"posts":[{"title":"dockerå®‰è£…ES","text":"123456789101112131415161718192021222324docker pull elasticsearch:6.4.0 //å†ä½å°±æ˜¯5.xäº†1.vim /etc/security/limits.d/90-nproc.conf æ·»åŠ ï¼šsoft nproc 40962. vim /etc/sysctl.conf æ·»åŠ vm.max_map_count=655360 æ‰§è¡Œsysctl -påˆ·æ–°é…ç½®//æ ¹æ®è‡ªå·±çš„å†…å­˜å¤§å°é€‚å½“è°ƒæ•´ï¼Œå¤ªå¤§ä¼šå¯åŠ¨å¤±è´¥3.docker run -e ES_JAVA_OPTS=\"-Xms512m -Xmx512m\" -d -p 9200:9200 -p 9300:9300 --name=myES å®¹å™¨id4.docker exec -it å®¹å™¨å /bin/bash è¿›å…¥å®¹å™¨å‘½ä»¤è¡Œ5.vim config/elasticsearch.yml åœ°å€æ”¹ä¸º0.0.0.0å¯èƒ½ä¼švimä¸å¯ç”¨ æ‰§è¡Œ yum update yum install -y vim6.å®‰è£…ikåˆ†è¯å™¨å…ˆä¸Šä¼ åˆ°å®¿ä¸»æœºï¼Œå†ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤copyåˆ°å®¹å™¨ä¸­docker cp å®¿ä¸»æœºikåˆ†è¯å™¨åœ°å€ å®¹å™¨å:/usr/share/elasticsearch/plugins/ik","link":"/posts/20200106-docker_es.html"},{"title":"centos7æŸ¥çœ‹é˜²ç«å¢™ä»¥åŠå¼€æ”¾å’Œå…³é—­ç«¯å£","text":"æŸ¥çœ‹æŸä¸ªç«¯å£æ˜¯å¦å¼€æ”¾ 1firewall-cmd --query-port=22122/tcp yes/no å¼€æ”¾/æœªå¼€æ”¾ å¼€æ”¾æŒ‡å®šç«¯å£1firewall-cmd --add-port=22122/tcp --permanent firewall-cmd â€“zone=public â€“add-port=80/tcp â€“permanent-zone #ä½œç”¨åŸŸ-permanent æ²¡æœ‰è¯¥å‚æ•°é‡å¯åå¤±æ•ˆ é‡æ–°åŠ è½½ç«¯å£ï¼š 1firewall-cmd --reload 3.å…³é—­æŸä¸ªç«¯å£ 1firewall-cmd --permanent --remove-port=22122/tcp é‡æ–°åŠ è½½ 4. æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ 123firewall-cmd --stateæˆ–è€…:systemctl status firewalld æ‰“å¼€/å…³é—­é˜²ç«å¢™ å¯åŠ¨ï¼šsystemctl start firewalldå…³é—­ï¼š systemctl stop firewalldå¼€æœºå¯ç”¨ ï¼š systemctl enable firewalldç¦æ­¢firewallå¼€æœºå¯åŠ¨ ï¼šsystemctl disable firewalld.serviceå¯åŠ¨æœåŠ¡ï¼šsystemctl start firewalld.serviceå…³é—­æœåŠ¡ï¼šsystemctl stop firewalld.serviceé‡å¯æœåŠ¡ï¼šsystemctl restart firewalld.service æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ 1netstat -anp æŸ¥çœ‹é˜²ç«å¢™å·²å¼€æ”¾çš„ç«¯å£ 1firewall-cmd --list-ports","link":"/posts/20200107-centos7_firewall.html"},{"title":"hexoå‹ç¼©é™æ€èµ„æº","text":"1.å®‰è£…gulp1.1é¦–å…ˆå…¨å±€å®‰è£…gulp1npm install gulp -g 1.2 å†å±€éƒ¨å®‰è£…ç›¸å…³æ’ä»¶1npm install gulp-imagemin gulp gulp-minify-css gulp-minify-html gulp-uglify -- 1234567# è§£å†³ã€Gulpæ‰“åŒ…é—®é¢˜ã€‘ GulpUglifyError: unable to minify JavaScript# è§£å†³ gulp-uglify å‹ç¼©JavaScript ä¸å…¼å®¹ es5 è¯­æ³•çš„é—®é¢˜npm install babel-core@6.26.3 --savenpm install gulp-babel@7.0.1 --savenpm install babel-preset-es2015@6.24.1 --save# gulp-babel å–æ¶ˆä¸¥æ ¼æ¨¡å¼æ–¹æ³•(\"use strict\")npm install babel-plugin-transform-remove-strict-mode --save 2.åœ¨ç½‘ç«™æ ¹ç›®å½•åˆ›å»ºgulpfile.jsæ–‡ä»¶ï¼Œç”¨æ¥é…ç½®å‹ç¼©1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859var gulp = require('gulp');//Pluginsæ¨¡å—è·å–var minifycss = require('gulp-minify-css');var uglify = require('gulp-uglify');var minifyhtml = require('gulp-minify-html');var imagemin = require('gulp-imagemin')var babel = require('gulp-babel');// å‹ç¼© public ç›®å½• cssæ–‡ä»¶gulp.task('minify-css', function () { return gulp.src('./public/**/*.css') .pipe(minifycss()) .pipe(gulp.dest('./public'));});// å‹ç¼© public ç›®å½• htmlæ–‡ä»¶gulp.task('minify-html', function () { return gulp.src('./public/**/*.html') .pipe(minifyhtml()) .pipe(gulp.dest('./public'))});// å‹ç¼©jsæ–‡ä»¶gulp.task('minify-js', function (done) { return gulp.src(['./public/**/*.js', '!./public/**/*.min.js','!./public/js/src/snow.js']) .pipe(babel({ //å°†ES6ä»£ç è½¬è¯‘ä¸ºå¯æ‰§è¡Œçš„JSä»£ç  presets: [['es2015',{strict:false}]] // es5æ£€æŸ¥æœºåˆ¶ })) .pipe(uglify()) .pipe(gulp.dest('./public')); done();});// å‹ç¼©public/posts ç›®å½• å›¾ç‰‡æ–‡ä»¶gulp.task('minify-img', function () { return gulp.src(['./public/images/**/*.*','./source/gallery/**']) .pipe(imagemin( [ imagemin.gifsicle({ 'optimizationLevel': 3 }), imagemin.jpegtran({ 'progressive': true }), imagemin.optipng({ 'optimizationLevel': 7 }), imagemin.svgo() ], { 'verbose': true })) .pipe(gulp.dest('./public'))});// åˆ†åˆ«æ‰§è¡Œcssã€hemlã€jså’Œå›¾ç‰‡çš„å‹ç¼©ä»»åŠ¡gulp.task('build', gulp.series('minify-css', 'minify-html', 'minify-js', 'minify-img')); 3.åœ¨ç½‘ç«™æ ¹ç›®å½•åˆ›å»º.babelrc1234{ 'presets': ['es2015'], \"plugins\": [\"transform-remove-strict-mode\"]} 4.æ‰§è¡Œå‹ç¼©1hexo clean&amp;&amp;hexo g &amp;&amp;gulp build ä¸å…¼å®¹ES5çš„è§£å†³å‚è€ƒ:https://segmentfault.com/a/1190000019842178?utm_source=tag-newest","link":"/posts/20200111-hexo-gulp.html"},{"title":"jibæ‰“åŒ…é¡¹ç›®åˆ°é˜¿é‡Œé•œåƒ","text":"â€‹ Jib å°†å¤„ç†å°†åº”ç”¨æ‰“åŒ…åˆ°å®¹å™¨é•œåƒè¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼Œå®ƒç›´æ¥ä¸ Maven å’Œ Gradle Java å¼€å‘ç¯å¢ƒé›†æˆï¼Œä¸éœ€è¦ä½ ç¼–å†™ Dockerfile æˆ–å®‰è£… Dockerï¼ˆä½†æƒ³è¦è¿è¡Œè¿˜æ˜¯è¦æœ¬åœ°å®‰è£…dockerï¼‰ ï¼Œåªéœ€å°†å…¶ä½œä¸ºæ’ä»¶æ·»åŠ åˆ°ä½ çš„æ„å»ºä¸­ï¼Œå°±å¯ä»¥ç«‹å³å°† Java åº”ç”¨å®¹å™¨åŒ–ã€‚ å›¾ç‰‡æ¥æºäºhttps://www.oschina.net/news/97892/google-opensource-jib ä¸€ã€åœ¨pomæ–‡ä»¶ä¸­å¼•å…¥jibæ’ä»¶1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;com.google.cloud.tools&lt;/groupId&gt; &lt;artifactId&gt;jib-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.7.0&lt;/version&gt; &lt;configuration&gt; &lt;!--æ‹‰å–çš„é•œåƒçš„é…ç½®ï¼Œé»˜è®¤ä¸ºgcr.io/distroless/java--&gt; &lt;from&gt; &lt;image&gt;åŸºç¡€é•œåƒåœ°å€&lt;/image&gt; &lt;auth&gt; &lt;username&gt;é˜¿é‡Œäº‘ç”¨æˆ·å&lt;/username&gt; &lt;password&gt;é˜¿é‡Œäº‘å¯†ç &lt;/password&gt; &lt;/auth&gt; &lt;/from&gt; &lt;to&gt; &lt;image&gt;åŸºç¡€é•œåƒåœ°å€&lt;/image&gt; &lt;auth&gt; &lt;username&gt;é˜¿é‡Œäº‘ç”¨æˆ·å&lt;/username&gt; &lt;password&gt;é˜¿é‡Œäº‘å¯†ç &lt;/password&gt; &lt;/auth&gt; &lt;tags&gt; &lt;tag&gt;ç‰ˆæœ¬å·&lt;/tag&gt; &lt;/tags&gt; &lt;/to&gt; &lt;allowInsecureRegistries&gt;true&lt;/allowInsecureRegistries&gt; &lt;/configuration&gt; &lt;executions&gt; &lt;execution&gt; &lt;phase&gt;package&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;build&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; ç‰ˆæœ¬å·è¿™é‡Œä¸€å¼€å§‹æŒ‡å®šçš„è‡ªå®šä¹‰ç‰ˆæœ¬ï¼Œä½†æ˜¯ä½¿ç”¨jib:buildæ—¶æŠ¥é”™ï¼Œè¯´æ‰¾ä¸åˆ°latestç‰ˆæœ¬ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯é»˜è®¤æ‹‰å–latestï¼Œä½†æ˜¯ç½‘ä¸Šå…¶ä»–åšä¸»å¥½åƒå¹¶æ²¡æœ‰è¿™ä¸ªæƒ…å†µï¼Œè¿™é‡Œå°±åªå¥½å°†tagè®¾ä¸ºlatestäº† äºŒã€githubåˆ›å»ºä»“åº“æ·»åŠ Dockerfileæ–‡ä»¶ ä¸‰ã€é˜¿é‡Œäº‘åˆ›å»ºé•œåƒä»“åº“3.1 åˆ›å»ºä»“åº“ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œæ ¹æ®æç¤ºé€‰æ‹©Dockerfileæ‰€åœ¨ä»“åº“ è¿›å…¥æ–°åˆ›å»ºçš„ä»“åº“ï¼Œç‚¹å‡»æ·»åŠ è§„åˆ™è¿™é‡Œç‰ˆæœ¬èµ·ålatestï¼ŒåŸå› ä¸Šé¢è§£é‡Šäº†ï¼Œæœ‰çŸ¥é“çš„ä¼™ä¼´è¿˜è¯·å‘ŠçŸ¥ æ„Ÿè°¢~ ç‚¹å‡»æ„å»ºï¼Œç­‰å¾…ä¸€ä¼šï¼Œä¸‹æ–¹æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºæ„å»ºçš„é•œåƒå’ŒçŠ¶æ€ æœ€åè¿”å›åŸºæœ¬ä¿¡æ¯ï¼Œå¤åˆ¶å…¬ç½‘åœ°å€ï¼Œæ”¾åœ¨fromå’Œtoçš„imageä¸­ï¼Œä¸€å®šè¦å¡«å†™usernameå’Œpasswordæœ€åæ‰§è¡Œ jib:buildå³å¯æˆåŠŸ æˆåŠŸ! æœ€ååœ¨dockerä¸­æ‹‰å–å°±å¯ä»¥äº† 1docker run -d --name testjib-p 8081:8081 åˆšåˆšå¤åˆ¶çš„å…¬ç½‘åœ°å€:latest(å¯¹åº”çš„é•œåƒç‰ˆæœ¬å·)","link":"/posts/20200106-jib_ali.html"},{"title":"mavon-editor+springboot+fdfsä¸Šä¼ æ–‡ä»¶","text":"ä¸€ã€å®‰è£…mavonç›´æ¥npm installä¸‹å°±å¯ä»¥äº†ï¼Œç„¶ååœ¨main.jså¼•å…¥ï¼š12import mavonEditor from 'mavon-editor'Vue.use(mavonEditor) äºŒã€é¡µé¢ä½¿ç”¨1234567891011&lt;mavon-editor v-show=\"!articleModal\" id=\"editor\" v-model=\"value\" fontSize=\"16px\" ref=\"md\" @imgAdd=\"$imgAdd\" @imgDel=\"$imgDel\" @change=\"handleChange\" @fullScreen=\"handleFullScreen\" /&gt; è¿™é‡Œåªéœ€è¦å…³æ³¨@imgAddï¼Œä¸ºæ·»åŠ å›¾ç‰‡çš„äº‹ä»¶ ä¸‰ã€ä¸Šä¼ æ–‡ä»¶è¿™é‡Œä½¿ç”¨çš„æ˜¯æ‰¹é‡ä¸Šä¼ ï¼Œæ‰€ä»¥æ¯è§¦å‘ä¸€æ¬¡@imgAddå°±å‘æ–‡ä»¶é›†åˆæ·»åŠ ä¸€æ¬¡ 1234567/** * æ·»åŠ æ–‡ä»¶åˆ°æ–‡ä»¶é›†åˆä¸­ */ $imgAdd(pos, $file) { // ç¼“å­˜å›¾ç‰‡ä¿¡æ¯ this.img_file[pos] = $file; }, dataä¸­å®šä¹‰å¦‚ä¸‹ï¼š 1img_file: {}, //æ–‡ä»¶é›†åˆ ä¸Šä¼ æ–‡ä»¶æ–¹æ³•ï¼š 123456789101112131415161718192021222324/** * ä¸Šä¼ æ–‡ä»¶ */ uploadimg($e) { var formdata = new FormData(); for (var _img in this.img_file) { formdata.append(\"files\", this.img_file[_img]); } uploadApi.uploadFileList(formdata).then(res =&gt; { console.log(res); const resData = res.data.data; /** * ä¾‹å¦‚ï¼šè¿”å›æ•°æ®ä¸º res = [[pos, url], [pos, url]...] * pos ä¸ºåŸå›¾ç‰‡æ ‡å¿—ï¼ˆ0ï¼‰ * url ä¸ºä¸Šä¼ åå›¾ç‰‡çš„urlåœ°å€ */ // ç¬¬äºŒæ­¥.å°†è¿”å›çš„urlæ›¿æ¢åˆ°æ–‡æœ¬åŸä½ç½®![...](0) -&gt; ![...](url) for (var i = 0; i &lt; resData.length; i++) { this.$refs.md.$img2Url(i + 1, resData[i]); } }); } ç„¶ååœ¨éœ€è¦ä¸Šä¼ çš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å•¦ å››ã€åå°è¿›è¡Œä¸Šä¼ 4.1Controller123456789101112131415/** * æ–‡ç« å¤šæ–‡ä»¶ä¸Šä¼  * @param files * @return è¿”å›å›¾ç‰‡åœ°å€ */ @PostMapping(value = \"/files\",produces = MediaType.APPLICATION_JSON_UTF8_VALUE) public Result uploadMultiFiles(@RequestParam(\"files\") MultipartFile[] files){ try { List&lt;String&gt; resultList = uploadService.uploadMultiFiles(files); return new Result(true,StatusCode.OK,\"ä¸Šä¼ æˆåŠŸ\",resultList); }catch (Exception e){ return new Result(false,StatusCode.ERROR,\"å•Šå“¦~å›¾ç‰‡ä¸Šä¼ å‡ºç°äº†ç‚¹å°é”™è¯¯ï¼Œè¯·ç¨åå†ä¸Šä¼ \"); } } 4.2ã€Service123456789101112131415161718192021222324252627282930313233343536/** * æ‰¹é‡ä¸Šä¼  * @param files */ public List&lt;String&gt; uploadMultiFiles(MultipartFile[] files) { List&lt;String&gt; resultList=new ArrayList&lt;&gt;(); for (MultipartFile file : files) { try { //æ ¡éªŒæ–‡ä»¶å†…å®¹ BufferedImage image = ImageIO.read(file.getInputStream()); if (image == null) { throw new MyException(ExceptionEnum.INVALID_FILE_TYPE); } //è·å–æ‹“å±•å String extension = StringUtils.substringAfterLast(file.getOriginalFilename(), \".\"); //ä¸Šä¼ åˆ°FastDFS StorePath storePath = storageClient.uploadFile(file.getInputStream(), file.getSize(), extension, null); //ä¸åŠ http://å‰ç«¯æ— æ³•æ˜¾ç¤º resultList.add(\"http://\"+uploadProperties.getBaseUrl() + storePath.getFullPath()); //è¿”å›è·¯å¾„ } catch (IOException e) { //ä¸Šä¼ å¤±è´¥ LOGGER.error(\"[æ–‡ä»¶ä¸Šä¼ ]æ–‡ä»¶\"+file.getOriginalFilename()+\"ä¸Šä¼ å¤±è´¥!\", e); throw new MyException(ExceptionEnum.UPLOAD_FILE_ERROR); } } return resultList; } Fdfsçš„ç›¸å…³é…ç½®åœ¨è¿™ç¯‡æ–‡ç« å†™å•¦(ä¸å¥½æ„æ€æ¯”è¾ƒæ‡’)ï¼šhttps://blog.csdn.net/weixin_43696529/article/details/102727220","link":"/posts/20200106-mavon_boot_fdfs.html"},{"title":"å†’æ³¡æ’åº---------javaå®ç°","text":"ä¸€ã€å†’æ³¡æ’åº å¹³å‡æ—¶é—´å¤æ‚åº¦: O(nÂ²)æœ€å·®æ—¶ï¼š O(nÂ²)æ˜¯å¦ç¨³å®šï¼š ç¨³å®šç©ºé—´å¼€é”€ï¼šOï¼ˆ1ï¼‰é€‚åˆnè¾ƒå°æ—¶ åŸå§‹æ•°ç»„ï¼š3 ï¼Œ 9ï¼Œ -1ï¼Œ 8, 2 ç¬¬ä¸€è¶Ÿæ’åºï¼šï¼ˆ1ï¼‰ 3ï¼Œ 9ï¼Œ -1ï¼Œ 8ï¼Œ2ï¼ˆ2ï¼‰ 3ï¼Œ -1ï¼Œ 9ï¼Œ8ï¼Œ 2ï¼ˆ3ï¼‰ 3ï¼Œ -1ï¼Œ 8ï¼Œ 9ï¼Œ 2ï¼ˆ4ï¼‰3ï¼Œ -1ï¼Œ 8ï¼Œ 2ï¼Œ 9 9ç¡®å®š ç¬¬äºŒè¶Ÿæ’åºï¼šï¼ˆ1ï¼‰-1ï¼Œ3ï¼Œ 8ï¼Œ 2ï¼Œ 9ï¼ˆ2ï¼‰-1, 3ï¼Œ 8ï¼Œ 2ï¼Œ 9ï¼ˆ3ï¼‰-1ï¼Œ3ï¼Œ2ï¼Œ 8ï¼Œ 9 8 , 9ç¡®å®šç¬¬ä¸‰è¶Ÿæ’åºï¼šï¼ˆ1ï¼‰-1ï¼Œ3 ï¼Œ2 ï¼Œ8 ï¼Œ 9ï¼ˆ2ï¼‰-1ï¼Œ 2ï¼Œ 3 ï¼Œ8 ï¼Œ9 3ï¼Œ 8ï¼Œ 9ç¡®å®šç¬¬å››è¶Ÿæ’åºï¼šï¼ˆ1ï¼‰-1ï¼Œ 2ï¼Œ 3ï¼Œ 8ï¼Œ 9 (2ï¼Œ 3ï¼Œ 8ï¼Œ 9ç¡®å®š) å®ç°ï¼š 123456789101112131415161718int[] array = {3, 9, -1, 8, 2}; int temp=0; for (int i=0; i&lt; array.length-1;i++){ System.out.println(\"å¼€å§‹ç¬¬\"+(i+1)+\"è¶Ÿæ’åº\"); for (int j=0;j&lt;array.length-1-i;j++){ if (array[j]&gt;array[j+1]){ temp=array[j]; array[j]=array[j+1]; array[j+1]=temp; } System.out.println(Arrays.toString(array)); } System.out.println(\"ç¬¬\"+(i+1)+\"è¶Ÿæ’åºç»“æœï¼š\"); System.out.println(Arrays.toString(array)); System.out.println(\"------------------\"); } ç»“æœï¼š1234567891011121314151617181920212223242526å¼€å§‹ç¬¬1è¶Ÿæ’åº[3, 9, -1, 8, 2][3, -1, 9, 8, 2][3, -1, 8, 9, 2][3, -1, 8, 2, 9]ç¬¬1è¶Ÿæ’åºç»“æœï¼š[3, -1, 8, 2, 9]------------------å¼€å§‹ç¬¬2è¶Ÿæ’åº[-1, 3, 8, 2, 9][-1, 3, 8, 2, 9][-1, 3, 2, 8, 9]ç¬¬2è¶Ÿæ’åºç»“æœï¼š[-1, 3, 2, 8, 9]------------------å¼€å§‹ç¬¬3è¶Ÿæ’åº[-1, 3, 2, 8, 9][-1, 2, 3, 8, 9]ç¬¬3è¶Ÿæ’åºç»“æœï¼š[-1, 2, 3, 8, 9]------------------å¼€å§‹ç¬¬4è¶Ÿæ’åº[-1, 2, 3, 8, 9]ç¬¬4è¶Ÿæ’åºç»“æœï¼š[-1, 2, 3, 8, 9]------------------ æ€»ç»“ï¼š1.å…±è¿›è¡Œæ•°ç»„å¤§å°-1æ¬¡å¾ªç¯2.æ¯æ¬¡æ’åºçš„æ¬¡æ•°é€æ¸å‡å°‘ ä¼˜åŒ–ï¼šè‹¥ä¸€è¶Ÿæ’åºä¸­æ²¡æœ‰ä¸€æ¬¡äº¤æ¢ï¼Œåˆ™åœæ­¢å¾ªç¯å¢åŠ æ ‡å¿—å˜é‡flag=falseï¼Œå‘ç”Ÿäº¤æ¢æ—¶ï¼Œç½®flagä¸ºtrueï¼Œä¸€æ¬¡å¾ªç¯ååˆ¤æ–­flagï¼Œè‹¥ä¸ºtrueï¼Œåˆ™é‡ç½®flagä¸ºfalseç»§ç»­å¾ªç¯ï¼Œå¦åˆ™breakï¼› 1234567891011121314151617181920212223242526272829int[] array = {3, 9, -1, 8, 2}; boolean flag=false; int temp=0; for (int i=0; i&lt; array.length-1;i++){ System.out.println(\"å¼€å§‹ç¬¬\"+(i+1)+\"è¶Ÿæ’åº\"); for (int j=0;j&lt;array.length-1-i;j++){ if (array[j]&gt;array[j+1]){ temp=array[j]; array[j]=array[j+1]; array[j+1]=temp; flag=true; } System.out.println(Arrays.toString(array)); } System.out.println(\"ç¬¬\"+(i+1)+\"è¶Ÿæ’åºç»“æœï¼š\"); System.out.println(Arrays.toString(array)); System.out.println(\"------------------\"); if (!flag){ //æœªå‘ç”Ÿä¸€æ¬¡äº¤æ¢ï¼Œflagä¸ºfalse break; }else { //å‘ç”Ÿäº†äº¤æ¢ï¼Œflagè¢«ç½®ä¸ºtrue flag=false; //é‡ç½®flagï¼Œç»§ç»­å¾ªç¯ } } è¿™é‡Œå› ä¸ºæ•°æ®åŸå› ä»ç„¶æ‰§è¡Œäº†4æ¬¡å¯ä»¥æ¢ä¸€ç»„æ•°æ®:{3,9,-1,8,10}ç»“æœï¼š 123456789101112131415161718192021å¼€å§‹ç¬¬1è¶Ÿæ’åº[3, 9, -1, 8, 10][3, -1, 9, 8, 10][3, -1, 8, 9, 10][3, -1, 8, 9, 10]ç¬¬1è¶Ÿæ’åºç»“æœï¼š[3, -1, 8, 9, 10]------------------å¼€å§‹ç¬¬2è¶Ÿæ’åº[-1, 3, 8, 9, 10][-1, 3, 8, 9, 10][-1, 3, 8, 9, 10]ç¬¬2è¶Ÿæ’åºç»“æœï¼š[-1, 3, 8, 9, 10]------------------å¼€å§‹ç¬¬3è¶Ÿæ’åº[-1, 3, 8, 9, 10][-1, 3, 8, 9, 10]ç¬¬3è¶Ÿæ’åºç»“æœï¼š[-1, 3, 8, 9, 10]------------------ å¯ä»¥çœ‹åˆ°åªæ‰§è¡Œäº†ä¸‰æ¬¡æ’åº æµ‹è¯•åä¸‡æ¡æ•°æ®æ‰§è¡Œæ—¶é—´:12345678910111213//åˆ›å»º50000ä¸ªéšæœºæ•°ç»„ int[] array =new int[100000]; for (int i=0;i&lt;100000;i++){ array[i]=(int)(Math.random()*100000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); bubbleSort(array); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572061280770ç»“æŸæ—¶é—´1572061302883ç”¨æ—¶ï¼š22113ms å½“ç„¶æ¯æ¬¡æ‰§è¡Œæ—¶é—´ä¸ä¸€æ ·ï¼Œä½†å½“æ•°æ®å¤§çš„æ—¶å€™æ€»ä½“æ•ˆç‡è¿˜æ˜¯å¾ˆä½çš„","link":"/posts/20200107-bubbleSort.html"},{"title":"åŸºæ•°æ’åº-------------javaå®ç°","text":"ä¸€ã€åŸºæœ¬æ€æƒ³1.åŸºæ•°æ’åº(Radix Sort)å±äºåˆ†é…å¼æ’åºï¼ˆdistribution sortï¼‰ï¼Œåˆç§°â€æ¡¶å­æ³•â€(Bucket Sortæˆ–Bin Sort)ï¼Œå®ƒæ˜¯é€šè¿‡é”®å€¼çš„å„ä¸ªä½çš„å€¼ï¼Œå°†è¦æ’åºçš„å…ƒç´ åˆ†é…è‡³æŸäº›â€œæ¡¶â€ä¸­ï¼Œè¾¾åˆ°æ’åºçš„ä½œç”¨ã€‚2.åŸºæ•°æ’åºå±äºç¨³å®šçš„æ’åºï¼ŒåŸºæ•°æ’åºæ³•çš„æ˜¯æ•ˆç‡é«˜çš„ç¨³å®šæ€§æ’åºæ³• 3.åŸºæ•°æ’åº(Radix Sort)æ˜¯æ¡¶æ’åºçš„æ‰©å±•4.å°†æ‰€æœ‰å¾…æ¯”è¾ƒæ•°å€¼ç»Ÿä¸€ä¸ºåŒæ ·çš„æ•°ä½é•¿åº¦ï¼Œæ•°ä½è¾ƒçŸ­çš„æ•°å‰é¢è¡¥é›¶ã€‚ç„¶åï¼Œä»æœ€ä½ä½å¼€å§‹ï¼Œä¾æ¬¡è¿›è¡Œä¸€æ¬¡æ’åºã€‚è¿™æ ·ä»æœ€ä½ä½æ’åºä¸€ç›´åˆ°æœ€é«˜ä½æ’åºå®Œæˆä»¥å, æ•°åˆ—å°±å˜æˆä¸€ä¸ªæœ‰åºåºåˆ—ã€‚ å¹³å‡æ—¶é—´å¤æ‚åº¦ï¼š O(n+k) æœ€ä¼˜æƒ…å†µï¼š O(n+k) æœ€åæƒ…å†µï¼š O(nÂ²) ç©ºé—´å¤æ‚åº¦: O(n+k) ç¨³å®šæ€§ï¼š ç¨³å®š äºŒã€ä¸¾ä¾‹è¯´æ˜ç°æœ‰ä¸€ç»„æ•°æ®ï¼š{43,3,535,738,14,21,0} ç¬¬ä¸€è½®æ’åºï¼š ç¬¬1è½®æ’åºåï¼š0,21,43,4,14,535,738 ç¬¬äºŒè½®æ’åºï¼šç¬¬äºŒè½®æ’åºç»“æœï¼š0,4ï¼Œ14,21,535,738,43 ç¬¬ä¸‰è½®æ’åºï¼šç¬¬ä¸‰è½®æ’åºç»“æœï¼š0,4ï¼Œ14,21,43,535,738 ä¸‰ã€ä»£ç å®ç°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768package com.wml.sort;import java.util.Arrays;/** * @author MaoLin Wang * @date 2019/10/3012:53 */public class RadixSort { public static void main(String[] args) { int[] arr={53,3,542,748,14,21,0}; radixSort(arr); } public static void radixSort(int[] arr){ //æ±‚æœ€å¤§æ•°çš„ä½æ•° int max = arr[0]; for (int i = 1;i &lt; arr.length; i++){ if (arr[i] &gt;max){ max = arr[i]; } } //å¾—åˆ°æœ€å¤§æ•°çš„ä½æ•° int maxLength = (max+\"\").length(); //ä¸ºé˜²æ­¢æ•°æ®æº¢å‡ºï¼Œåº”å°†åˆ—æ•°è®¾ä¸ºæ•°ç»„é•¿åº¦ int [][] bucket=new int[10][arr.length]; //è®°å½•æ¯ä¸ªæ¡¶ä¸­å®é™…å­˜æ”¾äº†å¤šå°‘æ•°æ® int[] bucketElementCounts=new int[10]; /** * nä»£è¡¨ä½æ•°ï¼Œåˆå§‹åŒ–ä¸º1ï¼Œä»£è¡¨ä¸ªä½ */ for (int i=0 ,n = 1;i&lt; maxLength;i++,n *=10){ for (int j=0;j&lt;arr.length;j++){ //å–å‡ºä¸ªä½çš„å€¼ int value= arr[j] /n %10; //æ”¾å…¥ä¸ªä½å€¼ä¸ºvalueçš„æ¡¶çš„ç¬¬bucketElementCounts[value]ä¸ªä½ç½®ï¼Œåˆšå¼€å§‹bucketElementCounts[value]ä¸º0ï¼Œæ¯æ”¾å…¥ä¸€ä¸ªæ•°æ®å°±+1 bucket[value][bucketElementCounts[value]]=arr[j]; bucketElementCounts[value]++; } int index = 0;//åŸå§‹æ•°ç»„ä¸‹è¾¹ï¼Œåˆå§‹ä¸º0 // System.out.println(Arrays.toString(bucketElementCounts)); //éå†æ¯ä¸ªæ¡¶ï¼Œå°†æ¡¶ä¸­æ•°æ®æ”¾å›åŸæ¥æ•°ç»„ for (int k=0;k&lt;bucketElementCounts.length;k++){ //ç¬¬kä¸ªæ¡¶ ä¸ç­‰äº0ï¼Œå³è¯¥æ¡¶æœ‰æ•°æ® if (bucketElementCounts[k] !=0){ //éå†è¯¥æ¡¶æ•°æ®ï¼Œæ”¾å…¥åŸæ•°ç»„ for (int m=0;m&lt;bucketElementCounts[k];m++){ //å–å‡ºå…ƒç´ æ”¾åˆ°arr arr[index++] = bucket[k][m]; } } //ç¬¬i+1è½®å¤„ç†åï¼Œéœ€è¦å°†æ¯ä¸ªbucketElementCounts[k] = 0 bucketElementCounts[k]=0; } System.out.println(\"ç¬¬\"+(i+1)+\"è½®ç»“æœ\"+ Arrays.toString(arr)); } }} ç»“æœï¼šç¬¬1è½®ç»“æœ[0, 21, 542, 53, 3, 14, 748]ç¬¬2è½®ç»“æœ[0, 3, 14, 21, 542, 748, 53]ç¬¬3è½®ç»“æœ[0, 3, 14, 21, 53, 542, 748] æµ‹è¯•80wæ¡æ•°æ®è€—æ—¶12345678910111213int[] arr =new int[800000]; for (int i=0;i&lt;800000;i++){ arr[i]=(int)(Math.random()*800000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); radixSort(arr); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼šå¼€å§‹æ—¶é—´1572416316975ç»“æŸæ—¶é—´1572416317084ç”¨æ—¶ï¼š109ms å¾ˆæ˜æ˜¾æ¯”ä¹‹å‰çš„å½’å¹¶ã€å¿«é€Ÿæ’åºéƒ½å¿«çš„å¤šï¼Œä½†æ˜¯å…¶ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå¯¹äºä»»ä½•ä½æ•°ä¸Šçš„åŸºæ•°è¿›è¡Œâ€œè£…æ¡¶â€æ“ä½œæ—¶ï¼Œéƒ½éœ€è¦n+kä¸ªä¸´æ—¶ç©ºé—´(kä¸ºæ¡¶æ•°)ï¼Œéå¸¸è€—è´¹ç©ºé—´","link":"/posts/20200107-jishuSort.html"},{"title":"å¸Œå°”æ’åº-----------javaå®ç°","text":"é¦–å…ˆçœ‹ä¸€ä¸‹ä¹‹å‰ä½¿ç”¨ç®€å•æ’å…¥æ’åºå­˜åœ¨çš„é—®é¢˜ï¼š å½“å­˜åœ¨ä¸€ä¸ªæ•°ç»„ï¼Œå…¶æœ€åä¸€ä¸ªæ•°æ®ä¸ºæœ€å°å€¼ï¼Œå¦‚ï¼šarr={5,6,16,34,33,2} è¿™æ ·çš„è¯éœ€è¦å¾ªç¯åˆ°æœ€åä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯ç¬¬6æ¬¡çš„æ—¶å€™ï¼Œæ‰å¯ä»¥å°†2æ’åˆ°å‰è¾¹ï¼Œæ•ˆç‡éå¸¸ä½ ä½†æ˜¯å¸Œå°”æ’åºï¼ˆåŸºäºæ’å…¥æ’åºï¼‰å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶æ˜¯ç®€å•æ’å…¥æ’åºæ”¹è¿›åçš„ä¸€ä¸ªæ•ˆç‡è¾ƒé«˜çš„æ’åºæ–¹å¼ ï¼Œä¹Ÿå«ç¼©å°å¢é‡æ’åº å¤æ‚åº¦ï¼š å¹³å‡æ—¶é—´ï¼š Oï¼ˆnlognï¼‰ æœ€å·®: O(nÂ²) æœ€ä¼˜: O(n^1/3) ç©ºé—´å¤æ‚åº¦ï¼šO(1) ç¨³å®šæ€§ï¼š ä¸ç¨³å®š æ¯”æ’å…¥å’Œé€‰æ‹©æ’åºå¿«å¾—å¤šï¼Œä¸”æ•°ç»„è¶Šå¤§ï¼Œä¼˜åŠ¿è¶Šå¤§ ä¸€ã€åŸºæœ¬æ€æƒ³å¸Œå°”æ’åºæŒ‰æŸä¸ªå¢é‡åˆ†ç»„ï¼Œå¯¹æ¯ä¸ªåˆ†ç»„ä½¿ç”¨ç›´æ¥æ’å…¥æ’åºå®ç°ï¼Œéšç€å¢é‡é€æ¸å‡å°ï¼Œæ¯ç»„æ•°æ®é€æ¸å¢åŠ ï¼Œå½“å¢é‡å‡å°‘è‡³1æ—¶ï¼Œä»…å‰©ä¸‹å®Œæ•´çš„ä¸€ç»„ï¼Œæ’åºç»“æŸã€‚ äºŒã€æ’åºåˆ†æ) å›¾ç‰‡å¼•ç”¨è‡ªhttps://blog.csdn.net/qq_28081081/article/details/80598960 ä¸‰ã€ä»£ç å®ç°1234567891011121314151617181920212223242526272829303132/** * å¸Œå°”æ’åº * @author MaoLin Wang * @date 2019/10/2817:43 */public class ShellSort { public static void main(String[] args) { int[] arr={214,32,11,2,3,2,66,33,54,12}; shellSort(arr); } public static void shellSort(int[]arr){ int temp=0; int count=0; for (int group =arr.length/2;group&gt;0;group/=2){ for (int i=group;i&lt;arr.length;i++){ for (int j=i-group;j&gt;=0;j-=group){ if (arr[j]&gt;arr[j+group]){ temp=arr[j]; arr[j]=arr[j+group]; arr[j+group]=temp; } } } System.out.println(\"ç¬¬\"+(++count)+\"æ¬¡æ’åºç»“æœï¼š\"); System.out.println(Arrays.toString(arr)); } }} ç»“æœï¼š 123456ç¬¬1æ¬¡æ’åºç»“æœï¼š[2, 32, 11, 2, 3, 214, 66, 33, 54, 12]ç¬¬2æ¬¡æ’åºç»“æœï¼š[2, 2, 3, 12, 11, 32, 54, 33, 66, 214]ç¬¬3æ¬¡æ’åºç»“æœï¼š[2, 2, 3, 11, 12, 32, 33, 54, 66, 214] æµ‹è¯•100000æ¡æ•°æ®è€—æ—¶ï¼š 123456789101112int[] arr =new int[100000];for (int i=0;i&lt;100000;i++){ arr[i]=(int)(Math.random()*100000);}long begintime=System.currentTimeMillis();System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime);shellSort(arr);long endtime=System.currentTimeMillis();System.out.println(\"ç»“æŸæ—¶é—´\"+endtime);System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572260920132ç»“æŸæ—¶é—´1572260930389ç”¨æ—¶ï¼š10257ms å‘ç°ç”¨äº†10000å¤šmsï¼Œä¸ä½†æ²¡æœ‰æé«˜æ•ˆç‡ï¼Œåè€Œä½äº†éå¸¸å¤šï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ ä»”ç»†çœ‹æˆ‘ä»¬çš„ä»£ç è¿›è¡Œäº¤æ¢çš„æ¡ä»¶ï¼Œå‘ç°åªè¦æ»¡è¶³arr[j]&gt;arr[j+group]å°±è¦è¿›è¡Œäº¤æ¢ï¼Œæ— ç–‘å¢åŠ äº†ç³»ç»Ÿå¼€é”€ æ¥ä¸‹æ¥å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼š 123456789101112131415161718192021222324252627282930313233public static void shellSort2(int arr[]) { for (int group = arr.length / 2; group &gt; 0; group /= 2) { for (int i = group; i &lt; arr.length; i++) { int j = i; int temp = arr[j]; if (arr[j] &lt; arr[j - group]) { while ((j - group) &gt;= 0 &amp;&amp; temp &lt; arr[j - group]) { /** * å¼€å§‹ç§»åŠ¨ï¼Œå°†æ¯”arr[j]å¤§çš„arr[j-group]ã€arr[j-group-group]......æŒ‰é¡ºåºç§»åŠ¨åˆ°åä¸€ä¸ªå¢é‡çš„ä½ç½® * å¦‚ 3, 2, 11, 21, 66, 32, 214, 4 * åœ¨groupå‡å°‘åˆ°2ï¼Œæ¯”è¾ƒ32å’Œ4çš„æ—¶å€™ * 1. 4&lt;32 ä¸”æ»¡è¶³whileæ¡ä»¶ï¼Œ æ‰€ä»¥å°†32ç§»åŠ¨åˆ°4,temp=4ï¼Œj=5ï¼ŒæŒ‡å‘32çš„ä½ç½® * æ­¤æ—¶çš„æ•°æ®ä¸º:3, 2, 11, 21, 66, 32, 214, 32 * 2.ç»§ç»­whileå¾ªç¯ * j-group=3&gt;0 temp=4&lt;arr[3]=21ï¼Œæ»¡è¶³whileæ¡ä»¶ * æ‰§è¡Œarr[j]=arr[j-group] -&gt; å°†21çš„ä½ç½®ç§»åŠ¨åˆ°32,tempä»ç„¶ä¸ºä¸€å¼€å§‹çš„4,j=3ï¼ŒæŒ‡å‘21çš„ä½ç½® * æ­¤æ—¶æ•°æ®ä¸ºï¼š3, 2, 11, 21, 66, 21, 214, 32 * 3.ç»§ç»­å¾ªç¯while * j-group=1&gt;0 temp=4&gt;arr[1]=2 ä¸æ»¡è¶³whileæ¡ä»¶ï¼Œé€€å‡ºå¾ªç¯ * 4.æ­¤æ—¶j=3ï¼Œå°†temp=4èµ‹å€¼ç»™arr[j] * æ­¤æ—¶æ•°æ®ä¸ºï¼š3, 2, 11, 4, 66, 21, 214, 32 */ arr[j] = arr[j - group]; j -= group; } //ç»“æŸwhileå¾ªç¯åï¼Œå°†tempæ’å…¥åˆ°arr[j] arr[j] = temp; } } } } æˆ–ç”¨forå¾ªç¯ï¼š 1234567891011121314public static void shellSort(int[] arr){ int j; for (int gap = arr.length/2; gap &gt;0 ; gap/=2) { for (int i = gap; i &lt; arr.length; i++) { int temp=arr[i]; for ( j = i; j -gap &gt;=0&amp;&amp;temp&lt;arr[j-gap] ; j-=gap) { arr[j]=arr[j-gap]; } arr[j]=temp; } } } åŒæ ·æµ‹è¯•10000æ¡æ•°æ®æ’åºçš„è€—æ—¶ï¼š 123å¼€å§‹æ—¶é—´1572264172662ç»“æŸæ—¶é—´1572264172692ç”¨æ—¶ï¼š30ms è€—æ—¶ä»1wå¤šmså‡å°åˆ°30msï¼Œå¤šæ¬¡æµ‹è¯•ä¸Šä¸‹æ³¢åŠ¨ä¹Ÿä¸ä¼šè¶…è¿‡20ms","link":"/posts/20200107-shellSort.html"},{"title":"å¿«é€Ÿæ’åº-------------javaå®ç°","text":"ä¸€ã€åŸºæœ¬æ€æƒ³é€‰æ‹©ä¸€ä¸ªåŸºå‡†æ•°ï¼Œé€šè¿‡ä¸€è¶Ÿæ’åºå°†å¾…æ’åºæ•°æ®åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°éƒ½æ¯”åŸºå‡†æ•°å°ï¼Œå¦ä¸€éƒ¨åˆ†éƒ½æ¯”åŸºå‡†æ•°å¤§ï¼Œç„¶åå†ä½¿ç”¨æ­¤æ–¹æ³•é€’å½’å¯¹ä¸¤éƒ¨åˆ†æ•°æ®è¿›è¡Œå¿«æ’ï¼Œæœ€ç»ˆå®ç°æ•´ä¸ªæ•°æ®çš„æœ‰åºã€‚ äºŒã€è¯¦è§£æ’åºè¿‡ç¨‹ç°æœ‰å¾…æ’åºæ•°æ®ï¼š 1{-21, 312, 44, 11, -23, 2, 10}; å·¦å“¨å…µè®°ä¸ºleftï¼Œå³å“¨å…µè®°ä¸ºright åŸºæ•°=å–ç¬¬ä¸€ä¸ªä½ç½®çš„å…ƒç´  å…ˆå–-21ä½œä¸ºåŸºæ•°ï¼š ç¬¬ä¸€è½®æ’åºï¼š â€‹ â†“ â†“ â€‹ -21ï¼Œ 312ï¼Œ 44ï¼Œ 11ï¼Œ -23ï¼Œ 2ï¼Œ 10 â€‹ å·¦å“¨å…µæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºæ•°-21å¤§çš„æ•°åœæ­¢ï¼Œå³åœ¨312åœæ­¢ï¼Œæ­¤æ—¶left=1 â€‹ å³å“¨å…µæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”åŸºæ•°å°çš„æ•°åœæ­¢ï¼Œå³åœ¨-23åœæ­¢ï¼Œæ­¤æ—¶right=4 â€‹ æ­¤æ—¶ä¸¤ä¸ªå“¨å…µå°šæœªç›¸é‡ï¼Œäº¤æ¢ 312 å’Œ -23 äº¤æ¢åï¼š â€‹ â†“ â†“ â€‹ -21ï¼Œ -23ï¼Œ 44ï¼Œ 11ï¼Œ 312ï¼Œ 2ï¼Œ 10 å·¦å“¨å…µç»§ç»­ç§»åŠ¨ï¼Œåˆ°æ¯”-21å¤§çš„44æ—¶åœæ­¢ï¼Œæ­¤æ—¶left=2 å³å“¨å…µç»§ç»­ç§»åŠ¨ï¼Œåˆ°æ¯”-21å°çš„-23å¤„åœæ­¢ï¼Œæ­¤æ—¶right=1 ä½†å› ä¸ºleft&gt;rightï¼Œè¡¨ç¤ºäºŒè€…å·²ç»ç›¸é‡ï¼Œç»ˆæ­¢æœ¬æ¬¡å¾ªç¯ï¼Œå°†pivotä¸rightä½ç½®å…ƒç´ äº¤æ¢ ä¸‰ã€ä»£ç å®ç°ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475/** * å¿«é€Ÿæ’åº * @author * @date 2019/10/2917:06 */public class QuickSort { public static void main(String[] args) { int[] arr={-21,312,44,11,-23,2,10}; quickSort(arr,0,arr.length-1); System.out.println(Arrays.toString(arr)); } public static &lt;T extends Comparable&lt;? super T&gt;&gt; void quickSort(T[] arr) { if (arr.length==0||arr.length==1){ return; } quickSort(arr, 0, arr.length - 1); } private static &lt;T extends Comparable&lt;? super T&gt;&gt; void quickSort(T[] arr, int left, int right) { if (right&lt;=left){ return; } //æ­¤æ—¶jå·¦è¾¹çš„å…ƒç´ å·²å…¨éƒ¨å°äºarr[j],jå³è¾¹çš„å…ƒç´ å…¨éƒ¨å°äºarr[j] int j=partition(arr,left,right); quickSort(arr,left,j-1); quickSort(arr,j+1,right); } /** * å¿«é€Ÿæ’åºçš„åˆ‡åˆ† * @param arr * @param left * @param right * @param &lt;T&gt; * @return */ public static &lt;T extends Comparable&lt;? super T&gt;&gt; int partition(T[] arr, int left, int right) { int i=left,j=right+1; T pivot = arr[left]; while (true){ //å¾ªç¯ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ¯”pivotå¤§çš„å€¼ï¼Œæˆ–åˆ°è¾¾å°¾éƒ¨ while (arr[++i].compareTo(pivot)&lt;0){ if (i==right){ break; } } //å¾ªç¯ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ¯”pivotå°çš„å€¼ï¼Œæˆ–åˆ°è¾¾é¦–éƒ¨ while (pivot.compareTo(arr[--j])&lt;0){ if (j==left){ break; } } //å¦‚æœiå’Œjç›¸é‡ï¼Œåˆ™ç»ˆæ­¢å¾ªç¯ if (i&gt;=j){ break; } //äº¤æ¢iå’Œjçš„å…ƒç´  swapReferences(arr,i,j); } //å°†pivotæ¢åˆ°jçš„ä½ç½® swapReferences(arr,left,j); return j; } public static &lt;T&gt; void swapReferences(T[] arr,int index1,int index2){ T temp=arr[index1]; arr[index1]=arr[index2]; arr[index2]=temp; }} ç»“æœï¼š [-23, -21, 2, 10, 11, 44, 312] å››ã€æµ‹è¯•10Wæ¡æ•°æ®è€—æ—¶123456789101112int[] arr =new int[100000];for (int i=0;i&lt;100000;i++){ arr[i]=(int)(Math.random()*100000);}long begintime=System.currentTimeMillis();System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime);quickSort(arr,0,arr.length-1);long endtime=System.currentTimeMillis();System.out.println(\"ç»“æŸæ—¶é—´\"+endtime);System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572344644967ç»“æŸæ—¶é—´1572344645031ç”¨æ—¶ï¼š64ms æ­¤æ—¶ä¸å¸Œå°”æ’åºçœ‹ä¸å‡ºå¾ˆå¤§çš„å·®è·ï¼Œå°†æ•°æ®å¢åŠ åˆ°80Wæ¡æµ‹è¯•ç»“æœï¼š å¸Œå°”ï¼š å¼€å§‹æ—¶é—´1572344777821ç»“æŸæ—¶é—´1572344778134ç”¨æ—¶ï¼š313ms å¿«é€Ÿï¼š å¼€å§‹æ—¶é—´1572344758536ç»“æŸæ—¶é—´1572344758711ç”¨æ—¶ï¼š175ms ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼Œå¶å°”ä¼šæœ‰å¸Œå°”æ’åºæ¯”å¿«é€Ÿå¿«çš„æƒ…å†µï¼Œä½†æ˜¯å¤šæ•°æƒ…å†µä¸‹è¿˜æ˜¯å¿«é€Ÿæ¯”å¸Œå°”å¿« äº”ã€ä¼˜åŒ–æ”¹è¿›â€”ä¸‰å–æ ·åˆ‡åˆ†ï¼šåœ¨æœ‰å¤§é‡é‡å¤å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œå‡å¦‚ä¸€ä¸ªå…ƒç´ çš„å­æ•°ç»„å…¨éƒ¨é‡å¤æ—¶ï¼Œæˆ‘ä»¬çš„å¿«é€Ÿæ’åºè¿˜ä¼šç»§ç»­å°†å…¶åˆ‡åˆ†ä¸ºæ›´å°çš„æ•°ç»„ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¯¹å®ƒè¿›è¡Œæ’åºï¼Œé‚£ä¹ˆæ€§èƒ½ä¼šæå‡å¾ˆå¤šï¼Œä»å½“å‰çš„çº¿æ€§å¯¹æ•°çº§åˆ«æé«˜åˆ°çº¿æ€§çº§åˆ«ã€‚ æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å°†æ•°ç»„åˆ‡åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹åº”å°äºã€ç­‰äºå’Œå¤§äºåˆ‡åˆ†å…ƒç´ çš„æ•°ç»„ã€‚ æ€è·¯å¦‚ä¸‹ï¼š ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆltï¼Œä½¿å¾—a[left]åˆ°a[lt-1]éƒ½å°äºåˆ‡åˆ†å…ƒç´ v ä¸€ä¸ªæŒ‡é’ˆgtï¼Œä½¿å¾—a[gt+1]åˆ°a[right]éƒ½å¤§äºåˆ‡åˆ†å…ƒç´ v ä¸€ä¸ªæŒ‡é’ˆiï¼Œä½¿ç”¨a[lt]åˆ°a[i-1]éƒ½ç­‰äºåˆ‡åˆ†å…ƒç´ v è€Œa[i]åˆ°a[gt]å…ƒç´ å°šæœªç¡®å®šã€‚ å½“i&lt;=gtæ—¶å¾ªç¯ï¼š 1.a[i] &lt; v: å°†a[i]ä¸a[lt]äº¤æ¢ï¼Œå¹¶è®© i å’Œ lt åŠ ä¸€ï¼Œæ­¤æ—¶ltå·¦è¾¹çš„ä¸€å®šå°äºv 2.a [i] &gt; v: å°†a[i]ä¸a[gt]äº¤æ¢ï¼Œå¹¶è®© gt å‡ä¸€ï¼Œæ­¤æ—¶gtå³è¾¹çš„ä¸€å®šå¤§äºv 3. a[i] = v : ç›´æ¥è®© i åŠ ä»¥ æ­¤æ—¶ lt åˆ° i-1 éƒ½ç­‰äºv å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132/** * ä¸‰å–æ ·åˆ‡åˆ† * @param arr * @param left * @param right * @param &lt;T&gt; */ public static &lt;T extends Comparable&lt;? super T&gt;&gt; void quickSort3Way(T[] arr, int left, int right) { if (right&lt;=left){ return; } if (left+1&lt;=right){ //åˆå§‹åŒ–ä¸‰ä¸ªæŒ‡é’ˆ int lt=left,i=lt+1,gt=right; T v = arr[left]; while (i&lt;=gt){ int result=arr[i].compareTo(v); if (result&lt;0){ swapReferences(arr,lt++,i++); }else if (result&gt;0){ swapReferences(arr,i,gt--); }else { i++ ; } } quickSort3Way(arr,left,lt-1); quickSort3Way(arr,gt+1,right); }else { insertSort(arr,left,right); } } ä½†æ˜¯è¯¥ç®—æ³•åœ¨é‡å¤å…ƒç´ ä¸å¤šçš„æ™®é€šæƒ…å†µä¸‹æ¯”æ ‡å‡†çš„ç®—æ³•å¤šç”¨äº†å¾ˆå¤šæ¬¡äº¤æ¢ã€‚è€Œè§£å†³è¯¥é—®é¢˜çš„å¿«é€Ÿä¸‰å‘æ’åºçš„æœ€ä¼˜è§£æ³•ç”±J.Bentlyå’ŒD.McIlroyç»™å‡ºç­”æ¡ˆã€‚ ç®—æ³•ç¬¬å››ç‰ˆä¸­2.3èŠ‚è¯¾åç»ƒä¹ 2.3.22é¢˜ç»™å‡ºäº†ç›¸å…³è§£è¯»ã€‚ æœ‰æ—¶é—´å†è§£è¯»ï¼Œç›¸å…³å®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152package com.datastructures2.sort;import edu.princeton.cs.algs4.StdIn;import edu.princeton.cs.algs4.StdOut;public class Quick3Way { // cutoff to insertion sort, must be &gt;= 1 private static final int INSERTION_SORT_CUTOFF = 8; // cutoff to median-of-3 partitioning private static final int MEDIAN_OF_3_CUTOFF = 40; // This class should not be instantiated. private Quick3Way() { } /** * Rearranges the array in ascending order, using the natural order. * * @param a * the array to be sorted */ public static void sort(Comparable[] a) { sort(a, 0, a.length - 1); } private static void sort(Comparable[] a, int lo, int hi) { int length = hi - lo + 1; // cutoff to insertion sort if (length &lt;= INSERTION_SORT_CUTOFF) { insertionSort(a, lo, hi); return; } // use median-of-3 as partitioning element else if (length &lt;= MEDIAN_OF_3_CUTOFF) { int m = median3(a, lo, lo + length / 2, hi); exch(a, m, lo); } // use Tukey ninther as partitioning element else { int eps = length / 8; int mid = lo + length / 2; int m1 = median3(a, lo, lo + eps, lo + eps + eps); int m2 = median3(a, mid - eps, mid, mid + eps); int m3 = median3(a, hi - eps - eps, hi - eps, hi); int ninther = median3(a, m1, m2, m3); exch(a, ninther, lo); } // Bentley-McIlroy 3-way partitioning int i = lo, j = hi + 1; int p = lo, q = hi + 1; Comparable v = a[lo]; while (true) { while (less(a[++i], v)) if (i == hi) break; while (less(v, a[--j])) if (j == lo) break; // pointers cross if (i == j &amp;&amp; eq(a[i], v)) exch(a, ++p, i); if (i &gt;= j) break; exch(a, i, j); if (eq(a[i], v)) exch(a, ++p, i); if (eq(a[j], v)) exch(a, --q, j); } i = j + 1; for (int k = lo; k &lt;= p; k++) exch(a, k, j--); for (int k = hi; k &gt;= q; k--) exch(a, k, i++); sort(a, lo, j); sort(a, i, hi); } private static void insertionSort(Comparable[] a, int lo, int hi) { for (int i = lo; i &lt;= hi; i++) for (int j = i; j &gt; lo &amp;&amp; less(a[j], a[j - 1]); j--) exch(a, j, j - 1); } // è¿”å›a [left]ï¼Œa [mid]å’Œa [right]ä¹‹é—´çš„ä¸­å€¼å…ƒç´ çš„ç´¢å¼• private static int median3(Comparable[] a, int left, int mid, int right) { return (less(a[left], a[mid]) ? (less(a[mid], a[right]) ? mid : less(a[left], a[right]) ? right : left) : (less(a[right], a[mid]) ? mid : less(a[right], a[left]) ? right : left)); } // is v &lt; w ? private static boolean less(Comparable v, Comparable w) { return v.compareTo(w) &lt; 0; } // does v == w ? private static boolean eq(Comparable v, Comparable w) { return v.compareTo(w) == 0; } // exchange a[i] and a[j] private static void exch(Object[] a, int i, int j) { Object swap = a[i]; a[i] = a[j]; a[j] = swap; } /*************************************************************************** * Check if array is sorted - useful for debugging. ***************************************************************************/ private static boolean isSorted(Comparable[] a) { for (int i = 1; i &lt; a.length; i++) if (less(a[i], a[i - 1])) return false; return true; } // print array to standard output private static void show(Comparable[] a) { for (int i = 0; i &lt; a.length; i++) { StdOut.println(a[i]); } } /** * Reads in a sequence of strings from standard input; quicksorts them * (using an optimized version of quicksort); and prints them to standard * output in ascending order. * * @param args * the command-line arguments */ public static void main(String[] args) { String[] a = StdIn.readAllStrings(); Quick3Way.sort(a); assert isSorted(a); show(a); }}","link":"/posts/20200107-quickSort.html"},{"title":"æ’å…¥æ’åº-----------javaå®ç°","text":"ä¸€ã€å¤æ‚åº¦123456å¹³å‡æ—¶é—´å¤æ‚åº¦ï¼š O(nÂ²)æœ€å·®æ—¶ï¼š O(nÂ²)æ˜¯å¦ç¨³å®šï¼š ç¨³å®šç©ºé—´å¼€é”€ï¼š O(1)åœ¨å¤§éƒ¨åˆ†æ•°æ®å·²ç»æ’å¥½åºæ—¶æ€§èƒ½è¾ƒå¥½ä¹Ÿå¾ˆé€‚åˆå°è§„æ¨¡æ•°ç»„ äºŒã€åŸºæœ¬æ€æƒ³å°†nä¸ªå¾…æ’åºå…ƒç´ çœ‹æˆä¸€ä¸ªæœ‰åºè¡¨å’Œä¸€ä¸ªæ— åºè¡¨ï¼Œå¼€å§‹æœ‰åºè¡¨åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ¯æ¬¡æ’åºä»æ— éœ€è¡¨ä¸­å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå°†å®ƒçš„å€¼ä¾æ­¤å’Œæœ‰åºè¡¨å…ƒç´ çš„æ•°æ®æ¯”è¾ƒï¼Œæ’å…¥åˆ°æœ‰åºè¡¨çš„é€‚å½“ä½ç½®ï¼Œå½¢æˆæ–°çš„æœ‰åºè¡¨ è¯¦è§£ï¼š åˆå§‹æ•°æ®ï¼š18, 5, 54, 2, 33, 12 ç¬¬ä¸€æ¬¡æ’åºï¼š5ï¼Œ 18ï¼Œ 54ï¼Œ 2ï¼Œ 33ï¼Œ12 ç¬¬äºŒæ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ 18ï¼Œ 54ï¼Œ 33ï¼Œ12 ç¬¬ä¸‰æ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ12 18ï¼Œ 54ï¼Œ 33 ç¬¬å››æ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ12 18ï¼Œ33ï¼Œ 54 ç¬¬äº”æ¬¡æ’åºï¼š2ï¼Œ5ï¼Œ12 18ï¼Œ33ï¼Œ54 ä¸‰ã€ä»£ç å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * @author MaoLin Wang * @date 2020/2/1814:35 */public class InsertSort{ /** * æ’å…¥æ’åº * @param arr */ public static &lt;T extends Comparable&lt;? super T&gt;&gt; void insertSort(T [] arr){ int j; for (int i = 1; i &lt; arr.length; i++) { T temp=arr[i]; for ( j = i; j &gt;0&amp;&amp;temp.compareTo(arr[j-1])&lt;0 ; j--) { arr[j]=arr[j-1]; } arr[j]=temp; } } /** * æ’å…¥æ’åº å¯¹arrçš„leftåˆ°rightä½ç½®æ’åº * @param arr * @param &lt;T&gt; */ public static &lt;T extends Comparable&lt;? super T&gt;&gt; void insertSort(T [] arr,int left,int right){ int j; for (int i = left; i &lt;= right; i++) { T temp=arr[i]; for ( j = i; j &gt;left&amp;&amp;temp.compareTo(arr[j-1])&lt;0 ; j--) { arr[j]=arr[j-1]; } arr[j]=temp; } } public static void main(String[] args) { Integer [] arr={2,44,1,2,6,4}; insertSort(arr); for(Integer i:arr){ System.out.println(i); } }} ç»“æœï¼š 123456789101112ç¬¬1æ¬¡æ’åºç»“æœï¼š[43, 213, 22, 11, 324, 11, 4]ç¬¬2æ¬¡æ’åºç»“æœï¼š[22, 43, 213, 11, 324, 11, 4]ç¬¬3æ¬¡æ’åºç»“æœï¼š[11, 22, 43, 213, 324, 11, 4]ç¬¬4æ¬¡æ’åºç»“æœï¼š[11, 22, 43, 213, 324, 11, 4]ç¬¬5æ¬¡æ’åºç»“æœï¼š[11, 11, 22, 43, 213, 324, 4]ç¬¬6æ¬¡æ’åºç»“æœï¼š[4, 11, 11, 22, 43, 213, 324] å››ã€æµ‹è¯•100000æ¡æ•°æ®è€—æ—¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.wml.sort;import java.util.Arrays;/** * @author *** * @date 2019/10/2816:55 */public class InsertSort { public static void main(String[] args) { int[] array =new int[100000]; for (int i=0;i&lt;100000;i++){ array[i]=(int)(Math.random()*100000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); insertSort(array); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); } public static void insertSort(int[] arr){ for (int i=1;i&lt;arr.length;i++){ //å¾…æ’å…¥æ•°æ® int insertVal=arr[i]; //å¾…æ’å…¥ä½ç½®ä¸‹æ ‡ int insertIndex=i-1; /** * å¦‚æœå¾…æ’å…¥ä¸‹æ ‡å°äºé›¶ï¼Œè¯´æ˜å¾…æ’å…¥æ•°æ®æœ€å°ï¼Œåº”æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½® * å¦‚æœå¾…æ’å…¥å€¼å¤§äºarr[inserIndex]ï¼Œåˆ™åœæ­¢å¾ªç¯ï¼Œè¯´æ˜å¾…æ’å…¥å€¼åœ¨æœ‰åºè¡¨ä¸­æ˜¯æœ€å¤§çš„ï¼Œåº”æ’å…¥åˆ°å½“å‰insertIndexåä¸€ä¸ªä½ç½® */ while (insertIndex&gt;=0 &amp;&amp; insertVal&lt;arr[insertIndex]){ arr[insertIndex+1]=arr[insertIndex]; insertIndex--; } arr[insertIndex+1]=insertVal; } }} ç»“æœï¼š 123å¼€å§‹æ—¶é—´1572254640158ç»“æŸæ—¶é—´1572254641586ç”¨æ—¶ï¼š1428ms ç›¸æ¯”ä¸Šä¸€ç¯‡çš„é€‰æ‹©æ’åºçš„5811msæ€»ä½“åˆå¿«äº†è®¸å¤š","link":"/posts/20200107-insertSort.html"},{"title":"é€‰æ‹©æ’åº  ------javaå®ç°","text":"ä¸€ã€é€‰æ‹©æ’åºçš„æ€æƒ³ç¬¬ä¸€æ¬¡ä»arr[0]~arr[n-1]ä¸­é€‰å–æœ€å°å€¼ä¸arr[0]äº¤æ¢ï¼Œç¬¬äºŒæ¬¡ä»arr[1]åˆ°arr[n-1]ä¸­é€‰å–æœ€å°å€¼ä¸arr[1]äº¤æ¢ï¼Œç¬¬ä¸‰æ¬¡ä»arr[2]åˆ°arr[n-1]ä¸­é€‰å–æœ€å°å€¼ä¸arr[2]äº¤æ¢ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæ€»å…±å¾ªç¯n-1æ¬¡ï¼Œå¾—åˆ°ä¸€ä¸ªä»å°åˆ°å¤§çš„æœ‰åºåºåˆ—ã€‚ äºŒã€æ€è·¯è¯¦è§£å¾…æ’åºå…ƒç´ ï¼š ==[34]== 54 123 55 11 22 ç¬¬ä¸€æ¬¡æ’åºï¼š ==[11,34]== 54 123 55 22ç¬¬äºŒæ¬¡æ’åº : ==[11,22,34]== 54 123 55ç¬¬ä¸‰æ¬¡æ’åºï¼š ==[11,22,34,54]== 123 55ç¬¬å››æ¬¡æ’åºï¼š ==[11,22,34,54,55]== 123 è¯´æ˜(è¿™é‡ŒæŒ‰ä»å°åˆ°å¤§)ï¼š 1.é€‰æ‹©æ’åºå…±è¿›è¡Œæ•°ç»„å¤§å°-1æ¬¡æ’åº2.æ¯æ¬¡æ’åºä¸­ï¼Œå…ˆè®¾å½“å‰çš„æ•°æ˜¯æœ€å°å€¼ï¼Œç„¶åä¾æ¬¡å’Œåé¢çš„æ•°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°æœ‰æ¯”è¿™ä¸ªæ•°å°çš„ï¼Œå°±è®©æœ€å°çš„æ•°ä¸ºè¿™ä¸ªæ•°ï¼Œå¾—åˆ°æœ€å°å€¼ä¸‹æ ‡ï¼Œéå†ä¸€ä¸ªå¾ªç¯åï¼Œå¾—åˆ°æœ€å°å€¼å’Œä¸‹æ ‡3.å¦‚æœè¯¥å°æ ‡ä¸ä¸€å¼€å§‹çš„ä¸ä¸€æ ·ï¼Œè¯´æ˜å­˜åœ¨æ¯”å¼€å§‹è®¾å®šçš„æœ€å°çš„æ•°è¿˜å°çš„æ•°ï¼Œå°†äºŒè€…äº¤æ¢ï¼Œè¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯ ä¸‰ã€ä»£ç å®ç°12345678910111213141516171819202122232425public static void selectSort(int[] arr){ for (int i=0;i&lt;arr.length-1;i++){ int minIndex=i; int min=arr[i]; for (int j=i+1;j&lt;arr.length;j++){ if (min&gt;arr[j]){ min=arr[j]; minIndex=j; } } //å°†æœ€å°å€¼æ”¾åœ¨arr[0]ã€‚å³äº¤æ¢ if (minIndex!=i){ arr[minIndex]=arr[i]; arr[i]=min; } System.out.println(\"ç¬¬\"+(i+1)+\"è½®åç»“æœ\"); System.out.println(Arrays.toString(arr)); } } public static void main(String[] args) { int[] array={101,222,119,1}; SelectSort.selectSort(array); } ç»“æœï¼š 123456ç¬¬1è½®åç»“æœ[1, 222, 119, 101]ç¬¬2è½®åç»“æœ[1, 101, 119, 222]ç¬¬3è½®åç»“æœ[1, 101, 119, 222] æµ‹è¯•100000æ¡æ•°æ®æ‰§è¡Œæ—¶é—´ï¼š 12345678910111213141516171819202122232425262728package com.wml.sort;import java.util.Arrays;/** * é€‰æ‹©æ’åº * @author MaoLin Wang * @date 2019/10/2811:24 */public class SelectSort { public static void main(String[] args) { //int[] array={101,222,119,1}; int[] array =new int[100000]; for (int i=0;i&lt;100000;i++){ array[i]=(int)(Math.random()*100000); } long begintime=System.currentTimeMillis(); System.out.println(\"å¼€å§‹æ—¶é—´\"+begintime); SelectSort.selectSort(array); long endtime=System.currentTimeMillis(); System.out.println(\"ç»“æŸæ—¶é—´\"+endtime); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\"); } } ç»“æœï¼šç”¨æ—¶ï¼š 123å¼€å§‹æ—¶é—´1572251978745ç»“æŸæ—¶é—´1572251984556ç”¨æ—¶ï¼š5811ms ç›¸æ¯”ä¸Šä¸€ç¯‡å†’æ³¡æ’åºçš„22113mså¿«äº†è®¸å¤š ä½¿ç”¨æ³›å‹ï¼š 12345678910111213141516public static &lt;T extends Comparable&lt;? super T&gt;&gt;void selectSort(T[]arr){ for (int i = 0; i &lt; arr.length; i++) { int minIndex=i; T min=arr[i]; for (int j =i+1; j &lt;arr.length ; j++) { if (arr[j].compareTo(min)&lt;0){ minIndex=j; min=arr[j]; } } if (minIndex!=i){ arr[minIndex]=arr[i]; arr[i]=min; } } } å¹³å‡æ—¶é—´ï¼š O(nÂ²)æœ€å·®ï¼š Oï¼ˆnÂ²ï¼‰æ˜¯å¦ç¨³å®šï¼š ä¸ç¨³å®šç©ºé—´å¤æ‚åº¦ï¼š Oï¼ˆ1ï¼‰å¤‡æ³¨ï¼š nå°æ—¶è¾ƒå¥½","link":"/posts/20200107-selectSort.html"},{"title":"Linuxå‘½ä»¤æ•´ç†-------------æ–‡ä»¶ç®¡ç†ç›¸å…³(ä¸€)","text":"catè¯´æ˜ï¼šç”¨æ¥æ˜¾ç¤ºæ–‡æœ¬å†…å®¹(å°æ–‡ä»¶)ï¼Œå¯¹äºå¤§æ–‡ä»¶æ¨èä½¿ç”¨moreå‘½ä»¤ æ ¼å¼ï¼š cat +é€‰é¡¹+æŒ‡å®šæ–‡ä»¶ â€‹ é€‰é¡¹ï¼š 123&gt; -n æˆ– --numberï¼šæ˜¾ç¤ºè¡Œå·ï¼›&gt; -b æˆ– --number-nonblankï¼šç¼–å·æ—¶å¿½ç•¥ç©ºç™½è¡Œ&gt; -Aï¼šæ˜¾ç¤ºä¸å¯æ‰“å°å­—ç¬¦ï¼Œè¡Œå°¾æ˜¾ç¤ºâ€œ$â€ï¼› å¦‚ï¼š 1234567echo xxx&gt;test è‹¥testä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºtestå¹¶å†™å…¥xxxï¼Œå¦åˆ™ç›´æ¥å†™å…¥cat 123.txt å±å¹•æ˜¾ç¤º123.txtå†…å®¹cat æ–‡æœ¬1 æ–‡æœ¬2 ... æ˜¾ç¤ºå¤šä¸ªæ–‡æœ¬å†…å®¹cat æ–‡æœ¬1 æ–‡æœ¬2 &gt; æ–‡æœ¬3 å°†æ–‡æœ¬1å’Œ2çš„å†…å®¹åˆå¹¶åˆ°æ–‡æœ¬3ä¸­cat æ–‡æœ¬1 &gt; æ–‡æœ¬2 å°†æ–‡æœ¬1å†…å®¹æ‹·è´åˆ°æ–‡æœ¬2cat /dev/null &gt; æ–‡æœ¬1 æ¸…ç©ºæ–‡æœ¬1çš„å†…å®¹cat &gt;test1.txt &lt;&lt;stop å‘test1.txtå†™å…¥å†…å®¹ï¼Œè¾“å…¥stopç»“æŸ æ³¨æ„ï¼šæ¯æ¬¡åˆå¹¶æ—¶ï¼Œæ–‡æœ¬3çš„å†…å®¹ä¼šè¢«é‡æ–°è¦†ç›– moreå…¨å±å¹•æ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶å†…å®¹ é€‰é¡¹ï¼š12345-æ•°å­—ï¼šæ¯å±æ˜¾ç¤ºæŒ‡å®šè¡Œ-cï¼šä¸è¿›è¡Œæ»šå±æ“ä½œã€‚æ¯æ¬¡åˆ·æ–°è¿™ä¸ªå±å¹•ï¼›-sï¼šå°†å¤šä¸ªç©ºè¡Œå‹ç¼©æˆä¸€è¡Œæ˜¾ç¤ºï¼›-uï¼šç¦æ­¢ä¸‹åˆ’çº¿ï¼›+æ•°å­—ï¼šä»æŒ‡å®šæ•°å­—çš„è¡Œå¼€å§‹æ˜¾ç¤ºã€‚ æŸ¥çœ‹æ—¶å¯ç”¨å‘½ä»¤ï¼š Spaceé”®ï¼šæ˜¾ç¤ºæ–‡æœ¬çš„ä¸‹ä¸€å±å†…å®¹ã€‚ Enteré”®ï¼šæ¯æ¬¡åˆ·æ–°ä¸€è¡Œ Hé”®ï¼šæ˜¾ç¤ºç›¸å…³çš„å¸®åŠ©ä¿¡æ¯ Bé”®ï¼šæŸ¥çœ‹ä¸Šä¸€å± qé”®ï¼šé€€å‡º â€‹â€‹ cd1.cd : è¿›å…¥ç›®å½• 2.cd ~: è¿›å…¥ç”¨æˆ·ç›®å½• 3.cd - : è¿›å…¥å†å²ä¸Šä¸€çº§ç›®å½•ï¼Œå³è¿›æ­¤ç›®å½•ä¹‹å‰çš„é‚£ä¸ªç›®å½• 4.cd .. ï¼šè¿”å›ä¸Šçº§ç›®å½• cd ../../ æœ‰å‡ ä¸ª.../å°±è¿”å›ä¸Šå‡ çº§ç›®å½• ls æ˜¾ç¤ºç›®æ ‡åˆ—è¡¨ é€‰é¡¹ -a æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼ˆåœ¨linuxä¸­ä»¥.å¼€å¤´çš„æ–‡ä»¶ä¸ºéšè—æ–‡ä»¶ï¼‰ -l æ˜¾ç¤ºæ–‡æœ¬çš„è¯¦æƒ…åŒ…æ‹¬(æƒé™ã€æ‹¥æœ‰è€…ã€æ–‡ä»¶å¤§å°ã€æœ€åä¿®æ”¹æ—¶é—´ç­‰) -r å°†æ–‡ä»¶ååºæ˜¾ç¤º(é»˜è®¤æŒ‰ç…§è‹±æ–‡å­—æ¯é¡ºåº) -t æŒ‰ç…§åˆ›å»ºæ—¶é—´åˆ—å‡º -A åŒ -a ï¼Œä½†ä¸åˆ—å‡º &quot;.&quot; (ç›®å‰ç›®å½•) åŠ &quot;..&quot; (çˆ¶ç›®å½•) -F åœ¨æ–‡ä»¶åç§°ååŠ ä¸€ä¸ªç¬¦å·ï¼š *ï¼šä»£è¡¨å¯æ‰§è¡Œæ¡£ /ï¼š ä»£è¡¨ç›®å½• -R æœ‰æ–‡ä»¶çš„ç›®å½•ï¼Œä¹Ÿä¼šå°†å…¶å­æ–‡ä»¶åˆ—å‡º â€‹ -Rä¸¾ä¾‹ï¼š -Fä¸¾ä¾‹ï¼štest2æ˜¯ä¸€ä¸ªç›®å½•ã€‚æ‰€ä»¥åœ¨åè¾¹æ˜¾ç¤ºäº†ä¸€ä¸ª/ pwd æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰ head æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶å‰Nè¡Œ é€‰é¡¹ï¼š -nï¼šæŒ‡å®šæ˜¾ç¤ºå‰nè¡Œ -vï¼šæ˜¾ç¤ºæ–‡ä»¶åçš„å¤´ä¿¡æ¯ï¼› -qï¼šä¸æ˜¾ç¤ºæ–‡ä»¶åçš„å¤´ä¿¡æ¯ã€‚ tail æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶çš„æœ«å°¾Nè¡Œï¼Œé»˜è®¤10è¡Œ é€‰é¡¹ï¼š -c,â€“bytes=ï¼šæ˜¾ç¤ºæ–‡ä»¶å°¾éƒ¨çš„Nï¼ˆNä¸ºæ•´æ•°ï¼‰ä¸ªå­—èŠ‚å†… -f&lt;name/descriptor&gt;ï¼šåŠ¨æ€æ˜¾ç¤ºæ–‡ä»¶å°¾éƒ¨å†…å®¹ï¼Œå¦‚æŸä¸ªåŠ¨æ€æ›´æ–°çš„æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨-fæŸ¥çœ‹æœ€æ–°çš„å†…å®¹ -nï¼šè¾“å‡ºæ–‡ä»¶çš„å°¾éƒ¨Nï¼ˆNä½æ•°å­—ï¼‰è¡Œå†…å®¹ã€‚ â€“pid=&lt;è¿›ç¨‹å·&gt;ï¼šä¸â€œ-fâ€é€‰é¡¹è¿ç”¨ï¼Œå½“æŒ‡å®šçš„è¿›ç¨‹å·çš„è¿›ç¨‹ç»ˆæ­¢æ—¶é€€å‡ºè¯¥å‘½ä»¤-q,â€“quiet,â€“silentï¼šå½“æœ‰å¤šä¸ªæ–‡ä»¶å‚æ•°æ—¶ï¼Œä¸è¾“å‡ºå„ä¸ªæ–‡ä»¶åï¼› -s&lt;ç§’æ•°&gt;,â€“sleep-interal=&lt;ç§’æ•°&gt;ï¼šä¸â€œ-fâ€è¿ç”¨ï¼ŒæŒ‡å®šæ–‡ä»¶å˜åŒ–æ—¶é—´éš”(s) -v,â€“verboseï¼šå½“æœ‰å¤šä¸ªæ–‡ä»¶å‚æ•°æ—¶ï¼Œæ€»æ˜¯è¾“å‡ºå„ä¸ªæ–‡ä»¶åï¼› â€“helpï¼šå¸®åŠ©ä¿¡æ¯ â€“versionï¼šæŒ‡ä»¤ç‰ˆæœ¬ ä¸¾ä¾‹ï¼š 12345tail test ä¸æŒ‡å®šè¡Œæ•°é»˜è®¤æ˜¾ç¤ºæ–‡ä»¶testçš„æœ€å10è¡Œtail -n +10 test ä»ç¬¬10è¡Œåˆ°æœ€åtail -c 10 test æ˜¾ç¤ºè¯¥æ–‡ä»¶çš„æœ€å10ä¸ªå­—ç¬¦tail -25 nginx.log æ˜¾ç¤ºæœ€åçš„ 25 è¡Œtail -f nginx.log åŠ¨æ€åˆ·æ–°è¯¥æ–‡ä»¶æœ€åçš„å†…å®¹ chmodä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•çš„æƒé™ æƒé™èŒƒå›´ï¼šu: â€“&gt; User ï¼Œå½“å‰æ–‡ä»¶/ç›®å½•çš„æ‹¥æœ‰è€…g: â€“&gt; Group ï¼Œ æ‰€å±ç»„o: â€“&gt; Other ï¼Œ é™¤Userå’Œæ‰€å±ç¾¤ç»„ä¹‹å¤–çš„æ‰€æœ‰ç”¨æˆ·a: â€“&gt; All ï¼Œ æ‰€æœ‰ç”¨æˆ·r: â€“&gt; è¯»æƒé™ï¼Œæ•°å­— 4w:â€“&gt; å†™æƒé™ï¼Œæ•°å­— 2x: æ‰§è¡Œ/åˆ‡æ¢æƒé™ï¼Œæ•°å­— 1- æ— æƒé™ï¼Œæ•°å­— 0 è¯­æ³•ï¼š chmod [options][å‚æ•°] é€‰é¡¹ï¼š 1234567891011121314151617+ æ·»åŠ æŸäº›æƒé™- å–æ¶ˆæŸäº›æƒé™= æŒ‡å®šæ–‡ä»¶æƒé™r è¯»æƒé™w å†™æƒé™x å¯æ‰§è¡Œæƒé™- æ— æƒé™X ç»™å¯æ‰§è¡Œæ–‡ä»¶è®¾ç½®å¯æ‰§è¡Œæƒé™t åªæœ‰ç›®å½•æˆ–æ–‡ä»¶çš„æ‰€æœ‰è€…æ‰å¯ä»¥åˆ é™¤ç›®å½•ä¸‹çš„æ–‡ä»¶-c ,--changes æ•ˆæœç±»ä¼¼â€œ-vâ€å‚æ•°ï¼Œä½†ä»…å›æŠ¥æ›´æ”¹çš„éƒ¨åˆ†ï¼Œå¦‚æœæ–‡ä»¶æƒé™å·²ç»æ”¹å˜ï¼Œæ˜¾ç¤ºå…¶æ“ä½œä¿¡æ¯ï¼›-f , --quiet, --silent æ“ä½œè¿‡ç¨‹ä¸­ä¸æ˜¾ç¤ºä»»ä½•é”™è¯¯ä¿¡æ¯ï¼›-R, --recursive ä»¥é€’å½’æ›´æ”¹å…¶æœ¬èº«åŠå­ç›®å½•-v, --verbose æ˜¾ç¤ºè¯¦æƒ…ä¿¡æ¯--reference=&lt;å‚è€ƒæ–‡ä»¶æˆ–ç›®å½•&gt; æŒ‡å®šå‚è€ƒæ–‡ä»¶ï¼Œéè‡ªå®šä¹‰æƒé™--help æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯--version æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ æƒé™ç»“æ„ï¼š 1-rwxr--r-- 1 user staff 651 Nov 11 11:02 .ignore ç¬¬ä¸€ä¸ª -: ä»£è¡¨æ˜¯æ™®é€šæ–‡ä»¶ï¼Œè‹¥æ˜¯ dï¼Œåˆ™ä»£è¡¨ç›®å½• ç¬¬ä¸€ç»„rwxï¼šå³ä¸Šè¾¹çš„rw-,è¡¨ç¤ºuå±ç»„ ç¬¬äºŒç»„rwx: å³ä¸Šè¾¹ä¸­é—´çš„râ€“ï¼Œè¡¨ç¤ºgå±ç»„ ç¬¬ä¸‰ç»„rwx: å³ä¸Šè¾¹æœ€åçš„râ€“ï¼Œ è¡¨ç¤ºå…¶ä»–äººçš„æƒé™ r:è¯» 4 wï¼šå†™ 2 xï¼šæ‰§è¡Œ 1 ä¸¾ä¾‹: 1234567chmod u+w,g+r test1 ä¸ºtest1è®¾ç½®å½“å‰ç”¨æˆ·å¯å†™ï¼Œç»„å¯è¯»çš„æƒé™chmod u=rwx,g=rw,o=r test1 å½“å‰ç”¨æˆ·å¯è¯»å†™æ‰§è¡Œï¼Œç»„å¯è¯»å†™ï¼Œå…¶ä»–ç”¨æˆ·åªèƒ½è¯»chmod 764 test1 å½“å‰ç”¨æˆ·è¯»å†™æ‰§è¡Œï¼Œç»„è¯»å†™ï¼Œå…¶ä»–åªå¯è¯»chmod a+r test1 æ‰€æœ‰ç”¨æˆ·éƒ½åªå¯è¯»test1chmod ugo-r test1 æ‰€æœ‰ç”¨æˆ·å‡æ‰å¯è¯»æƒé™ chmod -R 755 /usr/local/test/ é€’å½’ä¿®æ”¹testç›®å½•ä¸‹çš„å­æ–‡ä»¶çš„æƒé™ä¸º 755,7å³4+2+1ï¼Œ5å³4+1chown john:student test1 æŠŠtest1ç»™Johnï¼Œæ·»åŠ åˆ°studentç»„ chown æ”¹å˜æ–‡ä»¶æˆ–ç›®å½•çš„æ‹¥æœ‰è€…æˆ–æ‰€å±ç¾¤ç»„ å¯ä»¥ç»™æŸä¸ªç”¨æˆ·æˆæƒï¼Œä½¿è¯¥ç”¨æˆ·å˜æˆæŒ‡å®šæ–‡ä»¶çš„æ‰€æœ‰è€…æˆ–è€…æ”¹å˜æ–‡ä»¶æ‰€å±çš„ç»„ã€‚ è¯­æ³•ï¼š chown [options][å‚æ•°] é€‰é¡¹ï¼š 12345-cï¼Œ--changesï¼šæ˜¾ç¤ºä¿®æ”¹çš„éƒ¨åˆ†ï¼›-f ï¼šä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼›-hï¼šåªå¯¹ç¬¦å·è¿æ¥çš„æ–‡ä»¶ä½œä¿®æ”¹ï¼Œè€Œä¸æ›´æ”¹å…¶ä»–ä»»ä½•ç›¸å…³æ–‡ä»¶ï¼›-Rï¼šé€’å½’å¤„ç†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠå­ç›®å½•-vï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¿¡æ¯ 123chown -R wml:mygroup /usr/local/test1 å°†/usr/local/testä¸‹é¢çš„æ‰€æœ‰æ–‡ä»¶ä»¥åŠå­ç›®å½•çš„æ–‡ä»¶æ‹¥æœ‰è€…æ”¹ä¸ºwml,ç¾¤ç»„ä¸ºmygroup - ## cmp æ¯”è¾ƒä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦æœ‰å·®å¼‚ï¼Œè‹¥æ— å·®å¼‚åˆ™ä¸æ˜¾ç¤ºä»»ä½•ä¿¡æ¯ï¼Œè‹¥æœ‰å·®å¼‚åˆ™æ˜¾ç¤ºç¬¬ä¸€ä¸ªä¸åŒçš„åœ°æ–¹çš„å­—ç¬¦å’Œåˆ—æ•° **è¯­æ³•ï¼š** cmp [options][å‚æ•°] **é€‰é¡¹ï¼š** 12-lï¼šå¯¹äºæ¯å¤„ä¸åŒï¼Œæ˜¾ç¤ºåè¿›åˆ¶çš„å­—èŠ‚æ•°å’Œå…«è¿›åˆ¶çš„ä¸åŒå­—èŠ‚ã€‚ï¼›-sï¼Œ--quitï¼Œ--silentï¼šä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼› **ä¸¾ä¾‹:** 123.txt ï¼š æˆ‘æ˜¯123 222 222.txt: æˆ‘æ˜¯222 222 1cmp 123.txt 222.txt --ç»“æœ--&gt;123.txt 222.txt differ: byte 1, line 1 - ## diff æ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒï¼Œè¯¥å‘½ä»¤æ˜¯é‡‡å–é€è¡Œæ¯”è¾ƒçš„æ–¹å¼ï¼Œ **é€‰é¡¹ï¼š** 12345678910111213-&lt;è¡Œæ•°&gt;ï¼šæŒ‡å®šæ˜¾ç¤ºå¤šå°‘è¡Œçš„æ–‡æœ¬-aï¼Œ--textï¼šå°†æ–‡ä»¶å½“åšæ–‡æœ¬æ–‡ä»¶å¤„ç†-bï¼šå¿½ç•¥ç©ºæ ¼å­—ç¬¦é€ æˆçš„ä¸åŒï¼›-Bï¼Œ--ignore-blank-linesï¼šå¿½ç•¥ç©ºç™½è¡Œï¼›-cï¼šæ˜¾ç¤ºä¸¤ä¸ªæ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ï¼Œå¹¶æ ‡å‡ºä¸åŒä¹‹å¤„-Hï¼Œ--speed-large-filesï¼šåŠ é€Ÿå¤§æ–‡ä»¶æ£€ç´¢-iï¼Œ--ignore-caseï¼šå¿½ç•¥å¤§å°å†™ä¸åŒ-læˆ–â€”â€”paginateï¼šåˆ†é¡µ-qæˆ–--briefï¼šä»…æ˜¾ç¤ºæœ‰æ— å·®å¼‚ï¼Œä¸æ˜¾ç¤ºè¯¦ç»†çš„ä¿¡æ¯ æœ‰ä¸åŒçš„ç»“æœ:Files 123.txt and 222.txt differ-rï¼Œ--recursiveï¼šæ¯”è¾ƒå­ç›®å½•ä¸­çš„æ–‡ä»¶-Tï¼šæ¯è¡Œå¯¹é½è¾“å‡º-yï¼šå¹¶åˆ—æ‰“å° ä¸¾ä¾‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20191028231857879.png) - ## file æ£€æµ‹ç›®æ ‡æ–‡ä»¶ç±»å‹ **é€‰é¡¹ï¼š** 1234-bï¼šä¸æ˜¾ç¤ºæ–‡ä»¶åç§°L-Lï¼šç›´æ¥æ˜¾ç¤ºç¬¦å·è¿æ¥æ‰€æŒ‡å‘çš„æ–‡ä»¶ç±»åˆ«ï¼›-vï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼›-zï¼šå°è¯•å»è§£è¯»å‹ç¼©æ–‡ä»¶çš„å†…å®¹ã€‚ **ä¸¾ä¾‹ï¼š** 123[admin@ test]$ file 123.txt 222.txt123.txt: UTF-8 Unicode text222.txt: UTF-8 Unicode text findæŸ¥è¯¢æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶é€‰é¡¹ï¼š 123456789101112131415161718192021-depthï¼šä»æŒ‡å®šç›®å½•çš„æœ€æ·±å±‚çš„å­ç›®å½•å¼€å§‹æŸ¥æ‰¾-maxdepth&lt;ç›®å½•æ·±åº¦&gt;ï¼šæœ€å¤§ç›®å½•æ·±åº¦-mindepth&lt;ç›®å½•æ·±åº¦&gt;ï¼šæœ€å°ç›®å½•å±‚çº§ï¼›-emptyï¼šæŸ¥æ‰¾å¤§å°ä¸º0 çš„æ–‡ä»¶æˆ–ç©ºç›®å½•-exec&lt;è¦æ‰§è¡Œçš„æŒ‡ä»¤&gt;ï¼šè‹¥findæŒ‡ä»¤è¿”å›Trueï¼Œå°±æ‰§è¡Œç›®æ ‡æŒ‡ä»¤(å¦‚æ‰¾åˆ°ç©ºçš„å°±æ‰§è¡Œrmåˆ é™¤ç›®æ ‡æ–‡ä»¶)-fstype&lt;æ–‡ä»¶ç³»ç»Ÿç±»å‹&gt;ï¼šåªå¯»æ‰¾è¯¥æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸‹çš„æ–‡ä»¶æˆ–ç›®å½•ï¼›-lsï¼šå°†æ–‡ä»¶æˆ–ç›®å½•åç§°åˆ—å‡ºåˆ°æ ‡å‡†è¾“å‡º(æƒé™ä¿¡æ¯ï¼Œæ‰€å±ç”¨æˆ·ã€ç»„ï¼Œæ—¶é—´ä¿¡æ¯ç­‰)-name&lt;inputname&gt;ï¼Œ-inameï¼šæŸ¥è¯¢åç§°ç¬¦åˆinputnameçš„æ–‡ä»¶ï¼Œ-inameå¿½ç•¥å¤§å°å†™-anewer test : æ¯”æ–‡ä»¶ file æ›´æ™šè¢«è¯»å–è¿‡çš„æ–‡ä»¶-path&lt;testPath&gt;ï¼Œ-ipath&lt;testPath&gt;ï¼šè·¯å¾„ç¬¦åˆtestPathçš„æ–‡ä»¶,-ipath å¿½ç•¥å¤§å°å†™-perm&lt;æƒé™å€¼&gt;ï¼šæŸ¥æ‰¾ç¬¦åˆæŒ‡å®šçš„æƒé™æ•°å€¼çš„æ–‡ä»¶-printï¼šå°†æ–‡ä»¶æˆ–ç›®å½•åç§°åˆ—å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚æ ¼å¼ä¸ºæ¯åˆ—ä¸€ä¸ªåç§°ï¼Œæ¯ä¸ªåç§°å‰çš†æœ‰â€œ./â€å­—ç¬¦ä¸²ï¼›-printf&lt;è¾“å‡ºæ ¼å¼&gt;ï¼šè‡ªå®šä¹‰æ ¼å¼è¾“å‡º-size&lt;æ–‡ä»¶å¤§å°&gt;ï¼šæŸ¥æ‰¾ç¬¦åˆæŒ‡å®šå¤§å°çš„æ–‡ä»¶-type&lt;æ–‡ä»¶ç±»å‹&gt;ï¼šæŒ‡å®šçš„æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶-user&lt;æ‹¥æœ‰è€…åç§°&gt;ï¼šæŒ‡å®šç”¨æˆ·æ‹¥æœ‰çš„æ–‡ä»¶ ä¸¾ä¾‹ï¼š 1.find. åˆ—å‡ºå½“å‰ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶åŠå…¶å­æ–‡ä»¶ 123456789 find . ç»“æœï¼š../333.txt./222.txt./test2./test2/123.txt./123.txt./empty.txt 2.find /usr/test -name â€œ*.txtâ€ï¼šæŸ¥æ‰¾testç›®å½•ä¸‹åç¼€åä¸ºtxtçš„æ–‡ä»¶ 1234567find /usr/test -name \"*.txt\"ç»“æœï¼š/usr/test/333.txt/usr/test/222.txt/usr/test/test2/123.txt/usr/test/123.txt/usr/test/empty.txt 3.find /usr/test ! -name â€œ*.txtâ€ï¼šæŸ¥æ‰¾testç›®å½•ä¸‹åç¼€åä¸æ˜¯txtçš„æ–‡ä»¶ 4.æ ¹æ®æ–‡ä»¶ç±»å‹æŸ¥æ‰¾ -type: 1find . -type å‚æ•° ç±»å‹å‚æ•°ï¼š f ï¼šæ™®é€šæ–‡ä»¶ l ï¼šç¬¦å·è¿æ¥ d ï¼šç›®å½• c ï¼šå­—ç¬¦è®¾å¤‡ b ï¼šå—è®¾å¤‡ s ï¼šå¥—æ¥å­— p ï¼šFifo 5.æŸ¥æ‰¾å°äº3kçš„æ–‡ä»¶ 1find . -size -3k ç»“æœï¼š ./333.txt ./222.txt ./test2/123.txt ./123.txt ./empty.txt 6.æŸ¥æ‰¾å¤§å°ä¸º0çš„æ–‡ä»¶ 12[root@ test] find -empty./empty.txt 7.æŸ¥æ‰¾æŒ‡å®šæƒé™çš„æ–‡ä»¶ é¦–å…ˆç»™123.txtèµ‹äºˆ77æƒé™ï¼š 1chmod 777 123.txt æŸ¥çœ‹ä¸‹ç»“æœï¼š 12345-rwxrwxrwx 1 777 root 21 Oct 28 23:08 123.txt-rw-r--r-- 1 root root 15 Oct 28 22:57 222.txt-rw-r--r-- 1 root root 23 Oct 27 22:46 333.txt-rw-r--r-- 1 root root 0 Oct 29 15:20 empty.txtdrwxr-xr-x 2 root root 4096 Oct 27 19:52 test2 åªæœ‰123.txtçš„æƒé™ä¸º777, æ‰§è¡ŒæŸ¥æ‰¾ï¼š 1find -perm 777 ç»“æœï¼š 1./123.txt â€‹ æŒç»­æ›´æ–°â€¦â€¦â€¦","link":"/posts/20200106-linux_file_1.html"},{"title":"ï¼ˆå¤ä¹ ï¼‰äºŒå‰æ ‘çš„ä¸‰ç§éå†æ–¹å¼ã€æŸ¥æ‰¾å’Œåˆ é™¤----------Javaå®ç°","text":"ä¸€ã€æ¦‚å¿µï¼šäºŒå‰æ ‘äºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåªèƒ½ç”±ä¸¤ä¸ªå­èŠ‚ç‚¹ æ€§è´¨ï¼š äºŒå‰æ ‘çš„ç¬¬ i å±‚æœ€å¤šæœ‰ 2 ^ (i-1) ä¸ªèŠ‚ç‚¹ æ·±åº¦ä¸º k ï¼ˆ kâ‰¥0 ï¼‰çš„äºŒå‰æ ‘æœ€å°‘æœ‰ k ä¸ªèŠ‚ç‚¹(ä¸€å±‚ä¸€ä¸ª)ï¼Œæœ€å¤šæœ‰ ï¼ˆ2^k ï¼‰-1 ä¸ªèŠ‚ç‚¹ ï¼ˆç©ºæ ‘k=0ï¼Œåªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹k=1ï¼‰ å¯¹äºä»»æ„ä¸€ä¸ªéç©ºäºŒå‰æ ‘ï¼Œè‹¥å…¶ å¶å­èŠ‚ç‚¹æ•°ä¸º nï¼Œåº¦ä¸º2çš„éå¶å­èŠ‚ç‚¹æ•°ä¸º mï¼Œåˆ™ ==n=m+1==ï¼Œï¼ˆåº¦ å³èŠ‚ç‚¹æ‰€æ‹¥æœ‰çš„å­æ ‘çš„ä¸ªæ•°ï¼‰ å¦‚æœèŠ‚ç‚¹æ€»æ•°ä¸º 2^n-1 ä¸”æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨æœ€åä¸€å±‚ï¼Œåˆ™è¯¥æ ‘ä¸º==æ»¡äºŒå‰æ ‘== å¦‚æœè¯¥äºŒå‰æ ‘çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨æœ€åä¸€å±‚æˆ–è€…å€’æ•°ç¬¬äºŒå±‚ï¼Œè€Œä¸”æœ€åä¸€å±‚çš„å¶å­èŠ‚ç‚¹åœ¨å·¦è¾¹è¿ç»­ï¼Œå€’æ•°ç¬¬äºŒå±‚çš„å¶å­èŠ‚ç‚¹åœ¨å³è¾¹è¿ç»­ï¼Œåˆ™ç§°ä¸º==å®Œå…¨äºŒå‰æ ‘==ã€‚å¦‚ä¸‹ï¼š äºŒã€ä¸‰ç§éå†æ–¹å¼2.1å‰åºéå†æ ¹èŠ‚ç‚¹ â€”&gt; å·¦å­©å­ â€”&gt; å³å­©å­ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå‰åºéå†ç»“æœä¸ºï¼š11ï¼Œ21,14,81,91,15,31ï¼Œ61,71 2.2 ä¸­åºéå†å·¦å­©å­ â€“&gt; æ ¹èŠ‚ç‚¹ â€”&gt; å³å­©å­ ä¸Šå›¾ä¸ºä¾‹ï¼Œç»“æœä¸ºï¼š81,14,91,21,15,11,61,31,71 2.3 ååºéå†å·¦å­©å­ â€“&gt; å³å­©å­ â€”&gt; æ ¹èŠ‚ç‚¹ ä¸Šå›¾ä¸ºä¾‹ï¼Œç»“æœä¸ºï¼š81,91,14,15,21,61,71,31,11 ä¸‰ã€ä»£ç å®ç°éå†3.1é¦–å…ˆåˆ›å»ºTreeNodeç±»ä½œä¸ºæ•°èŠ‚ç‚¹è¿™é‡Œæ–¹ä¾¿ä½¿ç”¨ç›´æ¥éƒ½è®¾ä¸ºäº†public 12345678910111213141516171819class TreeNode { public int no;//èŠ‚ç‚¹ç¼–å· public TreeNode lchild;//å·¦å­©å­ public TreeNode rchild;//å³å­©å­ public TreeNode() { } public TreeNode(int no) { this.no = no; } @Override public String toString() { return \"TreeNode{\" + \"no=\" + no + '}'; }} 3.2 åˆ›å»ºäºŒå‰æ ‘ç±»12345678//å®šä¹‰äºŒå‰æ ‘class BinaryTree { private TreeNode root; public void setRoot(TreeNode root) { this.root = root; }} 3.3 å‰åºéå†æ–¹æ³•ï¼š 1.é¦–å…ˆè¾“å‡ºæ ¹èŠ‚ç‚¹ 2.å·¦å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å·¦å­©å­ 3.å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å³å­©å­ 1234567891011121314/** * å‰åºéå†ï¼š æ ¹èŠ‚ç‚¹-&gt;å·¦èŠ‚ç‚¹-&gt;å³èŠ‚ç‚¹ */ public void preOrder() { System.out.println(this);//å…ˆè¾“å‡ºçˆ¶èŠ‚ç‚¹ //å‘å·¦é€’å½’ if (this.lchild != null) { this.lchild.preOrder(); } //å‘å³é€’å½’ if (this.rchild != null) { this.rchild.preOrder(); } } 3.4 ä¸­åºéå†æ–¹æ³•ï¼š 1.å·¦å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å·¦å­©å­ 2.é¦–å…ˆè¾“å‡ºæ ¹èŠ‚ç‚¹ 3.å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å³å­©å­ 123456789101112131415/** * ä¸­åºéå†ï¼š å·¦èŠ‚ç‚¹-&gt;æ ¹èŠ‚ç‚¹-&gt;å³èŠ‚ç‚¹ */ public void midOrder() { //å‘å·¦é€’å½’ if (this.lchild != null) { this.lchild.midOrder(); } System.out.println(this);//è¾“å‡ºæ ¹èŠ‚ç‚¹ //å‘å³é€’å½’ if (this.rchild != null) { this.rchild.midOrder(); } } 3.5 ååºéå†æ–¹æ³•ï¼š 1.å·¦å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å·¦å­©å­ 2.å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå†å³å­©å­ 3.é¦–å…ˆè¾“å‡ºæ ¹èŠ‚ç‚¹ 12345678910111213141516/** * ååºéå†ï¼š å·¦èŠ‚ç‚¹-&gt;å³èŠ‚ç‚¹-&gt;æ ¹èŠ‚ç‚¹ */ public void postOrder() { //å‘å·¦é€’å½’ if (this.lchild != null) { this.lchild.postOrder(); } //å‘å³é€’å½’ if (this.rchild != null) { this.rchild.postOrder(); } System.out.println(this);//è¾“å‡ºæ ¹èŠ‚ç‚¹ } å…¶å®å°±æ˜¯æŠŠè¾“å‡ºæ ¹èŠ‚ç‚¹çš„ä½ç½®æŒ‰å…ˆä¸­åçš„é¡ºåºæ¢æ¥æ¢å» 3.6 åœ¨äºŒå‰æ ‘ä¸­è°ƒç”¨ä¸€ä¸‹æ–¹æ³•åº”å…ˆåˆ¤æ–­æ ¹èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºæ—¶æ‰éå† 123456789101112131415161718192021222324//å‰åºéå† public void preOrder(){ if (this.root!=null){ this.root.preOrder(); }else { System.out.println(\"äºŒå‰æ ‘ä¸ºç©º\"); } } //ä¸­åºéå† public void midOrder(){ if (this.root!=null){ this.root.midOrder(); }else { System.out.println(\"äºŒå‰æ ‘ä¸ºç©º\"); } } //åç»­éå† public void postOrder(){ if (this.root!=null){ this.root.postOrder(); }else { System.out.println(\"äºŒå‰æ ‘ä¸ºç©º\"); } } æµ‹è¯•æŒ‰ç…§ä¸€å¼€å§‹çš„é‚£ä¸ªå›¾åˆ›å»ºäºŒå‰æ ‘ï¼š 12345678910111213141516171819202122232425262728293031BinaryTree binaryTree=new BinaryTree(); //åˆ›å»ºæ ¹èŠ‚ç‚¹ TreeNode root = new TreeNode(11); TreeNode treeNode2 = new TreeNode(21); TreeNode treeNode3 = new TreeNode(31); TreeNode treeNode4 = new TreeNode(14); TreeNode treeNode5 = new TreeNode(15); TreeNode treeNode6 = new TreeNode(61); TreeNode treeNode7 = new TreeNode(71); TreeNode treeNode8 = new TreeNode(81); TreeNode treeNode9 = new TreeNode(91); root.lchild =treeNode2; root.rchild =treeNode3; treeNode3.rchild =treeNode7; treeNode3.lchild =treeNode6; treeNode2.lchild =treeNode4; treeNode2.rchild =treeNode5; treeNode4.lchild =treeNode8; treeNode4.rchild =treeNode9; binaryTree.setRoot(root); System.out.println(\"ä¸­åº-------\"); binaryTree.midOrder(); System.out.println(\"å‰åº--------\"); binaryTree.preOrder(); System.out.println(\"åç»­--------\"); binaryTree.postOrder(); ç»“æœï¼š 123456789101112131415161718192021222324252627282930ä¸­åº-------TreeNode{no=81}TreeNode{no=14}TreeNode{no=91}TreeNode{no=21}TreeNode{no=15}TreeNode{no=11}TreeNode{no=61}TreeNode{no=31}TreeNode{no=71}å‰åº--------TreeNode{no=11}TreeNode{no=21}TreeNode{no=14}TreeNode{no=81}TreeNode{no=91}TreeNode{no=15}TreeNode{no=31}TreeNode{no=61}TreeNode{no=71}åç»­--------TreeNode{no=81}TreeNode{no=91}TreeNode{no=14}TreeNode{no=15}TreeNode{no=21}TreeNode{no=61}TreeNode{no=71}TreeNode{no=31}TreeNode{no=11} å››ã€ä¸‰ç§éå†æŸ¥è¯¢æŸä¸ªèŠ‚ç‚¹è¿”å›èŠ‚ç‚¹ç¼–å·4.1 å‰åºéå†æ–¹æ³•ï¼š1.åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ï¼Œæ»¡è¶³çš„è¯è¿”å›è¯¥èŠ‚ç‚¹ï¼Œä¸æ»¡è¶³è¿›è¡Œ 22.åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºçš„è¯é€’å½’å‰åºéå†å·¦å­©å­3.åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºçš„è¯é€’å½’å‰åºéå†å³å­©å­å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132/** * å‰åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode preOrderFind(int no){ if (this.no==no){ return this; } TreeNode treeNode=null; /** * åˆ¤æ–­å½“å‰å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º -&gt; é€’å½’å‰åºéå†æŸ¥æ‰¾ï¼Œ * è‹¥æ‰¾åˆ°ï¼Œå°±è¿”å› */ if (this.lchild !=null){ treeNode=this.lchild.preOrderFind(no); } if (treeNode!=null){ return treeNode; } /** * åˆ¤æ–­å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º-&gt;é€’å½’å‰åºéå†ï¼Œæ— è®ºæ‰¾æ²¡æ‰¾åˆ°éƒ½è¿”å›treeNode */ if (this.rchild !=null){ treeNode=this.rchild.preOrderFind(no); } return treeNode; } 4.2 ä¸­åºéå†æ–¹æ³•ï¼šå°†å½“å‰èŠ‚ç‚¹æ”¾åœ¨å·¦å­©å­å’Œå³å­©å­ä¸­é—´å°±å¥½äº†ï¼Œå…¶ä»–åŒä¸Šå®ç°ï¼š 1234567891011121314151617181920212223242526272829303132/** * ä¸­åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode midOrderFind(int no){ TreeNode treeNode=null; /** * åˆ¤æ–­å½“å‰å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º -&gt; é€’å½’å‰åºéå†æŸ¥æ‰¾ï¼Œ * è‹¥æ‰¾åˆ°ï¼Œå°±è¿”å› */ if (this.lchild !=null){ treeNode=this.lchild.midOrderFind(no); } if (treeNode!=null){ return treeNode; } if (this.no==no){ return this; } /** * åˆ¤æ–­å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º-&gt;é€’å½’å‰åºéå†ï¼Œæ— è®ºæ‰¾æ²¡æ‰¾åˆ°éƒ½è¿”å›treeNode */ if (this.rchild !=null){ treeNode=this.rchild.midOrderFind(no); } return treeNode; } 4.3 ååºéå†æ–¹æ³•ï¼šå°†å½“å‰èŠ‚ç‚¹çš„æ¯”è¾ƒæ”¾åœ¨æœ€åå°±å¥½äº†ï¼Œå…¶ä»–åŒä¸Šå®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738/** * ååºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode postOrderFind(int no){ TreeNode treeNode=null; /** * åˆ¤æ–­å½“å‰å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º -&gt; é€’å½’å‰åºéå†æŸ¥æ‰¾ï¼Œ * è‹¥æ‰¾åˆ°ï¼Œå°±è¿”å› */ if (this.lchild !=null){ treeNode=this.lchild.postOrderFind(no); } if (treeNode!=null){ return treeNode; } /** * åˆ¤æ–­å³å­©å­æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©º-&gt;é€’å½’å‰åºéå†ï¼Œæ— è®ºæ‰¾æ²¡æ‰¾åˆ°éƒ½è¿”å›treeNode */ if (this.rchild !=null){ treeNode=this.rchild.postOrderFind(no); } if (treeNode!=null){ return treeNode; } //å·¦å³å­©å­éƒ½æ²¡æ‰¾åˆ°ï¼Œæ‰¾æ ¹èŠ‚ç‚¹ if (this.no==no){ return this; } return treeNode; } 4.4 äºŒå‰æ ‘è°ƒç”¨æŸ¥æ‰¾æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637/** * å‰åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode preOrderFind(int no){ if (root!=null){ return root.preOrderFind(no); }else { return null; } } /** * ä¸­åºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode midOrderFind(int no){ if (root!=null){ return root.midOrderFind(no); }else { return null; } } /** * ååºéå†æŸ¥æ‰¾ * @param no * @return */ public TreeNode postOrderFind(int no){ if (root!=null){ return root.postOrderFind(no); }else { return null; } } æµ‹è¯•ï¼šæŸ¥æ‰¾6112345678910111213141516171819202122232425//å‰åºéå†æŸ¥æ‰¾ System.out.println(\"å‰åºéå†æŸ¥æ‰¾==============\"); TreeNode treeNode = binaryTree.preOrderFind(61); if (treeNode!=null){ System.out.println(\"æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º\"+treeNode.no); }else { System.out.println(\"æ²¡æ‰¾åˆ°\"); } //ä¸­åºéå†æŸ¥æ‰¾ System.out.println(\"ä¸­åºéå†æŸ¥æ‰¾====================\") TreeNode midOrderFind = binaryTree.midOrderFind(61); if (midOrderFind!=null){ System.out.println(\"æ‰¾åˆ°äº†ï¼šç¼–å·ä¸ºï¼š\"+midOrderFind.no); }else { System.out.println(\"æ²¡æ‰¾åˆ°\"); } //ååºéå†æŸ¥æ‰¾ System.out.println(\"ååºéå†æŸ¥æ‰¾=============\"); TreeNode postOrderFind = binaryTree.postOrderFind(61); if (postOrderFind!=null){ System.out.println(\"æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º\"+postOrderFind.no); }else { System.out.println(\"æ²¡æ‰¾åˆ°\"); } ç»“æœï¼š 123456å‰åºéå†æŸ¥æ‰¾==============æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º61ä¸­åºéå†æŸ¥æ‰¾====================æ‰¾åˆ°äº†ï¼šç¼–å·ä¸ºï¼š61ååºéå†æŸ¥æ‰¾=============æ‰¾åˆ°äº†ï¼šç¼–å·ä¸º61 äº”ã€åˆ é™¤èŠ‚ç‚¹å½“èŠ‚ç‚¹ä¸ºå¶å­èŠ‚ç‚¹æ—¶ç›´æ¥åˆ é™¤å½“èŠ‚ç‚¹ä¸ºéå¶å­èŠ‚ç‚¹æ—¶è¿åŒå…¶å­æ ‘ä¸€èµ·åˆ é™¤ï¼›(ä¸åˆ é™¤å­æ ‘çš„æ–¹æ³•åç»­è¡¥å……)æ–¹æ³•ï¼šæ¯æ¬¡çš„æ¯”è¾ƒå¯¹è±¡ä¸ºå½“å‰èŠ‚ç‚¹çš„å·¦å³å­©å­ï¼Œå½“å·¦å­©å­éç©ºä¸”ç¼–å·ä¸ç›®æ ‡èŠ‚ç‚¹ç›¸åŒï¼Œè®©å·¦å­©å­ä¸ºnullå½“å³å­©å­éç©ºä¸”ç¼–å·ä¸ç›®æ ‡èŠ‚ç‚¹ç›¸åŒï¼Œè®©å³å­©å­ä¸ºnullå½“å·¦å³å­©å­éç©ºæ—¶ï¼Œé€’å½’éå† 12345678910111213141516171819/** * é€’å½’åˆ é™¤ */ public void deleteNode(int no){ if (this.lchild !=null &amp;&amp; this.lchild.no==no){ this.lchild =null; return; } if (this.rchild !=null &amp;&amp;this.rchild.no==no){ this.rchild =null; return; } if (this.lchild !=null){ this.lchild.deleteNode(no); } if (this.rchild !=null){ this.rchild.deleteNode(no); } }","link":"/posts/20200107-binarytree.html"},{"title":"æ¨¡æ‹Ÿå…ˆæ¥å…ˆæœåŠ¡ã€çŸ­ä½œä¸šä¼˜å…ˆã€æ—¶é—´ç‰‡è½®è½¬ä»¥åŠæœ€é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•çš„JAVAå®ç°","text":"è¿™é‡Œè®°å½•ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„å®éªŒï¼Œå‡ ä¸ªè°ƒåº¦ç®—æ³•çš„åŸç†å¾ˆå¥½ç†è§£ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šè§£é‡Šï¼Œè¿™é‡Œä¸å†è§£é‡Šï¼Œç›´æ¥ä¸Šä»£ç ã€‚ ä¸€ã€JCBç±»1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class JCB { public int id; /** * å‰©ä½™æœåŠ¡æ—¶é—´ */ public int leftTime; /** * è¦æ±‚æœåŠ¡æ—¶é—´ */ public int serviceTime; /** * åˆ°è¾¾æ—¶é—´ */ public int arriveTime; /** * å¼€å§‹æ—¶é—´ */ public int beginTime; /** * ç»“æŸæ—¶é—´ */ public int finishTime; /** * ä¼˜å…ˆæƒ */ public float priority; public JCB(int id, int serviceTime, int arriveTime,float priority) { this.id = id; this.leftTime = serviceTime; this.serviceTime = serviceTime; this.arriveTime = arriveTime; beginTime =0; this.priority=priority; finishTime=0; } @Override public String toString() { return \"JCB{\" + \"id=\" + id + \", serviceTime=\" + serviceTime + \", arriveTime=\" + arriveTime + \", priority=\" + priority + '}'; }} äºŒã€å®šä¹‰æ‰€éœ€æ•°æ®ç»“æ„1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/** * æ—¶é—´ç‰‡è½®è½¬ç®—æ³• * * @author MaoLin Wang * @date 2019/11/3020:03 */public class SchedulingAlgorithm { /** * å°±ç»ªé˜Ÿåˆ— */ LinkedList&lt;JCB&gt; readyQueue = null; /** * ç»“æŸè°ƒåº¦é˜Ÿåˆ— */ LinkedList&lt;JCB&gt; finishQueue = null; /** * æ—¶é—´æ®µ */ private int cpuTime; /** * æ—¶é—´ç‰‡å¤§å° */ private int timeSize; /** * ä½œä¸šæ•° */ private int jobNum; private String dispatchName;//è°ƒåº¦ç®—æ³•å /** * ä½œä¸šå‘¨è½¬æ—¶é—´ */ private int[] turnoverTime; /** * ä½œä¸šå¸¦æƒå‘¨è½¬æ—¶é—´Â· */ private float[] turnoverTimeWithWeight; /** * å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ */ private float ave;} ä¸‰ã€åˆå§‹åŒ–è¿™é‡Œå°†æœ€é«˜å“åº”æ¯”çš„åˆå§‹åŒ–æ‹‰äº†å‡ºæ¥ï¼Œå› ä¸ºè¦è®¾ç½®å“åº”æ¯” 12345678910111213141516171819202122232425262728293031323334353637383940414243444546/** * åˆå§‹åŒ– */ public void init(int jobNum, int timeSize, String dispatchName) { System.out.println(\"å¼€å§‹\" + dispatchName + \"è°ƒåº¦\"); readyQueue = new LinkedList&lt;&gt;(); finishQueue = new LinkedList&lt;&gt;(); this.turnoverTime = new int[jobNum]; this.turnoverTimeWithWeight = new float[jobNum]; this.cpuTime = 0; JCB jcb; for (int i = 1; i &lt;= jobNum; i++) { jcb = new JCB(i, (int) (Math.random() * 10 + 1), i - 1, 0); readyQueue.offer(jcb); } this.timeSize = timeSize; this.jobNum = jobNum; this.dispatchName = dispatchName; printInitQueue(); } /** * åˆå§‹åŒ–é«˜å“åº”æ¯”ä¼˜å…ˆé˜Ÿåˆ— * * @param jobNum * @param timeSize * @param dispatchName */ public void HRNInit(int jobNum, int timeSize, String dispatchName) { System.out.println(\"å¼€å§‹\" + dispatchName + \"è°ƒåº¦\"); readyQueue = new LinkedList&lt;&gt;(); finishQueue = new LinkedList&lt;&gt;(); this.turnoverTime = new int[jobNum]; this.turnoverTimeWithWeight = new float[jobNum]; this.cpuTime = 0; JCB jcb; for (int i = 1; i &lt;= jobNum; i++) { float v = (float) (Math.random() * 5 + 1); jcb = new JCB(i, (int) (Math.random() * 10 + 1), i - 1, (float) (Math.random() * 5 + 1)); readyQueue.offer(jcb); } this.timeSize = timeSize; this.jobNum = jobNum; this.dispatchName = dispatchName; printInitQueue(); } ä½œä¸šidé»˜è®¤ä¸ºåºå·iï¼Œæ‰€éœ€æœåŠ¡æ—¶é—´éšæœºç”Ÿæˆï¼Œåˆ°è¾¾æ—¶é—´é»˜è®¤ä»0å¼€å§‹ï¼Œå“åº”æ¯”å…¶ä»–è°ƒåº¦ç®—æ³•ä¸º0ï¼Œé«˜å“åº”æ¯”ç®—æ³•ä¸ºéšæœºç”Ÿæˆã€‚ å››ã€é«˜å“åº”æ¯”ä¼˜å…ˆç®—æ³•å®ç°é€»è¾‘å¾ˆç®€å•ï¼Œä½¿ç”¨é€’å½’å®ç°ï¼Œå‚æ•°åˆå§‹ä¸º0ï¼Œæ¯æ¬¡å–å‡ºå¯¹å¤´ä½œä¸šï¼Œå› ä¸ºè¿™é‡Œæ‰€æœ‰çš„ä½œä¸šåœ¨åˆå§‹åŒ–æ—¶æ•°æ®éƒ½åˆå§‹åŒ–å¥½äº†ï¼Œæ‰€ä»¥éœ€åˆ¤æ–­ä½œä¸šåˆ°è¾¾æ—¶é—´æ˜¯å¦å°äºcpuæ—¶é—´ç‰‡ï¼Œå› ä¸ºåªæœ‰å°äºæ—¶é—´ç‰‡ï¼Œè¯´æ˜å…¶å®é™…æ˜¯åˆ°è¾¾çš„ã€‚ å¦‚æœå°äºï¼Œåˆ™è®¾ç½®å…¶å¼€å§‹æ—¶é—´ä¸ºcpuå½“å‰æ—¶é—´ï¼Œç»“æŸæ—¶é—´ä¸ºå¼€å§‹æ—¶é—´+æœåŠ¡æ—¶é—´ï¼Œå‰©ä½™æ—¶é—´è®¾ä¸º0ï¼ŒåŒæ—¶å¢åŠ cpuæ—¶é—´ï¼Œå°†è¯¥ä½œä¸šåŠ å…¥å·²å®Œæˆé˜Ÿåˆ—ä¸­ï¼Œå¦åˆ™ï¼Œé€’å½’è°ƒç”¨è¯¥ç®—æ³•ï¼Œå‚æ•°ä¸ºindex+1ï¼Œä¸€è½®ç»“æŸåï¼Œå¯¹ä½œä¸šæŒ‰å“åº”æ¯”æ’åºï¼Œç»§ç»­é€’å½’ï¼ŒçŸ¥é“å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºã€‚ 12345678910111213141516171819202122232425262728293031323334 /** * æœ€é«˜å“åº”æ¯”ä¼˜å…ˆç®—æ³• */public void HRNAlgorithm(int index) { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•!\"); return; } JCB head = readyQueue.get(index); if (head.arriveTime &lt;= cpuTime) { readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; head.finishTime = head.beginTime + head.serviceTime; head.leftTime = 0; cpuTime += head.serviceTime; finishQueue.offer(head); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); } else { HRNAlgorithm(index++); } sortByPriority(); HRNAlgorithm(0);}/** * æ ¹æ®å“åº”æ¯”æ’åº */private void sortByPriority() { readyQueue.sort((o1, o2) -&gt; o1.priority &gt; o2.priority ? -1 : 1);} äº”ã€çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³•åŒé«˜å“åº”æ¯”ä¼˜å…ˆç±»ä¼¼ï¼Œåªæ˜¯æŒ‰ç…§è¦æ±‚æœåŠ¡æ—¶é—´æ’åºã€‚ 123456789101112131415161718192021222324252627282930313233343536/** * çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³• */ public void SJFAlgorithm(int index) { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼\"); return; } JCB head = readyQueue.get(index); if (head.arriveTime &lt;= cpuTime) { readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; head.finishTime = head.beginTime + head.serviceTime; head.leftTime = 0; cpuTime += head.serviceTime; finishQueue.offer(head); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); } else { sortByServiceTime(); SJFAlgorithm(index++); } sortByServiceTime(); SJFAlgorithm(0); } /** * æ ¹æ®è¦æ±‚æœåŠ¡æ—¶é—´ä»å°åˆ°å¤§æ’åº */ private void sortByServiceTime() { readyQueue.sort((o1, o2) -&gt; o1.serviceTime &lt; o2.serviceTime ? -1 : 1); } å…­ã€å…ˆæ¥å…ˆæœåŠ¡ æœ€ç®€å•çš„ä¸€ä¸ªç®—æ³•ï¼Œç›´æ¥æŒ‰é¡ºåºå–å‡ºé˜Ÿå¤´ä½œä¸šæ‰§è¡Œã€‚ 12345678910111213141516171819202122/** * å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç®—æ³• */ public void FCFSAlgorithm() { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼\"); return; } JCB head = readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; head.leftTime = 0; head.finishTime = head.beginTime + head.serviceTime; cpuTime += head.serviceTime; finishQueue.offer(head); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); FCFSAlgorithm(); } ä¸ƒã€æ—¶é—´ç‰‡è½®è½¬ç®—æ³• è¿™é‡Œéœ€è¦æ ¹æ®ä½œä¸šå‰©ä½™éœ€è¦æœåŠ¡çš„æ—¶é—´è·Ÿæ—¶é—´ç‰‡å¤§å°åšå¯¹æ¯”ï¼Œä»£ç å¾ˆå¥½ç†è§£ã€‚ 123456789101112131415161718192021222324252627282930313233343536/** * æ—¶é—´ç‰‡è½®è½¬ç®—æ³• */ public void RRAlgorithm() { if (readyQueue.size() == 0) { System.out.println(\"å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼\"); return; } JCB head = readyQueue.poll(); System.out.println(\"-----------------------------------------------------\"); System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"å¼€å§‹è°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); head.beginTime = cpuTime; if (head.leftTime &gt; timeSize) { //æœåŠ¡æ—¶é—´å¤§äºæ—¶é—´ç‰‡å¤§å° head.leftTime -= timeSize; //é‡æ–°åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—å°¾éƒ¨ readyQueue.offer(head); cpuTime += timeSize; } else if (head.leftTime == timeSize) { //æœåŠ¡æ—¶é—´ç­‰äºæ—¶é—´ç‰‡å¤§å° cpuTime += timeSize; head.finishTime = cpuTime; head.leftTime = 0; //åŠ å…¥ç»“æŸé˜Ÿåˆ— finishQueue.offer(head); } else { //æœåŠ¡æ—¶é—´å°äºæ—¶é—´ç‰‡å¤§å° head.finishTime = cpuTime + head.leftTime; head.leftTime = 0; cpuTime += head.leftTime; finishQueue.offer(head); } System.out.println(\"æ—¶é—´ç‰‡: \" + cpuTime + \"ç»“æŸè°ƒåº¦ä½œä¸š:\" + head.id + \", å‰©ä½™æœåŠ¡æ—¶é—´: \" + head.leftTime); RRAlgorithm(); } å…«ã€è®¡ç®—å‘¨è½¬æ—¶é—´å’Œå¸¦æƒå‘¨è½¬æ—¶é—´12345678910111213141516171819/** * è®¡ç®—å‘¨è½¬æ—¶é—´å’Œå¸¦æƒå‘¨è½¬æ—¶é—´ * @param finishQueue */ public void R_Dis(Queue&lt;JCB&gt; finishQueue) { Queue&lt;JCB&gt;temp=finishQueue; JCB tempJcb; float sum = 0; for (int i = 0; i &lt; jobNum; i++) { tempJcb=temp.poll(); turnoverTime[i] = tempJcb.finishTime - tempJcb.arriveTime; turnoverTimeWithWeight[i] =(float) turnoverTime[i] / tempJcb.serviceTime; sum += turnoverTimeWithWeight[i]; temp.offer(tempJcb); } float ave = sum / jobNum; this.ave = ave; } ä¹ã€æ‰“å°ç»“æœ123456789101112131415161718192021222324252627282930313233343536public void printResult(boolean isHRN) { R_Dis(this.finishQueue); System.out.println(\"=====================\" + this.dispatchName + \"è°ƒåº¦ç»“æœä¸º=========================\"); if (isHRN) { System.out.println(\"è¿›ç¨‹å\\t\" + \"åˆ°è¾¾æ—¶é—´\\t\" + \"è¦æ±‚æœåŠ¡æ—¶é—´\\t\" + \"å“åº”æ¯”\\t\" + \"å¼€å§‹æ—¶é—´\\t\" + \"å®Œæˆæ—¶é—´\\t\" + \"å‘¨è½¬æ—¶é—´\\t\" + \"å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"+\"å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"); } else { System.out.println(\"è¿›ç¨‹å\\t\" + \"åˆ°è¾¾æ—¶é—´\\t\" + \"è¦æ±‚æœåŠ¡æ—¶é—´\\t\" + \"å¼€å§‹æ—¶é—´\\t\" + \"å®Œæˆæ—¶é—´\\t\" + \"å‘¨è½¬æ—¶é—´\\t\" + \"å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"+\"å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´\\t\"); } int count = 0; for (JCB jcb : this.finishQueue) { if (isHRN) { System.out.println(\" \" + jcb.id + \"\\t\\t\\t\" + jcb.arriveTime + \"\\t\\t\" + jcb.serviceTime + \"\\t\\t\" + jcb.priority + \"\\t\\t\" + jcb.beginTime + \"\\t\\t\" + jcb.finishTime + \"\\t\\t\" + turnoverTime[count] + \"\\t\\t\" + turnoverTimeWithWeight[count]+\"\\t\\t\"+this.ave); count = count + 1; } else { System.out.println(\" \" + jcb.id + \"\\t\\t\\t\" + jcb.arriveTime + \"\\t\\t\" + jcb.serviceTime + \"\\t\\t\" + jcb.beginTime + \"\\t\\t\" + jcb.finishTime + \"\\t\\t\" + turnoverTime[count] + \"\\t\\t\" + turnoverTimeWithWeight[count]+\"\\t\\t\"+this.ave); count = count + 1; } } } /** * æ‰“å°åˆå§‹åŒ–é˜Ÿåˆ— */ private void printInitQueue() { System.out.println(\"å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:\"); for (JCB jcb2 : readyQueue) { System.out.println(jcb2); } } æµ‹è¯•1234567891011121314151617181920212223public class Test { public static void main(String[] args) { SchedulingAlgorithm schedulingAlgorithm = new SchedulingAlgorithm(); schedulingAlgorithm.init(5, 2,\"è½®è½¬\"); schedulingAlgorithm.RRAlgorithm(); schedulingAlgorithm.printResult(false); schedulingAlgorithm.init(5,3,\"å…ˆæ¥å…ˆæœåŠ¡\"); schedulingAlgorithm.FCFSAlgorithm(); schedulingAlgorithm.printResult(false); schedulingAlgorithm.init(5,3,\"çŸ­ä½œä¸šä¼˜å…ˆæœåŠ¡\"); schedulingAlgorithm.SJFAlgorithm(0); schedulingAlgorithm.printResult(false); schedulingAlgorithm.HRNInit(5,3,\"é«˜å“åº”æ¯”ä¼˜å…ˆ\"); schedulingAlgorithm.HRNAlgorithm(0); schedulingAlgorithm.printResult(true); }} ç»“æœï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141å¼€å§‹è½®è½¬è°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=1, arriveTime=0, priority=0.0}JCB{id=2, serviceTime=5, arriveTime=1, priority=0.0}JCB{id=3, serviceTime=4, arriveTime=2, priority=0.0}JCB{id=4, serviceTime=6, arriveTime=3, priority=0.0}JCB{id=5, serviceTime=6, arriveTime=4, priority=0.0}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 0ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 5æ—¶é—´ç‰‡: 2ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 3-----------------------------------------------------æ—¶é—´ç‰‡: 2å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 4æ—¶é—´ç‰‡: 4ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 2-----------------------------------------------------æ—¶é—´ç‰‡: 4å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 6ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 4-----------------------------------------------------æ—¶é—´ç‰‡: 6å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 8ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 4-----------------------------------------------------æ—¶é—´ç‰‡: 8å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 3æ—¶é—´ç‰‡: 10ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 1-----------------------------------------------------æ—¶é—´ç‰‡: 10å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 2æ—¶é—´ç‰‡: 12ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 12å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 4æ—¶é—´ç‰‡: 14ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 2-----------------------------------------------------æ—¶é—´ç‰‡: 14å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 4æ—¶é—´ç‰‡: 16ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 2-----------------------------------------------------æ—¶é—´ç‰‡: 16å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 16ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 16å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 2æ—¶é—´ç‰‡: 18ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 18å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 2æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼=====================è½®è½¬è°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 1 0 1 1 1.0 2.3733335 3 2 4 10 12 10 2.5 2.3733335 2 1 5 16 17 16 3.2 2.3733335 4 3 6 16 18 15 2.5 2.3733335 5 4 6 18 20 16 2.6666667 2.3733335å¼€å§‹å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=3, arriveTime=0, priority=0.0}JCB{id=2, serviceTime=10, arriveTime=1, priority=0.0}JCB{id=3, serviceTime=7, arriveTime=2, priority=0.0}JCB{id=4, serviceTime=1, arriveTime=3, priority=0.0}JCB{id=5, serviceTime=1, arriveTime=4, priority=0.0}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 3æ—¶é—´ç‰‡: 3ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 3å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 10æ—¶é—´ç‰‡: 13ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 13å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 7æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 20å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 21ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 21å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 22ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼=====================å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 3 0 3 3 1.0 8.154286 2 1 10 3 13 12 1.2 8.154286 3 2 7 13 20 18 2.5714285 8.154286 4 3 1 20 21 18 18.0 8.154286 5 4 1 21 22 18 18.0 8.154286å¼€å§‹çŸ­ä½œä¸šä¼˜å…ˆæœåŠ¡è°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=8, arriveTime=0, priority=0.0}JCB{id=2, serviceTime=10, arriveTime=1, priority=0.0}JCB{id=3, serviceTime=1, arriveTime=2, priority=0.0}JCB{id=4, serviceTime=10, arriveTime=3, priority=0.0}JCB{id=5, serviceTime=1, arriveTime=4, priority=0.0}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 8æ—¶é—´ç‰‡: 8ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 8å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 9ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 9å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 10ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 10å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 10æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 20å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 10æ—¶é—´ç‰‡: 30ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•ï¼=====================çŸ­ä½œä¸šä¼˜å…ˆæœåŠ¡è°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 8 0 8 8 1.0 3.72 3 2 1 8 9 7 7.0 3.72 5 4 1 9 10 6 6.0 3.72 2 1 10 10 20 19 1.9 3.72 4 3 10 20 30 27 2.7 3.72å¼€å§‹é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦å½“å‰å°±ç»ªé˜Ÿåˆ—ä¸º:JCB{id=1, serviceTime=1, arriveTime=0, priority=5.41018}JCB{id=2, serviceTime=6, arriveTime=1, priority=5.1338425}JCB{id=3, serviceTime=6, arriveTime=2, priority=3.1670618}JCB{id=4, serviceTime=6, arriveTime=3, priority=2.0463989}JCB{id=5, serviceTime=1, arriveTime=4, priority=4.711568}-----------------------------------------------------æ—¶é—´ç‰‡: 0å¼€å§‹è°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 1ç»“æŸè°ƒåº¦ä½œä¸š:1, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 1å¼€å§‹è°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 7ç»“æŸè°ƒåº¦ä½œä¸š:2, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 7å¼€å§‹è°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 1æ—¶é—´ç‰‡: 8ç»“æŸè°ƒåº¦ä½œä¸š:5, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 8å¼€å§‹è°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 14ç»“æŸè°ƒåº¦ä½œä¸š:3, å‰©ä½™æœåŠ¡æ—¶é—´: 0-----------------------------------------------------æ—¶é—´ç‰‡: 14å¼€å§‹è°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 6æ—¶é—´ç‰‡: 20ç»“æŸè°ƒåº¦ä½œä¸š:4, å‰©ä½™æœåŠ¡æ—¶é—´: 0å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒåº¦å®Œæ¯•!=====================é«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç»“æœä¸º=========================è¿›ç¨‹å åˆ°è¾¾æ—¶é—´ è¦æ±‚æœåŠ¡æ—¶é—´ å“åº”æ¯” å¼€å§‹æ—¶é—´ å®Œæˆæ—¶é—´ å‘¨è½¬æ—¶é—´ å¸¦æƒå‘¨è½¬æ—¶é—´ å¹³å‡å¸¦æƒå‘¨è½¬æ—¶é—´ 1 0 1 5.41018 0 1 1 1.0 2.1666665 2 1 6 5.1338425 1 7 6 1.0 2.1666665 5 4 1 4.711568 7 8 4 4.0 2.1666665 3 2 6 3.1670618 8 14 12 2.0 2.1666665 4 3 6 2.0463989 14 20 17 2.8333333 2.1666665","link":"/posts/20200107-OS_dispatch.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹Fork-Joinåˆ†æ²»ç¼–ç¨‹","text":"ä¸€ã€Fork-Joinæ¡†æ¶ forkjoinå³åˆ†è€Œæ²»ä¹‹ï¼Œåœ¨å‡ å¤§æ’åºç®—æ³•ä¸­ï¼Œå¿«é€Ÿæ’åºã€å½’å¹¶æ’åºã€äºŒåˆ†æŸ¥æ‰¾å‡ç”¨åˆ°äº†åˆ†æ²»çš„æ€æƒ³ï¼Œå³å°†ä¸€ä¸ªå¤§é—®é¢˜ï¼Œé€ä¸€åˆ†è§£ä¸ºä¸€ä¸ªä¸ªå°é—®é¢˜ï¼Œå°†å„ä¸ªå­é—®é¢˜çš„è§£æœ€ç»ˆåˆå¹¶ä¸ºæœ€ç»ˆè§£ã€‚è¿™é‡Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå°†ä¸€ä¸ªå¤§ä»»åŠ¡åˆ†è§£æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼ˆforkï¼‰ï¼Œå†å°†è¿™è‹¥å¹²çš„å°ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œåˆå¹¶ï¼ˆjoinï¼‰ã€‚ äºŒã€å·¥ä½œå¯†å–fork-joiné‡‡ç”¨å·¥ä½œå¯†å–çš„æ–¹å¼å®ç°çº¿ç¨‹çš„å·¥ä½œè´Ÿè½½ã€‚forkjoinPoolä¸­ç»´æŠ¤äº†å¤šä¸ªçº¿ç¨‹æ‰§è¡Œåˆ†ä¸‹çš„å°ä»»åŠ¡ï¼Œå½“å½“å‰çº¿ç¨‹çš„ä»»åŠ¡ç»“æŸåï¼Œä¼šè‡ªåŠ¨è·å–å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶ä¹Ÿä¼šæ ¹æ®å½“å‰å·¥ä½œçº¿ç¨‹çš„ç©ºé—²æƒ…å†µå»è·å–ä»»åŠ¡è¾ƒå¤šçš„çº¿ç¨‹çš„taskï¼Œä»¥è¾¾åˆ°çº¿ç¨‹é—´çš„å¹³è¡¡ï¼Œæä¾›CPUåˆ©ç”¨ç‡ã€‚ ä¸‰ã€fork-joinçš„å®ç°forkjoinæ¡†æ¶æä¾›äº†ä¸¤ä¸ªå­ç±»ä¾›æˆ‘ä»¬ç»§æ‰¿ä½¿ç”¨ã€‚åˆ†åˆ«æ˜¯ï¼š1.RecursiveActionæ­¤ç±»ä¸»è¦ç”¨äºæ²¡æœ‰è¿”å›å€¼çš„ä»»åŠ¡ã€‚2.RecursiveTaskæ­¤ç±»ä¸»è¦ç”¨äºæœ‰è¿”å›å€¼çš„ä»»åŠ¡ ä¸¤ä¸ªç±»éƒ½æä¾›äº†computeçš„æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆã€è°ƒç”¨å­ä»»åŠ¡ï¼Œå®Œæˆåˆ†æ²»è¿ç®—ã€‚åœ¨computeæ–¹æ³•ä¸­ï¼Œéœ€è¦åˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦è¾¾åˆ°è®¾ç½®çš„é˜ˆå€¼ï¼Œå¦‚æœå°äºè¯¥å€¼ï¼Œåˆ™ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™ï¼Œå°†è¯¥ä»»åŠ¡åˆ†å‰²æˆä¸¤ä¸ªå°ä»»åŠ¡ï¼Œå†è®©ä¸¤ä¸ªå°ä»»åŠ¡è°ƒç”¨invokeAllæ–¹æ³•ï¼Œä¼šå†æ¬¡è¿›å…¥computeæ–¹æ³•ï¼Œé‡å¤ä»¥ä¸Šå·¥ä½œã€‚æœ€åä½¿ç”¨joinæ–¹æ³•ç­‰åˆ°å­ä»»åŠ¡æ‰§è¡Œç»“æŸè·å–å…¶è¿è¡Œçš„ç»“æœï¼Œåˆå¹¶å³å¯ã€‚ è¿™é‡Œä½¿ç”¨invokeAllè€Œä¸æ˜¯ç”¨invokeä¸»è¦æ˜¯å› ä¸ºï¼Œå¦‚æœä½¿ç”¨invokeä¼šä½¿ä»»åŠ¡åˆ†ç¦»å¼€ï¼Œä¸¤ä¸ªä»»åŠ¡ä¸­åªå·¥ä½œä¸€ä¸ªä»»åŠ¡ï¼Œè€Œä½¿ç”¨invokeAllå¯ä»¥è®©ä¸¤ä¸ªä»»åŠ¡åŒæ—¶å·¥ä½œï¼Œæé«˜æ•ˆç‡ã€‚ fork-joinçš„ä»»åŠ¡æ˜¯é€šè¿‡ForkJoinPoolæ± æ¥æ‰§è¡Œï¼Œå…¶æä¾›äº†ä¸¤ç§æäº¤æ–¹å¼ï¼Œsubmitå’Œinvokeï¼Œå…¶ä¸­ï¼Œsubmitæ˜¯å¼‚æ­¥æäº¤ï¼Œä¸éœ€è¦ç­‰å¾…ä»»åŠ¡è¿è¡Œå®Œæ¯•å³å¯è¿è¡Œsumbitä¹‹åçš„ä»£ç ï¼›ç›¸åï¼Œinvokeæ˜¯åŒæ­¥æ‰§è¡Œï¼Œå¿…é¡»ç­‰å¾…ä»»åŠ¡å®Œæˆæ‰ä¼šæ‰§è¡Œinvokeä¹‹åçš„ä»£ç ã€‚ å››ã€ä½¿ç”¨Foke-Joinå®ç°æ•°ç»„æ±‚å’Œ 4.1åˆ›å»ºæ±‚å’Œä»»åŠ¡ç±»è‡ªå®šä¹‰é˜ˆå€¼ï¼Œå½“ä»»åŠ¡ä½äºè¯¥é˜ˆå€¼æ—¶ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™è¿›è¡Œåˆ†å‰²ï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•åè¿”å›å­ä»»åŠ¡åˆå¹¶çš„ç»“æœã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public class AddTask extends RecursiveTask&lt;Integer&gt; { /** * é˜ˆå€¼ */ private static final int THRESHOLD=10; private int[] nums; //å·¦è¾¹ç•Œ private int left; //å³è¾¹ç•Œ private int right; public AddTask(int[] nums, int left, int right) { this.nums = nums; this.left = left; this.right = right; } /** * ç”Ÿæˆéšæœºæ•°ç»„ * @return */ public static int[] randomNum(){ Random r = new Random(); int[] nums = new int[100]; for(int i=0;i&lt;100;i++){ nums[i] = r.nextInt(100); } return nums; } @Override protected Integer compute() { if (right-left&lt;THRESHOLD){ //ä»»åŠ¡åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼Œç¬¦åˆè¦æ±‚ï¼Œæ‰§è¡Œæ‰§è¡Œä»»åŠ¡ int sum=0; for (int i = left; i &lt;= right; i++) { try { TimeUnit.MILLISECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); } sum+=nums[i]; } return sum; }else { //ä»»åŠ¡å¤ªå¤§ï¼Œéœ€è¦åˆ†å‰²æˆå°ä»»åŠ¡ int mid=(left+right)/2; AddTask leftTask=new AddTask(nums,left,mid); AddTask rightTask=new AddTask(nums,mid+1,right); invokeAll(leftTask,rightTask); //è¿”å›å­ä»»åŠ¡åˆå¹¶çš„ç»“æœ return leftTask.join()+rightTask.join(); } }} 4.2åˆ›å»ºAddç±»è°ƒç”¨ä»»åŠ¡ç±»12345678910111213141516 */public class Add { public static void main(String[] args) { ForkJoinPool forkJoinPool=new ForkJoinPool(); int[] nums = AddTask.randomNum(); System.out.println(\"å¾…æ±‚å’Œæ•°ç»„:\"+ Arrays.toString(nums)); //åˆ›å»ºæ±‚å’Œä»»åŠ¡ AddTask addTask=new AddTask(nums,0,nums.length-1); forkJoinPool.invoke(addTask); System.out.println(\"æ±‚å’Œä¸­ã€‚ã€‚\"); System.out.println(\"å’Œä¸º:\"+addTask.join()); }} ç»“æœï¼šå¾…æ±‚å’Œæ•°ç»„:[34, 38, 71, 98, 38, 51, 35, 67, 59, 58, 33, 64, 65, 40, 30, 49, 67, 15, 4, 3, 5, 10, 94, 17, 24, 43, 94, 52, 53, 81, 7, 70, 25, 90, 96, 3, 84, 73, 54, 11, 42, 97, 18, 11, 95, 28, 14, 74, 95, 91, 53, 48, 69, 71, 91, 64, 25, 72, 3, 74, 77, 90, 22, 36, 77, 86, 41, 53, 92, 15, 30, 5, 51, 86, 60, 49, 76, 91, 15, 38, 55, 37, 24, 58, 53, 58, 75, 77, 34, 41, 88, 50, 91, 25, 56, 83, 14, 3, 75, 7]æ±‚å’Œä¸­ã€‚ã€‚å’Œä¸º:5134 è€Œå¦‚æœä½¿ç”¨submitæäº¤ï¼Œå°†æ•°ç»„å¤§å°æ”¹ä¸º10000ï¼Œå°±å¯çœ‹åˆ°æ±‚å’Œä¸­ä¸€å¥è¯æ˜¯åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰ä¼šæ‰“å°ï¼Œä½“ç°åŒæ­¥æ€§ã€‚","link":"/posts/20200123-ForkJoin.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹CountDownLatch,CyclicBarrierå’ŒSemaphore","text":"ä¸€ã€CountDownLatch CountDownLatchèƒ½å¤Ÿè®©ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹å…¨éƒ¨å®Œæˆå„è‡ªä»»åŠ¡åå†æ‰§è¡Œã€‚è€ŒCountDownLatchæ˜¯é€šè¿‡è®¡æ•°å™¨æ¥å®ç°çš„ï¼Œè®¡æ•°å™¨çš„åˆå§‹å€¼å³ä¸ºä»»åŠ¡çš„æ€»æ•°ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚ï¼ŒåŒå­¦èšä¼šç»“æŸå›å®¶ï¼Œæ¯ä¸ªäººéƒ½è¦å›å„è‡ªçš„å®¶ï¼Œæ­¤æ—¶è®¡æ•°å™¨çš„åˆå§‹å€¼ä¸ºå‚åŠ èšä¼šçš„æ€»äººæ•°ï¼Œè€Œæ¯ä¸ªäººéƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªåŒå­¦åˆ°å®¶åï¼Œéƒ½éœ€è¦è°ƒç”¨countDownæ–¹æ³•ï¼Œå¯¹è®¡æ•°å™¨å‡ä¸€ï¼Œè¡¨ç¤ºå®Œæˆå›å®¶çš„ä»»åŠ¡ï¼Œå½“æ‰€æœ‰åŒå­¦éƒ½åˆ°å®¶åï¼Œä¸»çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œé€šçŸ¥ç­é•¿å…¨éƒ¨åˆ°å®¶çš„ä»»åŠ¡ã€‚å†æ¯”å¦‚ï¼Œæ‰€ç¼–å†™çš„åº”ç”¨ç¨‹åºï¼Œå¸Œæœ›ç­‰å¾…å¯åŠ¨æ¡†æ¶çš„çº¿ç¨‹å¯åŠ¨å®Œæ¯•åå†æ‰§è¡Œã€‚ 1.1 æ„é€ æ–¹æ³•1234public CountDownLatch(int count) { if (count &lt; 0) throw new IllegalArgumentException(\"count &lt; 0\"); this.sync = new Sync(count); } CountDownLatchçš„æ„é€ æ–¹æ³•éœ€è¦ä¸€ä¸ªcountå‚æ•°ï¼Œä»£è¡¨åˆå§‹ä»»åŠ¡çš„æ•°é‡ï¼Œå¾€åæ¯å½“è°ƒç”¨ä¸€æ¬¡ï¼ˆCountDownLatch.countDown()æ–¹æ³•ï¼Œcountéƒ½å‡ä¸€ï¼Œå½“countå‡åˆ°0çš„æ—¶å€™ï¼Œè°ƒç”¨CountDownLatch.await()æ–¹æ³•çš„çº¿ç¨‹å°±å¯ä»¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒCountDownLatchè¿˜æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š 1.await(long timeout,TimeUnit unit) 1234public boolean await(long timeout, TimeUnit unit) throws InterruptedException { return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout)); } æ­¤æ–¹æ³•åœ¨await()çš„åŸºç¡€ä¸Šæ·»åŠ äº†æ—¶é—´é™åˆ¶ï¼Œå¦‚æœè°ƒç”¨awaitçš„çº¿ç¨‹åœ¨åˆ°è¾¾è¯¥æ—¶é—´åï¼Œcountä»ç„¶æ²¡æœ‰0ï¼Œå…¶ä¼šç»§ç»­æ‰§è¡Œï¼Œä¸å†ç­‰åˆ°countåˆ°0ã€‚ 2. public long getCount() 123public long getCount() { return sync.getCount(); } å³è·å–è¯¥CountDownLatchå½“å‰çš„countå€¼ äºŒã€Demoåº”ç”¨12345678910111213141516171819202122232425262728293031323334353637383940414243package com.wml.test1.countdownlatch;import java.util.concurrent.CountDownLatch;/** * @author Wang * @date 2020/1/2317:27 */public class CountDownLatchTest { //1. private static CountDownLatch finishEat=new CountDownLatch(1); //2. private static CountDownLatch friends=new CountDownLatch(10); public static void main(String[] args) throws InterruptedException { //3. for (int i = 0; i &lt;10; i++) { new Thread(()-&gt;{ try { //4. finishEat.await(); System.out.println(Thread.currentThread().getName()+\"æ­£åœ¨å›å®¶\"); //5. friends.countDown(); System.out.println(Thread.currentThread().getName()+\"åˆ°å®¶å•¦\"); } catch (InterruptedException e) { e.printStackTrace(); } },\"åŒå­¦\"+(i+1)).start(); } System.out.println(\"èšä¼šç»“æŸï¼ŒåŒå­¦ä»¬å‡†å¤‡å›å®¶\"); //6. finishEat.countDown(); //7. friends.await(); //8. System.out.println(\"åŒå­¦å…¨éƒ¨åˆ°å®¶\"); }} è¯´æ˜ï¼š1.ä»£ç 1åˆ›å»ºä¸€ä¸ªç»“æŸèšé¤çš„CountDownLatchï¼ŒfinishEatã€‚åˆå§‹å€¼ä¸º1ï¼Œä»£è¡¨æ­£åœ¨èšé¤ï¼Œå½“ä¸»çº¿ç¨‹è°ƒç”¨countDown()æ—¶ï¼ˆä»£ç 6ï¼‰ï¼Œcountå€¼ä»1å˜ä¸º0ï¼Œä»£è¡¨ç»“æŸèšé¤ã€‚è¿™æ—¶ï¼Œå…¶ä»–è°ƒç”¨finishEat.await();çš„çº¿ç¨‹ï¼ˆå„ä¸ªåŒå­¦å›å®¶çš„çº¿ç¨‹ï¼‰ç”±é˜»å¡çŠ¶æ€å˜ä¸ºæ‰§è¡Œã€‚2.ä»£ç 2åˆ›å»ºä¸€ä¸ªåŒå­¦å›å®¶çš„CountDownLatchï¼Œfriendsã€‚åˆå§‹å€¼ä¸º10ï¼Œä»£è¡¨å‚åŠ èšä¼šçš„10ä¸ªåŒå­¦ï¼Œå³10ä¸ªåŒå­¦éœ€è¦æ‰§è¡Œå›å®¶ä»»åŠ¡ã€‚å›å®¶çš„ä»»åŠ¡éœ€è¦åœ¨ä»£ç 4finishEat.await();åæ‰§è¡Œã€‚3.ä»£ç 3åˆ›å»º10ä¸ªå›å®¶çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æ‰§è¡Œä¸€æ¬¡friends.countDown();ï¼Œè®©friendsçš„countå‡ä¸€4.ä»£ç 7friends.await();ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…friendsçš„countå˜ä¸º0æ—¶å¼€å§‹æ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚ç»“æœï¼š 1234567891011121314èšä¼šç»“æŸï¼ŒåŒå­¦ä»¬å‡†å¤‡å›å®¶åŒå­¦1æ­£åœ¨å›å®¶åŒå­¦1åˆ°å®¶å•¦åŒå­¦2æ­£åœ¨å›å®¶åŒå­¦2åˆ°å®¶å•¦åŒå­¦4æ­£åœ¨å›å®¶åŒå­¦4åˆ°å®¶å•¦åŒå­¦3æ­£åœ¨å›å®¶åŒå­¦3åˆ°å®¶å•¦åŒå­¦5æ­£åœ¨å›å®¶åŒå­¦5åˆ°å®¶å•¦åŒå­¦6æ­£åœ¨å›å®¶åŒå­¦6åˆ°å®¶å•¦åŒå­¦å…¨éƒ¨åˆ°å®¶ ä¸‰ã€CyclicBarrierCyclicï¼ˆå¾ªç¯çš„ï¼‰Barrierï¼ˆå±éšœï¼‰ï¼Œè¯¥å·¥å…·åšçš„äº‹æƒ…æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆåŒæ­¥ç‚¹/ä¸´ç•Œç‚¹ï¼‰æ—¶ä¼šè¢«é˜»å¡ï¼Œç­‰å¾…åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾è¯¥ç‚¹åï¼Œè¢«æ‹¦æˆªé˜»å¡çš„çº¿ç¨‹æ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚æ¯”å¦‚ï¼šåŒå­¦èšé¤ï¼Œä¸ä¼šæ˜¯åˆ°ä¸€ä¸ªå°±åƒä¸€ä¸ªï¼Œè€Œæ˜¯åˆ°çš„äººå…ˆç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰äººéƒ½è¾¾åˆ°é¥­æ¡Œåï¼Œæ‰å¼€å§‹åƒé¥­ã€‚è¿™é‡Œé¤æ¡Œå°±ç±»ä¼¼barrierï¼Œæ¯ä¸ªåŒå­¦éƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªäººåˆ°é¥­æ¡Œåéƒ½è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªåŒå­¦åˆ°è¾¾ã€‚è€Œå› ä¸ºCyclicBarrieræ˜¯å¯å¾ªç¯çš„ï¼Œå½“ä¸€ç»„çº¿ç¨‹åˆ°è¾¾åï¼Œå…¶ä»ç„¶æœ‰æ•ˆï¼Œå¯ä»¥ç»§ç»­ä¸‹ä¸€ç»„å¾ªç¯ã€‚ 3.1æ„é€ æ–¹æ³•1.é»˜è®¤æ„é€ æ–¹æ³• 123public CyclicBarrier(int parties) { this(parties, null); } ä¼ å…¥çš„å‚æ•°è¡¨ç¤ºéœ€è¦æ‹¦æˆªçš„çº¿ç¨‹æ€»æ•°ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨CyclicBarrier.await()æ–¹æ³•åï¼Œä¼šé€šçŸ¥CyclicBarrierè¯¥çº¿ç¨‹å·²åˆ°è¾¾å±éšœã€‚ä¸CountDownLatchä¸€æ ·ï¼ŒCyclicBarrierä¹Ÿä¸ºawaitæä¾›äº†è¶…æ—¶æ—¶é—´è®¾ç½®ã€‚ 123456public int await(long timeout, TimeUnit unit) throws InterruptedException, BrokenBarrierException, TimeoutException { return dowait(true, unit.toNanos(timeout)); } çº¿ç¨‹é˜»å¡ç›´åˆ°åˆ°è¾¾è¶…æ—¶æ—¶é—´ã€‚2.é«˜çº§æ„é€ æ–¹æ³• 1public CyclicBarrier(int parties, Runnable barrierAction) è¯¥æ–¹æ³•ä½¿å¾—çº¿ç¨‹åˆ°è¾¾éšœç¢åï¼Œä¼˜å…ˆæ‰§è¡ŒbarrierActionçš„æ“ä½œã€‚ 3.2 CyclicBarrierçš„æ–¹æ³•3.2.1 await1234567public int await() throws InterruptedException, BrokenBarrierException { try { return dowait(false, 0L); } catch (TimeoutException toe) { throw new Error(toe); // cannot happen } } è¯¥æ–¹æ³•ç­‰å¾…æ‰€æœ‰çš„çº¿ç¨‹éƒ½åˆ°è¾¾æŒ‡å®šçš„ä¸´ç•Œç‚¹ã€‚ä½†å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æœ€ååˆ°è¾¾çš„çº¿ç¨‹ï¼Œåˆ™å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„å°†å…¶ç¦ç”¨ï¼Œå¹¶ä½¿å…¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ å…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ å…¶ä»–çº¿ç¨‹ä¸­æ–­ç­‰å¾…çº¿ç¨‹ä¹‹ä¸€ åœ¨å±éšœç­‰å¾…æ—¶å…¶ä»–çº¿ç¨‹è¶…æ—¶ å…¶ä»–çº¿ç¨‹åœ¨æ­¤å±éšœä¸Šè°ƒç”¨resetæ–¹æ³• åœ¨awaitæ–¹æ³•ä¸­è°ƒç”¨çš„dowaitæ–¹æ³•ä»¥ä¸‹æ˜¯dowaitæºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566private int dowait(boolean timed, long nanos) throws InterruptedException, BrokenBarrierException, TimeoutException { final ReentrantLock lock = this.lock; lock.lock(); try { final Generation g = generation; if (g.broken) throw new BrokenBarrierException(); //ä»£ç 1 if (Thread.interrupted()) { breakBarrier(); throw new InterruptedException(); } //ä»£ç 2 int index = --count; if (index == 0) { // tripped boolean ranAction = false; try { final Runnable command = barrierCommand; if (command != null) command.run(); ranAction = true; nextGeneration(); return 0; } finally { if (!ranAction) breakBarrier(); } } // ä»£ç 3 for (;;) { try { if (!timed) trip.await(); else if (nanos &gt; 0L) nanos = trip.awaitNanos(nanos); } catch (InterruptedException ie) { if (g == generation &amp;&amp; ! g.broken) { breakBarrier(); throw ie; } else { // We're about to finish waiting even if we had not // been interrupted, so this interrupt is deemed to // \"belong\" to subsequent execution. Thread.currentThread().interrupt(); } } if (g.broken) throw new BrokenBarrierException(); if (g != generation) return index; if (timed &amp;&amp; nanos &lt;= 0L) { breakBarrier(); throw new TimeoutException(); } } } finally { lock.unlock(); } } è¯´æ˜ï¼šä»£ç 1ï¼šå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œä¼šè°ƒç”¨breakBarrieræ–¹æ³•å¹¶æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚breakBarrieræ–¹æ³•å¦‚ä¸‹ï¼š 12345private void breakBarrier() { generation.broken = true; count = parties; trip.signalAll(); } 1.breakBarrieré¦–å…ˆå°†è¯¥ä»£çš„brokenè®¾ç½®ä¸ºtrueï¼Œä»£è¡¨å…¶è¢«æ‰“ç ´ã€‚2.generationæ˜¯CyclicBarrierçš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»Generationçš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä»£è¡¨å±éšœçš„å½“å‰ä»£ï¼Œå¯ä»¥å®ç°å¾ªç¯ç­‰å¾…ã€‚brokenä¸ºtrueï¼Œåˆ™è¯¥å¾ªç¯ç»“æŸã€‚3.åŒæ—¶å°†counté‡ç½®ä¸ºpartiesï¼› countä¸ºè®¡æ•°å™¨ï¼Œpartiesæ˜¯CyclicBarrierçš„æ„é€ å‚æ•°ï¼Œä»£è¡¨æ‹¦æˆªçš„çº¿ç¨‹æ•°4.è°ƒç”¨tripçš„signalAll()æ–¹æ³•ï¼Œå°†æ‰€æœ‰é˜»å¡çš„çº¿ç¨‹å”¤é†’ tripæ˜¯æˆå‘˜å˜é‡Conditionçš„å¯¹è±¡ï¼Œå¯è§æ˜¯ä½¿ç”¨Conditionå®ç°é˜»å¡é˜Ÿåˆ—çš„ã€‚ä»£ç 2ï¼šè®¡æ•°å™¨countå‡ä¸€å¹¶èµ‹å€¼ç»™intå˜é‡indexï¼Œå¦‚æœæ­¤æ—¶indexå€¼ä¸º0ï¼Œåˆ™åˆ¤æ–­å½“å‰barrierCommandæ˜¯å¦ä¸ºç©ºï¼Œï¼ˆbarrierCommandä¹Ÿæ˜¯CyclicBarrierçš„æˆå‘˜å˜é‡ï¼Œä¸ºæ¢ä»£å‰ä¼˜å…ˆæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå…¶åœ¨CyclicBarrieræ„é€ æ–¹æ³•ä¸­ä¼ å…¥ï¼Œå¦‚ä¸‹ï¼š 12345public CyclicBarrier(int parties, Runnable barrierAction) { .......... ........... this.barrierCommand = barrierAction; } ï¼‰ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œè¯¥æ“ä½œçš„run()æ–¹æ³•ã€‚æœ€åç½®ranActionä¸ºtrueï¼Œä¸ªäººç†è§£ä»£è¡¨ç»§ç»­æ‰§è¡Œï¼Œå¹¶æ‰§è¡ŒnextGeneration()è¿›å…¥ä¸‹ä¸€ä»£ï¼ˆä¸‹ä¸€ä¸ªå¾ªç¯ï¼‰ã€‚nextGeneration()ä»£ç å¦‚ä¸‹ï¼š 1234567private void nextGeneration() { // signal completion of last generation trip.signalAll(); // set up next generation count = parties; generation = new Generation(); } åœ¨nextGeneration()ä¸­å”¤é†’æ‰€æœ‰é˜»å¡è¿›ç¨‹ï¼Œé‡ç½®è®¡æ•°å™¨ï¼Œå¹¶é‡æ–°newäº†ä¸€ä¸ªGenerationã€‚è€Œåœ¨finallyä¸­ï¼Œå¦‚æœbarrierCommandæ‰§è¡Œå‡ºé”™ï¼Œæˆ–å…¶ä»–åŸå› ï¼Œä¼šæ‰§è¡ŒbreakBaåœ¨è¿™é‡Œæ’å…¥ä»£ç ç‰‡rrier()æ–¹æ³•ã€‚ä»£ç 3ï¼šæ— é™å¾ªç¯ç›´åˆ°å‘ç”Ÿtrippedï¼Œæ–­å¼€ï¼Œä¸­æ–­æˆ–è¶…æ—¶ã€‚timedä»£è¡¨æ˜¯å¦å¼€å¯è¶…æ—¶æ—¶é—´ï¼Œnanos ä¸ºè®¾å®šçš„è¶…æ—¶æ—¶é—´ 3.2.2 getNumberWaiting123456789public int getNumberWaiting() { final ReentrantLock lock = this.lock; lock.lock(); try { return parties - count; } finally { lock.unlock(); }} è¿”å›å½“å‰æœ‰å¤šå°‘ä¸ªçº¿ç¨‹é˜»å¡ç­‰å¾…åœ¨å±éšœä¸Š 3.3 isBroken1boolean isBroken() è¿”å›æŸ¥è¯¢é˜»å¡ç­‰å¾…çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­æ‰“ç ´ å››ã€CyclicBarrier ä¾‹å­12345678910111213141516171819202122232425262728293031323334353637package com.wml.test1.cyclicbarrier;import java.util.concurrent.*;/** * @author Wang * @date 2020/1/2317:44 */public class CyclicBarrierTest { //ä»£ç 1 private static CyclicBarrier barrier=new CyclicBarrier(6,()-&gt;{ System.out.println(\"åŒå­¦ä»¬éƒ½åˆ°é½äº†ï¼Œå’±ä»¬å¼€é¥­\"); }); public static void main(String[] args) { ExecutorService pool = new ThreadPoolExecutor(6,100,0L,TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); for (int i = 1; i &lt;= 6; i++) { pool.execute(() -&gt; { try { System.out.println(Thread.currentThread().getName() + \"åˆ°äº†\"); //ä»£ç 2 barrier.await(); System.out.println(Thread.currentThread().getName() + \"å¼€åƒ\"); } catch (InterruptedException e) { e.printStackTrace(); } catch (BrokenBarrierException e) { e.printStackTrace(); } }); } }} è¯´æ˜ï¼šè¯¥ä¾‹å­ä¸ºåŒå­¦èšé¤ï¼Œæ¯åˆ°ä¸€ä¸ªåŒå­¦ä¾¿é˜»å¡è‡ªå·±ï¼Œå½“æ‰€æœ‰åŒå­¦éƒ½åˆ°é½åï¼Œè¾“å‡ºâ€œå¼€é¥­â€ï¼Œç„¶åå”¤é†’æ‰€æœ‰åŒå­¦ï¼Œæ‰§è¡Œâ€œåƒé¥­â€ ä»£ç 1ï¼šæ„é€ ä¸€ä¸ªCyclicBarrier å±éšœï¼Œæ‹¦æˆªçº¿ç¨‹æ•°ä¸º6ï¼Œåœ¨è¿›å…¥ä¸‹ä¸€ä»£å‰æ‰§è¡ŒSystem.out.println(&quot;åŒå­¦ä»¬éƒ½åˆ°é½äº†ï¼Œå’±ä»¬å¼€é¥­&quot;);è¿™ä¸€barrierCommandï¼Œå³å½“å‰ä»£ç»“æŸï¼ˆæ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœæ—¶æˆ–å…¶ä»–åŸå› ï¼‰åä¼˜å…ˆæ‰§è¡Œè¯¥æ“ä½œã€‚ä»£ç 2ï¼šæ¯ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœåæ‰§è¡Œawaitæ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾ï¼Œawaitä¸­ä¼šæ‰§è¡Œå”¤é†’æ‰€æœ‰é˜»å¡çº¿ç¨‹çš„æ–¹æ³•ï¼Œæœ€åæ‰ä¼šæ‰§è¡Œåé¢çš„ä»£ç ã€‚ç»“æœï¼š 12345678910111213pool-1-thread-1åˆ°äº†pool-1-thread-2åˆ°äº†pool-1-thread-3åˆ°äº†pool-1-thread-4åˆ°äº†pool-1-thread-5åˆ°äº†pool-1-thread-6åˆ°äº†åŒå­¦ä»¬éƒ½åˆ°é½äº†ï¼Œå’±ä»¬å¼€é¥­pool-1-thread-6å¼€åƒpool-1-thread-2å¼€åƒpool-1-thread-3å¼€åƒpool-1-thread-5å¼€åƒpool-1-thread-4å¼€åƒpool-1-thread-1å¼€åƒ äº”ã€CountDownLatchå’ŒCyclicBarrierçš„å¼‚åŒ1.CountDownLatchæŠ€æœ¯å™¨åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ŒCyclicBarrierçš„å¯ä»¥å¾ªç¯ä½¿ç”¨ã€‚2.CountDownLatchæ˜¯ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆä»»åŠ¡åæ‰ä¼šæ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼Œæ˜¯é˜»å¡å·¥ä½œçº¿ç¨‹ã€‚CyclicBarrieræ˜¯æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾æŸä¸ªå±éšœï¼ˆä¸´ç•Œç‚¹ï¼‰åäº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾åå†å…±åŒè¿›è¡Œä¸‹é¢çš„ä»»åŠ¡ã€‚3.CountDownLatchè°ƒç”¨countDownæ–¹æ³•å¯ä»¥ç»§ç»­æ‰§è¡Œåé¢çš„ï¼Œåªæ˜¯è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨countDownï¼›CyclicBarrieræ˜¯æ‰€æœ‰çš„çº¿ç¨‹è°ƒç”¨awaitè¿›è¡Œè‡ªé˜»å¡ï¼Œç­‰åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨ä¸€æ¬¡awaitåä¸€èµ·ç»§ç»­æ‰§è¡Œåé¢æ“ä½œã€‚4.CyclicBarrierå¯ä»¥åœ¨æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœåæ‰§è¡ŒbarrierActionæ“ä½œï¼Œå®Œæˆå¤æ‚çš„é€»è¾‘åœºæ™¯ã€‚ å…­ã€SemaphoreSemaphoreå³ä¿¡å·é‡ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œæˆ–åŒæ—¶æ‰§è¡ŒæŸä¸ªæŒ‡å®šæ“ä½œçš„æ•°é‡ã€‚æ¯”å¦‚å¯ä»¥ç”¨æ¥å®ç°æ•°æ®åº“çš„è¿æ¥æ± ç­‰ã€‚å¦‚æ•°æ®åº“çš„è¿æ¥æ•°ä¸º20ä¸ªï¼Œè¿™æ—¶åªèƒ½æœ‰20ä¸ªçº¿ç¨‹åŒæ—¶è·å–æ•°æ®é‡è¿æ¥ï¼Œå†å¤šçš„çº¿ç¨‹åªèƒ½é˜»å¡ç­‰å¾…ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å½’è¿˜è¿æ¥åï¼Œé˜»å¡çš„çº¿ç¨‹æ‰èƒ½ç»§ç»­è·å–ã€‚ Semaphoreçš„æ„é€ æ–¹æ³•ï¼š 1public Semaphore(int permits) ä¼ å…¥ä¸€ä¸ªæ•´å‹permitsï¼Œä»£è¡¨å¯ç”¨çš„è®¸å¯è¯æ•°é‡ã€‚æ“ä½œæ—¶å¿…é¡»å…ˆè·å–è®¸å¯è¯ï¼Œæ‰èƒ½ç»§ç»­æ“ä½œï¼Œå½“æ“ä½œå®Œæˆåéœ€é‡Šæ”¾è®¸å¯è¯ï¼Œå…¶ä½™æ²¡æœ‰è·å¾—è®¸å¯è¯çš„ä¾¿é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾äº†è®¸å¯è¯ã€‚çº¿ç¨‹ä½¿ç”¨Semaphoreçš„acquire()æ–¹æ³•è·å–è®¸å¯è¯ï¼Œä½¿ç”¨release()æ–¹æ³•é‡Šæ”¾è®¸å¯è¯ï¼Œä½¿ç”¨tryAcquire()æ–¹æ³•å°è¯•è·å–è®¸å¯è¯. å…¶ä»–æ–¹æ³•ï¼š 12345intavailablePermits() //è¿”å›æ­¤ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯è¯æ•°ã€‚intgetQueueLength() //è¿”å›æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹æ•°ã€‚booleanhasQueuedThreads()//æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯ã€‚void reducePermitsï¼ˆ int reductionï¼‰ //å‡å°‘ reduction ä¸ªè®¸å¯è¯Collection getQueuedThreads() //è¿”å›æ‰€æœ‰ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹é›†åˆ semaphoreç¤ºä¾‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566package com.wml.test1.semphore;import java.sql.Connection;import java.util.LinkedList;import java.util.Random;import java.util.concurrent.*;/** * @author Wang * @date 2020/1/2416:31 */public class SemphoreTest { private final static int POOL_SIZE=10; private final Semaphore connections; //è¿æ¥æ±  private static LinkedList&lt;Integer&gt;pool; public SemphoreTest() { pool=new LinkedList&lt;&gt;(); //åˆå§‹åŒ–è¿æ¥æ±  for (int i = 0; i &lt; POOL_SIZE; i++) { pool.addLast(i); } this.connections = new Semaphore(POOL_SIZE); } //é‡Šæ”¾è¿æ¥ public void release(Integer conn){ if(conn!=null) { System.out.println(\"å½“å‰æœ‰\"+connections.getQueueLength()+\"ä¸ªçº¿ç¨‹ç­‰å¾…æ•°æ®åº“è¿æ¥!!\" +\"å¯ç”¨è¿æ¥æ•°ï¼š\"+connections.availablePermits()); synchronized (pool) { pool.addLast(conn); } connections.release(); } } //è·å–è¿æ¥ public Integer acquire() throws InterruptedException { connections.acquire(); Integer conn; synchronized (pool){ conn=pool.removeFirst(); } return conn; } public static void main(String[] args) { SemphoreTest dbPool=new SemphoreTest(); ExecutorService pool = new ThreadPoolExecutor(50,100,0L, TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); //50ä¸ªçº¿ç¨‹è·å–è¿æ¥ for (int i = 0; i &lt; 50; i++) { pool.execute(()-&gt;{ try { Integer conn=dbPool.acquire(); System.out.println(Thread.currentThread().getName() +\"--------è·å–æ•°æ®åº“è¿æ¥\"); Thread.sleep(1000); System.out.println(\"å½’è¿˜è¿æ¥\"); dbPool.release(conn); } catch (InterruptedException e) { } }); } }}","link":"/posts/20200124-cdlcbs.html"},{"title":"javaå¤šçº¿ç¨‹ä¹‹Callable+Future+FutureTaskåŸç†è¯¦è§£å’Œç®€å•ä½¿ç”¨","text":"ä¸€ã€Runnableå’ŒCallableRunnableæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªå£°æ˜äº†ä¸€ä¸ªrun()æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸ºvoidç±»å‹ï¼Œæ‰€ä»¥åªèƒ½æ‰§è¡Œæ— è¿”å›å€¼çš„ä»»åŠ¡ã€‚ 123public interface Runnable { public abstract void run();} Callableæ˜¯java.util.concurrentåŒ…ä¸‹çš„ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†ä¸€ä¸ªcall()æ–¹æ³•: 12345678910@FunctionalInterfacepublic interface Callable&lt;V&gt; { /** * Computes a result, or throws an exception if unable to do so. * * @return computed result * @throws Exception if unable to compute a result */ V call() throws Exception;} è¯¥æ–¹æ³•è¿”å›çš„æ•°æ®ç±»å‹å°±æ˜¯ä¼ è¿›æ¥çš„æ³›å‹ç±»å‹ï¼Œä¸»è¦ç”¨äºè®¡ç®—äº§ç”Ÿç»“æœã€‚å¦‚æœæ²¡æœ‰è®¡ç®—å‡ºç»“æœï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ äºŒã€FutureFutureåˆ™æ˜¯å¯¹äºå…·ä½“çš„Runnableæˆ–Callableä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€åˆ¤æ–­æ˜¯å¦å®Œæˆã€è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚Futureæ¥å£å£°æ˜äº†5ä¸ªæ–¹æ³•ï¼š 1boolean cancel(boolean mayInterruptIfRunning); å°è¯•å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚å¦‚æœå–æ¶ˆæˆåŠŸåˆ™è¿”å›trueï¼Œå–æ¶ˆå¤±è´¥åˆ™è¿”å›falseã€‚ å¦‚æœä»»åŠ¡å·²å®Œæˆã€å·²å–æ¶ˆæˆ–ç”±äºå…¶ä»–åŸå› æ— æ³•å–æ¶ˆï¼Œåˆ™æ­¤å°è¯•å°†å¤±è´¥ï¼Œè¿”å›falseã€‚ä¼ å…¥çš„å‚æ•°å¦‚æœä¸ºtrueï¼Œåˆ™ç›´æ¥ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿”å›trueï¼›å¦‚æœä¸ºfalseï¼Œåˆ™å…è®¸æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡å®Œæˆã€‚ 1boolean isCancelled(); ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆæˆåŠŸï¼Œå¦‚æœæ­¤ä»»åŠ¡åœ¨æ­£å¸¸å·¥ä½œä¹‹å‰è¢«å–æ¶ˆï¼Œåˆ™è¿”å›trueã€‚ 1boolean isDone(); å¦‚æœæ­¤ä»»åŠ¡å·²å®Œæˆï¼Œåˆ™è¿”å›trueã€‚å®Œæˆå¯èƒ½æ˜¯ç”±äºæ­£å¸¸ç»ˆæ­¢ã€å¼‚å¸¸æˆ–å–æ¶ˆ - åœ¨æ‰€æœ‰è¿™äº›æƒ…å†µä¸‹ï¼Œæ­¤æ–¹æ³•å°†è¿”å› trueã€‚ 1V get() throws InterruptedException, ExecutionException; ä»¥é˜»å¡çš„æ–¹å¼è·å–ä»»åŠ¡æ‰§è¡Œç»“æœï¼ŒçŸ¥é“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•è¿”å›ã€‚å¦å¤–åœ¨ä»¥ä¸‹æƒ…å†µä¼šæŠ›å‡ºå¼‚å¸¸ï¼š1.ä»»åŠ¡è¢«å–æ¶ˆï¼šæŠ›å‡º CancellationException å¼‚å¸¸2.è®¡ç®—å¼•å‘å¼‚å¸¸ï¼šæŠ›å‡º ExecutionException å¼‚å¸¸3.å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼šæŠ›å‡º InterruptedException å¼‚å¸¸ 12V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException; åŒä¸Šï¼Œä½†è§„å®šäº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰è®¡ç®—å‡ºç»“æœï¼Œä¼šæŠ›å‡ºTimeoutExceptionå¼‚å¸¸ã€‚ ä¸‰ã€FutureTaskFutureTaskç±»å®ç°äº†RunnableFutureæ¥å£ï¼Œè€ŒRunnableFutureç»§æ‰¿äº†Runnableå’ŒFutureæ¥å£ï¼Œå¯çŸ¥FutureTaskå¯åšRunnableå’ŒFutureä¸€æ ·çš„äº‹æƒ…ã€‚ 123public class FutureTask&lt;V&gt; implements RunnableFuture&lt;V&gt; public interface RunnableFuture&lt;V&gt; extends Runnable, Future&lt;V&gt; 3.1 é¦–å…ˆçœ‹FutureTaskçš„æˆå‘˜å˜é‡1234567891011121314private volatile int state; private static final int NEW = 0; private static final int COMPLETING = 1; private static final int NORMAL = 2; private static final int EXCEPTIONAL = 3; private static final int CANCELLED = 4; private static final int INTERRUPTING = 5; private static final int INTERRUPTED = 6; private Callable&lt;V&gt; callable; private Object outcome; // non-volatile, protected by state reads/writes private volatile Thread runner; private volatile WaitNode waiters; 1.stateï¼šstateä¿å­˜äº†FutureTaskä»»åŠ¡çš„çŠ¶æ€å€¼ï¼Œä¸ºvolatileç±»å‹ï¼Œä¿è¯äº†åŸå­æ€§ï¼Œå³ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†stateçš„å€¼ï¼Œéƒ½å¯ä»¥ä¿è¯å…¶ä»–çº¿ç¨‹çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚stateå…±æœ‰å¦‚ä¸‹å‡ ä¸ªå–å€¼ï¼ˆå¯¹åº”çš„å€¼ä¾æ­¤ä¸º0åˆ°6ï¼‰ï¼š NEWï¼šä¸ºstateçš„åˆå§‹å€¼ã€‚è¡¨ç¤ºè¯¥ä»»åŠ¡æ˜¯ä¸ªæ–°ä»»åŠ¡ã€‚COMPLETING:å½“å‰ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•æˆ–æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œä½†ç»“æœå°šæœªä¿å­˜åˆ°outcomeï¼ˆoutcomeç”¨æ¥ä¿å­˜è®¡ç®—ç»“æœæˆ–è€…æ˜¯å¼‚å¸¸ä¿¡æ¯ï¼‰ä¸­ï¼Œå±äºä¸­é—´çŠ¶æ€ã€‚NORMAL: ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä¸”ç»“æœä¿å­˜åˆ°outcomeä¸­ã€‚æ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚EXCEPTIONAL: ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œä¸”å¼‚å¸¸ä¿¡æ¯å·²ä¿å­˜åˆ°outcomeä¸­ã€‚æ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚CANCELLEDï¼šä»»åŠ¡å°šæœªå¼€å§‹æˆ–ä»»åŠ¡æ‰§è¡Œæ—¶è°ƒç”¨äº†cancel(false)æ–¹æ³•ã€‚æ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚INTERRUPTINGï¼šä»»åŠ¡å°šæœªå¼€å§‹æˆ–ä»»åŠ¡æ‰§è¡Œæ—¶è°ƒç”¨äº†cancel(true)æ–¹æ³•ã€‚æ­¤ä¸ºä¸­é—´çŠ¶æ€ã€‚INTERRUPTED: åœ¨è°ƒç”¨cancel(true)æ—¶ï¼Œä¼šè°ƒç”¨: 123Thread t = runner; if (t != null) t.interrupt(); stateä¼šå˜ä¸ºINTERRUPTEDï¼Œæ­¤ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚ä½†å¦‚æœè¢«ç»ˆç«¯çš„çº¿ç¨‹æ­£åœ¨sleep()ã€wait()ã€æˆ–join()ï¼Œåˆ™ä¼šæŠ›å‡ºInterruptedException()å¼‚å¸¸ï¼Œå› æ­¤cancel(true)ï¼ˆæ³¨æ„ï¼šä¸­é—´çŠ¶æ€æ—¶é—´çŸ­æš‚ï¼Œä¸ä»£è¡¨ä»»åŠ¡ä»åœ¨æ‰§è¡Œï¼Œè€Œæ˜¯ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå°šæœªè®¾ç½®æ‰§è¡Œç»“æœï¼Œå› æ­¤é™¤äº†NEWçŠ¶æ€ï¼Œå…¶ä½™çŠ¶æ€éƒ½ä»£è¡¨å·²ç»æ‰§è¡Œç»“æŸï¼‰å¯èƒ½å‡ºç°çš„è½¬å˜çŠ¶æ€ä¸ºï¼š 1234NEW -&gt; COMPLETING -&gt; NORMALNEW -&gt; COMPLETING -&gt; EXCEPTIONALNEW -&gt; CANCELLEDNEW -&gt; INTERRUPTING -&gt; INTERRUPTED 2.callableï¼šè¦æ‰§è¡Œçš„taskä»»åŠ¡ã€‚3.outcome: ä¿å­˜æ‰§è¡Œç»“æœæˆ–å‡ºç°å¼‚å¸¸æ—¶ä¿å­˜å¼‚å¸¸ä¿¡æ¯4.runner:æ‰§è¡Œtaskçš„çº¿ç¨‹ï¼Œåœ¨å–æ¶ˆå’Œä¸­æ–­çº¿ç¨‹æ—¶éœ€è¦çŸ¥é“æ˜¯å“ªä¸ªçº¿ç¨‹ã€‚5.waitersï¼šä¸ºWaitNode çš„å¯¹è±¡ã€‚WaitNode ä¸ºä¸€ä¸ªç®€å•çš„å•å‘é“¾è¡¨ç»“æ„çš„é˜Ÿåˆ—ï¼Œå½“ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰çº¿ç¨‹æƒ³è¦è°ƒç”¨get()è·å–ç»“æœæ—¶ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šè¢«é˜»å¡åŠ å…¥WaitNodeï¼Œç›´åˆ°è¯¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ä»¥ä¸‹ä¸ºWaitNodeçš„ç»“æ„ï¼š 12345static final class WaitNode { volatile Thread thread; volatile WaitNode next; WaitNode() { thread = Thread.currentThread(); } } ä»…ç”±ä¸€ä¸ªThreadå’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„nextç»„æˆï¼Œthreadå³ä¸ºå½“å‰çº¿ç¨‹ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªTreiberæ ˆã€‚ 3.2é™æ€ä»£ç å—ä¸­åˆå§‹åŒ–éœ€è¦CASæ“ä½œçš„å±æ€§çš„åç§»é‡12345678910111213141516171819// Unsafe mechanics private static final sun.misc.Unsafe UNSAFE; private static final long stateOffset; private static final long runnerOffset; private static final long waitersOffset; static { try { UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = FutureTask.class; stateOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(\"state\")); runnerOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(\"runner\")); waitersOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(\"waiters\")); } catch (Exception e) { throw new Error(e); } } CASæ“ä½œè°ƒç”¨çš„æ˜¯compareAndSwap***æ–¹æ³• 3.3 æ„é€ æ–¹æ³•3.3.1 123456public FutureTask(Callable&lt;V&gt; callable) { if (callable == null) throw new NullPointerException(); this.callable = callable; this.state = NEW; // ensure visibility of callable } å°†ä¼ å…¥çš„callableèµ‹å€¼ç»™ä¸Šé¢è¯´çš„æˆå‘˜å˜é‡callableï¼Œå°†stateåˆå§‹åŒ–ä¸ºNEWï¼›3.3.2 1234public FutureTask(Runnable runnable, V result) { this.callable = Executors.callable(runnable, result); this.state = NEW; // ensure visibility of callable } ä¼ å…¥Runnableå¯¹è±¡ï¼Œé€šè¿‡Executors.callable()æ–¹æ³•å°†runnableè½¬ä¸ºcallableä¿å­˜ç»™callableå˜é‡ï¼ŒåŒæ—¶ä¼šè¿”å›ä¼ å…¥çš„resultã€‚å°†runnableè½¬ä¸ºcallableçš„æ–¹æ³•å¦‚ä¸‹ï¼š 12345public static &lt;T&gt; Callable&lt;T&gt; callable(Runnable task, T result) { if (task == null) throw new NullPointerException(); return new RunnableAdapter&lt;T&gt;(task, result); } è¿™é‡Œè°ƒç”¨RunnableAdapter()é€‚é…,ä»£ç å¦‚ä¸‹ï¼š 12345678910111213static final class RunnableAdapter&lt;T&gt; implements Callable&lt;T&gt; { final Runnable task; final T result; RunnableAdapter(Runnable task, T result) { this.task = task; this.result = result; } public T call() { task.run(); return result; } } } RunnableAdapterå®ç°äº†Callableæ¥å£ï¼Œåœ¨call()ä¸­è°ƒç”¨task.run()ï¼Œå°†ä¼ å…¥çš„resultè¿”å›ã€‚ 3.4 æ–¹æ³•3.4.1 run()1234567891011121314151617181920212223242526272829303132333435public void run() { //ä»£ç 1 if (state != NEW || !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread())) return; try { Callable&lt;V&gt; c = callable; if (c != null &amp;&amp; state == NEW) { //ä»£ç 2 V result; boolean ran; try { result = c.call(); ran = true; } catch (Throwable ex) { result = null; ran = false; setException(ex); } if (ran) set(result); } } finally { // runner must be non-null until state is settled to // prevent concurrent calls to run() //ä»£ç 3 runner = null; // state must be re-read after nulling runner to prevent // leaked interrupts int s = state; if (s &gt;= INTERRUPTING) handlePossibleCancellationInterrupt(s); } } ä»£ç 1ï¼š1.state!=NEW: å¦‚æœstateä¸ä¸ºNEWï¼Œå³ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•æˆ–è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›ã€‚2. è‹¥stateæ˜¯NEWï¼Œåˆ™å°è¯•å°†å½“å‰çº¿ç¨‹ä¿å­˜åˆ°runnerä¸­ï¼Œå³å¦‚æœrunnerä¸ºç©ºå°±å°†å½“å‰çº¿ç¨‹ä¿å­˜ç»™runnerï¼Œè‹¥runnerä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜å·²ç»æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œï¼Œç›´æ¥return,å¦åˆ™è¿›å…¥try-catchã€‚ ä»£ç 2ï¼š1.å®šä¹‰V resultä¿å­˜callableçš„æ‰§è¡Œç»“æœï¼Œç½®ranä¸ºtrueï¼Œä»£è¡¨æ‰§è¡ŒæˆåŠŸã€‚2.è‹¥å‡ºç°å¼‚å¸¸ï¼Œåˆ™åœ¨catchä¸­æ•è·ï¼Œå°†resultç½®ä¸ºnullï¼Œranç½®ä¸ºfalseä»£è¡¨å‡ºç°å¼‚å¸¸ï¼ŒåŒæ—¶é€šè¿‡setException(ex)è®¾ç½®å¼‚å¸¸ã€‚setException(ex)ä»£ç å¦‚ä¸‹ï¼š 1234567protected void setException(Throwable t) { if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) { outcome = t; UNSAFE.putOrderedInt(this, stateOffset, EXCEPTIONAL); // final state finishCompletion(); } } æ­¤æ–¹æ³•ä¸­ï¼Œå°è¯•å°†stateçš„å€¼ä»NEWæ”¹ä¸ºCOMPLETING,å¦‚æœæˆåŠŸï¼Œåˆ™å°†å¼‚å¸¸ä¿¡æ¯ä¿å­˜åˆ°outcomeä¸­ï¼Œç„¶åå†å°†çŠ¶æ€æ”¹ä¸ºæœ€ç»ˆæ€EXCEPTIONALï¼Œæœ€åè°ƒç”¨finishCompletion()ç§»é™¤å¹¶å”¤é†’WaitNodeä¸­æ‰€æœ‰é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œè°ƒç”¨done()ï¼Œå¹¶è®©callableæ— æ•ˆï¼Œæºç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122private void finishCompletion() { // assert state &gt; COMPLETING; for (WaitNode q; (q = waiters) != null;) { if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) { for (;;) { Thread t = q.thread; if (t != null) { q.thread = null; LockSupport.unpark(t); } WaitNode next = q.next; if (next == null) break; q.next = null; // unlink to help gc q = next; } break; } } done(); callable = null; } å¦‚æœranä¸ºtrueï¼Œå³æ­£å¸¸æ‰§è¡Œï¼Œé€šè¿‡set(result)ï¼Œset()æºç å¦‚ä¸‹ï¼š 1234567protected void set(V v) { if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) { outcome = v; UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state finishCompletion(); } } åœ¨set()ä¸­ï¼Œå°è¯•å°†çŠ¶æ€ä»NEWå˜ä¸ºCOMPLETINGä¸­é—´æ€(è¿™é‡Œå†é‡æ–°ç†è§£ä¸Šé¢è¯´çš„stateçš„7ä¸ªçŠ¶æ€ä¼šæ›´æ·±åˆ»ä¸€ç‚¹)ï¼Œå¹¶å°†ç»“æœä¿å­˜ç»™outcomeï¼Œæ¥ç€å°†stateç”±COMPLETINGè½¬ä¸ºNORMALæœ€ç»ˆçŠ¶æ€ï¼ŒåŒä¸Šè°ƒç”¨ finishCompletion()ã€‚ ä»£ç 3ï¼š1.åœ¨finallyä¸­é‡æ–°å°†runnerç½®ç©ºï¼Œè¡¨æ˜å½“å‰çº¿ç¨‹è¿è¡Œå®Œæ¯•ï¼Œåœ¨ä¸‹ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åˆ°run()ï¼ˆä»£ç 1ï¼‰æ–¹æ³•æ—¶ï¼Œä¾¿å¯é€šè¿‡CASé‡æ–°å°†çº¿ç¨‹ä¿å­˜åˆ°runnerã€‚2.è‹¥ranä¸ºfalseï¼Œå³å‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨handlePossibleCancellationInterrupt(state)å¤„ç†å¼‚å¸¸ï¼Œ 1234567891011121314151617private void handlePossibleCancellationInterrupt(int s) { // It is possible for our interrupter to stall before getting a // chance to interrupt us. Let's spin-wait patiently. if (s == INTERRUPTING) while (state == INTERRUPTING) Thread.yield(); // wait out pending interrupt // assert state == INTERRUPTED; // We want to clear any interrupt we may have received from // cancel(true). However, it is permissible to use interrupts // as an independent mechanism for a task to communicate with // its caller, and there is no way to clear only the // cancellation interrupt. // // Thread.interrupted(); } åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå¦‚æœçŠ¶æ€ä¸€ç›´æ˜¯INTERUPINGï¼Œåˆ™ä¸€ç›´è¿›è¡Œyield()ã€‚ 3.4.2 get()çº¿ç¨‹å¯è°ƒç”¨get()æ–¹æ³•è·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœï¼Œå¦‚æœå½“å‰ä»»åŠ¡å°šæœªæ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é˜»å¡è°ƒç”¨get()æ–¹æ³•çš„çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œç»“æŸã€‚ 123456789/** * @throws CancellationException {@inheritDoc} */ public V get() throws InterruptedException, ExecutionException { int s = state; if (s &lt;= COMPLETING) s = awaitDone(false, 0L); return report(s); } get()æ–¹æ³•ä¸­é¦–å…ˆåˆ¤æ–­å½“å‰çš„çŠ¶æ€æ˜¯å¦å°äºç­‰äºCOMPLETINGï¼Œå³ä»»åŠ¡æ˜¯å¦å¤„äºå°šæœªå¼€å§‹æˆ–å°šæœªç»“æŸæˆ–ç»“æœå°šæœªä¿å­˜åˆ°outcomeçš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨awaitDone(false, 0L);é˜»å¡ç­‰å¾…ï¼Œå¦åˆ™è°ƒç”¨report(s)è¿”å›æ‰§è¡Œç»“æœã€‚ report()12345678private V report(int s) throws ExecutionException { Object x = outcome; if (s == NORMAL) return (V)x; if (s &gt;= CANCELLED) throw new CancellationException(); throw new ExecutionException((Throwable)x); } è·å–å½“å‰ç»“æœoutcomeï¼Œå¦‚æœå½“å‰çŠ¶æ€ä¸ºNORMALï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœï¼Œå¦‚æœå½“å‰çŠ¶æ€å¤§äºç­‰äºCANCELLEDï¼Œåˆ™æŠ›å‡ºCancellationException()å¼‚å¸¸ï¼Œå…¶ä»–çŠ¶æ€åˆ™æŠ›å‡ºExecutionException()å¼‚å¸¸ã€‚ 3.4.3 awaitDone()çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•é˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445private int awaitDone(boolean timed, long nanos) throws InterruptedException { //è‹¥å¼€å¯è¶…æ—¶ï¼Œåˆ™è®¡ç®—æˆªæ­¢æ—¶é—´ final long deadline = timed ? System.nanoTime() + nanos : 0L; //åˆ›å»ºä¸€ä¸ªWaitNodeèŠ‚ç‚¹ WaitNode q = null; //æ˜¯å¦è¿›å…¥é˜»å¡é˜Ÿåˆ— boolean queued = false; for (;;) { //ä»£ç 1 if (Thread.interrupted()) { removeWaiter(q); throw new InterruptedException(); } int s = state; //ä»£ç 2 if (s &gt; COMPLETING) { if (q != null) q.thread = null; return s; } //ä»£ç 3 else if (s == COMPLETING) // cannot time out yet Thread.yield(); //ä»£ç 4 else if (q == null) q = new WaitNode(); //ä»£ç 5 else if (!queued) queued = UNSAFE.compareAndSwapObject(this, waitersOffset, q.next = waiters, q); //ä»£ç 6 else if (timed) { nanos = deadline - System.nanoTime(); if (nanos &lt;= 0L) { removeWaiter(q); return state; } LockSupport.parkNanos(this, nanos); } else LockSupport.park(this); }} æ–¹æ³•çš„å‚æ•°ä¸º timed(æ˜¯å¦å¼€å¯è¶…æ—¶æ—¶é—´)å’Œnanos(è‹¥å¼€å¯è¶…æ—¶æ—¶é—´ï¼Œåˆ™æ­¤å‚æ•°ä¸ºè¶…æ—¶æ—¶é—´)ï¼ˆä»£ç 1åˆ°ä»£ç 6åœ¨ä¸€ä¸ªæ— é™forå¾ªç¯ä¸­ï¼Œä¸åœçš„è¿›è¡Œå¾ªç¯åˆ¤æ–­ï¼‰ ä»£ç 1ï¼šå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™å°†é˜»å¡é˜Ÿåˆ—waitNodeä¸­çš„è¯¥èŠ‚ç‚¹ç»™ç§»é™¤ï¼Œå¹¶æŠ›å‡ºInterruptedException()å¼‚å¸¸ã€‚ä»£ç 2ï¼šåˆ¤æ–­å½“å‰é˜»å¡çº¿ç¨‹çš„çŠ¶æ€æ˜¯å¦å¤§äºCOMPLETINGï¼Œå¦‚æœå¤§äºï¼Œåˆ™è¯¥ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹éç©ºï¼Œåˆ™åˆ é™¤è¯¥èŠ‚ç‚¹çš„threadï¼Œå¹¶è¿”å›çŠ¶æ€ã€‚ä»£ç 3ï¼š å¦‚æœå½“å‰çŠ¶æ€ä¸ºCOMPLETINGï¼Œåˆ™è¯´æ˜ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯æ‰§è¡Œç»“æœå°šæœªèµ‹å€¼ç»™outcomeï¼Œæ­¤æ—¶æ‰§è¡Œyieldè®©å‡ºCPUã€‚ä»£ç 4ï¼šå¦‚æœå½“å‰é˜»å¡ç­‰å¾…èŠ‚ç‚¹qä¸ºç©ºï¼Œåˆ™æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ã€‚ä»£ç 5ï¼šå¦‚æœå°šæœªå…¥é˜Ÿåˆ—ï¼Œåˆ™å°†ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„nextæŒ‡å‘waitersï¼Œç„¶åå°è¯•è®©æ–°çš„èŠ‚ç‚¹qæ›¿æ¢waitersï¼Œå¦‚æœå°è¯•æˆåŠŸåˆ™queuedä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseã€‚ä»£ç 6ï¼šå¦‚æœå¼€å¯äº†è¶…æ—¶é™åˆ¶ï¼Œåˆ™é‡æ–°è®¡ç®—ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœ nanos&lt;=0Lï¼Œå³è¶…æ—¶äº†ï¼Œåˆ™ç§»é™¤ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯¥èŠ‚ç‚¹ï¼Œå¹¶è¿”å›å½“å‰stateï¼›å¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œåˆ™ç»§ç»­é˜»å¡é‡æ–°è®¡ç®—åçš„æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰å¼€å¯è¶…æ—¶é™åˆ¶ï¼Œåˆ™ç›´æ¥é˜»å¡ç­‰å¾…ç›´åˆ°è¢«å”¤é†’ã€‚ 3.4.4 cancel()1234567891011121314151617181920212223public boolean cancel(boolean mayInterruptIfRunning) { //ä»£ç 1 if (!(state == NEW &amp;&amp; UNSAFE.compareAndSwapInt(this, stateOffset, NEW, mayInterruptIfRunning ? INTERRUPTING : CANCELLED))) return false; try { //ä»£ç 2 if (mayInterruptIfRunning) { try { Thread t = runner; if (t != null) t.interrupt(); } finally { // final state UNSAFE.putOrderedInt(this, stateOffset, INTERRUPTED); } } } finally { //ä»£ç 3 finishCompletion(); } return true; } ä»£ç 1ï¼š1.å¦‚æœstateä¸ç­‰äºNEWï¼Œåˆ™ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•æˆ–å‡ºç°å¼‚å¸¸æˆ–è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›falseï¼›2.å¦‚æœä»»åŠ¡å°šæœªå¼€å§‹ï¼Œåˆ™é€šè¿‡CASå°è¯•å°†çŠ¶æ€ä»NEWæ”¹ä¸ºmayInterruptIfRunningï¼Œè‹¥mayInterruptIfRunningä¸ºtrueï¼Œä»£è¡¨éœ€è¦ä¸­æ–­ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ï¼Œåˆ™æ”¹ä¸ºINTERRUPTINGä¸­é—´çŠ¶æ€ï¼Œå¦åˆ™æ”¹ä¸ºCANCELLEDæœ€ç»ˆçŠ¶æ€ï¼Œå¦‚æœå°è¯•æ›´æ–°æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ä»£ç 2ï¼šå¦‚æœè¿›è¡Œäº†ä¸­æ–­ï¼Œåˆ™è·å–å½“å‰çš„çº¿ç¨‹runnerï¼Œä¸­æ–­ä¹‹ã€‚æœ€åå°†çŠ¶æ€ç”±INTERRUPTINGæ”¹ä¸ºINTERRUPTEDä»£ç 3ï¼šæ‰§è¡ŒfinishCompltion()(ä»»åŠ¡å‡ºç°å¼‚å¸¸æˆ–æ­£å¸¸æ‰§è¡Œå®Œæ¯•æˆ–æˆåŠŸå–æ¶ˆä»»åŠ¡éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¸Šæ–‡å·²æåˆ°)ï¼Œè¿”å›true 3.4.5 isCancelled()123public boolean isCancelled() { return state &gt;= CANCELLED; } åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆã€‚åªè¦çŠ¶æ€å¤§äºç­‰äºCANCELLEDéƒ½è¿”å›trueã€‚ 3.4.6 isDone()123public boolean isDone() { return state != NEW; } åªè¦ä¸æ˜¯NEWï¼Œéƒ½è¿”å›trueï¼Œä»£è¡¨ä»»åŠ¡å·²å®Œæˆã€‚ å››.Callable+Futureç¤ºä¾‹12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package com.wml.test2.future;import java.util.concurrent.*;/** * @author MaoLin Wang * @date 2020/1/2723:18 */public class FutureDemo { public static class Task implements Callable&lt;Integer&gt;{ private int sum; @Override public Integer call() throws Exception { System.out.println(\"Callableçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡\"); Thread.sleep(1500); for (int i = 0; i &lt; 50; i++) { if (Thread.currentThread().isInterrupted()){ System.out.println(\"Callableçº¿ç¨‹è®¡ç®—ä»»åŠ¡ä¸­æ–­\"); return null; } if (i%2==0){ sum=sum+i; System.out.println(\"sum=\"+sum); } } System.out.println(\"Callableçº¿ç¨‹æ‰§è¡Œå®Œæ¯• è®¡ç®—ç»“æœä¸º\"+sum); return sum; } } public static void main(String[] args) { Task task=new Task(); ExecutorService pool = new ThreadPoolExecutor(6,100,0L,TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); Future&lt;Integer&gt;future=pool.submit(task); pool.shutdown(); try { Thread.sleep(3000L); System.out.println(\"ä¸»çº¿ç¨‹æ‰§è¡Œå…¶ä»–ä»»åŠ¡ä¸­.....\"); if (future.get()!=null){ System.out.println(\"ä¸»çº¿ç¨‹è·å–Callableæ‰§è¡Œç»“æœ:\"+future.get()); }else { System.out.println(\"å°šæœªè·å–åˆ°ç»“æœ\"); } } catch (InterruptedException e) { e.printStackTrace(); } catch (ExecutionException e) { e.printStackTrace(); } }} ç»“æœï¼š 1234567891011121314151617181920212223242526272829Callableçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡sum=0sum=2sum=6sum=12sum=20sum=30sum=42sum=56sum=72sum=90sum=110sum=132sum=156sum=182sum=210sum=240sum=272sum=306sum=342sum=380sum=420sum=462sum=506sum=552sum=600Callableçº¿ç¨‹æ‰§è¡Œå®Œæ¯• è®¡ç®—ç»“æœä¸º600ä¸»çº¿ç¨‹æ‰§è¡Œå…¶ä»–ä»»åŠ¡ä¸­.....ä¸»çº¿ç¨‹è·å–Callableæ‰§è¡Œç»“æœ:600 äº”ã€Callable+FutureTaskç¤ºä¾‹Taskç±»åŒä¸Š 12345678910111213141516171819202122public static void main(String[] args) { ExecutorService pool = new ThreadPoolExecutor(6,100,0L, TimeUnit.MILLISECONDS, new LinkedBlockingDeque&lt;&gt;()); Task task=new Task(); //åˆ›å»ºFutureTaskä»»åŠ¡ FutureTask futureTask=new FutureTask(task); pool.submit(futureTask); pool.shutdown(); try { Thread.sleep(3000L); System.out.println(\"ä¸»çº¿ç¨‹æ‰§è¡Œå…¶ä»–ä»»åŠ¡ä¸­.....\"); if (futureTask.get()!=null){ System.out.println(\"ä¸»çº¿ç¨‹è·å–Callableæ‰§è¡Œç»“æœ:\"+futureTask.get()); }else { System.out.println(\"å°šæœªè·å–åˆ°ç»“æœ\"); } } catch (InterruptedException e) { e.printStackTrace(); } catch (ExecutionException e) { e.printStackTrace(); } } ç»“æœï¼š 1234567891011Callableå­çº¿ç¨‹å¼€å§‹è®¡ç®—ï¼sum=0sum=1sum=3sum=6sum=10sum=15sum=21Cancel................. sum=28Callableå­çº¿ç¨‹è®¡ç®—ä»»åŠ¡ä¸­æ–­ï¼","link":"/posts/20200127-runcalfutask.html"},{"title":"javaå¤šçº¿ç¨‹ä¹‹CASæ“ä½œåŠç›¸å…³åŸå­æ“ä½œç±»è¯¦è§£","text":"ä¸€ã€åŸå­æ“ä½œæ˜¯ä»€ä¹ˆåŸå­æ“ä½œå³ä¸å¯è¢«ä¸­æ–­ï¼ˆåˆ†å‰²ï¼‰çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œï¼Œå¦‚å¯¹äºA,Bä¸¤ä¸ªæ“ä½œï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ“ä½œAï¼Œè‹¥å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒBæ“ä½œæ—¶ï¼Œè¦ä¹ˆå°†Bæ‰§è¡Œåˆ°ç»“æŸï¼Œè¦ä¹ˆå®Œå…¨ä¸è®©Bæ‰§è¡Œï¼Œæ­¤æ—¶å¯¹äºAå’ŒBæ¥è¯´ï¼Œå°±æ˜¯åŸå­çš„ã€‚ äºŒã€æ‚²è§‚é”å’Œä¹è§‚é”å¦‚synchronizedå°±æ˜¯æ‚²è§‚é”ï¼Œè§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼Œä»¥ä¿è¯äº‹åŠ¡çš„å®Œæ•´æ€§ã€‚å…¶æ˜¯åŸºäºé˜»å¡çš„é”æœºåˆ¶ï¼Œå¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰é”åï¼Œè®¿é—®è¯¥èµ„æºçš„å…¶ä»–çº¿ç¨‹å°±éœ€è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°è·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚CASæ“ä½œå³æ˜¯ä¹è§‚é”ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œåªæœ‰åœ¨æäº¤æ•°æ®çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦è¿åäº†æ•°æ®çš„å®Œæ•´æ€§ï¼Œå³æ¯æ¬¡éƒ½å°è¯•å»å®ŒæˆæŸä¸ªæ“ä½œï¼Œå¦‚æœå†²çªå’Œé€ æˆæ“ä½œå¤±è´¥ï¼Œå°±å¾ªç¯é‡è¯•ï¼Œç›´åˆ°æ“ä½œæˆåŠŸä¸ºæ­¢ã€‚ ä½¿ç”¨synchronizedä¼šå¼•å‡ºå¾ˆå¤šé—®é¢˜ï¼Œå¦‚ï¼šè·å¾—é”çš„çº¿ç¨‹ä¸€ç›´ä¸é‡Šæ”¾é”ï¼›å¤§é‡çº¿ç¨‹ç«äº‰èµ„æºï¼Œå¯èƒ½ä¼šé€ æˆæ­»é”ï¼›è¢«é˜»å¡çš„çº¿ç¨‹å¯èƒ½ä¼˜å…ˆçº§å¾ˆé«˜å´ä¸€ç›´æ— æ³•è·å–é”ã€‚ å› æ­¤å®ç°åŸå­æ“ä½œå¯ä½¿ç”¨CASæŒ‡ä»¤ã€‚ ä¸‰ã€CASCAS å³Compare and Swapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ã€‚æ¯ä¸ªCASæ“ä½œè¿‡ç¨‹éƒ½åŒ…æ‹¬ä¸‰ä¸ªè¿ç®—ç¬¦ï¼šå†…å­˜åœ°å€Vã€æœŸæœ›å€¼Aã€æ–°çš„å€¼Bå¦‚æœæ“ä½œçš„æ—¶å€™åœ°å€Vä¸Šçš„å€¼ç­‰äºæœŸæœ›çš„å€¼Aï¼Œåˆ™å°†åœ°å€Vä¸Šçš„å€¼æ›´æ–°ä¸ºBï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œï¼Œä½†è¦è¿”å›åŸå€¼ã€‚å¾ªç¯CASå°±æ˜¯ä¸æ–­çš„è¿›è¡ŒCASæ“ä½œç›´åˆ°æ“ä½œæˆåŠŸã€‚å¯é˜²æ­¢å†…å­˜ä¸­å…±äº«å˜é‡å‡ºç°è„è¯»è„å†™çš„é—®é¢˜ã€‚CASæ˜¯é€šè¿‡ç¡¬ä»¶CPUå’Œå†…å­˜ï¼Œåˆ©ç”¨CPUçš„å¤šå¤„ç†èƒ½åŠ›å®ç°ç¡¬ä»¶å±‚é¢çš„é˜»å¡ï¼Œå†åŠ ä¸Švolatileå˜é‡çš„ç‰¹æ€§æ¥å®ç°åŸºäºåŸå­æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚ ï¼ˆ1ï¼‰getå˜é‡å€¼(æ—§å€¼)â€”â€“&gt;ï¼ˆ2ï¼‰è®¡ç®—åå¾—åˆ°æ–°å€¼â€”â€”&gt;ï¼ˆ3ï¼‰æ¯”è¾ƒå†…å­˜ä¸­å˜é‡å€¼å’Œæ—§å€¼â€”â€“&gt;ï¼ˆ4ï¼‰å¦‚æœï¼ˆ3ï¼‰ç›¸ç­‰ï¼Œåˆ™è®©æ–°å€¼æ›¿æ¢æ—§å€¼ï¼Œå¦åˆ™ç»§ç»­ï¼ˆ1ï¼‰ å››ã€CASå®ç°åŸå­æ“ä½œçš„ä¸‰å¤§é—®é¢˜4.1ABAé—®é¢˜ç”±äºCASåœ¨æ“ä½œå€¼çš„æ—¶å€™éœ€è¦æ£€æŸ¥æ—§å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæœªå˜åŒ–åˆ™æ›´æ–°å€¼ï¼Œä½†å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œç„¶ååˆå˜ä¸ºäº†Aï¼Œè¿™æ ·è™½ç„¶å€¼å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†ä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„æ—§å€¼â€œæœªå˜åŒ–â€ã€‚è€Œè¦è§£å†³è¯¥é—®é¢˜ï¼Œå°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚å³ç»™å˜é‡æ·»åŠ ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ›´æ–°å˜é‡éƒ½å»æ›´æ–°å®ƒçš„ç‰ˆæœ¬å·ï¼Œå¦‚åˆšåˆšA-&gt;B-&gt;Aï¼Œä¾¿å˜æˆäº† 1A-&gt;2B-&gt;3Aã€‚å°±åƒåœ¨å®¶é‡Œå€’äº†ä¸€æ¯æ°´ï¼Œä½ è¿˜æ²¡æ¥å¾—åŠå–ï¼Œä½†æ˜¯è¢«å®¶äººå–æ‰ï¼Œ ç„¶ååˆç»™ä½ æ¥æ»¡äº†ä¸€æ¯æ°´ï¼Œè¿™æ ·å¦‚æœåœ¨ä¸çŸ¥é“çš„æƒ…å†µä¸‹ï¼Œä½ ä¼šè®¤ä¸ºè¿™ä»ç„¶æ˜¯ä¹‹å‰é‚£æ¯æ°´ã€‚åˆæˆ–è€…ä½ çš„èµ„é‡‘è¢«åˆ«äººæŒªç”¨äº†ï¼Œç„¶ååˆè¿˜ç»™äº†ä½ ï¼Œè™½ç„¶é’±æ²¡æœ‰å˜ï¼Œä½†é€ æˆçš„é—®é¢˜æ—¶é‚£ä¸ªäººå·²ç»çŠ¯ç½ªäº†ã€‚ 4.2å¾ªç¯æ—¶é—´é•¿ï¼Œå¼€é”€å¤§å¦‚æœCASä¸€ç›´å¤„äºè‡ªæ—‹ä¸æˆåŠŸçŠ¶æ€ï¼ŒCPUçš„å¼€é”€ä¼šå¤§å¤§å¢åŠ ã€‚ 4.3åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œå½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå¯ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œå½“ç„¶å¯ä»¥ç”¨é”ã€‚ä¹Ÿå¯ä»¥æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚å¦‚ï¼Œæœ‰ä¸¤ä¸ªå…±äº«å˜é‡ iï¼aï¼Œj=bï¼Œåˆå¹¶ä¸€ä¸‹ ij=abï¼Œç„¶åç”¨ CAS æ¥æ“ä½œ ijï¼Œç„¶åé€šè¿‡AtomicReference ç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œä¾¿å®ç°äº†å¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡Œ CAS æ“ä½œã€‚ äº”ã€JDKä¸­ç›¸å…³åŸå­æ“ä½œç±»çš„ä½¿ç”¨5.1æ¦‚è§ˆæ›´æ–°åŸºæœ¬ç±»å‹ç±»ï¼šAtomicBooleanï¼ŒAtomicIntegerï¼ŒAtomicLongæ›´æ–°æ•°ç»„ç±»ï¼šAtomicIntegerArrayï¼ŒAtomicLongArrayï¼ŒAtomicReferenceArrayæ›´æ–°å¼•ç”¨ç±»å‹ï¼šAtomicReferenceï¼ŒAtomicMarkableReferenceï¼ŒAtomicStampedReferenceåŸå­æ›´æ–°å­—æ®µç±»ï¼š AtomicReferenceFieldUpdaterï¼ŒAtomicIntegerFieldUpdaterï¼ŒAtomicLongFieldUpdater åŸºæœ¬æ•°æ®ç±»å‹çš„åŸå­æ“ä½œç±»ä»¥AtomicIntegerä¸ºä¾‹ï¼Œå…¶ä½™å·®ä¸å¤šã€‚ 5.2 AtomicIntegerå¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112public class AtomicInteger extends Number implements java.io.Serializable { private static final long serialVersionUID = 6214790243416807050L; //è·å–æŒ‡é’ˆç±»Unsafe private static final Unsafe unsafe = Unsafe.getUnsafe(); //å†…å­˜åç§»é‡ private static final long valueOffset; static { try { //é€šè¿‡objectFieldOffset()æ–¹æ³•ï¼Œè·å–å¯¹è±¡å±æ€§çš„åç§»é‡ valueOffset = unsafe.objectFieldOffset (AtomicInteger.class.getDeclaredField(\"value\")); } catch (Exception ex) { throw new Error(ex); } } //å½“å‰çš„å˜é‡å€¼ private volatile int value; public AtomicInteger(int initialValue) { //åˆå§‹åŒ–å˜é‡å€¼ value = initialValue; } //valueåˆå§‹åŒ–ä¸º0 public AtomicInteger() { } //è¿”å›å½“å‰å€¼ public final int get() { return value; } //è®¾ç½®å½“å‰å€¼ public final void set(int newValue) { value = newValue; } //æ‡’è®¾ç½®ï¼Œä½¿ç”¨Unsafe.putOrderedObjectæ–¹æ³•å®ç°ï¼Œå®ç°éå µå¡çš„å†™å…¥ï¼Œæœ€ç»ˆä¼šå°†valueç½®ä¸ºnewValueã€‚ //è¯¥æ–¹æ³•å¯èƒ½å‡ºç°å…¶ä»–çº¿ç¨‹åœ¨æœªæ¥å¾ˆå°çš„ä¸€æ®µæ—¶é—´å†…æ— æ³•è·å–åˆ°æ–°å€¼ï¼Œä½†å¯è·å–åˆ°æ—§å€¼ public final void lazySet(int newValue) { unsafe.putOrderedInt(this, valueOffset, newValue); } //ä»¥åŸå­æ–¹å¼è®¾ç½®ä¸ºç»™å®šå€¼å¹¶è¿”å›æ—§å€¼ã€‚ public final int getAndSet(int newValue) { return unsafe.getAndSetInt(this, valueOffset, newValue); } //ä»¥ä¸‹æ˜¯getAndSetIntæºç ï¼Œé€šè¿‡whileå¾ªç¯é‡è¯•æ›´æ–°å€¼ï¼Œç›´åˆ°æˆåŠŸï¼Œä¹Ÿæ˜¯é€šè¿‡CASå®ç°(JDK8ç‰ˆæœ¬) /*public final int getAndSetInt(Object var1, long var2, int var4) { int var5; do { var5 = this.getIntVolatile(var1, var2); } while(!this.compareAndSwapInt(var1, var2, var5, var4)); return var5; }*/ //åŸå­æ›´æ–°valueï¼Œå¦‚æœå½“å‰å€¼ç­‰äºexpectï¼Œåˆ™è®¾ç½®ä¸ºupdate public final boolean compareAndSet(int expect, int update) { return unsafe.compareAndSwapInt(this, valueOffset, expect, update); } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼å¢åŠ ä¸€ //è¿”å›æ—§å€¼ï¼Œåº•å±‚åŒgetAndSetIntä¸€æ ·ä½¿ç”¨CASæ“ä½œ public final int getAndIncrement() { return unsafe.getAndAddInt(this, valueOffset, 1); } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼å‡ä¸€ //è¿”å›æ—§å€¼ï¼ŒCASæ“ä½œ public final int getAndDecrement() { return unsafe.getAndAddInt(this, valueOffset, -1); } //ä»¥åŸå­æ–¹å¼å°†ç»™å®šå€¼deltaæ·»åŠ åˆ°å½“å‰å€¼ //è¿”å›æ—§å€¼ï¼ŒCASæ“ä½œ public final int getAndAdd(int delta) { return unsafe.getAndAddInt(this, valueOffset, delta); } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ 1ï¼Œè¿”å›æ–°å€¼ public final int incrementAndGet() { return unsafe.getAndAddInt(this, valueOffset, 1) + 1; } //å½“å‰å€¼å‡1ï¼Œè¿”å›æ–°å€¼ public final int decrementAndGet() { return unsafe.getAndAddInt(this, valueOffset, -1) - 1; } //ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼å¢åŠ deltaï¼Œè¿”å›æ–°å€¼ public final int addAndGet(int delta) { return unsafe.getAndAddInt(this, valueOffset, delta) + delta; } //ä½¿ç”¨ç»™å®šå‡½æ•°çš„ç»“æœä»¥åŸå­æ–¹å¼æ›´æ–°å½“å‰å€¼ï¼Œè¿”å›æ›´æ–°åçš„å€¼ã€‚ç»™çš„å‡½æ•°æ˜¯æ— å‰¯ä½œç”¨çš„ï¼Œå› ä¸ºå½“å°è¯•æ›´æ–°ç”±äºçº¿ç¨‹ä¹‹é—´çš„äº‰ç”¨è€Œå¤±è´¥æ—¶ï¼Œå®ƒå¯èƒ½ä¼šé‡æ–°åº”ç”¨ public final int updateAndGet(IntUnaryOperator updateFunction) { int prev, next; do { prev = get(); next = updateFunction.applyAsInt(prev); } while (!compareAndSet(prev, next)); return next; } //åŒä¸Šï¼Œä½¿ç”¨ç»™å®šå‡½æ•°çš„ç»“æœä»¥åŸå­æ–¹å¼æ›´æ–°å½“å‰å€¼ï¼Œè¿”å›æ›´æ–°å‰çš„å€¼ã€‚åº”ç”¨è¯¥å‡½æ•°æ—¶ï¼Œå°†å½“å‰å€¼ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¹¶å°†ç»™å®šçš„updateä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚ public final int getAndAccumulate(int x, IntBinaryOperator accumulatorFunction) { int prev, next; do { prev = get(); next = accumulatorFunction.applyAsInt(prev, x); } while (!compareAndSet(prev, next)); return prev; } //åŒgetAndAccumulateï¼Œä½†è¿”å›æ›´æ–°åçš„å€¼ public final int accumulateAndGet(int x, IntBinaryOperator accumulatorFunction) { int prev, next; do { prev = get(); next = accumulatorFunction.applyAsInt(prev, x); } while (!compareAndSet(prev, next)); return next; }} ä½¿ç”¨æ¼”ç¤ºï¼š 123456789101112131415161718192021222324252627public class UseAtomicInt { static AtomicInteger atomicInteger = new AtomicInteger(10); public static void main(String[] args) { //è¿”å›æ—§å€¼10 System.out.println(atomicInteger.getAndIncrement()); //è¿”å›æ–°å€¼12 System.out.println(atomicInteger.incrementAndGet()); atomicInteger.compareAndSet(12,1); //åŠ 24 è¿”å›25 System.out.println(atomicInteger.addAndGet(24)); //è‡ªå®šä¹‰å‡½æ•° IntBinarOperImpl intBinarOper=new IntBinarOperImpl(); //ä¼ å…¥è‡ªå®šä¹‰å‡½æ•°ï¼Œä¼ å…¥æ›´æ–°å€¼ atomicInteger.accumulateAndGet(1, intBinarOper); //è¿”å›26 System.out.println(atomicInteger.get()); }}//è‡ªå®šä¹‰å‡½æ•°ï¼Œå®ç°IntBinaryOperatoræ¥å£public class IntBinarOperImpl implements IntBinaryOperator { @Override public int applyAsInt(int left, int right) { //ç®€å•å®šä¹‰åŸæ¥çš„æ•°åŠ ä¸Šè¦æ›´æ–°çš„æ•° return left+right; }} 5.3 AtomicIntegerArrayæ˜¯æä¾›åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æ•´å‹ï¼Œè¿˜åŒ…æ‹¬é«˜çº§åŸå­æ“ä½œã€‚å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384public class AtomicIntegerArray implements java.io.Serializable { private static final long serialVersionUID = 2862133569453604235L; //åŒä¸Š private static final Unsafe unsafe = Unsafe.getUnsafe(); //è·å–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€ private static final int base = unsafe.arrayBaseOffset(int[].class); //å­˜å‚¨ç§»ä½ä¸ªæ•° private static final int shift; //ä¿å­˜çš„æ•°ç»„ private final int[] array; static { //è·å–è¯¥ç±»å‹çš„æ•°ç»„ä¸­å…ƒç´ çš„å¤§å°(å­—èŠ‚)ã€‚ int scale = unsafe.arrayIndexScale(int[].class); //scaleå¦‚æœä¸æ˜¯2çš„æ¬¡å¹‚åˆ™æŠ›å‡ºå¼‚å¸¸ if ((scale &amp; (scale - 1)) != 0) throw new Error(\"data type scale not a power of two\"); //è®¡ç®—å¾—åˆ°éœ€è¦ç§»ä½çš„ä¸ªæ•°ï¼Œå³scaleçš„æ¬¡å¹‚æ•° shift = 31 - Integer.numberOfLeadingZeros(scale); } //è¿”å›ç¬¬iä¸ªå…ƒç´ çš„åœ°å€ private static long byteOffset(int i) { //shiftä¸ºåç§»ä½æ•°ï¼Œbaseä¸ºç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ï¼Œiç§»shiftä¸ªä½å+åŸºä½ç½®å¾—åˆ°ç¬¬iä¸ªå…ƒç´ ä½ç½® return ((long) i &lt;&lt; shift) + base; } //å…ˆæ£€æµ‹iæ˜¯å¦è¶Šç•Œï¼Œå†è°ƒç”¨byteOffset(i)è¿”å› private long checkedByteOffset(int i) { if (i &lt; 0 || i &gt;= array.length) throw new IndexOutOfBoundsException(\"index \" + i); return byteOffset(i); } //æ„é€ åˆå§‹åŒ–ç»™å®šé•¿åº¦æ•°ç»„ public AtomicIntegerArray(int length) { array = new int[length]; } //åˆ›å»ºä¸€ä¸ªæ–°AtomicIntegerArrayï¼Œå…¶é•¿åº¦ä¸ä¼ å…¥æ•°ç»„ç›¸åŒï¼Œå¹¶ä»ç»™å®šæ•°ç»„ä¸­å¤åˆ¶æ‰€æœ‰å…ƒç´ ã€‚æ‰€ä»¥å½“ AtomicIntegerArray å¯¹å†…éƒ¨çš„æ•°ç»„å…ƒç´ è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¸ä¼šå½±å“ä¼ å…¥çš„æ•°ç»„ã€‚ public AtomicIntegerArray(int[] array) { this.array = array.clone(); } //è¿”å›å½“å‰ä½ç½®çš„å…ƒç´  public final int get(int i) { //è°ƒç”¨checkedByteOffsetè·å–å½“å‰ä½ç½®çš„å…ƒç´ åœ°å€ return getRaw(checkedByteOffset(i)); } //getIntVolatileæ–¹æ³•è·å–æ•°ç»„ä¸­offsetåç§»åœ°å€å¯¹åº”çš„æ•´å‹fieldçš„å€¼,æ”¯æŒvolatile loadè¯­ä¹‰ã€‚è¿”å›è¯¥å€¼ã€‚ private int getRaw(long offset) { return unsafe.getIntVolatile(array, offset); } //æ›´æ–°ç¬¬iä¸ªä½ç½®çš„å€¼ï¼Œä¹Ÿéœ€å…ˆè®¡ç®—å½“å‰ä½ç½®çš„å…ƒç´ çš„offset public final void set(int i, int newValue) { unsafe.putIntVolatile(array, checkedByteOffset(i), newValue); } //åŒAtomicIntegerçš„lazySet,è¿™é‡Œæ›´æ–°ç¬¬iä¸ªä½ç½®çš„å…ƒç´  public final void lazySet(int i, int newValue) { unsafe.putOrderedInt(array, checkedByteOffset(i), newValue); } public final int getAndSet(int i, int newValue) { return unsafe.getAndSetInt(array, checkedByteOffset(i), newValue); } //å¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†æ•°ç»„ä½ç½® i çš„å…ƒç´ è®¾ç½®æˆ update å€¼ã€‚ public final boolean compareAndSet(int i, int expect, int update) { return compareAndSetRaw(checkedByteOffset(i), expect, update); } private boolean compareAndSetRaw(long offset, int expect, int update) { return unsafe.compareAndSwapInt(array, offset, expect, update); } //åŸå­çš„æ–¹å¼è®©ç¬¬iä¸ªå…ƒç´ åŠ 1 public final int getAndIncrement(int i) { return getAndAdd(i, 1); } //åŸå­çš„æ–¹å¼è®©ç¬¬iä¸ªå…ƒç´ å‡1 public final int getAndDecrement(int i) { return getAndAdd(i, -1); } //åŸå­çš„æ–¹å¼è®©ç¬¬iä¸ªå…ƒç´ åŠ delta public final int getAndAdd(int i, int delta) { return unsafe.getAndAddInt(array, checkedByteOffset(i), delta); } //è¿˜æœ‰å…¶ä»–ä¸€äº›æ–¹æ³•éƒ½å’ŒIntegeråŸå­ç±»åŸºæœ¬ä¸€æ · ç®€å•ä½¿ç”¨ï¼š 123456789101112131415161718192021public class AtomicArray { static int[] value = new int[] { 1, 2,3 }; static AtomicIntegerArray atomicIntegerArray = new AtomicIntegerArray(value); public static void main(String[] args) { //è¿”å›ç¬¬ä¸€ä¸ªä½ç½®çš„å…ƒç´  2 System.out.println(atomicIntegerArray.get(1)); //æ›´æ–°ç¬¬1ä¸ªä½ç½®çš„å…ƒç´  atomicIntegerArray.set(1,4); //è¿”å›4 System.out.println(atomicIntegerArray.get(1)); //è®¾ç½®ç¬¬0ä¸ªä½ç½®ä¸º3ï¼Œè¿”å›æ›´æ–°å‰çš„å€¼ 1 System.out.println( atomicIntegerArray.getAndSet(0, 3)); //è¿”å›æ›´æ–°åçš„3 System.out.println(atomicIntegerArray.get(0)); //è¿”å›1ï¼ŒåŸæ•°ç»„ä¸ä¼šå˜åŒ– System.out.println(value[0]); atomicIntegerArray.compareAndSet(0,3,4); System.out.println(atomicIntegerArray.get(0)); }} 5.4 æ›´æ–°å¼•ç”¨ç±»å‹åŸå­æ›´æ–°åŸºæœ¬ç±»å‹çš„ AtomicIntegerï¼Œåªèƒ½æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœè¦åŸå­æ›´æ–°å¤šä¸ªå˜é‡ï¼Œå°±éœ€è¦ä½¿ç”¨è¿™ä¸ªåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æä¾›çš„ç±»ã€‚Atomic åŒ…æä¾›äº†ä»¥ä¸‹ 3ç±»ã€‚AtomicReferenceï¼ŒAtomicStampedReferenceï¼ŒAtomicMarkableReference 5.5 AtomicReferenceæ–¹æ³•åŒå‰é¢å‡ ä¸ªç±»åŸºæœ¬ä¸€æ ·ï¼Œä½†æ”¯æŒæ³›å‹ï¼Œå¯ä¼ å…¥å¯¹è±¡,æ”¯æŒå¯¹å¯¹è±¡çš„åŸå­æ“ä½œã€‚ 5.6 AtomicStampedReferenceå’ŒAtomicMarkableReferenceAtomicStampedReference ä½¿ç”¨ç‰ˆæœ¬æˆ³çš„è®°å½•æ¯æ¬¡æ”¹å˜åçš„ç‰ˆæœ¬å·ï¼Œè¿™æ ·çš„è¯å°±ä¸ä¼šå­˜åœ¨ ABAé—®é¢˜äº†ã€‚AtomicMarkableReferenceè·Ÿ AtomicStampedReference åŸºæœ¬ç›¸åŒï¼ŒAtomicStampedReference åœ¨Pairç±» ä¸­ä½¿ç”¨ intç±»å‹çš„stamp ä½œä¸ºè®¡æ•°å™¨ï¼Œæ¯æ¬¡æ“ä½œéƒ½æ›´æ–°ç‰ˆæœ¬ï¼Œå…³æ³¨çš„çš„æ˜¯åŠ¨è¿‡å‡ æ¬¡ã€‚AtomicMarkableReference åœ¨ Pairç±» ä½¿ç”¨çš„æ˜¯ boolean ç±»å‹çš„markï¼Œå…³æ³¨çš„çš„æ˜¯æœ‰æ²¡æœ‰è¢«åŠ¨è¿‡ã€‚ AtomicStampedReferenceæºç å¦‚ä¸‹ï¼š é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªPairå†…éƒ¨ç±»ï¼š 1234567891011private static class Pair&lt;T&gt; { final T reference; final int stamp; private Pair(T reference, int stamp) { this.reference = reference; this.stamp = stamp; } static &lt;T&gt; Pair&lt;T&gt; of(T reference, int stamp) { return new Pair&lt;T&gt;(reference, stamp); } } è¯¥ç±»å°†å…ƒç´ çš„å€¼(reference)å’Œç‰ˆæœ¬å·(stamp)éƒ½ç»´æŠ¤åœ¨è‡ªå·±èº«ä¸Šã€‚ æˆå‘˜å˜é‡ 12345678910111213141516171819//å£°æ˜Pairç±»å‹å˜é‡private volatile Pair&lt;V&gt; pair;//è·å–Unsafeprivate static final sun.misc.Unsafe UNSAFE = sun.misc.Unsafe.getUnsafe();//ä½¿ç”¨unsafeè·å–åç§»é‡ä¿å­˜åˆ°pairOffsetprivate static final long pairOffset = objectFieldOffset(UNSAFE, \"pair\", AtomicStampedReference.class); static long objectFieldOffset(sun.misc.Unsafe UNSAFE, String field, Class&lt;?&gt; klazz) { try { return UNSAFE.objectFieldOffset(klazz.getDeclaredField(field)); } catch (NoSuchFieldException e) { // Convert Exception to corresponding Error NoSuchFieldError error = new NoSuchFieldError(field); error.initCause(e); throw error; //åé¢ä¸¤ä¸ªæ”¾åœ¨æºç çš„æœ€åï¼Œä¸å¤ªå¥½æ‰¾ æ„é€ æ–¹æ³• 123public AtomicStampedReference(V initialRef, int initialStamp) { pair = Pair.of(initialRef, initialStamp); } ä¼ å…¥åˆå§‹å€¼å’Œåˆå€¼ç‰ˆæœ¬æˆ³ä¿å­˜åˆ°pairã€‚ æ–¹æ³• 4.1. getReference()å’ŒgetStamp()ï¼šè¿”å›å…ƒç´ å€¼å’Œè¿”å›ç‰ˆæœ¬æˆ³ 123456public V getReference() { return pair.reference; } public int getStamp() { return pair.stamp; } 4.2 get() 123456//è¿”å›å½“å‰å…ƒç´ çš„å€¼ï¼Œå¹¶å°†å½“å‰å…ƒç´ çš„ç‰ˆæœ¬å·ä¿å­˜åˆ°ä¼ å…¥çš„æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®public V get(int[] stampHolder) { Pair&lt;V&gt; pair = this.pair; stampHolder[0] = pair.stamp; return pair.reference; } 4.3 casPair() 12345//cmp:æœŸæœ›çš„pair,valï¼šæ–°çš„pair//CASæ›´æ–°å½“å‰çš„pairprivate boolean casPair(Pair&lt;V&gt; cmp, Pair&lt;V&gt; val) { return UNSAFE.compareAndSwapObject(this, pairOffset, cmp, val); } 4.4 compareAndSet() è¯¥æ–¹æ³•é¦–å…ˆåˆ¤æ–­æœŸæœ›çš„å€¼å’Œç‰ˆæœ¬æˆ³æ˜¯å¦å’Œå½“å‰çš„å€¼å’Œç‰ˆæœ¬æˆ³ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒåˆ™ç›´æ¥è¿”å›falseï¼Œå¦‚æœç›¸åŒåˆ™ç»§ç»­æ¯”è¾ƒæ–°çš„å€¼å’Œç‰ˆæœ¬æˆ³æ˜¯å¦å’Œå½“å‰å€¼ç›¸åŒï¼Œå¦‚æœç›¸åŒåˆ™ç›´æ¥è¿”å›trueï¼Œå¦åˆ™å¯¹å½“å‰çš„pairè¿›è¡ŒCASæ“ä½œã€‚ 12345678910111213141516171819/** * åŸå­çš„ä¿®æ”¹å…ƒç´ çš„å€¼å’Œç‰ˆæœ¬æˆ³ * @param æœŸæœ›å€¼ * @param æ–°å€¼ * @param æœŸæœ›ç‰ˆæœ¬æˆ³ * @param æ–°ç‰ˆæœ¬æˆ³ */ public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) { Pair&lt;V&gt; current = pair; return expectedReference == current.reference &amp;&amp; expectedStamp == current.stamp &amp;&amp; ((newReference == current.reference &amp;&amp; newStamp == current.stamp) || casPair(current, Pair.of(newReference, newStamp))); } 4.5 weakCompareAndSet() å…¶ä»£ç åŒcompareAndSetæ— å·®åˆ«ï¼Œä½†åœ¨JDK9ä¸­ï¼Œä¸¤ä¸ªæ–¹æ³•éƒ½æ·»åŠ äº†@HotSpotIntrinsicCandidateæ³¨è§£ï¼Œä½¿ç”¨è¯¥æ³¨è§£çš„æ–¹æ³•åœ¨JVMä¸­éƒ½æœ‰ä¸€å¥—åŸºäºCPUæŒ‡ä»¤çš„é«˜æ•ˆçš„å®ç°ï¼Œä¸”ä¼šåœ¨è¿è¡Œæ—¶ä¼šæ›¿ä»£JDKçš„æºç å®ç°ï¼Œä»è€Œè·å¾—æ›´é«˜çš„æ•ˆç‡ã€‚å³HotSpotå¯èƒ½ä¼šæ‰‹åŠ¨å®ç°è¿™ä¸ªæ–¹æ³•ã€‚å‚è€ƒï¼šhttps://blog.csdn.net/lzcaqde/article/details/80868854çš„è§£è¯»ã€‚ 12345678// åŒcompareAndSetï¼Œä½†å¯èƒ½ä¸èƒ½ä¿è¯åŸå­æ€§public boolean weakCompareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) { return compareAndSet(expectedReference, newReference, expectedStamp, newStamp); } 4.6 set() 12345678910/** * æºç è§£é‡Šæ— æ¡ä»¶æ›´æ–°å½“å‰å…ƒç´ çš„å€¼å’Œç‰ˆæœ¬æˆ³ * @param newReference æ–°å€¼ * @param newStamp æ–°ç‰ˆæœ¬æˆ³ */public void set(V newReference, int newStamp) { Pair&lt;V&gt; current = pair; if (newReference != current.reference || newStamp != current.stamp) this.pair = Pair.of(newReference, newStamp); } 4.7 attemptStamp() å¦‚æœå¼•ç”¨å¯¹è±¡ä¸ºæœŸæœ›å€¼ï¼Œåˆ™é‡æ–°è®¾ç½®æ–°çš„ç‰ˆæœ¬æˆ³ã€‚ 1234567public boolean attemptStamp(V expectedReference, int newStamp) { Pair&lt;V&gt; current = pair; return expectedReference == current.reference &amp;&amp; (newStamp == current.stamp || casPair(current, Pair.of(expectedReference, newStamp))); } ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class UseAtomicStampedReference { /** * è®¾ç½®åˆå§‹å€¼å’Œåˆå§‹ç‰ˆæœ¬æˆ³ */ static AtomicStampedReference&lt;String&gt; asr = new AtomicStampedReference(\"wml\",0); public static void main(String[] args) throws InterruptedException { //æ‹¿åˆ°å½“å‰çš„ç‰ˆæœ¬å·(æ—§) final int oldStamp = asr.getStamp(); final String oldReference = asr.getReference(); System.out.println(\"æ—§å€¼ï¼š\"+oldReference+\"ï¼Œæ—§ç‰ˆæœ¬æˆ³ï¼š\"+oldStamp); Thread rightStampThread = new Thread(() -&gt; { System.out.println(Thread.currentThread().getName()+\":å½“å‰å˜é‡å€¼ï¼š\" +oldReference + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + oldStamp ); //æ›´æ–°å¼•ç”¨å¯¹è±¡å€¼å’Œç‰ˆæœ¬æˆ³ asr.compareAndSet(oldReference, \"wml222\", oldStamp, oldStamp + 1); int[] stampHolder=new int[2]; stampHolder[0]=0; //è°ƒç”¨getï¼Œè¿”å›å½“å‰å€¼ï¼Œå¹¶å°†ç‰ˆæœ¬ä¿å­˜åˆ°stampHolder[0]ä¸­ asr.get(stampHolder); //æ‰“å°å½“å‰ç‰ˆæœ¬ System.out.println(\"ä½¿ç”¨get()è·å–ç‰ˆæœ¬ï¼š\"+stampHolder[0]); }); Thread errorStampThread = new Thread(() -&gt; { String reference = asr.getReference(); System.out.println(Thread.currentThread().getName()+\":å½“å‰å˜é‡å€¼ï¼š\" +reference + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + asr.getStamp()); //æ›´æ–°å¼•ç”¨å¯¹è±¡å€¼å’Œç‰ˆæœ¬æˆ³ asr.compareAndSet(reference, \"wml333\", oldStamp, oldStamp + 1); }); rightStampThread.start(); rightStampThread.join(); errorStampThread.start(); errorStampThread.join(); System.out.println(\"Mainçº¿ç¨‹:å½“å‰å˜é‡å€¼ï¼š\" +asr.getReference() + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + asr.getStamp()); asr.set(\"setæ–°å€¼\",3); System.out.println(\"ä½¿ç”¨setæ›´æ–°:å½“å‰å˜é‡å€¼ï¼š\" +asr.getReference() + \"ï¼Œå½“å‰ç‰ˆæœ¬æˆ³ï¼š\" + asr.getStamp()); }} çº¿ç¨‹errorStampThreadæ²¡æœ‰ä½¿ç”¨æ›´æ–°åçš„ç‰ˆæœ¬æˆ³ä½œä¸ºæœŸæœ›ç‰ˆæœ¬ï¼Œå› æ­¤è¯¥çº¿ç¨‹CASå¤±è´¥ã€‚ 5.7 åŸå­æ›´æ–°å­—æ®µç±»atomicåŒ…æä¾›äº†AtomicIntegerFieldUpdaterï¼ŒAtomicLongFieldUpdaterï¼ŒAtomicReferenceFieldUpdaterä¸‰ä¸ªç±»å®ç°åŸå­çš„æ›´æ–°æŸä¸ªç±»çš„æŸä¸ªå­—æ®µã€‚ä»¥AtomicReferenceFieldUpdaterä¸ºä¾‹ï¼šæ›´æ–°å­—æ®µç±»éœ€è¦ä¸¤æ­¥ï¼š1.ç”±äºåŸå­æ›´æ–°å­—æ®µç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ¯æ¬¡å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”ä¼ å…¥è¦æ›´æ–°çš„ç±»ï¼Œå­—æ®µç±»å‹å’Œå­—æ®µåã€‚2.æ›´æ–°ç±»çš„å­—æ®µï¼ˆå±æ€§ï¼‰å¿…é¡»ä½¿ç”¨ public volatileä¿®é¥°ç¬¦ã€‚å…¶ä»–æ³¨æ„ç‚¹ï¼š1.å˜é‡ä¸å¯ä½¿ç”¨staticã€finalå…³é”®å­—ã€‚2.å˜é‡çš„æè¿°ç¬¦ç±»å‹å¿…é¡»ä¸è°ƒç”¨è€…ä¸€è‡´ã€‚å¦åˆ™è°ƒç”¨è€…ä¸èƒ½è°ƒç”¨å˜é‡ä¹Ÿå°±ä¸èƒ½é€šè¿‡åå°„æ“ä½œä¿è¯åŸå­æ€§ã€‚ æ¯ä¸ªæ›´æ–°å­—æ®µç±»éƒ½æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªAtomicXXXXFieldUpdaterImplå®ç°ç±»ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485 private static final class AtomicReferenceFieldUpdaterImpl&lt;T,V&gt; extends AtomicReferenceFieldUpdater&lt;T,V&gt; { // è·å–Unsafe private static final sun.misc.Unsafe U = sun.misc.Unsafe.getUnsafe(); // å½“å‰å˜é‡çš„å†…å­˜åç§»é‡ private final long offset; // å¦‚æœè¦æ“ä½œçš„ç±»çš„å­—æ®µè¢«protectedä¿®é¥°ï¼Œåˆ™cclassä¸ºè°ƒç”¨è€…ç±»çš„classå¯¹è±¡ï¼Œå¦åˆ™cclassä¸ºtclassã€‚ private final Class&lt;?&gt; cclass; // è¦æ“ä½œçš„ç±»çš„classå¯¹è±¡ private final Class&lt;T&gt; tclass; // è¦æ“ä½œçš„ç±»å­—æ®µçš„classå¯¹è±¡ private final Class&lt;V&gt; vclass; /** * @param tclass å³ä¸Šé¢çš„tclass * @param vclass è¦æ“ä½œçš„ç±»å­—æ®µçš„classå¯¹è±¡ * @param fieldName è¢«æ“ä½œçš„å­—æ®µå * @param caller è°ƒç”¨è€…ç±»çš„classå¯¹è±¡ */ AtomicReferenceFieldUpdaterImpl(final Class&lt;T&gt; tclass, final Class&lt;V&gt; vclass, final String fieldName, final Class&lt;?&gt; caller) { //åŸå­æ›´æ–°çš„å­—æ®µ final Field field; //åŸå­æ›´æ–°å­—æ®µçš„classå¯¹è±¡ final Class&lt;?&gt; fieldClass; //åŸå­æ›´æ–°å­—æ®µçš„ä¿®é¥°ç¬¦ final int modifiers; try { //åˆ©ç”¨åå°„æœºåˆ¶è·å–tclassçš„field field = AccessController.doPrivileged( new PrivilegedExceptionAction&lt;Field&gt;() { public Field run() throws NoSuchFieldException { return tclass.getDeclaredField(fieldName); } }); //è·å–è¯¥å­—æ®µçš„ä¿®é¥°ç¬¦ modifiers = field.getModifiers(); //æ£€æŸ¥è¯¥å­—æ®µçš„è®¿é—®æƒé™ï¼Œæ— æ³•è®¿é—®åˆ™æŠ›å‡ºå¯¹åº”å¼‚å¸¸ä¿¡æ¯ sun.reflect.misc.ReflectUtil.ensureMemberAccess( caller, tclass, null, modifiers); //è·å–å¯¹åº”classçš„ç±»åŠ è½½å™¨ ClassLoader cl = tclass.getClassLoader(); ClassLoader ccl = caller.getClassLoader(); if ((ccl != null) &amp;&amp; (ccl != cl) &amp;&amp; ((cl == null) || !isAncestor(cl, ccl))) { sun.reflect.misc.ReflectUtil.checkPackageAccess(tclass); } fieldClass = field.getType(); } catch (PrivilegedActionException pae) { throw new RuntimeException(pae.getException()); } catch (Exception ex) { throw new RuntimeException(ex); } if (vclass != fieldClass) throw new ClassCastException(); if (vclass.isPrimitive()) throw new IllegalArgumentException(\"Must be reference type\"); if (!Modifier.isVolatile(modifiers)) throw new IllegalArgumentException(\"Must be volatile type\"); //é¦–å…ˆåˆ¤æ–­å­—æ®µä¿®é¥°ç¬¦æ˜¯å¦ä¸ºprotected // å†åˆ¤æ–­tclasså’Œcalleræ˜¯å¦ç›¸åŒæˆ–è€…æ˜¯å¦ä¸€ä¸ªç±»çš„å­ç±» this.cclass = (Modifier.isProtected(modifiers) &amp;&amp; tclass.isAssignableFrom(caller) &amp;&amp; !isSamePackage(tclass, caller)) ? caller : tclass; this.tclass = tclass; this.vclass = vclass; this.offset = U.objectFieldOffset(field); } //å¦‚æœå¯ä»¥åœ¨ç¬¬ä¸€ä¸ªç±»åŠ è½½å™¨çš„å§”æ‰˜é“¾ä¸­æ‰¾åˆ°ç¬¬äºŒä¸ªç±»åŠ è½½å™¨ï¼Œåˆ™è¿”å›true private static boolean isAncestor(ClassLoader first, ClassLoader second) { ClassLoader acl = first; do { acl = acl.getParent(); if (second == acl) { return true; } } while (acl != null); return false; } åŸå­æ›´æ–°ç±»çš„æ–¹æ³•åŒatomicåŒ…ä¸‹çš„å…¶ä»–ç±»åŸºæœ¬ç›¸åŒï¼Œä½†æ˜¯è¯¥ç±»åœ¨è¿›è¡ŒCASå‰ï¼Œéœ€è¦å…ˆè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå¦‚ä¸‹ï¼š 123456789101112131415//æ£€æŸ¥ç›®æ ‡å‚æ•°æ˜¯å¦æ˜¯ç±»çš„å®ä¾‹ã€‚å¤±è´¥æ—¶ï¼ŒæŠ›å‡ºåŸå› ã€‚ private final void accessCheck(T obj) { if (!cclass.isInstance(obj)) throwAccessCheckException(obj);}//æ£€æŸ¥ç›®æ ‡å‚æ•°æ˜¯å¦æ˜¯å¯¹åº”å­—æ®µçš„ç±»å‹ï¼Œå¦‚æœä¸æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸private final void valueCheck(V v) { if (v != null &amp;&amp; !(vclass.isInstance(v))) throwCCE(); } public final boolean compareAndSet(T obj, V expect, V update) { accessCheck(obj); valueCheck(update); return U.compareAndSwapObject(obj, offset, expect, update);} ä½¿ç”¨ç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class AtomicReferenceFieldUpdaterDemo { /** * å®šä¹‰AtomicReferenceFieldUpdaterï¼Œä¼ å…¥è¦æ“ä½œçš„ç±»Userï¼Œä»¥åŠåŸå­æ“ä½œçš„å­—æ®µageçš„classå¯¹è±¡Integer.classå’Œå­—æ®µåageï¼Œè¿™é‡Œå­—æ®µå¿…é¡»ä¸ºå¼•ç”¨ç±»å‹ï¼Œå¦‚æœæ˜¯intç±»å‹çš„åˆ™éœ€ä½¿ç”¨ */ static AtomicReferenceFieldUpdater arf = AtomicReferenceFieldUpdater.newUpdater(User.class, Integer.class, \"age\"); /** * å®šä¹‰AtomicIntegerFieldUpdaterï¼Œä¼ å…¥è¦æ“ä½œçš„ç±»Userï¼Œä»¥åŠåŸå­æ“ä½œçš„å­—æ®µågrade */ static AtomicIntegerFieldUpdater aif=AtomicIntegerFieldUpdater.newUpdater(User.class,\"grade\"); public static void main(String[] args) throws InterruptedException { User user = new User(); user.age=19; user.grade=0; //CASä¿®æ”¹ä¸º20 arf.compareAndSet(user, 19, 20); //è¾“å‡º20 System.out.println(arf.get(user)); //ä¿®æ”¹ä¸º21ï¼Œè¿”å›ä¿®æ”¹å‰çš„ 20 System.out.println(arf.getAndSet(user,21)); //ä¿®æ”¹åä¸º21 System.out.println(user.age); ThreadPoolExecutor poolExecutor = new ThreadPoolExecutor(500, 1000, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingDeque()); //å¼€500ä¸ªçº¿ç¨‹å¢åŠ gradeå­—æ®µ for (int i = 0; i &lt; 500; i++) { poolExecutor.execute(()-&gt;{ aif.incrementAndGet(user); }); } poolExecutor.shutdown(); Thread.sleep(2000L); System.out.println(\"å¢åŠ åçš„gradeä¸º:\"+aif.get(user)); aif.compareAndSet(user,500,1000); System.out.println(\"ä¿®æ”¹åçš„gradeä¸º\"+aif.get(user)); }}class User { protected volatile Integer age; protected volatile int grade;} ç»“æœï¼š 12345202021å¢åŠ åçš„gradeä¸º:500ä¿®æ”¹åçš„gradeä¸º1000 å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/65240318","link":"/posts/20200130-atomicClass.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹æ˜¾ç¤ºé”Lockã€Conditionæ¥å£ã€LockSupportä»¥åŠAQSï¼ˆåŒæ­¥é˜Ÿåˆ—ã€æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼‰è¯¦è§£","text":"ä¸€ã€æ˜¾å¼é”synchronizedå…³é”®å­—æ˜¯javaå†…ç½®çš„è¯­è¨€ç‰¹æ€§ï¼Œä½¿ç”¨synchronizedå…³é”®å­—ä¼šéšå¼çš„è·å–é”ï¼Œåœ¨è·å–é”çš„çº¿ç¨‹æ‰§è¡Œæ‰§è¡Œå®Œä»»åŠ¡æˆ–æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚ä½†ä¸ºä»€ä¹ˆè¿˜éœ€è¦Lockå‘¢ï¼Ÿ å¦‚ï¼Œç›®å‰ç»å¤§å¤šæ•°çš„ä¸šåŠ¡åœºæ™¯åŸºæœ¬éƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œå¦‚è¯»å†™æ¯”ä¾‹ä¸º10:1ï¼Œå€˜è‹¥ä½¿ç”¨synchronizedï¼Œè‹¥æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œåˆ™å› ä¸ºå…¶çš„ç‹¬å æ€§ï¼Œå…¶ä»–çš„çº¿ç¨‹éƒ½åªèƒ½ç­‰å¾…ï¼Œé€ æˆå¤§é‡çš„èµ„æºæµªè´¹ï¼Œä½†Lockçš„å®ç°ç±»ReentrantReadWriteLockè¯»å†™é”ä¾¿å¯ä»¥å®Œç¾çš„è§£å†³è¿™ä¸€é—®é¢˜ã€‚ åˆå¦‚ï¼Œsynchronizedæ— æ³•è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè€Œå¦‚æœè·å–è¯¥é”çš„çº¿ç¨‹å› ä¸ºI/Oè¯·æ±‚æˆ–æ˜¯å…¶ä»–åŸå› å¯¼è‡´ä¸€ç›´æ— æ³•é‡Šæ”¾é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹ä¾¿ä¼šè¿›å…¥â€œæ— é™ç­‰å¾…â€çš„çŠ¶æ€ï¼Œè€ŒLockè·å–é”æ—¶å¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨æˆªæ­¢æ—¶é—´ä¹‹åä»æœªè·å–åˆ°é”ï¼Œåˆ™è¿”å›ã€‚ ä½†ä¸ªäººè®¤ä¸ºå¦‚æœä¸ä½¿ç”¨lock.trylockæˆ–è€…lockInterruptbly()ä¸­æ–­è·å–é”çš„çº¿ç¨‹ç­‰ï¼Œå°½é‡ä½¿ç”¨synchronizedå…³é”®å­—ï¼Œsynchronizedå› ä¸ºæ˜¯ä¸€ä¸ªè¯­è¨€ç‰¹æ€§ï¼Œè€ŒLockæ˜¯ä¸€ä¸ªç±»ï¼Œä½¿ç”¨å°±éœ€è¦åˆ›å»ºå¯¹è±¡å®ä¾‹å¿…ç„¶ä¼šæ¯”synchronizedæœ‰æ‰€æ¶ˆè€—ï¼Œjdkå¯¹synchronizedä¹Ÿè¿›è¡Œäº†è®¸å¤šä¼˜åŒ–ã€‚ äºŒã€Lockå…ˆçœ‹lockçš„æ ‡å‡†ç”¨æ³•ï¼š 123456789101112private Lock lock = new ReentrantLock();private int num= 1; .............public void test() { lock.lock(); //å¦‚æœä¸­é—´æŠ›äº†ä¸ªå¼‚å¸¸ï¼Œunlockå°±ä¸ä¼šæ‰§è¡Œï¼Œå› æ­¤é‡Šæ”¾é”å¿…é¡»æ”¾åœ¨finallyä¸­ try{ age++; }finally { lock.unlock(); }} è¿™é‡Œä¸èƒ½å°†è·å–é”æ”¾åœ¨tryä¸­ï¼Œå› ä¸ºå¦‚æœæ”¾åœ¨tryä¸­ï¼Œå½“è·å–é”æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¿…ç„¶ä¼šæ‰§è¡Œunlock()é‡Šæ”¾é”ï¼Œè€Œé—®é¢˜æ˜¯å½“å‰å¹¶æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆå¿…ç„¶ä¼šå¯¼è‡´ç¨‹åºå¼‚å¸¸ã€‚ Lockçš„å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š lock() è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹ä¼šè·å–åˆ°é”ï¼Œå¦‚æœè·å–åˆ°é”ï¼Œä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ä¼šè¿›è¡Œç­‰å¾…ã€‚ void lockInterruptibly() throws InterruptedException;è¯¥æ–¹æ³•æ”¯æŒä¸­æ–­çš„è·å–é”ã€‚å³åœ¨è·å–é”æ—¶ï¼Œå¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™å½“å‰çº¿ç¨‹åªèƒ½è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œä½† æ˜¯å¯ä»¥è°ƒç”¨è¯¥çº¿ç¨‹çš„interrupt()æ–¹æ³•ä¸­æ–­å½“å‰çº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€ï¼Œåœæ­¢è·å–é”ã€‚ boolean tryLock() è¯¥æ–¹æ³•å®ç°éé˜»å¡çš„è·å–é”ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•ä¼šç«‹å³è¿”å›ï¼Œå¦‚æœè·å–åˆ°ï¼Œåˆ™è¿”å›trueï¼Œå¦‚æœæœªè·å–åˆ°åˆ™è¿”å›falseå®˜æ–¹ç»™å‡ºçš„èŒƒä¾‹å¦‚ä¸‹ï¼š 12345678910Lock lock = ...; if (lock.tryLock()) { try { //å¦‚æœè·å–åˆ°é”å°±å¤„ç†ç›¸å…³ä»»åŠ¡ } finally { lock.unlock(); } } else { //æœªè·å–åˆ°æ‰§è¡Œå…¶ä»–ä»»åŠ¡ }} boolean tryLock(long time, TimeUnit unit) throws InterruptedException;åŒ3ä¸€æ ·ï¼Œä½†å¢åŠ äº†è¶…æ—¶æ—¶é—´ã€‚å½“ï¼šï¼ˆ1ï¼‰å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è·å–åˆ°é”ï¼Œåˆ™ç›´æ¥è¿”å›trueï¼ˆ2ï¼‰å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼ˆ3ï¼‰å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…æœªè·å–åˆ°é”ï¼Œè¿”å›false void unlock();é‡Šæ”¾é”ã€‚ Condition newCondition(); è¿”å›ä¸€ä¸ªConditionå®ä¾‹ï¼Œè¯¥å®ä¾‹ä¸è°ƒç”¨å…¶çš„çš„é”ç»‘å®šï¼Œè°ƒç”¨åï¼Œå¯ä½¿ç”¨conditionçš„`await()`ã€`signal()`ç­‰æ–¹æ³•å¯¹è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹è¿›è¡Œç­‰å¾…å’Œå”¤é†’ï¼Œä¸€ä¸ªLockå¯¹è±¡å¯ä»¥ä½¿ç”¨å¤šä¸ª`Condition`ä¸‰ã€Conditionsynchronizedå…³é”®å­—å¯é€šè¿‡wait()ã€notify()å®ç°ç­‰å¾…-é€šçŸ¥çš„æ¨¡å¼ï¼Œè€ŒLockä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯å…¶æ˜¯å€ŸåŠ©Conditionæ¥å£å®ç°çš„ï¼Œé€šè¿‡Lock.newCondition()å°±å¯ä»¥çœ‹å‡ºã€‚ä¸synchronizedä¸åŒçš„æ˜¯ï¼Œä¸€ä¸ªLockå¯¹è±¡å¯ä»¥åˆ›å»ºå¤šä¸ªConditionå®ä¾‹ï¼Œå› æ­¤ï¼Œæ¯ä¸ªConditionå®ä¾‹å¯ä»¥ç»´æŠ¤å•ç‹¬çš„çº¿ç¨‹ï¼Œåœ¨è°ƒç”¨condition.await()å’Œsignal()æ—¶ï¼Œåªä¼šæ§åˆ¶æ³¨å†Œåœ¨è¯¥conditionå®ä¾‹ä¸Šçš„çº¿ç¨‹ï¼ŒsignalAll()ä¹Ÿä¸ä¼šåƒsynchronizedè°ƒç”¨notifyAll()ä¸€æ ·é€šçŸ¥æ‰€æœ‰é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œåªæ˜¯å”¤é†’æ‰€æœ‰æ³¨å†Œåœ¨è¯¥å®ä¾‹çš„çº¿ç¨‹ã€‚Conditionçš„å¸¸ç”¨æ–¹æ³•ï¼š void await() throws InterruptedException;ä¸æ­¤Conditionå…³è”çš„é”ä¼šè¢«åŸå­é‡Šæ”¾ï¼Œå¹¶ä¸”å‡ºäºçº¿ç¨‹è°ƒåº¦çš„ç›®çš„ï¼Œå½“å‰çº¿ç¨‹è¢«ç¦ç”¨ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹å››ç§æƒ…å†µä¹‹ä¸€ï¼š1.å…¶ä»–ä¸€äº›çº¿ç¨‹è°ƒç”¨æ­¤Conditionçš„signal()æˆ–signalAll()æ–¹æ³•ï¼Œè€Œå½“å‰çº¿ç¨‹æ°å¥½è¢«é€‰æ‹©ä¸ºè¦å”¤é†’çš„çº¿ç¨‹2.å…¶ä»–çº¿ç¨‹è°ƒç”¨interrupt() æ–¹æ³•ä¸­æ–­å½“å‰çº¿ç¨‹3.å‘ç”Ÿè™šå‡å”¤é†’å¦‚æœ å½“å‰çº¿ç¨‹è¢«å”¤é†’ï¼Œä»await()æ–¹æ³•è¿”å›ï¼Œåˆ™æ„å‘³ç€å½“å‰çº¿ç¨‹å·²ç»è·å–äº†è¯¥Conditionå¯¹è±¡ç»‘å®šçš„é”ã€‚ void awaitUninterruptibly(); åŒawait()ä¸€æ ·ï¼Œä½†æ˜¯ä¸å“åº”ä¸­æ–­ã€‚å³å¦‚æœå½“å‰çº¿ç¨‹è¿›å…¥æ­¤æ–¹æ³•æ—¶å·²è®¾ç½®å…¶ä¸­æ–­çŠ¶æ€ï¼Œæˆ–è€…åœ¨ç­‰å¾…æ—¶å…¶ä»–çº¿ç¨‹è°ƒç”¨`interrupt()` æ–¹æ³•ï¼Œå®ƒä»ç»§ç»­ç­‰å¾…ç›´åˆ°æ”¶åˆ°signal()æˆ–signalAll()ã€‚å½“å®ƒæœ€ç»ˆä»è¯¥æ–¹æ³•è¿”å›æ—¶ï¼Œå…¶ä¸­æ–­çŠ¶æ€ä»å°†è¢«è®¾ç½®ã€‚ long awaitNanos(long nanosTimeout) throws InterruptedException; å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ã€ä¸­æ–­æˆ–è¶…å‡ºè¶…æ—¶æ—¶é—´ã€‚ æ­¤æ–¹æ³•è¿”å›å‰©ä½™æ—¶é—´ã€‚å› æ­¤å¦‚æœè¿”å›å°äºç­‰äº0çš„æ•°ï¼Œè¯´æ˜å·²ç»è¶…æ—¶ã€‚ boolean await(long time, TimeUnit unit) throws InterruptedException;åŒä¸Šï¼Œä½†å¦‚æœè¶…æ—¶è¿”å›falseï¼Œå¦åˆ™è¿”å›true boolean awaitUntil(Date deadline) throws InterruptedException; å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ã€ä¸­æ–­æˆ–è¶…å‡ºæˆªæ­¢æ—¶é—´ã€‚è¶…æ—¶è¿”å›falseï¼Œå¦åˆ™è¿”å›trueã€‚ void signal();å”¤é†’ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚å¦‚æœæœ‰çº¿ç¨‹åœ¨è¯¥Conditionä¸‹ç­‰å¾…ï¼Œåˆ™é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹å”¤é†’ã€‚è¯¥çº¿ç¨‹ä»await()è¿”å›å‰ï¼Œå¿…é¡»é‡æ–°è·å–Conditonç»‘å®šçš„é”ã€‚ void signalAll(); å”¤é†’æ‰€æœ‰åœ¨è¯¥Conditionä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚åŒæ ·éœ€è¦å…ˆè·å–ç»‘å®šçš„é”ã€‚ Conditionç®€å•ä½¿ç”¨ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134package com.wml.test4.conditon;/** * @author Wang * @date 2020/2/117:27 */public class ConditionDemo { private static Delivery delivery = new Delivery(\"wml\", \"å—äº¬è·¯1å·\", \"å¾·åŸºå¹¿åœºä¸‰å±‚\", 1000); public static void main(String[] args) throws InterruptedException { for (int i = 0; i &lt; 3; i++) { new Thread(() -&gt; { delivery.sms300(); }, \"distance\").start(); } for (int i = 0; i &lt; 3; i++) { new Thread(() -&gt; { delivery.smsArrived(); }, \"address\").start(); } System.out.println(\"é…é€ä¸­\"); Thread.sleep(3000L); delivery.arive300(); Thread.sleep(1000L); delivery.completeDelivery(); }}//é…é€ç±»class Delivery { private Lock lock = new ReentrantLock(); //ä½¿ç”¨lockåˆ›å»ºä¸€ä¸ªç”¨äºå®ç°è·ç¦»çš„ç­‰å¾…é€šçŸ¥çš„condition private Condition distConditon = lock.newCondition(); //ä½¿ç”¨lockåˆ›å»ºä¸€ä¸ªç”¨äºå®ç°åœ°ç‚¹çš„ç­‰å¾…é€šçŸ¥çš„condition private Condition addrCondition = lock.newCondition(); /** * æ”¶é¤äºº */ private String recipient; /** * é…é€åœ°å€ */ private String address; /** * å½“å‰ä½ç½® */ private String currentAddress; /** * è·ç¦» */ private int distance; public Delivery(String recipient, String address, String currentAddress, int distance) { this.recipient = recipient; this.address = address; this.currentAddress = currentAddress; this.distance = distance; } /** * è·ç¦»é€é¤åœ°ç‚¹è¿˜æœ‰300ç±³ï¼Œé€šçŸ¥è®¢é¤äººåˆ°æŒ‡å®šåœ°ç‚¹å–é¤ */ public void arive300() { lock.lock(); try { this.distance = 300; //å‘é€é€šçŸ¥ï¼Œå”¤é†’ç­‰å¾…çº¿ç¨‹ distConditon.signal(); } finally { lock.unlock(); } } /** * å®Œæˆé…é€ï¼Œæ›´æ–°è·ç¦»å’Œä½ç½®ï¼Œå”¤é†’çº¿ç¨‹å‘é€ç›¸å…³é€šçŸ¥ */ public void completeDelivery() { lock.lock(); try { this.distance = 0; this.currentAddress = this.address; //å”¤é†’å½“å‰conditionå®ä¾‹çš„ç­‰å¾…çº¿ç¨‹ addrCondition.signal(); } finally { lock.unlock(); } } /** * åˆ°è¾¾300ç±³å¤„å‘é€é€šçŸ¥ */ public void sms300() { lock.lock(); try { while (this.distance &gt; 300) { try { distConditon.await(); System.out.println(\"åˆ°è¾¾300ç±³å¤„ï¼ŒdistConditonæ‰§è¡Œsignalå”¤é†’äº†\" + Thread.currentThread().getName() + \"çº¿ç¨‹\"); } catch (InterruptedException e) { e.printStackTrace(); } } } finally { lock.unlock(); } System.out.println(\"äº²çˆ±çš„\" + this.recipient + \"å…ˆç”Ÿ/å¥³å£«ï¼Œæ‚¨çš„å¤–å–è¿˜æœ‰300ç±³é€è¾¾\"); } //è®¢é¤é€è¾¾ç›®çš„åœ° public void smsArrived() { lock.lock(); try { try { while (!this.currentAddress.equals(this.address)) { //æŒ‡å®šè¶…æ—¶æ—¶é—´ addrCondition.await(); System.out.println(\"addressCOnditionçš„\" + Thread.currentThread().getName() + \"çº¿ç¨‹è¢«å”¤é†’\"); System.out.println(\"è®¢é¤å·²é€è‡³ç›®çš„åœ°:\" + this.address); } } catch (InterruptedException e) { e.printStackTrace(); } } finally { lock.unlock(); } System.out.println(\"å®Œæˆé…é€\"); }} ç»“æœï¼š 123456é…é€ä¸­åˆ°è¾¾300ç±³å¤„ï¼ŒdistConditonæ‰§è¡Œsignalå”¤é†’äº†distanceçº¿ç¨‹äº²çˆ±çš„wmlå…ˆç”Ÿ/å¥³å£«ï¼Œæ‚¨çš„å¤–å–è¿˜æœ‰300ç±³é€è¾¾addressCOnditionçš„addressçº¿ç¨‹è¢«å”¤é†’è®¢é¤å·²é€è‡³ç›®çš„åœ°:å—äº¬è·¯1å·å®Œæˆé…é€ è¯¥ä¾‹å­ä½¿ç”¨Lockå¯¹è±¡åˆ›å»ºäº†ä¸€ä¸ªè·ç¦»conditionå’Œåœ°å€conditionï¼Œå¤–æ´¾é…é€è‡³è·ç¦»é€é¤ç‚¹300ç±³å’Œé€è¾¾åˆ°æŒ‡å®šåœ°ç‚¹æ—¶éƒ½éœ€è¦å‘é€é€šçŸ¥ï¼Œå‘é€é€šçŸ¥éœ€è¦åˆ†åˆ«è°ƒç”¨è·ç¦»å’Œåœ°å€conditionçš„await()æ–¹æ³•ç­‰å¾…ï¼Œå½“åˆ°è¾¾300ç±³å’ŒæŒ‡å®šåœ°ç‚¹æ—¶å†åˆ†åˆ«è°ƒç”¨å¯¹åº”çš„condition.signal()å”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„çº¿ç¨‹ã€‚ å››ã€LockSupportåœ¨å°†Lockçš„å®ç°ç±»å‰ï¼Œéœ€è¦å…ˆå°†AQSï¼Œä½†æ˜¯äº†è§£AQSåˆéœ€è¦å…ˆäº†è§£LockSupportã€‚LockSupport å®šä¹‰äº†ä¸€ç»„ä»¥ park å¼€å¤´çš„æ–¹æ³•ç”¨æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä»¥åŠunpark(Thread thread)æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚ LockSupportç±»æ— æ³•è¢«å®ä¾‹åŒ–ï¼ˆä»ä»¥ä¸‹æºç å¯çœ‹å‡ºï¼Œåªæœ‰ä¸€ä¸ªç§æœ‰çš„æ„é€ å‡½æ•°ï¼‰ä¸”æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯é™æ€çš„ï¼Œè¿™äº›æ–¹æ³•æä¾›äº†æœ€åŸºæœ¬çš„çº¿ç¨‹é˜»å¡å’Œå”¤é†’åŠŸèƒ½ã€‚ 123public class LockSupport { private LockSupport() {} } å†æ¥çœ‹çœ‹LockSupportçš„æˆå‘˜å˜é‡ï¼š 123456private static final sun.misc.Unsafe UNSAFE;//æŒ‚èµ·çº¿ç¨‹å¯¹è±¡çš„åç§»åœ°å€,å¯¹åº”Threadç±»çš„parkBlockerå­—æ®µprivate static final long parkBlockerOffset;private static final long SEED;private static final long PROBE;private static final long SECONDARY; å¯¹åº”çš„èµ‹å€¼åœ¨é™æ€ä»£ç å—ä¸­: 1234567891011121314static { try { UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; tk = Thread.class; parkBlockerOffset = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"parkBlocker\")); SEED = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"threadLocalRandomSeed\")); PROBE = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"threadLocalRandomProbe\")); SECONDARY = UNSAFE.objectFieldOffset (tk.getDeclaredField(\"threadLocalRandomSecondarySeed\")); } catch (Exception ex) { throw new Error(ex); } } å¯ä»¥çœ‹åˆ°éƒ½æ˜¯å…ˆè·å–Threadç±»ä¸‹çš„å¯¹åº”çš„å­—æ®µï¼Œå¦‚parkBlockerï¼Œç„¶åé€šè¿‡UNFAFEçš„objectFieldOffset()æ–¹æ³•è·å–å¯¹åº”å­—æ®µçš„åç§»é‡ï¼ˆæŸå­—æ®µåœ¨å…¶ç±»ä¸­çš„å†…å­˜åç§»é‡æ˜¯å§‹ç»ˆç›¸åŒçš„ï¼‰ å†æ¥çœ‹çœ‹LockSupportçš„é™æ€æ–¹æ³•ï¼š è¯´åœ¨å‰é¢ï¼šLockSupportçš„park()å’Œunpark()åº•å±‚åœ¨ç»´æŠ¤ä¸€ä¸ªè®¸å¯è¯ï¼Œparkç›¸å½“äºæ¶ˆè´¹è€…ï¼Œunparkç›¸å½“äºç”Ÿäº§è€…ï¼ˆç”Ÿäº§ä¸€ä¸ªè®¸å¯è¯ï¼‰ï¼Œparkåœ¨æ²¡è¢«ä¸­æ–­æˆ–å…¶ä»–åŸå› å¯¼è‡´åœæ­¢ç­‰å¾…çš„æƒ…å†µä¸‹ï¼Œå¿…é¡»æ¶ˆè´¹ä¸€ä¸ªè®¸å¯è¯æ‰å¯ä»¥ç»§ç»­æ‰§è¡Œ 1.parkç›¸å…³æ–¹æ³•: 123public static void park() { UNSAFE.park(false, 0L); } å…¶åº•å±‚è°ƒç”¨çš„UNSAFE.park(boolean isAbsolute, long time)æ–¹æ³•ï¼Œå…¶åº•å±‚åŸç†è§£æå¯å‚è€ƒæ­¤æ–‡ç« ï¼šhttps://juejin.im/post/5bdc1142e51d45052c6fede7#heading-1ï¼Œç®€å•çš„è®²ï¼Œå°±æ˜¯å…¶åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªvolatile int _counterå˜é‡ï¼Œè¯¥å˜é‡å°±ç›¸å½“äºè®¸å¯è¯ï¼Œpark()æ–¹æ³•å°±æ˜¯å°†å…¶ä»1æ”¹ä¸º0æ¶ˆè´¹æ‰ã€‚å…¶ä¼šé¦–å…ˆå°è¯•è·å–è®¸å¯ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œå¦‚æœè·å–åˆ°åˆ™è¯´æ˜æœ‰çº¿ç¨‹è°ƒç”¨unpark()é‡Šæ”¾äº†ä¸€ä¸ªè®¸å¯ï¼Œå†è¿›è¡Œä»¥ä¸‹æƒ…å†µçš„åˆ¤æ–­ï¼š å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç›´æ¥è¿”å› å½“å‰çº¿ç¨‹åˆ°æœŸï¼Œç›´æ¥è¿”å›ï¼Œå…·ä½“å¯åˆ†ä¸ºï¼ˆä»¥ä¸‹æƒ…å†µå‘ç”Ÿä¸­æ–­æˆ–å‡ºç°æœªçŸ¥åŸå› ä¹Ÿéƒ½ä¼šè¿”å›ï¼‰:a.`isAbsolute`ä¸ºtrueï¼Œå¦‚æœ`time`å°äºç­‰äº0ï¼Œç›´æ¥è¿”å›ï¼›å¦‚æœå¤§äº0ï¼Œè¿›è¡Œç²—ç²¾åº¦è¶…æ—¶è®¡ç®—ï¼Œè¶…æ—¶æ—¶é—´å†…æœªè·å–åˆ°è®¸å¯åˆ™è¿”å› b.`isAbsolute`ä¸ºfalseï¼Œ`time`ä¸º0Lï¼Œä¸è¿›è¡Œè¶…æ—¶è®¡ç®—ï¼Œä¸€ç›´ç­‰å¾…unparké‡Šæ”¾è®¸å¯ c..`isAbsolute`ä¸ºfalseï¼Œ`time`å¤§äº0ï¼Œè¿›è¡Œç»†ç²¾åº¦è¶…æ—¶è®¡ç®—ï¼Œå¦‚æœåœ¨timeæ—¶é—´å†…ä»æœªè·å–åˆ°è®¸å¯ï¼Œåˆ™ç›´æ¥è¿”å› è¶…æ—¶ç›¸å…³æ–¹æ³•ï¼š 1234567public static void parkUntil(long deadline) { UNSAFE.park(true, deadline);}public static void parkNanos(long nanos) { if (nanos &gt; 0) UNSAFE.park(false, nanos);} 2. å¸¦æœ‰blockerçš„parkç›¸å…³æ–¹æ³•: 123456public static void park(Object blocker) { Thread t = Thread.currentThread(); setBlocker(t, blocker); UNSAFE.park(false, 0L); setBlocker(t, null); } è¯¥æ–¹æ³•ä¹Ÿæ˜¯ç”¨äºé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå…¶ä¸­blockeræ˜¯ç”¨æ¥æ ‡è¯†å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…çš„å¯¹è±¡ï¼ˆé˜»å¡å¯¹è±¡ï¼‰ï¼Œç”¨äºé—®é¢˜çš„æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§ã€‚ setBlocker()æ–¹æ³•å¦‚ä¸‹ï¼š 123private static void setBlocker(Thread t, Object arg) { UNSAFE.putObject(t, parkBlockerOffset, arg); } å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†UNSAFE.putObject()æ–¹æ³•ï¼Œå®ç°å°†ä¼ å…¥çš„blockerï¼Œï¼ˆè¿™é‡Œæ˜¯argï¼‰ï¼Œèµ‹å€¼ç»™å½“å‰çº¿ç¨‹çš„parkBlockerå¯¹åº”åç§»é‡ä¸‹çš„æ•°æ®ã€‚å›è¿‡å¤´çœ‹park(Object blocker) æ–¹æ³•ï¼Œå…¶åœ¨è°ƒç”¨UNSAFE.park()å‰è®¾ç½®äº†blockerï¼Œåœ¨è¢«å”¤é†’ååˆè°ƒç”¨äº†setBlockerå°†å¯¹åº”ä½ç½®çš„blockeræ¸…ç©ºã€‚å› æ­¤å½“å‰çº¿ç¨‹åœ¨é˜»å¡å‰ï¼Œæˆ‘ä»¬ä»å¯ä»¥è·å–åˆ°å½“å‰çš„blockerã€‚è·å–Blockeræ–¹æ³•å¦‚ä¸‹ï¼š 12345public static Object getBlocker(Thread t) { if (t == null) throw new NullPointerException(); return UNSAFE.getObjectVolatile(t, parkBlockerOffset); } å¸¦blockerçš„è¶…æ—¶çš„park()æ–¹æ³•å¦‚ä¸‹ï¼š 1234567891011121314public static void parkNanos(Object blocker, long nanos) { if (nanos &gt; 0) { Thread t = Thread.currentThread(); setBlocker(t, blocker); UNSAFE.park(false, nanos); setBlocker(t, null); } }public static void parkUntil(Object blocker, long deadline) { Thread t = Thread.currentThread(); setBlocker(t, blocker); UNSAFE.park(true, deadline); setBlocker(t, null); } 3.unparkç›¸å…³æ–¹æ³•: 1234public static void unpark(Thread thread) { if (thread != null) UNSAFE.unpark(thread); } å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚åº•å±‚å°±æ˜¯å°†_counterå˜é‡è®¾ä¸º1ï¼Œå¦‚æœ_counteræœ¬æ¥æ˜¯0ï¼Œåˆ™ä¼šå”¤é†’åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚unparkå¯ä»¥åœ¨parkä¹‹å‰ä½¿ç”¨ï¼Œè¿™æ ·è°ƒç”¨parkæ—¶å‘ç°_counterä¸º1ï¼Œåˆ™å¯ä»¥ç›´æ¥æ¶ˆè´¹ä½¿ç”¨ï¼›unpark()å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œä½†_counterå€¼æœ€å¤šä¸º1ï¼Œä¸ä¼šç´¯åŠ ï¼Œå› æ­¤è¿ç»­è°ƒç”¨ä¸¤æ¬¡park()åªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œç¬¬äºŒæ¬¡å°±ä¼šç­‰å¾…ã€‚ ä¸‹é¢å†™ä¸€ä¸ªå°ä¾‹å­éªŒè¯ä¸Šé¢çš„è¯´æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273public class LockSupportDemo { /** * æµ‹è¯•blockeråœ¨å¯¹åº”çº¿ç¨‹è¢«å”¤é†’åæ¸…ç©º */ public static void testBlocker(){ Thread threadA = new Thread(()-&gt;{ System.out.println(\"ThreadAè¢«é˜»å¡å‰\"); LockSupport.park(\"threadA_Blocker\"); try { Thread.sleep(1000L); } catch (InterruptedException e) { e.printStackTrace(); } }); threadA.start(); new Thread(()-&gt;{ try { Thread.sleep(2000L); } catch (InterruptedException e) { e.printStackTrace(); } String blocker = (String) LockSupport.getBlocker(threadA); System.out.println(\"çº¿ç¨‹Aå³å°†è¢«å”¤é†’\"); System.out.println(\"è·å–åˆ°çº¿ç¨‹Açš„blocker:\"+blocker); //é‡Šæ”¾çº¿ç¨‹A LockSupport.unpark(threadA); System.out.println(\"çº¿ç¨‹Aè¢«å”¤é†’äº†\"); System.out.println(\"å†æ¬¡è·å–çº¿ç¨‹Açš„blocker\"); String blocker2=(String)LockSupport.getBlocker(threadA); System.out.println(\"è·å–åˆ°çº¿ç¨‹Açš„blocker:\"+blocker2); }).start(); } public static void main(String[] args) throws InterruptedException { //testBlocker(); Thread thread = new Thread(() -&gt; { unparkFirst(); }); thread.start(); new Thread(()-&gt;{ try { Thread.sleep(2000L); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\"ç¬¬ä¸‰æ¬¡æ‰§è¡Œunpark\"); LockSupport.unpark(thread); }).start(); } /** * æµ‹è¯•å…ˆæ‰§è¡Œunparkï¼Œå†parkå¯ç»§ç»­æ‰§è¡Œï¼Œä½†æ˜¯æ‰§è¡Œä¸¤æ¬¡unparkï¼Œä¹Ÿåªèƒ½æ‰§è¡Œä¸€æ¬¡parkï¼Œç¬¬äºŒæ¬¡parkè¢«é˜»å¡ */ public static Thread unparkFirst(){ Thread curThread = Thread.currentThread(); LockSupport.unpark(curThread); LockSupport.unpark(curThread); System.out.println(\"æ‰§è¡Œä¸¤æ¬¡unparkå\"); LockSupport.park(); System.out.println(\"ç¬¬ä¸€æ¬¡æ‰§è¡Œparkå\"); LockSupport.park(); System.out.println(\"ç¬¬äºŒæ¬¡æ‰§è¡Œparkå\"); return curThread; }} æ‰§è¡ŒtestBlocker()ç»“æœï¼š 123456ThreadAè¢«é˜»å¡å‰çº¿ç¨‹Aå³å°†è¢«å”¤é†’è·å–åˆ°çº¿ç¨‹Açš„blocker:threadA_Blockerçº¿ç¨‹Aè¢«å”¤é†’äº†å†æ¬¡è·å–çº¿ç¨‹Açš„blockerè·å–åˆ°çº¿ç¨‹Açš„blocker:null å‘ç°åœ¨çº¿ç¨‹Aè¢«å”¤é†’åï¼Œå¯¹åº”çš„blockerä¸ºç©ºæ‰§è¡ŒunparkFirst()ç»“æœï¼š 1234æ‰§è¡Œä¸¤æ¬¡unparkåç¬¬ä¸€æ¬¡æ‰§è¡Œparkåç¬¬ä¸‰æ¬¡æ‰§è¡Œunparkç¬¬äºŒæ¬¡æ‰§è¡Œparkå å‘ç°ç¬¬äºŒæ¬¡æ‰§è¡Œparkåï¼Œçº¿ç¨‹è¢«é˜»å¡ç­‰å¾…ï¼Œåªæœ‰å†æ¬¡æ‰§è¡Œunparkåï¼Œåé¢çš„ä»£ç æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤parkå’Œunparkåº”æˆå¯¹å‡ºç°ï¼Œå¦åˆ™çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚ äº”ã€AQSè®²å®Œäº†LockerSupportï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è®²è§£AQSäº†ã€‚ 5.1 CLHé˜Ÿåˆ—é”CLH é˜Ÿåˆ—é”æ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹ä»…ä»…åœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå‡è®¾å‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ï¼Œè·å–å¯¹åº”çš„é”ã€‚ CLHé˜Ÿåˆ—é”ç”±ä¸€ä¸ªå‰é©±èŠ‚ç‚¹preï¼Œä¸€ä¸ªå½“å‰èŠ‚ç‚¹curNodeï¼Œä¸€ä¸ªtailå°¾èŠ‚ç‚¹å’Œä¸€ä¸ªlockedä½æ„æˆ 5.1.1 è·å–é”è‹¥å½“å‰çº¿ç¨‹Aéœ€è¦è·å–é”ï¼Œåˆ™çº¿ç¨‹Aåˆ›å»ºä¸€ä¸ªæ–°çš„QNodeï¼Œå…ˆå°†å…¶lockedä½è®¾ä¸ºtrueï¼Œè¡¨ç¤ºéœ€è¦è·å–é”ï¼Œåœ¨è°ƒç”¨tail.getAndSet(curNode)ï¼ŒCASçš„æ–¹å¼å°†è‡ªå·±è®¾ä¸ºå°¾éƒ¨ï¼ˆè¿™æ ·åé¢å†æœ‰éœ€è¦è·å–é”çš„å°±å¿…é¡»åœ¨çº¿ç¨‹Aåæ’é˜Ÿï¼‰ï¼ŒåŒæ—¶è¯¥æ–¹æ³•è¿”å›åŸæ¥çš„å°¾èŠ‚ç‚¹ï¼Œè®©è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘åŸå°¾èŠ‚ç‚¹ï¼ˆå³æŒ‡å‘å‰ä¸€ä¸ªçº¿ç¨‹çš„nodeèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè·å–é”çš„çº¿ç¨‹ï¼Œåˆ™preæŒ‡å‘nullï¼Œå› ä¸ºtailåˆå§‹åŒ–ä¸ºnullï¼‰ï¼Œæœ€åå¾ªç¯è®¿é—®åŸå°¾èŠ‚ç‚¹çš„lockedä½ï¼Œå½“å…¶ä¸ºfalseæ—¶ï¼Œåœæ­¢å¾ªç¯ï¼Œå³åœæ­¢è‡ªæ—‹ï¼Œè·å¾—åˆ°é”ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼šè¿™æ ·åªè¦å‰é¢çš„çº¿ç¨‹ä½¿ç”¨é”ç»“æŸï¼Œlockedä½å˜ä¸ºfalseï¼Œåé¢æ’é˜Ÿçš„çº¿ç¨‹å°±å¯ä»¥è·å–åˆ°é”ã€‚ 5.1.2 é‡Šæ”¾é”é‡Šæ”¾é”æ¯”è¾ƒç®€å•ï¼Œç›´æ¥å°†å½“å‰èŠ‚ç‚¹çš„lockedä½è®¾ä¸ºfalseï¼Œç„¶åè®©å½“å‰èŠ‚ç‚¹è®¾ä¸ºå‰é©±èŠ‚ç‚¹ï¼Œä»£è¡¨å‡ºé˜Ÿã€‚ç®€å•å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233/** * @author Wang * @date 2020/2/216:19 */public class CLH { private final AtomicReference&lt;QNode&gt; tail= new AtomicReference&lt;&gt;(new QNode());; private final ThreadLocal&lt;QNode&gt; pre; private final ThreadLocal&lt;QNode&gt; curNode; private static class QNode { volatile boolean locked = false; } public CLH() { curNode = ThreadLocal.withInitial(() -&gt; new QNode()); pre = ThreadLocal.withInitial(() -&gt; null); } public void lock() { QNode node = curNode.get(); node.locked = true; QNode pred = tail.getAndSet(node); pre.set(pred); while (pred.locked) {} } public void unlock() { QNode qnode = curNode.get(); qnode.locked = false; curNode.set(pre.get()); }} 5.2 AQS AQSå³é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œæ˜¯ç”¨æ¥æ„å»ºé”å’Œå…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå¦‚å³å°†è¦å°†çš„Lockçš„å‡ ä¸ªå®ç°ç±»ï¼ŒReentrantLockã€ReentrantReadWriteLockä»¥åŠå‰é¢æ–‡ç« æåˆ°çš„CountDownLatchã€Semaphoreç­‰éƒ½æ˜¯åŸºäºAQSæ¡†æ¶å®ç°çš„ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©AQSå®ç°è‡ªå·±çš„åŒæ­¥å™¨ã€‚ä½¿ç”¨æ–¹å¼ï¼šå­ç±»é€šè¿‡ç»§æ‰¿AQSï¼Œå®ç°AQSæä¾›çš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œåœ¨AQSä¸­ç»´æŠ¤äº†ä¸€ä¸ªintç±»å‹çš„stateä»£è¡¨è¯¥çŠ¶æ€ï¼Œå¹¶æä¾›äº†getState()ã€setState(int newState)å’Œ compareAndSetState(int expect,int update)ç­‰æ–¹æ³•å®ç°å¯¹å…±äº«èµ„æºstateçš„è·å–å’Œé‡Šæ”¾ï¼›è€Œè¯¥å­ç±»æ¨èä½¿ç”¨é™æ€å†…éƒ¨ç±»çš„æ–¹å¼å®ç°ï¼ŒAQSåªæ˜¯å®šä¹‰äº†è‹¥å¹²åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•æä¾›è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ä½¿ç”¨ï¼Œå…¶æ”¯æŒç‹¬å å¼å’Œå…±äº«å¼ä¸¤ç§æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ã€‚åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚é”å’ŒåŒæ­¥å™¨å¾ˆå¥½åœ°éš”ç¦»äº†ä½¿ç”¨è€…å’Œå®ç°è€…æ‰€éœ€å…³æ³¨çš„é¢†åŸŸã€‚å®ç°è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ï¼Œéšåå°†åŒæ­¥å™¨ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•å°†ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚ æ¨¡æ¿æ–¹æ³•AQSçš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯æ¨¡æ¿æ–¹æ³•å‘¢ï¼Ÿç®€å•çš„è¯´å°±æ˜¯åœ¨æ–¹æ³•ä¸­åªå®šä¹‰äº†è¯¥æ–¹æ³•çš„éª¨æ¶ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°æ­¥éª¤æ”¾åœ¨äº†å…¶å­ç±»ä¸­ã€‚å¦‚Springä¸­çš„å„ç§å„æ ·çš„Templateæ¨¡æ¿ã€‚å¦‚è¿˜ä¸æ‡‚ä»€ä¹ˆæ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œè¯·çœ‹ä»¥ä¸‹ä¾‹å­ï¼š 1.å®šä¹‰ä¸€ä¸ªæ”¹å·å­çš„æŠ½è±¡ç±»ï¼š 12345678910111213141516171819202122232425262728293031public abstract class AbstractMarking { //æ”¹å·å­ protected abstract void check(); //è®¡ç®—æ€»åˆ† protected abstract void compute(); //åˆ’åˆ†ç­‰ç¬¬ protected abstract void rank(); /** * æ‰¹å·çš„æ¨¡æ¿æ–¹æ³• * æä¾›äº†ä»¥ä¸Šä¸‰ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“å®ç°åœ¨å­ç±» */ public final void marking(){ check(); compute(); if (shouldRank()){ rank(); } } /** * æ˜¯å¦è¦æ‰“ç­‰çº§(æœ‰çš„ç§‘ç›®æ ¹æ®åˆ†æ•°è¦åˆ’åˆ†ç­‰çº§ï¼Œæœ‰çš„åˆ™æŒ‰åˆ†æ•°è¯„) * @return */ protected boolean shouldRank(){ return false; }} 2.åˆ†åˆ«å®šä¹‰æ•°å­¦ã€è‹±è¯­å’Œå®è®­ç±»å®ç°æ”¹å·å­çš„æŠ½è±¡ç±» 1234567891011121314151617181920212223242526272829303132333435363738public class English extends AbstractMarking { @Override protected void check() { System.out.println(\"æ”¹è‹±è¯­å·å­\"); } @Override protected void compute() { System.out.println(\"è®¡ç®—è‹±è¯­åˆ†æ•°\"); } @Override protected void rank() { System.out.println(\"ä¸éœ€æ‰“è‹±è¯­\"); }}public class Practical extends AbstractMarking { @Override protected void check() { System.out.println(\"æ”¹å®è®­æˆæœ\"); } @Override protected void compute() { System.out.println(\"è®¡ç®—å®è®­åˆ†æ•°\"); } @Override protected void rank() { System.out.println(\"æ‰“å®è®­ç­‰çº§\"); } @Override protected boolean shouldRank() { return true; }} è°ƒç”¨ï¼š 12345678910public class Main { public static void main(String[] args) { AbstractMarking englishMarking=new English(); englishMarking.marking(); AbstractMarking mathMarking=new Math(); mathMarking.marking(); AbstractMarking pracMarking=new Practical(); pracMarking.marking(); }} ç»“æœï¼š 1234567æ”¹è‹±è¯­å·å­è®¡ç®—è‹±è¯­åˆ†æ•°æ”¹é«˜æ•°å·å­è®¡ç®—é«˜æ•°åˆ†æ•°æ”¹å®è®­æˆæœè®¡ç®—å®è®­åˆ†æ•°æ‰“å®è®­ç­‰çº§ AQSä¸­çš„æ¨¡æ¿æ–¹æ³•ï¼šå®ç°è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ã€‚ ç‹¬å æ¨¡å¼ï¼š void acquire(int arg)ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç”±è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨é‡å†™çš„tryAcquire(int arg)æ–¹æ³• void acquireInterruptibly(int arg)åŒä¸Šï¼Œä½†ç›¸åº”ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€è€Œè¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œä½†å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸å¹¶è¿”å›ã€‚ boolean tryAcquireNanos(int arg, long nanosTimeout)åŒ2ï¼Œä½†å¢åŠ äº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…æœªè·å¾—åˆ°åŒæ­¥çŠ¶æ€ï¼Œåˆ™è¿”å›falseï¼Œåä¹‹è¿”å›true protected boolean tryAcquire(int arg)ä»¥åŠtryRelease(int arg) ï¼ˆå¯é‡å†™ï¼‰tryAcquireç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå®ç°è¯¥æ–¹æ³•éœ€è¦æŸ¥è¯¢å½“å‰çŠ¶æ€å¹¶åˆ¤æ–­åŒæ­¥è½¬é˜¿æ ¹å»·æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç„¶åå†è¿›è¡ŒCASè®¾ç½®åŒæ­¥çŠ¶æ€ã€‚è·å–æˆåŠŸè¿”å›trueï¼Œåä¹‹è¿”å›falseã€‚tryReleaseåº¦å±•ç¤ºé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†æœ‰æœºä¼šè·å–åŒæ­¥çŠ¶æ€ boolean release(int arg)ç‹¬å å¼åœ°é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹å”¤é†’ã€‚ å…±äº«æ¨¡å¼ï¼šæä¾›äº†ä¸ç‹¬å æ¨¡å¼å¯¹åº”çš„å¸¦æœ‰Sharedçš„å…±äº«å¼ç›¸å…³çš„æ–¹æ³•ã€‚ä»¥void acquireShared(int arg)ä¸ºä¾‹ï¼Œå…±äº«å¼çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœæœªè·å–åˆ°ï¼Œåˆ™å°†å½“å‰çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œä¸ç‹¬å å¼ä¸åŒçš„æ˜¯è¯¥æ–¹æ³•å…è®¸åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚ AQSä¸­çš„èŠ‚ç‚¹å’ŒåŒæ­¥é˜Ÿåˆ—æ•°æ®ç»“æ„åœ¨ä»‹ç»CLHé”æ—¶å€™å·²ç»æåˆ°äº†ï¼ŒAQSæ˜¯åŸºäºCLHçš„å˜ç§å®ç°ï¼Œå¯¹åº”çš„å°±æ˜¯é™æ€å†…éƒ¨ç±»Nodeï¼Œå®šä¹‰å¦‚ä¸‹ï¼š å…ˆçœ‹Nodeçš„ä¸¤ä¸ªç­‰å¾…æ¨¡å¼å’Œå‡ ä¸ªçŠ¶æ€ï¼š 1234567891011121314151617static final class Node { //æ ‡æ˜çº¿ç¨‹ä»¥å…±äº«æ¨¡å¼ç­‰å¾…é”ï¼Œå¦‚è¯»é”ReadLock static final Node SHARED = new Node(); //æ ‡æ˜çº¿ç¨‹ä»¥ç‹¬å æ¨¡å¼ç­‰å¾…é”ï¼Œå¦‚å¯é‡å…¥é”ReetrantLock(å³ä¸€æŠŠé”ä¸€æ¬¡åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œè€Œå…±äº«é”å…è®¸ä¸€æŠŠé”ä¸€æ¬¡è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰) static final Node EXCLUSIVE = null; /** *ä»¥ä¸‹å‡ ä¸ªæ˜¯çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ */ // è¡¨ç¤ºçº¿ç¨‹è·å–é”çš„è¯·æ±‚å·²ç» å–æ¶ˆ static final int CANCELLED = 1; // åé©±èŠ‚ç‚¹å…¥é˜Ÿç­‰å¾…åä¼šæ›´æ–°å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºSIGNALï¼Œç­‰å¾…å‰é©±èŠ‚ç‚¹é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå‰é©±èŠ‚ç‚¹é‡Šæ”¾åä¼šå”¤é†’åé©±èŠ‚ç‚¹ static final int SIGNAL = -1; //è¡¨ç¤ºèŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå½“å…¶ä»–çº¿ç¨‹è°ƒç”¨çš„condition.signal()åï¼ŒCONDITION static final int CONDITION = -2; //åœ¨å…±äº«æ¨¡å¼ä¸‹ï¼Œå‰é©±èŠ‚ç‚¹åœ¨å”¤é†’åé©±èŠ‚ç‚¹çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ— æ¡ä»¶çš„å”¤é†’åé©±èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ï¼Œä¸€ç›´ä¼ é€’ä¸‹å» static final int PROPAGATE = -3; é™¤æ­¤ä¹‹å¤–ã€‚è¿˜æœ‰ä¸€ä¸ªå€¼ä¸º0çš„çŠ¶æ€ï¼Œä»£è¡¨åˆå§‹åŒ–Nodeå¯¹è±¡çš„é»˜è®¤å€¼ã€‚ä»ä»¥ä¸Šå˜é‡å¯çœ‹å‡ºï¼Œå½“å€¼ä¸ºè´Ÿçš„æ—¶å€™ï¼Œè¡¨ç¤ºç»“ç‚¹ç­‰å¾…çŠ¶æ€æœ‰æ•ˆï¼Œè€Œæ­£å€¼è¡¨ç¤ºç»“ç‚¹å·²è¢«å–æ¶ˆã€‚å› æ­¤å¯é€šè¿‡åˆ¤æ–­çŠ¶æ€çš„å€¼æ˜¯å¦å°äº0æ¥åˆ¤å®šå…¶æ˜¯å¦æ­£å¸¸ã€‚ æˆå‘˜å˜é‡ï¼š 1234567891011//çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çŠ¶æ€ï¼Œ å€¼ä¸ºä»¥ä¸Šå‡ ä¸ªvolatile int waitStatus;//å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹volatile Node prev;//å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹volatile Node next;//å½“å‰èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹volatile Thread thread;//Nodeä½œä¸ºåŒæ­¥é˜Ÿåˆ—èŠ‚ç‚¹æ—¶ï¼ŒnextWaiteræœ‰ä¸¤ä¸ªå€¼ï¼šEXCLUSIVEã€SHAREDæ ‡è¯†å½“å‰èŠ‚ç‚¹æ˜¯ç‹¬å æ¨¡å¼è¿˜æ˜¯å…±äº«æ¨¡å¼//Nodeä½œä¸ºç­‰å¾…é˜Ÿåˆ—èŠ‚ç‚¹æ—¶ï¼ŒnextWaiterè¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ã€‚Node nextWaiter; å¦å¤–ï¼ŒAQSè¿˜æä¾›äº†å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹çš„å¼•ç”¨ã€‚ 12private transient volatile Node head;private transient volatile Node tail; ä½†è¿™é‡Œçš„headèŠ‚ç‚¹ä¸ä¿å­˜çº¿ç¨‹ä¿¡æ¯ã€‚å¦‚ä¸‹ï¼š 12345private void setHead(Node node) { head = node; node.thread = null; node.prev = null; } headèŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„èŠ‚ç‚¹ï¼ŒheadèŠ‚ç‚¹çš„çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œä¼šå”¤é†’å…¶åé©±èŠ‚ç‚¹ï¼Œè€Œåé©±èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºheadèŠ‚ç‚¹ã€‚è®¾ç½®é¦–èŠ‚ç‚¹æ¯æ¬¡éƒ½æ˜¯é€šè¿‡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„é‚£ä¸ªçº¿ç¨‹å®ç°çš„ï¼Œå› ä¸ºä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œæ‰€ä»¥è®¾ç½®å¤´èŠ‚ç‚¹çš„æ–¹æ³•å¹¶ä¸éœ€è¦ä½¿ç”¨ CAS ï¼Œåªéœ€è¦å°†å¤´èŠ‚ç‚¹è®¾ç½®æˆä¸ºåŸå¤´èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹å¹¶æ–­å¼€ä¸åŸå¤´èŠ‚ç‚¹çš„è¿æ¥ã€‚ ç‹¬å å¼åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾1.è·å–12345public final void acquire(int arg) { if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); } 1.é¦–å…ˆè°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°çš„ tryAcquire(int arg)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œè‹¥æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å›ï¼Œè‹¥å¤±è´¥ï¼Œåˆ™è¿”å›falseï¼Œç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ã€‚2.å¦‚æœåŒæ­¥çŠ¶æ€è·å–å¤±è´¥ï¼Œåˆ™æ„é€ åŒæ­¥èŠ‚ç‚¹å¹¶é€šè¿‡addWaiter(Node node)æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425Node(Thread thread, Node mode) { this.nextWaiter = mode; this.thread = thread;}private Node addWaiter(Node mode) { //é€šè¿‡å½“å‰çº¿ç¨‹å’Œmodeï¼ˆNode.EXCLUSIVEï¼‰æ„é€ ä¸€ä¸ªNodeèŠ‚ç‚¹ï¼Œåœ¨ä¸Šé¢çš„æ„é€ æ–¹æ³•ä¸­å¯çœ‹å‡ºmodeè¢«èµ‹å€¼ç»™nextWaiterï¼Œä¹Ÿå°è¯äº†ä¸Šé¢æˆå‘˜å˜é‡ä¸­å¯¹nextWaiterçš„è§£é‡Š Node node = new Node(Thread.currentThread(), mode); //è·å–åŸæ¥çš„å°¾èŠ‚ç‚¹ Node pred = tail; if (pred != null) { //å°¾èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè®©å½“å‰èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘tail node.prev = pred; //é€šè¿‡CASæ›´æ–°å°¾èŠ‚ç‚¹ if (compareAndSetTail(pred, node)) { //CASæˆåŠŸï¼ŒåŸtailèŠ‚ç‚¹çš„åé©±æŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼Œå®ç°åŒå‘é“¾è¡¨ pred.next = node; //è¿”å›å½“å‰èŠ‚ç‚¹ return node; } } //å¦‚æœå°¾èŠ‚ç‚¹ä¸ºç©ºæˆ–CASå¤±è´¥ï¼Œåˆ™è°ƒç”¨enq(node)å°†å½“å‰èŠ‚ç‚¹å…¥é˜Ÿï¼Œè¿”å›node enq(node); return node; } å…¥é˜Ÿæ“ä½œå¦‚ä¸‹ï¼šé€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸åœçš„CASè®¾ç½®å°¾èŠ‚ç‚¹ 123456789101112131415161718private Node enq(final Node node) { for (;;) { Node t = tail; if (t == null) { //å°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆå§‹åŒ–é˜Ÿåˆ—ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶è®©å°¾èŠ‚ç‚¹ç­‰äºå¤´æ¥åœ°é‚£ if (compareAndSetHead(new Node())) tail = head; } else { //å°¾èŠ‚ç‚¹ä¸ä¸ºç©º node.prev = t; //CASè®¾ç½®å°¾èŠ‚ç‚¹ if (compareAndSetTail(t, node)) { t.next = node; return t; } } } } å³å…¥é˜Ÿæ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªåŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ™é€šè¿‡compareAndSetHead(new Node())åˆå§‹åŒ–é˜Ÿåˆ—å¤´ å¦åˆ™ï¼Œè¿›è¡Œè‡ªæ—‹ä¸æ–­CASå°†èŠ‚ç‚¹æ’å…¥å°¾èŠ‚ç‚¹ 3.æœ€åè°ƒç”¨ acquireQueued(Node node,int arg)æ–¹æ³•ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹ä»¥â€œæ­»å¾ªç¯â€çš„æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœè·å–ä¸åˆ°åˆ™é˜»å¡èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œåˆ™åªèƒ½ç­‰å¾…å‰é©±èŠ‚ç‚¹å‡ºé˜Ÿæˆ–é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­æ‰èƒ½å”¤é†’é˜»å¡çº¿ç¨‹ã€‚ 123456789101112131415161718192021222324252627final boolean acquireQueued(final Node node, int arg) { boolean failed = true; try { boolean interrupted = false; for (;;) { //è·å–å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); //åªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹æ‰å¯ä»¥tryAcquire if (p == head &amp;&amp; tryAcquire(arg)) { //å¦‚æœè·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™å°†å¤´èŠ‚ç‚¹æ¢ä¸ºå½“å‰èŠ‚ç‚¹ setHead(node); p.next = null; // help GC failed = false; //è¿”å›ä¸­æ–­çŠ¶æ€ï¼Œæ­¤æ—¶ä¸éœ€è¦ä¸­æ–­ return interrupted; } //å‰é©±èŠ‚ç‚¹éå¤´èŠ‚ç‚¹æˆ–è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ if (shouldParkAfterFailedAcquire(p, node) //åˆ¤æ–­è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åæ˜¯å¦éœ€è¦é˜»å¡ &amp;&amp; parkAndCheckInterrupt())//å¦‚æœéœ€è¦é˜»å¡ï¼Œ interrupted = true;//ç½®ä¸­æ–­æ ‡å¿—ä¸ºtrue } } finally { //å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™å°†å½“å‰èŠ‚ç‚¹å–æ¶ˆ if (failed) cancelAcquire(node); } } shouldParkAfterFailedAcquireå¦‚ä¸‹ï¼š 12345678910111213141516171819private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) { //è·å–å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ int ws = pred.waitStatus; //å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯SIGNAL(å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”åä¼šé€šçŸ¥åé©±èŠ‚ç‚¹)ï¼Œåˆ™å½“å‰èŠ‚ç‚¹å¯ä»¥è¿›è¡Œå®‰å…¨ç­‰å¾… if (ws == Node.SIGNAL) return true; //wså¤§äº0å³å¤„äºCANCELçŠ¶æ€ if (ws &gt; 0) { //å¾ªç¯å°†å½“å‰èŠ‚ç‚¹ä¸å‰é©±èŠ‚ç‚¹ä¸ºéCANCELçŠ¶æ€çš„èŠ‚ç‚¹è¿æ¥ï¼Œå³å¾ªç¯éå†æ‰¾åˆ°æœ‰æ•ˆçŠ¶æ€èŠ‚ç‚¹ do { node.prev = pred = pred.prev; } while (pred.waitStatus &gt; 0); pred.next = node; } else { //å¤„äºå…¶ä»–çŠ¶æ€æ—¶ï¼Œå°†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ›´æ–°å°¾SIGNALï¼Œç„¶åè¿”å›falseï¼Œä¼šåœ¨acquireQueuedä¸­ç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œç›´åˆ°å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºSIGNALæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªæ–¹æ³• compareAndSetWaitStatus(pred, ws, Node.SIGNAL); } return false; } å¯è§ï¼Œè¯¥æ–¹æ³•åªæœ‰åœ¨å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºSIGNALæ—¶æ‰ä¼šè¿”å›trueï¼Œå¯ä»¥è¿›è¡Œå®‰å…¨ç­‰å¾…ã€‚æ¥ç€ä¼šè°ƒç”¨parkAndCheckInterrupt()ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶è¿”å›ä¸­æ–­çŠ¶æ€ 1234private final boolean parkAndCheckInterrupt() { LockSupport.park(this); return Thread.interrupted(); } æµç¨‹æ€»ç»“ï¼š1.è°ƒç”¨tryAcquireå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¦åˆ™è¿›å…¥ 22.è°ƒç”¨addWaiterå°†å½“å‰çº¿ç¨‹æ„é€ ä¸€ä¸ªæ–°èŠ‚ç‚¹åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æœªåˆå§‹åŒ–åˆ™å…ˆåˆå§‹åŒ–ï¼Œå¦åˆ™ç›´æ¥å°†æ–°èŠ‚ç‚¹åŠ å…¥é˜Ÿå°¾3.æ¥ç€è°ƒç”¨acquireQueuedè®©åŠ å…¥é˜Ÿåˆ—çš„èŠ‚ç‚¹å¼€å§‹è‡ªæ—‹ï¼Œåªæœ‰è¯¥èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºheadæ—¶æ‰å¯ä»¥å°è¯•è·å–çŠ¶æ€ï¼ˆè¿™é‡Œä¸€æ˜¯å› ä¸ºå¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¤´èŠ‚ç‚¹é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¼šå”¤é†’åé©±èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¦åŠ æ­¤åˆ¤æ–­ï¼ŒäºŒæ˜¯å› ä¸ºé˜Ÿåˆ—çš„FIFOï¼‰ï¼Œå¦åˆ™è·³è¿‡å¤„äºCANCELçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ›´æ–°ä¸ºSIGNALï¼Œåªæœ‰å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºSIGNALæ—¶ï¼Œè¯¥èŠ‚ç‚¹æ‰å¯ä»¥è¿›è¡Œparkç­‰å¾…ï¼Œè¿”å›ä¸­æ–­çŠ¶æ€4. å¦‚æœè¢«ä¸­æ–­ï¼Œåˆ™è°ƒç”¨selfInterrupt()ä¸­æ–­å½“å‰çº¿ç¨‹ 2.é‡Šæ”¾é‡Šæ”¾åŒæ­¥çŠ¶æ€é€šè¿‡releaseæ–¹æ³•ï¼Œé‡Šæ”¾åä¼šå”¤é†’åé©±èŠ‚ç‚¹ï¼Œè®©åé©±èŠ‚ç‚¹é‡æ–°å°è¯•è·å–åŒæ­¥çŠ¶æ€ 12345678910public final boolean release(int arg) { if (tryRelease(arg)) {///è°ƒç”¨æ¨¡æ¿æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false å…·ä½“å®ç°åœ¨å­ç±» Node h = head; //å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºä¸”çŠ¶æ€é0æ—¶å”¤é†’åé©±èŠ‚ç‚¹ if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; } return false; } unparkSuccessorå¦‚ä¸‹ï¼š 12345678910111213141516171819202122private void unparkSuccessor(Node node) { //è·å–å¤´èŠ‚ç‚¹ï¼ˆè¦é‡Šæ”¾åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼‰çš„çŠ¶æ€ int ws = node.waitStatus; if (ws &lt; 0) //å°†çŠ¶æ€æ”¹ä¸º0 compareAndSetWaitStatus(node, ws, 0); //è·å–åé©±èŠ‚ç‚¹ Node s = node.next; //å¦‚æœåé©±èŠ‚ç‚¹ä¸ºç©ºæˆ–å·²ç»è¢«å–æ¶ˆ if (s == null || s.waitStatus &gt; 0) { //é‡æ–°ç½®ä¸ºnull s = null; //ä»å°¾éƒ¨å¾ªç¯è·å–å¤„äºç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹ä½œä¸ºåé©±æ¥åœ°é‚£ for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; } if (s != null) //åé©±èŠ‚ç‚¹éç©ºæ—¶ï¼Œå”¤é†’è¯¥èŠ‚ç‚¹ LockSupport.unpark(s.thread); } é‚£ä¹ˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦ä»å°¾éƒ¨éå†å‘¢ï¼Ÿä»Nodeç±»çš„æºç ç»™å‡ºå¦‚ä¸‹è§£é‡Šï¼šé¦–å…ˆçœ‹ä¸€ä¸‹ä¹‹å‰è®²çš„addWaiter 12345678910111213private Node addWaiter(Node mode) { Node node = new Node(Thread.currentThread(), mode); Node pred = tail; if (pred != null) { node.prev = pred; if (compareAndSetTail(pred, node)) { pred.next = node; return node; } } enq(node); return node; } åœ¨æ’å…¥åˆ°å°¾èŠ‚ç‚¹æ—¶ï¼Œå…ˆæ‰§è¡Œçš„æ˜¯node.prev=predï¼Œå°†å½“å‰èŠ‚ç‚¹ä¸å‰é©±èŠ‚ç‚¹è¿æ¥ï¼Œç„¶åcompareAndSetTail(pred, node)åŸå­æ›´æ–°å°¾èŠ‚ç‚¹åæ‰æ‰§è¡Œpred.next = node;å°†å‰é©±èŠ‚ç‚¹çš„nextå¼•ç”¨ä¸æ–°çš„å°¾èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œå¦‚æœåœ¨è¯¥æ“ä½œæ‰§è¡Œå‰è°ƒç”¨äº†unparkSuccessorå°±æ— æ³•ä»å‰å¾€åå®Œå…¨éå† å…±äº«æ¨¡å¼åŒæ­¥çŠ¶æ€çš„è·å–å’Œé‡Šæ”¾è·å–ä»¥å…±äº«æ¨¡å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¿½ç•¥ä¸­æ–­ 12345public final void acquireShared(int arg) { if (tryAcquireShared(arg) &lt; 0) doAcquireShared(arg); } tryAcquireShared(int arg)æ¨¡æ¿æ–¹æ³•è¿”å›å€¼ä¸º int ç±»å‹ï¼Œå½“è¿”å›å€¼å¤§äºç­‰äº 0 æ—¶ï¼Œè¡¨ç¤ºèƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚å¯ä»¥ç®€å•çœ‹ä¸€ä¸‹Semphoreä¸­éå…¬å¹³é”å¯¹è¯¥æ–¹æ³•çš„å®ç°ï¼š 12345678910111213141516protected int tryAcquireShared(int acquires) { return nonfairTryAcquireShared(acquires); }final int nonfairTryAcquireShared(int acquires) { //é€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯è·å–åŒæ­¥çŠ¶æ€ for (;;) { //è·å–å½“å‰åŒæ­¥çŠ¶æ€ï¼Œè¿™é‡Œè¡¨ç¤ºå½“å‰å¯ç”¨è®¸å¯æ•° int available = getState(); //å‡å»æœ¬æ¬¡ç”³è¯·è®¸å¯æ•°acquiresï¼Œå¾—åˆ°ç”³è¯·æˆåŠŸåçš„å‰©ä½™è®¸å¯æ•°remaining int remaining = available - acquires; if (remaining &lt; 0 || //å¦‚æœremainingå°äº0ï¼Œåˆ™æœ¬æ¬¡ç”³è¯·æ²¡æœ‰è·å–æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œåç»­åŠ å…¥ç­‰å¾…é˜Ÿåˆ— //å¦‚æœremaining&gt;0ï¼Œåˆ™CASåœ°é‡æ–°è®¾ç½®çŠ¶æ€ï¼Œæ›´æ–°å°¾remainingï¼Œè¿”å›remaining compareAndSetState(available, remaining)) return remaining; } } å›åˆ°acquireShared()ï¼Œå¦‚æœè·å–åŒæ­¥å¤±è´¥ï¼Œåˆ™æ‰§è¡ŒdoAcquireShared()è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè‡ªæ—‹è·å– 1234567891011121314151617181920212223242526272829303132333435private void doAcquireShared(int arg) { //æ„é€ ä¸€ä¸ªå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨ final Node node = addWaiter(Node.SHARED); //è·å–æˆåŠŸå¦ boolean failed = true; try { //æ˜¯å¦è¢«ä¸­æ–­ boolean interrupted = false; for (;;) { //è·å–å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); if (p == head) { //åªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹æ—¶æ‰å¯ä»¥å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼ŒåŸå› å‰é¢å·²è®²è¿‡ int r = tryAcquireShared(arg); //è¿”å›å€¼å¤§äº0ä»£è¡¨è·å–æˆåŠŸ if (r &gt;= 0) { //å°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¦‚æœè¿˜æœ‰å‰©ä½™èµ„æºï¼Œåˆ™ç»§ç»­ä¼ æ’­å”¤é†’åé©±èŠ‚ç‚¹ä¸­å±äºå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹ setHeadAndPropagate(node, r); p.next = null; // help GC if (interrupted) selfInterrupt(); failed = false; return; } } //è·å–å¤±è´¥ï¼Œåˆ™åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åº”è¯¥é˜»å¡ï¼Œå¦‚æœåº”è¯¥é˜»å¡ï¼Œåˆ™å°†å…¶é˜»å¡å¹¶æ£€æŸ¥ä¸­æ–­ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; } } finally { if (failed) cancelAcquire(node); } } æ€»ä½“é€»è¾‘å’Œç‹¬å å¼çš„ç›¸åŒï¼Œä½†å› æ˜¯å…±äº«å¼çš„ï¼Œæ‰€æœ‰åœ¨è·å–äº†åŒæ­¥çŠ¶æ€åéœ€è¦ç»§ç»­å”¤é†’åé©±èŠ‚ç‚¹ï¼Œæ— æ¡ä»¶ä¼ æ’­ä¸‹å»ã€‚æ¥ä¸‹æ¥çœ‹setHeadAndPropagateçš„å®ç°ï¼š 12345678910111213private void setHeadAndPropagate(Node node, int propagate) { //è·å–æ—§çš„å¤´èŠ‚ç‚¹åé¢ä¼šç”¨åˆ° Node h = head; //å°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ setHead(node); //propagate &gt; 0 ä»£è¡¨è¿˜æœ‰å‰©ä½™åŒæ­¥çŠ¶æ€ if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) { Node s = node.next; if (s == null || s.isShared()) doReleaseShared(); } } å…³äºä¸ºä»€ä¹ˆä¸åªç”¨propagate &gt; 0 æ¥åˆ¤æ–­ï¼Œä»¥åŠPROPAGATEçš„æ„ä¹‰ï¼Œå¦ä¸€ä¸ªåšä¸»çš„è¿™ç¯‡æ–‡ç« åšäº†å¾ˆè¯¦ç»†çš„è§£é‡Šï¼šhttps://www.cnblogs.com/micrari/p/6937995.html é‡Šæ”¾ï¼š1234567public final boolean releaseShared(int arg) { if (tryReleaseShared(arg)) {//å°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€ doReleaseShared(); return true; } return false; } doReleaseShared() å¦‚ä¸‹ï¼šå…±äº«æ¨¡å¼ä¸‹ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€ 1234567891011121314151617181920212223private void doReleaseShared() { for (;;) { Node h = head; //å¤´èŠ‚ç‚¹éç©ºä¸”ä¸ç­‰äºå°¾èŠ‚ç‚¹ if (h != null &amp;&amp; h != tail) { //è·å–å¤´èŠ‚ç‚¹çŠ¶æ€ int ws = h.waitStatus; //å¦‚æœçŠ¶æ€ä¸ºSIGNALï¼Œåˆ™CASå°†å…¶çŠ¶æ€æ”¹ä¸º0ï¼Œå¦‚æœCASå¤±è´¥ï¼Œåˆ™ä¸€ç›´å¾ªç¯ï¼Œå¦‚æœæˆåŠŸåˆ™å”¤é†’åé©±èŠ‚ç‚¹ if (ws == Node.SIGNAL) { if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; unparkSuccessor(h); } else if (ws == 0 &amp;&amp; //å¦‚æœçŠ¶æ€ä¸º0ï¼Œåˆ™æ”¹ä¸ºPROPAGATEï¼Œä»¥ç¡®ä¿é‡Šæ”¾åç»§ç»­ä¼ æ’­ !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; // loop on failed CAS } //è¿™é‡Œï¼Œå¦‚æœå¤´èŠ‚ç‚¹åœ¨æ”¹å˜äº†ï¼Œåˆ™ç»§ç»­å¾ªç¯ï¼Œå¦åˆ™ç›´æ¥break if (h == head) break; } } AQSä¸­çš„æ¡ä»¶é˜Ÿåˆ—ConditionObjectå‰é¢å·²ç»ä»‹ç»äº†Conditionæ¥å£ï¼Œè€ŒConditionObjectæ˜¯Conditionçš„ä¸€ä¸ªå®ç°ç±»ï¼Œä¸ºå•å‘é“¾è¡¨ã€‚è¯¥æ¡ä»¶é˜Ÿåˆ—çš„èŠ‚ç‚¹ä¹Ÿæ˜¯ä½¿ç”¨äº†å†…éƒ¨ç±»Nodeï¼Œå¯ä»¥åœ¨ä¸æ»¡è¶³æŸä¸ªæ¡ä»¶çš„æ—¶å€™æŒ‚èµ·çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶çš„æ—¶å€™åœ¨å”¤é†’çº¿ç¨‹ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹è¯¥ç±»çš„æˆå‘˜å˜é‡ï¼š 12345678//ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹private transient Node firstWaiter;//ç­‰å¾…é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹private transient Node lastWaiter; //åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°ä¸­æ–­ private static final int REINTERRUPT = 1;//åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºInterruptedExceptionprivate static final int THROW_IE = -1; ä¸€ä¸ª Condition åŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ã€‚Condition.await()æ–¹æ³•ï¼Œå°†ä¼šä»¥å½“å‰çº¿ç¨‹æ„é€ èŠ‚ç‚¹ï¼Œå¹¶å°†èŠ‚ç‚¹ä»å°¾éƒ¨åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚ 1.å…ˆçœ‹await()æ–¹æ³•ï¼š12345678910111213141516171819202122232425262728public final void await() throws InterruptedException { //1,å¦‚æœä¸­æ–­ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ if (Thread.interrupted()) throw new InterruptedException(); //2.å°†å½“å‰çº¿ç¨‹åŠ å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ— Node node = addConditionWaiter(); //3.é‡Šæ”¾å½“å‰é”ï¼Œå¹¶å”¤é†’åé©±èŠ‚ç‚¹ï¼Œè¿”å›é‡Šæ”¾å‰çš„åŒæ­¥çŠ¶æ€ int savedState = fullyRelease(node); int interruptMode = 0; //4.å¾ªç¯åˆ¤æ–­å½“å‰nodeæ˜¯å¦å·²ç»è½¬ç§»åˆ°AQSé˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°æˆåŠŸè½¬ç§»åˆ°AQSé˜Ÿåˆ—ç»“æŸå¾ªç¯ while (!isOnSyncQueue(node)) { //4.1 é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¢«unparkæˆ–ä¸­æ–­ LockSupport.park(this); //4.2å¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼Œåˆ™è¦æ£€æŸ¥ä¸­æ–­ï¼Œå¹¶æ£€æŸ¥èŠ‚ç‚¹å·²ç»åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚å·²åŠ å…¥ï¼Œåˆ™break if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; } if (acquireQueued(node, savedState) //5.æ­»å¾ªç¯é‡æ–°è·å–åŒæ­¥çŠ¶æ€ï¼ˆåˆšåˆšé‡Šæ”¾äº†å¤šå°‘è¿™é‡Œå°±è·å–å¤šå°‘ï¼‰ï¼Œè¿”å›falseè·å–æˆåŠŸï¼Œè¿”å›trueè·å–å¤±è´¥ &amp;&amp; interruptMode != THROW_IE) //6.å¦‚æœè¢«signalåå‘ç”Ÿä¸­æ–­ interruptMode = REINTERRUPT;//å°†ä¸­æ–­æ¨¡å¼æ”¹ä¸ºREINTERRUPT if (node.nextWaiter != null) //7. åˆ é™¤å–æ¶ˆçš„åé©±èŠ‚ç‚¹ unlinkCancelledWaiters(); if (interruptMode != 0) //8.å¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœä¸ºREINTERRUPTåˆ™ä¸­æ–­å½“å‰çº¿ç¨‹ reportInterruptAfterWait(interruptMode); } æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—çš„æ–¹æ³•addConditionWaiter()ï¼š 1234567891011121314151617181920212223242526Node(Thread thread, int waitStatus) { // Used by Condition this.waitStatus = waitStatus; this.thread = thread; } private Node addConditionWaiter() { //è·å–å°¾èŠ‚ç‚¹ Node t = lastWaiter; //å¦‚æœå°¾èŠ‚ç‚¹çŠ¶æ€ä¸ºCANCELï¼Œåˆ™ç§»é™¤å®ƒ if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) { //æ¸…é™¤CANCELçš„èŠ‚ç‚¹ï¼Œå°†æ‰€æœ‰CONDITIONçš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ unlinkCancelledWaiters(); //é‡æ–°æŒ‡å‘lastWaiter t = lastWaiter; } //æ„å»ºä¸€ä¸ªæ–°çš„conditionç±»å‹NodeåŠ å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ— Node node = new Node(Thread.currentThread(), Node.CONDITION); //å¦‚æœå°¾èŠ‚ç‚¹æ­¤æ—¶ä¸ºç©ºï¼Œåˆ™é‡æ–°åˆå§‹åŒ–é¦–å°¾ç›¸åŒçš„é˜Ÿåˆ— if (t == null) firstWaiter = node; else //å°†å°¾èŠ‚ç‚¹çš„åé©±å¼•ç”¨æŒ‡å‘å½“å‰èŠ‚ç‚¹ t.nextWaiter = node; //æ›´æ–°å°¾èŠ‚ç‚¹ lastWaiter = node; return node; } ä¸Šè¿°èŠ‚ç‚¹å¼•ç”¨æ›´æ–°çš„è¿‡ç¨‹å¹¶æ²¡æœ‰ä½¿ç”¨ CAS ä¿è¯ï¼ŒåŸå› åœ¨äºè°ƒç”¨ await()æ–¹æ³•çš„çº¿ç¨‹å¿…å®šæ˜¯è·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥è¿‡ç¨‹æ˜¯ç”±é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚ unlinkCancelledWaiters()æºç ï¼š 123456789101112131415161718192021222324252627private void unlinkCancelledWaiters() { //è·å–é¦–èŠ‚ç‚¹ Node t = firstWaiter; //ä¿å­˜å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„å¼•ç”¨ Node trail = null; while (t != null) { //è·å–åé©±èŠ‚ç‚¹ Node next = t.nextWaiter; //å¦‚æœå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€éCONDITIONï¼Œåˆ™ç§»é™¤å¹¶å°†æ•´ä¸ªé“¾è¡¨è¿æ¥èµ·æ¥ if (t.waitStatus != Node.CONDITION) { //æ–­å¼€å½“å‰èŠ‚ç‚¹çš„åé©±å¼•ç”¨ t.nextWaiter = null; if (trail == null) //é¦–èŠ‚ç‚¹æŒ‡å‘ä¸‹å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ firstWaiter = next; else //å‰é©±èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™è®©å‰é©±èŠ‚ç‚¹ç›´æ¥è·¨è¿‡å½“å‰èŠ‚ç‚¹æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åé©±èŠ‚ç‚¹ trail.nextWaiter = next; if (next == null) lastWaiter = trail; } else //å½“å‰èŠ‚ç‚¹çŠ¶æ€ä¸ºCONDITIONï¼Œåˆ™è®©trailæŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹é¡ºä¸ºä¸‹ä¸ªèŠ‚ç‚¹ trail = t; t = next; } } å½»åº•é‡Šæ”¾é”fullyRelease(Node node)å³æ— è®ºå¤šå°‘æ¬¡é‡å…¥ï¼Œé€šé€šæ¸…é›¶ 12345678910111213141516171819final int fullyRelease(Node node) { boolean failed = true; try { //è·å–å½“å‰åŒæ­¥çŠ¶æ€ int savedState = getState(); //è°ƒç”¨releaseæ–¹æ³•é‡Šæ”¾å¹¶å”¤é†’ä¸‹ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹ if (release(savedState)) { failed = false; return savedState; } else { //å¦‚æœé‡Šæ”¾å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ throw new IllegalMonitorStateException(); } } finally { if (failed) //å¦‚æœå¤±è´¥ï¼Œåˆ™å–æ¶ˆå½“å‰èŠ‚ç‚¹ node.waitStatus = Node.CANCELLED; } } isOnSyncQueue(Node node):å¦‚æœè¯¥èŠ‚ç‚¹ä¹‹å‰åœ¨æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œä½†ç°åœ¨åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåˆ™è¿”å›trueï¼›å¦‚æœä¸åœ¨åŒæ­¥é˜Ÿåˆ—è¿”å›false 12345678910111213141516171819202122//nodeä¸ºå½“å‰å°¾èŠ‚ç‚¹final boolean isOnSyncQueue(Node node) { //nodeçš„çŠ¶æ€ä¸ºCONDITIONæˆ–nodeçš„å‰é©±ä¸ºç©ºï¼Œåˆ™è¯´æ˜ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºé˜Ÿåˆ—é™¤å¤´èŠ‚ç‚¹å¤–çš„å…¶ä»–èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹éƒ½ä¸ä¸º if (node.waitStatus == Node.CONDITION || node.prev == null) return false; //å¦‚æœå½“å‰node æœ‰åç»§èŠ‚ç‚¹ï¼Œåˆ™è¯´æ˜å…¶åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ if (node.next != null) return true; //åˆ°æ­¤æ–¹æ³•å°±è¯´æ˜å½“å‰å°¾èŠ‚ç‚¹å‰é©±ä¸ä¸ºç©ºï¼Œä¸”åé©±ä¸ºç©ºï¼Œæ­¤æ—¶å¯ä»¥è®¤ä¸ºnodeæ­£å¤„äºæ”¾å…¥åŒæ­¥é˜Ÿåˆ—enqæ–¹æ³•ä¸­çš„compareAndSetTail(t, node)æ“ä½œä¸­ï¼Œå‰é¢å·²ç»åˆ†æè¿‡ï¼Œæ­¤æ—¶å·²ç»è¿æ¥å¥½äº†preä½†æ²¡æœ‰è¿æ¥nextï¼Œè€Œè¿™ä¸ªCASæ“ä½œæœ‰å¯èƒ½å¤±è´¥ï¼Œæ‰€ä»¥é€šè¿‡findNodeFromTailå†å°è¯•ä¸€æ¬¡åˆ¤æ–­ã€‚ return findNodeFromTail(node); } //è¯¥æ–¹æ³•ä¸­é€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯ä»åŒæ­¥é˜Ÿåˆ—çš„å°¾åˆ°å‰éå†å¯»æ‰¾å½“å‰èŠ‚ç‚¹ï¼Œå¦‚æœæ‰¾åˆ°è¿”å›tureï¼Œå¦åˆ™è¿”å›false private boolean findNodeFromTail(Node node) { Node t = tail; for (;;) { if (t == node) return true; if (t == null) return false; t = t.prev; } } checkInterruptWhileWaiting(Node node)æ£€æŸ¥æ˜¯å¦ä¸­æ–­ï¼Œå¦‚æœåœ¨signalä¹‹å‰ä¸­æ–­ï¼Œåˆ™è¿”å›THROW_IEï¼Œå¦‚æœåœ¨signalä¹‹åï¼Œåˆ™è¿”å›REINTERRUPTï¼Œå¦‚æœæ²¡æœ‰ä¸­æ–­ï¼Œåˆ™ä¸º0ã€‚ 123456private int checkInterruptWhileWaiting(Node node) { return Thread.interrupted() ? //å¦‚æœå‘ç”Ÿäº†ä¸­æ–­éœ€è¦è°ƒç”¨transferAfterCancelledWaitä¿è¯ä¸­æ–­çš„çº¿ç¨‹å·²ç»åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ— (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0; } transferAfterCancelledWait(Node node)ä¿è¯ä¸­æ–­çš„çº¿ç¨‹å·²ç»åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ¤æ–­ä¸­æ–­çš„æ—¶å€™ï¼Œæ˜¯å¦æœ‰signalæ–¹æ³•çš„è°ƒç”¨ï¼Œå¦‚æœè¿”å›falseè¡¨ç¤ºåœ¨ä¸­æ–­å‰è¢«signalï¼Œä¹‹åcheckInterruptWhileWaitingè¿”å›REINTERRUPTé‡æ–°ä¸­æ–­ï¼›å¦‚æœè¿”å›trueè¡¨ç¤ºåœ¨ä¸­æ–­åè¢«signalï¼Œä¹‹åcheckInterruptWhileWaitingè¿”å›THROW_IE æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚ 12345678910111213final boolean transferAfterCancelledWait(Node node) { //å°†å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ä»CONDITIONæ”¹ä¸º0ï¼ˆä»è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºisOnSyncQueueæ–¹æ³•ä¸­é€šè¿‡åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸ºCONDITIONæ¥åˆ¤æ–­æ˜¯å¦è¢«è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼‰ if (compareAndSetWaitStatus(node, Node.CONDITION, 0)) { //å¦‚æœCASæˆåŠŸï¼Œè¯´æ˜æ²¡æœ‰è¢«signalï¼Œå¦‚æœè¢«signalï¼Œå…¶çŠ¶æ€ä¼šæ”¹ä¸ºSIGNALï¼ˆåè¾¹ä¼šè®²åˆ°ï¼‰ï¼Œåˆ™åŠ å…¥åŒæ­¥é˜Ÿåˆ— enq(node); return true; } //å¦‚æœçŠ¶æ€CASå¤±è´¥ï¼Œå³nodeçŠ¶æ€ä¸ä¸ºCONDITIONï¼Œè¯´æ˜å·²ç»è¢«signalæˆ–è¢«ä¸­æ–­ï¼Œä½†ä¸èƒ½ä¿è¯å…ˆåé¡ºåºï¼Œé€šè¿‡whileå¾ªç¯ç­‰å¾…nodeå·²ç»è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ— while (!isOnSyncQueue(node)) Thread.yield(); //è¿”å›falseé‡æ–°ä¸­æ–­ return false; } awaitçš„å¸¦è¶…æ—¶æ—¶é—´çš„å…¶ä»–å‡ ä¸ªæ–¹æ³•åŒè¿™ä¸ªåŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯åŠ äº†è¶…æ—¶æ—¶é—´ï¼Œå…·ä½“ä½œç”¨çœ‹ä¸Šé¢çš„Conditionçš„ä»‹ç» 2.å†çœ‹signalç›¸å…³ å°†ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰,ä»æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ç§»è‡³æ‹¥æœ‰é”çš„ç­‰å¾…é˜Ÿåˆ—ã€‚ 12345678public final void signal() { //1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯ç‹¬å æ¨¡å¼ï¼Œå¦‚æœä¸æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); Node first = firstWaiter; if (first != null) doSignal(first); } doSignal(Node first)ä¼šä»ä»é¦–èŠ‚ç‚¹å¼€å§‹éå†ï¼ŒæŠŠç¬¬ä¸€ä¸ªéç©ºã€æ²¡å–æ¶ˆçš„èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ— 123456789private void doSignal(Node first) { do { //åˆ é™¤firstæ¥åœ°é‚£ if ( (firstWaiter = first.nextWaiter) == null) lastWaiter = null; first.nextWaiter = null; } while (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != null); } transferForSignal(Node node) ä¼šå°†èŠ‚ç‚¹ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°AQSé˜Ÿåˆ— 123456789101112131415final boolean transferForSignal(Node node) { //å°è¯•å°†Nodeçš„çŠ¶æ€ä»CONDITIONæ”¹ä¸º0, if (!compareAndSetWaitStatus(node, Node.CONDITION, 0)) //å¦‚æœCASå¤±è´¥ï¼Œè¯´æ˜èŠ‚ç‚¹åœ¨signalå‰è¢«å–æ¶ˆï¼Œè¿”å›falseï¼Œè½¬ç§»å¤±è´¥ return false; //CASæˆåŠŸï¼Œåˆ™å°†è¯¥èŠ‚ç‚¹åŠ å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶è¿”å›ä¹‹å‰çš„tail Node p = enq(node); //è·å–ä¹‹å‰çš„tailçš„çŠ¶æ€ int ws = p.waitStatus; if (ws &gt; 0 //&gt;0ï¼Œå³ä¹‹å‰çš„tailè¢«å–æ¶ˆï¼Œ åˆ™ç›´è¿”å›å”¤é†’å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹ || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))//å¦‚æœæ²¡æœ‰è¢«å–æ¶ˆï¼Œåˆ™å°†åŸtailèŠ‚ç‚¹çŠ¶æ€è®¾ä¸ºSIGNAL,å¦‚æœå¤±è´¥äº†åˆ™ç›´æ¥å”¤é†’å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæˆåŠŸäº†åˆ™å‰é©±èŠ‚ç‚¹è¢«è®¾ä¸ºSIGNAL LockSupport.unpark(node.thread);//å”¤é†’å½“å‰èŠ‚ç‚¹ï¼Œå½“å‰çº¿ç¨‹å¯ä»await()ä¸­çš„park()è¿”å› return true; } å¦å¤–è¿˜æœ‰signalAll()æ–¹æ³•ã€‚å®ç°å°†Conditioné˜Ÿåˆ—ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹è½¬ç§»åˆ°AQSåŒæ­¥é˜Ÿåˆ—å»ç«äº‰é”ï¼ˆç‹¬å ï¼‰ã€‚ æ€»ç»“ï¼šä¸€ä¸ªåŒæ­¥å™¨æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼ˆåŒå‘ï¼‰å’Œå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ˆå•å‘ï¼‰ã€‚è°ƒç”¨ await()ç›¸å…³çš„æ–¹æ³•ï¼Œä¼šè®©å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶é‡Šæ”¾é”ï¼ŒåŒæ—¶çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ä» await()æ–¹æ³•è¿”å›æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¸€å®šè·å–äº† Condition ç»‘å®šçš„é”ã€‚1.è°ƒç”¨ await()ç›¸å…³æ–¹æ³•æ—¶ï¼Œå°†åŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹çš„çº¿ç¨‹è·å–åˆ°äº†é”ï¼Œå°†é€šè¿‡addConditionWaiter()æ–¹æ³•æŠŠå½“å‰çº¿ç¨‹æ„é€ æˆä¸€ä¸ªæ–°çš„èŠ‚ç‚¹å¹¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„åé©±èŠ‚ç‚¹ï¼Œéšåå½“å‰çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚2.ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹é€šè¿‡å…¶ä»–çº¿ç¨‹è°ƒç”¨Condition.signal()æ–¹æ³•è¢«å”¤é†’åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å¼€å§‹å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœæ˜¯é€šè¿‡ä¸­æ–­å”¤é†’ï¼Œåˆ™ä¼šæŠ›å‡ºInterruptedExceptionï¼Œå¦‚æœä¸æ˜¯ï¼Œå°†ä¸­æ–­æ¨¡å¼è®¾ä¸ºREINTERRUPTï¼Œå¹¶å°†è¢«å–æ¶ˆçš„åé©±èŠ‚ç‚¹æ¸…é™¤ã€‚3.è°ƒç”¨signal()æ–¹æ³•ï¼Œä¼šå”¤é†’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼ˆé¦–èŠ‚ç‚¹ï¼‰ï¼Œåœ¨å”¤é†’èŠ‚ç‚¹ä¹‹å‰ï¼Œä¼šå°†è¯¥èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚ä½†å½“å‰çº¿ç¨‹å¿…é¡»æ˜¯è·å–äº†é” ã€‚4.æ¥ç€è·å–ç­‰å¾…é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼Œå°†å…¶å…¨åœ°è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—åå¹¶ä½¿ç”¨ LockSupport .unparkå”¤é†’è¯¥èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ã€‚5.è¢«å”¤é†’çš„çº¿ç¨‹å°±ä¼šä» await()æ–¹æ³•ä¸­çš„ while (!isOnSyncQueue(node))å¾ªç¯ä¸­é€€å‡ºã€‚ï¼ˆisOnSyncQueue(Node node)æ–¹æ³•è¿”å› trueï¼ŒèŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼‰ï¼Œ6.ç„¶åè°ƒç”¨ acquireQueued()æ–¹æ³•åŠ å…¥åˆ°è·å–åŒæ­¥çŠ¶æ€çš„ç«äº‰ä¸­ã€‚æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…è¯´é”ï¼‰ä¹‹åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°†ä»å…ˆå‰è°ƒç”¨çš„ await()æ–¹æ³•è¿”å›ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å·²ç»æˆåŠŸåœ°è·å–äº†é”ã€‚ ï¼ˆéƒ¨åˆ†åˆ†æå¯èƒ½æœ‰ç‘•ç–µï¼Œè¿˜è¯·æŒ‡æ­£ï¼Œæ„Ÿè°¢~ï¼‰ ä¸‹ä¸€ç¯‡è®²Lockçš„å®ç°ç±»ï¼š javaå¹¶å‘ç¼–ç¨‹ä¹‹ReentrantLockå’Œè¯»å†™é”","link":"/posts/20200204-lcAQS.html"},{"title":"javaå¹¶å‘ç¼–ç¨‹ä¹‹ReentrantLockå’Œè¯»å†™é”ReentrantReadWriteLock","text":"åœ¨å‰æ–‡javaå¹¶å‘ç¼–ç¨‹ä¹‹æ˜¾ç¤ºé”Lockã€Conditionæ¥å£ã€LockSupportä»¥åŠAQSï¼ˆåŒæ­¥é˜Ÿåˆ—ã€æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼‰è¯¦è§£å·²ç»å¯¹Lockã€Conditionä»¥åŠAQSç›¸å…³è¿›è¡Œäº†ä»‹ç»ï¼Œæ¥ä¸‹æ¥å°±è¦è®²ä¸€è®²Lockæ¥å£çš„å‡ ä¸ªå®ç°ç±»ï¼šReentrantLockã€ReentrantReadWriteLockåŠå…¶å†…éƒ¨ç±»ReadLockå’ŒWriteLockã€‚æœ¬æ–‡ä¸­å¸¦â–³â–³çš„æ ‡æ³¨ä»£è¡¨å‰æ–‡å·²è®²è¿‡ï¼Œä¸è¯¦è¿°ã€‚ é¦–å…ˆäº†è§£ä¸‹é”çš„å¯é‡å…¥çš„æ¦‚å¿µï¼š ä¸€ã€é”çš„å¯é‡å…¥â€œé‡å…¥â€œæ˜¯æŒ‡çº¿ç¨‹åœ¨è·å–åˆ°é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«é˜»å¡ï¼Œå› æ­¤ï¼š1ï¼‰çº¿ç¨‹å†æ¬¡è·å–é”æ—¶ï¼Œéœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡æˆåŠŸè·å–ã€‚2ï¼‰çº¿ç¨‹è·å–äº†å‡ æ¬¡é”ï¼Œå°±éœ€è¦é‡Šæ”¾å‡ æ¬¡é”ï¼Œåªæœ‰å…¨éƒ¨é‡Šæ”¾å®Œæ¯•ï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½è·å¾—é”ï¼Œå› æ­¤éœ€è¦å¯¹é”çš„è·å–è¿›è¡Œè‡ªå¢è®¡ç®—ï¼Œè‡ªå¢æ¬¡æ•°è¡¨ç¤ºå½“å‰é”è¢«é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œé”è¢«é‡Šæ”¾æ—¶ï¼Œæ¯æ¬¡é‡Šæ”¾è¯¥è®¡æ•°éƒ½è‡ªå‡1ç›´åˆ°å‡åˆ°0æ—¶è¡¨ç¤ºæˆåŠŸé‡Šæ”¾é”ã€‚ äºŒã€ReentrantLock2.1 ç±»å›¾ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼š1.ReentrantLockå®ç°äº†Lockæ¥å£2.å†…éƒ¨ç±»Syncç»§æ‰¿äº†AQS3. FairSyncå’ŒNocfairSyncç»§æ‰¿äº†Sync å¦å¤–ï¼ŒReentrantLockæ˜¯å¯é‡å…¥çš„ç‹¬å é”ï¼Œå› æ­¤ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯è·å–é”ï¼Œè€Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡åœ¨AQSé˜Ÿåˆ—ï¼Œé’ˆå¯¹è·å–é”ï¼Œå…¶æä¾›äº†å…¬å¹³å’Œéå…¬å¹³çš„å®ç°ï¼Œè€Œå…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼ä¸»è¦é€šè¿‡ReentrantLockçš„æ„é€ æ–¹æ³•ç¡®å®šçš„ï¼Œå¦‚ä¸‹ï¼š 123456public ReentrantLock() { sync = new NonfairSync();}public ReentrantLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync();} é»˜è®¤æ„é€ å‡½æ•°ä¸­ï¼Œå®ç°äº†éå…¬å¹³çš„å®ç°ï¼Œè€Œå¸¦å‚çš„æ„é€ å‡½æ•°ï¼Œå‚æ•°fairä¸ºtrueæ—¶ä¸ºå…¬å¹³å®ç°ï¼Œä¸ºfalseæ—¶ä¸ºéå…¬å¹³å®ç°ã€‚ ReentrantLockçš„æˆå‘˜å˜é‡åªæœ‰ä¸€ä¸ªSyncå¯¹è±¡ï¼š 1private final Sync sync; å…¶æˆå‘˜å‡½æ•°é™¤äº†å®ç°Lockæ¥å£æä¾›çš„å‡ ä¸ªæ–¹æ³•å¤–ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œå…¶ä»–æ–¹æ³•éƒ½æ˜¯å¾ˆç®€å•ï¼Œå¦‚è·å–ç­‰å¾…é˜Ÿåˆ—é•¿åº¦ã€è·å–ç­‰å¾…çš„çº¿ç¨‹ç­‰å¾…ã€‚ï¼ˆè¿™å‡ ä¸ªæ–¹æ³•çš„ä»‹ç»åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ‰ä»‹ç»ï¼‰è€Œå¯¹è¿™å‡ ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼Œéƒ½æ˜¯æ ¹æ®Syncå®ç°äº†å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚ ä¸‹é¢å…ˆè®²éå…¬å¹³é”çš„ç›¸å…³æ–¹æ³•ï¼š 2.2 éå…¬å¹³æ¨¡å¼ä»¥ä¸‹æ˜¯éå…¬å¹³é”çš„lock()æ–¹æ³•ï¼š 2.2.1 lock()123456final void lock() { if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else acquire(1);} è¯¥æ–¹æ³•ä¸­ï¼š1.é¦–å…ˆè°ƒç”¨compareAndSetState(0, 1)å°è¯•å°†çŠ¶æ€å€¼ä»0æ”¹ä¸º1ï¼Œå¦‚æœCASæˆåŠŸï¼Œè¡¨ç¤ºé”å·²ç»è¢«å½“å‰çº¿ç¨‹å ç”¨ï¼Œåˆ™å°†å½“å‰çº¿ç¨‹è®¾ä¸ºæœ‰ç‹¬å è®¿é—®æƒçš„çº¿ç¨‹2.å¦‚æœCASå¤±è´¥ï¼Œè¡¨ç¤ºé”å·²ç»è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œåˆ™è°ƒç”¨acquire(1)æ–¹æ³•å°è¯•è·å–é”ã€‚ â–³â–³acquire(1)ä¸ºAQSä¸­çš„æ–¹æ³•ï¼š 12345public final void acquire(int arg) { if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); } å…¶ä¸­tryAcquire()ä¸ºå°è¯•è·å–é”çš„æ¨¡æ¿æ–¹æ³•ï¼Œè¿™é‡Œçš„å…·ä½“å®ç°å°±æ˜¯è°ƒç”¨äº†NonfairSyncä¸‹çš„éå…¬å¹³å®ç°æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334protected final boolean tryAcquire(int acquires) { return nonfairTryAcquire(acquires); }final boolean nonfairTryAcquire(int acquires) { //è·å–å½“å‰çº¿ç¨‹ final Thread current = Thread.currentThread(); //å½“å‰å½“å‰åŒæ­¥çŠ¶æ€ int c = getState(); //å¦‚æœçŠ¶æ€ä¸º0ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰é” if (c == 0) { //é‡å¤lock()ä¸­çš„ç¬¬ä¸€ä¸ªifè¯­å¥ if (compareAndSetState(0, acquires)) { setExclusiveOwnerThread(current); return true; } } //å¦‚æœçŠ¶æ€ä¸ä¸º0ï¼Œä»£è¡¨å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é” // åˆ™åˆ¤æ–­å½“å‰æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ else if (current == getExclusiveOwnerThread()) { // å¦‚æœæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é” // 1.è®©å½“å‰çŠ¶æ€åŠ ä¸Šacquires(å¯é‡å…¥å°±åœ¨è¿™é‡Œä½“ç°ï¼Œè¿›è¡Œè‡ªå¢) int nextc = c + acquires; //2. å¦‚æœåŠ ä¸Šacquiresåçš„çŠ¶æ€å€¼ä»å°äº0 if (nextc &lt; 0) //è¯´æ˜æº¢å‡ºäº†ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new Error(\"Maximum lock count exceeded\"); // å¦‚æœå¤§äº0ï¼Œåˆ™æ›´æ–°å½“å‰çŠ¶æ€ setState(nextc); //è¿”å›true return true; } // å¦‚æœä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›falseï¼Œå°è¯•è·å–å¤±è´¥ return false; } ç®€å•æ€»ç»“ä¸€ä¸‹æµç¨‹ï¼š1.é¦–å…ˆåˆ¤æ–­å½“å‰çŠ¶æ€å€¼stateæ˜¯å¦ç­‰äº0ï¼Œå¦‚æœç­‰äº0åˆ™è¯´æ˜æ²¡æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œè¿›å…¥2ï¼Œå¦åˆ™è¿›å…¥32. CASæ›´æ–°çŠ¶æ€å€¼ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„3.åˆ¤æ–­å½“å‰æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™è‡ªå¢çŠ¶æ€å€¼ï¼Œå¦åˆ™è¿”å›falseï¼›è‡ªå¢çŠ¶æ€æ—¶éœ€æ£€æŸ¥è‡ªå¢åçš„çŠ¶æ€å€¼ï¼Œå¦‚æœå¤§äº0ï¼Œåˆ™æ›´æ–°stateï¼Œå¦‚æœå°äº0ï¼Œè¯´æ˜æº¢å‡ºï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ è€Œå¦‚æœè·å–å¤±è´¥äº†åˆ™ä¼šæ‰§è¡ŒAQSçš„acquireQueued(addWaiter(Node.EXCLUSIVE), arg))æ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹æ„é€ ä¸ºä¸€ä¸ªç‹¬å æ¨¡å¼çš„èŠ‚ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºé¦–èŠ‚ç‚¹ï¼Œæ‰å¯ä»¥å°è¯•è·å–é”ï¼Œå¦åˆ™è·³è¿‡å¤„äºCANCELçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ›´æ–°ä¸ºSIGNALé˜»å¡è‡ªèº«ç­‰å¾…å”¤é†’ã€‚ä»¥ä¸Šå°±æ˜¯lock()çš„éå…¬å¹³å®ç°ï¼Œäº†è§£äº†å…¶å¯é‡å…¥çš„å®ç°æ ¸å¿ƒï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªè‡ªå·±çš„ä¸å¯é‡å…¥çš„ç‹¬å é”ï¼Œå°±å¾ˆç®€å•äº†ã€‚ä¸»è¦å°±æ˜¯ä¿®æ”¹tryAcquire(int arg) æ–¹æ³•ï¼Œå¦‚æœCASæˆåŠŸï¼Œåˆ™å°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„ï¼Œå¦åˆ™ç›´æ¥è¿”å›falseï¼Œä¸è¿›è¡ŒæŒæœ‰é”æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹çš„åˆ¤æ–­ç­‰ç›¸å…³æ“ä½œã€‚ 123456789/*è·å¾—é”*/ @Override protected boolean tryAcquire(int arg) { if(compareAndSetState(0,1)){ setExclusiveOwnerThread(Thread.currentThread()); return true; } return false; } 2.2.2 unlock()ReentrantLockçš„unlock()ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨äº†AQSçš„â–³â–³release()æ–¹æ³•ï¼š 123456789101112ï¼ˆReentrantLockï¼‰public void unlock() { sync.release(1); }ï¼ˆAQSï¼‰public final boolean release(int arg) { if (tryRelease(arg)) { Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; } return false;} è¯¥æ–¹æ³•çš„tryRelease(arg)ä¹Ÿæ˜¯æ¨¡æ¿æ–¹æ³•ï¼Œåœ¨ReentrantLockçš„å®ç°å¦‚ä¸‹ï¼šï¼ˆéå…¬å¹³å’Œå…¬å¹³æ¨¡å¼åªæ˜¯é’ˆå¯¹lockè¿‡ç¨‹ï¼Œreleaseçš„å®ç°æ˜¯ç›¸åŒçš„ï¼‰ 12345678910111213141516171819protected final boolean tryRelease(int releases) { // è®¡ç®—å½“å‰çŠ¶æ€å‡å»releasesåçš„å€¼ int c = getState() - releases; // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ç‹¬å æ¨¡å¼çš„ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); // å¯ä»¥ç†è§£ä¸ºæ˜¯å¦å½»åº•é‡Šæ”¾ boolean free = false; // å¦‚æœcä¸º0ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹å·²ç»å°†é”é‡Šæ”¾å®Œæ¯•ï¼Œå³é‡å…¥çš„æ¬¡æ•°éƒ½å·²é‡Šæ”¾ if (c == 0) { // ç½®ä¸ºtrueï¼Œè¡¨ç¤ºå·²å½»åº•é‡Šæ”¾ free = true; // å°†å½“å‰ç‹¬å çº¿ç¨‹æ¸…ç©º setExclusiveOwnerThread(null); } // å¦‚æœè‡ªå‡ä¸€åçš„stateä¸ä¸º0ï¼Œè¯´æ˜å°šæœªé‡Šæ”¾å®Œæ¯•ï¼Œè¿”å›false setState(c); return free; } æµç¨‹ç®€å•çš„å°†å°±æ˜¯ï¼šå¦‚æœå½“å‰çŠ¶æ€è‡ªå‡1åä¸º0ï¼Œåˆ™è¯´æ˜é”é‡Šæ”¾å®Œæ¯•ï¼Œæƒ…å†µç‹¬å é”ï¼›å¦‚æœä¸ä¸º0ï¼Œåˆ™è¯´æ˜é‡å…¥é”æœªé‡Šæ”¾å®Œæ¯•ï¼Œä»æŒæœ‰èµ„æº å¦‚æœè¿”å›falseï¼Œå°±ä¼šç»§ç»­æ‰§è¡Œrelease()çš„â–³â–³unparkSuccessor(h);æ–¹æ³•å”¤é†’åé©±èŠ‚ç‚¹ã€‚è€Œåé©±èŠ‚ç‚¹è¢«å”¤é†’åå°±ä¼šå†æ¬¡æ‰§è¡ŒacquireQueued() 1234567891011121314final boolean acquireQueued(final Node node, int arg) { .............. boolean interrupted = false; for (;;) { final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) { setHead(node); p.next = null; // help GC failed = false; return interrupted; } ............. } } æ­¤æ—¶p==headæˆç«‹ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºheadï¼Œä¸åŸheadæ–­å¼€ï¼Œå¹¶è¿”å›ä¸­æ–­æ ‡å¿—ï¼Œæ­¤æ—¶å¦‚æ²¡æœ‰è¢«ä¸­æ–­ï¼Œå°±ç›´æ¥ä»acquire()æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚ 2.3 å…¬å¹³æ¨¡å¼lock()æ–¹æ³•ï¼šè¯¥lockæ–¹æ³•ä¹Ÿæ˜¯å®ç°äº†AQSçš„acquire()æ–¹æ³•ï¼Œä½†æ˜¯æ˜¯åœ¨FairSyncå®ç°äº†å…¬å¹³æ¨¡å¼è·å–é”ï¼š 1234567891011121314151617181920protected final boolean tryAcquire(int acquires) { final Thread current = Thread.currentThread(); int c = getState(); if (c == 0) { if (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(0, acquires)) { setExclusiveOwnerThread(current); return true; } } else if (current == getExclusiveOwnerThread()) { int nextc = c + acquires; if (nextc &lt; 0) throw new Error(\"Maximum lock count exceeded\"); setState(nextc); return true; } return false; } } ä»æºç å¯ä»¥çœ‹å‡ºï¼Œåªæ˜¯åœ¨å½“å‰çŠ¶æ€å€¼ä¸º0æ—¶ï¼Œå³æ²¡æœ‰çº¿ç¨‹æŒæœ‰é”æ—¶å¢åŠ äº†ä¸€ä¸ªhasQueuedPredecessors()åˆ¤æ–­ï¼Œæºç å¦‚ä¸‹ï¼š 12345678public final boolean hasQueuedPredecessors() { Node t = tail; Node h = head; Node s; return h != t &amp;&amp; //1.å¤´å°¾èŠ‚ç‚¹ä¸ç›¸åŒï¼Œè¯´æ˜é˜Ÿåˆ—éç©ºï¼Œå¦‚æœé˜Ÿåˆ—ç©ºï¼Œåˆ™è¿”å›falseï¼Œè¯´æ˜æ²¡æœ‰çº¿ç¨‹åœ¨ç­‰å¾… ((s = h.next) == null || s.thread != Thread.currentThread());//2. é˜Ÿåˆ—éç©ºï¼Œå¦‚æœç­‰å¾…çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›trueï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›true } è¯¥æ–¹æ³•è¿”å›å½“å‰ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œtrueè¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œfalseè¡¨ç¤ºæ²¡æœ‰å¦‚æœè¿”å›falseï¼Œåˆ™ç»§ç»­è¿›è¡Œåé¢çš„æ­¥éª¤ï¼ŒåŒéå…¬å¹³æ­¥éª¤ç›¸åŒ å¯è§ï¼Œå…¬å¹³é”ä¼šè€ƒè™‘çº¿ç¨‹ç­‰å¾…çš„ä¼˜å…ˆé¡ºåºï¼Œè€Œéå…¬å¹³é”ä¸è€ƒè™‘é¡ºåºï¼Œè°æ¥è°å°±å»äº‰å¤ºé”ã€‚ ä¸‰ã€è¯»å†™é”ReentrantReadWriteLockåœ¨è¯»å¤šå†™çš„åœºæ™¯ä¸‹ï¼Œè¯¥é”å°±éå¸¸é€‚ç”¨ã€‚è¯¥ç±»ç»´æŠ¤äº†ä¸€ä¸ªè¯»é”ReadLockå’Œä¸€ä¸ªå†™é”WriteLockã€‚ å…³äºå†™é”ï¼š1.å†™é”æ˜¯ä¸€ä¸ªæ”¯æŒå¯é‡å…¥çš„æ’å®ƒé”ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å¢åŠ å†™çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–å†™é”æ—¶ï¼Œè¯»é”å·²ç»è¢«è·å–ï¼ˆè¯»çŠ¶æ€ä¸ä¸º 0ï¼‰æˆ–è€…è¯¥çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚2.å¦‚æœè¯»é”è¢«è·å–ï¼Œåˆ™å†™é”ä¸èƒ½è¢«è·å–ã€‚ å› ä¸ºè¯»å†™é”è¦ä¿è¯å†™é”çš„æ“ä½œå¯¹è¯»é”å¯è§ï¼Œå¦‚æœè¯»é”å·²è¢«è·å–ï¼Œåˆå¯¹å†™é”è·å–ï¼Œé‚£ä¹ˆå…¶ä»–è¯»çº¿ç¨‹å°±æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚å› æ­¤ï¼Œå†™é”è¢«å½“å‰çº¿ç¨‹è·å–çš„å‰ææ˜¯å…¶ä»–è¯»çº¿ç¨‹å…¨éƒ¨é‡Šæ”¾è¯»é”ï¼Œ3.å†™é”ä¸€æ—¦è¢«è·å–ï¼Œåˆ™å…¶ä»–è¯»å†™çº¿ç¨‹çš„è®¿é—®å‡è¢«é˜»å¡ã€‚å…³äºè¯»é”ï¼š1.è¯»é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„å…±äº«é”ï¼Œå®ƒèƒ½å¤Ÿè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–ã€‚2.åœ¨å†™é”æ²¡æœ‰è¢«è·å–æ—¶ï¼Œè¯»é”å¯ä»¥è¢«å¤šæ¬¡è·å–ã€‚è·å–æˆåŠŸåˆ™å®‰å…¨åœ°å¢åŠ è¯»çŠ¶æ€ï¼ˆè¯¥çŠ¶æ€æ˜¯æ‰€æœ‰çº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°å’Œï¼Œä½†æ¯ä¸ªçº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°ä¿å­˜åœ¨ThreadLocalä¸­ï¼‰3.å¦‚æœåœ¨è·å–è¯»é”æ—¶ï¼Œå†™é”è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™å½“å‰çº¿ç¨‹é˜»å¡ç­‰å¾… å…³äºé”çš„å‡é™çº§ï¼š1.é”é™çº§æŒ‡çš„æ˜¯å†™é”é™çº§ä¸ºè¯»é”ï¼šå½“å‰æŒæœ‰å†™é”ï¼ŒåŒæ—¶å†å»è·å–è¯»é”ï¼Œæœ€åå†é‡Šæ”¾å†™é”2.é”å‡çº§æŒ‡çš„æ˜¯è¯»é”å‡çº§ä¸ºå†™é”ï¼šå½“å‰æŒæœ‰è¯»é”ï¼Œè·å–å†™é”ï¼Œæœ€åé‡Šæ”¾è¯»é”ï¼Œä½†RentrantReadWriteLockä¸æ”¯æŒé”çš„å‡çº§ï¼Œå› ä¸ºå¦‚æœå¤šä¸ªçº¿ç¨‹æŒæœ‰è¯»é”ï¼Œä»»æ„ä¸€ä¸ªçº¿ç¨‹å‡çº§åˆ°äº†å†™é”ï¼Œè¿™æ ·å°±ä¸èƒ½ä¿è¯å†™çº¿ç¨‹çš„æ›´æ–°å¯¹å…¶ä»–è¯»çº¿ç¨‹çš„å¯è§æ€§ã€‚ 3.1 ç±»ç»“æ„ä»å›¾ä¸­å¯ä»¥è§å‡ºï¼š1.ReentrantReadWriteLockå®ç°äº†ReadWriteLockæ¥å£ï¼Œåœ¨è¯¥æ¥å£ä¸­æä¾›äº†ä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”ï¼Œå…¶å…·ä½“å®ç°å°±ReentrantReadWriteLockä¸­çš„è¯»é”å’Œå†™é”ã€‚2.ReentrantReadWriteLockæœ‰5ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«ä¸ºReadLockã€WriteLockã€FairSyncã€NonfairSyncå’ŒSyncï¼Œå…¶ä¸­FairSyncå’ŒNonfairSyncæ˜¯Syncçš„å…¬å¹³å’Œéå…¬å¹³çš„å®ç°ï¼ŒSyncå®ç°äº†AQSï¼Œè¯»é”å’Œå†™é”å®ç°äº†Lockæ¥å£ã€‚3.åœ¨Syncä¸‹åˆæœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼šThreadLocalHoldCounterå’ŒHoldCounter 3.2 Syncé¦–å…ˆçœ‹Syncç±»ï¼šå®ƒçš„ä¸¤ä¸ªå†…éƒ¨ç±»æºç å¦‚ä¸‹ï¼š 123456789101112static final class HoldCounter { int count = 0; final long tid = getThreadId(Thread.currentThread()); }static final class ThreadLocalHoldCounter extends ThreadLocal&lt;HoldCounter&gt; { public HoldCounter initialValue() { return new HoldCounter(); } } å…¶ä¸­HoldCounter å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªcountå˜é‡å’Œä¸€ä¸ªtidï¼Œå…¶ä¸­countè¡¨ç¤ºä¸€ä¸ªè¯»çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°ï¼Œtidè¡¨ç¤ºæŒæœ‰è¯»é”çš„å½“å‰çº¿ç¨‹çš„idï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªçº¿ç¨‹ã€‚è€ŒThreadLocalHoldCounterç»§æ‰¿äº†ThreadLocalï¼Œå¹¶ä¸”å°†HoldCounterä½œä¸ºæ³›å‹ï¼Œé‡å†™äº†ThreadLocalçš„initialValue()æ–¹æ³•ï¼Œå¯ç›´æ¥é€šè¿‡getè·å–å½“å‰çº¿ç¨‹çš„countå€¼ã€‚ åœ¨çœ‹èµ·ç±»å±æ€§å‰ï¼Œå…ˆäº†è§£å…¶è¯»å†™çŠ¶æ€çš„è®¾è®¡ï¼š è¯»å†™çŠ¶æ€çš„è®¾è®¡ï¼šReentrantLock ä¸­ï¼ŒåŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œè¯»å†™é”çš„è‡ªå®šä¹‰åŒæ­¥å™¨éœ€è¦åœ¨åŒæ­¥çŠ¶æ€ï¼ˆæ•´å‹å˜é‡ï¼‰ä¸Šç»´æŠ¤å¤šä¸ªè¯»çº¿ç¨‹å’Œä¸€ä¸ªå†™çº¿ç¨‹çš„çŠ¶æ€ï¼Œå› æ­¤å°±éœ€è¦å¯¹è¯¥éå†è¿›è¡Œâ€œæŒ‰ä½åˆ‡å‰²ä½¿ç”¨â€ã€‚åŒæ­¥çŠ¶æ€çš„é«˜ 16 ä½è¡¨ç¤ºè¯»ï¼ˆè¯»é”çº¿ç¨‹æ•°ï¼‰ï¼Œä½ 16 ä½è¡¨ç¤ºå†™ï¼ˆå†™é”é‡å…¥æ­¤æ•°ï¼‰è¯»å†™é”é€šè¿‡ä½è¿ç®—ç¡®å®šå½“å‰çŠ¶æ€ã€‚å‡è®¾å½“å‰åŒæ­¥çŠ¶æ€å€¼ä¸º Sï¼Œå†™çŠ¶æ€ç­‰äº S&amp;0x0000FFFFï¼ˆå°†é«˜ 16 ä½å…¨éƒ¨æŠ¹å»ï¼‰ï¼Œè¯»çŠ¶æ€ç­‰äº S&gt;&gt;&gt;16ï¼ˆæ— ç¬¦å·è¡¥ 0 å³ç§» 16 ä½ï¼‰ã€‚å½“å†™çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+1ï¼Œå½“è¯»çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+(1&lt;&lt;16)ï¼Œä¹Ÿå°±æ˜¯S+0x00010000ã€‚æ ¹æ®çŠ¶æ€çš„åˆ’åˆ†èƒ½å¾—å‡ºä¸€ä¸ªæ¨è®ºï¼šS ä¸ç­‰äº 0 æ—¶ï¼Œå½“å†™çŠ¶æ€ï¼ˆS&amp;0x0000FFFFï¼‰ç­‰äº 0 æ—¶ï¼Œåˆ™è¯»çŠ¶æ€ï¼ˆS&gt;&gt;&gt;16ï¼‰å¤§äº 0ï¼Œå³è¯»é”å·²è¢«è·å–ã€‚ï¼ˆå›¾ç‰‡æ¥æºäºç½‘ç»œï¼‰ Syncçš„æˆå‘˜å±æ€§å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627 è¯»å†™é”å…±ç”¨åŒæ­¥çŠ¶æ€ï¼Œé«˜16ç”¨äºè¯»ï¼Œä½16ä½ç”¨äºå†™ static final int SHARED_SHIFT = 16;// è¯»é”çš„å•ä½ï¼ˆå› ä¸ºè¯»é”æ˜¯é«˜16ä½ï¼Œå› æ­¤æ¯æ¬¡è¦åŠ ä¸Š2^16ï¼‰ static final int SHARED_UNIT = (1 &lt;&lt; SHARED_SHIFT); // å†™é”çš„æœ€å¤§å¯é‡å…¥æ¬¡æ•°æˆ–è¯»é”å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•° static final int MAX_COUNT = (1 &lt;&lt; SHARED_SHIFT) - 1; // å†™é”æ©ç ï¼Œç”¨äºçŠ¶æ€çš„ä½16ä½æœ‰æ•ˆå€¼ static final int EXCLUSIVE_MASK = (1 &lt;&lt; SHARED_SHIFT) - 1; //è¯»é”çš„è®¡æ•°ï¼Œå½“å‰åŒæ­¥çŠ¶æ€å³ç§»16ä½è·å–è¯»é”è®¡æ•° static int sharedCount(int c) { return c &gt;&gt;&gt; SHARED_SHIFT; } //è·å–å†™çº¿ç¨‹çš„æ•°é‡ï¼ˆè·å–å†™é”çš„é‡å…¥æ¬¡æ•°ï¼‰ static int exclusiveCount(int c) { return c &amp; EXCLUSIVE_MASK; }// ä¿å­˜æœ¬åœ°çº¿ç¨‹è·å–è¯»é”çš„é‡å…¥æ¬¡æ•°ï¼Œå½“å‰çº¿ç¨‹çš„è®¡æ•°å˜ä¸º0æ—¶åˆ é™¤ä¹‹ private transient ThreadLocalHoldCounter readHolds; // è¡¨ç¤ºæœ€åä¸€ä¸ªæˆåŠŸè·å–è¯»é”çš„çº¿ç¨‹çš„è®¡æ•°çš„ç¼“å­˜ /* è·å–å’Œé‡Šæ”¾è¯»é”çš„æ—¶å€™ï¼Œéœ€è¦æ›´æ–°HoldCountï¼Œä¼šå…ˆæ£€æµ‹ç¼“å­˜çš„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­çº¿ç¨‹IDæ˜¯å¦å’Œå½“å‰çº¿ç¨‹IDç›¸åŒ å¦‚æœç›¸åŒï¼Œå°±ç›´æ¥é€šè¿‡ç¼“å­˜æ›´æ–°HoldCount å¦åˆ™ï¼Œä»readHoldsä¸­è·å–HoldCounterå¯¹è±¡ï¼Œèµ‹å€¼ç»™è¯¥ç¼“å­˜ï¼Œæœ€åå†æ›´æ–°HoldCounterçš„è®¡æ•°ï¼ˆä¸ç†è§£çš„è¯éœ€è¦å…ˆçœ‹ä¸‹é¢çš„æºç åˆ†æï¼Œå›å¤´å†çœ‹å°±ç†è§£äº†ï¼‰ */ private transient HoldCounter cachedHoldCounter; //ç¬¬ä¸€ä¸ªè·å¾—è¯»å–é”çš„çº¿ç¨‹ã€‚ï¼ˆè¿™é‡Œä½¿ç”¨æ­¤å˜é‡åº”è¯¥å°±æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå½“åªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–è¯»é”æ—¶ï¼Œå¯ç›´æ¥ä»æ­¤å˜é‡è·å–ï¼Œä¸éœ€è¦æ“ä½œreadHolds.get()äº†ï¼‰ private transient Thread firstReader = null; //æ˜¯firstReaderçš„é‡å…¥æ•°ã€‚ private transient int firstReaderHoldCount; Syncçš„æ„é€ å‡½æ•°ï¼š 123456Sync() { // åˆå§‹åŒ–æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨ readHolds = new ThreadLocalHoldCounter(); //ç¡®ä¿readHoldsçš„å¯è§æ€§ setState(getState()); } Syncæ˜¯å…¬å¹³çš„è¿˜æ˜¯éå…¬å¹³çš„æ˜¯åœ¨ReentrantReadWriteLockçš„æ„é€ ä¸­ç¡®å®šçš„ï¼š 12345public ReentrantReadWriteLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync(); readerLock = new ReadLock(this); writerLock = new WriteLock(this); } fairä¸ºtrueæ—¶å®ç°å…¬å¹³æ¨¡å¼ï¼Œä¸ºfalseæ—¶å®ç°éå…¬å¹³æ¨¡å¼ï¼ŒåŒæ—¶åˆå§‹åŒ–è¯»é”å’Œå†™é”ã€‚ å†™é”ï¼šå†™é”å†…éƒ¨å°±ç»´æŠ¤äº†ä¸€ä¸ªSyncï¼Œå…¶å…·ä½“å®ç°ç”±ReentrantReadWriteLockä¸­çš„syncå†³å®šï¼š 123456789public static class WriteLock implements Lock, java.io.Serializable { private static final long serialVersionUID = -4992448646407690164L; private final Sync sync; protected WriteLock(ReentrantReadWriteLock lock) { sync = lock.sync; }} å†™é”çš„lock():lock()ä¹Ÿæ˜¯è°ƒç”¨äº†AQSçš„lock()æ–¹æ³•ï¼Œå…·ä½“å®ç°ä¸ºSyncä¸‹çš„tryAcquire() 12345678910111213141516171819202122232425262728293031protected final boolean tryAcquire(int acquires) { //è·å–å½“å‰çº¿ç¨‹ Thread current = Thread.currentThread(); //è·å–åŒæ­¥çŠ¶æ€ int c = getState(); // è·å–å†™çº¿ç¨‹æ•°é‡ int w = exclusiveCount(c); //çŠ¶æ€ä¸ä¸º0ï¼Œè¡¨ç¤ºå·²æœ‰å…¶ä»–çº¿ç¨‹è·å–è¯»é”æˆ–å†™é” if (c != 0) { //a.è€Œå¦‚æœæ­¤æ—¶w==0å³å†™é”æ²¡æœ‰è¢«å ç”¨ï¼Œè¯´æ˜è¯»é”è¢«å ç”¨ï¼Œå› æ­¤ç›´æ¥è¿”å›falseï¼Œè·å–å¤±è´¥ if (w == 0 || //b.å¦‚æœå½“å‰å†™é”è¢«æŒæœ‰ï¼Œåˆ™åˆ¤æ–­æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯åˆ™è¿”å›falseï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­ current != getExclusiveOwnerThread()) return false; //å¦‚æœæŒæœ‰å†™é”çš„çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ // åˆ™é‡æ–°è®¡ç®—å½“å‰å†™é”é‡å…¥æ¬¡æ•°åæ˜¯å¦å¤§äºæœ€å¤§é‡å…¥æ¬¡æ•°(2^16-1) if (w + exclusiveCount(acquires) &gt; MAX_COUNT) //å¦‚æœè¶…å‡ºæœ€å¤§é‡å…¥æ¬¡æ•°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ throw new Error(\"Maximum lock count exceeded\"); //å¦åˆ™æ›´æ–°åŒæ­¥çŠ¶æ€ï¼Œå³è‡ªå¢é‡å…¥æ¬¡æ•° setState(c + acquires); return true; } //å¦‚æœçŠ¶æ€ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹è·å–è¯»å†™é” if (writerShouldBlock() || //æ˜¯å¦åº”è¯¥é˜»å¡å½“å‰è·å–å†™é”çš„çº¿ç¨‹ !compareAndSetState(c, c + acquires))//å¦‚æœä¸éœ€è¦é˜»å¡ï¼Œåˆ™CASæ›´æ–°åŒæ­¥çŠ¶æ€ return false; //CASæˆåŠŸï¼Œå°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„ setExclusiveOwnerThread(current); return true; } writerShouldBlock()çš„å…¬å¹³å®ç°éœ€è¦è°ƒç”¨hasQueuedPredecessorsåˆ¤æ–­æœ‰æ²¡æœ‰å·²ç»åœ¨ç­‰å¾…è·å–å†™é”çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰åˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›trueï¼›è€Œéå…¬å¹³å®ç°ç›´æ¥è¿”å›false 1234567891011static final class NonfairSync extends Sync { final boolean writerShouldBlock() { return false; }}static final class FairSync extends Sync { final boolean writerShouldBlock() { return hasQueuedPredecessors(); } } æµç¨‹æ€»ç»“ï¼šè·å–å½“å‰åŒæ­¥çŠ¶æ€stateï¼Œå’Œå†™é”é‡å…¥æ¬¡æ•°w å¦‚æœstateä¸ä¸º0.è¯´æ˜è¯»é”æˆ–å†™é”è¢«å ç”¨1.1 å¦‚æœwä¸º0è¯´æ˜å†™é”è¢«æŒæœ‰ï¼Œå› æ­¤è¯»é”å·²ç»è¢«æŒæœ‰ï¼Œç›´æ¥è¿”å›false1.2 å¦‚æœwä¸ä¸º0ï¼Œè¯´æ˜å½“å‰å†™é”è¢«æŒæœ‰ï¼Œåˆ™åˆ¤æ–­å½“å‰å†™é”çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™åˆ¤æ–­é‡å…¥æ¬¡æ•°æ˜¯å¦æº¢å‡ºï¼Œå¦‚æœæ²¡æº¢å‡ºåˆ™æ›´æ–°åŒæ­¥çŠ¶æ€è¿”å›trueï¼›å¦‚æœä¸æ˜¯åˆ™ç›´æ¥è¿”å›false å¦‚æœä¸º0ï¼Œè¯´æ˜è¯»å†™é”éƒ½æ²¡æœ‰è¢«å ç”¨ï¼Œåˆ™æ ¹æ®syncæ˜¯å…¬å¹³è¿˜æ˜¯éå…¬å¹³å®ç°åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦é˜»å¡ï¼Œå¦‚æœä¸éœ€è¦é˜»å¡åˆ™CASæ›´æ–°åŒæ­¥çŠ¶æ€ï¼ŒæˆåŠŸåå°†å½“å‰çº¿ç¨‹è®¾ä¸ºç‹¬å çš„ï¼Œå¹¶è¿”å›trueï¼Œè·å–å†™é”æˆåŠŸ å†™é”çš„unlock():åŒæ ·è°ƒç”¨AQSçš„unlockï¼ŒtryReleaseçš„å®ç°å¦‚ä¸‹ï¼š 12345678910111213protected final boolean tryRelease(int releases) { //1.å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰å†™é”çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); //2.è®¡ç®—å½“å‰çŠ¶æ€å‡å»releasesåçš„å€¼ int nextc = getState() - releases; boolean free = exclusiveCount(nextc) == 0; if (free) //å¦‚æœé‡å…¥æ¬¡æ•°ä¸º0ï¼Œåˆ™ç›´æ¥æ¸…ç©ºé”çš„æŒæœ‰è€…ã€‚å› æ­¤é‡å…¥é”å¿…é¡»å°†é‡å…¥æ¬¡æ•°å…¨éƒ¨é‡Šæ”¾åæ‰å¯çœŸæ­£é‡Šæ”¾é”,è¿”å›true setExclusiveOwnerThread(null); //å¦åˆ™æ›´æ–°é‡å…¥æ¬¡æ•°ï¼Œè¿”å›false setState(nextc); return free; æµç¨‹æ€»ç»“ï¼š1.å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰å†™é”çš„çº¿ç¨‹ç›´æ¥æŠ›å‡ºå¼‚å¸¸2.å¦‚æœè·å–å†™é”æ•°é‡ä¸º0è¡¨ç¤ºæˆåŠŸé‡Šæ”¾ï¼Œç½®ç‹¬å çº¿ç¨‹ä¸ºç©ºï¼Œè¿”å›true2.å¦‚æœä¸ä¸º0ï¼Œåˆ™æ›´æ–°åŒæ­¥çŠ¶æ€ï¼Œè¿”å›false è¯»é”ï¼šç»“æ„åŒå†™é”ç›¸åŒ è¯»é”çš„lock():å¯¹åº”Syncçš„tryAcquireShared ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243protected final int tryAcquireShared(int unused) { //è·å–å½“å‰çº¿ç¨‹ Thread current = Thread.currentThread(); // è·å–å½“å‰çŠ¶æ€ int c = getState(); // å¦‚æœå½“å‰å†™é”è¢«æŒæœ‰ï¼Œä¸”ä¸æ˜¯å½“å‰çº¿ç¨‹,è¿”å›-1ï¼Œå°äº0è¡¨ç¤ºè·å–å¤±è´¥ // è€Œå¦‚æœå†™é”è¢«æŒæœ‰ï¼Œä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œè¯´æ˜æ­£åœ¨è¿›è¡Œé”é™çº§ if (exclusiveCount(c) != 0 &amp;&amp; getExclusiveOwnerThread() != current) return -1; // è·å–å½“å‰è·å–è¯»é”çš„çº¿ç¨‹æ•°é‡ int r = sharedCount(c); if (!readerShouldBlock() &amp;&amp; //å…·ä½“æ ¹æ®å…¬å¹³æˆ–éå…¬å¹³åŸåˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡å½“å‰çº¿ç¨‹ r &lt; MAX_COUNT &amp;&amp; //è¯»é”çº¿ç¨‹å°äºæœ€å¤§å€¼ compareAndSetState(c, c + SHARED_UNIT)) {//CASæ›´æ–°æˆåŠŸ if (r == 0) { //æŒæœ‰è¯»é”çº¿ç¨‹ä¸º0 // å°†å½“å‰çº¿ç¨‹è®¾ä¸ºç¬¬ä¸€ä¸ªæŒæœ‰è¯»é”çš„çº¿ç¨‹ï¼Œå³å°†è¯»é”çŠ¶æ€ä»0å˜ä¸º1 firstReader = current; firstReaderHoldCount = 1; } else if (firstReader == current) {//å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œå³è¯¥çº¿ç¨‹é‡å…¥ //é‡å…¥æ•°è‡ªå¢ firstReaderHoldCount++; } else {//å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹ //å…ˆæŸ¥å–ç¼“å­˜ï¼Œè·å–ç¼“å­˜è®¡æ•° HoldCounter rh = cachedHoldCounter; //1.ç¼“å­˜ä¸ºç©º //2.ç¼“å­˜ä¸ä¸ºç©ºï¼Œä½†å¯¹åº”çš„çº¿ç¨‹idéå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹id if (rh == null || rh.tid != getThreadId(current)) // ä»threadLocalä¸­è·å–è®¡æ•° cachedHoldCounter = rh = readHolds.get(); //å¦‚æœè®¡æ•°ä¸º0 else if (rh.count == 0) //åˆ™åŠ å…¥åˆ°readHoldsä¸­ readHolds.set(rh); //è®¡æ•°è‡ªå¢ rh.count++; } //è·å–æˆåŠŸï¼Œè¿”å›1 return 1; } return fullTryAcquireShared(current); } å¦‚æœå½“å‰çº¿ç¨‹éœ€è¦é˜»å¡ï¼Œæˆ–è¯»çº¿ç¨‹è¶…è¿‡æœ€å¤§å€¼ï¼Œæˆ–CASå¤±è´¥ï¼Œè¿›å…¥fullTryAcquireSharedæ–¹æ³•ï¼Œå¾ªç¯è·å–è¯»é” 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556final int fullTryAcquireShared(Thread current) { HoldCounter rh = null; //æ­»å¾ªç¯è‡ªæ—‹ for (;;) { //è·å–å½“å‰çŠ¶æ€ int c = getState(); if (exclusiveCount(c) != 0) {//æœ‰çº¿ç¨‹æŒæœ‰å†™é” if (getExclusiveOwnerThread() != current) //ä¸”ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è¿”å›-1 return -1; } else if (readerShouldBlock()) {//å¦‚æœéœ€è¦é˜»å¡ if (firstReader == current) {///å½“å‰çº¿ç¨‹ä¸ºç¬¬ä¸€ä¸ªè·å–è¯»é”çš„ // assert firstReaderHoldCount &gt; 0; } else {//å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„ if (rh == null) { //è®¡æ•°ä¸ºç©ºï¼Œåˆ™å°†ç¼“å­˜èµ‹å€¼ç»™å®ƒ rh = cachedHoldCounter; //ç¼“å­˜ä¸ºç©ºæˆ–è¿è¡Œçº¿ç¨‹tidä¸æ˜¯å½“å‰è¿è¡Œçš„çº¿ç¨‹ if (rh == null || rh.tid != getThreadId(current)) { //ä»threadlocalä¸­è·å– rh = readHolds.get(); if (rh.count == 0) readHolds.remove(); } } if (rh.count == 0) return -1; } } // è¯»é”çº¿ç¨‹è¶…è¿‡æœ€å¤§å€¼ï¼ŒæŠ›å‡ºå¼‚å¸¸ if (sharedCount(c) == MAX_COUNT) throw new Error(\"Maximum lock count exceeded\"); //CASæ›´æ–°çŠ¶æ€å€¼ if (compareAndSetState(c, c + SHARED_UNIT)) { //ä¸‹é¢é€»è¾‘è·Ÿä¸Šé¢åŸºæœ¬ç›¸åŒï¼Œä¸èµ˜è¿° if (sharedCount(c) == 0) { firstReader = current; firstReaderHoldCount = 1; } else if (firstReader == current) { firstReaderHoldCount++; } else { if (rh == null) rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) rh = readHolds.get(); else if (rh.count == 0) readHolds.set(rh); rh.count++; cachedHoldCounter = rh; // cache for release } return 1; } } } è¯»é”çš„unlock():æ¶‰åŠçš„ç±»å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839protected final boolean tryReleaseShared(int unused) { Thread current = Thread.currentThread(); //å¦‚æœç¬¬ä¸€ä¸ªè¯»é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ if (firstReader == current) { //å¦‚æœåªé‡å…¥ä¸€æ¬¡ if (firstReaderHoldCount == 1) //ç›´æ¥ç½®ç©º firstReader = null; else //å¦åˆ™è®¡æ•°è‡ªå‡ firstReaderHoldCount--; } else {//å½“å‰çº¿ç¨‹éç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹ //è·å–ç¼“è®¡æ•° HoldCounter rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) //ç¼“å­˜ä¸ºç©ºæˆ–éå½“å‰çº¿ç¨‹åˆ™ä»threadlocalè·å– rh = readHolds.get(); //è·å–å½“å‰çº¿ç¨‹çš„è·å–è¯»é”æ¬¡æ•° int count = rh.count; if (count &lt;= 1) {//å¦‚æœè®¡æ•°å°äºç­‰äº1 readHolds.remove();//å½»åº•é‡Šæ”¾èµ„æº if (count &lt;= 0)//å°äºç­‰äº-æ—¶æŠ›å‡ºå¼‚å¸¸ throw unmatchedUnlockException(); } // å½“å‰çº¿ç¨‹çš„è¯»é”çš„å¯é‡å…¥æ¬¡æ•°è‡ªå‡ --rh.count; } for (;;) { //è·å–å½“å‰çŠ¶æ€ int c = getState(); //é‡Šæ”¾åçš„çŠ¶æ€ int nextc = c - SHARED_UNIT; //casæ›´æ–°çŠ¶æ€ if (compareAndSetState(c, nextc)) //å¦‚æœä¸º0ï¼Œè¡¨ç¤ºå½»åº•é‡Šæ”¾ï¼Œè¿”å›tureï¼Œå¦åˆ™è¿”å›false return nextc == 0; } } é‡Šæ”¾æµç¨‹ï¼š1.å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ï¼Œåˆ™åˆ¤æ–­å…¶å æœ‰çš„èµ„æºæ˜¯å¦ä¸º1ï¼Œå³æ˜¯å¦åªé‡å…¥ä¸€æ¬¡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®©ç¬¬ä¸€ä¸ªè¯»é”çš„çº¿ç¨‹ç½®ç©ºï¼Œå¦åˆ™è®©ç¬¬ä¸€ä¸ªè¯»é”çš„çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°è‡ªå‡ä¸€2.å¦‚æœå½“å‰çº¿ç¨‹éç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹ï¼Œåˆ™é¦–å…ˆè·å–ç¼“å­˜è®¡æ•°ï¼Œå¦‚æœä¸ºç©ºæˆ–éå½“å‰çº¿ç¨‹ï¼Œåˆ™ä»threadLocalä¸­è·å–å½“å‰çº¿ç¨‹çš„è®¡æ•°ï¼Œå¦‚æœè®¡æ•°å°äºç­‰äº1ï¼Œåˆ™ç§»é™¤è®¡æ•°ï¼Œå¦‚æœâ‰¤0ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼›æœ€åå†è®©countè‡ªå‡ä¸€3.è¿›å…¥æ­»å¾ªç¯CASæ›´æ–°åŒæ­¥çŠ¶æ€","link":"/posts/20200207-reentrant_read_write_lock.html"},{"title":"äºŒå‰æŸ¥æ‰¾æ ‘ï¼ˆBSTï¼‰---javaå®ç°","text":"ä¸€ã€å®šä¹‰äºŒå‰æŸ¥æ‰¾æ ‘ï¼ˆBSTï¼‰æ˜¯ä¸€é¢—äºŒå‰æ ‘ï¼Œå…¶æ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½æ¯”å·¦å­©å­çš„ä»»æ„èŠ‚ç‚¹å¤§ï¼Œæ¯”å³å­©å­çš„ä»»æ„èŠ‚ç‚¹å°ã€‚ æœ€åæƒ…å†µä¸‹è¿è¡Œæ—¶é—´çš„å¢é•¿æ•°é‡çº§ï¼šæŸ¥æ‰¾ï¼š Næ’å…¥ï¼š Nå¹³å‡æƒ…å†µä¸‹ï¼šæŸ¥æ‰¾å‘½ä¸­ï¼š1.39lgNæ’å…¥ï¼š 1.39lgNæ”¯æŒæœ‰åºæ€§ç›¸å…³æ“ä½œ äºŒã€æ•°æ®ç»“æ„1234567891011121314151617181920212223242526public class BinarySearchTree&lt;T extends Comparable&lt;? super T&gt;&gt; { private TreeNode&lt;T&gt; root; public BinarySearchTree(TreeNode&lt;T&gt; root) { this.root = root; }}class TreeNode&lt;T&gt;{ T data; TreeNode lchild; TreeNode rchild; public TreeNode(T data) { this(data,null,null); } public TreeNode(T data, TreeNode lchild, TreeNode rchild) { this.data = data; this.lchild = lchild; this.rchild = rchild; }} ä¸‰ã€containsæ–¹æ³•å¦‚æœè¯¥æ ‘å­˜åœ¨æ•°æ®Xåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚æˆ‘ä»¬åªéœ€è¦ä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹å°äºXï¼Œåˆ™å‘å·¦é€’å½’ï¼Œå¦åˆ™å‘å³é€’å½’ï¼Œç›´åˆ°æ‰¾åˆ°Xæˆ–åˆ°è¾¾æ ‘çš„æœ€åã€‚ 1234567891011121314151617public boolean contains(T x){ return contains(x,root); } private boolean contains(T x, TreeNode&lt;T&gt; root) { if (root==null){ return false; } int result=x.compareTo(root.data); if (result&lt;0){ return contains(x,root.lchild); }else if (result&gt;0){ return contains(x,root.rchild); }else { return true; } } å››ã€æŸ¥æ‰¾æœ€å°å€¼å’Œæœ€å¤§å€¼ä¸€é¢—äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå…¶æœ€å°å€¼ä¸€å®šæ˜¯æŒ‰å·¦å­æ ‘é€’å½’æ‰¾åˆ°ï¼Œç›´åˆ°æ ‘åº•1.å¦‚æœæ ¹èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™è¿”å›ç©º2.å¦‚æœå·¦å­æ ‘ä¸ºç©ºï¼Œåˆ™è¿”å›æ ¹èŠ‚ç‚¹3.å¦åˆ™ä»å·¦å­©å­å¼€å§‹ï¼Œç»§ç»­ä»1é€’å½’ã€‚ 123456789public TreeNode&lt;T&gt; findMax(TreeNode&lt;T&gt; root){ if (root==null){ return null; } while (root.rchild!=null){ root=root.rchild; } return root; } æŸ¥æ‰¾æœ€å¤§å€¼åˆ™ç›¸åï¼Œä»æ ¹èŠ‚ç‚¹å‘å³å­æ ‘å¾ªç¯æŸ¥æ‰¾ã€‚ 123456789public TreeNode&lt;T&gt; findMax(TreeNode&lt;T&gt; root){ if (root==null){ return null; } while (root.rchild!=null){ root=root.rchild; } return root; } äº”ã€æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹åŒæ ·å¯ä»¥ä½¿ç”¨containsé‚£ç§é€’å½’çš„æ–¹å¼ã€‚å¦‚æœæ‰¾åˆ°Xï¼Œåˆ™èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼›å¦åˆ™å°±æ’å…¥åˆ°éå†è·¯å¾„ä¸Šçš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚ 123456789101112131415161718192021public TreeNode&lt;T&gt; insert(T x){ if (x==null){ throw new IllegalArgumentException(\"å‚æ•°ä¸ºç©º\"); } return insert(x,root); } private TreeNode&lt;T&gt; insert(T x,TreeNode&lt;T&gt; t){ //å½“å‰èŠ‚ç‚¹ä¸ºç©ºï¼Œæ„å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ’å…¥x if (t==null){ return new TreeNode&lt;&gt;(x); } int result=x.compareTo(t.data); if (result&lt;0){ //å‘å·¦é€’å½’ t.lchild=insert(x,t.lchild); }else if (result&gt;0){ //å‘å³é€’å½’ t.rchild=insert(x,t.rchild); } return t; } å…­ã€åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤èŠ‚ç‚¹Xå¤§è‡´å¯åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š å¦‚æœXæ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥åˆ é™¤ å¦‚æœXæœ‰ä¸€ä¸ªå­©å­ï¼Œåˆ™å°†é‚£ä¸ªå­©å­æ”¾åœ¨å½“å‰èŠ‚ç‚¹ä½ç½® å¦‚æœXæœ‰ä¸¤ä¸ªå­©å­ï¼Œåˆ™æ‰¾åˆ°å³å­©å­ä¸­æœ€å°çš„ä¸€ä¸ªèŠ‚ç‚¹Yï¼Œæ”¾åˆ°å¾…åˆ é™¤èŠ‚ç‚¹Xçš„ä½ç½®ï¼Œè¿™æ ·Xçš„å·¦å­©å­ä»¬ä»ç„¶æ¯”å®ƒå°ï¼Œç°åœ¨åªéœ€è¦ç”¨åŒæ ·çš„æ–¹å¼åˆ é™¤å³å­©å­çš„Yå³å¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536public void remove(T x){ if (x==null){ return; } remove(x,root); } /** * åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ * 1.å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥åˆ é™¤ * 2.å¦‚æœæœ‰ä¸€ä¸ªå­©å­ï¼Œè®©å½“å‰èŠ‚ç‚¹ç­‰äºé‚£ä¸ªå­©å­ * 3.å¦‚æœæœ‰ä¸¤ä¸ªå­©å­ï¼Œè®©å½“å‰èŠ‚ç‚¹çš„å€¼ç­‰äºå³å­©å­ä¸­æœ€å°çš„ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼ï¼Œç„¶åå†åŒæ ·çš„æ–¹æ³•åˆ é™¤å³å­©å­æœ€å°å€¼çš„èŠ‚ç‚¹ * @param x * @param root * @return */ private TreeNode&lt;T&gt; remove(T x,TreeNode&lt;T&gt;root){ if (root==null){ return null; } int result=x.compareTo(root.data); if (result&lt;0){ root.lchild=remove(x,root.lchild); }else if (result&gt;0){ root.rchild=remove(x,root.rchild); }else if (root.lchild!=null&amp;&amp;root.rchild!=null){ //æ‰¾åˆ°å¾…åˆ é™¤èŠ‚ç‚¹ï¼Œä¸”æœ‰ä¸¤ä¸ªå­©å­ //è®©å½“å‰èŠ‚ç‚¹å€¼ç­‰äºå³å­©å­æœ€å°çš„èŠ‚ç‚¹å€¼ root.data= (T) findMin(root.rchild).data; //åœ¨å³å­©å­ä¸­åˆ é™¤ä¸Šä¸€æ­¥æ‰¾åˆ°çš„æœ€å°çš„å€¼ root.rchild=remove(root.data,root.rchild); }else { root=root.lchild==null?root.rchild:null; } return root; } æ±‚èŠ‚ç‚¹çš„é«˜åº¦å°±å¾ˆç®€å•äº†ï¼š 123456public int height(TreeNode&lt;T&gt; root){ if (root==null){ return -1; } return 1+Math.max(height(root.lchild),height(root.rchild)); } æ€»ç»“ï¼šä½¿ç”¨äºŒå‰æŸ¥æ‰¾æ ‘çš„è¿è¡Œæ—¶é—´å–å†³äºæ ‘çš„å½¢æ€ï¼Œè€Œæ ‘çš„å½¢æ€åˆå–å†³äºæ•°æ®è¢«æ’å…¥çš„é¡ºåºã€‚å› æ­¤æœ€å¥½çš„æƒ…å†µä¸‹æ˜¯ä¸€é¢—å®Œå…¨äºŒå‰æ ‘ï¼›ä½†æœ€åæƒ…å†µä¸‹ï¼Œæœç´¢è·¯å¾„ä¸Šæœ‰Nä¸ªèŠ‚ç‚¹ï¼Œå³å·¦å³èŠ‚ç‚¹éƒ½åœ¨ä¸€æ¡è·¯å¾„ä¸‹æ’å¼€ã€‚","link":"/posts/20200310-bst.html"},{"title":"AVLæ ‘çš„åŸç†è®²è§£-------javaå®ç°","text":"å‰é¢è®²åˆ°äº†äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œè™½ç„¶èƒ½å¤Ÿå¾ˆå¥½çš„åº”ç”¨äºå¤§å¤šæ•°çš„åœºæ™¯ï¼Œä½†æ˜¯ä»–ä»¬åœ¨æœ€åæƒ…å†µä¸‹æ€§èƒ½è¿˜æ˜¯å¾ˆå·®çš„ï¼Œå¦‚äºŒå‰æŸ¥æ‰¾æ ‘æœ€åæƒ…å†µä¸‹æ˜¯ä¸€é¢—é«˜åº¦ä¸ºNçš„æ ‘ï¼Œæ˜¾ç„¶ä¸åˆ©äºæŸ¥æ‰¾ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦è®©æŸ¥æ‰¾æ ‘ä¿æŒä¸€ç§å¹³è¡¡ï¼Œå¦‚äºŒå‰æŸ¥æ‰¾æ ‘æœ€ä¼˜æƒ…å†µçš„çŠ¶æ€ä¸€æ ·ã€‚ ä¸€ã€AVLæ ‘åŸºç¡€AVLæ ‘æ˜¯ä¸€é¢—ä¿æŒå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œä¿è¯äº†æ ‘çš„æ·±åº¦ä¸ºO(logN)ã€‚å…¶æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦éƒ½æœ€å¤šç›¸å·®1ä¸Šå›¾å°±æ˜¯ä¸€é¢—AVLæ ‘ï¼Œå…¶ä»»æ„èŠ‚ç‚¹çš„å·¦å­©å­å’Œå³å­©å­çš„é«˜åº¦å·®ä¸è¶…è¿‡1ã€‚ ä½†æ˜¯å½“æˆ‘ä»¬æ’å…¥æˆ–åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¾ˆå®¹æ˜“ç ´åAVLæ ‘çš„å¹³è¡¡åº¦ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§æ“ä½œï¼Œåœ¨æ’å…¥æˆ–åˆ é™¤å®Œæˆå‰é‡æ–°å¯¹æ ‘è¿›è¡Œå¹³è¡¡ï¼Œæ¢å¤AVLæ ‘çš„æ€§è´¨ï¼Œè¿™ç§æ“ä½œå°±æ˜¯æ—‹è½¬ã€‚ å‡è®¾å¾…å¹³è¡¡èŠ‚ç‚¹ä¸º Aï¼Œåˆ™ä¸å¹³è¡¡çš„æ¡ä»¶å°±æ˜¯A çš„ä¸¤é¢—å­æ ‘çš„é«˜åº¦å·®ä¸º2ï¼Œå› æ­¤å°±ä¼šå‡ºç°å››ç§æƒ…å†µï¼Œé’ˆå¯¹ä¸åŒæƒ…å†µæˆ‘ä»¬åšä¸åŒçš„æ—‹è½¬æ“ä½œï¼š 1.åœ¨Açš„å·¦å­©å­çš„å·¦å­æ ‘è¿›è¡Œæ’å…¥ ï¼ˆå•æ—‹è½¬ï¼Œå‘å³æ—‹è½¬ï¼‰ 2.åœ¨Açš„å·¦å­©å­çš„å³å­æ ‘è¿›è¡Œæ’å…¥ ï¼ˆåŒæ—‹è½¬ï¼Œå…ˆå·¦ï¼Œå†å³ï¼‰ 3.åœ¨Açš„å³å­©å­çš„å·¦å­æ ‘è¿›è¡Œæ’å…¥ ï¼ˆåŒæ—‹è½¬ï¼Œå…ˆå³å†å·¦ï¼‰ 4.åœ¨Açš„å³å­©å­çš„å³å­æ ‘è¿›è¡Œæ’å…¥ ï¼ˆå•æ—‹è½¬ï¼Œå‘å·¦æ—‹è½¬ï¼‰ æƒ…å†µ1ï¼šå¦‚ä¸‹å›¾å·¦æ ‘ï¼Œæ’å…¥äº†ä¸€ä¸ªèŠ‚ç‚¹Gåï¼Œåœ¨Aç‚¹å¤„å¤±å»äº†å¹³è¡¡ï¼ˆè¿™é‡Œæ ‘çš„èŠ‚ç‚¹æ— æ„ä¹‰ï¼Œéšæ„å–çš„ï¼Œåªå…³æ³¨å¹³è¡¡æ€§å³å¯ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨Aå¤„å°†æ ‘å‘å³æ—‹è½¬ï¼Œå˜æˆå³è¾¹çš„æ ‘ï¼Œå¯ä»¥æƒ³è±¡æˆç”¨æ‰‹æç€Bï¼Œå°†å…¶æèµ·æ¥ï¼Œç„¶åå°†Bçš„å³å­©å­å˜ä¸ºAçš„å·¦å­©å­å¯¹åº”ä»£ç å¦‚ä¸‹ï¼šå³æ—‹è½¬å°±å…ˆè·å–å…¶å·¦å­©å­left1.nodeçš„å·¦å­©å­å˜ä¸ºleftçš„å³å­©å­2.leftçš„å³å­©å­å˜ä¸ºnode3.é‡æ–°è®¡ç®—nodeå’Œleftçš„é«˜åº¦ 12345678910111213/** * å•æ—‹è½¬(å³æ—‹è½¬)(æƒ…å½¢1) * @param node * @return */ private AVLNode&lt;T&gt;rotateRight(AVLNode&lt;T&gt; node){ AVLNode&lt;T&gt; left=node.left; node.left=left.right; left.right=node; node.height=Math.max(height(node.left),height(node.right))+1; left.height=Math.max(height(node.left),node.height)+1; return left; } æƒ…å†µ4ï¼šå¦‚ä¸‹å›¾1ï¼Œåœ¨Açš„å³å­©å­çš„å³å­æ ‘æ’å…¥äº†èŠ‚ç‚¹Gï¼Œæ­¤æ—¶åœ¨AèŠ‚ç‚¹å¤±å»äº†å¹³è¡¡ï¼Œå› æ­¤åœ¨Aå¤„å‘å·¦æ—‹è½¬ï¼ŒåŸç†åŒæƒ…å†µ1ã€‚å®ç°å¦‚ä¸‹ï¼šå·¦æ—‹è½¬å°±å…ˆè·å–å…¶å³å­©å­right1.nodeçš„å³å­©å­å˜ä¸ºrightçš„å·¦å­©å­2.rightçš„å·¦å­©å­å˜ä¸ºnode3.é‡æ–°è®¡ç®—nodeå’Œrightçš„é«˜åº¦ 12345678910111213/** * å•æ—‹è½¬(å·¦æ—‹è½¬)(æƒ…å½¢4) * @param node * @return */ private AVLNode&lt;T&gt; rotateLeft(AVLNode&lt;T&gt; node){ AVLNode&lt;T&gt; right=node.right; node.right=right.left; right.left=node; node.height=Math.max(height(node.left),height(node.right))+1; right.height=Math.max(node.height,height(right.right))+1; return right; } æƒ…å†µ2ï¼šå¦‚ä¸‹å›¾1ï¼Œåœ¨Açš„å·¦å­©å­Bçš„å³å­æ ‘æ’å…¥äº†èŠ‚ç‚¹Dåï¼Œåœ¨Aå¤„å¤±å»äº†å¹³è¡¡ï¼Œå› æ­¤éœ€è¦å…ˆå¯¹å…¶å·¦å­©å­Bè¿›è¡Œå·¦æ—‹è½¬ï¼Œå˜æˆäº†å›¾2ï¼Œä¸éš¾å‘ç°å›¾2çš„æƒ…å†µå°±æ˜¯æƒ…å†µ1ï¼Œå› æ­¤æˆ‘ä»¬åªè¦å†å¯¹Aè¿›è¡Œå³æ—‹è½¬å°±å¯ä»¥æ¢å¤æ ‘çš„å¹³è¡¡æ€§ã€‚ä¹‹æ‰€ä»¥ä¼šå˜æˆæƒ…å†µ1ï¼Œæ˜¯å› ä¸ºå¯¹Bè¿›è¡Œå·¦æ—‹è½¬åï¼ŒæŒ‰ç…§å·¦æ—‹è½¬çš„ç‰¹ç‚¹ï¼Œä¼šå°†Bçš„å³å­æ ‘Gæå‡ä¸€ä¸ªé«˜åº¦åˆ°Bçš„ä½ç½®ï¼ŒBè‡ªç„¶å°±ä¼šä¸‹å»ä¸€ä¸ªé«˜åº¦ï¼Œå†åŠ ä¸Šä¸€ä¸ªæ–°çš„Gï¼Œè‡ªç„¶ä¹Ÿå°±å˜æˆäº†æƒ…å†µ1ã€‚å¦‚ä¸‹å›¾3ï¼Œå¯¹Aè¿›è¡Œå³æ—‹è½¬åï¼Œæ ‘å·²æ¢å¤å¹³è¡¡ã€‚å®ç°å¦‚ä¸‹ï¼šæœ‰äº†æƒ…å†µ1å’Œæƒ…å†µ4çš„åŸºç¡€ï¼Œå†å®ç°æƒ…å†µ2å°±å¾ˆç®€å•ï¼š1.å…ˆå¯¹Açš„å·¦å­©å­å·¦æ—‹è½¬2.å†å¯¹Aè¿›è¡Œå³æ—‹è½¬ 123456789/** * åŒæ—‹è½¬(å…ˆå·¦åå³)(é’ˆå¯¹æƒ…å½¢2) * @param node * @return */ private AVLNode&lt;T&gt; doubleLeftAndRight(AVLNode&lt;T&gt; node){ node.left=rotateLeft(node.left); return rotateRight(node); } æƒ…å†µ3ï¼šå¦‚å›¾1ï¼Œåœ¨Açš„å³å­©å­çš„å·¦å­æ ‘åŠ äº†ä¸€ä¸ªèŠ‚ç‚¹Dï¼Œé€ æˆAå¤„å¤±å»å¹³è¡¡ï¼Œå› æ­¤å…ˆå¯¹Eè¿›è¡Œå³æ—‹è½¬å˜æˆå›¾2ï¼Œæ­¤æ—¶å˜æˆæƒ…å†µ4ï¼Œå†å¯¹Aè¿›è¡Œå·¦æ—‹è½¬å˜æˆå›¾3ï¼Œå°±æ¢å¤äº†å¹³è¡¡ã€‚å®ç°å¦‚ä¸‹ï¼š 123456789/** * åŒæ—‹è½¬(å…ˆå³å†å·¦) (é’ˆå¯¹æƒ…å½¢3) * @param node * @return */ private AVLNode&lt;T&gt; doubleRightAndLeft(AVLNode&lt;T&gt; node){ node.right=rotateRight(node.right); return rotateLeft(node); } æœ‰äº†ä¸Šé¢çš„åŸºç¡€ï¼Œå†å¯¹AVLæ ‘æ“ä½œå°±ä¸å›°éš¾äº†ã€‚ äºŒã€æ•°æ®ç»“æ„ä¹Ÿæ˜¯ä¸€ä¸ªå·¦å­©å­ï¼Œä¸€ä¸ªå³å­©å­ï¼Œä¸€ä¸ªæ•°æ®åŸŸï¼Œå¤–åŠ ä¸€ä¸ªå½“å‰èŠ‚ç‚¹çš„é«˜åº¦ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Key-Valueç»“æ„ï¼ŒæŒ‰Keyè¿›è¡Œæ„é€ æ ‘ï¼Œä¸€ä¸ªkeyå…³è”ä¸€ä¸ªvalueï¼Œè¿™é‡Œç®€å•ä½¿ç”¨äº†ä¸€ä¸ªæ³›å‹T 1234567891011121314151617181920212223242526272829public class AVLTree&lt;T extends Comparable&lt;? super T&gt;&gt; { private AVLNode&lt;T&gt; root; //èŠ‚ç‚¹çš„å·¦å³å­©å­é«˜åº¦å·®ä¸èƒ½è¶…è¿‡è¯¥å€¼ private static final int HEIGHT_DIFFERENCE=1; public AVLTree(AVLNode&lt;T&gt; root) { this.root = root; }} class AVLNode&lt;T&gt;{ AVLNode(T t){ this(t,null,null); } AVLNode(T data,AVLNode&lt;T&gt; lt,AVLNode&lt;T&gt; rt){ this.data=data; left=lt; right=rt; this.height=0; } T data; AVLNode&lt;T&gt; left; AVLNode&lt;T&gt; right; int height;} AVLæ ‘è¿”å›æœ€å¤§å€¼æœ€å°å€¼ä»¥åŠcontainsæ–¹æ³•åŒä¸Šä¸€ç¯‡äºŒå‰æŸ¥æ‰¾æ ‘ç›¸åŒï¼Œä¸èµ˜è¿°ã€‚ ä¸‰ã€æ’å…¥ä¸€ä¸ªå…ƒç´ 123456789101112131415161718192021public void insert(T data){ if (data==null){ throw new IllegalArgumentException(\"æ•°æ®ä¸ºç©º\"); } root= insert(data, this.root); } private AVLNode&lt;T&gt; insert(T data,AVLNode&lt;T&gt; t){ if (t==null){ return new AVLNode&lt;&gt;(data,null,null); } int compareResult=data.compareTo(t.data); if (compareResult&lt;0){ t.left=insert(data,t.left); }else if (compareResult&gt;0){ t.right=insert(data,t.right); }else { ; } return balance(t); } å¯ä»¥çœ‹å‡ºï¼Œé™¤äº†æœ€åä¸€è¡Œï¼Œå…¶ä½™éƒ¨åˆ†åŒäºŒå‰æŸ¥æ‰¾æ ‘ç›¸åŒã€‚æ¯æ¬¡insert()è°ƒç”¨åï¼Œéƒ½è¦å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œé‡æ–°å¹³è¡¡ï¼Œå³å½“æ‰¾åˆ°æ’å…¥çš„èŠ‚ç‚¹åï¼ŒæŒ‰é€’å½’è°ƒç”¨æ ˆçš„é¡ºåºï¼Œå¯¹è·¯å¾„ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œé‡æ–°å¹³è¡¡ã€‚balance()èŠ‚ç‚¹å¹³è¡¡ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940/** * å¯¹èŠ‚ç‚¹tè¿›è¡Œå¹³è¡¡ * @param t * @return */ private AVLNode&lt;T&gt; balance(AVLNode&lt;T&gt; t) { if (t==null){ return null; } if (height(t.left)-height(t.right)&gt;HEIGHT_DIFFERENCE){ //å·¦è¾¹é«˜ if (height(t.left.left)&gt;=height(t.left.right)){ //å·¦å­æ ‘çš„å·¦å­æ ‘é«˜ //æ­¤ä¸ºæƒ…å½¢1ï¼Œåœ¨å·¦å­æ ‘çš„å·¦å­æ ‘æ’å…¥äº†å…ƒç´ ï¼Œç›´æ¥å³æ—‹è½¬ t=rotateRight(t); }else { //å·¦å­æ ‘çš„å³å­æ ‘é«˜ //æ­¤ä¸ºæƒ…å½¢2ï¼Œåœ¨å·¦å­æ ‘çš„å³å­æ ‘æ’å…¥äº†å…ƒç´ ï¼Œå…ˆå·¦æ—‹è½¬å†å³æ—‹è½¬ t=doubleLeftAndRight(t); } }else if (height(t.right)-height(t.left)&gt;HEIGHT_DIFFERENCE){ //å³è¾¹é«˜ if (height(t.right.left)&gt;height(t.right.right)){ //å³å­æ ‘çš„å·¦å­æ ‘é«˜äº† //æ­¤ä¸ºæƒ…å½¢3ï¼Œåœ¨å³å­æ ‘çš„å·¦å­æ ‘æ’å…¥äº†å…ƒç´ ï¼Œå…ˆå³æ—‹è½¬å†å·¦æ—‹è½¬ t=doubleRightAndLeft(t); }else { //å³å­æ ‘çš„å³å­æ ‘é«˜ //æ­¤ä¸ºæƒ…å½¢4ï¼Œåœ¨å³å­æ ‘çš„å³å­æ ‘æ’å…¥äº†å…ƒç´ ï¼Œç›´æ¥å·¦æ—‹è½¬ t=rotateLeft(t); } } //é‡æ–°è®¡ç®—è¯¥èŠ‚ç‚¹çš„é«˜åº¦ t.height=Math.max(height(t.left),height(t.right))+1; return t; } private int height(AVLNode&lt;T&gt; t){ return t==null?-1:t.height; } å››ã€åˆ é™¤ä¸€ä¸ªå…ƒç´ é€»è¾‘åŒäºŒå‰æŸ¥æ‰¾æ ‘ï¼ŒåŒæ’å…¥ä¸€æ ·ï¼Œéœ€è¦åœ¨æ¯æ¬¡removeè°ƒç”¨åå¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œå¹³è¡¡ã€‚ 1234567891011121314151617181920212223242526272829/** * åˆ é™¤æ•°æ® * @param x */ public void remove( T x ) { root = remove( x, root ); } private AVLNode&lt;T&gt; remove(T data,AVLNode&lt;T&gt; root){ if (root==null){ return null; } int compareResult=data.compareTo(root.data); if (compareResult&lt;0){ root.left=remove(data,root.left); }else if (compareResult&gt;0){ root.right=remove(data,root.right); }else if (root.left!=null&amp;&amp;root.right!=null){ //å¾…åˆ é™¤èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­©å­ root.data=findMin(root).data; root.right=remove(root.data,root.right); }else { //å¾…åˆ é™¤èŠ‚ç‚¹æ²¡æœ‰å­©å­æˆ–æœ‰ä¸€ä¸ªå­©å­ root=root.left==null?root.right:root.left; } //é‡æ–°å¹³è¡¡æ ‘ return balance(root); } æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸­åºéå†è¿”å›AVLæ ‘çš„èŠ‚ç‚¹é˜Ÿåˆ—ï¼š 12345678910111213141516171819202122/** * è¿”å›æ•°æ®é˜Ÿåˆ— * @return */ public Queue&lt;T&gt;iterator(){ if (isEmpty()){ return null; }else { Queue&lt;T&gt;queue=new Queue&lt;&gt;(); return iterator(root,queue); } } private Queue&lt;T&gt; iterator( AVLNode&lt;T&gt; t,Queue&lt;T&gt; queue ) { if( t != null ) { iterator( t.left,queue ); queue.enqueue(t.data); iterator( t.right, queue); } return queue; } æµ‹è¯•ï¼š 12345678910111213141516171819202122232425public static void main(String[] args) { AVLTree&lt;Integer&gt; avlTree = new AVLTree&lt;&gt;(new AVLNode&lt;&gt;(1)); avlTree.insert(2); avlTree.insert(3); avlTree.insert(4); avlTree.insert(5); avlTree.insert(6); avlTree.insert(7); avlTree.insert(15); avlTree.insert(16); avlTree.insert(14); //ä¸­åºéå†æ‰“å° avlTree.printTree(); System.out.println(\"==========åˆ é™¤èŠ‚ç‚¹15=========\"); avlTree.remove(15); Queue&lt;Integer&gt; queue = avlTree.iterator(); while (!queue.isEmpty()){ System.out.println(queue.dequeue()); } Integer max = avlTree.findMax(); System.out.println(\"æœ€å¤§å…ƒç´ :\"+max); System.out.println(\"èŠ‚ç‚¹17æ˜¯å¦å­˜åœ¨\"+avlTree.contains(17)); } ç»“æœï¼š 123456789101112131415161718192021221234567141516==========åˆ é™¤èŠ‚ç‚¹15=========12345671416æœ€å¤§å…ƒç´ :16èŠ‚ç‚¹17æ˜¯å¦å­˜åœ¨false æ€»ç»“ï¼šAVLæ ‘æ€»ä½“ä¸Šçš„å®ç°å’ŒäºŒå‰æŸ¥æ‰¾æ ‘ç›¸åŒï¼Œåªæ˜¯ä¸ºäº†é‡æ–°è®©æ ‘æ¢å¤å¹³è¡¡éœ€è¦åœ¨é€’å½’è°ƒç”¨ä¸­å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œbalance()ã€‚AVLæ ‘çš„æŸ¥æ‰¾ã€æ’å…¥æˆ–åˆ é™¤ï¼Œæœ€åçš„æƒ…å†µä¸‹çš„å¤æ‚åº¦å‡ä¸ºO(log(n))ï¼Œä½†å¦‚æœæ•°æ®é‡å¾ˆå¤§æ—¶ï¼ŒAVLæ ‘çš„ç»¼åˆæ€§èƒ½ç•¥é€Šäºå¦ä¸€ç§å¹³è¡¡æ ‘â€”-çº¢é»‘æ ‘ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸€ç¯‡è®²åˆ°ã€‚","link":"/posts/20200310-avltree.html"},{"title":"ã€Šç®—æ³•4ã€‹å½’å¹¶æ’åº---------javaå®ç°","text":"å½’å¹¶æ’åºé‡‡ç”¨åˆ†æ²»ç­–ç•¥å®ç° å¹³å‡æ—¶é—´å¤æ‚åº¦ : Oï¼ˆnlognï¼‰ æœ€å·®æ—¶é—´å¤æ‚åº¦: O(nlogn) ç¨³å®šæ€§ï¼š ç¨³å®š ç©ºé—´å¤æ‚åº¦ï¼šO(n) å½’å¹¶æ’åºæ—¶ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ’åºæ–¹æ³•ï¼Œç©ºé—´æ¶ˆè€—å¾ˆå¤§ï¼Œä¸€èˆ¬å†…éƒ¨æ’åºä½¿ç”¨å¿«é€Ÿæ’åºè¾ƒå¤š å‡è®¾æœ‰è¿™æ ·ä¸€ç»„æ•°æ®ï¼š[10,4,8,7,1,3,2,9] æˆ‘ä»¬å…ˆä»‹ç»è‡ªé¡¶å‘ä¸‹çš„å½’å¹¶æ’åº ä¸€ã€åˆ†) å¦‚ä¸Šå°†8ä¸ªæ•°ç»„åˆ†æˆ8ä¸ªå•ç‹¬çš„æ•°æ® äºŒã€åˆ1.å°† 10å’Œ 4åˆå¹¶ ) 2.å°†8å’Œ7åˆå¹¶ ) 3. å°†4,10å’Œ7,8åˆå¹¶ )ã€ 4.åŒæ ·å°†å³åŠéƒ¨åˆ†ä¹ŸæŒ‰æ­¤åˆå¹¶å¾—åˆ°å¦‚ä¸‹ä¸¤ç»„æ•°æ® ) 5.æœ€åå°†ä¸¤ç»„æ•°æ®åˆå¹¶åœ¨ä¸€èµ· ) ä¸‰ã€ä»£ç å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596package com.wml.sort;import java.util.Arrays;/** * @author * @date 2019/10/2919:17 */public class MergeSort { private static int CUTOFF = 15; public static &lt;T extends Comparable&lt;? super T&gt;&gt; void mergeSort(T[] arr) { T[] temp = (T[]) new Comparable[arr.length]; mergeSort(arr, temp, 0, arr.length - 1); } /** * è‡ªé¡¶å‘ä¸‹å½’å¹¶æ’åº é•¿åº¦ä¸ºNçš„æ•°ç»„ï¼Œéœ€è¦1/2NlogNåˆ°NlgNæ¬¡æ¯”è¾ƒ * @param arr * @param temp * @param left * @param right * @param &lt;T&gt; */ private static &lt;T extends Comparable&lt;? super T&gt;&gt; void mergeSort(T[] arr, T[] temp, int left, int right) { if (left &lt; right) { //System.out.println(\"sort(arr,\" + left + \",\" + right + \")\"); int mid = (left + right) / 2; mergeSort(arr, temp, left, mid); mergeSort(arr, temp, mid + 1, right); merge(arr, temp, left, mid + 1, right); } } /** * åˆå¹¶ä¸¤ç»„æ•°æ® * @param arr åŸå§‹æ•°ç»„ * @param temp ä¸´æ—¶æ•°ç»„ * @param leftStart å·¦åŠéƒ¨åˆ†å¼€å§‹ä½ç½® * @param rightStart å³åŠéƒ¨åˆ†å¼€å§‹ä½ç½® * @param rightEnd å³åŠéƒ¨åˆ†ç»“æŸä½ç½® * @param &lt;T&gt; */ private static &lt;T extends Comparable&lt;? super T&gt;&gt; void merge(T[] arr, T[] temp, int leftStart, int rightStart, int rightEnd) { // System.out.println(\"merge(arr,temp,\" + leftStart + \",\" + rightStart + \",\" + rightEnd + \")\"); //è®¡ç®—å·¦åŠéƒ¨åˆ†è¾¹ç•Œ int leftEnd = rightStart - 1; //ä¸´æ—¶æ•°ç»„å½“å‰ä½ç½®çš„æŒ‡é’ˆ int tempCurrent = leftStart; //è®¡ç®—å¾…åˆå¹¶æ•°ç»„çš„æ€»é•¿åº¦ int length = rightEnd - leftStart + 1; //å½“ä»»æ„ä¸€è¾¹æ•°æ®æ‹·è´å®Œæ¯•ç»“æŸå¾ªç¯ while (leftStart &lt;= leftEnd &amp;&amp; rightStart &lt;= rightEnd) { if (arr[leftStart].compareTo(arr[rightStart]) &lt;= 0) { temp[tempCurrent++] = arr[leftStart++]; } else { temp[tempCurrent++] = arr[rightStart++]; } } //å¦‚æœæ˜¯å·¦è¾¹çš„æœªæ‹·è´å®Œæ¯•ï¼Œåˆ™ç»§ç»­å°†å·¦è¾¹å‰©ä¸‹çš„æ‹·è´åˆ°ä¸´æ—¶æ•°ç»„ while (leftStart &lt;= leftEnd) { temp[tempCurrent++] = arr[leftStart++]; } //å¦‚æœæ˜¯å³è¾¹çš„æœªæ‹·è´å®Œæ¯•ï¼Œåˆ™ç»§ç»­å°†å³è¾¹å‰©ä¸‹çš„æ‹·è´åˆ°ä¸´æ—¶æ•°ç»„ while (rightStart &lt;= rightEnd) { temp[tempCurrent++] = arr[rightStart++]; } for (int i = 0; i &lt; length; i++, rightEnd--) { arr[rightEnd] = temp[rightEnd]; } }public static void main(String[] args) { /* Integer[]arr=new Integer[8000000]; Random random=new Random(); for (int i = 0; i &lt; 8000000; i++) { arr[i]= random.nextInt(8000000); } long begin=System.currentTimeMillis(); System.out.println(begin); mergeSort(arr); long end=System.currentTimeMillis(); System.out.println(end); System.out.println(end-begin);*/ Integer[]arr={4,12,4,25,12,524,12,12,25,346,21,346,47,587,96,4534,21,56,8,78,9,2,12}; mergeSort(arr); for (Integer o:arr){ System.out.println(o); } } } ç»“æœï¼š ä»¥ä¸‹æ‰§è¡Œåœ°åŠ¨æ€æƒ…å†µå¯ä»¥çœ‹å‡ºå½’å¹¶æ’åºçš„é€’å½’è¿‡ç¨‹ï¼ŒåŠ æ·±ç†è§£ï¼š 123456789101112131415161718192021222324489121212121221212525475678963463465245874534 ç®—æ³•ç¬¬å››ç‰ˆç»™å‡ºå¦‚ä¸‹ç»“è®ºï¼š å¯¹äºé•¿åº¦ä¸ºNçš„ä»»æ„æ•°ç»„ï¼Œè‡ªé¡¶å‘ä¸‹çš„å½’å¹¶æ’åºéœ€è¦1/2NlgNåˆ°NlogNæ¬¡æ¯”è¾ƒã€‚ ä¸”æœ€å¤šéœ€è¦è®¿é—®ç»„æ•°6NlgNæ¬¡ æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å¯¹è¯¥ç®—æ³•è¿›è¡Œä¸€å®šçš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨è§„æ¨¡è¾ƒå°çš„æ•°ç»„æ’åºæ—¶ï¼Œä½¿ç”¨æ’å…¥æ’åºæ›´å¿«é€Ÿäº›ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨æ•°ç»„è§„æ¨¡å°äº15æ—¶è®©å…¶æ‰§è¡Œæ’å…¥æ’åºã€‚å¦å¤–å¯¹äºä¸¤ä¸ªå¾…åˆå¹¶æ•°ç»„ï¼Œå¦‚æœa[mid]&lt;=a[mid+1]ï¼Œå³å·¦è¾¹ä¸€ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ å°äºç­‰äºå³è¾¹ä¸€ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥ä¸å¯¹å…¶è¿›è¡Œmergeï¼Œå› ä¸ºè¿™ä¸¤ç»„æ•°æ®å·²ç»æ˜¯æœ‰åºçš„äº†ã€‚ ä¿®æ”¹åçš„mergeSortå¦‚ä¸‹ï¼š 123456789101112131415161718private static &lt;T extends Comparable&lt;? super T&gt;&gt; void mergeSort(T[] arr, T[] temp, int left, int right) { if (left &lt; right) { //å°äºCUTOFF=15æ—¶ï¼Œè¿›è¡Œ æ’å…¥æ’åº if (right-left&lt;CUTOFF){ InsertSort.insertSort(arr,left,right); } System.out.println(\"sort(arr,\" + left + \",\" + right + \")\"); int mid = (left + right) / 2; mergeSort(arr, temp, left, mid); mergeSort(arr, temp, mid + 1, right); //å¦‚æœå·¦åŠè¾¹æœ€åä¸€ä¸ªå…ƒç´ å¤§äºå³åŠè¾¹ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶æ‰è¿›è¡Œåˆå¹¶ if (arr[mid].compareTo(arr[mid + 1]) &gt; 0) { merge(arr, temp, left, mid + 1, right); } } } ä¸‰ã€è‡ªåº•å‘ä¸Šçš„å½’å¹¶æ’åºè‡ªåº•å‘ä¸Šçš„å½’å¹¶æ’åºæ€æƒ³æ˜¯ï¼š å…ˆå½’å¹¶å¾®å‹æ•°ç»„ï¼Œå†æˆå¯¹å½’å¹¶å¾—åˆ°çš„å­æ•°ç»„ï¼Œç›´åˆ°å°†æ•´ä¸ªæ•°ç»„å½’å¹¶åœ¨ä¸€èµ·ã€‚ æµç¨‹å°±æ˜¯ï¼š 1.å°†æ¯ä¸ªå…ƒç´ å½“åšå¤§å°ä¸º1çš„æ•°ç»„ï¼Œä¸¤ä¸¤å½’å¹¶ 2.ç„¶åå†å››ä¸ªå››ä¸ªå½’å¹¶ 3.å†å…«ä¸ªå…«ä¸ªå½’å¹¶ 4.ç›´åˆ°å½’å¹¶å®Œæ¯• 1234567891011121314151617181920212223242526272829303132/** * è‡ªåº•å‘ä¸Š * @param arr åŸå§‹æ•°ç»„ * @param temp ä¸´æ—¶æ•°ç»„ * @param &lt;T&gt; */ private static &lt;T extends Comparable&lt;? super T&gt;&gt; void mergeSort(T[] arr, T[] temp) { int N = arr.length; //ä¸€å¼€å§‹ä¸¤ä¸¤æ¯”è¾ƒï¼Œgapä¸º1ï¼Œä¹‹åæ¯æ¬¡éƒ½æ‰©å¤§ä¸€å€ for (int gap = 1; gap &lt; N; gap *= 2) { //æ•°ç»„å¤§å°å°äºCUTOFFæ—¶ï¼Œè¿›è¡Œæ’å…¥æ’åº if (gap &lt; CUTOFF) { for (int left = 0; left &lt; N - gap; left += gap + gap) { int right = Math.min(left + gap + gap - 1, N - 1); InsertSort.insertSort(arr, left, right); } } else { //å¯¹0åˆ°N-gapè¿›è¡Œæ’åºï¼Œgapä¸º1ï¼Œå°±æ˜¯ä¸¤ä¸¤æ’åºï¼Œgapä¸º2ï¼Œå°±æ˜¯å››å››æ’åº for (int left = 0; left &lt; N - gap; left += gap*2) { //è®¡ç®—å½“å‰å¾…åˆå¹¶æ•°ç»„çš„å³è¾¹ç•Œä½ç½®ï¼Œå¦‚æœåŸå§‹æ•°ç»„æœ€åä¸€ç»„æ•°æ®ä¸å¤Ÿ2*gapï¼Œåˆ™left+gap*2å°±ä¼šè¶Šç•Œï¼Œå…¶çœŸå®çš„è¾¹ç•Œåº”å½“æ˜¯N-1 int right = Math.min(left + gap*2 - 1, N - 1); //åŒè‡ªé¡¶å‘ä¸‹ï¼Œè‹¥å¾…åˆå¹¶çš„æ•°æ®å·²ç»æ˜¯æœ‰åºçš„ï¼Œåˆ™ä¸è¿›è¡Œåˆå¹¶ if (arr[left + gap - 1].compareTo(arr[left + gap]) &gt; 0) { merge(arr, temp, left, left + gap, right); } } } } } æš‚æ—¶å»æ‰ä¼˜åŒ–çš„éƒ¨åˆ†ï¼ŒåŒæ ·å¯¹è¯¥ç®—æ³•çš„è°ƒç”¨è¿›è¡Œæ‰“å°è¾“å‡ºï¼ˆä»ç”¨è‡ªé¡¶å‘ä¸‹å½’å¹¶çš„æ•°æ®ï¼‰ï¼š gap=1æ—¶ï¼Œä¸¤ä¸¤æ’åº *merge(arr,temp,0,1,1) * â€‹ *merge(arr,temp,2,3,3) * â€‹ *merge(arr,temp,4,5,5) * â€‹ *merge(arr,temp,6,7,7) * â€‹ *merge(arr,temp,8,9,9) * â€‹ merge(arr,temp,10,11,11) â€‹ *merge(arr,temp,12,13,13) * â€‹ *merge(arr,temp,14,15,15) * â€‹ *merge(arr,temp,16,17,17) * â€‹ *merge(arr,temp,18,19,19) * â€‹ merge(arr,temp,20,21,21) gap=2æ—¶ï¼Œå››ä¸ªå››ä¸ªæ’åº*merge(arr,temp,0,2,3) * â€‹ *merge(arr,temp,4,6,7) * â€‹ *merge(arr,temp,8,10,11) * â€‹ merge(arr,temp,12,14,15) â€‹ merge(arr,temp,16,18,19) â€‹ merge(arr,temp,20,22,22) gap=4æ—¶ï¼Œå…«ä¸ªå…«ä¸ªæ’åº*merge(arr,temp,0,4,7) * â€‹ merge(arr,temp,8,12,15) â€‹ *//æ­¤æ—¶å³åŠè¾¹åªæœ‰7ä¸ªæ•°æ®ï¼Œå› æ­¤right=N-1=23-1=22 * â€‹ merge(arr,temp,16,20,22) gap=8æ—¶ï¼Œ16ä¸ªä¸€ç»„æ’åºmerge(arr,temp,0,8,15) gap=16æ—¶ï¼Œæ­¤æ—¶å·¦åŠè¾¹ä¸º0-15ï¼Œå³åŠè¾¹ä¸º16-22ï¼Œåˆå¹¶ä¹‹merge(arr,temp,0,16,22)24489121212121221212525475678963463465245874534 å¯¹äºé•¿åº¦ä¸ºNçš„ä»»æ„æ•°ç»„ï¼Œè‡ªåº•å‘ä¸Šçš„å½’å¹¶æ’åºä¸€æ ·éœ€è¦1/2NlgNåˆ°NlogNæ¬¡æ¯”è¾ƒã€‚ ä¸”æœ€å¤šéœ€è¦è®¿é—®ç»„æ•°6NlgNæ¬¡ å½“æ•°ç»„é•¿åº¦ä¸º2çš„å¹‚æ—¶ï¼Œä¸¤ç§å½’å¹¶æ–¹å¼æ‰€ç”¨çš„æ¯”è¾ƒæ¬¡æ•°å’Œæ•°ç»„è®¿é—®æ¬¡æ•°æ­£å¥½ç›¸åŒï¼Œåªæ˜¯é¡ºåºä¸åŒã€‚ è€Œè‡ªåº•å‘ä¸Šçš„å½’å¹¶æ›´é€‚åˆæ¯”è¾ƒé“¾è¡¨ç»“æ„çš„æ•°æ®ã€‚åªéœ€è¦é‡æ–°ç»„ç»‡é“¾è¡¨çš„é“¾æ¥å°±å¯ä»¥åŸåœ°æ’åºï¼Œè€Œä¸éœ€è¦åˆ›å»ºä»»ä½•æ–°çš„èŠ‚ç‚¹ã€‚","link":"/posts/20200107-mergeSort.html"},{"title":"ã€Šç®—æ³•4ã€‹æ•£åˆ—è¡¨å®ç°ç¬”è®°","text":"ä¸€ã€æ•£åˆ—å‡½æ•°æ•£åˆ—å‡½æ•°ä¼šå°†é”®è½¬ä¸ºæ•°ç»„çš„ç´¢å¼•ã€‚æˆ‘ä»¬çš„æ•£åˆ—å‡½æ•°åº”è¯¥è®¡ç®—é€Ÿåº¦å¿«ä¸”èƒ½å¤Ÿå‡åŒ€åˆ†å¸ƒæ‰€æœ‰çš„é”®ï¼Œå¦‚å¯¹äºå¤§å°ä¸ºMçš„æ•£åˆ—è¡¨ï¼Œæˆ‘ä»¬çš„æ•£åˆ—å‡½æ•°åº”å½“èƒ½å¤Ÿè®©ä»»æ„çš„keyéƒ½èƒ½å¤Ÿè½¬åŒ–ä¸º 0-åˆ°M-1 çš„æ•´æ•°ï¼Œå¯¹äºä¸åŒçš„é”®åº”è¯¥æœ‰ä¸åŒçš„æ•£åˆ—å‡½æ•°ã€‚Javaä¸­è®¸å¤šå¸¸ç”¨çš„ç±»éƒ½é‡å†™äº†hashCodeæ–¹æ³•ï¼Œä»¥é’ˆå¯¹ä¸åŒçš„æ•°æ®ç±»å‹ä½¿ç”¨ä¸åŒçš„æ•£åˆ—å‡½æ•°ã€‚ äºŒã€åŸºäºæ‹‰é“¾æ³•çš„æ•£åˆ—è¡¨æ•£åˆ—ç®—æ³•ç†æƒ³çš„çŠ¶æ€æ˜¯å°†ä¸åŒçš„keyéƒ½è½¬ä¸ºä¸åŒçš„ç´¢å¼•å€¼ï¼Œä½†è¿™æ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ï¼Œä¸€å®šä¼šäº§ç”Ÿå†²çªï¼Œå› æ­¤æˆ‘ä»¬å°±éœ€è¦å¯¹å†²çªè¿›è¡Œå¤„ç†ã€‚ä¸€ç§ç›´æ¥çš„æ–¹æ³•æ˜¯å°†å¤§å°ä¸ºMçš„æ•°ç»„ä¸­çš„æ¯ä¸ªç´¢å¼•æŒ‡å‘ä¸€æ¡é“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨äº†æ•£åˆ—å€¼ä¸ºè¯¥é“¾è¡¨æ‰€åœ¨ç´¢å¼•å€¼çš„é”®å€¼å¯¹ï¼Œè¿™ç§æ–¹æ³•å°±æ˜¯æ‹‰é“¾æ³•ã€‚ å¦‚ä¸‹æ˜¯åŸºæœ¬æ•°æ®ç»“æ„ï¼š 123456789101112131415161718192021222324public class SeparateChainingHashST&lt;Key,Value&gt; { /** * é”®å€¼å¯¹æ€»æ•° */ private int N; /** * æ•£åˆ—è¡¨å¤§å° */ private int M; private SequentialSearchST&lt;Key,Value&gt;[] st; public SeparateChainingHashST() { this(997); } public SeparateChainingHashST(int M) { this.M=M; st=new SequentialSearchST[M]; for (int i = 0; i &lt; M; i++) { //æ•°ç»„ä¸­æ¯ä¸ªç´¢å¼•å€¼éƒ½åˆå§‹åŒ–ä¸€ä¸ªé“¾è¡¨ st[i]=new SequentialSearchST&lt;&gt;(); } }} SequentialSearchSTæ˜¯å‰é¢é¡ºåºæŸ¥æ‰¾ä¸­å®ç°çš„æ— åºé“¾è¡¨ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697ublic class SequentialSearchST&lt;Key, Value&gt; { /** * é¦–èŠ‚ç‚¹ */ private Node first; private int size; private class Node { private Key key; private Value value; private Node next; public Node(Key key, Value value, Node next) { this.key = key; this.value = value; this.next = next; } } /** * æ ¹æ®keyæŸ¥è¯¢å¯¹åº”çš„å€¼ï¼Œä¸€ä¸ªä¸ªå¾€ä¸‹éå†ç›´åˆ°æ‰¾åˆ°ç›¸ç­‰çš„keyï¼Œè¿”å›å¯¹åº”çš„å€¼ï¼Œå¦åˆ™è¿”å›null * @param key * @return */ public Value get(Key key) { for (Node x = first; x != null; x = x.next) { if (key.equals(x.key)) { return x.value; } } return null; } /** * åŠ å…¥ä¸€ä¸ªå…ƒç´  * @param key * @param value */ public void put(Key key, Value value) { for (Node x = first; x != null; x = x.next) { //keyå·²å­˜åœ¨ï¼Œæ›´æ–°å¯¹åº”çš„å€¼ if (key.equals(x.key)) { x.value = value; return; } } //keyä¸å­˜åœ¨ï¼Œæ–°æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ first = new Node(key, value, first); size++; } public boolean isEmpty() { return size == 0; } private int size() { return size; } public boolean contains(Key key) { if (key == null) throw new IllegalArgumentException(\"argument to contains() is null\"); return get(key) != null; } /** * åˆ é™¤keyå¯¹åº”çš„èŠ‚ç‚¹ * @param key */ public void delete(Key key) { if (key == null) throw new IllegalArgumentException(\"argument to delete() is null\"); first = delete(first, key); } /** * é€’å½’æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸ç­‰çš„keyï¼Œæ­£å¸¸åˆ é™¤é“¾è¡¨èŠ‚ç‚¹ * @param x * @param key * @return */ private Node delete(Node x, Key key) { if (x == null) return null; if (key.equals(x.key)) { size--; return x.next; } x.next = delete(x.next, key); return x; } public Iterable&lt;Key&gt; keys() { Queue&lt;Key&gt; queue=new Queue&lt;&gt;(); while (first!=null){ queue.enqueue(first.key); first=first.next; } return queue; }} hashè®¡ç®—ï¼šä¸Šé¢è¯´äº†ï¼Œjavaä¸­ä¸ºæ‰€æœ‰æ•°æ®ç±»å‹éƒ½é‡å†™äº†hashCode()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª32ä½æ¯”ç‰¹çš„æ•´æ•°ï¼Œä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯æ•°ç»„çš„ç´¢å¼•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†é»˜è®¤çš„hashCodeæ–¹æ³•å’Œé™¤ç•™ä½™æ•°æ³•ç»“åˆèµ·æ¥äº§ç”Ÿä¸€ä¸ª0åˆ°M-1çš„æ•´æ•°ï¼Œåˆå› ä¸ºhashCodeè¿”å›çš„å€¼æ˜¯å¸¦æœ‰ç¬¦å·ä½çš„ï¼Œè¿™æ ·å°±ç®—å¯¼è‡´è®¡ç®—ç»“æœå‡ºç°è´Ÿæ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡0x7fffffffå˜ä¸ºä¸€ä¸ª31ä½çš„éè´Ÿæ•´æ•°ï¼Œå†ä½¿ç”¨é™¤ç•™ä½™æ•°æ³•è®©å…¶%Mï¼ŒMä¸ºä¸€ä¸ªè¾ƒå¤§çš„è´¨æ•°ã€‚ 123private int hash(Key key){ return (key.hashCode() &amp; 0x7fffffff) % M; } è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ’å…¥ã€åˆ é™¤å’Œè·å–äº†ï¼šæ’å…¥å®ç°ï¼šå¦‚ä¸‹ï¼Œå…ˆè®¡ç®—keyçš„å“ˆå¸Œå€¼ï¼Œå¾—åˆ°ä¸€ä¸ªæ•°ç»„çš„ç´¢å¼•ï¼Œç„¶åå°†è¯¥é”®å€¼å¯¹æ’å…¥åˆ°è¯¥ç´¢å¼•å¯¹åº”çš„é“¾è¡¨ä¸­ã€‚ 12345678910111213public void put(Key key,Value value){ if (key==null){ throw new NoSuchElementException(\"keyä¸ºç©º\"); } if (value==null){ delete(key); } //ä¿è¯é“¾è¡¨çš„é•¿åº¦åœ¨2åˆ°8ä¹‹é—´ if (N&gt;=8*M){ resize(M*2); } st[hash(key)].put(key,value); } åˆ é™¤å®ç°ï¼šå…ˆè®¡ç®—keyçš„å“ˆå¸Œå€¼ï¼Œæ‰¾åˆ°å…¶æ‰€åœ¨çš„é“¾è¡¨ï¼Œå¦‚æœè¯¥é“¾è¡¨ä¸­æœ‰è¯¥keyï¼Œå…¶åˆ é™¤ä¹‹ã€‚ 12345678910111213141516171819202122/** * åˆ é™¤æŒ‡å®šé”®å€¼å¯¹ * @param key */ public void delete(Key key) { if (key == null) throw new IllegalArgumentException(\"argument to delete() is null\"); int i = hash(key); if (st[i].contains(key)){ N--; } st[i].delete(key); //ä¿è¯é“¾è¡¨å¹³å‡é•¿åº¦åœ¨2åˆ°8é—´ æ­¤ä¸ºä¸‹ç•Œ2 if (N&gt;0 &amp;&amp; N&lt;=M*2){ resize(M/2); } }public boolean contains(Key key) { if (key == null) throw new IllegalArgumentException(\"keyä¸ºç©º\"); return get(key) != null; } è·å–å€¼ï¼šè®¡ç®—keyçš„å“ˆå¸Œå€¼ï¼Œ è¿”å›å¯¹åº”é“¾è¡¨ä¸­çš„value 12345public Value get(Key key){ if (key == null) return null; return st[hash(key)].get(key); } æˆ‘ä»¬ä½¿ç”¨Mæ¡é“¾è¡¨å­˜å‚¨Nä¸ªé”®ï¼Œæ— è®ºé”®åœ¨è¡¨ä¸­å¦‚ä½•åˆ†å¸ƒï¼Œå…¶å¹³å‡é•¿åº¦ä¸€å®šæ˜¯ N/Mã€‚ä½¿ç”¨æ‹‰é“¾æ³•çš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¦‚æœå­˜å…¥çš„é”®å¤šä¸é¢„æœŸï¼ŒæŸ¥æ‰¾çš„æ—¶é—´åªä¼šæ¯”é€‰æ‹©æ›´å¤§çš„æ•°ç»„é•¿ï¼›å¦‚æœä½äºé¢„æœŸï¼Œè™½ç„¶ä¼šé€ æˆä¸€ç‚¹ç©ºé—´æµªè´¹ï¼Œä½†æŸ¥æ‰¾å¾ˆå¿«ã€‚å› æ­¤å†…å­˜è¶³å¤Ÿæ—¶ï¼Œå¯é€‰æ‹©è¶³å¤Ÿå¤§çš„Mï¼Œè®©æŸ¥æ‰¾ä½¿ç”¨å˜ä¸ºå¸¸æ•°ï¼›å½“å†…å­˜ç´§å¼ æ—¶ï¼Œé€‰æ‹©å°½é‡å¤§çš„Mä»èƒ½å¤Ÿå°†æ€§èƒ½æé«˜Må€ã€‚ åŠ¨æ€è°ƒæ•´æ•°ç»„ï¼šåœ¨åˆ é™¤åï¼Œå¦‚æœå¹³å‡é•¿åº¦N/Mä½äº2ï¼Œåˆ™è®©æ•°ç»„ç¼©å° ä¸€å€ï¼šM/2;åœ¨åŠ å…¥ä¸€ä¸ªæ•°æ®åï¼Œå¦‚æœ N/M é«˜äº8ï¼Œåˆ™è®©æ•°ç»„å¢åŠ ä¸€å€ï¼š M*2 12345678910111213private void resize(int capacity){ SeparateChainingHashST&lt;Key,Value&gt;hashST=new SeparateChainingHashST&lt;&gt;(capacity); for (int i = 0; i &lt; M; i++) { for (Key key:st[i].keys()){ if (key!=null){ hashST.put(key,st[i].get(key)); } } } this.M=hashST.M; this.N=hashST.N; this.st=hashST.st; } ä¸‰ã€åŸºäºçº¿æ€§æ¢æµ‹æ³•çš„æ•£åˆ—è¡¨å®ç°æ•£åˆ—è¡¨çš„å¦ä¸€ç§æ–¹å¼æ˜¯ç”¨å¤§å°ä¸ºMçš„æ•°ç»„ä¿å­˜Nä¸ªé”®å€¼å¯¹ï¼ˆM&gt;Nï¼‰ï¼Œå€ŸåŠ©ç©ºä½è§£å†³ç¢°æ’å†²çªï¼ŒåŸºäºè¿™ç§ç­–ç•¥çš„æ‰€æœ‰æ–¹æ³•éƒ½æˆä¸ºå¼€æ”¾åœ°å€æ•£åˆ—è¡¨ã€‚å¼€æ”¾åœ°å€æ•£åˆ—è¡¨æœ€ç®€å•çš„æ–¹æ³•æ˜¯çº¿æ€§æ¢æµ‹æ³•ï¼Œå³å¦‚æœäº§ç”Ÿå†²çªï¼ˆä¸€ä¸ªé”®çš„æ•£åˆ—å€¼å·²ç»è¢«å¦ä¸€ä¸ªä¸åŒçš„é”®å ç”¨ï¼‰ï¼Œåˆ™ç›´æ¥æ£€æŸ¥æ•£åˆ—è¡¨çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼ˆç´¢å¼•+1ï¼‰ï¼Œå¦‚æœè¿˜æ˜¯å†²çªï¼Œåˆ™ä¸€ç›´å‘åæ¢æµ‹ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªç©ºä½ç½®ï¼Œå°†è¯¥é”®å€¼å¯¹æ’å…¥è¿›å»ã€‚æ•°æ®ç»“æ„å¦‚ä¸‹ï¼šè¿™é‡Œä½¿ç”¨ä¸€ä¸ªKey[]ä¿å­˜é”®ï¼Œä¸€ä¸ªValues[]ä¿å­˜keyå¯¹åº”çš„å€¼ 12345678910111213141516171819public class LinearProbingHashST&lt;Key, Value&gt; { private Key[] keys; private Value[] values; /** * é”®å€¼å¯¹æ•° */ private int N; /** * çº¿æ€§è¡¨å¤§å° */ private int M; public LinearProbingHashST(int M) { this.M = M; keys = (Key[]) new Object[this.M]; values = (Value[]) new Object[this.M]; }} æ’å…¥æ“ä½œï¼šæˆ‘ä»¬éœ€è¦è®¡ç®—å¾…æ’å…¥çš„é”®çš„hashå€¼ï¼Œç„¶ååˆ¤æ–­å½“å‰ç´¢å¼•æ˜¯å¦è¢«å…¶ä»–é”®å ç”¨ï¼Œå¦‚æœè¢«å ç”¨çš„é”®ä¹Ÿæ˜¯å¾…æ’å…¥çš„é”®ï¼Œåˆ™ä¿®æ”¹å¯¹åº”çš„å€¼ï¼Œå¦åˆ™ä¸€ç›´éå†ä¸‹å»ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªç©ºä½ç½®ã€‚ 12345678910111213141516171819202122232425public void put(Key key, Value value) { if (key == null) throw new IllegalArgumentException(\"first argument to put() is null\"); if (value==null){ delete(key); } //ä¿è¯ä½¿ç”¨ç‡ N/M å°äºç­‰äº 1/2 ï¼Œå½“ä½¿ç”¨ç‡è¶‹è¿‘äº1æ—¶ï¼Œæ¢æµ‹çš„æ¬¡æ•°ä¼šå˜å¾—å¾ˆå¤§ if (N&gt;=M*2){ resize(M*2); } int i; for (i = hash(key); keys[i] != null; i = (i + 1) % M) { if (keys[i].equals(key)) { //å¾…æ’å…¥çš„keyå­˜åœ¨ï¼Œä¿®æ”¹å¯¹åº”çš„å€¼å¹¶è¿”å› values[i] = value; return; } } //æ‰¾åˆ°ç©ºä½ç½®ï¼Œæ’å…¥é”®å€¼å¯¹ keys[i] = key; values[i] = value; N++;} private int hash(Key key) { return (key.hashCode() &amp; 0x7fffffff) % M;} æŸ¥è¯¢æ“ä½œï¼šè®¡ç®—keyçš„å“ˆå¸Œå€¼ï¼Œå¦‚æœå½“å‰ä½ç½®å†²çªï¼ˆè¢«å…¶ä»–keyå ç”¨ï¼‰ï¼Œåˆ™ç»§ç»­å‘åéå†ï¼Œéå†çš„ç»“æŸæ¡ä»¶æ˜¯ä»hash(key)åˆ°ä¸‹ä¸€ä¸ªnullä½ç½®å‰ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å¯¹åº”çš„valueï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›null 12345678public Value get(Key key) { for (int i = hash(key); keys[i] != null; i = (i + 1) % M) { if (keys[i].equals(key)) { return values[i]; } } return null; } å¯¹äºå¦‚ä¸‹ä¸€ä¸ªæ•£åˆ—è¡¨ï¼š 1230 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15P M A C S H L E R X10 9 8 4 0 5 11 12 3 7 Açš„æ•£åˆ—å€¼æ˜¯4ï¼ŒHçš„æ•£åˆ—å€¼ä¹Ÿæ˜¯4ï¼Œä½†å› ä¸ºåœ¨4å†²çªï¼Œæ‰€ä»¥æ’å…¥Hçš„æ—¶å€™è¢«çº¿æ€§ç§»åŠ¨åˆ°äº†7ä½ç½®ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æŸ¥æ‰¾Hå¯¹åº”çš„å€¼çš„æ—¶å€™ï¼Œå…ˆä»ç´¢å¼•4å¼€å§‹ï¼Œä¸åŒ¹é…ï¼Œé¡ºæ¬¡å‘ä¸‹æŸ¥æ‰¾ï¼Œå¦‚æœåœ¨ç©ºä½ç½®9ä¹‹å‰è¿˜æ²¡æ‰¾åˆ°ï¼Œè¯´æ˜ä¸å­˜åœ¨Hï¼Œä½†å› ä¸ºHåœ¨9ä¹‹å‰çš„7ä½ç½®ï¼Œç´¢å¼•è¿”å›å¯¹åº”çš„å€¼5.åˆ é™¤æ“ä½œï¼šå¯¹äºåˆ é™¤æ“ä½œï¼Œæˆ‘ä»¬ä¸å¯ä»¥ç›´æ¥å°†å¯¹åº”çš„keyç½®ä¸ºnullã€‚åŒæ ·æ˜¯ä¸Šé¢çš„æ•£åˆ—è¡¨ï¼Œå‡å¦‚åˆ é™¤Cï¼Œè€ŒHçš„æ•£åˆ—å€¼ä¸º4ï¼Œåœ¨çº¿æ€§æ¢æµ‹çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå› ä¸ºç´¢å¼•5ä¸ºç©ºï¼Œè€Œâ€œé”™è¯¯â€çš„è®¤ä¸ºæ•£åˆ—è¡¨ä¸­ä¸å­˜åœ¨Hè€Œè¿”å›nullï¼Œä½†äº‹å®æ˜¯Hå­˜åœ¨ï¼Œå¹¶ä¸”åœ¨ç´¢å¼•7ä¸­ã€‚ å› æ­¤åœ¨åˆ é™¤ç»™å®škeyåï¼Œéœ€è¦å°†key+1åˆ°ä¸‹ä¸€ä¸ªç©ºä½ç½®å‰çš„æ‰€æœ‰é”®é‡æ–°æ’å…¥æ•£åˆ—è¡¨ï¼Œä»¥é¿å…ä¸Šè¿°é”™è¯¯çš„å‘ç”Ÿã€‚ 1234567891011121314151617181920212223242526272829public void delete(Key key) { if (!contains(key)) { return; } int i=hash(key); //çº¿æ€§æ¢æµ‹æ‰¾åˆ°å¾…åˆ é™¤çš„keyçš„ç´¢å¼• while (!keys[i].equals(key)){ i=(i+1)%M; } //ç½®ç©º keys[i]=null; values[i]=null; //å°†i+1çš„ä½ç½®åˆ°ä¸‹ä¸€ä¸ªç©ºä½ç½®å‰çš„æ‰€æœ‰keyé‡æ–°æ’å…¥åˆ°æ•£åˆ—è¡¨ä¸­ i=(i+1)%M; while (keys[i]!=null){ Key oldKey=keys[i]; Value oldValue=values[i]; keys[i]=null; values[i]=null; N--; put(oldKey,oldValue); i=(i+1)%M; } N--; if (N&gt;0 &amp;&amp; N &lt;= M/8){ resize(M/2); } } å¦Î±= N/M ï¼Œæˆ‘ä»¬ç§°Î±ä¸ºæ•£åˆ—è¡¨çš„ä½¿ç”¨ç‡åœ¨ã€Šç®—æ³•4ã€‹ä¸­ç»™å‡ºäº†å¦‚ä¸‹ç»“è®ºï¼š åœ¨ä¸€å¼ å¤§å°ä¸ºMå¹¶å«æœ‰Nä¸ªé”®çš„åŸºäºçº¿æ€§æ¢æµ‹çš„æ•£åˆ—è¡¨ä¸­ï¼Œå¦‚æœæˆ‘ä»¬çš„æ•£åˆ—å‡½æ•°èƒ½å¤Ÿå‡åŒ€å¹¶ç‹¬ç«‹åœ°å°†æ‰€æœ‰çš„é”®åˆ†å¸ƒåœ¨0åˆ°M-1ä¹‹é—´ï¼Œåˆ™å‘½ä¸­å’Œæœªå‘½ä¸­çš„æŸ¥æ‰¾æ‰€éœ€çš„æ¢æµ‹æ¬¡æ•°åˆ†åˆ«ä¸ºï¼š 1 / 2(1 + 1 / 1âˆ’Î±) and 1/2 ( 1 + 1 / (1âˆ’Î±) ^ 2) å³å½“æ•£åˆ—è¡¨å¿«æ»¡çš„æ—¶å€™ï¼ŒæŸ¥æ‰¾æ‰€éœ€çš„æ¢æµ‹æ¬¡æ•°æ˜¯å·¨å¤§çš„ï¼ˆÎ±è¶‹è¿‘äº1ï¼‰ï¼Œä½†å½“ä½¿ç”¨ç‡Î± &lt; 1/2æ—¶ï¼Œæ¢æµ‹çš„é¢„è®¡æ¬¡æ•°åªåœ¨1.5åˆ°2.5ä¹‹é—´ï¼Œå› æ­¤æˆ‘ä»¬è¦ä¿è¯ Î±çš„å€¼ä¸å¤§äº 1/2ã€‚åŸºäºæ­¤æˆ‘ä»¬è¦åœ¨æ’å…¥å‰å’Œåˆ é™¤åå¯¹æ•°ç»„è¿›è¡ŒåŠ¨æ€è°ƒæ•´ï¼š æ’å…¥å‰åˆ¤æ–­ï¼š 1234//ä¿è¯ä½¿ç”¨ç‡ N/M ä¸èƒ½è¶…è¿‡1/2 ï¼Œå½“ä½¿ç”¨ç‡è¶‹è¿‘äº1æ—¶ï¼Œæ¢æµ‹çš„æ¬¡æ•°ä¼šå˜å¾—å¾ˆå¤§if (N&gt;=M*2){ resize(M*2);} åˆ é™¤ååˆ¤æ–­ï¼šä¿è¯ä½¿ç”¨çš„å†…å­˜é‡å’Œè¡¨ä¸­çš„é”®å€¼å¯¹æ•°é‡çš„æ¯”ä¾‹æ€»åœ¨ä¸€å®šèŒƒå›´å†…ã€‚ 1234 //æ•°ç»„å‡å°ä¸€åŠï¼Œå¦‚æœN/M ä¸º12.5% æˆ–æ›´å°‘if (N&gt;0 &amp;&amp; N &lt;= M/8){ resize(M/2); }","link":"/posts/20200310-seq-linear-hash.html"},{"title":"ã€Šç®—æ³•4ã€‹ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ç¬”è®°-----javaå®ç°","text":"ä¸€ã€å‰è¨€å‰é¢å·²ç»è®²äº†ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå †ï¼‰çš„å®ç°ï¼Œhttps://wbml.top/posts/20200310-HeapPQ.htmlï¼Œä½†æ˜¯å…¶å¾ˆæ˜æ˜¾æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯æ— æ³•ç›´æ¥è®¿é—®å·²ç»åœ¨é˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œæ›´æ–°æˆ–æ˜¯åˆ é™¤å®ƒä»¬ï¼Œåœ¨Dijistraç®—æ³•ä¸­å°±éå¸¸éœ€è¦æ­¤æ€§è´¨ï¼Œå› æ­¤è¦è§£å†³æ­¤é—®é¢˜å°±éœ€ç”¨åˆ°ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ— äºŒã€ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—æ•°æ®ç»“æ„è®²è§£ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ä½¿ç”¨ä¸€ä¸ªint[] pqæ•°ç»„ä½œä¸ºç´¢å¼•é˜Ÿåˆ—ï¼Œ ä¿å­˜å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œä½¿ç”¨T[] keysæ•°ç»„ä¿å­˜å¯¹è±¡å…³è”çš„å€¼ï¼Œä½¿ç”¨int[] qpè¡¨ç¤ºå¯¹è±¡åœ¨ç´¢å¼•é˜Ÿåˆ—pqä¸­çš„ä½ç½®ã€‚ å¦‚æœ‰è¿™æ ·ä¸€ç»„æ•°æ®ï¼š 123456780 -&gt; f1 -&gt; a3 -&gt; c5 -&gt; r7 -&gt; g10-&gt; iæˆ‘ä»¬å°†0,1,3,5,7,10ç§°ä¸ºæ•°æ®å¯¹è±¡çš„ç´¢å¼• å¯¹åº”çš„pqã€qpä»¥åŠkeysæ•°ç»„å°±æ˜¯ï¼š 1234 0 1 2 3 4 5 6 7 8 9 10pq: 1 3 0 7 10 5qp: 2 0 1 5 3 4keys: f a c r g i å¯ä»¥çœ‹åˆ°keys[i] ï¼š iå°±æ˜¯æ•°æ®å¯¹è±¡ç´¢å¼•ï¼Œkeys[i] å°±æ˜¯ä¸ä¹‹å…³è”çš„å€¼ keys[0]=f,keys[1]=aqp[i] : å¯¹è±¡ç´¢å¼•åœ¨ç´¢å¼•é˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼Œqp[0]=2 ,å¯¹è±¡ç´¢å¼• 0 åœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®ä¸º2pq[i] : å³æŒ‰ç…§å¯¹åº”ç´¢å¼•å…³è”çš„å€¼è¿›è¡Œæ’åºï¼Œå¦‚aæ˜¯æ‰€æœ‰å…ƒç´ ä¸­æœ€å°çš„ï¼Œå› æ­¤å…¶ç´¢å¼•1åœ¨pqä¸­çš„ä½ç½®å°±æ˜¯0ï¼Œæ’åœ¨ç¬¬ä¸€ä½ ç”»å‡ºå¯¹åº”çš„äºŒå‰æ ‘ä¼šæ›´å®¹æ˜“ç†è§£ï¼šèŠ‚ç‚¹å¤–è¾¹çš„å°±æ˜¯pqçš„ä¸‹æ ‡jï¼ŒèŠ‚ç‚¹ä¸­çš„æ•°å­—å°±æ˜¯å¯¹è±¡ç´¢å¼•å³pq[j]çš„å€¼ï¼ŒèŠ‚ç‚¹ä¸­çš„å­—ç¬¦å°±æ˜¯ ç´¢å¼•å…³è”çš„å¯¹è±¡ï¼Œä¿å­˜åœ¨keysä¸­ å› æ­¤å¯¹äº 1-&gt;a è¿™æ ·ä¸€ä¸ªæ•°æ®ï¼Œç”¨ i è¡¨ç¤ºå…¶ç´¢å¼•1åˆ™æœ‰ä»¥ä¸‹å…³ç³»ï¼š ä»¤x=qp[i]åˆ™pq[x]=ikeys[pq[x]]=akeys[i] = apq[qp[i]] = i æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839public class IndexMinPQ&lt;Key extends Comparable&lt;? super Key&gt;&gt; implements Iterable&lt;Integer&gt; { /** * ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—,ä¿å­˜å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼ŒæŒ‰ç´¢å¼•å€¼(å³keys[i],iä¸ºç´¢å¼•)è¿›è¡Œå°å †æ’åº */ private int[] pq; /** * pqçš„é€†åº,ä¿å­˜å¯¹è±¡ç´¢å¼•åœ¨pqä¸­çš„ä½ç½® */ private int[] qp; /** * é˜Ÿåˆ—æœ€å¤§å…ƒç´ æ•° */ private int maxSize; /** * å½“å‰é˜Ÿåˆ—å…ƒç´ æ•°é‡ */ private int currentSize; /** * å…·ä½“å…ƒç´  */ private Key[] keys; public IndexMinPQ(int maxSize) { if (maxSize&lt;0){ throw new IllegalArgumentException(\"å‚æ•°éæ³•\"); } this.maxSize = maxSize; pq=new int[maxSize + 1 ]; qp=new int[maxSize + 1]; keys= (Key[]) new Comparable[maxSize+1]; currentSize=0; for (int i = 0; i &lt; maxSize + 1; i++) { //qp åˆå§‹åŒ–ä¸º-1 ï¼Œè¡¨ç¤ºæ²¡æœ‰ç´¢å¼•å…³è”çš„å¯¹è±¡ qp[i] = -1; } }} è¿™æ ·å°±å¯ä»¥å¾—åˆ°å‡ ä¸ªå¸¸ç”¨çš„æ–¹æ³•ï¼š keyOf(int i) è¿”å›ç´¢å¼• i å…³è”çš„éœ€ 12345public Key keyOf(int i){ checkIndex(i); if (!contains(i))throw new NoSuchElementException(\"ä¸å­˜åœ¨è¯¥ç´¢å¼•\"); return keys[i]; } minIndex() è¿”å›æœ€å°çš„ç´¢å¼• 12345678910/** * è¿”å›æœ€å°çš„ç´¢å¼•ï¼Œå³ç´¢å¼•é˜Ÿåˆ—pq[1]å¯¹åº”çš„ç´¢å¼•å¯¹è±¡ * @return */ public int minIndex(){ if (isEmpty()){ throw new NoSuchElementException(\"é˜Ÿåˆ—ä¸ºç©º\"); } return pq[1]; } contains(int index) ï¼šç´¢å¼•indexæ˜¯å¦åŒ…å«åœ¨é˜Ÿåˆ—ä¸­ï¼Œå³indexæ˜¯å¦å…³è”äº†å¯¹è±¡ 12345678910public boolean contains(int index){ checkIndex(index); //å¦‚æœå­˜åœ¨ï¼Œåˆ™qp[index]ä¸€å®šä¸ä¸º-1ï¼Œä¸”æŒ‡å‘ è¯¥å¯¹è±¡indexåœ¨ ç´¢å¼•é˜Ÿåˆ—pqä¸­çš„ä½ç½® return qp[index] != -1; } private void checkIndex(int index){ if (index&lt;0 || index&gt;= maxSize){ throw new IndexOutOfBoundsException(\"å‚æ•°è¶Šç•Œ\"); } } ä¸‰ã€æ’å…¥æ“ä½œåŒä¼˜å…ˆé˜Ÿåˆ—æ€æƒ³ç±»ä¼¼ã€‚è‹¥æ’å…¥ä¸€å¯¹æ•°æ®ä¸ºï¼š index -&gt; keyè¿™é‡Œé¦–å…ˆå°†å¯¹è±¡ç´¢å¼•indexä¿å­˜åœ¨ä¼˜å…ˆé˜Ÿåˆ—pqçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆå…ˆè®©currentSize+1ï¼‰ï¼Œå› æ­¤ qp[index] = currentSizeï¼Œpq[currentSize]=indexï¼Œkeys[index]=key`ï¼Œæ¥ç€ä»ä¼˜å…ˆé˜Ÿåˆ—pqçš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå³åˆšåˆšåŠ å…¥çš„èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œä¸Šæ»¤æ“ä½œï¼ˆåŒå †æ’åºä¸­çš„ä¸Šæ»¤åŸºæœ¬ç›¸åŒï¼‰ï¼Œä½†è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸Šæ»¤çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”è¾ƒçš„æ˜¯ keys[pq[i]]ï¼Œå³æ¯”è¾ƒçš„æ˜¯ç´¢å¼•indexå…³è”çš„å€¼keyï¼Œå‘ç”Ÿäº¤æ¢æ—¶ä¸å…‰è¦äº¤æ¢pqçš„å€¼ï¼Œè¿˜è¦æ›´æ–°qpçš„å€¼ã€‚å®ç°å¦‚ä¸‹ï¼šæ’å…¥ï¼š 1234567891011121314151617181920/** * æ’å…¥ä¸€å¯¹å€¼ * @param index ç´¢å¼• * @param key ç´¢å¼•å…³è”çš„å€¼ */ public void insert(int index,Key key){ checkIndex(index); if (contains(index)){ throw new IllegalArgumentException(\"ç´¢å¼•\"+index+\"å·²å­˜åœ¨\"); } //å¢åŠ å…ƒç´ æ•° currentSize++; //å½“å‰å¯¹è±¡çš„ç´¢å¼•ä¸ºé˜Ÿåˆ—å°¾éƒ¨ qp[index]=currentSize; //è¯¥ç´¢å¼•æŒ‡å‘çš„å¯¹è±¡åœ¨keyä¸­çš„ä½ç½®ä¸ºindex pq[currentSize]=index; keys[index] = key; //å¯¹å°¾éƒ¨å…ƒç´ ä¸Šæ»¤ percolateUp(currentSize); } ä¸Šæ»¤æ“ä½œï¼š 12345678910/** * ä¸Šæ»¤ * @param n */ private void percolateUp(int n) { //å°†nå’Œn/2ï¼ˆnçš„çˆ¶äº²ï¼‰æ¯”è¾ƒï¼Œå¦‚æœçˆ¶äº²å¤§ï¼Œåˆ™äº¤æ¢ä¸¤ä¸ªèŠ‚ç‚¹ for (; n&gt;1&amp;&amp;compareTo(n,n/2)&lt;0 ; n/=2) { swap(n,n/2); } } compareTo æ¯”è¾ƒå…³è”çš„å€¼ï¼š 123456789/** * æ¯”è¾ƒç´¢å¼•é˜Ÿåˆ—iå’Œjä¸Šçš„å¯¹åº”çš„keyå€¼å¤§å° * @param i * @param j * @return */ private int compareTo(int i,int j){ return keys[pq[i]].compareTo(keys[pq[j]]); } äº¤æ¢pq[i]å’Œpq[j]çš„å…ƒç´ ï¼š 1234567891011121314/** * äº¤æ¢pq[i]å’Œpq[j]çš„å…ƒç´  * å¹¶æ›´æ–°qp,qp[pq[i]]=i; * @param i * @param j */ private void swap(int i, int j) { int temp= pq[i]; pq[i] = pq[j]; pq[j] = temp; qp[pq[i]] = i; qp[pq[j]] = j; } å››ã€åˆ é™¤æœ€å°é”®åˆ é™¤æœ€å°é”®ï¼ˆå³keys[pq[1]]ï¼‰æ¯”è¾ƒç®€å•ï¼š è·å–æœ€å°é”®ç´¢å¼•minIndexï¼Œå¹¶å°†ç´¢å¼•é˜Ÿåˆ—pqçš„ç¬¬ä¸€ä¸ªå…ƒç´ å’Œæœ€åä¸€ä¸ªå…ƒç´ äº¤æ¢ï¼Œå¹¶è®©currentSizeå‡ä¸€ åŒä¼˜å…ˆé˜Ÿåˆ—ä¸€æ ·ï¼Œä»é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ä¸‹æ»¤ï¼Œå°†ç¬¬ä¸€ä¸ªå…ƒç´ æ”¾åœ¨æ»¡è¶³å †åºçš„ä½ç½® æ­¤æ—¶åªéœ€è®©qp[minIndex]=-1ï¼Œkeys[minIndex]=null å³å¯ å®ç°ï¼š 12345678910111213141516171819/** * åˆ é™¤æœ€å°é”®å¹¶è¿”å›å…¶å…³è”çš„ç´¢å¼•ã€‚ * @return å…³è”çš„ç´¢å¼• å³pq[1] */ public int delMin(){ if (currentSize == 0) { return -1; } int minIndex=pq[1]; swap(1,currentSize--); percolateDown(1); //åˆ é™¤å½“å‰å¯¹è±¡ï¼Œå³pqä¸­ä¸å­˜åœ¨è¯¥å¯¹è±¡äº† qp[minIndex] = -1; pq[currentSize+1]=-1;//ä¸æ˜¯å¿…é¡»çš„ keys[minIndex]=null; return minIndex; } ä¸‹æ»¤ï¼šé€»è¾‘åŒä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå †ï¼‰ 12345678910111213141516171819/** * ä¸‹æ»¤ * @param k */ private void percolateDown(int k) { int child; for (; k*2 &lt;= currentSize ; k =child) { child= 2 * k; if (child &lt; currentSize &amp;&amp;compareTo(child+1,child)&lt;0){ child++; } if (compareTo(child,k)&lt;0){ swap(child,k); }else { break; } } } äº”ã€åˆ é™¤æŒ‡å®šç´¢å¼•å…³è”çš„keyåˆ é™¤æŒ‡å®šç´¢å¼•çš„å…³è”çš„keyåŒåˆ é™¤æœ€å°å€¼åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯äº¤æ¢æ—¶æ˜¯äº¤æ¢pq[qp[i]]ä¸pq[currentSize]çš„å…ƒç´ ï¼Œiä¸ºå¾…åˆ é™¤å¯¹è±¡ç´¢å¼•ã€‚ä¸”äº¤æ¢å®Œåä¸èƒ½åªè¿›è¡Œä¸‹æ»¤ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ç¡®å®šå¾…åˆ é™¤çš„æ˜¯pq[1]æ‰€å…³è”çš„å¯¹è±¡ï¼Œå› æ­¤éœ€è¦è¿›è¡Œä¸Šæ»¤å’Œä¸‹æ»¤ä¸¤æ¬¡æ“ä½œã€‚ 123456789101112131415161718/** * åˆ é™¤ä¸ç´¢å¼•iå…³è”çš„key * @param i */ public void delete(int i){ checkIndex(i); if (!contains(i)){ throw new IllegalArgumentException(\"ç´¢å¼•ä¸å­˜åœ¨\"); } int index=qp[i]; swap(index,currentSize--); //ä¸Šæ»¤ percolateUp(index); //å†ä¸‹æ»¤ é¡ºåºéšæ„ percolateDown(index); keys[index]=null; qp[i] = -1; } äº”ã€ä¿®æ”¹ç´¢å¼•iå…³è”çš„keyå€¼å› ä¸ºåªæ˜¯ä¿®æ”¹äº†iå…³è”çš„å€¼ï¼Œæ‰€ä»¥åªè¦ä¿®æ”¹keys[i]=newKeyï¼Œè€Œ qp[i] å’Œ pq[qp[i]] æŒ‡çš„å€¼å¹¶æ²¡æœ‰æ”¹å˜ã€‚ä½†å› ä¸ºpq[qp[i]] å…³è”çš„å¯¹è±¡æ”¹å˜äº†ï¼Œå› æ­¤éœ€è¦å¯¹qp[i] è¿›è¡Œä¸Šæ»¤å’Œä¸‹æ»¤ï¼Œé‡æ–°è°ƒæ•´ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ã€‚ 12345678910111213/** * ä¿®æ”¹ç´¢å¼•iå…³è”çš„keyå€¼ * @param i * @param key */ public void changeKey(int i,Key key){ checkIndex(i); if (!contains(i))throw new NoSuchElementException(\"ä¸å­˜åœ¨è¯¥ç´¢å¼•\"); keys[i]=key; percolateUp(qp[i]); percolateDown(qp[i]); } å…­ã€å¢å¤§æˆ–å‡å°ç´¢å¼•iå…³è”çš„keyå€¼ä»¥å‡å°ä¸ºä¾‹ï¼Œé¦–å…ˆè¦åˆ¤æ–­æ–°çš„keyæ˜¯å¦å°äºåŸkeyå€¼ï¼Œå¦‚æœå°äºï¼Œåˆ™é‡æ–°æŒ‡å®škeys[i]çš„å€¼ï¼Œå¹¶è¿›è¡Œä¸Šæ»¤ï¼Œå› ä¸ºkeyæ¯”åŸæ¥çš„keyå°ï¼Œå…¶å­èŠ‚ç‚¹å¿…ç„¶æ¯”å®ƒå°ï¼Œä½†æ˜¯çˆ¶èŠ‚ç‚¹å¯èƒ½ä¼šæ¯”æ–°çš„keyå¤§ï¼Œå› æ­¤åªéœ€ä¸Šæ»¤ã€‚å¢å¤§ä¸ä¹‹ç›¸åã€‚ 123456789101112131415161718192021222324252627282930/** * å°†ä¸ç´¢å¼• i å…³è”çš„é”®å‡å°ä¸ºæŒ‡å®šå€¼ã€‚ * @param i * @param key */ public void decreaseKey(int i,Key key){ checkIndex(i); if (!contains(i))throw new NoSuchElementException(\"ä¸å­˜åœ¨è¯¥ç´¢å¼•\"); if(keys[i].compareTo(key)&lt;0){ throw new IllegalArgumentException(\"å½“å‰keyæ— æ³•ç¼©å°åŸkeyå€¼\"); } keys[i]=key; //å½“å‰keyå˜å°ï¼Œå› æ­¤ä¸Šæ»¤å³å¯ percolateUp(qp[i]); } /** * å°†ä¸ç´¢å¼• i å…³è”çš„é”®å¢åŠ ä¸ºæŒ‡å®šå€¼ã€‚ * @param i * @param key */ public void increaseKey(int i, Key key) { checkIndex(i); if (!contains(i))throw new NoSuchElementException(\"ä¸å­˜åœ¨è¯¥ç´¢å¼•\"); if (keys[i].compareTo(key) &gt;= 0) throw new IllegalArgumentException(\"å½“å‰keyæ— æ³•å¢åŠ åŸkeyå€¼\"); keys[i] = key; //å½“å‰keyå˜å¤§ï¼Œå› æ­¤ä¸‹æ»¤å³å¯ percolateDown(qp[i]); } å‚è€ƒï¼šã€Šç®—æ³•ç¬¬å››ç‰ˆã€‹2.4èŠ‚","link":"/posts/20200310-indexPQ.html"},{"title":"ã€Šç®—æ³•4ã€‹union-findå¹¶æŸ¥é›†è§£æ","text":"union-findä¸»è¦ç”¨äºè§£å†³åŠ¨æ€è¿é€šæ€§çš„é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼šå¯¹äºè¾“å…¥çš„ä¸€ç³»åˆ—æ•´æ•°å¯¹p,qï¼Œè¡¨ç¤ºpå’Œqæ˜¯ç›¸è¿çš„ï¼Œåœ¨å°†æ•´æ•°å¯¹è¾“å…¥å®Œæ¯•åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»è¯¥å›¾ä¸­è·å–è¯¥å›¾çš„è¿é€šæ€§ï¼Œå¦‚ä»»æ„ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯å¦ç›¸è¿ï¼Œå…±æœ‰å‡ ä¸ªè¿é€šåˆ†é‡ã€‚å¦‚ä¸Šå›¾å¯çœ‹å‡ºå…±æœ‰ä¸¤ä¸ªè¿é€šåˆ†é‡ï¼š0-5-6-1-2-7ï¼Œ8-3-4-9 union-findç®—æ³•APIå¦‚ä¸‹ï¼š 12345678910//åˆå§‹åŒ–countä¸ªé¡¶ç‚¹ public UF(int count) //på’Œqä¸¤ä¸ªç‚¹æ˜¯å¦è¿é€š public boolean connected(int p,int q)//è¿”å›ç‚¹pæ‰€åœ¨åˆ†é‡çš„æ ‡è¯†ç¬¦ private int find(int p) //è¿”å›è¿é€šåˆ†é‡çš„ä¸ªæ•° public int count() //å°†på’Œqä¸¤ä¸ªç‚¹è¿æ¥ public void union(int p,int q) å¯¹äºfind()å’Œunion()æœ‰å¤šç§å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å…ˆä»‹ç»æœ€åŸºæœ¬çš„quick-findç®—æ³•ï¼š ä¸€ã€quick-findåœ¨è¯¥ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªint id[]æ•°ç»„è¡¨ç¤ºå¯¹åº”çš„é¡¶ç‚¹æ‰€åœ¨çš„è¿é€šåˆ†é‡æ ‡è¯†ç¬¦ï¼Œå¦‚id[0]=0è¡¨ç¤ºé¡¶ç‚¹0æ‰€åœ¨çš„è¿é€šåˆ†é‡ä¸º0ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œä¼šå°†æ‰€æœ‰é¡¶ç‚¹å¯¹åº”çš„id[]å€¼åˆå§‹åŒ–ä¸ºä¸å…¶è‡ªèº«ç›¸ç­‰çš„å€¼ï¼Œè¡¨ç¤ºä¸€å¼€å§‹å„ä¸ªç‚¹éƒ½ä»¥è‡ªèº«ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„åˆ†é‡ï¼Œäº’ç›¸ä¸è¿é€šã€‚å¦‚ä¸‹ï¼š 123456789101112private int[] id; /** * è¿é€šåˆ†é‡æ•°é‡(æ ‡è¯†ç¬¦) */ private int count; public UF(int count) { this.count = count; this.id=new int[count]; for (int i = 0; i &lt; count; i++) { id[i]=i; } } å¯¹äºfind()çš„å®ç°ï¼Œå…ˆä»‹ç»quick-findç®—æ³•ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š 123private int quickFind(int i) { return id[i]; } id[i]ç›´æ¥ä¿å­˜içš„åˆ†é‡idï¼Œå› æ­¤å½“id[p]=id[q]æ—¶ï¼Œè¡¨ç¤ºpå’Œqæ˜¯è¿é€šçš„ã€‚ç”±æ­¤å¯å¾—connected(p,q)çš„å®ç°ï¼š 123456/** * på’Œqæ˜¯å¦åœ¨åŒä¸€ä¸ªåˆ†é‡ */ public boolean connected(int p,int q){ return quickFind(p)==quickFind(q); } è€Œè¦æƒ³å®ç°å°†på’Œqè¿æ¥èµ·æ¥ï¼Œé¦–å…ˆè¦åˆ¤æ–­ä¸¤ç‚¹æ˜¯å¦è¿é€šï¼Œå¦‚æœè¿é€šåˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸è¿é€šï¼Œåˆ™éå†idæ•°ç»„ï¼Œè®©æ‰€æœ‰ä¸id[p]ç›¸ç­‰çš„ç‚¹ï¼Œæ”¹ä¸ºid[q]ï¼Œå³å°†æ‰€æœ‰ä¸påœ¨åŒä¸€ä¸ªè¿é€šåˆ†é‡ä¸Šçš„ç‚¹ä¿®æ”¹ä¸ºqæ‰€åœ¨è¿é€šåˆ†é‡ã€‚å›¾ç¤ºå¦‚ä¸‹ï¼š 123456789101112å¦‚è¦è¿æ¥union(3,4)ï¼Œp=3ï¼Œq=4idæ•°ç»„å¦‚ä¸‹:p q 0 1 2 3 4 5 6 7 8 93 4 1 1 2 3 5 6 6 3 3 5å¯è§ï¼Œid[p]=id[3]=3 ,id[q]=id[4]=5 ä¸påœ¨åŒä¸€åˆ†é‡çš„ç‚¹æœ‰ï¼š3 7 8 ä¸qåœ¨åŒä¸€åˆ†é‡çš„ç‚¹æœ‰: 4 9 æ‰€ä»¥union(3,4)çš„ä»»åŠ¡å°±æ˜¯è®©æ‰€æœ‰id[i]ç­‰äº3çš„ä½ç½®ï¼Œæ”¹ä¸º5ï¼Œå³å®ç°è¿æ¥ è¿æ¥åçš„çŠ¶æ€å¦‚ä¸‹ï¼šp q 0 1 2 3 4 5 6 7 8 93 4 1 1 2 3 5 6 6 3 3 5 1 1 2 5 5 6 6 5 5 5 unionå®ç°å¦‚ä¸‹ï¼š 12345678910public void union(int p,int q){ if (!connected(p,q)){ for (int i = 0; i &lt; id.length; i++) { if (id[i]==id[p]){ id[i]=id[q]; count--; } } } } ä¸éš¾å‘ç°ï¼Œè¯¥ç®—æ³•æ¯æ¬¡find()åªä¼šè®¿é—®ä¸€æ¬¡æ•°ç»„ï¼Œæ¯æ¬¡union()æ“ä½œæ•°ç»„çš„æ¬¡æ•° åœ¨N+3åˆ°2N+1æ¬¡ï¼Œæœ€åæƒ…å†µä¸‹ä¼šè¾¾åˆ°å¹³æ–¹çº§åˆ«ã€‚å› æ­¤è¯¥ç®—æ³•é€Ÿåº¦å¿«ï¼Œä½†æ— æ³•è§£å†³å¤§å‹é—®é¢˜ï¼Œå› ä¸ºæ¯æ¬¡éƒ½éœ€è¦éå†æ•´ä¸ªid[]æ•°ç»„ã€‚ æ¥ä¸‹æ¥çš„quick-unionå¯¹quick-findè¿›è¡Œäº†ä¼˜åŒ–ï¼š äºŒã€quick-unionè¯¥ç®—æ³•çš„æ•°æ®ç»“æ„åŒquick-findç›¸åŒï¼Œä½†æ˜¯id[]çš„æ„ä¹‰æ”¹å˜äº†ã€‚åœ¨è¯¥ç®—æ³•ä¸­ï¼Œid[]ä¸­çš„å…ƒç´ ä¿å­˜çš„éƒ½æ˜¯åŒä¸€ä¸ªè¿é€šåˆ†é‡ä¸­çš„å¦ä¸€ä¸ªå…ƒç´ ã€‚å¦‚ä¸‹å›¾ï¼š 12345671 8 / | \\ / \\ 0 2 7 3 9 | | 5 4 | 6 ç”±ä¸Šå›¾å¯å¾—idæ•°ç»„ï¼š 120 1 2 3 4 5 6 7 8 9 idç´¢å¼•1 1 1 8 3 0 5 1 8 8 å€¼ å¯çŸ¥é™¤äº†æ ¹èŠ‚ç‚¹ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹çš„idå€¼éƒ½ç­‰äºä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„å€¼ã€‚ è€ŒåŒä¸€ä¸ªåˆ†é‡çš„èŠ‚ç‚¹ï¼Œå¾ªç¯å‘ä¸Šå¯»æ‰¾ï¼Œæœ€ç»ˆéƒ½ä¼šåœ¨æ ¹èŠ‚ç‚¹ç›¸é‡ã€‚å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹åœ¨æ ¹èŠ‚ç‚¹çš„å€¼ç›¸åŒï¼Œåˆ™è¯´æ˜åœ¨åŒä¸€ä¸ªåˆ†é‡ï¼Œå¦åˆ™åœ¨ä¸åŒçš„åˆ†é‡ä¸­ã€‚å¦‚æœè¦è¿æ¥ä¸¤ä¸ªåˆ†é‡ï¼Œåªéœ€è¿æ¥ä¸¤ä¸ªåˆ†é‡çš„æ ¹èŠ‚ç‚¹ï¼Œå¦‚ä¸Šå›¾ï¼Œè¦è¿æ¥5å’Œ9ï¼Œåˆ™ç›´æ¥è®©id[1]=8å³å¯ã€‚å¯å¾—å¦‚ä¸‹union-findç®—æ³•ï¼š 1234567891011121314public void union(int p,int q){ int i = find(p); int j = find(q); if (i!=j){ id[i]=j; count--; } } public int find(int p){ while(p!=id[p]){ p=id[p]; } return p; } åˆ†æå¯çŸ¥ï¼Œè¯¥ç®—æ³•çš„find()æ–¹æ³•è®¿é—®æ•°ç»„çš„æ¬¡æ•°ä¸º1+ç»™å®šå‡ºç‚¹å¯¹åº”çš„é«˜åº¦çš„ä¸¤å€ï¼Œunion()è®¿é—®æ•°ç»„æ¬¡æ•°ä¸ºä¸¤æ¬¡find()æ“ä½œï¼Œå¦‚æœä¸¤ä¸ªä¸åœ¨ä¸€ä¸ªåˆ†é‡ä¸­ï¼Œåˆ™è¿˜éœ€+1æ¬¡ã€‚åœ¨æœ€åæƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªæ— åˆ†æ”¯çš„è¿é€šåˆ†é‡ï¼Œå³é¡¶ç‚¹é«˜åº¦height=Nï¼ŒNä¸ºæ‰€æœ‰èŠ‚ç‚¹æ•°ï¼Œæ­¤æ—¶çš„è¿è¡Œæ—¶é—´ä¹Ÿæ˜¯å¹³æ–¹çº§çš„ï¼Œå¦‚æœæ•°é‡å·¨å¤§ï¼Œåˆ™ä¹Ÿå¾ˆåƒåŠ›ã€‚ ä¸‰ã€åŠ æƒquick-unionç®—æ³•è¯¥ç®—æ³•åœ¨ç†è§£quick-unionçš„åŸºç¡€ä¸Šï¼Œä¼šè®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„é«˜åº¦ï¼Œåœ¨æ¯æ¬¡unionæ—¶ï¼Œä¼šæ¯”è¾ƒé«˜åº¦ï¼Œå¹¶å°†å°æ ‘è¿æ¥åˆ°å¤§æ ‘ä¸Šï¼Œè¿™æ ·æ§åˆ¶æ ‘çš„é«˜åº¦å°±å¯ä»¥è§£å†³ä¸Šè¿°quick-unionçš„æœ€åæƒ…å†µã€‚ 123456789101112131415161718public class WeightedQuickUnionFind { private int[] id; //æ¯ä¸ªæ ¹èŠ‚ç‚¹å¯¹åº”çš„åˆ†é‡çš„å¤§å° private int[] weighted; private int count; public WeightedQuickUnionFind(int count) { this.count = count; weighted=new int[count]; id = new int[count]; for (int i = 0; i &lt; count; i++) { //åˆ†é‡å¤§å°åˆå§‹åŒ–ä¸º1 weighted[i]=1; //åˆ†é‡æ ‡è¯†ç¬¦åˆå§‹åŒ–ä¸ºè‡ªèº« id[i]=i; } }} è¯¥ç®—æ³•çš„find()æ–¹æ³•åŒä¸Šï¼Œunionç®—æ³•å¦‚ä¸‹ï¼š 12345678910111213141516171819202122/** * åŠ æƒquick-unionç®—æ³•ï¼Œä¿è¯æ¯æ¬¡éƒ½å°†å°æ ‘åŠ åˆ°å¤§æ ‘ä¸Š * @param p * @param q */ public void union(int p,int q){ int i = find(p); int j = find(q); if(i==j)return; else{ //è¿æ¥æ—¶åˆ¤æ–­ä¸¤ä¸ªæ ¹èŠ‚ç‚¹æ‰€åœ¨åˆ†é‡çš„å¤§å° if (weighted[i]&lt;weighted[j]){ id[i]=j; //ä¿®æ”¹å¤§å° weighted[j] += weighted[i]; }else { id[j]=i; weighted[i] += weighted[j]; } } count--; } åŠ æƒquick-unionç®—æ³• å¯ç”¨äºè§£å†³å¤§å‹é—®é¢˜Nä¸ªç‚¹Mä¸ªè¿æ¥æœ€å¤šè®¿é—®æ•°ç»„cMlogNæ¬¡ï¼Œcä¸ºå¸¸æ•°æœ€åæƒ…å†µä¸‹find()ã€connected()å’Œunion()çš„å¢é•¿æ•°é‡çº§ä¸ºlogN å››ã€æœ€ä¼˜ç®—æ³•ï¼ˆä½¿ç”¨è·¯å¾„å‹ç¼©ï¼‰æœ€ä¼˜çš„ç®—æ³•åº”å½“æ˜¯ä¸€ç§èƒ½å¤Ÿä¿è¯åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆå„ç§æ“ä½œçš„ç®—æ³•ã€‚ç†æƒ³æƒ…å†µä¸‹æˆ‘ä»¬å¸Œæœ›å„ä¸ªèŠ‚ç‚¹éƒ½ç›´æ¥é“¾æ¥åˆ°æ ¹èŠ‚ç‚¹ï¼Œåˆä¸æƒ³é€šè¿‡å¤§é‡ä¿®æ”¹å®ç°ã€‚è¦å®ç°è¿™ç§ç®—æ³•ï¼Œå°±æ˜¯åœ¨find()åŒæ—¶ï¼Œå°†è¯¥èŠ‚ç‚¹è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ç›´æ¥é“¾æ¥åˆ°æ ¹èŠ‚ç‚¹ã€‚ åœ¨find()ä¸­å®ç°è·¯å¾„å‹ç¼©ï¼š 1234567891011121314151617181920212223/** * ä½¿ç”¨è·¯å¾„å‹ç¼©ï¼Œå°†è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ç›´æ¥ä¸æ ¹èŠ‚ç‚¹ç›¸è¿ * @param p * @return */ public int find(int p) { //rootè®°å½•æ ¹èŠ‚ç‚¹ int root=p; while (root!=id[root]){ //å¾ªç¯æ‰¾åˆ°å½“å‰èŠ‚ç‚¹æ‰€åœ¨åˆ†é‡çš„æ ¹èŠ‚ç‚¹ root=id[root]; } //æ­¤æ—¶rootå·²ç»ä¸ºå½“å‰åˆ†é‡æ ¹èŠ‚ç‚¹ //å¯¹pè¿›è¡ŒåŒæ ·æ–¹æ³•çš„å¾ªç¯ï¼Œå°†ä¸påœ¨åŒä¸€ä¸ªè·¯å¾„ä¸Šçš„èŠ‚ç‚¹ç›´æ¥ä¸rootç›¸è¿æ¥ while (id[p]!=root){ int temp=p; //å½“å‰èŠ‚ç‚¹ä¸rootè¿æ¥ id[temp]=root; //æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç»§ç»­å¾ªç¯ p=id[p]; } return root; } å› æ­¤ä½¿ç”¨è·¯å¾„å‹ç¼©çš„åŠ æƒquick-unionç®—æ³•å°±æ˜¯è¯¥é—®é¢˜çš„æœ€ä¼˜è§£ï¼Œè¯¥ç®—æ³•çš„unionå’Œfind()çš„æˆæœ¬çš„å¢é•¿æ•°é‡çº§å·²ç»éå¸¸æ¥è¿‘1ï¼Œä½†æ²¡è¾¾åˆ°1ä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061public class ComPathWeightedQuickUnionFind { private int[] id; private int[] weighted; private int count; public ComPathWeightedQuickUnionFind(int count) { this.count = count; weighted=new int[count]; id = new int[count]; for (int i = 0; i &lt; count; i++) { weighted[i]=1; id[i]=i; } } /** * åŠ æƒquick-unionç®—æ³•ï¼Œä¿è¯æ¯æ¬¡éƒ½å°†å°æ ‘åŠ åˆ°å¤§æ ‘ä¸Š * @param p * @param q */ public void union(int p,int q){ int i = find(p); int j = find(q); if (i==j){ return; }else { if (weighted[i]&lt;weighted[j]){ id[i]=j; weighted[j] += weighted[i]; }else { id[j]=i; weighted[i] += weighted[j]; } } count--; } /** * ä½¿ç”¨è·¯å¾„å‹ç¼©ï¼Œå°†è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ç›´æ¥ä¸æ ¹èŠ‚ç‚¹ç›¸è¿ * @param p * @return */ public int find(int p) { int root=p; while (root!=id[root]){ root=id[root]; } while (id[p]!=root){ int temp=p; id[temp]=root; p=id[p]; } return root; } public boolean connected(int p , int q){ return find(p)==find(q); } public int count(){ return count; }} å‚è€ƒï¼šã€Šç®—æ³•ç¬¬å››ç‰ˆã€‹1.5èŠ‚","link":"/posts/20200310-union-find.html"},{"title":"é¡ºåºæŸ¥æ‰¾å’ŒäºŒåˆ†æŸ¥æ‰¾----javaå®ç°","text":"ä¸€ã€åŸºäºæ— åºé“¾è¡¨çš„é¡ºåºæŸ¥æ‰¾ä¼˜ç‚¹ï¼šé€‚ç”¨å°å‹é—®é¢˜ç¼ºç‚¹ï¼šå¯¹å¤§å‹ç¬¦å·è¡¨å¾ˆæ…¢ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104/** * é¡ºåºæŸ¥æ‰¾ï¼ˆåŸºäºæ— åºé“¾è¡¨ï¼‰ * æœªå‘½ä¸­å’Œå‘½ä¸­éƒ½éœ€è¦Næ¬¡æ¯”è¾ƒ * å‘½ä¸­æœ€åéœ€è¦Næ¬¡æ¯”è¾ƒ * @author MaoLin Wang * @date 2020/3/118:01 */public class SequentialSearchST&lt;Key, Value&gt; { /** * é¦–èŠ‚ç‚¹ */ private Node first; private int size; private class Node { private Key key; private Value value; private Node next; public Node(Key key, Value value, Node next) { this.key = key; this.value = value; this.next = next; } } /** * æ ¹æ®keyæŸ¥è¯¢å¯¹åº”çš„å€¼ï¼Œä¸€ä¸ªä¸ªå¾€ä¸‹éå†ç›´åˆ°æ‰¾åˆ°ç›¸ç­‰çš„keyï¼Œè¿”å›å¯¹åº”çš„å€¼ï¼Œå¦åˆ™è¿”å›null * @param key * @return */ public Value get(Key key) { for (Node x = first; x != null; x = x.next) { if (key.equals(x.key)) { return x.value; } } return null; } /** * åŠ å…¥ä¸€ä¸ªå…ƒç´  * @param key * @param value */ public void put(Key key, Value value) { for (Node x = first; x != null; x = x.next) { //keyå·²å­˜åœ¨ï¼Œæ›´æ–°å¯¹åº”çš„å€¼ if (key.equals(x.key)) { x.value = value; return; } } //keyä¸å­˜åœ¨ï¼Œæ–°æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ first = new Node(key, value, first); size++; } public boolean isEmpty() { return size == 0; } private int size() { return size; } public boolean contains(Key key) { if (key == null) throw new IllegalArgumentException(\"argument to contains() is null\"); return get(key) != null; } /** * åˆ é™¤keyå¯¹åº”çš„èŠ‚ç‚¹ * @param key */ public void delete(Key key) { if (key == null) throw new IllegalArgumentException(\"argument to delete() is null\"); first = delete(first, key); } /** * é€’å½’æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸ç­‰çš„keyï¼Œæ­£å¸¸åˆ é™¤é“¾è¡¨èŠ‚ç‚¹ * @param x * @param key * @return */ private Node delete(Node x, Key key) { if (x == null) return null; if (key.equals(x.key)) { size--; return x.next; } x.next = delete(x.next, key); return x; } public Iterable&lt;Key&gt; keys() { Queue&lt;Key&gt; queue=new Queue&lt;&gt;(); while (first!=null){ queue.enqueue(first.key); first=first.next; } return queue; }} äºŒã€åŸºäºæœ‰åºæ•°ç»„çš„äºŒåˆ†æŸ¥æ‰¾æŸ¥æ‰¾å¾ˆç®€å•ï¼Œå…ˆè®©ç›®æ ‡å€¼ä¸ä¸­å€¼æ¯”è¾ƒï¼Œå¦‚æœæ¯”ä¸­å€¼å°ï¼Œåˆ™åœ¨å·¦åŠè¾¹ç»§ç»­æŸ¥æ‰¾ï¼Œå¦‚æœæ¯”ä¸­å€¼å¤§ï¼Œåˆ™ç»§ç»­è¦å³åŠè¾¹æŸ¥æ‰¾ã€‚è¿™é‡Œå®šä¹‰äº†rank()æ–¹æ³•ï¼Œè¿”å›æ¯”ç›®æ ‡keyå°çš„keyçš„æ•°é‡ 1234567891011121314151617181920212223/** * è¿”å›å°äºç»™å®šé”®keyçš„keyçš„æ•°é‡ * 1.æ‰¾åˆ°ç»™å®škeyï¼Œåˆ™è¿”å›å¯¹åº”çš„midåæ ‡ * 2.æ‰¾ä¸åˆ°ç»™å®škeyï¼Œè¿”å›leftæŒ‡é’ˆï¼Œæ­¤æ—¶leftæŒ‡å‘å¤§äºç­‰äºç»™å®škeyçš„æœ€å°ä½ç½® * ä¸¤ç§æƒ…å†µè¿”å›çš„éƒ½æ˜¯å°é±¼ç»™å®škeyçš„keyçš„æ•°é‡ * @param key * @return */ public int rank(Key key){ int left=0,right=size-1; while (left&lt;=right){ int mid=left+(right-left)/2; int result=keys[mid].compareTo(key); if (result&lt;0){ left=mid+1; }else if (result &gt; 0){ right=mid-1; }else { return mid; } } return left; } åŸºæœ¬æ•°æ®ç»“æ„å¦‚ä¸‹ï¼šä½¿ç”¨æ³›å‹Keyä¿å­˜é”®ï¼Œæ³›å‹Valueä¿å­˜å€¼ 12345678910public class BinarySearchST&lt;Key extends Comparable&lt;Key&gt;,Value&gt; { private Key[] keys; private Value[] values; private int size; public BinarySearchST(int size) { keys= (Key[]) new Comparable[size]; values= (Value[]) new Comparable[size]; }} æŸ¥æ‰¾æ“ä½œï¼š 123456789101112public Value get(Key key){ if (isEmpty()){ return null; } int i=rank(key); //å¦‚æœkeyå­˜åœ¨ï¼Œä¸”i&lt;sizeï¼Œåˆ™keys[i]ä¸€å®šç­‰äºkeyï¼Œè¿”å›å¯¹åº”çš„value if (i&lt;size &amp;&amp; keys[i].compareTo(key)==0){ return values[i]; }else { return null; } } æ·»åŠ ä¸€å¯¹æ•°æ® 1234567891011121314151617181920212223242526public void put(Key key,Value value){ if (key==null){ return; } //valueç­‰äºnullï¼Œé»˜è®¤ä¸å­˜å‚¨nullï¼Œåˆ é™¤å¯¹åº”çš„key-value if (value==null){ delete(key); return; } int i=rank(key); if (i&lt;size &amp;&amp; keys[i].compareTo(key)==0){ //å­˜åœ¨keyï¼Œåˆ™æ›´æ–°å€¼ values[i]=value; }else { if (size == keys.length) resize(2*keys.length); //ä¸å­˜åœ¨ï¼Œåˆ™å°†ä»iåˆ°sizeçš„æ‰€æœ‰å…ƒç´ å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œå†å°†æ–°çš„å€¼åŠ å…¥åˆ°ä½ç½®i for (int j = size; j &gt; i; j--) { keys[j]=keys[j-1]; values[j]=values[j-1]; } keys[i]=key; values[i]=value; size++; } } åˆ é™¤ä¸€å¯¹æ•°æ®ï¼š 12345678910111213141516171819public void delete(Key key){ if (key==null)throw new IllegalArgumentException(\"keyä¸ºç©º\"); if (isEmpty()) return; //å¾…åˆ é™¤keyçš„ä½ç½® int i=rank(key); if (i&lt;size &amp;&amp; keys[i].compareTo(key)==0){ //å¦‚æœkeyå­˜åœ¨ï¼Œåˆ™å°†i+1åˆ°size-1çš„å…ƒç´ å‘å·¦ç§»åŠ¨ä¸€ä½ for (int j = i; j &lt; size-1 ; j++) { keys[j]=keys[j+1]; values[j]=values[j+1]; } //ç½®æœ€åä¸€ä½ä¸ºnull size--; keys[size]=null; values[size]=null; return ; } } å…¶ä»–å®Œæ•´ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183/** * Nä¸ªé”®çš„æœ‰åºæ•°ç»„æœ€å¤šéœ€è¦N+1æ¬¡æ¯”è¾ƒ * @author MaoLin Wang * @date 2020/3/118:43 */public class BinarySearchST&lt;Key extends Comparable&lt;Key&gt;,Value&gt; { private Key[] keys; private Value[] values; private int size; public BinarySearchST(int size) { keys= (Key[]) new Comparable[size]; values= (Value[]) new Comparable[size]; } public int Size(){ return size; } public Value get(Key key){ if (isEmpty()){ return null; } int i=rank(key); if (i&lt;size &amp;&amp; keys[i].compareTo(key)==0){ return values[i]; }else { return null; } } public void put(Key key,Value value){ if (key==null){ return; } if (value==null){ delete(key); return; } int i=rank(key); if (i&lt;size &amp;&amp; keys[i].compareTo(key)==0){ //å­˜åœ¨keyï¼Œåˆ™æ›´æ–°å€¼ values[i]=value; }else { if (size == keys.length) resize(2*keys.length); //ä¸å­˜åœ¨ï¼Œåˆ™å°†ä»iåˆ°sizeçš„æ‰€æœ‰å…ƒç´ å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œå†å°†æ–°çš„å€¼åŠ å…¥åˆ°ä½ç½®i for (int j = size; j &gt; i; j--) { keys[j]=keys[j-1]; values[j]=values[j-1]; } keys[i]=key; values[i]=value; size++; } } /** * è¿”å›å°äºç»™å®šé”®keyçš„keyçš„æ•°é‡ * @param key * @return */ public int rank(Key key){ int left=0,right=size-1; while (left&lt;=right){ int mid=left+(right-left)/2; int result=keys[mid].compareTo(key); if (result&lt;0){ left=mid+1; }else if (result &gt; 0){ right=mid-1; }else { return mid; } } return left; } public boolean isEmpty(){ return size==0; } public Key minKey(){ return keys[0]; } public Key maxKey(){ return keys[size-1]; } public Key selectKey(int k){ return keys[k]; } /** * å‘ä¸Šå–æ•´ æ‰¾å‡ºå¤§äºç­‰äºè¯¥é”®çš„æœ€å°é”® * @param key * @return */ public Key ceiling(Key key){ int i=rank(key); return keys[i]; } /** * å‘ä¸‹å–æ•´ æ‰¾å‡ºå°äºç­‰äºè¯¥é”®çš„æœ€å°é”® * @param key * @return */ public Key floor(Key key){ if (key==null)throw new IllegalArgumentException(\"keyä¸ºç©º\"); int i=rank(key); if (i&lt;size &amp;&amp; keys[i].compareTo(key)==0){ return keys[i]; }else if (i==0){ return null; }else { return keys[i-1]; } } public void delete(Key key){ if (key==null)throw new IllegalArgumentException(\"keyä¸ºç©º\"); if (isEmpty()) return; int i=rank(key); if (i&lt;size &amp;&amp; keys[i].compareTo(key)==0){ for (int j = i; j &lt; size-1 ; j++) { keys[j]=keys[j+1]; values[j]=values[j+1]; } size--; keys[size]=null; values[size]=null; return ; } } private void resize(int capacity) { Key[] tempKey = (Key[]) new Comparable[capacity]; Value[] tempValue = (Value[]) new Object[capacity]; for (int i = 0; i &lt; size; i++) { tempKey[i] = keys[i]; tempValue[i] = values[i]; } values = tempValue; keys = tempKey; } public void delMin(){ delete(minKey()); } public void delMax(){ delete(maxKey()); } public Iterable&lt;Key&gt; keys(Key lo,Key hi){ Queue&lt;Key&gt;queue=new Queue&lt;&gt;(); int right = rank(hi); for (int i = rank(lo); i &lt; right; i++) { queue.enqueue(keys[i]); } if (contains(hi)){ queue.enqueue(keys[right]); } return queue; } public boolean contains(Key key) { if (key == null) throw new IllegalArgumentException(\"argument to contains() is null\"); return get(key) != null; } public static void main(String[] args) { BinarySearchST&lt;String,Integer&gt; binarySearchST=new BinarySearchST&lt;&gt;(5); binarySearchST.put(\"a\",3); binarySearchST.put(\"d\",2); binarySearchST.put(\"c\",1); binarySearchST.put(\"b\",0); binarySearchST.put(\"e\",4); System.out.println(binarySearchST.size); binarySearchST.delete(\"b\"); String s = binarySearchST.selectKey(3); System.out.println(s); }} äºŒåˆ†æŸ¥æ‰¾å¹³å‡æƒ…å†µä¸‹çš„æ’å…¥æˆæœ¬ä¸º lgNï¼Œæœ€åæƒ…å†µä¸‹ä¸ºlgNï¼Œä¸€èˆ¬æƒ…å†µæ¯”é¡ºåºæŸ¥æ‰¾å¿«çš„å¤šä½†æ˜¯åœ¨é”®æ˜¯éšæœºçš„æƒ…å†µä¸‹ï¼Œæ„é€ ä¸€ä¸ªæœ‰åºæ•°ç»„æ‰€éœ€è¦è®¿é—®æ•°ç»„çš„æ¬¡æ•°æ˜¯æ•°ç»„é•¿åº¦çš„å¹³æ–¹çº§åˆ«ã€‚å› æ­¤æœ€åæƒ…å†µä¸‹ï¼Œæ’å…¥çš„æˆæœ¬ä¸º2N ä¼˜ç‚¹ï¼šæœ€ä¼˜çš„æŸ¥æ‰¾æ•ˆç‡å’Œæ§ä»¶éœ€æ±‚ï¼Œèƒ½å¤Ÿè¿›è¡Œæœ‰åºæ€§ç›¸å…³çš„æ“ä½œç¼ºç‚¹ï¼šæ’å…¥æ“ä½œæ…¢","link":"/posts/20200310-seq-binary-find.html"},{"title":"ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå †ï¼‰ä»¥åŠå †æ’åº-------javaå®ç°","text":"å®ç°ä¼˜å…ˆé˜Ÿåˆ—çš„åŸºæœ¬æ•°æ®ç»“æ„æ˜¯ä½¿ç”¨äºŒå‰å † ä¸€ã€äºŒå‰å †äºŒå‰å †å³ç”¨ä¸€é¢—å®Œå…¨äºŒå‰æ ‘ï¼ˆåº•å±‚å…ƒç´ ä»å·¦å‘å³å¡«å…¥ï¼‰ã€‚å¦‚æœæ‰€ç¤ºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ•°ç»„æ¥è¡¨ç¤ºäºŒå‰å †ï¼Œè€Œä¸ä½¿ç”¨é“¾è¡¨: 120 1 2 3 4 5 6 7 8 9 10 A B C D E F G H I å¯ä»¥å‘ç°ï¼Œå¯¹äºä»»æ„èŠ‚ç‚¹ iï¼Œå…¶ å·¦äºŒå­åœ¨ 2i ä½ç½®ï¼Œå³å„¿å­åœ¨ 2i+1ä½ç½® å…³äºä¼˜å…ˆé˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥è§„å®šæœ€å¤§å…ƒä¼˜å…ˆæˆ–æœ€å°å…ƒä¼˜å…ˆï¼Œå¯¹åº”çš„å †å°±æ˜¯å¤§é¡¶å †å’Œå°é¡¶å †ã€‚å¤§é¡¶å †ï¼š å³æ ‘ä¸Šæ¯ä¸ªèŠ‚ç‚¹éƒ½å°äºç­‰äºå…¶çˆ¶äº²èŠ‚ç‚¹ï¼Œé™¤äº†æ ¹èŠ‚ç‚¹ï¼Œå› ä¸ºæ ¹èŠ‚ç‚¹æ²¡æœ‰çˆ¶äº²å°é¡¶å †ï¼šå³æ ‘ä¸Šæ¯ä¸ªèŠ‚ç‚¹éƒ½å¤§äºç­‰äºå…¶çˆ¶äº²èŠ‚ç‚¹ã€‚åŒä¸Š äºŒã€åŸºæœ¬çš„å †æ“ä½œï¼ˆä»¥å°é¡¶å †ä¸ºä¾‹ï¼‰1.æ’å…¥1.å¯ä»¥åœ¨ä¸‹ä¸€ä¸ªå¯ç”¨ä½ç½®å¤„åˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œå°†å¾…æ’å…¥èŠ‚ç‚¹xæ”¾åœ¨0ä½ç½®ï¼ˆ0ä½ç½®ä¸ºç©ºï¼‰2.ç„¶åå¾ªç¯æ¯”è¾ƒå¾…åŠ å…¥èŠ‚ç‚¹å’Œç©ºèŠ‚ç‚¹çš„çˆ¶äº²æ¯”è¾ƒï¼Œå¦‚æœçˆ¶èŠ‚ç‚¹å¤§äºxï¼Œåˆ™å°†è®©çˆ¶èŠ‚ç‚¹ç½®äºç©ºèŠ‚ç‚¹ï¼Œç©ºèŠ‚ç‚¹ä¸Šå†’åˆ°åŸçˆ¶èŠ‚ç‚¹ï¼›å¦‚æœçˆ¶èŠ‚ç‚¹å°äºxï¼Œåˆ™ç›´æ¥å°†xæ”¾åœ¨ç©ºä½ç½®ï¼Œæ­¤æ—¶ä¸ä¼šæ”¹å˜å †åº è‹¥åˆ›å»ºå¤§é¡¶å †ï¼Œåˆ™å’Œçˆ¶äº²èŠ‚ç‚¹æ¯”è¾ƒæ—¶ï¼ŒåŒå°é¡¶å †ç›¸åå³å¯ã€‚ å®ç°å¦‚ä¸‹ï¼šå…ˆçœ‹åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼š 12345678910111213141516public class BinaryHeap&lt;T extends Comparable&lt;? super T&gt;&gt; { private static final int DEFAULT_CAPACITY = 10; //å½“å‰å †å¤§å°(å…ƒç´ ä¸ªæ•°) private int currentSize; //æ•°ç»„è¡¨ç¤ºäºŒå‰å † private T[] array; public BinaryHeap() { this(DEFAULT_CAPACITY); } public BinaryHeap(int capacity) { this.currentSize = 0; array = (T[]) new Comparable[capacity + 1]; }} æ’å…¥æ“ä½œï¼š 123456789101112131415161718192021222324252627/** * å…ˆå»ºç«‹ä¸€ä¸ªç©ºä½ç½® hole,ä¸Šæ»¤ç›´åˆ°æ‰¾åˆ°æ»¡è¶³å †åºçš„ä½ç½®ï¼Œå°†xæ’å…¥åˆ°è¯¥ä½ç½® * array[0]æš‚å­˜å¾…æ’å…¥å…ƒç´ x * @param x */ public void insert(T x) { //æ‰©å®¹æ“ä½œ if (currentSize == array.length - 1) { enlargeArray(array.length * 2 + 1); } //è®©ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºèŠ‚ç‚¹ int hole=++currentSize; //å°†å¾…æ’å…¥èŠ‚ç‚¹æ”¾åœ¨0å¤„ array[0]=x; //ä»ç©ºèŠ‚ç‚¹å¼€å§‹ä¸Šå†’ percolateUp(hole,array[0]); } /** * ä¸Šå†’ * @param hole */ private void percolateUp(int hole,T x){ for ( ; x.compareTo(array[hole/2])&lt;0 ;hole /= 2) { array[hole]=array[hole/2]; } array[hole]=x; } 2. åˆ é™¤æœ€å°å€¼ï¼ˆå‡ºé˜Ÿï¼‰åœ¨äºŒå‰å †ä¸­ï¼Œæœ€å°å€¼å³ç¬¬arr[1]å…ƒç´ ï¼Œä½†æ˜¯åˆ é™¤å®ƒåï¼Œæ ¹èŠ‚ç‚¹å˜ä¸ºç©ºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠæœ€åä¸€ä¸ªèŠ‚ç‚¹Xæ”¾åœ¨è¿™ä¸ªç©ºå…ƒç´ ä¸Šï¼ŒåŒæ—¶è®©å½“å‰å †å¤§å°å‡ä¸€ï¼Œå¦‚æœæ•´ä¸ªå †æœ‰åºï¼Œåˆ™ç›´æ¥è¿”å›æœ€å°å€¼ï¼Œä½†æ˜¯æ˜¾ç„¶ä¸å¯èƒ½ä¿æŒå †åºã€‚å› æ­¤æˆ‘ä»¬å°±éœ€è¦ä»è¯¥ç©ºèŠ‚ç‚¹å¼€å§‹è¿›è¡Œä¸‹æ»¤æ“ä½œï¼šä¸‹æ»¤ä¸ä¸Šå†’ç›¸åï¼Œå°±æ˜¯æ²¿ç€ç©ºèŠ‚ç‚¹å¼€å§‹åŒ…å«æœ€å°å„¿å­çš„è·¯å¾„ä¸Šæ‰¾åˆ°ä¸€ä¸ªä½ç½®å¯ä»¥æ”¾å…¥Xã€‚ å›¾ä¾‹ï¼šåˆ é™¤æœ€å°èŠ‚ç‚¹ABæ¯”Iå°ï¼Œå› æ­¤å°†ç©ºèŠ‚ç‚¹ä¸‹æ»¤ï¼šDæ¯”Iå°ï¼Œå› æ­¤ç©ºèŠ‚ç‚¹ç§»åŠ¨åˆ°Dä½ç½®ï¼šæ­¤æ—¶Iæ”¾åœ¨å½“å‰çš„ç©ºèŠ‚ç‚¹ä½ç½®å¯ä»¥ä¿æŒå †åºï¼šå®ç°å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546/** * åˆ é™¤æœ€å°å…ƒç´ ï¼Œä¸‹æ»¤ * 1.æ‰¾åˆ°æœ€å°å…ƒç´ ï¼Œç§»é™¤ï¼ˆcurrentSize--,å¹¶å°†æœ€åä¸€ä¸ªå…ƒç´ æ”¾åœ¨æœ€å°å…ƒç´ ä½ç½®ï¼‰ * 2.å¯¹è¯¥å…ƒç´ è¿›è¡Œä¸‹æ»¤ * @return */ public T deleteMin(){ if (isEmpty()){ System.out.println(\"å †ä¸ºç©º\"); } T min = findMin(); array[1]=array[currentSize--]; percolateDown(1); return min; } /** * ä»holeå¼€å§‹ä¸‹æ»¤ * @param hole */ private void percolateDown(int hole) { int child; T temp = array[hole]; for ( ; hole*2&lt;=currentSize ;hole=child ) { child=hole*2; if (child!=currentSize&amp;&amp; //å¶æ•°ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œæœ€åä¸€ä¸ªholeåªæœ‰ä¸€ä¸ªå·¦å„¿å­ï¼Œå¦‚æœæ²¡æœ‰æ­¤æ¡ä»¶array[child+1]ä¼šå‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸ array[child+1].compareTo(array[child])&lt;0){//å³å„¿å­æ¯”å·¦å„¿å­è¿˜å° child++;//childæŒ‡å‘å³å„¿å­ } //å¦‚æœtempå¤§äºä¸¤ä¸ªå„¿å­ä¸­æœ€å°çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è®©ç©ºèŠ‚ç‚¹ä¸‹ç§»åˆ°child if (array[child].compareTo(temp)&lt;0){ array[hole]=array[child]; }else break; } array[hole]=temp; } public T findMin(){ if (isEmpty()){ System.out.println(\"å †ä¸ºç©º\"); } return array[1]; } å®Œæ•´ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147/** * å †(ä¼˜å…ˆé˜Ÿåˆ—) * * @author MaoLin Wang * @date 2020/2/1611:26 */public class BinaryHeap&lt;T extends Comparable&lt;? super T&gt;&gt; { private static final int DEFAULT_CAPACITY = 10; private int currentSize; private T[] array; public BinaryHeap() { this(DEFAULT_CAPACITY); } public BinaryHeap(int capacity) { this.currentSize = 0; array = (T[]) new Comparable[capacity + 1]; } public BinaryHeap(T[] array) { currentSize = array.length; this.array = (T[]) new Comparable[(currentSize + 2) * 11 / 10]; int i = 1; for (T arr : array) { array[i++] = arr; } buildHead(); } private void buildHead() { for (int i = currentSize/2; i &gt;0 ; i--) { percolateDown(i); } } private void enlargeArray(int newSize) { T[] old = array; array = (T[]) new Comparable[newSize]; for (int i = 0; i &lt; old.length; i++) { array[i] = old[i]; } } /** * å…ˆå»ºç«‹ä¸€ä¸ªç©ºä½ç½® hole,ä¸Šæ»¤ç›´åˆ°æ‰¾åˆ°æ»¡è¶³å †åºçš„ä½ç½®ï¼Œå°†xæ’å…¥åˆ°è¯¥ä½ç½® * array[0]æš‚å­˜å¾…æ’å…¥å…ƒç´ x * @param x */ public void insert(T x) { if (currentSize == array.length - 1) { enlargeArray(array.length * 2 + 1); } int hole=++currentSize; array[0]=x; percolateUp(hole,array[0]); } /** * ä¸Šæ»¤ * @param hole */ private void percolateUp(int hole,T x){ for ( ; x.compareTo(array[hole/2])&lt;0 ;hole /= 2) { array[hole]=array[hole/2]; } array[hole]=x; } /** * åˆ é™¤æœ€å°å…ƒç´ ï¼Œä¸‹æ»¤ * 1.æ‰¾åˆ°æœ€å°å…ƒç´ ï¼Œç§»é™¤ï¼ˆcurrentSize--,å¹¶å°†æœ€åä¸€ä¸ªå…ƒç´ æ”¾åœ¨æœ€å°å…ƒç´ ä½ç½®ï¼‰ * 2.å¯¹è¯¥å…ƒç´ è¿›è¡Œä¸‹æ»¤ * @return */ public T deleteMin(){ if (isEmpty()){ System.out.println(\"å †ä¸ºç©º\"); } T min = findMin(); array[1]=array[currentSize--]; percolateDown(1); return min; } /** * ä»holeå¼€å§‹ä¸‹æ»¤ * @param hole */ private void percolateDown(int hole) { int child; T temp = array[hole]; for ( ; hole*2&lt;=currentSize ;hole=child ) { child=hole*2; if (child!=currentSize&amp;&amp; //ä¿è¯å¶æ•°ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œæœ€åä¸€ä¸ªholeåªæœ‰ä¸€ä¸ªå·¦å„¿å­ array[child+1].compareTo(array[child])&lt;0){ child++; } if (array[child].compareTo(temp)&lt;0){ array[hole]=array[child]; }else break; } array[hole]=temp; } public T findMin(){ if (isEmpty()){ System.out.println(\"å †ä¸ºç©º\"); } return array[1]; } public void print(){ for (int i = 1; i &lt;currentSize ; i++) { System.out.println(array[i]); } } private boolean isEmpty() { return currentSize==0; } // Test program public static void main( String [ ] args ) { BinaryHeap&lt;Integer&gt; heap = new BinaryHeap&lt;&gt;(); heap.insert(13); heap.insert(14); heap.insert(16); heap.insert(19); heap.insert(21); heap.insert(19); heap.insert(68); heap.insert(65); heap.insert(26); heap.insert(32); heap.insert(31); System.out.println(\"-----\"); while (!heap.isEmpty()){ //ä¾æ­¤å‡ºé˜Ÿ System.out.println(heap.deleteMin()); } }} ç»“æœï¼š1314161919212631326568 å¤§é¡¶å †çš„ä¸‹æ»¤æ“ä½œä¹ŸåŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ”¹å˜ä¸€ä¸ªæ¯”è¾ƒçš„ç¬¦å·ã€‚ ä¸‰ã€å †æ’åºè®²å®Œäº†ä¼˜å…ˆé˜Ÿåˆ—çš„å®ç°åï¼Œå†å®ç°å †æ’åºå°±å¾ˆå®¹æ˜“äº†ã€‚è¿›è¡Œä¼˜å…ˆé˜Ÿåˆ—æ—¶ï¼Œæˆ‘ä»¬æ„é€ äº†å¤§é¡¶å †æˆ–å°é¡¶å †ã€‚è¿™é‡Œä¾ç„¶ä»¥å°é¡¶å †ä¸ºä¾‹ï¼š1.å¦‚æœæˆ‘ä»¬æƒ³è®©ä¸€ä¸ªå°é¡¶å †æ•°ç»„å˜æˆæœ‰åºæ•°ç»„ï¼Œåªéœ€ä»æœ€åä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œä¸æ ¹èŠ‚ç‚¹äº¤æ¢ï¼ˆç›¸å½“äºåœ¨ä¼˜å…ˆé˜Ÿåˆ—ä¸­åˆ é™¤æœ€å°å€¼ï¼Œä½†æ˜¯è¿™é‡ŒæŠŠæœ€å°å€¼ä¿å­˜åˆ°äº†æœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼‰ï¼ŒåŒæ—¶è®©currentSizeå‡ä¸€ã€‚2.å¯¹æ–°çš„æ ¹èŠ‚ç‚¹è¿›è¡Œä¸‹æ»¤æ“ä½œï¼Œç›´åˆ°currentSize3.è¿™æ ·å¾ªç¯ç›´åˆ°äº¤æ¢å®Œæ‰€æœ‰å…ƒç´ ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªä»å¤§åˆ°å°çš„æœ‰åºæ•°ç»„ å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * ä½¿ç”¨å°é¡¶å † ---&gt;ä»å¤§åˆ°å°æ’åº * @param arr */public static void heapSort(int[] arr){ for (int i = arr.length/2-1; i &gt;=0 ; i--) { //ä» arr.length/2-1 å³å€’æ•°ç¬¬ä¸€ä¸ªéå¶å­èŠ‚ç‚¹å¼€å§‹ï¼Œé€ä¸€ä¸‹æ»¤ï¼Œå½¢æˆå°é¡¶å † perDownMin(arr,i,arr.length); } for (int i = arr.length-1; i &gt;0 ; i--) { //å°†æ ¹èŠ‚ç‚¹ï¼Œå³æœ€å°çš„èŠ‚ç‚¹ä¸æœ€åä¸€ä¸ªèŠ‚ç‚¹äº¤æ¢ï¼Œè®©æœ€å°å€¼é€ä¸€æ”¾åœ¨æœ€å swap(arr,i,0); //ä»æ ¹èŠ‚ç‚¹å¼€å§‹é‡æ–°ç”Ÿæˆå°é¡¶å † perDownMin(arr,0,i); }} /** * å°é¡¶å †ä¸‹æ»¤ * @param arr * @param i * @param length */private static void perDownMin(int[]arr, int i, int length){ int child; int temp; for (temp=arr[i];leftChild(i)&lt;length ;i=child) { child=leftChild(i); if (leftChild(i)!=length-1&amp;&amp;arr[child+1]&lt;arr[child]){ child++; } if (temp&gt;arr[child]){ arr[i]=arr[child]; }else { break; } } arr[i]=temp;}private static void swap(int[] arr, int index1, int index2){ int temp=arr[index1]; arr[index1]=arr[index2]; arr[index2]=temp;} éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¸éœ€è¦åƒä¼˜å…ˆé˜Ÿåˆ—è¿›è¡Œåˆ é™¤ï¼ˆå‡ºé˜Ÿï¼‰å’Œæ’å…¥ï¼ˆå…¥é˜Ÿï¼‰æ“ä½œï¼Œå› æ­¤æ•°ç»„æ˜¯ä»0å¼€å§‹è€Œä¸æ˜¯ä»1å¼€å§‹ï¼Œåœ¨ä¸ªåˆ«åˆ¤æ–­æœ‰æ‰€ä¸åŒã€‚ åŒæ ·çš„æ–¹æ³•ä»¥å¤§é¡¶å †å®ç°å †æ’åºï¼š 1234567891011121314151617181920212223242526272829303132333435363738/** * ä½¿ç”¨å¤§é¡¶å † ----&gt; ä»å°åˆ°å¤§æ’åº * @param arr * @param &lt;T&gt; */ public static &lt;T extends Comparable&lt;? super T&gt;&gt;void heapSort(T[] arr){ for (int i = arr.length/2-1; i &gt;=0 ; i--) { perDownBig(arr,i,arr.length); } for (int i = arr.length-1; i &gt;0 ; i--) { swap(arr,0,i); perDownBig(arr,0,i); } } /** * å¤§é¡¶å †ä¸‹æ»¤ * @param arr * @param i * @param length * @param &lt;T&gt; */ private static &lt;T extends Comparable&lt;? super T&gt;&gt;void perDownBig(T[] arr, int i, int length){ int child; T temp; for(temp=arr[i];leftChild(i)&lt;length;i=child){ child=leftChild(i); if (child!= length-1 &amp;&amp; arr[child].compareTo(arr[child+1])&lt;0){ child++; } if (temp.compareTo(arr[child])&lt;0){ arr[i]=arr[child]; }else { break; } } arr[i]=temp; } leftChildæ˜¯ä¸€ä¸ªç§æœ‰çš„è®¡ç®—å­©å­èŠ‚ç‚¹ä½ç½®çš„æ–¹æ³•ï¼š 123private static int leftChild(int i){ return 2*i+1; } æµ‹è¯•ï¼š 123456789101112131415161718192021public static void main(String[] args) {/* int[] array =new int[8000000]; for (int i=0;i&lt;8000000;i++){ array[i]=(int)(Math.random()*8000000); } long begintime=System.currentTimeMillis(); heapSort(array); long endtime=System.currentTimeMillis(); System.out.println(\"ç”¨æ—¶ï¼š\"+(endtime-begintime)+\"ms\");*/ int[] array =new int[10]; for (int i=0;i&lt;10;i++){ array[i]=(int)(Math.random()*100); } heapSort(array); for (int i:array){ System.out.println(i); } } 123456789109777726965433219175 å †æ’åºçš„æ—¶é—´å¤æ‚åº¦ä¸º NlogNç©ºé—´å¤æ‚åº¦ä¸º 1","link":"/posts/20200310-HeapPQ.html"},{"title":"ã€Šç®—æ³•4ã€‹æœ€çŸ­è·¯å¾„é—®é¢˜ç¬”è®°","text":"ä¸€ã€æœ€çŸ­è·¯å¾„çš„å®šä¹‰ï¼šåœ¨ä¸€å¹…åŠ æƒæœ‰å‘å›¾ä¸­ï¼Œä»é¡¶ç‚¹såˆ°é¡¶ç‚¹tçš„æœ€çŸ­è·¯å¾„æ˜¯æ‰€æœ‰ä»såˆ°tçš„è·¯å¾„ä¸­çš„æƒé‡æœ€å°è€…ã€‚ äºŒã€æœ€çŸ­è·¯å¾„æ ‘ä¸€å¹…åŠ æƒæœ‰å‘å›¾ä¸­ï¼Œä»¥sä¸ºèµ·ç‚¹çš„ä¸€é¢—æœ€çŸ­è·¯å¾„æ ‘æ˜¯å›¾çš„ä¸€ä¸ªå­å›¾ï¼ŒåŒ…å«äº†så’Œä»så¯è¾¾çš„æ‰€æœ‰é¡¶ç‚¹ã€‚è¯¥æœ‰å‘æ ‘çš„æ ¹èŠ‚ç‚¹ä¸ºsï¼Œæ ‘çš„æ¯æ¡è·¯å¾„éƒ½æ˜¯æœ‰å‘å›¾ä¸­çš„ä¸€æ¡æœ€çŸ­è·¯å¾„ã€‚å³æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä»såˆ°è¾¾å›¾ä¸­ä»»ä½•é¡¶ç‚¹çš„æœ€çŸ­è·¯å¾„ã€‚ ä¸‰ã€åŠ æƒæœ‰å‘è¾¹12345678910111213141516171819202122232425262728293031323334353637public class DirectedEdge { /** * è¾¹çš„èµ·ç‚¹ */ private final int v; /** * è¾¹çš„ç»ˆç‚¹ */ private final int w; /** * è¾¹çš„æƒé‡ */ private final double weight; public DirectedEdge(int v, int w, double weight) { this.v = v; this.w = w; this.weight = weight; } public double weight(){ return weight; } public int from(){ return v; } public int to(){ return w; } @Override public String toString() { return String.format(\"%d-&gt;%d %.2f\",v,w,weight); }} å››ã€åŠ æƒæœ‰å‘å›¾åŒå‰é¢è®²å›¾ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå®ç°æ‰€éœ€çš„åŠ æƒæœ‰å‘å›¾çš„ç±»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990public class EdgeWeightedDigraph { private static final String NEWLINE = System.getProperty(\"line.separator\"); //é¡¶ç‚¹æ•° private final int V; //è¾¹æ•° private int E; //é¡¶ç‚¹vçš„å…¥åº¦ private int[] indegree; // indegree[v] = indegree of vertex v private Bag&lt;DirectedEdge&gt;[] adj; public EdgeWeightedDigraph(int v){ this.V=v; this.E=0; this.adj=new Bag[V]; this.indegree = new int[V]; for (int i = 0; i &lt; V; i++) { adj[i]=new Bag&lt;&gt;(); } } //æ·»åŠ ä¸€æ¡æœ‰å‘è¾¹ public void addEdge(DirectedEdge edge) { int from = edge.from(); validateVertex(from); int to = edge.to(); validateVertex(to); adj[from].add(edge); indegree[to]++; E++; } //é¡¶ç‚¹vçš„é‚»è¾¹ï¼Œå³ç”±vå‘å‡ºçš„è¾¹ public Iterable&lt;DirectedEdge&gt; adj(int v) { validateVertex(v); return adj[v]; } /** * é¡¶ç‚¹vçš„å‡ºåº¦ * @param v * @return */ public int outdegree(int v) { validateVertex(v); return adj[v].size(); } /** * é¡¶ç‚¹vçš„å…¥åº¦ * @param v * @return */ public int indegree(int v) { validateVertex(v); return indegree[v]; } public int V() { return V; } public int E() { return E; } //è¿”å›æ‰€æœ‰çš„è¾¹ public Iterable&lt;DirectedEdge&gt; edges(){ Bag&lt;DirectedEdge&gt;bag=new Bag&lt;&gt;(); for (int v = 0; v &lt; V; v++) { for (DirectedEdge edge:adj[v]){ bag.add(edge); } } return bag; } private void validateVertex(int v) { if (v &lt; 0 || v &gt;= V) throw new IllegalArgumentException(\"vertex \" + v + \" is not between 0 and \" + (V-1)); } public String toString() { StringBuilder s = new StringBuilder(); s.append(V + \" \" + E + NEWLINE); for (int v = 0; v &lt; V; v++) { s.append(v + \": \"); for (DirectedEdge e : adj[v]) { s.append(e + \" \"); } s.append(NEWLINE); } return s.toString(); }} äº”ã€æœ€çŸ­è·¯å¾„çš„æ•°æ®ç»“æ„ æœ€çŸ­è·¯å¾„æ ‘ä¸­çš„è¾¹å’Œå‰é¢è®²çš„DFSã€BFSä»¥åŠPrimç®—æ³•ä¸€æ ·ï¼Œè¿™é‡Œä½¿ç”¨DirectedEdge[] edgeToæ•°ç»„æ¥ä¿å­˜æœ€çŸ­è·¯å¾„æ ‘ä¸­çš„è¾¹ã€‚å…¶ä¸­edgeTo[v] è¡¨ç¤º æ ‘ä¸­è¿æ¥vå’Œå…¶çˆ¶èŠ‚ç‚¹çš„è¾¹ï¼ˆä¹Ÿæ˜¯ä»såˆ°vçš„æœ€çŸ­è·¯å¾„ä¸Šçš„æœ€åä¸€æ¡è¾¹ï¼‰ ä»»æ„ä¸€ä¸ªé¡¶ç‚¹vå’Œèµ·ç‚¹sçš„è·ç¦»ä½¿ç”¨edgeTo[] æ•°ç»„ä¿å­˜èµ·ç‚¹såˆ°ä»»æ„é¡¶ç‚¹vçš„å·²çŸ¥æœ€çŸ­è·¯å¾„é•¿åº¦ åŒæ—¶åšä»¥ä¸‹çº¦å®šï¼šå¯¹äºèµ·ç‚¹sï¼š edgeTo[s]= null; distTo[s] =0.0å¦‚æœvä»sä¸å¯è¾¾ï¼šdistTo[v] = Double.POSITIVE_INFINITY å…­ã€æœ€çŸ­è·¯å¾„çš„æ±‚è§£æ€è·¯è¾¹çš„æ¾å¼›è¦æƒ³æ±‚å¾—æœ€çŸ­è·¯å¾„ï¼Œæ¯åŠ å…¥ä¸€ä¸ªæ–°çš„è¾¹ï¼Œéƒ½å¿…é¡»å¯¹è¾¹è¿›è¡Œâ€œæ¾å¼›â€æ“ä½œã€‚å…ˆçœ‹å¦‚ä¸‹ç¤ºä¾‹ï¼š å·²çŸ¥distTo[v] = 3.0ï¼Œå³ä»såˆ°vçš„æœ€çŸ­è·¯å¾„æƒé‡ä¸º3.0ï¼›è€Œåˆ°wçš„æœ€çŸ­è·¯å¾„ä¸º3.4å‡è®¾ å¾…åŠ å…¥çš„æ–°è¾¹ v -&gt; w çš„æƒé‡ä¸º0.2ï¼Œ æ­¤æ—¶ distTo[v]+0.2 =3.2 å°äºåŸæœ¬distTo[w]=3.4ï¼Œå› æ­¤ä»såˆ°wçš„æœ€çŸ­è·¯å¾„åº”è¯¥ç»è¿‡vå†åˆ°wï¼Œä¸”æƒé‡ä¸º3.2 å› æ­¤æˆ‘ä»¬éœ€è¦æ›´æ–°distTo[w]çš„å€¼ä¸º distTo[v]+0.2ï¼Œè¿™æ ·æ‰èƒ½å¾—åˆ°ä¸€ä¸ªæ›´çŸ­çš„è·¯å¾„ï¼›å¹¶ä¸”æ›´æ–°edgeTo[w]=è¾¹v-&gt;wï¼Œæ­¤æ—¶è¾¹ q -&gt; w å°±ä¸ä¼šå†å­˜æ”¾äºæœ€çŸ­è·¯å¾„æ ‘ä¸­ï¼Œå·²ç»å¤±æ•ˆã€‚ æˆ‘ä»¬å°†å¦‚ä¸Šçš„è¿™æ ·ä¸€ä¸ªæ“ä½œå«åšå¯¹è¯¥è¾¹çš„ä¸€æ¬¡æˆåŠŸçš„æ¾å¼›(æ”¾æ¾) è€Œå¦‚æœdistTo[v]åŠ ä¸Šè¾¹v-&gt;wçš„æƒé‡å¤§äºdistTo[w]ï¼Œåˆ™ä¸åšæ›´æ–°ï¼Œå®ƒä¼šè®© è¾¹v-&gt;w å¤±æ•ˆã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ¾å¼›çš„å®šä¹‰ï¼š æ”¾æ¾è¾¹v -&gt; wæ„å‘³ç€ä»såˆ°wçš„æœ€çŸ­è·¯å¾„æ˜¯å¦æ˜¯å…ˆä»såˆ°vï¼Œå†ä»våˆ°wã€‚å¦‚æœæ˜¯ï¼Œåˆ™æ ¹æ®è¯¥æƒ…å†µæ›´æ–°æ•°æ®ç»“æ„çš„å†…å®¹ã€‚ ç”±ä¸Šæˆ‘ä»¬å¯ä»¥å¾—åˆ°é€šç”¨çš„æœ€çŸ­è·¯å¾„ç®—æ³•ï¼š1.å°†distTo[s]åˆå§‹åŒ–ä¸º0ï¼Œå…¶ä»–é¡¶ç‚¹çš„distToä¸ºæ— ç©·å¤§2.æ”¾æ¾æœ‰å‘å›¾ä¸­çš„ä»»æ„ä¸€ä¸ªè¾¹ï¼Œç›´åˆ°ä¸å­˜åœ¨æœ‰æ•ˆè¾¹ä¸ºæ­¢ ç»è¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿è¯å¯¹äºä»»æ„ä¸€ä¸ªä»så¯è¾¾çš„é¡¶ç‚¹wï¼ŒdistTo[w] ä¸€å®šæ˜¯ä»såˆ°wçš„æœ€çŸ­è·¯å¾„ï¼Œä¸”edgeTo[w] ä¸ºsåˆ°wçš„æœ€çŸ­è·¯å¾„ä¸Šçš„æœ€åä¸€æ¡è¾¹ã€‚ ä¸ƒã€Dijkstraï¼ˆè¿ªæ°æ–¯ç‰¹æ‹‰ï¼‰ç®—æ³•æœ‰äº†ä¸Šé¢çš„åŸºç¡€ï¼Œæˆ‘ä»¬å†æ¥å¼•å…¥æœ€ç»ˆè§£å†³æœ€çŸ­è·¯å¾„çš„Dijkstraç®—æ³•ï¼ˆå…¶å®ä¸Šé¢å·²ç»è¯´çš„å·®ä¸å¤šäº†ï¼‰ï¼šDijkstraçš„æ€è·¯è·ŸPrimç±»ä¼¼ï¼Œä½†æ˜¯Primç®—æ³•æ¯æ¬¡æ·»åŠ çš„éƒ½æ˜¯è·ç¦»æ ‘æœ€è¿‘çš„éæ ‘é¡¶ç‚¹ï¼Œè€ŒDijkstraç®—æ³•æ¯æ¬¡æ·»åŠ çš„æ˜¯ç¦»èµ·ç‚¹sæœ€è¿‘çš„éæ ‘é¡¶ç‚¹ã€‚ å› æ­¤æˆ‘ä»¬ä¹Ÿéœ€è¦å€ŸåŠ©ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—(ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—çš„è®²è§£ä¸å®ç°å‚è€ƒæ–‡ç« https://wbml.top/posts/20200310-indexPQ.html)æ¥å®ç°ï¼Œå°†é¡¶ç‚¹vä½œä¸ºç´¢å¼•ï¼Œä»såˆ°vçš„æœ€çŸ­è·¯å¾„çš„æƒé‡å€¼ä½œä¸ºç´¢å¼•å…³è”çš„å€¼ã€‚ æ­¥éª¤å¦‚ä¸‹ï¼š å°†distTo[s]åˆå§‹åŒ–ä¸º0ï¼Œæ•°ç»„çš„å…¶ä»–å…ƒç´ åˆå§‹åŒ–ä¸ºæ— ç©·å¤§ï¼Œå¹¶å°†så’ŒdistTo[s]åŠ å…¥ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ï¼› å–å‡ºé˜Ÿåˆ—ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„ç´¢å¼•ï¼ˆé¡¶ç‚¹ï¼‰ï¼Œå¯¹ä»è¯¥é¡¶ç‚¹å‡ºå‘çš„é‚»è¾¹è¿›è¡Œæ”¾æ¾ï¼Œå¹¶å°†æ”¾æ¾æˆåŠŸçš„è¾¹çš„å¦ä¸€ä¸ªé¡¶ç‚¹åŠå…¶å¯¹åº”çš„distToå€¼åŠ å…¥åˆ°ä¼˜å…ˆé˜Ÿåˆ—ä¸­ï¼ˆç¬¬ä¸€æ¬¡è®¿é—®åˆ°è¯¥ç‚¹æ—¶ï¼Œå°šæœªå°†å…¶åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå³distToä¸ºæ— ç©·å¤§ï¼‰æˆ–æ›´æ–°ä¼˜å…ˆé˜Ÿåˆ—ä¸­å¯¹åº”çš„å€¼ï¼ˆè¯¥é¡¶ç‚¹æ–°çš„distToå€¼æ¯”åŸæ¥å°ï¼‰ï¼› å½“ä¼˜å…ˆé˜Ÿåˆ—éç©ºæ—¶ï¼Œæ¯æ¬¡éƒ½å–å‡ºä¸€ä¸ªç´¢å¼•ï¼ˆé¡¶ç‚¹ï¼‰ï¼ŒæŒ‰2çš„æ–¹å¼è¿›è¡Œæ”¾æ¾ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºï¼ˆå³æ‰€æœ‰é¡¶ç‚¹éƒ½è¢«åŠ å…¥åˆ°ç”Ÿæˆæ ‘ä¸­ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public class DijkstraSP { private DirectedEdge[] edgeTo; private double[] distTo; /** * ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ï¼šé¡¶ç‚¹vä½œä¸ºç´¢å¼•ï¼Œä»èµ·ç‚¹åˆ°vçš„æœ€çŸ­è·¯å¾„çš„æƒå€¼ä½œä¸ºç´¢å¼•å…³è”çš„å¯¹è±¡ */ private IndexMinPQ&lt;Double&gt; pq; public DijkstraSP(EdgeWeightedDigraph digraph,int s){ for (DirectedEdge e : digraph.edges()) { if (e.weight() &lt; 0) throw new IllegalArgumentException(\"è¾¹ \" + e + \" çš„æƒé‡ä¸ºè´Ÿå€¼ï¼\"); } edgeTo=new DirectedEdge[digraph.V()]; distTo=new double[digraph.V()]; pq=new IndexMinPQ&lt;&gt;(digraph.V()); //åˆå§‹åŒ–ä¸ºæ— ç©·å¤§ for (int v = 0; v &lt; digraph.V(); v++) { distTo[v]=Double.POSITIVE_INFINITY; } distTo[s]=0; pq.insert(s,0.0); while (!pq.isEmpty()){ relax(digraph,pq.delMin()); } } /** * å¯¹é¡¶ç‚¹vçš„é‚»è¾¹æ”¾æ¾ * @param digraph * @param v */ private void relax(EdgeWeightedDigraph digraph, int v) { for (DirectedEdge edge:digraph.adj(v)){ int to=edge.to(); if (distTo[to]&gt;distTo[v]+edge.weight()){ distTo[to]=distTo[v]+edge.weight(); edgeTo[to]=edge; if (pq.contains(to)){ pq.changeKey(to,distTo[to]); }else { pq.insert(to,distTo[to]); } } } }} å› æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥è§£å†³å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š1.è¯¥å›¾çš„æœ€çŸ­è·¯å¾„æ ‘ï¼›2.ä»såˆ°ä»»æ„é¡¶ç‚¹vçš„æœ€çŸ­è·¯å¾„3.æ˜¯å¦å­˜åœ¨ä»såˆ°vçš„æœ€çŸ­è·¯å¾„ï¼Œåªè¦distTo[v] éæ— ç©·å¤§å³å­˜åœ¨ã€‚ 123456789101112131415161718192021222324252627282930313233/** * ä»èµ·ç‚¹åˆ°é¡¶ç‚¹vçš„æœ€çŸ­è·¯å¾„æƒå€¼ * @param v * @return */public double distTo(int v){ return distTo[v];}/** * æ˜¯å¦å­˜åœ¨ä»såˆ°vçš„æœ€çŸ­è·¯å¾„ * @param v * @return */public boolean hasPathTo(int v){ return distTo[v]&lt;Double.POSITIVE_INFINITY;}/** * è¿”å›ä»såˆ°vçš„æœ€çŸ­è·¯å¾„ * @param v * @return */public Iterable&lt;DirectedEdge&gt; pathTo(int v){ if (!hasPathTo(v))return null; Stack&lt;DirectedEdge&gt; path=new Stack&lt;&gt;(); for (DirectedEdge edge=edgeTo[v];edge!=null;edge=edgeTo[edge.from()]) { path.push(edge); } return path;} å°†Dijkstraç®—æ³•ç¨ä½œæ”¹åŠ¨å°±å¯ä»¥å®ç°ä»»æ„é¡¶ç‚¹å¯¹ä¹‹é—´çš„æœ€çŸ­è·¯å¾„é—®é¢˜ï¼š 123456789101112131415161718public class DijkstraAllPairsSP { private DijkstraSP[]all; public DijkstraAllPairsSP(EdgeWeightedDigraph digraph){ all=new DijkstraSP[digraph.V()]; for (int i = 0; i &lt; digraph.V(); i++) { all[i]=new DijkstraSP(digraph,i); } } public Iterable&lt;DirectedEdge&gt; path(int s,int t){ return all[s].pathTo(t); } public double distBetween(int s,int t){ return all[s].distTo(t); }} Dijkstraç®—æ³•é€‚ç”¨äºåŠ æƒæœ‰å‘éè´Ÿæƒå€¼çš„å•èµ·ç‚¹å›¾çš„æœ€çŸ­è·¯å¾„é—®é¢˜ï¼Œæœ‰ç¯æ— ç¯éƒ½ä¸å½±å“æ­£ç¡®æ€§ã€‚ å…«ã€æ— ç¯åŠ æƒæœ‰å‘å›¾ä¸­çš„æœ€çŸ­è·¯å¾„ç®—æ³•è®¸å¤šåº”ç”¨ä¸­çš„åŠ æƒæœ‰å‘å›¾éƒ½æ˜¯ä¸å«æœ‰æœ‰å‘ç¯çš„ï¼Œå› æ­¤æˆ‘ä»¬ä»‹ç»ä¸€ä¸ªåŸºäºæ— ç¯çš„åŠ æƒæœ‰å‘å›¾çš„æœ€çŸ­è·¯å¾„ç®—æ³•ï¼Œè¯¥ç®—æ³•æ¯”Dijkstraç®—æ³•è¦å¿«ï¼Œèƒ½å¤Ÿåœ¨çº¿æ€§æ—¶é—´å†…è§£å†³è¯¥é—®é¢˜ï¼Œä¸”èƒ½å¤Ÿå¤„ç†è´Ÿæƒå€¼çš„è¾¹ï¼Œå¹¶æ‰¾å‡ºæœ€é•¿è·¯å¾„ã€‚ è¯¥ç®—æ³•çš„æ€æƒ³æ˜¯ï¼š æŒ‰ç…§å›¾çš„æ‹“æ‰‘æ’åºä¸€ä¸ªä¸ªæ”¾æ¾æ‰€æœ‰çš„é¡¶ç‚¹ï¼Œå°±èƒ½åœ¨å’ŒE+Væˆæ­£æ¯”çš„æ—¶é—´å†…è§£å†³æ— ç¯åŠ æƒæœ‰å‘å›¾çš„å•ç‚¹æœ€çŸ­è·¯å¾„é—®é¢˜ã€‚ è¯æ˜å¦‚ä¸‹ï¼šæ¯æ¡è¾¹v-&gt;wåªä¼šè¢«æ”¾æ¾ä¸€æ¬¡ã€‚å› ä¸ºé¡¶ç‚¹vè¢«æ”¾æ¾æ—¶ï¼ŒdistTo[w]&lt;=distTo[v]+e.weight()ï¼Œåœ¨ç®—æ³•ç»“æŸå‰ï¼Œè¯¥ä¸ç­‰å¼å§‹ç»ˆæˆç«‹ã€‚å› ä¸ºæˆ‘ä»¬æ˜¯æŒ‰ç…§æ‹“æ‰‘æ’åºæ”¾æ¾é¡¶ç‚¹ï¼Œæ‰€ä»¥vè¢«æ”¾æ¾åï¼Œå°±ä¸ä¼šå¤„ç†ä»»ä½•æŒ‡å‘vçš„è¾¹ï¼Œè€ŒdistTo[w]çš„å€¼åªèƒ½å˜å°ã€‚ å®ç°å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class AcyclicSP { private DirectedEdge[] edgeTo; private double[] distTo; public AcyclicSP(EdgeWeightedDigraph digraph,int s){ edgeTo=new DirectedEdge[digraph.V()]; distTo=new double[digraph.V()]; for (int v=0;v&lt;digraph.V();v++){ distTo[v]=Double.POSITIVE_INFINITY; } distTo[s]=0.0; //å…ˆæ±‚å‡ºæ‹“æ‰‘æ’åº TopologicalSort sort=new TopologicalSort(digraph); if (!sort.hasOrder()){ throw new IllegalArgumentException(\"Digraph is not acyclic.\"); } //æŒ‰ç…§æ‹“æ‰‘æ’åºæ”¾æ¾é¡¶ç‚¹ for(int v:sort.order()){ relax(digraph,v); } } private void relax(EdgeWeightedDigraph digraph, int v) { for (DirectedEdge edge:digraph.adj(v)){ int to=edge.to(); if (distTo[to]&gt;distTo[v]+edge.weight()){ distTo[to]=distTo[v]+edge.weight(); edgeTo[to]=edge; } } } public double distTo(int v){ return distTo(v); } public boolean hasPathTo(int v){ return distTo(v)&lt;Double.POSITIVE_INFINITY; } public Iterable&lt;DirectedEdge&gt; pathTo(int v){ Stack&lt;DirectedEdge&gt; path=new Stack&lt;&gt;(); for ( DirectedEdge edge=edgeTo[v]; edge!=null ; edge=edgeTo[edge.from()]) { path.push(edge); } return path; }} å¦‚æœæˆ‘ä»¬å¯¹ä¸Šè¿°ç®—æ³•ç¨ä½œä¿®æ”¹ï¼Œå³å°†distToçš„åˆå§‹å€¼è®¾ä¸ºæ— ç©·å°ï¼Œå°†æ”¾æ¾æ—¶distTo[w]&gt;&lt;distTo[v]+edge.weight()çš„æ¡ä»¶ä¿®æ”¹ä¸ºdistTo[w]&lt;distTo[from]+edge.weight()ï¼Œå°±å¯ä»¥å®ç°æ— ç¯åŠ æƒæœ‰å‘å›¾ä¸­çš„å•ç‚¹æœ€é•¿è·¯å¾„ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556/** * åŠ æƒæœ‰å‘æ— ç¯å›¾çš„æœ€é•¿è·¯å¾„ * @author MaoLin Wang * @date 2020/2/2416:38 */public class AcyclicLP { private double[] distTo; private DirectedEdge[] edgeTo; public AcyclicLP(EdgeWeightedDigraph digraph,int s) { distTo=new double[digraph.V()]; edgeTo=new DirectedEdge[digraph.V()]; for (int i = 0; i &lt; digraph.V(); i++) { //åˆå§‹åŒ–ä¸ºæ— ç©·å° distTo[i]=Double.NEGATIVE_INFINITY; } distTo[s]=0.0; TopologicalSort sort=new TopologicalSort(digraph); if (sort.order()==null){ throw new IllegalArgumentException(\"å‚æ•°é”™è¯¯\"); } for (int w:sort.order()){ relax(digraph,w); } } private void relax(EdgeWeightedDigraph digraph, int v) { for (DirectedEdge edge:digraph.adj(v)){ int to=edge.to(),from = edge.from(); if (distTo[to]&lt;distTo[from]+edge.weight()){ //ä¿®æ”¹ä¸º&lt; distTo[to]=distTo[from]+edge.weight(); edgeTo[to]=edge; } } } public double distTo(int v) { return distTo[v]; } public boolean hasPathTo(int v) { return distTo[v] &gt; Double.NEGATIVE_INFINITY; } public Iterable&lt;DirectedEdge&gt; pathTo(int v){ if (!hasPathTo(v)){ return null; } Stack&lt;DirectedEdge&gt; path=new Stack&lt;&gt;(); for (DirectedEdge edge=edgeTo[v];edge!=null;edge=edgeTo[edge.from()]){ path.push(edge); } return path; }} ä¹ã€ä¸€èˆ¬åŠ æƒæœ‰å‘å›¾ä¸­çš„æœ€çŸ­è·¯å¾„ç®—æ³•è¯¥ç®—æ³•è§£å†³æ—¢å¯èƒ½å«æœ‰ç¯ï¼Œä¹Ÿå¯èƒ½å«æœ‰è´Ÿæƒå€¼è¾¹çš„åŠ æƒæœ‰å‘å›¾çš„æœ€çŸ­è·¯å¾„ç®—æ³•ã€‚ è¿™ä¸ªä»…åšè®°å½•å§ï¼Œå¯èƒ½ä¸ªäººè®²çš„ä¸å¤ªæ˜ç™½ã€‚ è§£å†³è¯¥é—®é¢˜çš„ç®—æ³•è¯•Bellman-Fordç®—æ³•ï¼Œå®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118/** * åŸºäºé˜Ÿåˆ—çš„Bellman-Fordç®—æ³• * åœ¨ä»»æ„å«æœ‰Vä¸ªé¡¶ç‚¹çš„åŠ æƒæœ‰å‘å›¾ä¸­ç»™å®šèµ·ç‚¹sï¼Œä»sæ— æ³•åˆ°è¾¾ä»»ä½•è´Ÿæƒé‡ç¯ * å°†distTo[s]åˆå§‹åŒ–ä¸º0ï¼Œå…¶ä»–distTo[]å…ƒç´ ä¸ºæ— ç©·å¤§ï¼Œä»¥ä»»æ„é¡ºåºæ”¾æ¾æœ‰å‘å›¾çš„æ‰€æœ‰è¾¹ï¼Œé‡å¤Vè½® * @author MaoLin Wang * @date 2020/2/2421:41 */public class BellmanFordSP { private double[] distTo; private DirectedEdge[] edgeTo; /** * è¯¥é¡¶ç‚¹æ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­ */ private boolean[] onQ; /** * æ­£åœ¨è¢«æ”¾æ¾çš„é¡¶ç‚¹ */ private Queue&lt;Integer&gt; queue; /** * relax()çš„è°ƒç”¨æ¬¡æ•° */ private int cost; /** * edgeTo[]ä¸­æ˜¯å¦æœ‰è´Ÿæƒé‡ç¯ */ private Iterable&lt;DirectedEdge&gt; cycle; public BellmanFordSP(EdgeWeightedDigraph digraph,int s) { distTo=new double[digraph.V()]; edgeTo=new DirectedEdge[digraph.V()]; onQ=new boolean[digraph.V()]; queue=new Queue&lt;&gt;(); for (int v = 0; v &lt; digraph.V(); v++) { distTo[v]=Double.POSITIVE_INFINITY; } distTo[s]=0.0; queue.enqueue(s); onQ[s]=true; while (!queue.isEmpty() &amp;&amp; !hasNegativeCycle()){ int v=queue.dequeue(); onQ[v]=false; relax(digraph,v); } } private void relax(EdgeWeightedDigraph digraph, int v) { for (DirectedEdge edge:digraph.adj(v)){ int to=edge.to(); if (distTo[to]&gt;distTo[v]+edge.weight()){ distTo[to]=distTo[v]+edge.weight(); edgeTo[to]=edge; if (!onQ[to]){ queue.enqueue(to); onQ[to]=true; } } //è°ƒç”¨Væ¬¡relaxåæŸ¥æ‰¾è´Ÿæƒé‡ç¯ if (cost++ % digraph.V()==0){ findNegativeCycle(); } } } /** * æŸ¥æ‰¾è´Ÿæƒé‡ç¯ï¼Œæ²¡æœ‰åˆ™è¿”å›null */ private void findNegativeCycle() { int V=edgeTo.length; EdgeWeightedDigraph digraph; digraph=new EdgeWeightedDigraph(V); for (int v = 0; v &lt; V; v++) { if (edgeTo[v]!=null){ digraph.addEdge(edgeTo[v]); } } EdgeWeightedDirectedCycle directedCycle; directedCycle=new EdgeWeightedDirectedCycle(digraph); cycle=directedCycle.cycle(); } /** * æ˜¯å¦å«æœ‰è´Ÿæƒé‡ç¯ * @return */ public boolean hasNegativeCycle() { return cycle!=null; } public Iterable&lt;DirectedEdge&gt; negativeCycle(){ return cycle; } public boolean hasPathTo(int v){ return distTo[v]&lt;Double.POSITIVE_INFINITY; } public double distTo(int v){ return distTo[v]; } public Iterable&lt;DirectedEdge&gt; pathTo(int v){ if (hasNegativeCycle()) throw new UnsupportedOperationException(\"Negative cost cycle exists\"); if (!hasPathTo(v)) return null; Stack&lt;DirectedEdge&gt; path = new Stack&lt;DirectedEdge&gt;(); for (DirectedEdge e = edgeTo[v]; e != null; e = edgeTo[e.from()]) { path.push(e); } return path; } }","link":"/posts/20200310-sp-dijkstra.html"},{"title":"ã€Šç®—æ³•4ã€‹çº¢é»‘æ ‘çš„åŸç†è§£æ---javaå®ç°","text":"å‰é¢è®²äº†AVLå¹³è¡¡æ ‘çš„å®ç°https://wbml.top/posts/20200310-avltree.htmï¼Œä½†ç”±äºAVLæ˜¯é«˜åº¦å¹³è¡¡çš„æ ‘ï¼ˆé«˜åº¦å·®å°äºç­‰äº1ï¼‰ï¼Œè€Œçº¢é»‘æ ‘æ˜¯æ ¹æ®é¢œè‰²æ¥ä¸ä¸¥æ ¼çš„å®ç°å¹³è¡¡ï¼Œå› æ­¤åœ¨æ’å…¥å’Œåˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œçº¢é»‘æ ‘çš„è°ƒæ•´æ¬¡æ•°è¾ƒå°‘ï¼Œå°¤å…¶æ˜¯åœ¨å¤§é‡æ•°æ®é¢å‰æ—¶ï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡ä¼šæ›´é«˜ã€‚å…¶æ˜¯AVLæ ‘çš„ä¸€ä¸ªå˜ç§ã€‚ ä¸€ã€å®šä¹‰ä»‹ç»é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯2-èŠ‚ç‚¹ï¼Œä»€ä¹ˆæ˜¯3-èŠ‚ç‚¹ã€‚2-èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„äºŒå‰èŠ‚ç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸¤ä¸ªé“¾æ¥3-èŠ‚ç‚¹åˆ™æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹ä¸‰ä¸ªé“¾æ¥ çº¢é»‘æ ‘ä¸­ï¼Œæ ‘çš„é“¾æ¥æœ‰ä¸¤ç§ç±»å‹ï¼šçº¢é“¾æ¥å’Œé»‘é“¾æ¥ä¸€ä¸ªçº¢é“¾æ¥å°†ä¸¤ä¸ª2-èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ª3-èŠ‚ç‚¹é»‘é“¾æ¥å°±æ˜¯ä¸€ä¸ªæ™®é€šè¿æ¥ï¼Œå¦‚ä¸‹ï¼šä¸Šé¢çš„2-3æ ‘å¯¹åº”ä¸‹é¢çš„çº¢é»‘æ ‘ å®šä¹‰å¦‚ä¸‹ï¼š1.çº¢é“¾æ¥éƒ½æ˜¯å·¦é“¾æ¥ï¼Œä¸å…è®¸ä¸ºå³é“¾æ¥ï¼ˆä»…å› å‡å°ä»£ç é‡ï¼‰2.æ²¡æœ‰ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹åŒæ—¶å’Œä¸¤æ¡çº¢é“¾æ¥ç›¸è¿3.è¯¥æ ‘æ˜¯å®Œç¾é»‘è‰²å¹³è¡¡çš„ï¼Œå³ä»»æ„ç©ºè¿æ¥åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„ä¸Šçš„é»‘é“¾æ¥æ•°é‡ç›¸åŒã€‚ äºŒã€æ•°æ®ç»“æ„å¦‚ä¸‹ï¼šæ¯ä¸ªèŠ‚ç‚¹å¢åŠ äº†ä¸€ä¸ªå¸ƒå°”ç±»å‹colorå˜é‡ï¼Œè¡¨ç¤ºæŒ‡å‘è¯¥èŠ‚ç‚¹çš„é“¾æ¥çš„é¢œè‰²ï¼Œcolorçš„å–å€¼ä¸ºREDï¼ˆtrueï¼‰å’ŒBLACK(false) 1234567891011121314151617181920212223242526272829303132public class RedBlackTree&lt;Key extends Comparable&lt;Key&gt;,Value&gt; { private static final boolean RED=true; private static final boolean BLACK= false; private Node root; private class Node{ // å·¦å³å­©å­ private Node left,right; /** * å…¶çˆ¶èŠ‚ç‚¹æŒ‡å‘è¯¥èŠ‚ç‚¹çš„é“¾æ¥é¢œè‰² */ private boolean color; //é”® private Key key; //é”®å…³è”çš„å€¼ private Value value; /** * å­æ ‘ä¸­çš„èŠ‚ç‚¹æ€»æ•° */ private int size; public Node( boolean color,Key key,Value value, int size) { this.key=key; this.color = color; this.value = value; this.size = size; } }} ä¸‰ã€æ—‹è½¬æ“ä½œåœ¨å¯¹çº¢é»‘æ ‘è¿›è¡Œæ“ä½œæ—¶ï¼Œéš¾å…ä¼šå‡ºç°è¿ç»­çš„ä¸¤ä¸ªçº¢é“¾æ¥ç›¸è¿ï¼Œçº¢é“¾æ¥å¯èƒ½æ˜¯è¿ç»­ä¸¤ä¸ªå·¦é“¾æ¥ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå³é“¾æ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ—‹è½¬é“¾æ¥è¿›è¡Œä¿®å¤ã€‚çº¢é»‘æ ‘çš„æ—‹è½¬ä¸€å…±æœ‰ä¸¤ä¸ªæƒ…å†µï¼š1.å¯¹ä¸€ä¸ªå³çº¢é“¾æ¥å·¦æ—‹è½¬å¦‚ä¸‹å›¾ï¼Œå¯¹å³é“¾æ¥ä¸ºçº¢è‰²çš„èŠ‚ç‚¹fè¿›è¡Œå·¦æ—‹è½¬ï¼Œå˜ä¸ºä¸‹é¢ä¸€ä¸ªå›¾ï¼šä»£ç å¦‚ä¸‹ï¼š ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920/** * å·¦æ—‹è½¬(å³é“¾æ¥ä¸ºçº¢è‰²) * @param node * @return */ private Node rotateLeft(Node node){ //è¿™é‡Œæ—‹è½¬é€»è¾‘åŒAVL Node right=node.right; node.right=right.left; right.left=node; //ä½†æ˜¯éœ€è¦ä¿®æ”¹ä¸¤ä¸ªèŠ‚ç‚¹çš„é¢œè‰² //å°†å³èŠ‚ç‚¹çš„é¢œè‰²æ”¹ä¸ºnodeçš„é¢œè‰² right.color=node.color; //å°†node çš„é¢œè‰²æ”¹ä¸ºçº¢è‰²ï¼Œå› ä¸ºæ˜¯æŠŠçº¢é“¾æ¥æ—‹è½¬è¿‡æ¥ï¼Œè¿™é‡Œå¿…ç„¶æ˜¯çº¢è‰² node.color=RED; right.size=node.size; node.size=1+size(node.left)+size(node.right); return right; } 2.å¯¹ä¸€ä¸ªå·¦çº¢é“¾æ¥å³æ—‹è½¬å¦‚ä¸‹å›¾ï¼Œå¯¹å·¦é“¾æ¥ä¸ºçº¢è‰²çš„èŠ‚ç‚¹bè¿›è¡Œå³æ—‹è½¬ï¼Œå˜ä¸ºä¸‹é¢ä¸€ä¸ªå›¾ï¼šä»£ç å¦‚ä¸‹ï¼šé€»è¾‘å’Œä¸Šé¢ä¸€æ ·ï¼Œç›¸åè€Œå·² 123456789101112131415161718/** * å³æ—‹è½¬(å·¦é“¾æ¥ä¸ºçº¢è‰²) * @param node * @return */ private Node rotateRight(Node node){ Node left=node.left; node.left=left.right; left.right=node; left.color=node.color; node.color=RED; left.size=node.size; node.size=1+size(node.left)+size(node.right); return left; } å››ã€æ’å…¥æ“ä½œæˆ‘ä»¬åœ¨æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œé»˜è®¤è®©å…¶é¢œè‰²ä¸ºçº¢è‰²ï¼Œè¿™æ ·å°±ä¼šå‡ºç°ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š å½“æ’å…¥åˆ°ä¸€ä¸ª2-èŠ‚ç‚¹æ—¶ï¼šæ­¤æ—¶æœ‰ä¸¤ç§æƒ…å†µï¼š æŒ‡å‘æ–°èŠ‚ç‚¹çš„é“¾æ¥æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦é“¾æ¥ï¼šæ­¤æ—¶çˆ¶é“¾æ¥ç›´æ¥æˆäº†ä¸€ä¸ª3-èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼Œæ’å…¥èŠ‚ç‚¹aï¼Œæ­¤æ—¶aä¸çˆ¶èŠ‚ç‚¹bæˆä¸ºä¸€ä¸ª3-èŠ‚ç‚¹ æŒ‡å‘æ–°èŠ‚ç‚¹çš„é“¾æ¥æ˜¯çˆ¶èŠ‚ç‚¹çš„å³é“¾æ¥ï¼š æ­¤æ—¶æ˜¯ä¸€ä¸ªé”™è¯¯çš„3-èŠ‚ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬è§„å®šçº¢é“¾æ¥å¿…é¡»çš„å·¦é“¾æ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œå·¦æ—‹è½¬ï¼š å¦‚ä¸‹å›¾æ–°æ’å…¥äº†ä¸€ä¸ªèŠ‚ç‚¹cï¼ŒæŒ‡å‘å®ƒçš„é“¾æ¥ä¸ºçˆ¶é“¾æ¥èŠ‚ç‚¹bçš„å³é“¾æ¥ å¯¹é½è¿›è¡Œå·¦æ—‹è½¬ä¿®æ­£ï¼Œå¦‚ä¸‹å›¾ï¼š å½“æ’å…¥åˆ°ä¸€ä¸ª3-èŠ‚ç‚¹æ—¶ï¼š1.æ’å…¥çš„æ˜¯3-èŠ‚ç‚¹çš„å³é“¾æ¥æ­¤æ—¶éœ€è¦å°†ä¸¤ä¸ªé“¾æ¥éƒ½å˜ä¸ºé»‘è‰²ï¼šè¿™ä¸ªè¿‡ç¨‹å«åšé¢œè‰²è½¬æ¢ï¼š 12345private void flipColors(Node node){ node.color = !node.color; node.left.color = !node.left.color; node.right.color = !node.right.color; } ä¹¦ä¸Šç»™çš„æ˜¯è®©nodeå˜ä¸ºçº¢è‰²ï¼Œå·¦å³å­©å­å˜ä¸ºé»‘è‰²ï¼Œä½†å› ä¸ºåé¢è¿˜è¦ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯è½¬æ¢ä¸ºä¸åŸæ¥é¢œè‰²å¯¹åº”çš„é¢œè‰²ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å†™æˆè¿™æ ·ï¼ŒåŒæ ·é€‚ç”¨ã€‚åœ¨æˆ‘ä»¬æ¯æ¬¡æ’å…¥åéƒ½ä¼šè®©æ ¹èŠ‚ç‚¹å˜ä¸ºé»‘è‰²ï¼Œè€Œå¦‚æœæ ¹èŠ‚ç‚¹ä»çº¢å˜ä¸ºé»‘æ˜¯ï¼Œå°±æ„å‘³ç€å…¶é«˜åº¦åŠ 1 2.æ’å…¥çš„æ˜¯3-èŠ‚ç‚¹çš„ä¸­é“¾æ¥ æ­¤æ—¶éœ€è¦å…ˆå¯¹èŠ‚ç‚¹aè¿›è¡Œå·¦æ—‹è½¬å˜æˆå³è¾¹çš„å›¾ï¼Œç„¶åå†å¯¹èŠ‚ç‚¹cè¿›è¡Œå³æ—‹è½¬ï¼Œå¦‚ä¸‹ï¼šæ­¤æ—¶å˜æˆäº†ç¬¬ä¸€ç§æƒ…å†µï¼ŒæŒ‰ç¬¬ä¸€ç§æƒ…å†µç»§ç»­å¤„ç†å³å¯ 3.æ’å…¥çš„æ˜¯3-èŠ‚ç‚¹çš„å·¦é“¾æ¥å¦‚ä¸Šå›¾ï¼Œæ’å…¥èŠ‚ç‚¹aï¼Œæ­¤æ—¶å˜æˆäº†ç¬¬äºŒç§æƒ…å†µå·¦æ—‹è½¬åçš„çŠ¶æ€ï¼ŒæŒ‰ä¸Šé¢çš„æ­¥éª¤å¤„ç†å³å¯ã€‚ ç»¼åˆå¯ä»¥å¾—å‡ºæ’å…¥ç®—æ³•çš„æ­¥éª¤ï¼š1.å¦‚æœæ’å…¥çš„æ˜¯2-èŠ‚ç‚¹ï¼Œåªéœ€æŒ‰2-èŠ‚ç‚¹çš„ä¸¤ç§æƒ…å†µæ“ä½œå³å¯2.å¦‚æœæ’å…¥çš„æ˜¯3-èŠ‚ç‚¹ï¼Œåˆ™ä¸´æ—¶åˆ›å»ºäº†ä¸€ä¸ª4-èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶åˆ†è§£å¹¶å°†çº¢é“¾æ¥å‘ä¸Šä¼ é€’ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ª2-èŠ‚ç‚¹æˆ–æ ¹èŠ‚ç‚¹ã€‚è§‚å¯Ÿä¸Šé¢çš„å‡ ç§æ–¹æ³•ï¼Œéƒ½æ˜¯ä¸ºäº†å®Œæˆè¿™ä¸ªç›®æ ‡ã€‚ è€Œåœ¨ä»£ç ä¸­çš„ä½“ç°å°±æ˜¯ï¼š1.å¦‚æœå³å­©å­æ˜¯çº¢è‰²ï¼Œå·¦å­©å­ä¸ºé»‘è‰²ï¼Œåˆ™å·¦æ—‹è½¬2.å¦‚æœå·¦å­©å­å’Œå·¦å­©å­çš„å·¦å­©å­éƒ½æ˜¯çº¢è‰²ï¼Œ åˆ™è¿›è¡Œå³æ—‹è½¬3.å¦‚æœå·¦å­©å­å’Œå³å­©å­éƒ½æ˜¯çº¢è‰²ï¼Œåˆ™è¿›è¡Œé¢œè‰²è½¬æ¢ è§‚å¯Ÿä¸Šè¿°3ç‚¹ï¼Œå…¶å¯ä»¥æ¶µç›–æˆ‘ä»¬ä¸Šé¢çš„ä»»æ„æƒ…å†µã€‚ æ’å…¥ç®—æ³•å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public void put(Key key,Value value){ if (key == null) throw new IllegalArgumentException(\"keyä¸ºç©º\"); if(value==null){ delete(key); return; } root=put(root,key,value); //æ’å…¥åå°†æ ¹èŠ‚ç‚¹é¢œè‰²å˜ä¸ºé»‘è‰² root.color=BLACK; } private Node put(Node node,Key key,Value value) { if (node==null){ //æ’å…¥çš„èŠ‚ç‚¹ï¼Œæ€»æ˜¯è®©å®ƒçš„é¢œè‰²åˆå§‹åŒ–ä¸ºçº¢ return new Node(RED,key,value,1); } int result=key.compareTo(node.key); if (result&lt;0){ node.left=put(node.left,key,value); }else if (result&gt;0){ node.right=put(node.right,key,value); }else { node.value=value; } /* å³é“¾æ¥ä¸ºçº¢è‰² 1.å³å‘2-èŠ‚ç‚¹å³è¾¹æ’å…¥ 2 æˆ–æ˜¯ å‘3-èŠ‚ç‚¹ä¸­é—´æ’å…¥ */ if (isRed(node.right)&amp;&amp;!isRed(node.left)){ //å·¦æ—‹è½¬ node=rotateLeft(node); } //3.æŒ‡å‘æ–°èŠ‚ç‚¹çš„é“¾æ¥ä¸º3-èŠ‚ç‚¹çš„å·¦é“¾æ¥ //4.æˆ–æ˜¯æƒ…å†µ2å·¦æ—‹è½¬åçš„çŠ¶æ€ if (isRed(node.left)&amp;&amp;isRed(node.left.left)){ //å³æ—‹è½¬ node=rotateRight(node); } //5.å·¦å³é“¾æ¥å‡ä¸ºçº¢ï¼Œå³æˆä¸ºä¸€ä¸ª4-èŠ‚ç‚¹(3ã€4 å³æ—‹è½¬åçš„çŠ¶æ€) if (isRed(node.left)&amp;&amp;isRed(node.right)){ //è½¬æ¢é¢œè‰² flipColors(node); } node.size=size(node.left)+size(node.right)+1; return node; } private int size(Node node) { return node==null?0:node.size; } åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦è¢«çº¢é“¾æ¥æŒ‡å‘ï¼š äº”ã€åˆ é™¤æœ€å°å€¼åˆ é™¤æ“ä½œæ¯”è¾ƒéº»çƒ¦ï¼Œä¹Ÿæ˜¯çœ‹çš„å¾ˆä¹…æ‰çœ‹æ‡‚(hhhh)å¦‚æœå¾…åˆ é™¤çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸ª3-èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥åˆ é™¤å°±å¥½äº†ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä¸€ä¸ª2-èŠ‚ç‚¹ï¼Œåˆ é™¤åä¾¿åå°è±¡æ ‘çš„ç»“æ„ï¼Œå› æ­¤åˆ é™¤æœ€å°å€¼çš„æ€è·¯å¦‚ä¸‹ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹å‘ä¸‹å¯»æ‰¾æœ€å°å€¼ï¼Œè·¯å¾„ä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼š1.å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯3-èŠ‚ç‚¹ï¼Œè¿‡2.å½“å‰èŠ‚ç‚¹çš„å·¦å­©å­æ˜¯2-èŠ‚ç‚¹ï¼Œä½†æ˜¯å…„å¼ŸèŠ‚ç‚¹æ˜¯3-èŠ‚ç‚¹ï¼Œæ­¤æ—¶å¯ä»¥å‘å…„å¼ŸèŠ‚ç‚¹å€Ÿä¸€ä¸ªè¿‡æ¥ï¼Œä¿è¯è‡ªå·±ä¸æ˜¯2-èŠ‚ç‚¹ï¼›3.å½“å‰èŠ‚ç‚¹å·¦å­©å­å³å­©å­éƒ½æ˜¯2-èŠ‚ç‚¹ï¼Œåˆ™å‘çˆ¶èŠ‚ç‚¹å€Ÿä¸€ä¸ªï¼Œå¹¶å°†å€Ÿçš„èŠ‚ç‚¹å’Œå·¦å­©å­å³å­©å­åˆå¹¶ã€‚ æŒ‰å¦‚ä¸Šæ“ä½œéå†åˆ°æœ€å°å€¼å¤„ï¼Œæ­¤æ—¶æœ€å°å€¼å°±åœ¨ä¸€ä¸ª3-èŠ‚ç‚¹æˆ–è€…4-èŠ‚ç‚¹ä¸­ï¼Œåˆ é™¤æ¥å³å¯ã€‚ç„¶åå°±å¯ä»¥è‡ªåº•å‘ä¸Šä¿®å¤ä¸´æ—¶çš„4-èŠ‚ç‚¹ï¼ˆåŒå‰é¢çš„æ­¥éª¤ï¼‰ã€‚ 123456789101112131415161718192021public void delMin(){ if (isEmpty()){ throw new NoSuchElementException(\"æ ‘ä¸ºç©º\"); } if(!isRed(root.left) &amp;&amp; !isRed(root.right)){ root.color = RED; // å¦‚æœæ ¹èŠ‚ç‚¹çš„å·¦å³å­èŠ‚ç‚¹æ˜¯2-èŠ‚ç‚¹ï¼Œæˆ‘ä»¬è¦å…ˆæ ¹è®¾ä¸ºçº¢çš„ï¼Œè¿™æ ·æ‰èƒ½è¿›è¡Œåé¢çš„moveRedLeftæ“ä½œï¼Œå› ä¸ºå·¦å­©å­è¦ä»æ ¹èŠ‚ç‚¹å€Ÿä¸€ä¸ª } root = delMin(root); root.color = BLACK; // å€Ÿå®Œä»¥åï¼Œæˆ‘ä»¬å°†æ ¹èŠ‚ç‚¹çš„é¢œè‰²å¤åŸ } private Node delMin(Node node) { if (node.left==null){ return null; } if (!isRed(node.left) &amp;&amp; !isRed(node.left.left)){ // nodeçš„å·¦èŠ‚ç‚¹å¦‚æœæ˜¯2-èŠ‚ç‚¹ï¼Œåˆ™æŒ‰ä¸Šé¢çš„æ–¹æ³•ç¼–ç¨‹3-èŠ‚ç‚¹æˆ–æ˜¯ä¸´æ—¶4-èŠ‚ç‚¹ node=moveRedLeft(node); } node.left=delMin(node.left); return balance(node); // å¹³è¡¡ä¸´æ—¶ç»„æˆçš„4-èŠ‚ç‚¹ } ä»¥ä¸‹æ˜¯2-èŠ‚ç‚¹å˜3-èŠ‚ç‚¹æˆ–4-èŠ‚ç‚¹çš„æ–¹æ³•ï¼š 123456789101112131415161718private Node moveRedLeft(Node node) { /** * å› ä¸ºæˆ‘ä»¬è§„å®šçº¢é“¾æ¥åªèƒ½åœ¨å·¦ï¼Œ * å› æ­¤å½“å‰èŠ‚ç‚¹çš„å·¦å³å­èŠ‚ç‚¹éƒ½æ˜¯2-èŠ‚ç‚¹ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦é€šè¿‡é¢œè‰²è½¬æ¢ï¼Œå°†è¿™ä¸‰ä¸ªèŠ‚ç‚¹åˆå¹¶åœ¨ä¸€èµ· */ flipColors(node); //å¦‚æœå…„å¼ŸèŠ‚ç‚¹ä¸º2-èŠ‚ç‚¹çš„è¯ï¼Œé‚£ä¹ˆåˆ°ä¸Šä¸€æ­¥å°±ç»“æŸäº† if(isRed(node.right.left)){ // è€Œå¦‚æœå…„å¼ŸèŠ‚ç‚¹ä¸æ˜¯2-èŠ‚ç‚¹çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡æ—‹è½¬ä»å…„å¼ŸèŠ‚ç‚¹å€Ÿä¸€ä¸ªè¿‡æ¥ node.right = rotateRight(node.right); node = rotateLeft(node); // å› ä¸ºæ¡ä»¶2è¦æ±‚æˆ‘ä»¬åªå‘å…„å¼ŸèŠ‚ç‚¹å€Ÿä¸€ä¸ªï¼Œ // è€Œä¸€å¼€å§‹ä»çˆ¶èŠ‚ç‚¹é‚£é‡Œå€Ÿäº†ä¸€ä¸ªï¼Œå› æ­¤éœ€è¦è¿˜ä¸€ä¸ªç»™çˆ¶èŠ‚ç‚¹ flipColors(node); } return node; } åˆ é™¤å®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦è‡ªé¡¶å‘ä¸Šåˆ†è§£ä¸´æ—¶çš„4-èŠ‚ç‚¹ï¼šä»¥ä¸‹ä»£ç å’Œä¸Šé¢çš„putæœ€åå‡ ä¸ªifç›¸åŒï¼Œåªæ˜¯åœ¨å¼€å§‹æ·»åŠ äº†ä¸€ä¸ªæ¡ä»¶ï¼Œä½†æ˜¯è¿™ä¸ªæ¡ä»¶å»æ‰åä¹Ÿä¸å½±å“ï¼Œå› ä¸ºå¦‚æœç¬¬ä¸€ä¸ªifå·¦æ—‹è½¬åï¼Œç¬¬äºŒä¸ªifå¿…ç„¶ä¸ä¼šå†èµ°ï¼Œå› ä¸ºå·¦å­©å­å¿…ç„¶æ˜¯çº¢è‰²ï¼›å¦‚æœå»æ‰ç¬¬ä¸€ä¸ªifï¼Œå¦‚æœå·¦é»‘å³çº¢ï¼Œåˆ™è¿›è¡Œå·¦æ—‹è½¬ï¼Œå¦‚æœå·¦çº¢å³çº¢ï¼Œé‚£å°±å±äºæœ€åä¸€ä¸ªæƒ…å†µï¼Œè½¬æ¢é¢œè‰²å³å¯ï¼Œä¸å½±å“ç»“æœ 1234567891011121314151617private Node balance(Node node){ if (isRed(node.right)) { node = rotateLeft(node); } if (isRed(node.right) &amp;&amp; !isRed(node.left)) { node=rotateLeft(node); } if (isRed(node.left) &amp;&amp; isRed(node.left.left)) { node=rotateRight(node); } if (isRed(node.left) &amp;&amp; isRed(node.right)) { flipColors(node); } node.size = size(node.left)+size(node.right)+1; return node; } å…­ã€åˆ é™¤æœ€å¤§å€¼é€»è¾‘åŒåˆ é™¤æœ€å°å€¼ç›¸åŒï¼Œæ–¹å‘ç›¸åã€‚ 12345678910public void delMax(){ if (isEmpty()){ throw new NoSuchElementException(\"æ ‘ä¸ºç©º\"); } if (!isRed(root.left) &amp;&amp; !isRed(root.right)){ root.color=RED; } root=delMax(root); root.color=BLACK; } åœ¨åˆ é™¤ä¸­éœ€è¦æ·»åŠ ä¸€ä¸ªå·¦å­©å­æ˜¯å¦ä¸ºçº¢é“¾æ¥çš„åˆ¤æ–­ï¼Œå› ä¸ºæœ€å¤§å€¼è¦ä¹ˆä¸å­˜åœ¨å­å­©å­ï¼Œè¦ä¹ˆæœ€å¤šå­˜åœ¨ä¸€ä¸ªå·¦é“¾æ¥ï¼ˆä»ä»¥ä¸Šå‡ ä¸ªå¹³è¡¡æ—‹è½¬å¯ä»¥å‘ç°ï¼Œæœ€å¤§å€¼èŠ‚ç‚¹ä¸€å®šæ˜¯è¿™ä¸¤ä¸ªæƒ…å†µï¼‰å¦‚æœæœ‰å·¦çº¢é“¾æ¥ï¼Œåˆ™åº”è¯¥å°†æ­¤èŠ‚ç‚¹å³æ—‹è½¬ï¼Œè®©æœ€å¤§å€¼æ²¡æœ‰ä¸€ä¸ªå­©å­ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥åˆ é™¤ï¼Œå¦åˆ™ä¼šç ´åæ ‘çš„ç»“æ„ï¼Œä¸¢å¤±è¯¥å·¦å­©å­ 1234567891011121314private Node delMax(Node node) { if(isRed(node.left)){ node = rotateRight(node); } if (node.right==null){ return null; } if (!isRed(node.right) &amp;&amp; !isRed(node.right.left)){ node=moveRedRight(node); } node.right=delMax(node.right); return balance(node); } ä¸ƒã€åˆ é™¤ä»»æ„keyåˆ é™¤æ“ä½œåˆ™å°±æ˜¯å°†åˆ é™¤æœ€å°å€¼å’Œåˆ é™¤æœ€å¤§å€¼ç»„åˆåœ¨ä¸€èµ·ï¼Œä½†éœ€è¦è€ƒè™‘keyä¸åœ¨æ ‘åº•çš„æƒ…å†µï¼Œæ­¤æ—¶æŒ‰äºŒå‰æŸ¥æ‰¾æ ‘çš„åˆ é™¤é€»è¾‘åˆ é™¤å³å¯ï¼Œå…·ä½“å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243public void delete(Key key) { if (key == null) throw new IllegalArgumentException(\"argument to delete() is null\"); if (!contains(key)) return; if (!isRed(root.left) &amp;&amp; !isRed(root.right)) root.color = RED; root = delete(root, key); if (!isEmpty()) root.color = BLACK; } private Node delete(Node node, Key key) { if (key.compareTo(node.key) &lt; 0) { //keyåœ¨å·¦å­æ ‘ï¼ŒæŒ‰åˆ é™¤æœ€å°å€¼ä¸€æ ·åˆ é™¤ if (!isRed(node.left) &amp;&amp; !isRed(node.left.left)) node = moveRedLeft(node); node.left = delete(node.left, key); } else {//keyåœ¨å³å­æ ‘ï¼ŒæŒ‰åˆ é™¤æœ€å¤§å€¼ä¸€æ ·åˆ é™¤ if (isRed(node.left)) node = rotateRight(node); //éœ€é¦–å…ˆåˆ¤æ–­å¾…åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å¦åœ¨æ ‘åº•ï¼Œå¦åˆ™ä¸‹ä¸€æ­¥çš„node.right.leftä¼šå‡ºç°ç©ºæŒ‡é’ˆ if (key.compareTo(node.key) == 0 &amp;&amp; (node.right == null)) return null; //é€’å½’åœ¨å³å­æ ‘ä¸­åˆ é™¤ if (!isRed(node.right) &amp;&amp; !isRed(node.right.left)) node = moveRedRight(node); //å¦‚æœå¾…åˆ é™¤çš„èŠ‚ç‚¹ä¸åœ¨æ ‘åº• if (key.compareTo(node.key) == 0) { //åƒäºŒå‰æŸ¥æ‰¾æ ‘ä¸€æ ·åˆ é™¤ï¼Œä»nodeå³å­æ ‘æ‰¾åˆ°æœ€å°çš„èŠ‚ç‚¹æ”¾åœ¨å½“å‰ä½ç½®ï¼Œç„¶åå†å°†è¯¥æœ€å°èŠ‚ç‚¹ä»å³å­æ ‘åˆ é™¤ Node x = min(node.right); node.key = x.key; node.value = x.value; node.right = delMin(node.right); } else { //keyä»ç„¶å¤§äºè¯¥nodeï¼Œç»§ç»­åœ¨å³å­æ ‘é€’å½’ node.right = delete(node.right, key); } } return balance(node); } è·å–ç»™å®šé”®çš„å€¼ï¼ŒåŒå‰é¢äºŒå‰æŸ¥æ‰¾æ ‘ç›¸åŒã€‚ 12345678910111213141516171819public Value get(Key key){ if (key==null){ return nullï¼› } return get(root,key); } private Value get(Node node, Key key) { while (node!=null){ int result=key.compareTo(node.key); if (result&lt;0){ node=node.left; }else if (result&gt;0){ node=node.right; } else { return node.value; } } return null; } å…«ã€æ€»ç»“ï¼š ä¸€é¢—å¤§å°ä¸ºNçš„çº¢é»‘æ ‘çš„é«˜åº¦ä¸ä¼šè¶…è¿‡2lgN çº¢é»‘æ ‘æœ€åæƒ…å†µä¸‹çš„è¿è¡Œæ—¶é—´çš„å¢é•¿æ•°é‡çº§ï¼šæŸ¥æ‰¾ï¼š2lgNåˆ é™¤ï¼š2lgNå¹³å‡æƒ…å†µï¼šæŸ¥æ‰¾ï¼šlgNæ’å…¥ï¼šlgN AVLæ ‘è¿½æ±‚å®Œç¾å¹³è¡¡ï¼Œè¯»å–çš„æ€§èƒ½ç•¥é«˜ï¼›ä½†ç»´æŠ¤è¾ƒæ…¢ï¼Œç©ºé—´å¼€é”€è¾ƒå¤§ã€‚çº¢é»‘æ ‘çš„è¯»å–æ€§èƒ½ç•¥ä½ï¼ˆä½†æœ€å¤šä¹Ÿå°±å¤šæ¯”è¾ƒä¸€æ¬¡å·¦å³ï¼‰ï¼Œç©ºé—´å¤æ‚åº¦åŒAVLå·®ä¸å¤šï¼Œä½†æ•°æ®é‡å¤§æ—¶ï¼Œçº¢é»‘æ ‘çš„ç»¼åˆæ€§èƒ½æ›´é«˜ å› æ­¤åœ¨æŸ¥æ‰¾å¤§äºæ’å…¥æˆ–åˆ é™¤çš„åœºæ™¯æ—¶ï¼Œä½¿ç”¨AVLæ ‘ï¼Œå¦‚æœæ¬¡æ•°éƒ½å·®ä¸å¤šï¼Œå°±ç”¨çº¢é»‘æ ‘ã€‚**","link":"/posts/20200310-RedBlackTree.html"},{"title":"ã€Šç®—æ³•4ã€‹æœ€å°ç”Ÿæˆæ ‘è®²è§£ç¬”è®°ï¼ˆPrimçš„å»¶æ—¶å’Œå³ä½¿å®ç°ï¼ŒKruskalç®—æ³•ï¼‰","text":"ç”Ÿæˆæ ‘ï¼š å›¾çš„ç”Ÿæˆæ ‘å°±æ˜¯ä¸€é¢—å«æœ‰å…¶æ‰€æœ‰é¡¶ç‚¹çš„æ— ç¯è¿é€šå­å›¾ã€‚æœ€å°ç”Ÿæˆæ ‘ï¼š å³ç»™å®šä¸€ä¸ªåŠ æƒæ— å‘å›¾ï¼Œæ‰¾åˆ°å®ƒçš„ä¸€é¢—æœ€å°ç”Ÿæˆæ ‘ï¼ˆæƒå€¼æœ€å°ï¼‰ã€‚ å› æ­¤æœ€å°ç”Ÿæˆæ ‘çš„ç ”ç©¶èŒƒå›´æ˜¯ï¼šå¸¦æƒæ— å‘å›¾ï¼Œä¸”æ˜¯è¿é€šå›¾ã€‚ å¦‚ä¸‹ç»™å‡ºåŠ æƒæ— å‘å›¾çš„æ•°æ®ç»“æ„ï¼šå¸¦æƒé‡çš„è¾¹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * å¸¦æƒé‡çš„è¾¹ * @author MaoLin Wang * @date 2020/2/239:49 */public class Edge implements Comparable&lt;Edge&gt;{ private final int v; private final int w; private final double weight; public Edge(int v, int w, double weight) { if (v &lt; 0) throw new IllegalArgumentException(\"vertex index must be a nonnegative integer\"); if (w &lt; 0) throw new IllegalArgumentException(\"vertex index must be a nonnegative integer\"); if (Double.isNaN(weight)) throw new IllegalArgumentException(\"æƒé‡å¿…é¡»ä¸ºæ•°å€¼\"); this.v = v; this.w = w; this.weight = weight; } /** * è¿”å›æƒé‡ * @return */ public double weight() { return weight; } /** * è¿”å›è¾¹ä¸¤ç«¯çš„é¡¶ç‚¹ä¹‹ä¸€ * @return */ public int either() { return v; } /** * è¿”å›å¦ä¸€ä¸ªé¡¶ç‚¹ * @param vertex * @return */ public int other(int vertex) { if (vertex == v) return w; else if (vertex == w) return v; else throw new IllegalArgumentException(\"Illegal endpoint\"); } @Override public int compareTo(Edge edge) { return Double.compare(this.weight, edge.weight); } public String toString() { return String.format(\"%d-%d %.5f\", v, w, weight); }} åŠ æƒæ— å‘å›¾ï¼šåŒä¹‹å‰å°†çš„å‡ ä¸ªå›¾åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯è¿™æ˜¯æ·»åŠ è¾¹æ˜¯é€šè¿‡Edgeå¯¹è±¡è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿”å›æ‰€æœ‰çš„è¾¹æ—¶ï¼Œè¦è€ƒè™‘è‡ªç¯çš„æƒ…å†µã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778/** * åŠ æƒæ— å‘å›¾ * @author MaoLin Wang * @date 2020/2/239:54 */public class EdgeWeightedGraph { private static final String NEWLINE = System.getProperty(\"line.separator\"); private final int V; private int E; private Bag&lt;Edge&gt;[] adj; public EdgeWeightedGraph(int V) { if (V &lt; 0) throw new IllegalArgumentException(\"Number of vertices must be nonnegative\"); this.V = V; this.E = 0; adj = (Bag&lt;Edge&gt;[]) new Bag[V]; for (int v = 0; v &lt; V; v++) { adj[v] = new Bag&lt;Edge&gt;(); } } //æ·»åŠ ä¸€æ¡è¾¹ private void addEdge(Edge e) { int v = e.either(); int w = e.other(v); validateVertex(v); validateVertex(w); adj[v].add(e); adj[w].add(e); E++; } //è¿”å›é¡¶ç‚¹vçš„é‚»è¾¹ public Iterable&lt;Edge&gt; adj(int v) { validateVertex(v); return adj[v]; } //é¡¶ç‚¹vçš„åº¦ public int degree(int v) { validateVertex(v); return adj[v].size(); } //è¿”å›æ‰€æœ‰è¾¹ public Iterable&lt;Edge&gt; edges() { Bag&lt;Edge&gt; list = new Bag&lt;Edge&gt;(); for (int v = 0; v &lt; V; v++) { int selfLoops = 0; for (Edge e : adj(v)) { if (e.other(v) &gt; v) { list.add(e); } else if (e.other(v) == v) { //æ˜¯è‡ªç¯ å¦‚ 1-1 if (selfLoops % 2 == 0) list.add(e);//å¯¹äºè‡ªç¯ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªå‰¯æœ¬å³å¯ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨addEdgeæ—¶ï¼Œæ·»åŠ äº†ä¸¤æ¡ä¸€æ ·çš„è¾¹ selfLoops++; } } } return list; } private void validateVertex(int v) { if (v &lt; 0 || v &gt;= V) throw new IllegalArgumentException(\"vertex \" + v + \" is not between 0 and \" + (V-1)); } public int V() { return V; } public int E() { return E; } @Override public String toString() { return \"é¡¶ç‚¹ï¼š\" + V + \", è¾¹=\" + E + \"\\n\" + Arrays.toString(adj); }} ä¸€ã€Primç®—æ³•Primç®—æ³•çš„æ¯ä¸€æ­¥éƒ½ä¼šä¸ºä¸€é¢—æ­£åœ¨ç”Ÿé•¿çš„æ ‘æ·»åŠ ä¸€æ¡è¾¹ã€‚æ ‘æ˜¯ä»ä¸€ä¸ªé¡¶ç‚¹å¼€å§‹çš„ï¼Œç„¶åæ¯æ¬¡æ·»åŠ ä¸€æ¡è¾¹ï¼Œè¯¥è¾¹æ˜¯ä¸‹ä¸€æ¡ è¿æ¥æ ‘ä¸­çš„é¡¶ç‚¹å’Œä¸åœ¨æ ‘ä¸­çš„é¡¶ç‚¹ä¸”æƒé‡æœ€å°çš„è¾¹ã€‚ è¯¥ç®—æ³•èƒ½å¤Ÿå¾—åˆ°ä»»æ„åŠ æƒè¿é€šå›¾çš„æœ€å°ç”Ÿæˆæ ‘ã€‚ åœ¨è¿™ä¹‹å‰è¦è®²ä¸€ä¸‹åˆ‡åˆ†å®šç†ï¼š å›¾çš„ä¸€ç§åˆ‡åˆ†å°±æ˜¯å°†å›¾çš„æ‰€æœ‰é¡¶ç‚¹åˆ†ä¸ºä¸¤ä¸ªéç©ºçš„ä¸”ä¸é‡å çš„é›†åˆã€‚æ¨ªåˆ‡è¾¹æ˜¯ä¸€æ¡è¿æ¥ä¸¤ä¸ªå±äºä¸åŒé›†åˆçš„é¡¶ç‚¹çš„è¾¹ï¼ˆä¸€è¾¹è¿æ¥è¿™ä¸ªé›†åˆï¼Œä¸€è¾¹æ¥è¿å¦ä¸€ä¸ªé›†åˆï¼‰ã€‚åˆ‡åˆ†å®šç†å°±æ˜¯ç»™å®šä»»æ„åˆ‡åˆ†ï¼Œæ¨ªåˆ‡è¾¹ä¸­æƒå€¼æœ€å°çš„è¾¹å¿…ç„¶å±äºæœ€å°ç”Ÿæˆæ ‘ï¼› Primçš„å»¶æ—¶å®ç°1.1æ•°æ®ç»“æ„æˆ‘ä»¬éœ€è¦å¦‚ä¸‹çš„æ•°æ®ç»“æ„æ¥å®ç°Primç®—æ³•ï¼Œå…¶ä¸­BinaryHeapæ˜¯å‰é¢è®²è¿‡çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå°é¡¶å †å®ç°ï¼‰ï¼Œéœ€è¦çš„å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå †ï¼‰ä»¥åŠå †æ’åºâ€”â€”-javaå®ç° 1234567891011121314/** * æœ€å°ç”Ÿæˆæ ‘çš„é¡¶ç‚¹ */ private boolean[] marked; /** * æœ€å°ç”Ÿæˆæ ‘çš„è¾¹ */ private Queue&lt;Edge&gt; mst; /** * æ¨ªåˆ‡è¾¹ï¼ˆåŒ…æ‹¬å¤±æ•ˆçš„è¾¹ï¼‰ */ private BinaryHeap&lt;Edge&gt; pq; 1.2 å®ç°æ€è·¯1.é€‰æ‹©ä¸€ä¸ªé¡¶ç‚¹æ ‡è®°å®ƒï¼Œç„¶åå°†è¿æ¥è¿™ä¸ªé¡¶ç‚¹å’Œå…¶ä»–æ‰€æœ‰ä¸å†æ ‘ä¸­çš„é¡¶ç‚¹çš„è¾¹åŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—ä¸­ï¼ˆä¼˜å…ˆé˜Ÿåˆ—æŒ‰è¾¹çš„æƒé‡ä»å°åˆ°å¤§æ’åˆ—ï¼‰ï¼›2.ä»ä¼˜å…ˆé˜Ÿåˆ—ä¸­å–å‡ºæƒé‡æœ€å°çš„è¾¹ï¼Œå¦‚æœè¾¹çš„ä¸¤ä¸ªé¡¶ç‚¹éƒ½è¢«è®¿é—®è¿‡äº†ï¼Œåˆ™ä»£è¡¨è¯¥è¾¹å¤±æ•ˆäº†ï¼Œç»§ç»­å–ä¸‹ä¸€ä¸ªæœ€å°çš„è¾¹ï¼›3.å¦‚æœæƒé‡æœ€å°çš„è¾¹ï¼ˆå³æ¨ªåˆ‡è¾¹ï¼‰æ²¡æœ‰å¤±æ•ˆï¼Œåˆ™å°†å…¶åŠ å…¥æœ€å°ç”Ÿæˆæ ‘é˜Ÿåˆ—ï¼Œå°†å¯¹è¯¥è¾¹æœªè¢«è®¿é—®çš„ç‚¹å†æ¬¡è¿›è¡Œ æ­¥éª¤1çš„æ“ä½œï¼Œç›´åˆ°ä¼˜å…ˆé˜Ÿåˆ—ä¸ºç©ºï¼Œæ­¤æ—¶æœ€å°ç”Ÿæˆæ ‘çš„è¾¹éƒ½åœ¨msté˜Ÿåˆ—ä¸­äº†ã€‚å¦‚ä¸‹å›¾ï¼šé€‰å–0ä½œä¸ºå¼€å§‹çš„é¡¶ç‚¹ï¼Œç„¶åå°†ä¸0ç›¸è¿çš„ä¸”å…¶ä»–ä¸åœ¨æ ‘ä¸­çš„è¾¹åŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆåè¾¹ç›´æ¥å±•ç¤ºä¼˜å…ˆé˜Ÿåˆ—çŠ¶æ€ï¼‰ï¼š*è¡¨ç¤ºæ–°åŠ å…¥çš„è¾¹ï¼Œâ–³è¡¨ç¤ºå¤±æ•ˆçš„è¾¹ï¼Œå›¾ä¸­çº¢è‰²çš„è¾¹ä¸ºåŠ å…¥æœ€å°ç”Ÿæˆæ ‘ä¸­çš„è¾¹ï¼Œè“è‰²çš„è¾¹æœªä¼˜å…ˆé˜Ÿåˆ—ä¸­çš„è¾¹ï¼›æ©™è‰²çš„èŠ‚ç‚¹è¡¨ç¤ºæœ€å°ç”Ÿæˆæ ‘ï¼Œç»¿è‰²çš„è¡¨ç¤ºæœªåŠ å…¥ 12345 è¾¹ æƒé‡* 0-7 0.16* 0-2 0.26* 0-4 0.38* 6-0 0.58 å°†æƒé‡æœ€å°çš„è¾¹0-7ä»ä¼˜å…ˆé˜Ÿåˆ—å–å‡ºï¼Œå¹¶åŠ å…¥æœ€å°ç”Ÿæˆæ ‘ï¼Œç»§ç»­å¯¹æœªè¢«è®¿é—®çš„é¡¶ç‚¹7è¿›è¡Œä¸Šè¿°æ“ä½œï¼š 1234567* 1-7 0.19 0-2 0.26* 5-7 0.28* 2-7 0.34* 4-7 0.37 0-4 0.38 6-0 0.58 å°†è¾¹ 1-7å–å‡ºåŠ å…¥ç”Ÿæˆæ ‘ï¼š 123456789 0-2 0.26 5-7 0.28* 1-3 0.29* 1-5 0.32 2-7 0.34* 1-2 0.36 4-7 0.37 0-4 0.38 6-0 0.58 å°†è¾¹0-2å–å‡ºåŠ å…¥ç”Ÿæˆæ ‘ï¼š 12345678910* 2-3 0.17 5-7 0.28 1-3 0.29 1-5 0.32 â–³ 2-7 0.34â–³ 1-2 0.36 4-7 0.37 0-4 0.38* 6-2 0.40 6-0 0.58 å°†2-3å–å‡ºåŠ å…¥ç”Ÿæˆæ ‘ï¼š 1234567891011 5-7 0.28â–³ 1-3 0.29 1-5 0.32 â–³ 2-7 0.34â–³ 1-2 0.36 4-7 0.37 0-4 0.38 6-2 0.40* 3-6 0.52 6-0 0.58 å–å‡º5-7åŠ å…¥ç”Ÿæˆæ ‘ï¼š 12345678910â–³ 1-3 0.29â–³ 1-5 0.32 â–³ 2-7 0.34* 5-4 0.35â–³ 1-2 0.36 4-7 0.37 0-4 0.38 6-2 0.40 3-6 0.52 6-0 0.58 æ­¤æ—¶å‰é¢ä¸‰ä¸ªè¾¹å·²ç»å¤±æ•ˆäº†ï¼Œå…¨éƒ¨ç§»é™¤ï¼Œå°†è¾¹5-4åŠ å…¥ç”Ÿæˆæ ‘ï¼š 1234567â–³ 1-2 0.36â–³ 4-7 0.37â–³ 0-4 0.38 6-2 0.40 3-6 0.52 6-0 0.58 6-4 0.93 å°†æœªå¤±æ•ˆçš„6-2åŠ å…¥ç”Ÿæˆæ ‘ï¼šæ­¤æ—¶ä¼˜å…ˆé˜Ÿåˆ—å‰©ä½™è¾¹å…¨éƒ¨å¤±æ•ˆï¼Œmsté˜Ÿåˆ—å·²ç»å¾—åˆ°äº†è¯¥å›¾ä»0å¼€å§‹çš„æœ€å°ç”Ÿæˆæ ‘ã€‚ 1.3 Primçš„å»¶æ—¶å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public class LazyPrimMST { /** * æœ€å°ç”Ÿæˆæ ‘çš„é¡¶ç‚¹ */ private boolean[] marked; /** * æœ€å°ç”Ÿæˆæ ‘çš„è¾¹ */ private Queue&lt;Edge&gt; mst; /** * æ¨ªåˆ‡è¾¹ï¼ˆåŒ…æ‹¬å¤±æ•ˆçš„è¾¹ï¼‰ */ private BinaryHeap&lt;Edge&gt; pq; public LazyPrimMST(EdgeWeightedGraph G){ pq=new BinaryHeap&lt;&gt;(); marked=new boolean[G.V()]; mst=new Queue&lt;&gt;(); //å‡è®¾Gæ˜¯è¿é€šçš„ visit(G,0); while (!pq.isEmpty()){ //ä»pqä¸­å¾—åˆ°æƒé‡æœ€å°çš„è¾¹ Edge edge = pq.deleteMin(); int v=edge.either(),w=edge.other(v); if (marked[v]&amp;&amp;marked[w]){//å·²å¤±æ•ˆï¼Œå¿½ç•¥ continue; } //å½“å‰è¾¹åŠ å…¥æœ€å°ç”Ÿæˆæ ‘ mst.enqueue(edge); //è®¿é—®å½“å‰æ¨ªåˆ‡è¾¹æœªè¢«è®¿é—®çš„é‚£ä¸ªé¡¶ç‚¹væˆ–w if (!marked[v]){ visit(G,v); } if (!marked[w]){ visit(G,w); } } } /** * å°†æ‰€æœ‰ä¸vè¿æ¥ä¸”æœªè¢«æ ‡è®°çš„é¡¶ç‚¹çš„è¾¹åŠ å…¥æ¨ªåˆ‡è¾¹ * @param G * @param v */ private void visit(EdgeWeightedGraph G, int v) { marked[v]=true; for (Edge edge:G.adj(v)){ if (!marked[edge.other(v)]){ pq.insert(edge); } } } /** * è¿”å›æœ€å°ç”Ÿæˆæ ‘çš„æ‰€æœ‰è¾¹ * @return */ public Iterable&lt;Edge&gt; edges(){ return mst; } /** * æœ€å°ç”Ÿæˆæ ‘çš„æƒé‡å’Œ * @return */ public double weight(){ double weight=0; for (Edge edge:mst){ weight+=edge.weight(); } return weight; }} Primç®—æ³•çš„å»¶æ—¶å®ç°ï¼ˆVä¸ªé¡¶ç‚¹Eæ¡è¾¹ï¼‰æ‰€éœ€ç©ºé—´ä¸Eæˆæ­£æ¯”ï¼Œæ‰€éœ€æ—¶é—´ä¸ElogEæˆæ­£æ¯”ï¼ˆæœ€åæƒ…å†µï¼‰ 1.4 Primç®—æ³•çš„å³æ—¶å®ç°å¯¹äºä¸Šé¢çš„å»¶æ—¶å®ç°ï¼Œæˆ‘ä»¬å‘ç°ä¼˜å…ˆé˜Ÿåˆ—ä¸­å­˜åœ¨å¤§é‡å¤±æ•ˆçš„è¾¹ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥å°†å¤±æ•ˆçš„è¾¹ä»ä¸­åˆ é™¤å°±å¥½äº†ã€‚å¯¹äºæ¯ä¸ªéæ ‘é¡¶ç‚¹wï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¿å­˜æ‰€æœ‰ä»wåˆ°æ ‘é¡¶ç‚¹çš„è¾¹ï¼Œè€Œåªè¦ä¿å­˜æƒé‡æœ€å°çš„é‚£ä¸ªè¾¹å°±å¯ä»¥äº†ï¼Œæ·»åŠ é¡¶ç‚¹våˆ°æ ‘ä¸­åï¼Œå°±éœ€è¦æ›´æ–°æƒé‡æœ€å°çš„è¾¹ï¼Œå› ä¸ºå¯èƒ½ v-w çš„æƒé‡æ¯”ä¹‹å‰wåˆ°å¦å¤–ä¸€ä¸ªæ ‘é¡¶ç‚¹çš„è¾¹æ›´å°ã€‚è€Œå¯¹äºæœ€å°æƒé‡ä¹‹å¤–çš„è¾¹ï¼Œå…¶æ—©æ™šä¼šå¤±æ•ˆã€‚ åœ¨å³æ—¶å®ç°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨edgeTo[v]ä¿å­˜vå’Œæ ‘æœ€è¿‘çš„è¾¹ï¼Œç”¨distTo[v]ä¿å­˜è¯¥è¾¹çš„æƒé‡ï¼ŒdistTo[v]åº”å§‹ç»ˆä¿æŒvåˆ°æ ‘é¡¶ç‚¹çš„æœ€å°æƒé‡å€¼ã€‚å¦å¤–ä½¿ç”¨ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—å°†é¡¶ç‚¹vä½œä¸ºç´¢å¼•ï¼Œé¡¶ç‚¹våˆ°æ ‘é¡¶ç‚¹æœ€å°çš„è¾¹æƒé‡distTo[v]ä½œä¸ºç´¢å¼•å…³è”çš„å€¼ï¼ˆç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—å³æŒ‰è¯¥æƒé‡è¿›è¡Œæ’åºï¼‰ï¼ˆç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—å‚è€ƒ ç®—æ³•4ã€‹ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ç¬”è®°â€”â€“javaå®ç°ä¸€æ–‡ï¼‰ å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839public class PrimMST { /** * edgeTo[v] é¡¶ç‚¹vè·ç¦»æ ‘æœ€è¿‘çš„è¾¹ */ private Edge[] edgeTo; /** * distTo[v] ä¿å­˜é¡¶ç‚¹våˆ°æ ‘é¡¶ç‚¹æœ€å°è¾¹çš„æƒé‡ */ private double[] distTo; private boolean[] marked; private double weight=0.0; /** * æœ‰æ•ˆçš„æ¨ªåˆ‡è¾¹ï¼šç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ï¼Œé¡¶ç‚¹vä½œä¸ºç´¢å¼•ï¼ŒdisTo[v]ä½œä¸ºç´¢å¼•å…³è”çš„å€¼ */ private IndexMinPQ&lt;Double&gt;pq; public PrimMST(EdgeWeightedGraph G){ edgeTo=new Edge[G.V()]; distTo=new double[G.V()]; marked=new boolean[G.V()]; for (int v = 0; v &lt; G.V(); v++) { //åˆå§‹åŒ–ä¸ºæ— ç©·å¤§ distTo[v]=Double.POSITIVE_INFINITY; } pq=new IndexMinPQ&lt;&gt;(G.V()); //å¦‚æœæ˜¯è¿é€šçš„ï¼Œåˆ™ç›´æ¥èµ°prim()ï¼Œè¿™ä¸ªå¾ªç¯ä¸éœ€è¦åŠ  for (int v = 0; v &lt; G.V(); v++) { if (!marked[v]){ prim(G,v); } } }} ä¸¾ä¾‹è¯´æ˜ï¼ˆä»ä½¿ç”¨ä¸Šé¢çš„å›¾ï¼‰ï¼šå¦‚ä¸‹å›¾ï¼Œä»¥0ä¸ºèµ·ç‚¹ï¼Œæ­¤æ—¶æˆ‘ä»¬å°†è¿æ¥0å’Œéæ ‘èŠ‚ç‚¹çš„è¾¹åŠ å…¥ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ï¼ŒedgeToå’ŒdistToçš„çŠ¶æ€ä¸ºï¼š 12345 edgeTo[] distTo[]2 0-2 0.264 0-4 0.386 0-6 0.587 0-7 0.16 ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ä¸ºï¼š 12345index Key 7 0.16 2 0.26 4 0.38 6 0.58 æ¥ç€ä»ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—å–å‡ºç¬¬ä¸€ä¸ªç´¢å¼•7ï¼Œç„¶åæ›´æ–°edgeToå’ŒdistToï¼š 1234567 edgeTo[] distTo[]1 7-1 0.19 2 0-2 0.26 å› ä¸ºè¾¹7-2çš„æƒé‡å¤§äºè¾¹0-2çš„0.26 å› æ­¤ä¸éœ€è¦æ›´æ–°ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ä¸­ç´¢å¼•ä¸º2çš„å…³è”çš„å¯¹è±¡4 7-4 0.37 å› ä¸ºè¾¹7-4çš„æƒé‡å°äºè¾¹0-4çš„0.38 å› æ­¤éœ€è¦æ›´æ–°ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ä¸­ç´¢å¼•ä¸º4çš„å…³è”çš„å¯¹è±¡5 7-5 0.286 0-6 0.587 0-7 0.16 é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼š 123456index Key 1 0.19 2 0.26 //æ–°çš„æƒé‡()æ¯”0.26å¤§ï¼Œæ‰€ä»¥ä¸åšæ›´æ–° 4 0.37 //ç”±åŸæ¥çš„0.38æ›´æ–°ä¸ºè¾ƒå°çš„0.37 5 0.28 6 0.58 åˆ°æ­¤å°±å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ä¸­ä¿å­˜çš„æ°¸è¿œæ˜¯é¡¶ç‚¹vè·ç¦»æ ‘æœ€è¿‘çš„è¾¹ï¼ˆæ¯åŠ å…¥ä¸€ä¸ªé¡¶ç‚¹åˆ°æ ‘ä¸­å°±åšæ›´æ–°ï¼‰ï¼Œè€Œä¸åƒä¸Šé¢å»¶æ—¶ç‰ˆæœ¬ä¸€æ ·ä¿å­˜äº†æ‰€æœ‰çš„è¾¹ï¼Œè¿™æ ·ç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºï¼Œä¾¿å¯ä»¥å¾—åˆ°ä¸€é¢—æœ€å°ç”Ÿæˆæ ‘ã€‚ å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192public class PrimMST { /** * edgeTo[v] é¡¶ç‚¹vè·ç¦»æ ‘æœ€è¿‘çš„è¾¹ */ private Edge[] edgeTo; /** * distTo[v] ä¿å­˜é¡¶ç‚¹våˆ°æ ‘é¡¶ç‚¹æœ€å°è¾¹çš„æƒé‡ */ private double[] distTo; private boolean[] marked; /** * æœ€å°ç”Ÿæˆæ ‘çš„æƒé‡ */ private double weight=0.0; /** * æœ‰æ•ˆçš„æ¨ªåˆ‡è¾¹ï¼šç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—ï¼Œé¡¶ç‚¹vä½œä¸ºç´¢å¼•ï¼ŒdisTo[v]ä½œä¸ºç´¢å¼•å…³è”çš„å€¼ */ private IndexMinPQ&lt;Double&gt;pq; public PrimMST(EdgeWeightedGraph G){ edgeTo=new Edge[G.V()]; distTo=new double[G.V()]; marked=new boolean[G.V()]; for (int v = 0; v &lt; G.V(); v++) { //åˆå§‹åŒ–ä¸ºæ— ç©·å¤§ distTo[v]=Double.POSITIVE_INFINITY; } pq=new IndexMinPQ&lt;&gt;(G.V()); //å¦‚æœæ˜¯è¿é€šçš„ï¼Œåˆ™ç›´æ¥èµ°prim()ï¼Œè¿™ä¸ªå¾ªç¯ä¸éœ€è¦åŠ  for (int v = 0; v &lt; G.V(); v++) { if (!marked[v]){ prim(G,v); } } check(G); } private void prim(EdgeWeightedGraph G,int v) { distTo[v]=0.0; //å°†å½“å‰é¡¶ç‚¹ä½œä¸ºç´¢å¼•ï¼Œå½“å‰é¡¶ç‚¹è·ç¦»æ ‘æƒé‡æœ€å°çš„è¾¹çš„æƒé‡ä½œä¸ºå…³è”çš„keyåŠ å…¥ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ— pq.insert(v,distTo[v]); while (!pq.isEmpty()){ //å–å‡ºæƒé‡æœ€å°çš„ç´¢å¼•ï¼ˆé¡¶ç‚¹ï¼‰ int w = pq.delMin(); visit(G,w); } } private void visit(EdgeWeightedGraph G, int v) { marked[v]=true; weight+=distTo[v]; for (Edge e:G.adj(v)){ int w=e.other(v); if (marked[w]){ continue; } if (e.weight()&lt;distTo[w]){//åªæœ‰å½“æ–°çš„è¾¹çš„æƒé‡å°äºä¹‹å‰çš„distTo[w]å€¼çš„æ—¶å€™ï¼Œæ‰æ›´æ–°å€¼ edgeTo[w]=e; distTo[w]=e.weight(); if (pq.contains(w)){ //ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—æœ‰è¿™ä¸ªç´¢å¼•ï¼Œæ›´æ–°å¯¹åº”çš„æƒé‡å€¼ pq.changeKey(w,distTo[w]); }else {//å¦åˆ™æ’å…¥æ–°çš„ pq.insert(w,distTo[w]); } } } } public Iterable&lt;Edge&gt; edges(){ Queue&lt;Edge&gt; mst = new Queue&lt;Edge&gt;(); for (int v = 0; v &lt; edgeTo.length; v++) { Edge e = edgeTo[v]; if (e != null) { mst.enqueue(e); } } return mst; } public double weight(){ return weight; } } äºŒã€Kruskalæ³•Kruskalç®—æ³•çš„æ€æƒ³æ˜¯ï¼šæŒ‰ç…§è¾¹çš„æƒé‡ä»å°åˆ°å¤§çš„é¡ºåºå¤„ç†å®ƒä»¬ï¼Œæ¯æ¬¡å°†æƒé‡æœ€å°çš„è¾¹åŠ å…¥æ ‘ä¸­ï¼Œæ–°åŠ å…¥çš„è¾¹ä¸ä¼šä¸å·²ç»åŠ å…¥çš„è¾¹æ„æˆç¯ï¼Œç›´åˆ°æ ‘ä¸­æœ‰V-1æ¡è¾¹ä¸ºæ­¢ã€‚æ˜¯ä»è¾¹å‡ºå‘ã€‚ è¯¥ç®—æ³•çš„å®ç°æœ‰ä¸¤ä¸ªå…³é”®ï¼š1. éœ€è¦å°†æ‰€æœ‰è¾¹æŒ‰æƒé‡å¤§å°æ’åºï¼Œè¿™æ ·æ¯æ¬¡æ‰èƒ½å–å‡ºæƒé‡æœ€å°çš„ä¸€æ¡è¾¹ï¼Œå®ç°æ­¤éœ€è¦ç”¨åˆ°å‰é¢çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå°é¡¶å †ï¼‰2. ä¸ºäº†é¿å…å½¢æˆç¯ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©å‰é¢è®²è¿‡çš„å¹¶æŸ¥é›†åˆ¤æ–­æ ‘åŠ å…¥æ–°å–å‡ºçš„è¾¹åæ˜¯å¦æœ‰ç¯ï¼Œå³å¦‚æœè¯¥è¾¹çš„ä¸¤ä¸ªé¡¶ç‚¹å±äºåŒä¸€ä¸ªå±æ€§é›†ï¼Œåˆ™ä¼šå½¢æˆç¯ï¼›å¦åˆ™å°†è¯¥è¾¹åŠ å…¥ç”Ÿæˆæ ‘ï¼Œå¹¶å°†è¾¹çš„ä¸¤ä¸ªé¡¶ç‚¹è¿æ¥ ä¾ç„¶ä»¥ä¸Šé¢çš„å›¾ä¸ºä¾‹ï¼š ä¸€å¼€å§‹æ¯ä¸ªé¡¶ç‚¹éƒ½å±äºå•ç‹¬çš„åˆ†é‡ 1.å…ˆé€‰æ‹©æƒé‡æœ€å°çš„è¾¹ 0-7ï¼Œå°†0å’Œ7ä¸¤ä¸ªé¡¶ç‚¹ä½¿ç”¨union(0,7)è¿æ¥ï¼Œæ­¤æ—¶0å’Œ7åœ¨ä¸€ä¸ªåˆ†é‡ä¸­2.é€‰å–ä¸‹ä¸€ä¸ªæœ€å°è¾¹2-3ï¼Œå°†2-3åŠ å…¥ç”Ÿæˆæ ‘ï¼Œå¹¶ç”¨unionè¿æ¥ï¼Œæ­¤æ—¶2å’Œ3åœ¨ä¸€ä¸ªåˆ†é‡ä¸­3.é€‰å–1-7åŠ å…¥ç”Ÿæˆæ ‘ï¼Œè¿æ¥1å’Œ7ï¼Œæ­¤æ—¶1åŠ å…¥7æ‰€åœ¨çš„åˆ†é‡3.é€‰å–0-2åŠ å…¥ç”Ÿæˆæ ‘ï¼Œè¿æ¥0å’Œ2ï¼Œæ­¤æ—¶2å’Œ3åŠ å…¥0æ‰€åœ¨åˆ†é‡4.è¿™æ—¶è¾¹ 1-3 ï¼Œ 1-2 å’Œ 7-2 å¤±æ•ˆï¼Œå› ä¸ºè¿™ä»»æ„ä¸€æ¡è¾¹è¿æ¥éƒ½æ„æˆäº†ç¯ï¼ˆä»»æ„ä¸€æ¡è¾¹ä¸¤ä¸ªé¡¶ç‚¹éƒ½åœ¨åŒä¸€ä¸ªåˆ†é‡ä¸­ï¼‰ï¼Œåªèƒ½é€‰å–ä¸‹ä¸€ä¸ªæƒé‡æœ€å°è¾¹5-7ç„¶åæ˜¯5-4å’Œ2-6ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæœ€å°ç”Ÿæˆæ ‘ï¼š å®ç°å¦‚ä¸‹ï¼šå…³äºå¹¶æŸ¥é›†çš„å®ç°å¯ä»¥çœ‹å‰é¢çš„æ–‡ç« ï¼šã€Šç®—æ³•ç¬¬å››ç‰ˆã€‹â€”union-findå¹¶æŸ¥é›†ç¬”è®° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class KruskalMST { /** * æœ€å°ç”Ÿæˆæ ‘æƒé‡ */ private double weight=0.0; /** * æœ€å°ç”Ÿæˆæ ‘æ‰€æœ‰è¾¹ */ private Queue&lt;Edge&gt; mst; public KruskalMST(EdgeWeightedGraph G){ mst=new Queue&lt;&gt;(); //åˆ›å»ºä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ— BinaryHeap&lt;Edge&gt; pq= new BinaryHeap&lt;&gt;(); for (Edge e: G.edges()){ //å°†æ‰€æœ‰è¾¹åŠ å…¥é˜Ÿåˆ—ä¸­ï¼ŒæŒ‰æƒé‡å¤§å°ä»å°åˆ°å¤§æ’åº pq.insert(e); } //åˆ›å»ºä¸€ä¸ªå¹¶æŸ¥é›† ComPathWeightedQuickUnionFind uf=new ComPathWeightedQuickUnionFind(G.V()); //é˜Ÿåˆ—éç©ºä¸”è¾¹çš„ä¸ªæ•°å°äºé¡¶ç‚¹æ•°-1æ—¶å¾ªç¯ while (!pq.isEmpty() &amp;&amp; mst.size()&lt;G.V()-1){ //å¾—åˆ°æƒé‡æœ€å°çš„è¾¹ Edge edge = pq.deleteMin(); int v=edge.either(),w=edge.other(v); if (uf.connected(v,w)){ //å¿½ç•¥å¤±æ•ˆçš„è¾¹ continue; } uf.union(v,w);//åˆå¹¶åˆ†é‡ mst.enqueue(edge);//åŠ å…¥ç”Ÿæˆæ ‘ weight+=edge.weight(); } } public Iterable&lt;Edge&gt; edges(){ return mst; } public double weight(){ return weight; }}","link":"/posts/20200310-prim-kruskal.html"},{"title":"ã€Šç®—æ³•4ã€‹æ— å‘å›¾å’Œæœ‰å‘å›¾çš„æœ‰å…³é—®é¢˜è¯¦è§£ï¼ˆDFS,BFS,ç¯,æ‹“æ‰‘æ’åº,è¿é€šæ€§å’Œå¼ºè¿é€šæ€§ï¼‰","text":"æœ¬æ–‡ä»…ä½œä¸ºã€Šç®—æ³•ã€‹ç¬¬å››ç‰ˆå›¾çš„ç›¸å…³çŸ¥è¯†çš„ä¸ªäººç¬”è®°ã€‚ å‡ ä¸ªæ¦‚å¿µï¼š1.è¿é€šå›¾ï¼šä»ä»»æ„ä¸€ä¸ªé¡¶ç‚¹éƒ½å­˜åœ¨ä¸€æ¡è·¯å¾„åˆ°è¾¾å¦ä¸€ä¸ªä»»æ„é¡¶ç‚¹ã€‚éè¿é€šå›¾ç”±è‹¥å¹²è¿é€šå›¾ç»„æˆï¼Œéƒ½æ˜¯æå¤§è¿é€šå­å›¾ã€‚2.æ ‘æ˜¯ä¸€ä¸ªæ— ç¯è¿é€šå›¾ã€‚è¿é€šå›¾çš„ç”Ÿæˆæ ‘æ˜¯å…¶ä¸€ä¸ªå­å›¾ï¼Œæ‹¥æœ‰å›¾çš„æ‰€æœ‰é¡¶ç‚¹ã€‚3.äºŒåˆ†å›¾ä¸€ç§èƒ½å¤Ÿå°†æ‰€æœ‰èŠ‚ç‚¹åˆ†ä¸ºä¸¤éƒ¨åˆ†çš„å›¾ã€‚ç®€å•çš„è¯´ï¼Œå¦‚æœæŒ‰åŒè‰²ä¸Šè‰²ï¼ŒäºŒåˆ†å›¾çš„ä»»æ„ä¸¤ä¸ªç›¸é‚»çš„é¡¶ç‚¹çš„é¢œè‰²ä¸åŒã€‚ ä¸¤ä¸ªé¡¶ç‚¹é€šè¿‡ä¸€æ¡è¾¹è¿æ¥ï¼Œç§°ä¸ºç›¸é‚»çš„ã€‚é¡¶ç‚¹çš„åº¦æ•°ä¸ºä¸ä»–ç›¸è¿çš„è¾¹çš„æ€»æ•°ã€‚æœ‰å‘å›¾ä¸­çš„åº¦æ•°åˆ†ä¸ºå…¥åº¦å’Œå‡ºåº¦ï¼Œå…¥åº¦ä¸ºæŒ‡å‘è¯¥é¡¶ç‚¹çš„è¾¹çš„æ€»æ•°ï¼Œå‡ºåº¦ä¸ºä»è¯¥é¡¶ç‚¹æŒ‡å‡ºçš„è¾¹çš„æ€»æ•°ã€‚ è‡ªç¯ï¼šä¸€æ¡è¿æ¥é¡¶ç‚¹å’Œå…¶è‡ªèº«çš„è¾¹ ä¸€å¯¹é¡¶ç‚¹çš„ä¸¤æ¡è¾¹ç§°ä¸ºå¹³è¡Œè¾¹ã€‚ PartOne:æ— å‘å›¾ç›¸å…³ç®—æ³•ä¸€ã€æ— å‘å›¾1.1 æ•°æ®ç»“æ„123456789101112/** * é¡¶ç‚¹æ•°ç›® */ private final int V; /** * è¾¹çš„æ•°ç›® */ private int E; /** * é‚»æ¥è¡¨ï¼ŒBagä¸ºèƒŒåŒ…ï¼Œä¸ºä¸€ä¸ªåªå…¥ä¸å‡ºçš„é˜Ÿåˆ—ï¼Œadj[v]å³è¡¨ç¤ºä¸é¡¶ç‚¹vç›¸è¿çš„é¡¶ç‚¹ï¼Œå› æ­¤ç›¸é‚»çš„ä¸¤ä¸ªé¡¶ç‚¹vå’Œwåˆ†åˆ«ä¼šå‡ºç°åœ¨å¯¹æ–¹çš„é‚»æ¥è¡¨ä¸­ */ private Bag&lt;Integer&gt;[] adj; 1.2 æ„é€ 12345678public Graph(int v) { V = v; this.E=0; adj=new Bag[V]; for (int i = 0; i &lt; V; i++) { adj[i]=new Bag&lt;&gt;(); } } 1.3 ç›¸å…³æ–¹æ³•ä¸¤é¡¶ç‚¹æ˜¯å¦ç›¸é‚»ï¼š 123456789public boolean hasEdge(int v,int w){ //éå†é¡¶ç‚¹vçš„é‚»æ¥è¡¨ï¼ŒæŸ¥æ‰¾æœ‰æ— é¡¶ç‚¹w for(int x:adj(v)){ if (x==w){ return true; } } return false; } æ·»åŠ ä¸€æ¡è¾¹ï¼š 12345678public void addEdge(int v,int w){ //ä¹Ÿå¯ä»¥é€šè¿‡åˆ¤æ–­v==wå’ŒhasEdge(v,w)å†³å®šæ˜¯å¦å…è®¸è‡ªç¯å’Œå¹³è¡Œè¾¹ adj[v].add(w); adj[w].add(v); E++; } 12345678910111213141516171819202122232425262728293031//é¡¶ç‚¹åº¦æ•° public int degree(int v){ int degree=0; for (int w:adj(v)){ degree++; } return degree; } //æœ€å¤§åº¦æ•° public int maxDegree(){ int max=0; for (int v = 0; v &lt; V; v++) { int degree = degree(v); if (degree&gt;max){ max=degree; } } return max; } //è‡ªç¯æ•° public int numOfSelfLoops(Graph graph){ int loops=0; for (int i = 0; i &lt; graph.V(); i++) { for(int w:graph.adj(i)){ if (w==i){ loops++; } } } return loops/2; } äºŒã€æ·±åº¦ä¼˜å…ˆæœç´¢ç®€å•çš„è¯´å°±æ˜¯ ä»ç»™å®šé¡¶ç‚¹å‡ºå‘ï¼Œä¸€ç›´å‘ä¸‹èµ°ï¼Œç›´åˆ°ä¸‹é¢æ²¡æœ‰è·¯äº†ï¼Œç„¶åè¿”å›ä¸Šä¸€ä¸ªé¡¶ç‚¹ï¼Œç»§ç»­è¿›è¡ŒåŒæ ·æ–¹å¼éå†ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰çš„é¡¶ç‚¹ã€‚ å› æ­¤æˆ‘ä»¬éœ€è¦å¦‚ä¸‹çš„æ•°æ®ç»“æ„ï¼š 1234567891011121314/** * æ ‡è®°é¡¶ç‚¹iæ˜¯å¦è¢«è®¿é—® */ private boolean[] marked; /** * ä»èµ·ç‚¹åˆ°ä¸€ä¸ªé¡¶ç‚¹çš„å·²çŸ¥è·¯å¾„ä¸Šçš„æœ€åä¸€ä¸ªé¡¶ç‚¹ * å¦‚ v-&gt;w-&gt;x åˆ™edgeTo[w]=v,edgeTo[x]=w */ private int[] edgeTo; /** * éå†çš„èµ·ç‚¹ */ private final int s; æ„é€ å‡½æ•°ï¼š 1234567public DepthFirstPaths(Graph G, int s) { this.s = s; //åˆå§‹åŒ–ä¸¤ä¸ªæ•°ç»„ edgeTo = new int[G.V()]; marked = new boolean[G.V()]; dfs(G, s); } æ·±åº¦ä¼˜å…ˆéå†ï¼š 1234567891011121314private void dfs(Graph G, int v) { //æ ‡è®°å½“å‰é¡¶ç‚¹ä¸ºtrue marked[v] = true; //éå†ä¸å½“å‰é¡¶ç‚¹ç›¸é‚»çš„é¡¶ç‚¹ for (int w : G.adj(v)) { //å¦‚æœæ²¡æœ‰è¢«è®¿é—® if (!marked[w]) { //æ ‡è®°èµ·ç‚¹åˆ°å½“å‰é¡¶ç‚¹çš„æœ€åä¸€ä¸ªè·¯å¾„ edgeTo[w] = v; //ä»å½“å‰èŠ‚ç‚¹ç»§ç»­è¿›è¡Œéå† dfs(G, w); } } } æ˜¯å¦å­˜åœ¨ä»èµ·ç‚¹åˆ°æŒ‡å®šé¡¶ç‚¹çš„è·¯å¾„ï¼š 1234public boolean hasPathTo(int v) { validateVertex(v); return marked[v]; } è¿”å›ä»èµ·ç‚¹åˆ°æŒ‡å®šé¡¶ç‚¹çš„è·¯å¾„ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›nullï¼š 1234567891011121314public Iterable&lt;Integer&gt; pathTo(int v) { if (!hasPathTo(v)){ //æ²¡æœ‰åˆ°è¾¾è·¯å¾„ï¼Œè¿”å›null return null; } //å› ä¸ºedgeToä¿å­˜çš„æ˜¯åˆ°è¾¾å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå› æ­¤ä½¿ç”¨æ ˆç»“æ„ï¼Œè¿™æ ·ä»å½“å‰èŠ‚ç‚¹åˆ°èµ·å§‹é¡¶ç‚¹çš„é¡¶ç‚¹ä¾æ­¤å…¥æ ˆï¼Œéå†çš„æ—¶å€™ä¾¿æ˜¯ä»èµ·ç‚¹åˆ°è¯¥é¡¶ç‚¹çš„å®Œæ•´è·¯å¾„ Stack paths=new Stack(); for (int i = v; i !=s ; i=edgeTo[i]) { paths.push(i); } paths.push(s); return paths; } æµ‹è¯•ï¼š 12345678910111213141516public static void main(String[] args) { Graph graph=new Graph(6); graph.addEdge(0,2); graph.addEdge(0,1); graph.addEdge(0,5); graph.addEdge(2,1); graph.addEdge(2,3); graph.addEdge(2,4); graph.addEdge(3,5); graph.addEdge(3,4); DepthFirstPaths dfs=new DepthFirstPaths(graph,0); Iterable&lt;Integer&gt; paths = dfs.pathTo(4); for (Integer i:paths){ System.out.println(i.toString()); } } ç»“æœï¼š 12340534 ä¸‰ã€å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼šå¹¿åº¦ä¼˜å…ˆæœç´¢çš„æ€æƒ³æ˜¯ï¼Œä»å½“å‰èŠ‚ç‚¹ï¼Œå…ˆéå†ä¸è¯¥èŠ‚ç‚¹ç›¸é‚»çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åå†å¯¹ç›¸é‚»é¡¶ç‚¹è¿›è¡Œå¹¿åº¦ä¼˜å…ˆéå†ã€‚æ·±åº¦ä¼˜å…ˆæ˜¯çºµå‘éå†ï¼Œå¹¿åº¦ä¼˜å…ˆæ˜¯æ¨ªå‘éå†ã€‚ æ•°æ®ç»“æ„ï¼šå¹¿åº¦ä¼˜å…ˆæœç´¢çš„æ•°æ®ç»“æ„åŒæ·±åº¦åŸºæœ¬ä¸€æ ·ï¼š 123456789101112public class BreadthFirstPaths { private final int start; private int[] edgeTo; private boolean[] marked; public BreadthFirstPaths(Graph graph,int start) { this.start = start; edgeTo=new int[graph.V()]; marked=new boolean[graph.V()]; bfs(graph,start); }} ä½†åœ¨éå†çš„æ—¶å€™é‡‡ç”¨é˜Ÿåˆ—è¿›è¡Œè¾…åŠ©ï¼Œæ€æƒ³å¦‚ä¸‹ï¼š1.å°†å½“å‰é¡¶ç‚¹åŠ å…¥é˜Ÿåˆ—2.ä»å‡ºé˜Ÿå‡ºé˜Ÿä¸€ä¸ªé¡¶ç‚¹ï¼ˆç¬¬ä¸€æ¬¡æ—¶å‡ºé˜Ÿçš„å°±æ˜¯å½“å‰èŠ‚ç‚¹ï¼‰ï¼Œéå†è¯¥é¡¶ç‚¹çš„æ‰€æœ‰ç›¸é‚»é¡¶ç‚¹ï¼Œç½®marked[v]ä¸ºtrueï¼Œå¹¶ä¾æ­¤å…¥é˜Ÿã€‚3.å½“é˜Ÿåˆ—éç©ºæ—¶ï¼Œå¾ªç¯æ­¥éª¤2 ä»£ç å¦‚ä¸‹ï¼š 12345678910111213private void bfs(Graph graph, int start) { Queue&lt;Integer&gt; queue=new Queue&lt;&gt;(); queue.enqueue(start); marked[start]=true; while (!queue.isEmpty()){ int v = queue.dequeue(); for (int w:graph.adj(v)){ queue.enqueue(w); edgeTo[w]=v; marked[w]=true; } } } å››ã€è¿é€šåˆ†é‡æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š 12345678910111213141516public class CC { private boolean[] marked; /** * é¡¶ç‚¹å±äºå“ªä¸ªè¿é€šåˆ†é‡ å¦‚ é¡¶ç‚¹vå±äºç¬¬countä¸ªè¿é€šåˆ†é‡ï¼Œåˆ™id[v]=count */ private int[] id; /** * ç¬¬countä¸ªè¿é€šåˆ†é‡çš„é¡¶ç‚¹æ•° */ private int[] size; /** * è¿é€šåˆ†é‡æ•° */ private int count; } æ€æƒ³å¦‚ä¸‹ï¼šéå†æ‰€æœ‰çš„é¡¶ç‚¹ï¼Œå¯¹æ¯ä¸ªé¡¶ç‚¹éƒ½æ‰§è¡Œdfsæ·±åº¦ä¼˜å…ˆéå†ï¼Œå¦‚æœä¸¤ä¸ªé¡¶ç‚¹åœ¨åŒä¸€ä¸ªè¿é€šåˆ†é‡ï¼Œé‚£ä¹ˆåœ¨å¯¹ä¸€ä¸ªé¡¶ç‚¹è¿›è¡Œdfséå†çš„æ—¶å€™ï¼Œä¸¤ä¸ªé¡¶ç‚¹å¿…ç„¶ä¼šåœ¨æ„é€ å‡½æ•°çš„ä¸€ä¸ªdfsä¸­è¢«è®¿é—®åˆ°ï¼Œå±äºåŒä¸€ä¸ªè¿é€šåˆ†é‡ã€‚æ„é€ å‡½æ•°ï¼š 12345678910111213141516171819202122232425public CC(Graph G) { marked = new boolean[G.V()]; id = new int[G.V()]; size = new int[G.V()]; //ä»£ç 1 for (int v = 0; v &lt; G.V(); v++) { if (!marked[v]) { dfs(G, v); //ä¸é¡¶ç‚¹vè¿é€šçš„æ‰€æœ‰é¡¶ç‚¹éƒ½éå†å®Œæ¯•åï¼Œè¯´æ˜è¯¥è¿é€šåˆ†é‡æ‰€æœ‰é¡¶ç‚¹å·²éå†å®Œæ¯•ï¼Œå¢åŠ count count++; } } } private void dfs(Graph G, int v) { marked[v] = true; //é¡¶ç‚¹vå±äºç¬¬countä¸ªåˆ†é‡ id[v] = count; //ç¬¬countä¸ªåˆ†é‡çš„é¡¶ç‚¹æ•°åŠ 1 size[count]++; for (int w : G.adj(v)) { if (!marked[w]) { dfs(G, w); } } } äº”ã€åˆ¤æ–­æ˜¯å¦ä¸ºæ— ç¯å›¾å¯¹äºæ— å‘å›¾è€Œè¨€ï¼Œåˆ¤æ–­å…¶æ˜¯å¦ä¸ºæ— ç¯å›¾å¾ˆç®€å•ï¼Œåœ¨å¯¹æŸä¸ªé¡¶ç‚¹è¿›è¡Œdfséå†æ—¶ï¼Œå‡å¦‚å®ƒçš„ç›¸é‚»é¡¶ç‚¹å·²è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆæœ‰ä¸¤ç§å¯èƒ½ï¼šä»¥ 3-4-5-3ä¸ºä¾‹ æ¯æ¬¡dfséƒ½ä¼ é€’è¦éå†çš„èŠ‚ç‚¹ï¼Œå’Œå½“å‰åˆšåˆšè¢«éå†è¿‡çš„èŠ‚ç‚¹ä¸€å¼€å§‹ä¸‰ä¸ªé¡¶ç‚¹éƒ½æœªè¢«è®¿é—®1.ç°åœ¨å¯¹3è¿›è¡Œdfsï¼Œè®¿é—®åˆ°5,5è¢«æ ‡è®°ä¸ºtrueï¼›2.å†å¯¹5è¿›è¡Œdfsï¼Œæ­¤æ—¶3å·²ç»è¢«è®¿é—®ï¼Œä½†æ˜¯æ­¤æ—¶çš„3å±äºé¡¶ç‚¹5çš„çˆ¶çº§ï¼Œä¸æ„æˆç¯ï¼Œå†è®¿é—®4ï¼Œæ ‡è®°4ä¸ºtrueï¼›3.æ¥ç€å¯¹4è¿›è¡Œdfsï¼Œæ­¤æ—¶é¡¶ç‚¹5è¢«è®¿é—®ï¼ŒåŒ2ä¸€æ ·ï¼Œé¡¶ç‚¹5å±äºé¡¶ç‚¹4çš„â€œçˆ¶çº§â€ï¼Œä¸æ„æˆç¯ï¼Œä½†æ˜¯3ä¹Ÿè¢«è®¿é—®äº†ï¼Œä¸”3ä¸æ˜¯é¡¶ç‚¹4çš„â€œçˆ¶çº§â€ï¼Œå› æ­¤æ­¤å¤„å‡ºç°ç¯ã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122private boolean[] marked; private boolean hasCycle; public Cycle(Graph G) { marked=new boolean[G.V()]; for (int i = 0; i &lt; G.V(); i++) { if (!marked[i]){ dfs(G,i,i); } } } private void dfs(Graph G,int v, int u){ marked[v]=true; for(int w:G.adj(v)){ if (!marked[w]){ dfs(G,w,v); }else if (w!=u){//å¦‚ 3:5 5:3 å°±ä¸æ„æˆç¯ hasCycle=true; } } } å…­ã€äºŒåˆ†å›¾é—®é¢˜è¿™ä¸ªåŒæ— ç¯å›¾é—®é¢˜ç±»å‹ï¼Œåœ¨å¯¹ä¸€ä¸ªé¡¶ç‚¹è¿›è¡Œdfséå†æ—¶ï¼Œå°†å…¶æœªè¢«è®¿é—®çš„ä¸´æ¥é¡¶ç‚¹ç½®ä¸ºä¸è¯¥é¡¶ç‚¹å¯¹ç«‹çš„é¢œè‰²ï¼Œè‹¥å·²ç»è¢«è®¿é—®ï¼Œåˆ™åˆ¤æ–­è¯¥é¡¶ç‚¹çš„é¢œè‰²ä¸å½“å‰é¡¶ç‚¹çš„é¢œè‰²æ˜¯å¦ä¸ä¸€æ ·ï¼Œå¦‚æœä¸€æ ·ï¼Œåˆ™ä¸æ˜¯äºŒåˆ†å›¾ã€‚ å…³é”®ä»£ç å¦‚ä¸‹ï¼š 123456789101112private void dfs(Graph graph, int v) { marked[v]=true; for (int w: graph.adj(v)){ if (!marked[w]){ color[w]=!color[v]; dfs(graph,w); }else if (color[w]==color[v]){ isTwoColorable=false; break; } } } PartTwo:æœ‰å‘å›¾ç›¸å…³ç®—æ³•æœ‰å‘å›¾çš„å®šä¹‰å’Œæ— å‘å›¾åŸºæœ¬ä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿæ˜¯åŸºäºä¸´æ¥è¡¨å®ç°ï¼Œä½†åœ¨æ’å…¥è¾¹çš„æ—¶å€™ï¼Œæœ‰å‘å›¾åªéœ€è¦æ“ä½œè¾¹çš„å§‹ç‚¹çš„é‚»æ¥è¡¨ï¼Œä¸éœ€åƒæ— å‘å›¾ä¸€æ ·ä¸¤ä¸ªé¡¶ç‚¹çš„é‚»æ¥è¡¨éƒ½æ’å…¥å¯¹åº”çš„é¡¶ç‚¹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839public class Digraph { private final int V; private int E; private Bag&lt;Integer&gt;[] adj; public Digraph(int v) { V = v; this.E=0; adj=new Bag[V]; for (int i = 0; i &lt; v; i++) { adj[i]=new Bag&lt;&gt;(); } } public int V(){ return V; } public int E(){ return E; } public void addEdge(int v,int w){ adj[v].add(w); E++; } public Iterable&lt;Integer&gt; adj(int v){ return adj[v]; } /** * è·å–å½“å‰æœ‰å‘å›¾çš„åè½¬å›¾ */ public Digraph reverse(){ Digraph R=new Digraph(V); for (int v = 0; v &lt; V; v++) { for (int w: adj(v)){ R.addEdge(w,v); } } return R; }} ä¸€ã€æœ‰å‘å›¾çš„å¯è¾¾æ€§ï¼šè¿™é‡ŒåŒæ— å‘å›¾ä¸€æ ·ï¼Œåªéœ€å°†Graphæ¢ä¸ºDigraphå³å¯ï¼šè¿›è¡ŒDFSéå†: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public class DirectedDFS { private boolean[] marked; /** * å•ç‚¹å¯è¾¾æ€§ * ç»è¿‡æ­¤æ–¹æ³•ï¼Œä»marked(int v)è¿”å›æ˜¯å¦å­˜åœ¨ä¸€æ¡ä»såˆ°è¾¾ç»™å®šé¡¶ç‚¹vçš„æœ‰å‘è·¯å¾„ * @param digraph * @param s */ public DirectedDFS(Digraph digraph,int s) { marked=new boolean[digraph.V()]; dfs(digraph,s); } /** * å¤šç‚¹å¯è¾¾æ€§ * æ˜¯å¦å­˜åœ¨ä¸€æ¡ä»é›†åˆä¸­çš„ä»»æ„é¡¶ç‚¹åˆ°è¾¾ç»™å®šé¡¶ç‚¹vçš„æœ‰å‘è·¯å¾„ * @param digraph * @param sources */ public DirectedDFS(Digraph digraph,Iterable&lt;Integer&gt; sources) { marked=new boolean[digraph.V()]; for (int s:sources){ if (!marked[s]){ dfs(digraph,s); } } } private void dfs(Digraph digraph, int v) { marked[v]=true; for (int w:digraph.adj(v)){ if (!marked[w]){ dfs(digraph,w); } } } public boolean marked(int v){ return marked[v]; } public static void main(String[] args) { Digraph graph=new Digraph(6); graph.addEdge(0,2); graph.addEdge(0,1); graph.addEdge(0,5); graph.addEdge(2,1); graph.addEdge(2,3); graph.addEdge(4,5); DirectedDFS dfs=new DirectedDFS(graph,0); System.out.println(dfs.marked(3)); }} é¡¶ç‚¹å¯¹çš„å¯è¾¾æ€§å€ŸåŠ©DirectedDFSæ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°é¡¶ç‚¹å¯¹çš„å¯è¾¾æ€§ï¼šæ— è®ºå¯¹äºç¨€ç–è¿˜æ˜¯ç¨ å¯†çš„å›¾ï¼Œå®ƒéƒ½æ˜¯ç†æƒ³çš„è§£å†³æ–¹æ¡ˆï¼Œä½†ä¸é€‚ç”¨äºå®é™…åº”ç”¨ä¸­çš„å¤§å‹æœ‰å‘å›¾ï¼Œå› ä¸ºæ„é€ å‡½æ•°æ‰€éœ€çš„ç©ºé—´å’ŒVÂ²æˆæ­£æ¯”ï¼Œæ‰€éœ€æ—¶é—´å’ŒVï¼ˆV+Eï¼‰æˆæ­£æ¯” 1234567891011121314151617181920public class TransitiveClosure { private DirectedDFS[] directedDFS; // tc[v] = reachable from v /** * æ„é€ å‡½æ•° * æ‰€éœ€ç©ºé—´ä¸VÂ²æˆæ­£æ¯” * æ‰€éœ€æ—¶é—´ä¸ V(V+E)æˆæ­£æ¯” * @param G */ public TransitiveClosure(Digraph G) { directedDFS = new DirectedDFS[G.V()]; for (int v = 0; v &lt; G.V(); v++) directedDFS[v] = new DirectedDFS(G, v); } boolean reachable(int v,int w){ return directedDFS[v].marked(w); }} äºŒã€å•ç‚¹æœ‰å‘è·¯å¾„å’Œå•ç‚¹æœ€çŸ­æœ‰å‘è·¯å¾„åŒæ— å‘å›¾ä¸€æ ·ï¼Œå•ç‚¹æœ‰å‘è·¯å¾„å°±æ˜¯å€ŸåŠ©DFSï¼Œå¯¹ä»såˆ°vè·¯å¾„ä¸Šçš„æ¯ä¸€ä¸ªé¡¶ç‚¹ï¼Œä½¿ç”¨edgeToæ•°ç»„ä¿å­˜ä»såˆ°è¯¥é¡¶ç‚¹çš„è·¯å¾„ä¸Šçš„æœ€åä¸€ä¸ªé¡¶ç‚¹åæ ‡ï¼›è€Œå•ç‚¹æœ€çŸ­è·¯å¾„å°±æ˜¯ä»¥åŒæ ·çš„æ–¹å¼å€ŸåŠ©BFSä¿å­˜ä»såˆ°æŒ‡å®šé¡¶ç‚¹çš„è·¯å¾„ï¼Œè¿™æ ·å¾—å‡ºçš„è·¯å¾„å°±æ˜¯åˆ°è¾¾è¯¥é¡¶ç‚¹çš„æœ€çŸ­è·¯å¾„ã€‚ ä¸‰ã€ç¯å’Œæ— ç¯å›¾ï¼ˆæ‹“æ‰‘æ’åºï¼‰åœ¨è°ƒåº¦é—®é¢˜ä¸­ï¼Œé™åˆ¶æ¡ä»¶æ˜¯è¿™äº›ä»»åŠ¡çš„æ‰§è¡Œæ–¹æ³•å’Œèµ·å§‹æ—¶é—´ï¼Œä½†æœ€é‡è¦çš„é™åˆ¶æ¡ä»¶å«åšæœ‰é™åˆ¶çº§é™åˆ¶ï¼Œå®ƒæŒ‡æ˜äº†ä»»åŠ¡é—´æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚ æˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªæœ‰ä¼˜å…ˆçº§é™åˆ¶çš„ä»»åŠ¡ä¸­ï¼ŒæŒ‰è¯¥é™åˆ¶æ¡ä»¶æ‰¾å‡ºå®‰æ’å®Œæˆä»»åŠ¡çš„é¡ºåºã€‚è¿™ä¹Ÿç­‰ä»·äºä¸€ä¸ªåŸºæœ¬é—®é¢˜ï¼šæ‹“æ‰‘æ’åºï¼Œå³åœ¨ä¸€ä¸ªæœ‰å‘å›¾ä¸­ï¼Œå°†æ‰€æœ‰é¡¶ç‚¹æ’åºï¼Œæ»¡è¶³æ‰€æœ‰çš„æœ‰å‘è¾¹å‡ä»æ’åœ¨å‰é¢çš„å…ƒç´ æŒ‡å‘æ’åœ¨åé¢çš„å…ƒç´ ï¼ˆæˆ–æŒ‡å‡ºæ— æ³•åšåˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚ ä»¥é«˜æ ¡è¯¾ç¨‹å®‰æ’ä¸ºä¾‹ï¼Œä¸€äº›è¯¾ç¨‹çš„å¼€è¯¾å¿…é¡»è¦æ±‚å­¦ç”Ÿä¿®å®Œå‰é¢çš„æŸäº›è¯¾ï¼Œè€Œæ‹“æ‰‘æ’åºå°±æ˜¯åœ¨è¿™ç§é™åˆ¶æ¡ä»¶ä¸‹ï¼Œæ‰¾å‡ºå­¦ç”Ÿé€‰ä¿®è¯¾ç¨‹çš„é¡ºåºã€‚ è€Œä¸€æ—¦ä¸€ä¸ªä¼˜å…ˆçº§é™åˆ¶çš„é—®é¢˜ä¸­å­˜åœ¨æœ‰å‘ç¯ï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜ä¸€å®šæ˜¯æ— è§£çš„ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦è¿›è¡Œæœ‰å‘ç¯çš„æ£€æµ‹ã€‚æœ‰å‘æ— ç¯å›¾å°±æ˜¯ä¸å«æœ‰æœ‰å‘ç¯çš„æœ‰å‘å›¾ æ£€æµ‹æœ‰å‘ç¯çš„æ€è·¯å¦‚ä¸‹ï¼šå¯¹æœ‰å‘å›¾çš„æ¯ä¸ªé¡¶ç‚¹éƒ½è¿›è¡ŒDFSéå†ï¼Œå‡è®¾ä»é¡¶ç‚¹vå¼€å§‹æ·±åº¦ä¼˜å…ˆéå†ï¼Œå°†ä»è¯¥é¡¶ç‚¹é€’å½’è°ƒç”¨è·¯å¾„ä¸Šçš„æ‰€æœ‰é¡¶ç‚¹markedæ ‡è®°åå†ä½¿ç”¨ä¸€ä¸ªboolean[] onStackæ ‡è®°æ˜¯å¦åœ¨é€’å½’æ ˆä¸Šï¼Œå¦‚æœå¯¹ä¸€ä¸ªé¡¶ç‚¹çš„DFSé€’å½’è°ƒç”¨æ²¡æœ‰å‘ç°æœ‰å‘ç¯ï¼Œåˆ™é€’å½’ç»“æŸå‰å†è®©è¯¥èŠ‚ç‚¹çš„onStackçŠ¶æ€æ”¹ä¸ºfalseï¼›è€Œå¦‚æœå¯¹æŸä¸ªé¡¶ç‚¹çš„é€’å½’è°ƒç”¨æ—¶å‘ç°å¦ä¸€ä¸ªé¡¶ç‚¹å·²ç»è¢«æ ‡è®°äº†ï¼Œä¸”onStackä¸ºtrueï¼Œåˆ™è¯´æ˜è¿™ä¸ªè·¯å¾„ä¸Šä¸€å®šå­˜åœ¨æœ‰å‘ç¯ï¼Œè¿™æ—¶å°†è¯¥ç¯ä¸Šçš„æ‰€æœ‰ç‚¹åŠ å…¥Stack cycleæ ˆä¸­ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public class DirectedCycle { private boolean[]marked; private int[] edgeTo; /** * æœ‰å‘ç¯ä¸­çš„æ‰€æœ‰é¡¶ç‚¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ */ private Stack&lt;Integer&gt;cycle; /** * é€’å½’è°ƒç”¨çš„æ ˆä¸Šçš„æ‰€æœ‰é¡¶ç‚¹ */ private boolean[] onStack; public DirectedCycle(Digraph digraph) { marked=new boolean[digraph.V()]; edgeTo=new int[digraph.V()]; onStack=new boolean[digraph.V()]; for (int v = 0; v &lt; digraph.V(); v++) { if (!marked[v]){ dfs(digraph,v); } } } /** * ä½¿ç”¨ä¸å¸¦æƒçš„Digraph * @param digraph * @param v */ private void dfs(Digraph digraph, int v) { onStack[v]=true; marked[v]=true; for (int w: digraph.adj(v)){ if (this.hasCycle()){ //å¦‚æœå·²ç»æ‰¾åˆ°æœ‰å‘ç¯ï¼Œåˆ™è¿”å› return; } else if (!marked[w]){ edgeTo[w]=v; dfs(digraph,w); }else if (onStack[w]){ cycle=new Stack&lt;&gt;(); for (int x = v; x != w; x=edgeTo[x]) { cycle.push(x); } cycle.push(w); cycle.push(v); } } //å¯¹vçš„ä¸€æ¬¡é€’å½’è°ƒç”¨åï¼Œå¦‚æœæ²¡å‘ç°ç¯ï¼Œåˆ™é‡ç½®ä¸ºfalse onStack[v]=false; } public Iterable&lt;Integer&gt;cycle(){ return cycle; } public boolean hasCycle(){ return cycle!=null; }} æµ‹è¯•ï¼š 12345678910111213141516public static void main(String[] args) { Digraph digraph=new Digraph(4); digraph.addEdge(0,1); digraph.addEdge(2,3); digraph.addEdge(3,1); digraph.addEdge(1,2); //å­˜åœ¨ç¯3&gt;1-&gt;2&gt;3 DirectedCycle cycle = new DirectedCycle(digraph); if (cycle.hasCycle()){ System.out.println(\"å­˜åœ¨ç¯\"); Stack&lt;Integer&gt; stack = cycle.cycle; while (!stack.isEmpty()){ System.out.println(stack.pop()); } } } ç»“æœï¼š 12345å­˜åœ¨ç¯3123 ã€Šç®—æ³•4ã€‹ä¸­ç»™å‡ºï¼š ä¸€å¹…æœ‰å‘æ— ç¯å›¾çš„æ‹“æ‰‘æ’åºå°±æ˜¯æ‰€æœ‰é¡¶ç‚¹çš„é€†åæ’åº é‚£ä¹ˆä»€ä¹ˆæ˜¯é€†åæ’åºå‘¢ï¼Ÿæˆ‘ä»¬è§„å®šï¼šå‰åºï¼š åœ¨å¯¹é¡¶ç‚¹vé€’å½’è°ƒç”¨å‰å°±å°†è¯¥é¡¶ç‚¹åŠ å…¥é˜Ÿåˆ—ï¼Œæœ€åå‡ºé˜Ÿçš„é¡ºåºå°±æ˜¯å‰åºååºï¼šåœ¨å¯¹é¡¶ç‚¹vé€’å½’è°ƒç”¨åå°†è¯¥é¡¶ç‚¹åŠ å…¥é˜Ÿåˆ—ï¼Œæœ€åå‡ºé˜Ÿçš„é¡ºåºå°±æ˜¯ååºé€†ååºï¼šåœ¨å¯¹é¡¶ç‚¹vé€’å½’è°ƒç”¨åå°†è¯¥é¡¶ç‚¹åŠ å…¥æ ˆä¸­ï¼Œæœ€åå‡ºæ ˆçš„é¡ºåºå°±æ˜¯é€†ååº å®ç°å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061/** * æœ‰å‘å›¾ä¸­åŸºäºæ·±åº¦ä¼˜å…ˆæœç´¢çš„é¡¶ç‚¹æ’åº * @author MaoLin Wang * @date 2020/2/2214:55 */public class DepthFirstOrder { private boolean[]marked; /** * æ‰€æœ‰é¡¶ç‚¹çš„å‰åºéå†(é€’å½’è°ƒç”¨å‰åŠ å…¥é˜Ÿåˆ—) */ private Queue&lt;Integer&gt; pre; /** * æ‰€æœ‰é¡¶ç‚¹çš„ååºéå†(é€’å½’è°ƒç”¨ååŠ å…¥é˜Ÿåˆ—) */ private Queue&lt;Integer&gt; post; /** * æ‰€æœ‰é¡¶ç‚¹çš„é€†ååºéå†(é€’å½’è°ƒç”¨åå‹å…¥æ ˆ) */ private Stack&lt;Integer&gt; reversePost; public DepthFirstOrder(Digraph digraph) { pre=new Queue&lt;&gt;(); post=new Queue&lt;&gt;(); reversePost=new Stack&lt;&gt;(); marked=new boolean[digraph.V()]; for (int v = 0; v &lt; digraph.V(); v++) { if (!marked[v]){ dfs(digraph,v); } } } private void dfs(Digraph digraph, int v) { System.out.println(\"dfs(\"+v+\")\"); pre.enqueue(v); marked[v]=true; for (int w: digraph.adj(v)){ if (!marked[w]){ dfs(digraph,w); } } System.out.println(v+\"å®Œæˆ\"); post.enqueue(v); reversePost.push(v); } public Iterable&lt;Integer&gt;pre(){ return pre; } public Queue&lt;Integer&gt;post(){ return post; } public Iterable&lt;Integer&gt;reversePost(){ return reversePost; }} æˆ‘ä»¬å…ˆæµ‹è¯•ä¸€ä¸‹ä¸€å¼ æœ‰å‘æ— ç¯å›¾çš„å„ä¸ªæ’åºçš„é¡ºåºï¼š 12345678910111213141516171819202122public static void main(String[] args) { Digraph digraph = new Digraph(13); digraph.addEdge(0,5); digraph.addEdge(0,1); digraph.addEdge(0,6); digraph.addEdge(2,0); digraph.addEdge(2,3); digraph.addEdge(3,5); digraph.addEdge(5,4); digraph.addEdge(6,4); digraph.addEdge(6,9); digraph.addEdge(7,6); digraph.addEdge(8,7); digraph.addEdge(9,10); digraph.addEdge(9,11); digraph.addEdge(9,12); digraph.addEdge(11,12); DepthFirstOrder depthFirstOrder = new DepthFirstOrder(digraph); Stack&lt;Integer&gt; reversePost = depthFirstOrder.reversePost; } è°ƒç”¨ç»“æœåŠå½¢æˆçš„é˜Ÿåˆ—å¦‚ä¸‹ï¼šè¾¹çš„æ„é€ é¡ºåºä¸ä¸€æ ·ï¼Œå¾—åˆ°çš„æ‹“æ‰‘æ’åºä¹Ÿä¼šä¸ä¸€æ ·ï¼Œä½†æ˜¯ç»“æœä¸€å®šæ˜¯æ»¡è¶³æ‹“æ‰‘æ’åºä¼˜å…ˆçº§é™åˆ¶çš„ã€‚ 123456789101112131415161718192021222324252627 pre post reversePostdfs(0) 0 dfs(6) 0 6 dfs(9) 0 6 9 dfs(12) 0 6 9 12 12å®Œæˆ 12 12 dfs(11) 0 6 9 12 11 11å®Œæˆ 12 11 11 12 dfs(10)0 6 9 12 11 10 10å®Œæˆ 12 11 10 10 11 12 9å®Œæˆ 12 11 10 9 9 10 11 12 dfs(4) 0 6 9 12 11 10 4 4å®Œæˆ 12 11 10 9 4 4 9 10 11 12 6å®Œæˆ 12 11 10 9 4 6 6 4 9 10 11 12dfs(1) 0 6 9 12 11 10 4 1 1å®Œæˆ 12 11 10 9 4 6 1 1 6 4 9 10 11 12dfs(5) 0 6 9 12 11 10 4 1 55å®Œæˆ 12,11,10,9,4,6,1,5 5 1 6 4 9 10 11 120å®Œæˆ 12,11,10,9,4,6,1,5,0 0,5,1,6,4,9,10,11,12dfs(2) 0,6,9,12,11,10,4,1,5,2 dfs(3) 0,6,9,12,11,10,4,1,5,2,3 3å®Œæˆ 12,11,10,9,4,6,1,5,0,3 3,0,5,1,6,4,9,10,11,122å®Œæˆ 12,11,10,9,4,6,1,5,0,3,2 2,3,0,5,1,6,4,9,10,11,12dfs(7) 0,6,9,12,11,10,4,1,5,2,3,77å®Œæˆ 12,11,10,9,4,6,1,5,0,3,2,7 7,2,3,0,5,1,6,4,9,10,11,12dfs(8)8å®Œæˆ 12,11,10,9,4,6,1,5,0,3,2,7,8 8,7,2,3,0,5,1,6,4,9,10,11,12 æˆ‘ä»¬å‘ç°å…¶é€†ååºå°±æ˜¯æˆ‘ä»¬è¦çš„æ‹“æ‰‘æ’åºï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆé€†ååºå°±æ˜¯æ‹“æ‰‘æ’åºå‘¢ï¼Ÿ å¯¹äºä»»æ„è¾¹v-&gt;wï¼Œè°ƒç”¨dfs(v)æ—¶ï¼Œä¸€å®šä¼šå‡ºç°ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹ä¸€ï¼š1.dfsï¼ˆwï¼‰å·²è°ƒç”¨è¿‡ï¼Œä¸”å·²ç»ç»“æŸï¼ˆwè¢«æ ‡è®°è¿‡äº†ï¼‰2.dfsï¼ˆwï¼‰æœªè¢«è°ƒç”¨ï¼ˆwæ²¡è¢«æ ‡è®°ï¼‰ï¼Œå› æ­¤dfsï¼ˆvï¼‰æ—¶ä¼šè°ƒç”¨dfsï¼ˆwï¼‰ï¼Œä¸”dfs(w)ä¼šåœ¨dfs(v)ä¹‹å‰è¿”å›3.dfsï¼ˆwï¼‰è¢«è°ƒç”¨è¿‡äº†ï¼Œä¸”æ²¡æœ‰è¿”å›ã€‚è¿™ä¸ªå°±æ˜¯æœ‰æœ‰å‘ç¯æ—¶ä¼šå‡ºç°çš„æƒ…å†µï¼Œä½†è¿›è¡Œæ‹“æ‰‘æ’åºçš„å‰æçš„æ²¡æœ‰æœ‰å‘ç¯ï¼Œå› ä¸ºè¯¥æƒ…å†µä¸ä¼šå‡ºç°ã€‚å› æ­¤ æƒ…å†µ1å’Œ2éƒ½æ˜¯wåœ¨vä¹‹å‰ç»“æŸè°ƒç”¨ï¼Œåˆ™wåœ¨ååºæ’åºä¸­ï¼Œä¸€å®šåœ¨vä¹‹å‰ï¼Œç›¸åï¼Œåœ¨é€†ååºä¸­ï¼Œwä¸€å®šåœ¨vä¹‹åï¼Œå› æ­¤å¯¹äºä»»æ„v-&gt;wéƒ½æ˜¯æ’åè¾ƒå‰ç‚¹æŒ‡å‘æ’åè¾ƒåçš„ç‚¹ã€‚ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æ‹“æ‰‘æ’åºçš„å®ç°ï¼š 1234567891011121314151617181920212223public class TopologicalSort { //é¡¶ç‚¹çš„æ‹“æ‰‘æ’åº private Iterable&lt;Integer&gt;order; public TopologicalSort(Digraph digraph) { DirectedCycle directedCycle=new DirectedCycle(digraph); //æ’åºå‰è¿›è¡Œæœ‰å‘ç¯æ£€æµ‹ï¼Œæ²¡æœ‰ç¯æ‰å¯ä»¥è¿›è¡Œæ‹“æ‰‘æ’åº if (!directedCycle.hasCycle()){ //è¿”å›æ‹“æ‰‘æ’åº DepthFirstOrder dfs=new DepthFirstOrder(digraph); order=dfs.reversePost(); } } public Iterable&lt;Integer&gt;order(){ return order; } public boolean hasOrder(){ return order!=null; }} å››ã€æœ‰å‘å›¾çš„å¼ºè¿é€šæ€§å®šä¹‰ï¼šå¦‚æœä¸¤ä¸ªé¡¶ç‚¹æ˜¯äº’ç›¸å¯è¾¾çš„ï¼Œåˆ™ç§°æ˜¯å¼ºè¿é€šçš„ã€‚å¦‚æœä¸€ä¸ªæœ‰å‘å›¾çš„ä»»æ„ä¸¤ä¸ªé¡¶ç‚¹éƒ½æ˜¯å¼ºè¿é€šçš„ï¼Œåˆ™è¯¥æœ‰å‘å›¾æ˜¯å¼ºè¿é€šçš„ã€‚æœ‰å‘å›¾çš„æå¤§å¼ºè¿é€šå­å›¾ï¼Œç§°ä¸ºå¼ºè¿é€šåˆ†é‡(strongly connected components)ã€‚å¦‚ä¸‹ï¼šæ¯ä¸ªé¢œè‰²ä»£è¡¨ä¸€ä¸ªå¼ºè”é€šåˆ†é‡ã€‚è®¡ç®—å¼ºè¿é€šåˆ†é‡çš„æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯Kosarajuç®—æ³•ï¼šå…¶æ€æƒ³æ˜¯ï¼š1.ä½¿ç”¨DFSæŸ¥æ‰¾ç»™å®šæœ‰å‘å›¾Gçš„åå‘å›¾G^R2.æ ¹æ®åå‘å›¾G^Ræ±‚å¾—å…¶é€†ååºåˆ—3.å¯¹2æ±‚å¾—çš„é€†ååºè¿›è¡ŒDFSéå†ï¼Œè®¿é—®æœªè¢«æ ‡è®°çš„ç‚¹4.åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ‰€æœ‰åœ¨åŒä¸€ä¸ªdfsè°ƒç”¨ä¸­è¢«è®¿é—®çš„é¡¶ç‚¹éƒ½åœ¨åŒä¸€ä¸ªå¼ºè¿é€šåˆ†é‡ä¸­ï¼ŒæŒ‰æ— å‘å›¾ä¸­æ±‚è¿é€šåˆ†é‡çš„æ–¹æ³•æ±‚å¼ºè¿é€šåˆ†é‡ã€‚ æœ‰å…³è¯¥æ€æƒ³çš„è¯æ˜å¦‚ä¸‹ï¼šæˆ‘ä»¬åªè¦è¯æ˜ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜å³å¯ï¼šï¼ˆæ ‘ä¸Šçš„è¯æ˜çŒ›ä¸€çœ‹å¯èƒ½çœ‹çš„ä¸å¤ªæ‡‚ï¼Œä¸‹é¢ç”¨è‡ªå·±çš„ç†è§£è®²çš„ç»†ä¸€ç‚¹ï¼‰==1.æ¯ä¸ªå’Œså¼ºè¿é€šçš„é¡¶ç‚¹véƒ½ä¼šåœ¨æ„é€ å‡½æ•°è°ƒç”¨çš„dfs(G,s)ä¸­è¢«è®¿é—®åˆ°2.æ„é€ å‡½æ•°è°ƒç”¨çš„dfs(G,s)æ‰€åˆ°è¾¾çš„ä»»æ„é¡¶ç‚¹véƒ½å¿…ç„¶æ˜¯å’Œså¼ºè¿é€šçš„ã€‚== å¯¹å‘½é¢˜1ï¼Œæˆ‘ä»¬ä½¿ç”¨åè¯æ³•ï¼š1.å‡è®¾ä¸€ä¸ªå’Œså¼ºè¿é€šçš„é¡¶ç‚¹våœ¨dfs(G,s)çš„è°ƒç”¨ä¸­æ²¡æœ‰è¢«è®¿é—®åˆ°2.ç”±äºå­˜åœ¨ä¸€æ¡ä»s-&gt;vçš„è·¯å¾„ï¼Œæ‰€ä»¥å¦‚æœé¡¶ç‚¹væ²¡æœ‰åœ¨dfs(G,s)ä¸­è¢«è®¿é—®ï¼Œå°±ä¸€å®šåœ¨ä¹‹å‰è°ƒç”¨äº†dfs(G,v)ï¼Œå¹¶ä¸”è®¿é—®åˆ°äº†vã€‚3.åˆå› ä¸ºså’Œvæ˜¯å¼ºè¿é€šçš„ï¼Œæ‰€ä»¥ä¹Ÿå­˜åœ¨v-&gt;sçš„è·¯å¾„ï¼Œåœ¨dfs(G,v)ä¸­ï¼Œsä¸€å®šä¼šè¢«æ ‡è®°ï¼Œè€Œsè¢«æ ‡è®°ï¼Œå°±ä¸€å®šä¸ä¼šå†æ¬¡è¿›è¡Œdfs(G,s)çš„è°ƒç”¨ï¼ŒçŸ›ç›¾ï¼Œå› æ­¤å‘½é¢˜1æˆç«‹ã€‚ å¯¹å‘½é¢˜2ï¼š1.è¦è¯æ˜så’Œä»»æ„é¡¶ç‚¹vå¼ºè¿é€šï¼Œåªè¦è¯æ˜s-&gt;vä¸”v-&gt;sï¼Œå› ä¸ºvæ˜¯dfs(G,s)è°ƒç”¨ä¸­è®¿é—®åˆ°çš„ä»»æ„é¡¶ç‚¹ï¼Œæ‰€ä»¥ä¸€å®šå­˜åœ¨s-&gt;vï¼Œæ¥ä¸‹æ¥åªè¦è¯æ˜å­˜åœ¨v-&gt;så³å¯ã€‚2.è¦è¯æ˜å­˜åœ¨v-&gt;sï¼Œå°±ç›¸å½“äºè¯æ˜åå‘å›¾ä¸­å­˜åœ¨s1-&gt;v1å¦‚ä¸‹ï¼šå› ä¸ºæˆ‘ä»¬æ˜¯æŒ‰ç…§é€†ååºè¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†çš„ï¼ŒæŒ‰ç…§é€†åºï¼Œæˆ‘ä»¬æ˜¯åœ¨dfs(G,s)çš„è°ƒç”¨ä¸­è°ƒç”¨dfs(G,v)ï¼Œå³å…ˆè®¿é—®så†è®¿é—®vï¼Œæ‰€ä»¥åœ¨åå‘å›¾GRä¸­ï¼Œæˆ‘ä»¬å°±åº”è¯¥æ˜¯å…ˆè®¿é—®vå†è®¿é—®sï¼Œå¯¹åº”ä¸Šå›¾GRä¸­çš„ç‚¹å°±æ˜¯ï¼Œå…ˆè®¿é—®s1å†è®¿é—®v1ã€‚å³åªè¦è¯æ˜dfs(G,v1)åœ¨dfsï¼ˆG,s1ï¼‰ä¹‹å‰ç»“æŸï¼Œåˆ™è¿™æ ·å°±æœ‰å¦‚ä¸‹ä¸¤ä¸ªæƒ…å†µï¼š 1. dfsï¼ˆGï¼Œv1ï¼‰åœ¨è°ƒç”¨dfs(G,s1)ä¹‹å‰ï¼Œä¸”åœ¨dfsï¼ˆGï¼Œs1ï¼‰çš„è°ƒç”¨å¼€å§‹å‰ç»“æŸã€‚2. dfsï¼ˆGï¼Œv1ï¼‰åœ¨è°ƒç”¨dfsï¼ˆG,s1ï¼‰ä¹‹åï¼Œä¸”åœ¨dfsï¼ˆG,s1ï¼‰çš„è°ƒç”¨ç»“æŸå‰ç»“æŸã€‚ å¦‚æœå‡ºç°æƒ…å†µ1ï¼Œè¿™æ˜¾ç„¶ä¸å¯èƒ½ï¼Œå› ä¸ºå¦‚æœv1åœ¨s1ä¹‹å‰å°±ç»“æŸäº†ï¼Œé‚£ä¹ˆå¾—å‡ºçš„é€†ååºåº”è¯¥æ˜¯s1,v1ï¼Œå¯¹åº”Gä¸­çš„vå’Œsï¼Œå…ˆè°ƒç”¨vå†è°ƒç”¨sï¼Œä½†æ˜¯æ˜¾ç„¶Gæ˜¯å…ˆè°ƒç”¨så†è°ƒç”¨vï¼Œæ‰€ä»¥è¯¥æƒ…å†µä¸å­˜åœ¨ã€‚å¦‚æœæ˜¯æƒ…å†µ2ï¼Œåˆ™è¯´æ˜å­˜åœ¨ä¸€æ¡è·¯å¾„s1&gt;v1ï¼Œå³åŸå›¾Gä¸­å­˜åœ¨ä¸€æ¡è·¯å¾„v-&gt;sï¼Œå‘½é¢˜2æ­£ç¡®ã€‚ ä¸‹é¢æ˜¯Kosarajuç®—æ³•çš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/** * è®¡ç®—å¼ºè¿é€šåˆ†é‡çš„Kosarajuç®—æ³• * @author MaoLin Wang * @date 2020/2/2216:54 */public class KosarajuSCC { private boolean[] marked; /** * å¼ºè¿é€šåˆ†é‡çš„æ ‡è¯†ç¬¦ */ private int[] id; /** * å¼ºè¿é€šåˆ†é‡ä¸ªæ•° */ private int count; public KosarajuSCC(Digraph digraph){ marked=new boolean[digraph.V()]; id=new int[digraph.V()]; //æ±‚åå‘å›¾çš„é€†ååº DepthFirstOrder order=new DepthFirstOrder(digraph.reverse()); //å¯¹é€†ååºè¿›è¡Œdfséå† for(int s: order.reversePost()){ if (!marked[s]){ dfs(digraph,s); count++; } } } private void dfs(Digraph digraph, int v) { marked[v]=true; //é¡¶ç‚¹vå±äºç¬¬countä¸ªå¼ºè¿é€šåˆ†é‡ id[v]=count; for (int w: digraph.adj(v)){ if (!marked[w]){ dfs(digraph,w); } } } /*vå’Œwæ˜¯å¦å¼ºè¿é€š*/ public boolean stronglyConnected(int v,int w){ return id[v]==id[w]; } public int id(int v){ return id[v]; } public int count(){ return count; }}","link":"/posts/20200310-graphDetails.html"},{"title":"JVMç¬”è®°ã€Šå››ã€‹å¸¸è§çš„åƒåœ¾æ”¶é›†å™¨","text":"åƒåœ¾æ”¶é›†å™¨ä¸€ã€ Serial ï¼ˆæ–°ç”Ÿä»£ï¼‰1.å•çº¿ç¨‹ï¼ˆæ”¶é›†æœŸé—´éœ€è¦æš‚åœå…¶ä»–æ‰€æœ‰çº¿ç¨‹ï¼‰ 2.å®¢æˆ·ç«¯æ¨¡å¼ä¸‹çš„é»˜è®¤æ”¶é›†å™¨ï¼Œä¹Ÿæ˜¯å¾ˆå¥½çš„é€‰æ‹© ä¼˜ç‚¹ï¼š 1.ç®€å•é«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰ 2.å†…å­˜èµ„æºå—é™æ—¶ï¼Œé¢å¤–å†…å­˜æ¶ˆè€—æœ€å° 3.å› ä¸ºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œå› æ­¤å¯è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ•ˆç‡ äºŒã€ ParNewï¼ˆæ–°ç”Ÿä»£ï¼‰æ˜¯Serialçš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚ å¤šçº¿ç¨‹å¹¶è¡Œæ”¶é›†ï¼Œå…¶ä½™ä¸Serialç›¸åŒ å¤šçº¿ç¨‹å¹¶è¡Œæ”¶é›†ï¼ˆç”¨æˆ·è¿›ç¨‹éœ€ç­‰å¾…ï¼‰ ç›®å‰å”¯ä¸€ä¸€ä¸ªèƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œ ä½¿ç”¨-XX:+UseConcMarkSweepGCå‚æ•°ï¼Œä½¿ç”¨ParNew+CMS+Serial Oldæ”¶é›†å™¨ç»„åˆï¼Œæ­¤æ—¶ParNewæ˜¯æ–°ç”Ÿä»£çš„é»˜è®¤æ”¶é›†å™¨ é»˜è®¤å¼€å¯çš„æ”¶é›†çº¿ç¨‹æ•°ä¸å¤„ç†å™¨æ ¸å¿ƒæ•°ç›¸åŒã€‚ å¯ä»¥ä½¿ç”¨-XX:ParallelGCThreadså‚æ•°é™åˆ¶çº¿ç¨‹æ•° å¯¹åƒåœ¾æ”¶é›†æ—¶ç³»ç»Ÿèµ„æºçš„é«˜æ•ˆåˆ©ç”¨å¾ˆæœ‰å¥½å¤„ã€‚ JDK9åå–æ¶ˆçš„ç»„åˆï¼š ParNew+CMS(æœªè¢«å–æ¶ˆï¼Œä½†ä¸æ¨èä½œä¸ºæœåŠ¡ç«¯æ¨¡å¼ä¸‹çš„æ”¶é›†å™¨ç»„åˆ) ParNew+Serial Old Serial+CMS å› æ­¤åªæœ‰ParNewå’ŒCMSå¯ä»¥ç»„åˆï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºParNewå¹¶å…¥äº†CMS ä¸‰ã€ Parallel Scanvengeï¼ˆæ–°ç”Ÿä»£ï¼‰1.åŸºäºæ ‡è®°-å¤åˆ¶ 2.å¹¶è¡Œæ”¶é›† 3.å…³æ³¨ååé‡ $ç”¨æˆ·ä»£ç æ—¶é—´/(ç”¨æˆ·ä»£ç æ—¶é—´+åƒåœ¾æ”¶é›†æ—¶é—´)$ é€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ç›¸å…³å‚æ•° -XX:MaxGCPauseMillis å¤§äº0çš„æ¯«ç§’æ•° æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ï¼ˆä»¥ç‰ºç‰²å¹´è½»ä»£å¤§å°ä¸ºä»£ä»·ï¼Œæ¯æ¬¡åœé¡¿æ—¶é—´çŸ­ï¼Œä½†å¯¼è‡´GCæ›´é¢‘ç¹ï¼Œé™ä½ååé‡ï¼‰ -XX:GCTimeRatio 0-100 æ•´æ•°ï¼šåƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡ï¼Œè¿™é‡ŒåŸä¹¦æ¦‚å¿µæœ‰ç‚¹ä¹±ä¸å¤ªå¥½ç†è§£ã€‚ ä½†åªè¦åªè¦å‚æ•°å€¼Næ˜¯é€šè¿‡å…¬å¼ï¼š 1/1+N æ¥è®¡ç®—åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡ï¼Œè€ŒNæœ¬èº«ä¸æ˜¯è¯¥æ¯”ç‡ å¦‚å‚æ•°ä¸º49æ—¶ï¼šååé‡=1-1/(1+49)=1-1/50 = 98% 1/50å°±æ˜¯åƒåœ¾æ”¶é›†æ—¶é—´çš„å æ¯” -XX:UseAdaptiveSizePolicy å¼€å¯è¯¥å‚æ•°ï¼Œä¸éœ€è¦æŒ‡å®šæ–°ç”Ÿä»£å¤§å°(-Xmn)ã€-XX:SurvivorRatioã€-XX:PretenureSizeThresholdç­‰å‚æ•°ï¼Œåªéœ€è¦æŒ‡å®šä¸€ä¸ªä¼˜åŒ–ç›®æ ‡ï¼šå¦‚æœ€å¤§å †-Xmxï¼Œä»¥åŠä¸Šé¢å‚æ•°1æˆ–2ï¼ŒæŒ‡å®šæ˜¯å…³æ³¨åœé¡¿æ—¶é—´è¿˜æ˜¯ååé‡ï¼Œç³»ç»Ÿä¼šåŠ¨æ€çš„è°ƒæ•´ç›¸å…³å‚æ•°ï¼Œæ­¤ç§°ä¸ºåƒåœ¾æ”¶é›†çš„è‡ªé€‚åº”çš„è°ƒèŠ‚ç­–ç•¥ å››ã€ Parallel Oldï¼ˆè€å¹´ä»£ï¼‰Parallel Scavengeçš„è€å¹´ä»£ç‰ˆæœ¬ å¤šçº¿ç¨‹å¹¶å‘æ”¶é›† åŸºäºæ ‡è®°æ•´ç† æ³¨é‡ååé‡ï¼ˆParallel Scanvenge + Parallel Old) äº”ã€ Serial Old(è€å¹´ä»£)Serialçš„è€å¹´ä»£ç‰ˆæœ¬ 1.å•çº¿ç¨‹ 2.æ ‡è®°æ•´ç† 3.åŒSerialä¾›å®¢æˆ·ç«¯æ¨¡å¼ä½¿ç”¨ 4.ä½œä¸ºCMSæ”¶é›†å™¨å¤±è´¥æ—¶çš„åå¤‡é¢„æ¡ˆ å·¥ä½œè¿‡ç¨‹å›¾å‚è€ƒä¸€ã€ Serialæ”¶é›†å™¨ å…­ã€ CMSï¼ˆè€å¹´ä»£ï¼‰å…³æ³¨åœé¡¿æ—¶é—´â€”&gt; B/Sç­‰æœåŠ¡ç«¯æ¨¡å¼ä¸­ç»™ç”¨æˆ·ç»™æ‹±è‰¯å¥½çš„äº¤äº’ä½“éªŒ è¿ä½œè¿‡ç¨‹1.åˆå§‹æ ‡è®° ï¼ˆInitial Markï¼‰ 2.å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰ 3.é‡æ–°æ ‡è®°ï¼ˆRemarkï¼‰ 4.å¹¶å‘æ¸…é™¤ï¼ˆConcurrent Sweepï¼‰ 1.åˆå§‹æ ‡è®°ï¼šæ ‡è®°ä¸GCRootsç›´æ¥å…³è”çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¿« 2.å¹¶å‘æ ‡è®°ï¼šä»GCRootsç›´æ¥å…³è”çš„å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾ï¼Œä¸æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä¸GCçº¿ç¨‹å¹¶å‘è¿è¡Œï¼Œè€—æ—¶é•¿ 3.é‡æ–°æ ‡è®°ï¼šä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·çº¿ç¨‹å¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„å¯¹è±¡ 4.å¹¶å‘æ¸…é™¤ï¼šåˆ é™¤æ‰è¢«æ ‡è®°æ­»äº¡çš„å¯¹è±¡ï¼Œå¯ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘è¿è¡Œ ç¼ºç‚¹ å¯¹CPUèµ„æºæ•æ„Ÿ CMSé»˜è®¤å¯åŠ¨çš„å›æ”¶çº¿ç¨‹æ•°æ˜¯ï¼ˆcpuæ•°é‡+3ï¼‰/4ã€‚æ‰€ä»¥CPUæ•°é‡å°‘ä¼šå¯¼è‡´ç”¨æˆ·ç¨‹åºæ‰§è¡Œé€Ÿåº¦é™ä½è¾ƒå¤šã€‚ æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ ä¸¤ä¸ªå¹¶å‘é˜¶æ®µå› ä¸ºç”¨æˆ·ç¨‹åºä»è¦æ‰§è¡Œï¼Œå› æ­¤ä¼šäº§ç”Ÿæ–°çš„åƒåœ¾å¯¹è±¡ï¼Œè€Œè¿™äº›å¯¹è±¡å› å‡ºç°åœ¨æ ‡è®°åï¼Œåªèƒ½åœ¨ä¸‹ä¸€æ¬¡GCæ—¶å›æ”¶ï¼Œè¿™äº›å°±æ˜¯æµ®åŠ¨åƒåœ¾ã€‚ CMSä¸èƒ½ç­‰åˆ°è€å¹´ä»£å¯¹è±¡æ»¡äº†æ‰è§¦å‘ã€‚ å‚æ•°-XX:CMSInitiatingOccupancyFractionï¼šè®¾ç½®CMSè§¦å‘çš„é˜ˆå€¼ï¼Œåœ¨jdk1.6ä¸­CMSé»˜è®¤å¯åŠ¨é˜ˆå€¼æå‡åˆ°äº†92%ã€‚ -XX:+UseCMSInitiatingOccupancyOnly ï¼šé»˜è®¤falseï¼Œå¦‚æœä¸ä½¿ç”¨ï¼Œåˆ™åªä¼šä½¿ç”¨ä¸€æ¬¡ä¸Šé¢è®¾ç½®çš„é˜ˆå€¼ï¼Œåé¢ä¼šè‡ªåŠ¨è°ƒæ•´ï¼›å¦‚æœä½¿ç”¨ï¼Œåˆ™å§‹ç»ˆä½¿ç”¨è®¾å®šçš„é˜ˆå€¼ã€‚ å¯ä»¥å°†è¿™ä¸¤ä¸ªå‚æ•°æ­é…ä½¿ç”¨ï¼š -XX:CMSInitiatingOccupancyFraction=70 -XX:UseCMSInitiatingOccupancyOnly=true CMSè¿è¡ŒæœŸé—´é¢„ç•™çš„å†…å­˜æ— æ³•æ»¡è¶³ç¨‹åºçš„éœ€è¦æ—¶ï¼Œä¼šå‡ºç°â€Concurrent Mode Failureâ€œ,ç„¶åä¼šä¸´æ—¶å¯ç”¨Serial Oldæ”¶é›†å™¨è¿›è¡Œè€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œè¿™æ ·åœé¡¿æ—¶é—´å°±å¾ˆé•¿äº†ï¼Œæ‰€ä»¥å‚æ•°å€¼è®¾ç½®å¤ªé«˜å®¹æ˜“å¯¼è‡´å¤§é‡â€Concurrent Mode Failureâ€œã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼š intx CMSInitiatingOccupancyFraction = -1 {product} è¯¥å‚æ•°çš„å€¼åœ¨jdk1.8ä¸­é»˜è®¤å€¼ä¸º-1ï¼Œè€Œ92%çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š 12345678910void ConcurrentMarkSweepGeneration::init_initiating_occupancy(intx io, uintx tr) { assert(io &lt;= 100 &amp;&amp; tr &lt;= 100, \"Check the arguments\"); if (io &gt;= 0) { _initiating_occupancy = (double)io / 100.0; } else { _initiating_occupancy = ((100 - MinHeapFreeRatio) + (double)(tr * MinHeapFreeRatio) / 100.0) / 100.0; }} å¦‚æœå‚æ•°å€¼å¤§äºç­‰äº0ï¼Œåˆ™å°±æŒ‰è¯¥ç™¾åˆ†æ¯”ä½œä¸ºå‚æ•° å¦‚æœå°äº0ï¼Œåˆ™æ ¹æ®MinHeapFreeRatioå’ŒtræŒ‰ä¸Šé¢å…¬å¼è®¡ç®—ï¼ŒMinHeapFreeRatioæ˜¯å †å¤§å°è¾¾åˆ°è¿™ä¸ªè¯¥ç™¾åˆ†æ¯”æ—¶ä¼šç¼©å°å †ï¼ˆ-Xms=-Xmxæ—¶æ— æ•ˆï¼‰ï¼Œtrå³CMSTriggerRatioï¼ŒæŸ¥çœ‹å¯çŸ¥è¿™ä¸¤ä¸ªå‚æ•°çš„é»˜è®¤å€¼ä¸ºï¼š 12uintx MinHeapFreeRatio = 40 {manageable}uintx CMSTriggerRatio = 80 {product} å› æ­¤å¾—å‡ºçš„è§¦å‘CMSçš„ç™¾åˆ†æ¯”ä¸ºï¼š((100-40)+(80*40)/100)/100=0.92=92% å­˜åœ¨ç©ºé—´ç¢ç‰‡ï¼Œå› ä¸ºåŸºäºæ ‡è®°-æ¸…é™¤ç®—æ³• -XX:+UseCMSCompactAtFullCollection ï¼šFullGCæ—¶è¿›è¡Œç¢ç‰‡æ•´ç†ï¼Œç‹¬å æ— æ³•å¹¶å‘ï¼Œä¼šä½¿åœé¡¿æ—¶é—´å˜é•¿ï¼ŒJDK9å¼€å§‹åºŸå¼ƒ -XX:+CMSFullGCsBeforeCompaction è®¾ç½®ç»è¿‡å‡ æ¬¡FullGCåè¿›è¡Œç¢ç‰‡æ•´ç† æ€»ç»“CMSè§¦å‘é˜ˆå€¼ä¸èƒ½å¤ªå¤§ï¼Œå¦åˆ™ä¼šé€ æˆå¹¶å‘å¤±æ•ˆï¼Œä¹Ÿä¸èƒ½å¤ªå°ï¼Œä¼šé€ æˆé¢‘ç¹è§¦å‘CMSï¼Œè€ŒCMSçš„åˆå§‹æ ‡è®°å’Œé‡æ–°æ ‡è®°ï¼ˆè€—æ—¶é•¿ï¼‰ä¼šé€ æˆStop The Worldï¼Œå¢å¤§åœé¡¿æ—¶é—´ï¼Œå¯è®¾ç½®ä¸º70 ä¸ƒã€ Garbage First(G1)1.é¢å‘æœåŠ¡ç«¯ï¼ˆJDK9å¼€å§‹ä½œä¸ºæœåŠ¡å™¨æ¨¡å¼ä¸‹çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ï¼ŒCMSåˆ™è¢«Deprecateï¼‰ 2.é¢å‘å †å†…å­˜ä»»ä½•éƒ¨åˆ†æ¥ç»„æˆå›æ”¶é›†ï¼ˆCSetï¼‰ï¼Œè¡¡é‡çš„æ ‡å‡†å˜ä¸ºå“ªå—å†…å­˜ä¸­å­˜æ”¾çš„åƒåœ¾æ•°é‡æœ€å¤šï¼Œå›æ”¶æ”¶ç›Šæœ€å¤§ G1å°†å †åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼Œæ¯ä¸ªregionéƒ½å¯ä»¥æ‰®æ¼”edenã€survivorå’Œè€å¹´ä»£ï¼Œæ”¶é›†å™¨èƒ½å¤Ÿé’ˆå¯¹ä¸åŒè§’è‰²çš„regioné‡‡å–ä¸åŒçš„ç­–ç•¥åŒºå¤„ç†ï¼Œregionæ˜¯å•æ¬¡å›æ”¶çš„æœ€å°å•å…ƒï¼Œå³æ¯æ¬¡å›æ”¶çš„å†…å­˜ç©ºé—´éƒ½æ˜¯regionçš„æ•´æ•°å€ Regionä¸­çš„Humongousï¼ˆå½“åšè€å¹´ä»£çœ‹å¾…ï¼‰åŒºåŸŸç”¨äºå­˜å‚¨å¤§å¯¹è±¡ï¼Œåªè¦è¶…è¿‡ä¸€ä¸ªregionå®¹é‡ä¸€åŠçš„å¯¹è±¡éƒ½å¯ä»¥ç§°ä¸ºå¤§å¯¹è±¡ å‚æ•°-XX:G1HeapRegionSizeå‚æ•°å¯ä»¥æŒ‡å®šæ¯ä¸ªregionå¤§å°ï¼ŒèŒƒå›´ï¼š1M~32Mé—´çš„2çš„å¹‚æ¬¡æ•° è¶…è¿‡æ•´ä¸ªregionçš„è¶…å¤§å¯¹è±¡è¢«æ”¾äºè¿ç»­çš„Homongousä¸­ G1æŒ‰ç…§å„ä¸ªregionåƒåœ¾çš„ä»·å€¼ï¼ˆå³å›æ”¶è·å¾—çš„ç©ºé—´ä¸æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ï¼Œä¾æ®ç”¨æˆ·è®¾ç½®çš„åœé¡¿æ—¶é—´ä¼˜å…ˆå›æ”¶ä»·å€¼å¤§çš„region å‡ ä¸ªé—®é¢˜ G1ä½¿ç”¨è®°å¿†é›†é¿å…æ•´å †æ‰«æ å¹¶å‘æ ‡è®°é˜¶æ®µä¿è¯æ”¶é›†çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹äº’ä¸å¹²æ‰°çš„æ–¹å¼ï¼š G1é€šè¿‡åŸå§‹å¿«ç…§æ–¹å¼ä¿è¯ç”¨æˆ·çº¿ç¨‹æ”¹å˜å¼•ç”¨å…³ç³»æ—¶ï¼ŒåŸæœ¬çš„å¯¹è±¡å›¾ç»“æ„ä¸è¢«ç ´åï¼Œä¿è¯æ ‡è®°çš„æ­£ç¡®æ€§ã€‚å‚è€ƒä¸Šæ–‡4.6ï¼ˆåŸå§‹å¿«ç…§ï¼‰ G1ä¸ºæ¯ä¸ªregionè®¾è®¡äº†ä¸¤ä¸ªTAMSï¼ˆTop At Mark Startï¼‰æŒ‡é’ˆ åˆ’åˆ†ä¸€éƒ¨åˆ†ç©ºé—´ç”¨äºå¹¶å‘å›æ”¶æ—¶äº§ç”Ÿçš„æ–°å¯¹è±¡çš„åˆ†é… æ–°å¯¹è±¡åœ°å€å¿…é¡»åœ¨ä¸¤ä¸ªæŒ‡é’ˆä½ç½®ä»¥ä¸Š G1é»˜è®¤åœ¨è¯¥åœ°å€ä»¥ä¸Šçš„å¯¹è±¡æ˜¯å­˜æ´»çš„ å½“åˆ†é…å¯¹è±¡çš„é€Ÿåº¦è¶…è¿‡å›æ”¶é€Ÿåº¦æ—¶ï¼Œå†»ç»“ç”¨æˆ·çº¿ç¨‹ï¼Œäº§ç”ŸFull GC è¿è¡Œè¿‡ç¨‹ åˆå§‹æ ‡è®° æ ‡è®°GCRootsç›´æ¥å…³è”çš„å¯¹è±¡ï¼Œä¿®æ”¹TAMSæŒ‡é’ˆå€¼ï¼Œè®©ä¸‹ä¸ªé˜¶æ®µç”¨æˆ·è¿›ç¨‹å¹¶å‘è¿è¡Œæ—¶ï¼Œèƒ½å¤Ÿåœ¨å¯ç”¨çš„regionä¸­åˆ†é…æ–°å¯¹è±¡ã€‚åŒå‰é¢ä¸€æ ·ï¼Œéœ€è¦STWï¼Œä½†è€—æ—¶å¾ˆçŸ­ï¼Œä¸”æ˜¯å€ŸåŠ©MinorGCæ—¶åŒæ­¥å®Œæˆï¼Œå› æ­¤G1åœ¨è¯¥é˜¶æ®µä¸éœ€è¦é¢å¤–çš„åœé¡¿ã€‚ å¹¶å‘æ ‡è®° ä»GCRootsç›´æ¥å…³è”çš„å¯¹è±¡å¯¹å¯¹è±¡å›¾åšå¯è¾¾æ€§åˆ†æï¼Œæ‰¾å‡ºå›æ”¶å¯¹è±¡ï¼Œè€—æ—¶é•¿ã€‚ å¯ä¸ç”¨æˆ·è¿›ç¨‹å¹¶å‘æ‰§è¡Œï¼Œæ‰«æå®Œæˆåï¼Œéœ€é‡æ–°å¤„ç†SATBï¼ˆåŸå§‹å¿«ç…§ï¼‰è®°å½•ä¸‹çš„å¹¶å‘æ—¶å¼•ç”¨å˜åŠ¨çš„å¯¹è±¡ã€‚ æœ€ç»ˆæ ‡è®° å¯¹ç”¨æˆ·çº¿ç¨‹ä½œå¦ä¸€ä¸ªçŸ­æš‚æš‚åœï¼Œç”¨äºå¤„ç†å¹¶å‘é˜¶æ®µç»“æŸåé—ç•™ä¸‹çš„å°‘é‡SATBè®°å½•ã€‚ ç­›é€‰å›æ”¶ æ›´æ–°regionçš„ç»Ÿè®¡æ•°æ® å¯¹æ‰€æœ‰regionæŒ‰ç…§å›æ”¶ä»·å€¼å’Œæˆæœ¬æ’åº æ ¹æ®ç”¨æˆ·è®¾å®šçš„åœé¡¿æ—¶é—´åˆ¶å®šå›æ”¶è®¡åˆ’ è‡ªç”±é€‰æ‹©å¤šä¸ªregionä½œä¸ºå›æ”¶é›†ï¼Œå°†å†³å®šå›æ”¶çš„regionçš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ªç©ºçš„regionï¼Œå†æ¸…ç†æ•´ä¸ªæ—§region éœ€æš‚åœç”¨æˆ·è¿›ç¨‹ï¼Œå¯å¤šæ¡æ”¶é›†å™¨å¹¶è¡Œæ‰§è¡Œã€‚ æ›´æ–°-&gt;æ’åº-&gt;åˆ¶å®šå›æ”¶è®¡åˆ’-&gt;é€‰æ‹©å›æ”¶é›†-&gt;å¤åˆ¶æ¸…ç†(å¹¶è¡Œã€STW) é™¤äº†å¹¶å‘æ ‡è®°ï¼Œéƒ½éœ€è¦åœæ­¢ç”¨æˆ·è¿›ç¨‹ã€‚ ç¤ºæ„å›¾å¦‚ä¸‹ï¼š ç‰¹è‰²å’Œä¼˜ç‚¹ï¼š å»¶è¿Ÿå¯æ§æƒ…å†µä¸‹è·å¾—å°½å¯èƒ½é«˜çš„ååé‡ã€‚ ç”¨æˆ·å¯æŒ‡å®šæœŸæœ›ï¼ˆè¦ç¬¦åˆå®é™…ï¼‰çš„åœé¡¿æ—¶é—´ é»˜è®¤ä¸º200msï¼Œä¸èƒ½å¤ªä½ï¼Œå¤ªä½ä¼šé€ æˆæ¯æ¬¡é€‰æ‹©çš„å›æ”¶é›†åªå å †çš„å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œå›æ”¶é€Ÿåº¦è·Ÿä¸ä¸Šåˆ†é…é€Ÿåº¦ï¼Œå¯¼è‡´Full GC åˆ†åŒºï¼ˆregionï¼‰ç®¡ç†å †å†…å­˜ æŒ‰å›æ”¶æ•ˆç›Šç¡®å®šå›æ”¶é›† æ•´ä½“åŸºäºæ ‡è®°-æ•´ç†ï¼Œå±€éƒ¨åŸºäºæ ‡è®°-å¤åˆ¶ï¼Œä¸ä¼šäº§ç”Ÿç¢ç‰‡ ç¼ºç‚¹ï¼ˆä¸CMSæ¯”ï¼‰ å†…å­˜å ç”¨ å› ä¸ºæ¯ä¸ªregionéƒ½éœ€è¦ç»´æŠ¤ä¸€ä¸ªå¡è¡¨è§£å†³è·¨ä»£å¼•ç”¨é—®é¢˜ï¼Œè®°å¿†é›†å¯èƒ½å æ•´å †çš„20%ä»¥ä¸Šã€‚CMSåˆ™åªæœ‰ä¸€ä»½å¡è¡¨ã€‚ é¢å¤–æ‰§è¡Œè´Ÿè½½é«˜ å’ŒCMSä¸€æ ·éƒ½ä½¿ç”¨å†™å±éšœç»´æŠ¤å¡è¡¨ã€‚ é™¤äº†å’ŒCMSä¸€æ ·ä½¿ç”¨å†™åå±éšœå¤–ï¼ˆç›´æ¥ä½¿ç”¨åŒæ­¥ï¼‰ï¼ŒG1è¿˜éœ€è¦å†™å‰å±éšœå®ç°åŸå§‹å¿«ç…§ç®—æ³•ï¼Œäº§ç”Ÿé¢å¤–è´Ÿæ‹…ã€‚ï¼ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ å°å†…å­˜åº”ç”¨CMSè¡¨ç°å¤§æ¦‚ç‡ç”±äºG1 ====================================================================== å…¶ä»–ç›¸å…³ç¬”è®°ï¼š JVMç¬”è®°ï¼ˆä¸€ï¼‰javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºä»¥åŠå¯¹è±¡çš„åˆ›å»ºã€å¸ƒå±€å’Œå®šä½JVMç¬”è®°ï¼ˆäºŒï¼‰å¯¹è±¡çš„ç”Ÿæ­»ä¸javaçš„å››å¤§å¼•ç”¨JVMç¬”è®°ï¼ˆä¸‰ï¼‰åƒåœ¾æ”¶é›†ç®—æ³•ä»¥åŠHotSpotçš„ç®—æ³•å®ç°(å®‰å…¨ç‚¹ã€è®°å¿†é›†ä¸å¡è¡¨ã€å†™å±éšœã€ä¸‰è‰²æ ‡è®°ç­‰)================================================================ å‚è€ƒï¼šã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœºç¬¬ä¸‰ç‰ˆã€‹","link":"/posts/20200316-jvm-garbage-collector.html"},{"title":"JVMç¬”è®°ï¼ˆä¸€ï¼‰javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºä»¥åŠå¯¹è±¡çš„åˆ›å»ºã€å¸ƒå±€å’Œå®šä½","text":"JVMä½“ç³»ç»“æ„å›¾ ä¸€ã€æ–¹æ³•åŒº1.æ˜¯çº¿ç¨‹é—´å…±äº«çš„å†…å­˜åŒºåŸŸ 2.å­˜å‚¨äº†è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç±»çš„ç±»å‹ã€ä¿®é¥°ç¬¦ã€æ–¹æ³•ä¿¡æ¯ã€å­—æ®µä¿¡æ¯ï¼‰ã€ç±»çš„é™æ€å˜é‡ã€finalç±»å‹çš„å¸¸é‡ã€ç±»ä¸­çš„å­—æ®µã€æ–¹æ³•æ•°æ®ä¿¡æ¯ã€æ„é€ å‡½æ•°ã€ä»¥åŠç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç å†…å®¹ç­‰ ä½†æ˜¯ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªè§„èŒƒï¼Œåœ¨ä¸åŒè™šæ‹Ÿæœºé‡Œå®ç°æ˜¯ä¸ä¸€æ ·çš„ã€‚ å¦‚ï¼šList list=new ArrayList(); Listå°±æ˜¯è§„èŒƒï¼ŒArrayListå¯¹åº”ä¸åŒçš„è™šæ‹Ÿæœºçš„ä¸åŒå®ç°ã€‚ å…¸å‹çš„ä¸¤ç§å°±æ˜¯â€æ°¸ä¹…ä»£â€œ(JDK8ä»¥å‰)å’Œâ€å…ƒç©ºé—´â€œï¼ˆJDK8åŠä»¥åï¼‰ å®ä¾‹å˜é‡å­˜å‚¨åœ¨å †ä¸­ï¼Œä¸æ–¹æ³•åŒºæ— å…³ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚ç”¨äºå­˜æ”¾ç¼–è¯‘æ—¶äº§ç”Ÿçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚ é¡¾åæ€ä¹‰ï¼Œè¿è¡Œæ—¶äº§ç”Ÿçš„å¸¸é‡è‡ªç„¶ä¹Ÿä¼šå­˜å‚¨åœ¨è¿™é‡Œï¼ˆåŠ¨æ€æ€§ï¼‰ã€‚ å¦‚Stringçš„intern()æ–¹æ³•ï¼Œå¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤Stringå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œåˆ™ä¼šè¿”å›è¯¥å¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå¦åˆ™ä¼šå°†è¯¥Stringå¯¹è±¡åŒ…å«çš„å­—ç¬¦ä¸²æ·»åŠ åˆ°å¸¸é‡æ± ä¸­ã€‚ æµ‹è¯•ï¼š 123456789public static void main(String[] args) { String sb=new StringBuilder(\"å“ˆå“ˆ\").append(\"å˜¿å˜¿\").toString(); System.out.println(sb.intern()==sb);//true String sb2=new StringBuilder(\"ja\").append(\"va\").toString(); //javaåœ¨Versionç±»ä¸­å·²ç»å‡ºç°ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å·²ç»æœ‰å®ƒçš„å¼•ç”¨ï¼Œå› æ­¤è¿”å›false System.out.println(sb2.intern()==sb2);//false } å¦‚ä¸‹ï¼š 123456package sun.misc;public class Version { private static final String launcher_name = \"java\"; private static final String java_version = \"1.8.0_231\"; ..............................} è¯¥ç±»åœ¨å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)ä¸­è¢«åŠ è½½ï¼Œä½äºrt.jar\\sun\\miscä¸­ï¼š å¼‚å¸¸æƒ…å†µæ–¹æ³•åŒºæ— æ³•æ»¡è¶³æ–°çš„å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± ç”³è¯·ä¸åˆ°å†…å­˜æ—¶ï¼Œä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚ äºŒã€æ ˆæ ˆè´Ÿè´£è¿è¡Œï¼ˆå †è´Ÿè´£å­˜å‚¨ï¼‰ 1.çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸çº¿ç¨‹åŒç”Ÿå‘½å‘¨æœŸï¼Œä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜ 2.æ¯ä¸ªæ–¹æ³•æ‰§è¡Œä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ä¿å­˜åœ¨æ ˆçš„é¡¶éƒ¨ï¼Œæ¯ä¸ªæ–¹æ³•ä»è°ƒç”¨åˆ°æ‰§è¡Œå®Œæ¯•å¯¹åº”ä¸€ä¸ªæ ˆå¸§ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚ å¦‚ä¸‹ï¼š 1234567891011121314public static void m1(){ System.out.println(\"m1..begin\"); m2(); System.out.println(\"m1..end\"); } public static void m2(){ System.out.println(\"m2\"); } public static void main(String[] args) { System.out.println(\"main...begin\"); m1(); System.out.println(\"main...end\"); } å¯¹åº”çš„æ ˆæ¨¡å‹å¦‚ä¸‹ï¼š | | | m2() | | m1() | | main() | 3.æ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥å’Œæ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚ æ ˆï¼ˆæˆ–è€…è¯´æ˜¯å±€éƒ¨å˜é‡è¡¨éƒ¨åˆ†ï¼‰ä¿å­˜çš„ä¿¡æ¯å¦‚ä¸‹ï¼š 8ç§åŸºæœ¬ç±»å‹å˜é‡+å¯¹è±¡å¼•ç”¨å˜é‡+å®ä¾‹æ–¹æ³• å±€éƒ¨å˜é‡è¡¨ï¼šå­˜å‚¨æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ï¼ˆæ–¹æ³•ä¸­å£°æ˜çš„éé™æ€å˜é‡ï¼Œå…¥å‚å’Œå‡ºå‚ç­‰ï¼‰ã€‚8ç§åŸºæœ¬ç±»å‹å˜é‡ç›´æ¥å­˜å‚¨å¯¹åº”çš„å€¼ï¼Œè€Œå¯¹è±¡å¼•ç”¨å˜é‡å­˜å‚¨æŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œæˆ–æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–ä¸å¯¹è±¡ç›¸å…³çš„ä½ç½®) æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„å¼•ç”¨ï¼šå½“æˆ‘ä»¬åœ¨æ–¹æ³•ä¸­ç”¨åˆ°ç±»ä¸­çš„å¸¸é‡æ—¶ï¼Œå°±éœ€è¦ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„å¼•ç”¨ã€‚ æ“ä½œæ•°æ ˆï¼šè®°å½•æ–¹æ³•ä¸­æ‰€æœ‰è®¡ç®—ç›¸å…³çš„å‡ºæ ˆã€å…¥æ ˆçš„æ“ä½œ æ–¹æ³•å‡ºå£ï¼šå³æ–¹æ³•ç»“æŸåï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¹‹å‰è°ƒç”¨å®ƒçš„åœ°æ–¹ï¼Œå› æ­¤éœ€è¦ä¿å­˜ä¸€ä¸ªæ–¹æ³•è¿”å›çš„åœ°å€ã€‚ æ ˆçš„ç›¸å…³å¼‚å¸¸1.çº¿ç¨‹è¯·æ±‚çš„æ ˆçš„å¤§å°å¤§äºè™šæ‹Ÿæœºå…è®¸çš„å¤§å°ï¼Œä¼šå‡ºç°StackOverflowErroré”™è¯¯ã€‚ 2.æ ˆç”³è¯·åŠ¨æ€æ‰©å±•æ— æ³•è·å–åˆ°è¶³å¤Ÿå†…å­˜æ—¶ä¼šå‡ºç°OOMå¼‚å¸¸ã€‚ï¼ˆç›®å‰çš„HotSpotè™šæ‹Ÿæœºä¸å¯ä»¥è¿›è¡ŒåŠ¨æ€æ‰©å±•ï¼Œå› æ­¤çº¿ç¨‹ç”³è¯·æ ˆç©ºé—´æˆåŠŸåå°±ä¸€å®šä¸ä¼šå‡ºç°OOMå¼‚å¸¸ï¼Œä½†ç”³è¯·å¤±è´¥ä»ä¼šå‡ºç°OOMï¼‰ã€‚ æ ˆå¼‚å¸¸æµ‹è¯•ï¼šé’ˆå¯¹æƒ…å†µä¸€ï¼Œå¯ä»¥å°†æ ˆçš„å¤§å°è°ƒå°ï¼š å‡ºç°StackOverflowError 1234567891011121314151617181920public class VMStackSOF { private static int stackLength = 0; //-Xss150k å‡å°‘æ ˆå†…å­˜å®¹é‡ StackOverFlow public void stackLeak() { stackLength++; stackLeak(); } public static void main(String[] args) { VMStackSOF oom=new VMStackSOF(); try { oom.stackLeak(); }catch (Throwable e){ System.out.println(\"æ ˆé•¿åº¦:\"+oom.stackLength); throw e; } }} æˆ–æ˜¯å°†æ–¹æ³•å¸§çš„æœ¬åœ°å˜é‡è¡¨å˜åœ°è¶…å¤§ï¼š 123456789101112131415161718192021222324public class VMStackSOF { private static int stackLength = 0; //å¢å¤§æ–¹æ³•å¸§ä¸­æœ¬åœ°å˜é‡è¡¨çš„é•¿åº¦ StackOverFlowError public static void test() { long a1,.......a100;//100ä¸ªå±€éƒ¨å˜é‡ stackLength++; test(); a1 =a2=.....a100; } public static void main(String[] args) { VMStackSOF oom=new VMStackSOF(); try { test(); }catch (Error a){ System.out.println(\"é•¿åº¦\"+stackLength); throw a; } }} ä¸‰ã€å †1.ä¸ºçº¿ç¨‹é—´å…±äº«ï¼Œè™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»º 2.ç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„ 3.æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„å†…å­˜åŒºåŸŸï¼Œä¹Ÿç§°ä¸ºâ€œGCå †â€ã€‚ ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéšç€å³ä½¿ç¼–è¯‘æŠ€æœ¯çš„è¿›æ­¥ï¼Œå°¤å…¶æ˜¯é€ƒé€¸åˆ†ææŠ€æœ¯çš„æ—¥æ¸å¼ºå¤§ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ ˆä¸Šåˆ†é…ä»¥åŠTLABã€‚ è¿™é‡Œå¯ä»¥æ‰©å±•ä¸‹ï¼š å…³äºæ ˆä¸Šåˆ†é…ï¼š æœ‰å¾ˆå¤šå¯¹è±¡çš„ä½œç”¨äºå¹¶ä¸ä¼šé€ƒé€¸å‡ºæ–¹æ³•å¤–ï¼Œè€Œå¦‚æœåœ¨å †ä¸Šåˆ›å»ºï¼Œåˆ™å½“æ–¹æ³•çš„è°ƒç”¨ç»“æŸåï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿéšä¹‹ç»“æŸï¼Œåˆ™ç›¸åº”åœ°æŒ‡å‘å †ä¸­è¯¥å¯¹è±¡çš„å¼•ç”¨ä¹Ÿå°±æ²¡æœ‰äº†ï¼ŒGCå°±ä¼šå»å›æ”¶è¯¥å¯¹è±¡ï¼Œè‹¥è¿™ç§å¯¹è±¡éå¸¸å¤šï¼Œå°±ä¼šå¢åŠ GCçš„å‹åŠ›ã€‚ æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å°†è¿™ç±»å¯¹è±¡å±æ€§æ‰“æ•£ååˆ†é…åœ¨æ ˆä¸­ï¼Œè¿™æ ·æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œæ ˆç©ºé—´çš„å›æ”¶å°±ä¼šå°†æ‰“æ•£åçš„å¯¹è±¡å›æ”¶æ‰ã€‚è¿™æ ·å°±é¿å…äº†ç»™GCå¢åŠ å‹åŠ›ï¼Œæé«˜æ€§èƒ½ã€‚ å…³äºTLAB: ç”±äºå †æ˜¯å…¨å±€å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œè€Œåˆ›å»ºå¯¹è±¡åˆæ˜¯éå¸¸é¢‘ç¹çš„è¡Œä¸ºï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹å¹¶å‘ç»™å¯¹è±¡åˆ†é…å†…å­˜æ—¶å°±éœ€è¦è¿›è¡ŒåŒæ­¥ï¼ˆjvmé‡‡ç”¨çš„æ˜¯CASå¤±è´¥é‡è¯•çš„æ–¹å¼ä¿è¯åŸå­æ€§çš„ï¼‰ï¼Œè€Œè¿™ä¸ªå¼€é”€åœ¨æŸäº›æƒ…å†µæ˜¯éå¸¸å¤§çš„ã€‚ è€ŒTLAB(Thread Local Allocation Buffer)å°±æ˜¯åœ¨å †ä¸­åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒºï¼Œå°±å¯ä»¥è®©çº¿ç¨‹åˆ†é…å †ç©ºé—´æ—¶å…ˆåˆ†é…åˆ°è‡ªå·±æ‰€å±çš„ç¼“å†²åŒºï¼Œé¿å…åŒæ­¥å¸¦æ¥çš„å¼€é”€ï¼Œä»¥æé«˜å¯¹è±¡åˆ†é…çš„æ•ˆç‡ã€‚ï¼ˆjvmé»˜è®¤å¼€å¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨-XX: +UseTLAB æ˜¾ç¤ºå¼€å¯ï¼‰ï¼Œä½†å½“å¯¹è±¡è¿‡å¤§æ—¶ä»ç„¶ç›´æ¥åœ¨å †ä¸Šåˆ†é…ç©ºé—´ã€‚ ä½¿ç”¨-XX:+PrintTLAB å‚æ•°æ‰“å¼€è·Ÿè¸ªTLABçš„ä½¿ç”¨æƒ…å†µï¼Œ ä½¿ç”¨-XX:TLABSize é€šè¿‡è¯¥å‚æ•°æŒ‡å®šåˆ†é…ç»™æ¯ä¸€ä¸ªçº¿ç¨‹çš„TLABç©ºé—´çš„å¤§å° å †ç©ºé—´çš„æ„æˆå †ç”±è€å¹´ä»£å’Œå¹´è½»ä»£æ„æˆï¼Œè€Œå¹´è½»ä»£åˆåˆ†ä¸ºedenåŒºå’Œä¸¤ä¸ªsurvivoråŒºï¼ˆfrom Space and To Space)ã€‚ å¯¹è±¡é¦–å…ˆé…åˆ†é…åˆ°å¹´è½»ä»£çš„edenåŒºï¼Œä½†å¦‚æœå¯¹è±¡å¤§äºedenåŒºå°äºè€å¹´åŒºï¼Œåˆ™ç›´æ¥ä¸¢åœ¨è€å¹´åŒºï¼Œå¦‚æœæ¯”è€å¹´ä»£è¿˜å¤§ï¼Œåˆ™æŠ›å‡ºOOMå¼‚å¸¸ã€‚ åœ¨survivoråŒºç»è¿‡å¤šæ¬¡GCä»ç„¶å­˜æ´»çš„å¯¹è±¡ï¼Œè¢«è½¬ç§»åˆ°è€å¹´åŒºã€‚ å †çš„å¤§å°è®¾å®šé€šè¿‡ -Xms æœ€å°å€¼ å’Œ -Xmxæœ€å¤§å€¼æ§åˆ¶å †çš„å¤§å°ã€‚ å½“ -Xmså’Œ-Xmxç›¸åŒæ—¶ï¼Œå †æ˜¯å›ºå®šå¤§å°ä¸å¯è‡ªåŠ¨æ‰©å±•çš„ï¼Œå¦åˆ™æ˜¯èƒ½å¤Ÿè‡ªåŠ¨æ‰©å±•çš„ å¼‚å¸¸å½“å †ä¸­å†…å­˜ä¸è¶³ä»¥åˆ†é…å¯¹è±¡ç©ºé—´ä¸”å †ä¹Ÿæ— æ³•æ‰©å±•æ—¶ï¼Œä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚ å¼‚å¸¸æµ‹è¯•é€šè¿‡ä»¥ä¸Šä¸¤ä¸ªå‚æ•°å°†å †å¤§å°æ§åˆ¶åœ¨10MBï¼Œå†åŠ ä¸Š-XX:+HeapDumpOnOutOfMemoryErrorå‚æ•°ä½¿å¾—åœ¨å‡ºç°OOMæ—¶ï¼Œdumpå‡ºå½“å‰çš„å†…å­˜å †è½¬å‚¨å¿«ç…§ã€‚ 12345678910111213141516171819202122public class HeapOOM { static class OOM{ } /** * -Xms10m -Xmx10m -XX:+HeapDumpOnOutOfMemoryError * -XX:+HeapDumpOnOutOfMemoryError è®©è™šæ‹Ÿæœºåœ¨å‡ºç°å†…å­˜æº¢å‡ºå¼‚å¸¸æ—¶Dumpå‡ºå½“å‰çš„å†…å­˜å †è½¬å‚¨å¿«ç…§ * @param args */ public static void main(String[] args) { /* java.lang.OutOfMemoryError: Java heap space Dumping heap to java_pid9368.hprof ... Heap dump file created [28275886 bytes in 0.140 secs] */ List&lt;OOM&gt; list=new ArrayList&lt;&gt;(); while (true){ list.add(new OOM()); } }} æˆ‘ä»¬ä½¿ç”¨IDEAé›†æˆçš„æ’ä»¶jprofilerè¿è¡Œï¼Œæ‰“å¼€å¾—åˆ°çš„å †è½¬å‚¨å¿«ç…§ï¼Œå¯ä»¥è¿…é€Ÿæ‰¾å‡ºå¼‚å¸¸ä½ç½®ã€‚ å››ã€ç¨‹åºè®¡æ•°å™¨å¯ä»¥çœ‹åšæ˜¯å½“å‰çº¿ç¨‹é”æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ï¼Œå­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚ ç”±äºåœ¨javaè™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢ã€åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåœ¨ä»»ä½•æ—¶åˆ»ä¸€ä¸ªå¤„ç†å™¨éƒ½åªä¼šæ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ä¸­çš„æŒ‡ä»¤ã€‚ å› æ­¤ä¸ºäº†åˆ‡æ¢çº¿ç¨‹åèƒ½æ¢å¤åˆ°åˆ‡æ¢å‰çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œäº’ä¸å¹²æ‰°ï¼Œç‹¬ç«‹å­˜å‚¨ã€‚ å› æ­¤ç¨‹åºè®¡æ•°å™¨æ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚ å¦‚æœæ‰§è¡Œçš„æ˜¯ä¸€ä¸ªjavaæ–¹æ³•ï¼Œåˆ™è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç çš„æŒ‡ä»¤åœ°å€ã€‚ å¦‚æœæ‰§è¡Œçš„æ˜¯æœ¬åœ°nativeæ–¹æ³•ï¼Œåˆ™è®¡æ•°å™¨å€¼ä¸ºundefinedã€‚ ä¸ä¼šå‘ç”ŸOOMå¼‚å¸¸ äº”ã€æœ¬åœ°æ–¹æ³•æ ˆåŒjavaæ ˆä½œç”¨åŸºæœ¬ä¸€æ ·ï¼Œä½†æ˜¯æœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä¸ºäº†æ”¯æŒæœ¬åœ°nativeæ–¹æ³•ï¼Œè€Œæ ˆæ˜¯ä¸ºjavaæ–¹æ³•æœåŠ¡ã€‚ å¼‚å¸¸å‡ºç°æƒ…å†µåŒæ ˆç›¸åŒã€‚ å…­ã€å¯¹è±¡çš„åˆ›å»ºè¿™é‡Œåªè®¨è®ºæ™®é€šjavaå¯¹è±¡ï¼Œä¸åŒ…æ‹¬æ•°ç»„å’ŒClasså¯¹è±¡ã€‚ å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤æ—¶ï¼š 1.newæŒ‡ä»¤æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°æ˜¯å¦èƒ½åœ¨å¸¸é‡æ± ä¸­å®šä½åˆ°ä¸€ä¸ªç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆé¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹ã€‚ 2.åˆ†é…å†…å­˜å¯¹è±¡æ‰€éœ€å†…å­˜å¤§å°åœ¨ç±»åˆå§‹åŒ–å®Œæˆåå¯ä»¥å®Œå…¨ç¡®å®šã€‚ åˆ†é…å†…å­˜çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š a.æŒ‡é’ˆç¢°æ’ï¼ˆBump The Pointerï¼‰ å †å†…å­˜æ˜¯è§„æ•´çš„æ—¶å€™ï¼Œä¸€è¾¹æ˜¯ä½¿ç”¨è¿‡çš„å†…å­˜ï¼Œä¸€è¾¹æ˜¯ç©ºé—²çš„å†…å­˜ï¼Œä¸­é—´ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºæŒ‡ç¤ºå™¨ï¼Œåˆ†é…å†…é…å°±æ˜¯å°†æŒ‡é’ˆå‘ç©ºé—²çš„ä¸€è¾¹ç§»åŠ¨å’Œå¯¹è±¡å¤§å°ç›¸åŒçš„è·ç¦»ã€‚ b.ç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰ å †å†…å­˜ä¸æ˜¯è§„æ•´çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºç»´æŠ¤ä¸€å¼ åˆ—è¡¨ï¼Œè®°å½•äº†å“ªäº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œåˆ†é…å†…å­˜å°±æ˜¯ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨å†…å®¹ã€‚ åˆ†é…æ–¹å¼ç”±å †æ˜¯å¦è§„æ•´å†³å®šï¼Œå †æ˜¯å¦è§„æ•´ç”±åƒåœ¾æ”¶é›†å™¨æ˜¯å¦èƒ½å¤Ÿè¿›è¡Œç©ºé—´å‹ç¼©æ•´ç†å†³å®šã€‚ 3.åˆå§‹åŒ–å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰åˆå§‹åŒ–ä¸ºé›¶å€¼ã€‚ï¼ˆTLABæ–¹å¼å¯æå‰è‡³TLABåˆ†é…æ—¶è¿›è¡Œï¼‰ä¿è¯å¯¹è±¡å®ä¾‹å­—æ®µä¸èµ‹åˆå§‹å€¼å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ 4.å¯¹è±¡çš„åˆå§‹è®¾ç½®å¦‚ï¼šå¯¹è±¡æ˜¯å“ªä¸ªå®ä¾‹ã€å¦‚ä½•æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œç ã€GCåˆ†ä»£å¹´é¾„ç­‰ã€‚ ä»¥ä¸Šä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡å¤´ï¼ˆObject Headerï¼‰ä¸­ã€‚æ ¹æ®è™šæ‹Ÿæœºå½“å‰çš„è¿è¡ŒçŠ¶æ€çš„ä¸åŒï¼Œå¦‚å¯¹å¦å¯ç”¨åå‘é”ç­‰ï¼Œå¯¹è±¡å¤´ä¼šæœ‰ä¸åŒçš„è®¾ç½®æ–¹å¼ã€‚ 5. &lt;init&gt;()æ–¹æ³•newæŒ‡ä»¤ä¼šæ¥ç€æ‰§è¡ŒClassæ–‡ä»¶çš„initæ–¹æ³•ï¼Œå³æ„é€ å‡½æ•°ï¼Œæ¥å°†å¯¹è±¡çš„å…¶ä»–èµ„æºå’ŒçŠ¶æ€ä¿¡æ¯æ„é€ å¥½ã€‚æ­¤æ—¶æ‰ç®—æ˜¯æ„é€ ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡ã€‚ ä¸ƒã€å¯¹è±¡çš„å†…å­˜å¸ƒå±€åœ¨HotSpotä¸­ï¼Œå¯¹è±¡åœ¨å †å†…å­˜ä¸­çš„å­˜å‚¨å¸ƒå±€å¯åˆ’åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š å¯¹è±¡å¤´ï¼ˆHeaderï¼‰ã€å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰å’Œå¯¹é½å¡«å……ï¼ˆPaddingï¼‰ 7.1 å¯¹è±¡å¤´ä¸»è¦åˆ†ä¸ºä¸¤ç±»ä¿¡æ¯ï¼š ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ® å“ˆå¸Œç ã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ã€‚ ç±»å‹æŒ‡é’ˆ å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å‹å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆç¡®å®šå¯¹è±¡æ—¶å“ªä¸ªç±»çš„å®ä¾‹ã€‚ï¼ˆä½†æŸ¥æ‰¾å¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯å¹¶éä¸€å®šè¦ç»è¿‡å¯¹è±¡æœ¬èº«ï¼‰ã€‚ å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªjavaæ•°ç»„ï¼Œåˆ™å¯¹è±¡å¤´è¿˜éœ€è¦æœ‰ä¸€å—è®°å½•æ•°ç»„çš„é•¿åº¦ã€‚ 7.2 å®ä¾‹æ•°æ®å­˜å‚¨äº†å¯¹è±¡çš„æœ‰æ•ˆä¿¡æ¯ã€‚å³åœ¨ä»£ç ä¸­å®šä¹‰çš„å„ç§ç±»å‹çš„å­—æ®µå†…å®¹ï¼ˆçˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„å’Œå­ç±»çš„éƒ½ä¼šè®°å½•ä¸‹æ¥ï¼‰ã€‚ å­˜å‚¨é¡ºåºå—è™šæ‹Ÿæœºåˆ†é…ç­–ç•¥å‚æ•° -XX:FieldsAllocationStyle å’Œå­—æ®µå®šä¹‰é¡ºåºå½±å“ã€‚ é»˜è®¤çš„åˆ†é…é¡ºåºä¸ºï¼š longs/doublesã€intsã€shorts/chartsã€bytes/booleansã€oops(Ordinary Object Pointers)ï¼Œå¯ä»¥çœ‹åˆ°ç›¸åŒå®½åº¦çš„å­—æ®µæ€»æ˜¯è¢«åˆ†é…åˆ°ä¸€èµ·å­˜æ”¾ã€‚ 7.3 å¯¹é½å¡«å……è™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œå³å¯¹è±¡çš„å¤§å°å¿…é¡»ä¸º8å­—èŠ‚æ•´æ•°å€ï¼Œå¦‚æœå®ä¾‹æ•°æ®æ²¡æœ‰å¯¹é½çš„è¯ï¼Œéœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥ä½œä¸ºå ä½ç¬¦è¡¥å…¨ã€‚ å…«ã€å¯¹è±¡çš„è®¿é—®å®šä½javaé€šè¿‡æ ˆä¸Šçš„referenceæ“ä½œå †ä¸­çš„å…·ä½“å¯¹è±¡ã€‚ æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼šå¥æŸ„å’Œç›´æ¥æŒ‡é’ˆ 8.1å¥æŸ„è®¿é—®åœ¨å †ä¸­åˆ’åˆ†å‡ºä¸€å—å†…å­˜ä½œä¸ºå¥æŸ„æ± ï¼Œ referenceå­˜å‚¨å¥æŸ„åœ°å€ã€‚ å¥æŸ„åŒ…å«äº†å¯¹è±¡çš„å®ä¾‹æ•°æ®å’Œç±»å‹æ•°æ®å„è‡ªçš„åœ°å€ä¿¡æ¯ã€‚ 8.2 ç›´æ¥æŒ‡é’ˆreferenceç›´æ¥å­˜å‚¨å¯¹è±¡åœ°å€ã€‚å¦‚æœåªè®¿é—®å¯¹è±¡æœ¬èº«ï¼Œåˆ™é¿å…äº†ä¸€æ¬¡ç®€ä»‹è®¿é—®çš„å¼€é”€ã€‚ ä¼˜åŠ¿å¥æŸ„: referenceä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šå¥æŸ„åœ°å€ï¼Œå¯¹è±¡è¢«ç§»åŠ¨æ—¶ï¼Œæ™ºæ…§è¯¥ç—…å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆã€‚ ç›´æ¥æŒ‡é’ˆï¼šé€Ÿåº¦æ›´å¿«ï¼ŒèŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€ã€‚åœ¨é¢‘ç¹çš„javaå¯¹è±¡è®¿é—®ä¸­ï¼Œè¿™ç§å¼€é”€éå¸¸å¯è§‚ã€‚ HotSpotä¸»è¦é‡‡ç”¨ç›´æ¥æŒ‡é’ˆè¿›è¡Œå¯¹è±¡è®¿é—®ã€‚ ====================================================================== å…¶ä»–ç›¸å…³ç¬”è®°ï¼š JVMç¬”è®°ï¼ˆäºŒï¼‰å¯¹è±¡çš„ç”Ÿæ­»ä¸javaçš„å››å¤§å¼•ç”¨JVMç¬”è®°ï¼ˆä¸‰ï¼‰åƒåœ¾æ”¶é›†ç®—æ³•ä»¥åŠHotSpotçš„ç®—æ³•å®ç°(å®‰å…¨ç‚¹ã€è®°å¿†é›†ä¸å¡è¡¨ã€å†™å±éšœã€ä¸‰è‰²æ ‡è®°ç­‰)JVMç¬”è®°ã€Šå››ã€‹ä¸ƒä¸ªå¸¸è§çš„åƒåœ¾æ”¶é›†å™¨================================================================ å‚è€ƒï¼šã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœºç¬¬ä¸‰ç‰ˆã€‹","link":"/posts/20200316-jvm-memory.html"},{"title":"JVMç¬”è®°ï¼ˆä¸‰ï¼‰åƒåœ¾æ”¶é›†ç®—æ³•ä»¥åŠHotSpotçš„ç®—æ³•å®ç°(å®‰å…¨ç‚¹ã€è®°å¿†é›†ä¸å¡è¡¨ã€å†™å±éšœã€ä¸‰è‰²æ ‡è®°ç­‰)","text":"ä¸€ã€åƒåœ¾æ”¶é›†ç®—æ³•1.1 å †çš„å¸ƒå±€åˆ†ä¸ºæ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰å’Œè€å¹´ä»£ï¼ˆOld Generationï¼‰ å…¶ä¸­æ–°ç”Ÿä»£åˆåˆ†ä¸ºï¼š EdenåŒº survivor0ï¼ˆfromï¼‰åŒº survivor1ï¼ˆtoï¼‰åŒº å…¶ä¸­ æ–°ç”Ÿä»£ä¸‰ä¸ªåŒºçš„æ¯”ä¾‹é»˜è®¤ä¸ºï¼š 8:1:1 å¯é€šè¿‡-XX:SurvivorRatioå‚æ•°è°ƒæ•´ï¼Œå¦‚-XX:SurvivorRatio=9 1.2 GCç±»å‹ Minor GC(Young GC) å¯¹æ–°ç”Ÿä»£è¿›è¡ŒGC Major GC(Old GC) å¯¹è€å¹´ä»£è¿›è¡ŒGCã€‚ç›®å‰åªæœ‰CMSæ”¶é›†å™¨èƒ½å¤Ÿå•ç‹¬æ”¶é›†è€å¹´ä»£å¯¹è±¡ã€‚ Full GC å¯¹æ•´ä¸ªå †å’Œæ–¹æ³•åŒºè¿›è¡ŒGC 1.2.1 Minor GCæµç¨‹ edenå’ŒfromåŒºå¤åˆ¶åˆ°toåŒº edenåŒºæ»¡æ—¶è§¦å‘ç¬¬ä¸€æ¬¡GCï¼Œå°†edenå’ŒfromåŒºæ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°toåŒºï¼Œæ¸…ç†edenå’ŒfromåŒºçš„ç©ºé—´ï¼ŒåŒæ—¶å°†åˆ°toåŒºçš„å¯¹è±¡å¹´é¾„+1ï¼Œä½†å¦‚æœå·²ç»åˆ°è¾¾åˆ°è€å¹´ä»£çš„é˜ˆå€¼ï¼ˆé»˜è®¤15ï¼Œå¯é€šè¿‡-XX:MaxTenuringThresholdå‚æ•°è°ƒæ•´ï¼‰ï¼Œåˆ™ç›´æ¥è½¬ç§»åˆ°è€å¹´ä»£ äº¤æ¢fromå’ŒtoåŒº fromå’ŒtoåŒºä¸æ˜¯å›ºå®šçš„ï¼Œæ¯æ¬¡minorGCåï¼Œä¸¤ä¸ªsurvivoråŒºç©ºé—²çš„ä¸€å—ä½œä¸ºtoåŒºï¼Œéç©ºé—²çš„ä¸€å—ä½œä¸ºfromåŒº 1.2.2 åˆ†é…æ‹…ä¿Minor GC çš„æ­¥éª¤1ä¸­ï¼Œå‡ºç°äº†toåŒºä¸è¶³ä»¥å‚¨å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡ï¼Œåˆ™è¿™äº›å¯¹è±¡ç›´æ¥è¢«è½¬ç§»åˆ°è€å¹´ä»£ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ç©ºé—´åˆ†é…æ‹…ä¿ã€‚ JDK8ä»¥åï¼Œåœ¨è¿›è¡ŒMinor GCå‰ï¼Œå¦‚æœè€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£å¯¹è±¡å¤§å°æ€»å’Œæˆ–å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°ï¼Œåˆ™è¿›è¡ŒMinor GCï¼Œå¦åˆ™è¿›è¡ŒFull GCã€‚ å¦‚æœFull GCåä»ç„¶å†…å­˜ä¸è¶³ï¼Œåˆ™æŠ›å‡ºOOM. 1.3 å†…å­˜åˆ†é…ç­–ç•¥ å¯¹è±¡ä¼˜å…ˆåœ¨EdenåŒºåˆ†é… å¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£ ä½¿ç”¨-XX:PretenureSizeThresholdå‚æ•°æŒ‡å®šå¤§äºè¯¥å€¼çš„å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œå€¼å•ä½å¿…é¡»æ˜¯å­—èŠ‚ï¼Œä¸èƒ½ä½¿ç”¨Mæˆ–Kï¼Œå¦‚ä½¿ç”¨2,097,152â€¬è¡¨ç¤º2M é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ ä½¿ç”¨-XX:MaxTenuringThresholdå‚æ•°è®¾ç½®å¤§äºè¯¥å¹´é¾„çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ åœ¨survivorç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡æ€»å’Œå¤§äºsurvivorç©ºé—´ä¸€åŠï¼Œåˆ™å¹´é¾„å¤§äºç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ åªè¦æ»¡è¶³è¯¥æ¡ä»¶ï¼Œåˆ™æ— éœ€è¾¾åˆ°-XX:MaxTenuringThresholdå‚æ•°æŒ‡å®šçš„å¹´é¾„ MinorGCæ—¶ï¼Œå¦‚æœtoåŒºæ— æ³•æ»¡è¶³å­˜æ´»ä¸‹çš„å¯¹è±¡çš„å†…å­˜éœ€æ±‚ï¼Œåˆ™å°†å…¶åˆ†é…åˆ°è€å¹´ä»£ äºŒã€åƒåœ¾æ”¶é›†ç®—æ³•2.1 æ ‡è®°-æ¸…é™¤ç®—æ³•æ ‡è®°å‡ºæ‰€æœ‰è¦å›æ”¶çš„å¯¹è±¡ï¼Œ ç»Ÿä¸€å›æ”¶è¢«æ ‡è®°çš„å¯¹è±¡ã€‚ ç¼ºç‚¹ï¼š æ‰§è¡Œæ•ˆç‡ä¸ç¨³å®š å¦‚æœå¯¹è±¡è¿‡å¤šï¼Œåˆ™ä¼šè¿›è¡Œå¤§é‡çš„æ ‡è®°æ¸…é™¤ï¼Œæ•ˆç‡ä¸å¯¹è±¡æ•°é‡æˆåæ¯”ã€‚ é€ æˆå†…å­˜ç¢ç‰‡åŒ– å¾ˆæ˜æ˜¾ï¼Œæ ‡è®°æ¸…é™¤åä¸€å®šä¼šå‡ºç°å¾ˆå¤šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ­¤ä¸ºå†…å­˜ç¢ç‰‡ã€‚å¦‚æœæœ‰ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œè™½ç„¶æ€»å†…å­˜è¶³å¤Ÿï¼Œä½†å› è¿‡äºç¢ç‰‡åŒ–ï¼Œæ‰¾ä¸åˆ°è¿ç»­çš„ç©ºé—´åˆ†é…ç»™å¤§å¯¹è±¡ï¼Œå°±ä¼šé€ æˆä¸€æ¬¡GCï¼Œå½±å“æ€§èƒ½ã€‚ å¦‚ä¸‹å›¾ï¼š 2.2 æ ‡è®°-å¤åˆ¶ç®—æ³•å°†å†…å­˜åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œåªä½¿ç”¨ä¸€å—ã€‚ å½“ä¸€å—ç”¨å®Œäº†ï¼Œå°±å°†å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ï¼Œå¹¶å›æ”¶è¿™ä¸€å—ä½¿ç”¨çš„å†…å­˜ã€‚ å› æ­¤ã€‚å½“å­˜æ´»å¯¹è±¡è¿‡å¤šæ—¶ï¼Œå¤åˆ¶çš„å¼€é”€éå¸¸å¤§ã€‚ è€Œå¤§é‡å¯¹è±¡éœ€è¦å›æ”¶æ—¶ï¼Œåªéœ€è¦å¯¹åŠä¸ªå †çš„å°‘é‡å¯¹è±¡è¿›è¡Œå¤åˆ¶ï¼Œç®€å•è€Œé«˜æ•ˆï¼Œä¸”ä¸ä¼šäº§ç”Ÿç¢ç‰‡ã€‚ ç¼ºç‚¹ï¼š å¯ç”¨å†…å­˜ç¼©å°ä¸€åŠï¼Œç©ºé—´æµªè´¹ã€‚ å¦‚ä¸‹å›¾ï¼š ä½†æ˜¯Serialã€ParNewç­‰æ–°ç”Ÿä»£æ”¶é›†å™¨å¹¶æ²¡æœ‰é‡‡ç”¨è¿™ç§1:1çš„åˆ’åˆ†ç­–ç•¥ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸Šé¢è®²çš„8:1çš„æ¯”ä¾‹è¿›è¡Œæ ‡è®°-å¤åˆ¶å›æ”¶ã€‚ 2.3 æ ‡è®°-æ•´ç†ç®—æ³•è€Œä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œè¯¥ç®—æ³•ä¹Ÿæ˜¯å…ˆå¯¹å¯å›æ”¶å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œç„¶åå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘å†…å­˜çš„ä¸€ç«¯ç§»åŠ¨ï¼Œå†æ¸…ç†æ‰è¾¹ç•Œä»¥å¤–çš„æ‰€æœ‰å†…å­˜ã€‚ å¦‚ä¸‹å›¾å›æ”¶å‰å’Œå›æ”¶åçš„å¯¹æ¯”ï¼š ä½†æ˜¯è€å¹´ä»£ä¸­æ¯æ¬¡å›æ”¶éƒ½æœ‰å¤§é‡å¯¹è±¡ï¼Œç§»åŠ¨åè¿˜éœ€è¦æ›´æ–°å¯¹è±¡çš„å¼•ç”¨ï¼Œä¸”éœ€è¦Stop The Worldï¼ˆæš‚åœç”¨æˆ·ç¨‹åºï¼‰ ä¸æ ‡è®°-å¤åˆ¶ç›¸æ¯”ï¼š 1.æ ‡è®°æ•´ç†éœ€è¦ç§»åŠ¨ï¼Œå›æ”¶æ—¶è¾ƒå¤æ‚ï¼Œæ ‡è®°-å¤åˆ¶ä¸éœ€è¦ç§»åŠ¨ï¼Œä½†åˆ†é…æ—¶è¾ƒå¤æ‚ï¼ˆå¤§é‡ç¢ç‰‡ï¼‰ 2.å¤åˆ¶çš„åœé¡¿æ—¶é—´çŸ­ï¼Œæ•´ç†åœé¡¿é•¿ 3.æ ‡è®°-æ•´ç†ç®—æ³•ååé‡é«˜ è™½ç„¶æ ‡è®°-å¤åˆ¶ä¸éœ€è¦ç§»åŠ¨æ•ˆç‡é«˜ï¼Œä½†å†…å­˜åˆ†é…å’Œè®¿é—®æ¯”åƒåœ¾æ”¶é›†é¢‘ç‡é«˜å¾—å¤šï¼Œè€—æ—¶å¢åŠ ï¼Œæ€»ä½“ååé‡ä»ç„¶æ˜¯ä¸‹é™çš„ã€‚ ä¸‰ã€HotSpotçš„ç®—æ³•ç»†èŠ‚å®ç°3.1 æ ¹èŠ‚ç‚¹æšä¸¾ è¿„ä»Šä¸ºæ­¢ï¼Œæ‰€æœ‰æ”¶é›†å™¨åœ¨æ ¹èŠ‚ç‚¹æšä¸¾è¿™ä¸€æ­¥éª¤éƒ½å¿…é¡»æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œä¼šé¢ä¸´Stop The Worldçš„å›°æ‰° å½“å‰ä¸»æµçš„è™šæ‹Ÿæœºéƒ½ä½¿ç”¨å‡†ç¡®æ˜¯åƒåœ¾æ”¶é›†ï¼Œå› æ­¤è™šæ‹Ÿæœºæœ‰åŠæ³•ç›´æ¥å¾—åˆ°å“ªäº›åœ°æ–¹å­˜åœ¨å¯¹è±¡å¼•ç”¨ã€‚HotSpotä½¿ç”¨ä¸€ç»„OopMapçš„æ•°æ®ç»“æ„æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ ä¸€æ—¦ç±»åŠ è½½åŠ¨ä½œå®Œæˆï¼ŒHotSpot å°±ä¼šæŠŠå¯¹è±¡å†…ä»€ä¹ˆåç§»é‡ä¸Šæ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®è®¡ç®—å‡ºæ¥ï¼ˆåœ¨å³æ—¶ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šåœ¨ç‰¹å®šçš„ä½ç½®è®°å½•ä¸‹æ ˆå’Œå¯„å­˜å™¨ä¸­å“ªäº›ä½ç½®æ˜¯å¼•ç”¨ï¼‰ï¼Œè¿™æ ·æ”¶é›†å™¨åœ¨æ‰«ææ—¶å°±èƒ½ç›´æ¥å¾—çŸ¥è¿™äº›ä¿¡æ¯ï¼Œä¸å¿…ä»æ–¹æ³•åŒºç­‰ GC Roots å¼€å§‹æŸ¥æ‰¾ï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡ã€‚ 3.2 å®‰å…¨ç‚¹HotSpotæ²¡æœ‰ä¸ºæ¯ä¸ªæŒ‡ä»¤éƒ½ç”ŸæˆOopMapï¼Œå‰é¢æåˆ°çš„åœ¨â€œç‰¹å®šçš„ä½ç½®â€è®°å½•ä¸‹è¿™äº›ä¿¡æ¯ï¼Œè¿™äº›ä½ç½®ç§°ä¸ºå®‰å…¨ç‚¹ã€‚ å¼ºåˆ¶ç”¨æˆ·ç¨‹åºå¿…é¡»æ‰§è¡Œåˆ°å®‰å…¨ç‚¹æ‰èƒ½å¤Ÿæš‚åœã€‚å°±åƒé«˜é€Ÿå¼€è½¦åªèƒ½åœ¨æœåŠ¡åŒºåœè½¦ä¼‘æ¯ä¸€æ ·ã€‚ å®‰å…¨ç‚¹å¤ªå°‘ï¼Œä¼šè®©æ”¶é›†å™¨ç­‰å€™è¿‡ä¹… å®‰å…¨ç‚¹å¤ªå¤šï¼Œä¼šè¿‡åˆ†å¢å¤§è¿è¡Œæ—¶çš„å†…å­˜è´Ÿè· å®‰å…¨ç‚¹çš„é€‰å–ä»¥æ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾ â€œé•¿æ—¶é—´æ‰§è¡Œâ€æœ€æ˜æ˜¾çš„ç‰¹å¾æ˜¯ï¼šæŒ‡ä»¤åˆ—çš„å¤ç”¨ï¼Œå¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ã€å¼‚å¸¸è·³è½¬ç­‰ï¼Œå…·æœ‰è¿™ç§åŠŸèƒ½çš„æŒ‡ä»¤æ‰ä¼šäº§ç”Ÿå®‰å…¨ç‚¹ã€‚ å¦‚ä½•åœ¨åƒåœ¾æ”¶é›†æ—¶è®©æ‰€æœ‰çº¿ç¨‹è·‘åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹åœé¡¿ä¸‹æ¥ æŠ¢å…ˆå¼ä¸­æ–­ åƒåœ¾æ”¶é›†æ—¶ï¼Œé¦–å…ˆæŠŠæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹å…¨éƒ¨ä¸­æ–­ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹æ²¡æœ‰åœ¨å®‰å…¨ç‚¹ï¼Œå°±æ¢å¤è¯¥çº¿ç¨‹ï¼Œç›´åˆ°åˆ°è¾¾å®‰å…¨ç‚¹ã€‚ å‡ ä¹ä¸å†ä½¿ç”¨è¯¥æ–¹å¼ã€‚ ä¸»åŠ¨å¼ä¸­æ–­ a. åƒåœ¾æ”¶é›†éœ€è¦ä¸­æ–­çº¿ç¨‹æ—¶ï¼Œä»…ç®€å•åœ°è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½ï¼Œå„çº¿ç¨‹ä¸åœåœ°ä¸»åŠ¨è½®è¯¢è¯¥æ ‡å¿—ï¼Œä¸€æ—¦å‘ç°ä¸­æ–­æ ‡å¿—ä½ä¸ºçœŸï¼Œå°±åœ¨æœ€è¿‘çš„å®‰å…¨ç‚¹åœä¸‹ b. è½®è¯¢æ ‡å¿—æ˜¯å’Œå®‰å…¨ç‚¹é‡åˆçš„ c. hotSpotä½¿ç”¨å†…å­˜ä¿æŠ¤é™·é˜±çš„æ–¹å¼æŠŠè½®è¯¢æ“ä½œç²¾ç®€åˆ°åªæœ‰ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤ã€‚ 3.3 å®‰å…¨åŒºåŸŸå½“ç¨‹åºâ€œä¸æ‰§è¡Œâ€æ—¶ï¼Œå¦‚ç”¨æˆ·çº¿ç¨‹åœ¨Sleepæˆ–Blockedï¼Œçº¿ç¨‹æ— æ³•å“åº”ä¸­æ–­åˆ°å®‰å…¨ç‚¹æŒ‚èµ·è‡ªå·±ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©å®‰å…¨åŒºåŸŸã€‚ å®‰å…¨åŒºåŸŸå°±æ˜¯èƒ½å¤Ÿç¡®ä¿åœ¨æŸæ®µä»£ç ä¸­ï¼Œå¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤åœ¨è¿™ä¸ªåŒºåŸŸä»»æ„ä½ç½®è¿›è¡ŒGCéƒ½æ˜¯å®‰å…¨çš„ã€‚ï¼ˆå¯ç†è§£ä¸ºè¢«æ‰©å±•æ‹‰ä¼¸çš„å®‰å…¨ç‚¹ï¼‰ åŸç† 3.4 è®°å¿†é›†ä¸å¡è¡¨ä¸ºäº†è§£å†³è·¨ä»£å¼•ç”¨é—®é¢˜ï¼Œåœ¨æ–°ç”Ÿä»£å¼•å…¥çš„è®°å½•é›†ï¼ˆRemember Setï¼‰çš„æ•°æ®ç»“æ„ï¼ˆè®°å½•ä»éæ”¶é›†åŒºåˆ°æ”¶é›†åŒºçš„æŒ‡é’ˆé›†åˆï¼‰ï¼Œé¿å…æŠŠæ•´ä¸ªè€å¹´ä»£åŠ å…¥GCRootsæ‰«æèŒƒå›´ã€‚ åƒåœ¾æ”¶é›†åœºæ™¯ä¸­ï¼Œæ”¶é›†å™¨åªéœ€é€šè¿‡è®°å¿†é›†åˆ¤æ–­å‡ºæŸä¸€å—éæ”¶é›†åŒºåŸŸæ˜¯å¦å­˜åœ¨æŒ‡å‘æ”¶é›†åŒºåŸŸçš„æŒ‡é’ˆå³å¯ï¼Œæ— éœ€äº†è§£è·¨ä»£å¼•ç”¨æŒ‡é’ˆçš„å…¨éƒ¨ç»†èŠ‚ã€‚ 3.4.1 è®°å¿†é›†çš„å®ç°å¯ä»¥é‡‡ç”¨ä¸åŒçš„è®°å½•ç²’åº¦ï¼Œä»¥èŠ‚çœè®°å¿†é›†çš„å­˜å‚¨å’Œç»´æŠ¤æˆæœ¬ï¼Œå¦‚ï¼š å­—é•¿ç²¾åº¦ï¼šæ¯ä¸ªè®°å½•ç²¾ç¡®åˆ°ä¸€ä¸ªæœºå™¨å­—é•¿ï¼ˆå¤„ç†å™¨çš„å¯»å€ä½æ•°ï¼Œå¦‚å¸¸è§çš„ 32 ä½æˆ– 64 ä½ï¼‰ï¼Œè¯¥å­—åŒ…å«è·¨ä»£æŒ‡é’ˆ å¯¹è±¡ç²¾åº¦ï¼šæ¯ä¸ªè®°å½•ç²¾ç¡®åˆ°ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­æœ‰å­—æ®µåŒ…å«è·¨ä»£æŒ‡é’ˆ å¡ç²¾åº¦ï¼šæ¯ä¸ªè®°å½•ç²¾ç¡®åˆ°ä¸€å—å†…å­˜åŒºåŸŸï¼Œè¯¥åŒºåŸŸä¸­æœ‰å¯¹è±¡åŒ…å«è·¨ä»£æŒ‡é’ˆ å¡è¡¨ç¬¬ä¸‰ç§å¡ç²¾åº¦æ˜¯ä½¿ç”¨ä¸€ç§å«åšâ€œå¡è¡¨â€çš„æ–¹å¼å®ç°è®°å¿†é›†ï¼Œä¹Ÿæ˜¯ç›®å‰æœ€å¸¸ç”¨çš„ä¸€ç§æ–¹å¼ è®°å¿†é›†æ˜¯ä¸€ç§æŠ½è±¡æ¦‚å¿µï¼Œå¡è¡¨æ˜¯å®ƒçš„å®ç°æ–¹å¼ã€‚å®ƒè®°å½•äº†è®°å¿†é›†çš„è®°å½•ç²¾åº¦ã€ä¸å †å†…å­˜çš„æ˜ å°„å…³ç³»ç­‰ã€‚ å¡è¡¨æ˜¯ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ•°ç»„å®ç°ï¼šCARD_TABLE[this addredd &gt;&gt;9]=0ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ç€å…¶æ ‡è¯†çš„å†…å­˜åŒºåŸŸä¸€å—ç‰¹å®šå¤§å°çš„å†…å­˜å—ï¼Œç§°ä¸ºâ€œå¡é¡µâ€ã€‚ hotSpotä½¿ç”¨çš„å¡é¡µæ˜¯2^9å¤§å°ï¼Œå³512å­—èŠ‚ ä¸€ä¸ªå¡é¡µä¸­å¯åŒ…å«å¤šä¸ªå¯¹è±¡ï¼Œåªè¦æœ‰ä¸€ä¸ªå¯¹è±¡çš„å­—æ®µå­˜åœ¨è·¨ä»£æŒ‡é’ˆï¼Œå…¶å¯¹åº”çš„å¡è¡¨çš„å…ƒç´ æ ‡è¯†å°±å˜æˆ1ï¼Œè¡¨ç¤ºè¯¥å…ƒç´ å˜è„ï¼Œå¦åˆ™ä¸º0. GCæ—¶ï¼Œåªè¦ç­›é€‰å¡è¡¨ä¸­å˜è„çš„å…ƒç´ åŠ å…¥GCRootsã€‚ 3.5 å†™å±éšœ3.5.1 å¡è¡¨çš„ç»´æŠ¤å¡è¡¨å˜è„ä¸Šé¢å·²ç»è¯´äº†ï¼Œä½†æ˜¯éœ€è¦çŸ¥é“å¦‚ä½•è®©å¡è¡¨å˜è„ï¼Œå³å‘ç”Ÿå¼•ç”¨å­—æ®µèµ‹å€¼æ—¶ï¼Œå¦‚ä½•æ›´æ–°å¡è¡¨å¯¹åº”çš„æ ‡è¯†ä¸º1. hotSpotä½¿ç”¨å†™å±éšœç»´æŠ¤å¡è¡¨çŠ¶æ€ã€‚ å¯çœ‹åšåœ¨è™šæ‹Ÿæœºå±‚é¢å¯¹â€œå¼•ç”¨ç±»å‹å­—æ®µèµ‹å€¼â€åŠ¨ä½œçš„AOPåˆ‡é¢ï¼Œåœ¨èµ‹å€¼æ—¶äº§ç”Ÿä¸€ä¸ªç¯å½¢é€šçŸ¥ã€‚èµ‹å€¼å‰åéƒ½å±äºå†™å±éšœï¼Œèµ‹å€¼å‰ç§°ä¸ºâ€œå†™å‰å±éšœï¼ˆPre-Write Barrierï¼‰â€ï¼Œèµ‹å€¼åç§°ä¸ºâ€œå†™åå±éšœï¼ˆPost-Write Barrierï¼‰â€ã€‚ 3.5.2 å†™å±éšœçš„é—®é¢˜ è™šæ‹Ÿæœºä¼šä¸ºæ‰€æœ‰èµ‹å€¼æ“ä½œç”Ÿæˆç›¸åº”çš„æŒ‡ä»¤ï¼Œä¸€æ—¦æ”¶é›†å™¨åœ¨å†™å±éšœä¸­å¢åŠ äº†æ›´æ–°å¡è¡¨æ“ä½œï¼Œæ— è®ºæ›´æ–°çš„æ˜¯ä¸æ˜¯è€å¹´ä»£å¯¹æ–°ç”Ÿä»£çš„å¼•ç”¨ï¼Œæ¯æ¬¡åªè¦å¯¹å¼•ç”¨è¿›è¡Œæ›´æ–°ï¼Œå°±ä¼šäº§ç”Ÿé¢å¤–çš„å¼€é”€ã€‚ ä¼ªå…±äº«é—®é¢˜ å¹¶å‘åœºæ™¯ä¸‹ï¼Œå½“å¤šä¸ªäº’ç›¸ç‹¬ç«‹çš„å˜é‡è¢«è¯»å–åˆ°ä¸€ä¸ªç¼“å­˜è¡Œæ—¶ï¼Œä¼šå½±å“æ€§èƒ½ã€‚ä¼ªå…±äº«å‚è€ƒï¼šhttps://blog.csdn.net/weixin_43696529/article/details/104884373 è§£å†³ï¼š åŠ æ¡ä»¶ åªæœ‰å¡è¡¨å…ƒç´ æœªè¢«æ ‡è®°æ—¶æ‰å°†å…¶æ ‡è®°ä¸ºå˜è„ã€‚ JDK7ä»¥åï¼Œä½¿ç”¨ -XX:+UseCondCardMarkå‚æ•°è®¾å®šæ˜¯å¦å¼€å¯å¡è¡¨æ›´æ–°æ—¶çš„æ¡ä»¶åˆ¤æ–­ å¼€å¯æ¡ä»¶è‡ªç„¶ä¼šå¢åŠ ä¸€ä¸ªåˆ¤æ–­å¼€é”€ï¼Œä½†èƒ½å¤Ÿé¿å…ä¼ªå…±äº«é—®é¢˜ã€‚æ ¹æ®å®é™…æ¥ã€‚ 3.6 å¹¶å‘çš„å¯è¾¾æ€§åˆ†æå¯è¾¾æ€§åˆ†æå·¥ä½œå¿…é¡»è¦åœ¨èƒ½ä¿éšœä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œï¼Œå› æ­¤å¿…é¡»åœæ­¢ç”¨æˆ·è¿›ç¨‹ã€‚ å¦‚æœç”¨æˆ·è¿›ç¨‹è¢«åœæ­¢ï¼Œé‚£ä¸ä¼šäº§ç”Ÿä»»ä½•é—®é¢˜ã€‚ ä½†å¦‚æœç”¨æˆ·è¿›ç¨‹å’ŒGCè¿›ç¨‹å¹¶å‘è¿›è¡Œï¼Œå°±ä¼šå‡ºç°ä¸¤ç§åæœï¼š é”™è¯¯åœ°æ ‡è®°å·²ç»æ¶ˆäº¡çš„å¯¹è±¡ å°†å­˜æ´»çš„å¯¹è±¡æ ‡è®°ä¸ºæ¶ˆäº¡ 3.6.1 ä¸‰è‰²æ ‡è®°ä½¿ç”¨ä¸‰è‰²æ ‡è®°æ¥è§£é‡Šä¸Šè¿°é—®é¢˜ï¼š ç™½è‰²ï¼š å¯¹è±¡æœªè¢«æ”¶é›†å™¨è®¿é—®ï¼ˆæœªæ‰«æï¼‰ é»‘è‰²ï¼šå¯¹è±¡å·²è¢«æ”¶é›†å™¨è®¿é—®ï¼Œä¸”è¯¥å¯¹è±¡æ‰€æœ‰å¼•ç”¨å·²æ‰«æè¿‡ã€‚ï¼ˆå®‰å…¨å­˜æ´»ï¼‰ï¼ˆæ‰«æå®Œæ¯•ï¼‰ ç°è‰²ï¼šå¯¹è±¡è¢«è®¿é—®è¿‡ï¼Œä½†å¯¹åº”è‡³å°‘è¿˜æœ‰ä¸€ä¸ªå¼•ç”¨æ²¡æœ‰æ‰«æè¿‡ã€‚ï¼ˆæ­£åœ¨æ‰«æï¼‰ ä½†å¦‚æœç”¨æˆ·çº¿ç¨‹åœ¨å¹¶å‘æ ‡è®°è¿›è¡Œæ—¶ä¿®æ”¹äº†å¼•ç”¨å…³ç³»ï¼Œå¦‚ä¸‹æƒ…å†µä¼šå‡ºç°å­˜æ´»å¯¹è±¡æ¶ˆäº¡çš„ç°è±¡ï¼š å¦‚ä¸Šå›¾ï¼š åŸæœ¬å¼•ç”¨å…³ç³»ä¸ºï¼šA-&gt;Bï¼ŒB-&gt;C æ‰«æåˆ°Bæ—¶ï¼Œç”¨æˆ·çº¿ç¨‹å–æ¶ˆäº†Båˆ°Cçš„å¼•ç”¨ï¼Œåè€Œæ·»åŠ äº†ä¸€æ¡ä»å·²æ‰«æè¿‡çš„å¯¹è±¡Aåˆ°å¯¹è±¡Cçš„å¼•ç”¨ 2çš„æƒ…å†µå°±ä¼šé€ æˆå¯¹è±¡Cä¸è¢«æ‰«æåˆ°ï¼Œè€ŒCæœ¬åº”è¯¥æ˜¯å­˜æ´»çš„ï¼Œå´åœ¨è¿™ä¸ªæƒ…å†µä¸‹æ„å¤–åœ°è¢«æ ‡è®°ä¸ºâ€æ­»äº¡â€œ åŒç†ï¼Œå½“æ ‡è®°åˆ°è¯¥å›¾çš„Bæ—¶ã€‚å–æ¶ˆ äº†Båˆ°Cçš„å¼•ç”¨ï¼Œæ·»åŠ äº†Aåˆ°Dçš„å¼•ç”¨ï¼Œä½†å› ä¸ºAå·²ç»æ ‡è®°è¿‡ï¼Œå› æ­¤Dä¸ä¼šå†è¢«æ‰«æï¼ŒCä¹Ÿä¸ä¼šè¢«æ‰«æï¼Œè¿™æ ·Då’ŒCä¹Ÿå› ç”¨æˆ·çº¿ç¨‹çš„ä¿®æ”¹â€œæ„å¤–æ­»äº¡â€ï¼Œè¿™å°±æ˜¯â€œå¯¹è±¡æ¶ˆå¤±â€œçš„é—®é¢˜ã€‚ å¯¹è±¡æ¶ˆå¤±çš„åŸå›  æ·»åŠ äº†ä¸€æ¡æˆ–å¤šæ¡ä»é»‘è‰²åˆ°ç™½è‰²çš„æ–°å¼•ç”¨ åˆ é™¤äº†å…¨éƒ¨ä»ç°è‰²åˆ°ç™½è‰²çš„æ—§å¼•ç”¨ï¼ˆç›´æ¥oré—´æ¥ï¼‰ å¯¹è±¡æ¶ˆå¤±çš„è§£å†³åŸå› 1å’Œ2åˆ†åˆ«å¯¹åº”ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š å¢é‡æ›´æ–°ï¼ˆCMSç”¨åˆ°ï¼‰ è®°å½•ä¸‹æ–°æ’å…¥çš„å¼•ç”¨ï¼Œå¹¶å‘æ‰«æå®Œæ¯•åï¼Œé‡æ–°ä»¥è®°å½•ä¸‹çš„å¼•ç”¨å…³ç³»çš„é»‘è‰²å¯¹è±¡ä¸ºæ ¹æ‰«æã€‚ å³é»‘è‰²ä¸€æ—¦æ’å…¥äº†æ–°çš„åˆ°ç™½è‰²çš„å¼•ç”¨ï¼Œå°±å˜æˆäº†ç°è‰²ã€‚ åŸå§‹å¿«ç…§ï¼ˆG1å’ŒShenandoahï¼‰ ç°è‰²å¯¹è±¡è¦åˆ é™¤æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œå°†è¯¥å¼•ç”¨è®°å½•ä¸‹æ¥ï¼Œæ‰«æå®Œæ¯•åï¼Œå†ä»è¢«è®°å½•ä¸‹çš„å¼•ç”¨çš„ç°è‰²å¯¹è±¡å¼€å§‹é‡æ–°æ‰«æã€‚ HotSpotä¸»è¦é‡‡ç”¨ç›´æ¥æŒ‡é’ˆè¿›è¡Œå¯¹è±¡è®¿é—®ã€‚ ====================================================================== å…¶ä»–ç›¸å…³ç¬”è®°ï¼š JVMç¬”è®°ï¼ˆä¸€ï¼‰javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºä»¥åŠå¯¹è±¡çš„åˆ›å»ºã€å¸ƒå±€å’Œå®šä½JVMç¬”è®°ï¼ˆäºŒï¼‰å¯¹è±¡çš„ç”Ÿæ­»ä¸javaçš„å››å¤§å¼•ç”¨JVMç¬”è®°ã€Šå››ã€‹ä¸ƒä¸ªå¸¸è§çš„åƒåœ¾æ”¶é›†å™¨================================================================ å‚è€ƒï¼šã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœºç¬¬ä¸‰ç‰ˆã€‹","link":"/posts/20200316-jvm-gc.html"},{"title":"JVMç¬”è®°ï¼ˆäºŒï¼‰å¯¹è±¡çš„ç”Ÿæ­»ä¸javaçš„å››å¤§å¼•ç”¨","text":"åƒåœ¾å›æ”¶ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯åƒåœ¾ï¼Œå³è¿™ä¸ªå¯¹è±¡æ˜¯å¦å·²ç»ä¸å†è¢«ä½¿ç”¨åˆ°ã€‚ ä¸€ã€å¯¹è±¡çš„ç”Ÿæ­»1.1 å¼•ç”¨è®¡æ•°æ³•åœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå¦‚æœä¸€ä¸ªåœ°æ–¹å¼•ç”¨äº†å®ƒï¼Œåˆ™è®¡æ•°å™¨+1ï¼Œç›¸åº”çš„ä¸€ä¸ªå¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å‡ä¸€ï¼›è®¡æ•°å™¨ä¸º0ä¸ºä¸å¯å†è¢«ä½¿ç”¨ã€‚ åŸç†ç®€å•ï¼Œæ•ˆç‡é«˜ï¼Œä½†æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚ ä¸»æµçš„javaè™šæ‹Ÿæœºæœªä½¿ç”¨æ­¤æ–¹æ³• 12345678910111213141516171819202122232425262728public class _01Reference { public Object instance=null; private static final int _1MB=1024*1024; private byte[] bigSize=new byte[2*_1MB]; /** * -XX:+PrintGC è¾“å‡ºGCæ—¥å¿— * -XX:+PrintGCDetails è¾“å‡ºGCçš„è¯¦ç»†æ—¥å¿— * -XX:+PrintGCTimeStamps è¾“å‡ºGCçš„æ—¶é—´æˆ³ï¼ˆä»¥åŸºå‡†æ—¶é—´çš„å½¢å¼ï¼‰ * -XX:+PrintGCDateStamps è¾“å‡ºGCçš„æ—¶é—´æˆ³ï¼ˆä»¥æ—¥æœŸçš„å½¢å¼ï¼Œå¦‚ 2013-05-04T21:53:59.234+0800ï¼‰ * -XX:+PrintHeapAtGC åœ¨è¿›è¡ŒGCçš„å‰åæ‰“å°å‡ºå †çš„ä¿¡æ¯ * -Xloggc:../logs/gc.log æ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ * @param args */ public static void main(String[] args) { _01Reference r1=new _01Reference(); _01Reference r2=new _01Reference(); r1.instance=r2; r2.instance=r1; r1=null; r2=null; System.gc(); }} ä¸¤ä¸ªå¯¹è±¡äº’ç›¸å¼•ç”¨ï¼Œä½†è™šæ‹Ÿæœºæ²¡æœ‰å› ä¸ºä¸¤ä¸ªå¯¹è±¡äº’ç›¸å¼•ç”¨è€Œä¸è¿›è¡ŒGC 1.2 å¯è¾¾æ€§åˆ†ææ³•è¯¥ç®—æ³•æ˜¯å½“å‰ä¸»æµçš„å•†ç”¨è¯­æ³•çš„å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ‰€é‡‡å–çš„ï¼Œä¹Ÿæ˜¯JVMæ‰€é‡‡å–çš„ã€‚ è¯¥ç®—æ³•è¯•é€šè¿‡ä¸€ç³»åˆ—â€œGC Rootsâ€çš„æ ¹å¯¹è±¡ä½œä¸ºèµ·å§‹èŠ‚ç‚¹é›†åˆï¼Œä»è¿™äº›èŠ‚å¼€å§‹æ ¹æ®å¼•ç”¨å…³ç³»å‘ä¸‹æœç´¢ï¼Œæœç´¢è¿‡ç¨‹èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºâ€œå¼•ç”¨é“¾â€œï¼Œå¦‚æœæŸä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰å¼•ç”¨é“¾ï¼Œè¯´æ˜æ­¤å¯¹è±¡æ—¶ä¸å¯è¢«åˆ©ç”¨çš„ã€‚ ç®€å•è¯´ï¼Œå°±æ˜¯ä»æ ¹èŠ‚ç‚¹é›†åˆçš„æ‰€æœ‰ä¸å¯è¾¾çš„å¯¹è±¡åˆ¤å®šä¸ºæ­»äº¡ï¼Œå¯è¾¾çš„å¯¹è±¡åˆ¤å®šä¸ºæ´»è·ƒçš„ã€‚ å¦‚ä¸Šï¼šè™½ç„¶å¯¹è±¡5,6,7äº’ç›¸å­˜åœ¨å…³è”ï¼Œä½†å®ƒä»¬æ˜¯ä»GC Rootsä¸å¯è¾¾çš„ï¼Œå› ä¸ºè¢«åˆ¤å®šä¸ºå¯å›æ”¶å¯¹è±¡ã€‚ å¯ä½œä¸ºGC Rootsçš„å¯¹è±¡ï¼š æ ˆä¸­ï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼ˆå¦‚å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„å¼•ç”¨ï¼‰ æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆNativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ è™šæ‹Ÿæœºå†…éƒ¨å¼•ç”¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„Classå¯¹è±¡ï¼Œå¸¸é©»çš„å¼‚å¸¸å¯¹è±¡ï¼ˆNPEã€OOMï¼‰ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ æ‰€æœ‰è¢«synchronizeå…³é”®å­—æŒæœ‰çš„å¯¹è±¡ 1.3 å¼•ç”¨javaå¼•ç”¨åˆ†ä¸º å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨å’Œè™šå¼•ç”¨ æ•´ä½“æ¶æ„ä½äºjava.lang.refåŒ…ä¸‹ï¼š å¼ºå¼•ç”¨ç±»ä¼¼Object obj=new Object()è¿™æ ·çš„å¼•ç”¨å…³ç³»å°±å«åšå¼ºå¼•ç”¨ å¯¹äºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œå³ä½¿å‡ºç°OOMä¹Ÿä¸ä¼šå›æ”¶è¯¥å¯¹è±¡ 12345Object obj1=new Object();Object obj2=obj1;obj1=null;System.gc();Sytem.out.printIn(obj2) å¦‚ä¸Šä»£ç ï¼Œobj2ä¸ä¼šè¿›è¡Œå›æ”¶ è½¯å¼•ç”¨ä½äºjava.lang.ref.SoftReference ä¸€äº›æœ‰ç”¨ï¼Œä½†éå¿…é¡»çš„å¯¹è±¡ã€‚åœ¨ç³»ç»Ÿå°†è¦å‡ºç°å†…å­˜æº¢å‡ºå‰ï¼Œä¼šå°†è¿™äº›å¯¹è±¡åˆ—ä¸ºç¬¬äºŒæ¬¡å›æ”¶å¯¹è±¡ï¼Œå¦‚æœæ­¤æ¬¡å›æ”¶è¿˜æ²¡æœ‰è¶³å¤Ÿå†…å­˜ï¼Œåˆ™æŠ›å‡ºOOMã€‚ å³ å†…å­˜å¤Ÿç”¨ å°± ä¸å›æ”¶ å†…å­˜ä¸å¤Ÿç”¨ å°± å›æ”¶ ----&gt; å›æ”¶è¿˜ä¸å¤Ÿ -----&gt; OOMç”¨åœ¨å†…å­˜æ•æ„Ÿçš„åœ°æ–¹ï¼Œå¦‚é«˜é€Ÿç¼“å­˜ 1234567891011121314151617181920212223242526272829303132333435/** * å†…å­˜å¤Ÿç”¨æ—¶ è½¯å¼•ç”¨å¯¹è±¡ä¸è¢«å›æ”¶ */ public static void memoryEnough(){ Object obj1=new Object(); SoftReference&lt;Object&gt;softReference=new SoftReference&lt;&gt;(obj1); System.out.println(obj1); System.out.println(softReference.get()); obj1=null; System.gc(); System.out.println(obj1);//null System.out.println(softReference.get());//æœ‰å¯¹è±¡ } /** * å†…å­˜ä¸å¤Ÿç”¨ï¼Œä¼šå›æ”¶è½¯å¼•ç”¨å¯¹è±¡ * -Xms10M -Xmx10M -XX:+PrintGCDetails */ public static void notEnough(){ Object obj1=new Object(); SoftReference&lt;Object&gt;softReference=new SoftReference&lt;&gt;(obj1); System.out.println(obj1); System.out.println(softReference.get()); obj1=null; try { byte[]bytes=new byte[20*1024*1024]; }finally { System.out.println(obj1);//null System.out.println(softReference.get());//null } } è½¯å¼•ç”¨ç”¨é€”ç¼“å­˜ä¸­ä¼šéå¸¸å¸¸ç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨è½¯å¼•ç”¨ä¿å­˜ç¼“å­˜æ•°æ®ï¼Œå½“å‘ç”ŸOOMæ—¶ï¼Œç³»ç»Ÿå°±ä¼šå›æ”¶è¿™äº›è½¯å¼•ç”¨çš„ç¼“å­˜æ•°æ®ã€‚ å¼±å¼•ç”¨ä½äºjava.lang.ref.WeakReference éå¿…é¡»å¯¹è±¡ï¼Œä¸ç®¡å†…å­˜å¤Ÿä¸å¤Ÿç”¨ï¼Œéƒ½ä¼šè¢«GCå›æ”¶ 1234567891011public static void main(String[] args) { Object o1=new Object(); WeakReference&lt;Object&gt;weakReference=new WeakReference&lt;&gt;(o1); System.out.println(o1);//java.lang.Object@677327b6 System.out.println(weakReference.get());//java.lang.Object@677327b6 o1=null; System.gc(); System.out.println(o1);//null System.out.println(weakReference.get());//null } å¦‚ä¸Šå†…å­˜å¤Ÿç”¨çš„è¯ï¼Œå‘ç”ŸGCä»ç„¶ä¼šè¢«å›æ”¶ï¼Œå†…å­˜ä¸å¤Ÿä¹Ÿæ˜¯ä¼šè¢«å›æ”¶çš„ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ã€‚ WeakHashMap123456789101112131415161718192021private static void weakHashMap() { WeakHashMap&lt;Integer,Object&gt; map=new WeakHashMap&lt;&gt;(); Integer key=new Integer(1); Object value=\"value\"; map.put(key,value); System.out.println(map);//{1=value} key=null; System.gc(); System.out.println(map);//{} }private static void hashMap(){ HashMap&lt;Integer,String&gt;map=new HashMap&lt;&gt;(); Integer key=new Integer(1); String value=\"wml\"; map.put(key,value); System.out.println(map);//{1=wml} key=null; System.gc(); System.out.println(map);//{1=wml} } è™šå¼•ç”¨ä½äºjava.lang.ref.PhantomReference ä¹Ÿç§°â€œå¹½çµå¼•ç”¨â€æˆ–â€œå¹»å½±å¼•ç”¨â€ï¼Œæœ€å¼±çš„å¼•ç”¨å…³ç³» æ— æ³•é€šè¿‡è™šå¼•ç”¨çš„get()æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ ä»…ç”¨äºå¯¹è±¡è¢«å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ï¼Œæˆ–åç»­æ·»åŠ è¿›ä¸€æ­¥å¤„ç†ï¼Œå¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ã€‚ 1234567891011121314151617public static void main(String[] args) throws InterruptedException { Object o1=new Object(); ReferenceQueue&lt;Object&gt;queue=new ReferenceQueue&lt;&gt;(); PhantomReference&lt;Object&gt; phantomReference=new PhantomReference&lt;&gt;(o1, queue); System.out.println(o1);//java.lang.Object@677327b6 System.out.println(phantomReference.get());//null System.out.println(\"å¼•ç”¨é˜Ÿåˆ—ï¼š\"+queue.poll());//null System.out.println(\"=============å‘ç”ŸGCå========\"); o1=null; System.gc(); System.out.println(o1);//null System.out.println(phantomReference.get());//null System.out.println(\"å¼•ç”¨é˜Ÿåˆ—ï¼š\"+queue.poll());//java.lang.ref.WeakReference@14ae5a5 } 1.4 å¯¹è±¡çš„è‡ªæˆ‘æ‹¯æ•‘ä¸€ä¸ªå¯¹è±¡çš„æ­»äº¡è‡³å°‘éœ€è¦ä¸¤æ¬¡æ ‡è®°ã€‚ ç¬¬ä¸€æ¬¡ï¼šå³å¯¹GC Rootsè¿›è¡Œå¯è¾¾æ€§åˆ†æåæ²¡æœ‰ä¸ä¹‹ç›¸è¿çš„å¼•ç”¨è¿æ—¶ ç¬¬äºŒæ¬¡ï¼šå¯¹è±¡æ˜¯å¦è¦æ‰§è¡Œfinalize()æ–¹æ³• å¦‚æœå¯¹è±¡è¦†ç›–äº†finalizeæ–¹æ³•ï¼Œå¹¶åœ¨è¯¥æ–¹æ³•ä¸­é‡æ–°ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹è¿æ¥ï¼Œåˆ™ä»£è¡¨è¯¥å¯¹è±¡è‡ªæˆ‘æ‹¯æ•‘æˆåŠŸï¼Œä¼šè¢«ä»è¢«å›æ”¶çš„é›†åˆä¸­ç§»é™¤ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.wml.jvm.gc;/** * 1.å¯¹è±¡å¯ä»¥åœ¨è¢«GBæ—¶è¿›è¡Œé€ƒé€¸ * 2.è¿™ç§è‡ªæ•‘çš„æœºä¼šåªæœ‰ä¸€æ¬¡ï¼Œå› ä¸ºä¸€ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•æœ€å¤šåªä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡ * @author MaoLin Wang * @date 2020/3/1216:39 */public class _02FinalizeEscapeGC { public static Object obj1 =null; @Override protected void finalize() throws Throwable { System.out.println(\"finalizeæ–¹æ³•æ‰§è¡Œ\"); obj1 =this; } private static void gc(){ System.gc(); System.out.println(\"å¼€å§‹åƒåœ¾å›æ”¶\"); } public static void main(String[] args) throws InterruptedException { obj1 =new _02FinalizeEscapeGC(); //å¯¹è±¡ç¬¬ä¸€æ¬¡è¿›è¡Œè‡ªæˆ‘æ‹¯æ•‘(é€ƒé¿GC) obj1 =null; gc(); //å› ä¸ºfinalizeæ–¹æ³•ä¼˜å…ˆçº§å¾ˆä½ï¼Œæ‰€æœ‰ç­‰å¾…ä¸€ä¸‹ Thread.sleep(500); if (obj1 !=null){ System.out.println(\"first-&gt;å¯¹è±¡ä»ç„¶å­˜æ´»\"); }else { System.out.println(\"first-&gt;å¯¹è±¡å·²æ­»äº¡\"); } //å¯¹è±¡ç¬¬äºŒæ¬¡è¿›è¡Œè‡ªæˆ‘æ‹¯æ•‘(é€ƒé¿GC)ï¼Œä½†å› ä¸ºfinalizeå·²ç»è¢«è°ƒç”¨äº†ä¸€æ¬¡ï¼Œå› æ­¤æ— æ³•é€ƒé€¸æˆåŠŸ obj1 =null; System.gc(); //å› ä¸ºfinalizeæ–¹æ³•ä¼˜å…ˆçº§å¾ˆä½ï¼Œæ‰€æœ‰ç­‰å¾…ä¸€ä¸‹ Thread.sleep(500); if (obj1 !=null){ System.out.println(\"Second-&gt;å¯¹è±¡ä»ç„¶å­˜æ´»\"); }else { System.out.println(\"Second-&gt;å¯¹è±¡å·²æ­»äº¡\"); } }} ç»“æœï¼š 1234è°ƒç”¨äº†finalizeæ–¹æ³•å¼€å§‹åƒåœ¾å›æ”¶first-&gt;å¯¹è±¡ä»ç„¶å­˜æ´»Second-&gt;å¯¹è±¡å·²æ­»äº¡ ä½†å®˜æ–¹å·²ä¸æ¨èè¿™ç§åšæ³•ï¼Œå› ä¸ºè¿è¡Œä»£ä»·é«˜ï¼Œä¸ç¡®å®šæ€§å¤§ã€‚ 1.5 æ–¹æ³•åŒºçš„å›æ”¶å›æ”¶ç›®æ ‡ï¼š åºŸå¼ƒçš„å¸¸é‡ æŸä¸ªå¸¸é‡æ²¡æœ‰å…¶ä»–ä»»ä½•åœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œå°±ä¼šè¢«å›æ”¶ã€‚å¸¸é‡æ± ä¸­å…¶ä»–ç±»ã€æ–¹æ³•ã€å­—æ®µçš„ç¬¦å·å¼•ç”¨ ä¸å†ä½¿ç”¨çš„ç±»å‹ ç±»å‹è¢«å…è®¸å›æ”¶çš„æ¡ä»¶å¦‚ä¸‹ï¼š a.è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½è¢«å›æ”¶ b. åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²è¢«å›æ”¶ c. è¯¥ç±»å¯¹åº”çš„java.class.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³• åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLibç­‰å­—èŠ‚ç æ¡†æ¶éƒ½éœ€è¦è™šæ‹Ÿæœºèƒ½å¤Ÿè¿›è¡Œç±»å‹å¸è½½ï¼Œä»¥å‡å°‘æ–¹æ³•åŒºå‹åŠ›ã€‚ ====================================================================== å…¶ä»–ç›¸å…³ç¬”è®°ï¼š JVMç¬”è®°ï¼ˆä¸€ï¼‰javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºä»¥åŠå¯¹è±¡çš„åˆ›å»ºã€å¸ƒå±€å’Œå®šä½JVMç¬”è®°ï¼ˆä¸‰ï¼‰åƒåœ¾æ”¶é›†ç®—æ³•ä»¥åŠHotSpotçš„ç®—æ³•å®ç°(å®‰å…¨ç‚¹ã€è®°å¿†é›†ä¸å¡è¡¨ã€å†™å±éšœã€ä¸‰è‰²æ ‡è®°ç­‰)JVMç¬”è®°ã€Šå››ã€‹ä¸ƒä¸ªå¸¸è§çš„åƒåœ¾æ”¶é›†å™¨================================================================ å‚è€ƒï¼šã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœºç¬¬ä¸‰ç‰ˆã€‹","link":"/posts/20200316-JVM-obj-reference.html"},{"title":"JVMç¬”è®°ã€Šäº”ã€‹Classæ–‡ä»¶ç»“æ„","text":"ä¸€ã€Classæ–‡ä»¶ç»“æ„ ä»»ä½•ä¸€ä¸ªClassæ–‡ä»¶éƒ½å¯¹åº”ç€å”¯ä¸€çš„ä¸€ä¸ªç±»æˆ–æ¥å£çš„å®šä¹‰ä¿¡æ¯ ä½†ç±»æˆ–æ¥å£å¹¶ä¸ä¸€å®šéƒ½å¾—å®šä¹‰åœ¨æ–‡ä»¶é‡Œï¼ˆä¹Ÿå¯èƒ½æ˜¯åŠ¨æ€ç”Ÿæˆç›´æ¥é€å…¥ç±»åŠ è½½å™¨ä¸­ï¼‰ æ˜¯ä»¥8å­—èŠ‚ä¸ºåŸºç¡€å•ä½çš„äºŒè¿›åˆ¶æµï¼Œè¶…è¿‡8å­—èŠ‚æ—¶ï¼ŒæŒ‰ç…§é«˜ä½åœ¨å‰åˆ†å‰²æˆè‹¥å¹²ä¸ª8å­—èŠ‚å­˜å‚¨ æ–‡ä»¶æ ¼å¼ï¼š æ— ç¬¦å·æ•° å±äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œä»¥u1,u2,u4,u8åˆ†åˆ«ä»£è¡¨1,2,4,8å­—èŠ‚çš„æ— ç¬¦å·æ•°ï¼Œå¯ç”¨æ¥æè¿°æ•°å­—ã€ç´¢å¼•å¼•ç”¨ã€æ•°é‡å€¼æˆ–æŒ‰UTF-8æ„æˆçš„å­—ç¬¦ä¸²å€¼ã€‚ è¡¨ ç”±å¤šä¸ªæ— ç¬¦å·æ•°æˆ–å…¶ä»–è¡¨æ„æˆçš„ç¬¦åˆæ•°æ®ç±»å‹ã€‚ä¹ æƒ¯ä»¥â€_infoâ€ç»“å°¾ å½“éœ€è¦æè¿°åŒä¸€ç±»å‹ä½†æ•°é‡ä¸ç¡®å®šçš„å¤šä¸ªæ•°æ®æ—¶ï¼Œç»å¸¸ä½¿ç”¨ä¸€ä¸ªå‰ç½®çš„å®¹é‡è®¡æ•°å™¨åŠ è‹¥å¹²ä¸ªè¿ç»­çš„æ•°æ®é¡¹çš„å½¢å¼ã€‚ç§°è¿™ä¸€ç³»åˆ—è¿ç»­çš„æŸä¸€ç±»å‹çš„æ•°æ®ä¸ºæŸä¸€ç±»å‹çš„â€œé›†åˆâ€ã€‚ 1.1 é­”æ•°ä¸Classæ–‡ä»¶çš„ç‰ˆæœ¬ å¤´å››ä¸ªå­—èŠ‚ é­”æ•° ä½œç”¨ï¼šç¡®å®šè¯¥Classæ–‡ä»¶æ˜¯å¦èƒ½è¢«è™šæ‹Ÿæœºæ¥æ”¶ å€¼ï¼š0xCAFEBABE(å’–å•¡å®è´) ç¬¬4åˆ°8ä¸ªå­—èŠ‚ 5~6ï¼š æ¬¡ç‰ˆæœ¬å· 7~8ï¼šä¸»ç‰ˆæœ¬å· é«˜ç‰ˆæœ¬jdkå…¼å®¹ä½ç‰ˆæœ¬ 12345678public class TestClass { private int m; public int inc(){ return m+1; }} ä»¥ä¸Šè¿°ä»£ç ä¸ºä¾‹çš„å­—èŠ‚ç æ–‡ä»¶å¦‚ä¸‹ï¼š å¤´4ä¸ªå­—èŠ‚ä¸º0xCAFEBABEï¼Œæ¬¡ç‰ˆæœ¬å·ä¸ºï¼š0x0000 ä¸»ç‰ˆæœ¬å·ä¸ºï¼š0x0034 å¯¹åº”åè¿›åˆ¶çš„52 jdk8åŠä»¥ä¸Šç‰ˆæœ¬å¯æ‰§è¡Œè¯¥classæ–‡ä»¶ 1.2 å¸¸é‡æ± ä¸»æ¬¡ç‰ˆæœ¬åçš„æ˜¯å¸¸é‡æ± å…¥å£ å…¥å£ä½¿ç”¨ä¸€ä¸ªu2ç±»å‹çš„æ•°æ®ï¼Œè¡¨ç¤ºå¸¸é‡æ± å®¹é‡è®¡æ•°å€¼ è¯¥å€¼ä»1å¼€å§‹ã€‚å¦‚ä¸Šå›¾çš„ç¬¬8,9ä½ï¼Œ0x0016ï¼Œå¯¹åº”åè¿›åˆ¶ä¸º22ï¼Œç´¢å¼•èŒƒå›´ä¸º1-21ï¼Œè¡¨ç¤ºå¸¸é‡æ± æœ‰21ä¸ªå¸¸é‡ã€‚ ç¬¬0é¡¹ç©ºå‡ºçš„ç›®çš„ï¼š è‹¥åé¢æŸäº›æŒ‡å‘å¸¸é‡æ± çš„ç´¢å¼•å€¼çš„æ•°æ®åœ¨ç‰¹å®šæƒ…å†µä¸‹è¦è¡¨è¾¾â€œä¸å¼•ç”¨ä»»ä½•ä¸€ä¸ªå¸¸é‡æ± â€çš„å«ä¹‰ï¼Œå¯æŠŠç´¢å¼•å€¼è®¾ä¸º0è¡¨ç¤ºã€‚ å¸¸é‡æ± å­˜æ”¾å†…å®¹ å­—é¢é‡ï¼ˆæ–‡æœ¬å­—ç¬¦ä¸²ã€finalå¸¸é‡å€¼ç­‰ï¼‰å’Œç¬¦å·å¼•ç”¨ï¼ˆåŒ…ã€ç±»å’Œæ¥å£çš„å…¨é™å®šåã€å­—æ®µå’Œæ–¹æ³•çš„åå’Œæè¿°ç¬¦ã€æ–¹æ³•å¥æŸ„å’Œç±»å‹ã€åŠ¨æ€è°ƒç”¨ç‚¹å’ŒåŠ¨æ€å¸¸é‡ï¼‰ å¸¸é‡æ± çš„æ¯ä¸€é¡¹å¸¸é‡éƒ½æ˜¯ä¸€ä¸ªè¡¨ï¼š è¡¨ç»“æ„ä¸ºï¼š ç¬¬ä¸€ä½æ˜¯ u1ç±»å‹çš„æ ‡å¿—ä½ï¼ˆtagï¼Œå–å€¼è§ä¸‹è¡¨ï¼‰ï¼Œè¡¨ç¤ºå½“å‰å¸¸é‡å±äºå“ªä¸ªå¸¸é‡ç±»å‹ å¦å¤–ä¸ºäº†æ”¯æŒjavaæ¨¡å—åŒ–ç³»ç»Ÿï¼ŒåˆåŠ å…¥äº† CONSTANT_Module_infoå’ŒCONSTANT_Package_infoä¸¤ä¸ªå¸¸é‡ å†çœ‹ä¸Šé¢çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œç¬¬ä¸€é¡¹å¸¸é‡ï¼Œæ ‡å¿—ä½ä¸º0x0Aï¼Œä¸º10è¿›åˆ¶çš„10ï¼ŒæŸ¥ä¸Šè¡¨å¾—çŸ¥å±äº CONSTANT_Methodref_infoç±»å‹ä»£è¡¨ç±»ä¸­æ–¹æ³•çš„å¼•ç”¨ã€‚ javapå‘½ä»¤å‚æ•°ï¼š 1234567891011121314hep --hep -? è¾“å‡ºæ­¤ç”¨æ³•æ¶ˆæ¯-version ç‰ˆæœ¬ä¿¡æ¯ï¼Œå…¶å®æ˜¯å½“å‰javapæ‰€åœ¨jdkçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œä¸æ˜¯cassåœ¨å“ªä¸ªjdkä¸‹ç”Ÿæˆçš„ã€‚-v -verbose è¾“å‡ºé™„åŠ ä¿¡æ¯ï¼ˆåŒ…æ‹¬è¡Œå·ã€æœ¬åœ°å˜é‡è¡¨ï¼Œåæ±‡ç¼–ç­‰è¯¦ç»†ä¿¡æ¯ï¼‰- è¾“å‡ºè¡Œå·å’Œæœ¬åœ°å˜é‡è¡¨-pubic ä»…æ˜¾ç¤ºå…¬å…±ç±»å’Œæˆå‘˜-protected æ˜¾ç¤ºå—ä¿æŠ¤çš„/å…¬å…±ç±»å’Œæˆå‘˜-package æ˜¾ç¤ºç¨‹åºåŒ…/å—ä¿æŠ¤çš„/å…¬å…±ç±» å’Œæˆå‘˜ (é»˜è®¤)-p -private æ˜¾ç¤ºæ‰€æœ‰ç±»å’Œæˆå‘˜-c å¯¹ä»£ç è¿›è¡Œåæ±‡ç¼–-s è¾“å‡ºå†…éƒ¨ç±»å‹ç­¾å-sysinfo æ˜¾ç¤ºæ­£åœ¨å¤„ç†çš„ç±»çš„ç³»ç»Ÿä¿¡æ¯ (è·¯å¾„, å¤§å°, æ—¥æœŸ, MD5 æ•£åˆ—)-constants æ˜¾ç¤ºé™æ€æœ€ç»ˆå¸¸é‡-casspath &amp;t;path&gt; æŒ‡å®šæŸ¥æ‰¾ç”¨æˆ·ç±»æ–‡ä»¶çš„ä½ç½®-bootcasspath &amp;t;path&gt; è¦†ç›–å¼•å¯¼ç±»æ–‡ä»¶çš„ä½ç½® å¯¹ä¸Šè¿°ä»£ç è¿›è¡Œjavap -verbose TestClass.class å¾—åˆ°å¦‚ä¸‹å¸¸é‡æ± çš„21é¡¹å¸¸é‡å†…å®¹ï¼š 12345678910111213141516171819202122Constant pool: #1 = Methodref #4.#18 // java/lang/Object.\"&lt;init&gt;\":()V #2 = Fieldref #3.#19 // com/wml/jvm/classtructure/TestClass.m:I #3 = Class #20 // com/wml/jvm/classtructure/TestClass #4 = Class #21 // java/lang/Object #5 = Utf8 m #6 = Utf8 I #7 = Utf8 &lt;init&gt; #8 = Utf8 ()V #9 = Utf8 Code #10 = Utf8 LineNumberTable #11 = Utf8 LocalVariableTable #12 = Utf8 this #13 = Utf8 Lcom/wml/jvm/classtructure/TestClass; #14 = Utf8 inc #15 = Utf8 ()I #16 = Utf8 SourceFile #17 = Utf8 TestClass.java #18 = NameAndType #7:#8 // \"&lt;init&gt;\":()V #19 = NameAndType #5:#6 // m:I #20 = Utf8 com/wml/jvm/classtructure/TestClass #21 = Utf8 java/lang/Object 1.3 è®¿é—®æ ‡å¿—å¸¸é‡æ± åç´§æ¥ç€çš„ä¸¤ä¸ªå­—èŠ‚ä»£è¡¨è®¿é—®æ ‡å¿—ã€‚ ç”¨äºè¯†åˆ«ä¸€äº›ç±»æˆ–æ¥å£å±‚æ¬¡çš„è®¿é—®å˜»å˜»ï¼š Classæ˜¯ç±»è¿˜æ˜¯æ¥å£ï¼› æ˜¯å¦ä¸ºpublicï¼› æ˜¯å¦ä¸ºabstractï¼› ç±»æ˜¯å¦è¢«å£°æ˜ä¸ºfinalç­‰ ACC_MODULE 0x8000 æ ‡è¯†è¿™æ˜¯ä¸€ä¸ªæ¨¡å— accsess_flagså…±æœ‰16ä¸ªæ ‡å¿—ä½å¯ç”¨ï¼Œå½“å‰åªå®šä¹‰äº†9ä¸ªï¼Œæ²¡æœ‰ç”¨åˆ°çš„æ ‡å¿—ä½ä¸€å¾‹ä¸ºé›¶ 1.4 ç±»ç´¢å¼•ã€çˆ¶ç±»ç´¢å¼•å’Œæ¥å£ç´¢å¼•é›†åˆ ç±»ç´¢å¼• ç¡®å®šè¯¥ç±»çš„å…¨é™å®šå çˆ¶ç±»ç´¢å¼• ç¡®å®šè¯¥ç±»çš„çˆ¶ç±»çš„å…¨é™å®šå é™¤äº†Objectç±»ä¹‹å¤–ï¼Œæ‰€æœ‰çš„javaç±»éƒ½æœ‰çˆ¶ç±»ï¼Œå› æ­¤é™¤Objectç±»å¤–çš„æ‰€æœ‰ç±»çš„çˆ¶ç±»ç´¢å¼•éƒ½ä¸ä¸º0 æ¥å£ç´¢å¼•é›†åˆ æè¿°è¯¥ç±»å®ç°äº†å“ªäº›æ¥å£ã€‚è¿™äº›å®ç°çš„æ¥å£æŒ‰implementså…³é”®å­—åçš„æ¥å£é¡ºåºä»å·¦åˆ°å³å†æ¥å£ç´¢å¼•é›†åˆä¸­ ç±»ç´¢å¼•å’Œçˆ¶ç±»ç´¢å¼•éƒ½ç”¨ä¸¤ä¸ªu2ç±»å‹çš„ç´¢å¼•å€¼è¡¨ç¤ºï¼Œå„è‡ªæŒ‡å‘ä¸€ä¸ªç±»å‹ä¸ºCONSTANT_Class_infoçš„ç±»æè¿°ç¬¦å¸¸é‡ æ¥å£ç´¢å¼•é›†åˆï¼Œå…¥å£çš„ç¬¬ä¸€é¡¹u2ç±»å‹çš„æ•°æ®ä¸ºæ¥å£è®¡æ•°å™¨ï¼Œè¡¨ç¤ºç´¢å¼•è¡¨çš„å®¹é‡ã€‚å¦‚æœè¯¥ç±»æ²¡æœ‰å®ç°ä»»ä½•æ¥å£ï¼Œåˆ™è¯¥è®¡æ•°å™¨ä¸º0 1.5 å­—æ®µè¡¨é›†åˆæè¿°æ¥å£æˆ–ç±»ä¸­å£°æ˜çš„å˜é‡ã€‚ æè¿°ä¸€ä¸ªå­—æ®µå¯åŒ…å«çš„ä¿¡æ¯ï¼š ä¿®é¥°ç¬¦ï¼ˆpublic/private/protectedï¼‰ å®ä¾‹å˜é‡ or ç±»å˜é‡ï¼ˆstaticä¿®é¥°ç¬¦ï¼‰ å¯å˜æ€§ï¼ˆfinalï¼‰ å¹¶å‘å¯è§æ€§ï¼ˆvolatileä¿®é¥°ç¬¦ï¼‰ æ˜¯å¦è¢«åºåˆ—åŒ– å­—æ®µæ•°æ®ç±»å‹ï¼ˆåŸºæœ¬ã€å¯¹è±¡ã€æ•°ç»„ï¼‰ å­—æ®µåç§° ä»¥ä¸Šä¿¡æ¯å„ä¸ªä¿®é¥°ç¬¦éƒ½æ˜¯å¸ƒå°”å€¼ï¼Œé€‚åˆç”¨æ ‡å¿—ä½ã€‚ å­—æ®µè¡¨ç»“æ„ è¡¨ ç±»å‹ åç§° æ•°é‡ u2 access_flags 1 u2 name_inedx 1 u2 descriptor_index 1 u2 attributes_count 1 attribute_info attributes attributes_count å­—æ®µè®¿é—®æ ‡å¿— æ ‡å¿—åç§° æ ‡å¿—å€¼ å«ä¹‰ ACC_PUBLIC 0x0001 æ˜¯å¦public ACC_PRIVATE 0x0002 æ˜¯å¦private ACC_PROTECTED 0x0004 æ˜¯å¦protected ACC_STATIC 0x0008 æ˜¯å¦static ACC_FINAL 0x0010 æ˜¯å¦final ACC_VOLATILE 0x0040 æ˜¯å¦volatile ACC_TRANSITENT 0x0080 æ˜¯å¦transient ACC_SYNTHETIC 0x1000 æ˜¯å¦ç”±ç¼–è¯‘æœŸè‡ªåŠ¨äº§ç”Ÿ ACC_ENUM 0x4000 æ˜¯å¦enum name_indexå’Œdescriptor_indexéƒ½æ˜¯å¯¹å¸¸é‡æ± é¡¹çš„å¼•ç”¨ï¼Œåˆ†åˆ«ä»£è¡¨å­—æ®µçš„ç®€å•åç§°å’Œå­—æ®µå’Œæ–¹æ³•çš„æè¿°ç¬¦ã€‚ â€‹ æè¿°ç¬¦æ ‡è¯†å­—ç¬¦å«ä¹‰ï¼š æ ‡è¯†å­—ç¬¦ å«ä¹‰ B byte C char D double F float I int J long S short z boolean V ç‰¹æ®Šç±»å‹ void L å¯¹è±¡ç±»å‹ æ•°ç»„ç±»å‹ æ¯ä¸€ç»´ä½¿ç”¨ä¸€ä¸ªå‰ç½®çš„ â€œ [ â€œ å­—ç¬¦æè¿°ï¼Œå¦‚ï¼šjava.lang.String[] [] è¢«è®°å½•æˆ [[Ljava/lang/String; æè¿°æ–¹æ³•æ—¶ æŒ‰å…ˆå‚æ•°åˆ—è¡¨ï¼Œåè¿”å›å€¼çš„é¡ºåºæè¿° å¦‚ æ–¹æ³• void inc() â€”â€”â€“&gt; () V æ–¹æ³•int indexof(char[] source,int sourceOffset,int sourceCount,char[] target,int targetOffset,int targetCount,int fromIndex) â€”â€”&gt; ([CII[CIII)I 1.6 æ–¹æ³•é›†åˆæ–¹æ³•è¡¨ç»“æ„å’Œå­—æ®µè¡¨ç»“æ„å‡ ä¹ä¸€è‡´ æ–¹æ³•è¡¨ç»“æ„ ç±»å‹ åç§° æ•°é‡ u2 access_flags 1 u2 name_inedx 1 u2 descriptor_index 1 u2 attributes_count 1 attribute_info attributes attributes_count æ–¹æ³•è®¿é—®æ ‡å¿—ï¼š æ ‡å¿—åç§° æ ‡å¿—å€¼ å«ä¹‰ ACC_PUBLIC 0x0001 æ˜¯å¦public ACC_PRIVATE 0x0002 æ˜¯å¦private ACC_PROTECTED 0x0004 æ˜¯å¦protected ACC_STATIC 0x0008 æ˜¯å¦static ACC_FINAL 0x0010 æ˜¯å¦final ACC_SYNCHRONIZED 0x0020 æ˜¯å¦ä¸ºsynchronize ACC_BRIDGE 0x0040 æ˜¯å¦transient ACC_SYNTHETIC 0x1000 æ˜¯å¦ç”±ç¼–è¯‘æœŸè‡ªåŠ¨äº§ç”Ÿ ACC_VARARGS 0x0080 æ˜¯å¦æ¥å—ä¸å®šå‚æ•° ACC_NATIVE 0x0100 æ˜¯å¦ä¸ºnative ACC_ABSTRACT 0x0400 æ˜¯å¦ä¸ºabstract ACC_STRICT 0x0800 æ˜¯å¦ä¸ºstrictfp æ–¹æ³•ä¸­çš„ä»£ç ç»è¿‡ç¼–è¯‘åå­˜æ”¾åœ¨æ–¹æ³•å±æ€§è¡¨é›†åˆä¸­ä¸€ä¸ªå«â€œCodeâ€çš„å±æ€§é‡Œé¢ã€‚ æ–¹æ³•è¡¨é›†åˆä¸­æœ‰å¯èƒ½ä¼šå‡ºç°ç¼–è¯‘æœŸè‡ªåŠ¨æ·»åŠ çš„æ–¹æ³•ï¼Œå¦‚ï¼š &lt;clinit&gt;()æ–¹æ³•å’Œå®ä¾‹æ„é€ å™¨&lt;init&gt;()æ–¹æ³• 1.7 å±æ€§è¡¨1.7.1Codeå±æ€§å­˜æ”¾æ–¹æ³•ä½“é‡Œçš„ä»£ç ç»è¿‡javacç¼–è¯‘å¤„ç†åçš„å­—èŠ‚ç æŒ‡ä»¤ å±æ€§è¡¨ç»“æ„å¦‚ä¸‹ï¼š ç±»å‹ åç§° æ•°é‡ u2 attribute_name_index 1 u4 attrtbute_length 1 u2 max_stack 1 u2 max_localss 1 u4 code_length 1 u1 code code_length u2 exception_table_length 1 exception_info exception_table exception_table_length u2 attributes_count 1 attribute_info attributes attributes_count attribute_name_index æŒ‡å‘COUNSTANT_Utf8_infoå‹å¸¸é‡çš„ç´¢å¼•ï¼Œå›ºå®šä¸ºâ€Codeâ€ï¼Œä»£è¡¨è¯¥å±æ€§çš„å±æ€§åç§° attrtbute_length å±æ€§å€¼çš„é•¿åº¦ max_stack æ“ä½œæ•°æ ˆæ·±åº¦çš„æœ€å¤§å€¼ã€‚è™šæ‹Ÿæœºè¿è¡Œæ—¶éœ€è¦æ ¹æ®è¯¥å€¼åˆ†é…æ ˆå¸§ max_locals å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ã€‚å•ä½ï¼šæ§½(Slot) 32ä½ä»¥ä¸‹çš„æ•°æ®ç±»å‹ï¼Œæ¯ä¸ªå±€éƒ¨å˜é‡å ç”¨1ä¸ªå˜é‡æ§½ doubleå’Œlongè¿™ç§64ä½çš„æ•°æ®ç±»å‹éœ€è¦ä¸¤ä¸ªå˜é‡æ§½å­˜æ”¾ code_lengthå’Œcode å­˜å‚¨javaæºç¨‹åºç¼–è¯‘åç”Ÿæˆçš„å­—èŠ‚ç æŒ‡ä»¤ code_lenghtï¼šè¡¨ç¤ºå­—èŠ‚ç é•¿åº¦ codeï¼šæ˜¯ç”¨äºå­˜å‚¨å­—èŠ‚ç æŒ‡ä»¤çš„ä¸€ç³»åˆ—å­—èŠ‚æµ å¼‚å¸¸è¡¨ ç±»å‹ åç§° æ•°é‡ u2 start_pc 1 u2 end_pc 1 u2 handler_pc 1 u2 catch_type 1 å«ä¹‰ï¼š å¦‚æœå½“å­—èŠ‚ç ä»ç¬¬start_pcè¡Œåˆ°ç¬¬end_pcè¡Œä¹‹é—´ï¼Œå‡ºç°äº†ç±»å‹ä¸ºcatch_typeæˆ–è€…å…¶å­ç±»çš„å¼‚å¸¸ï¼ˆcatch_typeä¸ºæŒ‡å‘ä¸€ä¸ªCONSTANT_Class_infoå¸¸é‡çš„ç´¢å¼•ï¼‰ï¼Œåˆ™è½¬åˆ°handler_pcè¡Œç»§ç»­å¤„ç†ã€‚ å½“catch_typeä¸º0æ—¶ï¼Œä»£è¡¨ä»»æ„å¼‚å¸¸æƒ…å†µéƒ½éœ€è¦è½¬åˆ°handler_pcè¡Œå¤„ç†ã€‚ 1.7.2 Exceptionså±æ€§åˆ—ä¸¾å‡ºæ–¹æ³•ä¸­å¯èƒ½æŠ›å‡ºçš„å—æŸ¥å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•æè¿°æ—¶åœ¨throwså…³é”®å­—åé¢åˆ—ä¸¾çš„å¼‚å¸¸ ç±»å‹ åç§° æ•°é‡ u2 attribute_name_index 1 u4 attribute_length 1 u2 number_of_exceptions 1 u2 exception_index_table number_of_exceptions 1.7.3 LineNumberTableå±æ€§æè¿°æºç è¡Œå·ä¸å­—èŠ‚ç è¡Œå·é—´çš„å…³ç³» ç±»å‹ åç§° æ•°é‡ u2 attribute_name_index 1 u4 attribute_length 1 u2 line_number_table_length 1 line_number_info line_numbe_table line_number_table_length 1.7.4 LocalVariableTableå’ŒLocalVariableTypeTableLocalVariableTableæè¿°æ ˆå¸§ä¸­å±€éƒ¨å˜é‡è¡¨çš„å˜é‡å’Œæºç ä¸­å®šä¹‰çš„å˜é‡é—´çš„å…³ç³»ã€‚ ç±»å‹ åç§° æ•°é‡ u2 attribute_name_index 1 u4 attribute_length 1 u2 local_variable_table_length 1 local_variable_info local_variable_table local_variable_table_length local_variable_infoä»£è¡¨äº†ä¸€ä¸ªæ ˆå¸§ä¸æºç ä¸­çš„å±€éƒ¨å˜é‡çš„å…³è”","link":"/posts/20200318-null.html"},{"title":"ä¸€æ–‡ææ‡‚Springå®¹å™¨åˆå§‹åŒ–æœºåˆ¶","text":"Springå®¹å™¨åŠ è½½çš„æ–¹å¼ ClassPathXmlApplicationContextï¼šç±»è·¯å¾„è·å–é…ç½®æ–‡ä»¶ FileSystemXmlApplicationCnotextï¼šæ–‡ä»¶ç³»ç»Ÿè·¯å¾„è·å–é…ç½®æ–‡ä»¶ã€ç»å¯¹è·¯å¾„ã€‘ AnnotationConfigApplicationContextï¼šæ— é…ç½®æ–‡ä»¶åŠ è½½å®¹å™¨ EmbeddedWebApplicationContextï¼šSpringbootåŠ è½½å®¹å™¨ ä»¥ClassPathXmlApplicationContextåŠ è½½ä¸ºä¾‹è®²è§£æºç ï¼š newä¸€ä¸ªClassPathApplicationContextæ—¶ï¼Œä¸»è¦è°ƒç”¨çš„æ˜¯refreshæ–¹æ³•ï¼š Springå®¹å™¨çš„åˆå§‹åŒ–æœºåˆ¶1.refresh() è¯¥æ–¹æ³•æ˜¯springå®¹å™¨åˆå§‹åŒ–çš„æ ¸å¿ƒæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨äº†çˆ¶ç±»æ¨¡æ¿è®¾è®¡æ¨¡å¼ï¼Œ æ ¹æ®ä¸åŒçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œä¼šåœ¨å­ç±»ä¸­æä¾›ä¸åŒçš„å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445@Override public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { //ä¸ºå®¹å™¨åˆå§‹åŒ–åšå‡†å¤‡ï¼Œå¯ä»¥ä¸çœ‹ prepareRefresh(); /* * ä¸»è¦çœ‹obtainFreshBeanFactoryï¼Œéƒ½åœ¨è¿™é‡Œè¿›è¡Œåˆå§‹åŒ– */ ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // Prepare the bean factory for use in this context. prepareBeanFactory(beanFactory); try { // å­ç±»æ‰©å±•ç”¨ï¼Œå¯ä»¥è®¾ç½®beançš„åç½®å¤„ç†å™¨ï¼ˆbeanåœ¨å®ä¾‹åŒ–ä¹‹åè¿™äº›åç½®å¤„ç†å™¨ä¼šæ‰§è¡Œï¼‰ postProcessBeanFactory(beanFactory); // æ‰§è¡ŒbeanFactoryåç½®å¤„ç†å™¨ï¼ˆæœ‰åˆ«äºbeanåç½®å¤„ç†å™¨å¤„ç†beanå®ä¾‹ï¼ŒbeanFactoryåç½®å¤„ç†å™¨å¤„ç†beanå®šä¹‰ï¼‰ invokeBeanFactoryPostProcessors(beanFactory); // Register bean processors that intercept bean creation. registerBeanPostProcessors(beanFactory); // åˆå§‹åŒ–å›½é™…åŒ–æœåŠ¡ initMessageSource(); // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨ã€‚ initApplicationEventMulticaster(); // Initialize other special beans in specific context subclasses. onRefresh(); // Check for listener beans and register them. registerListeners(); // Instantiate all remaining (non-lazy-init) singletons. finishBeanFactoryInitialization(beanFactory); // Last step: publish corresponding event. finishRefresh(); } ....... } } 2.obtainFreshBeanFactory()ï¼šè¯¥æ–¹æ³•ä¸»è¦ç”¨äºåˆ›å»ºBeanFactoryï¼Œå¦‚æœæœ‰å°±é”€æ¯ï¼Œæ²¡æœ‰å°±åˆ›å»ºï¼Œç„¶åè¿›è¡Œè§£æxmlï¼Œå†…éƒ¨è°ƒç”¨refreshBeanFactoryæ–¹æ³•. åˆ›å»ºBeanFactory 12345678910111213141516171819202122232425@Override protected final void refreshBeanFactory() throws BeansException { //å¦‚æœBeanFactoryä¸ä¸ºç©ºï¼Œåˆ™æ¸…é™¤BeanFactoryå’Œé‡Œé¢çš„å®ä¾‹ if (hasBeanFactory()) { destroyBeans(); closeBeanFactory(); } try { //åˆ›å»ºDefaultListableBeanFactory DefaultListableBeanFactory beanFactory = createBeanFactory(); beanFactory.setSerializationId(getId()); //è®¾ç½®æ˜¯å¦å¯ä»¥å¾ªç¯ä¾èµ– allowCircularReferences //æ˜¯å¦å…è®¸ä½¿ç”¨ç›¸åŒåç§°é‡æ–°æ³¨å†Œä¸åŒçš„beanå®ç°. customizeBeanFactory(beanFactory); //ä¸»è¦çœ‹è¯¥æ–¹æ³•ï¼Œè§£æxmlï¼Œå¹¶æŠŠxmlä¸­çš„æ ‡ç­¾å°è£…æˆBeanDefinitionå¯¹è±¡ loadBeanDefinitions(beanFactory); synchronized (this.beanFactoryMonitor) { this.beanFactory = beanFactory; } } ......... } 3.loadBeanDefinitions()æ ¹æ®beanFactoryåˆ›å»ºxmlè§£æå™¨XmlBeanDefinitionReader 1234567891011121314151617@Override protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException { //****1.åˆ›å»ºxmlçš„è§£æå™¨ï¼Œã€å§”æ‰˜æ¨¡å¼ã€‘*** XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); beanDefinitionReader.setEnvironment(this.getEnvironment()); //è¿™é‡Œä¼ å…¥thisï¼Œå› ä¸ºApplicationContexté¡¶çº§æ¥å£å®ç°äº†ResourceLoaderæ¥å£ beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); //åˆå§‹åŒ–BeanDefinitionReaderï¼Œä¸ç”¨çœ‹ initBeanDefinitionReader(beanDefinitionReader); //***********ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³• ****** loadBeanDefinitions(beanDefinitionReader); } loadBeanDefinitionså†…éƒ¨ä¼šéå†æ‰€æœ‰é…ç½®æ–‡ä»¶ç„¶åæ‰§è¡ŒXmlBeanDefinitionReaderçš„loadBeanDefinitionsæ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š è¯¥æ–¹æ³•ä¸»è¦å°†xmlé…ç½®æ–‡ä»¶ç”¨æµçš„æ–¹å¼å°è£…ä¸ºResourceå¯¹è±¡ï¼Œç„¶åå¯¹è¯¥å¯¹è±¡è¿›è¡Œè§£æ 12345678910111213141516171819public int loadBeanDefinitions(String location, @Nullable Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException { ResourceLoader resourceLoader = getResourceLoader(); ................. if (resourceLoader instanceof ResourcePatternResolver) { // Resource pattern matching available. try { //ç”¨æµçš„æ–¹å¼åŠ è½½xmlé…ç½®æ–‡ä»¶ï¼Œå°è£…æˆResourceå¯¹è±¡ï¼Œ Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location); //2.è§£æè¢«å°è£…æˆçš„Resourceå¯¹è±¡ int count = loadBeanDefinitions(resources); ........ return count; } ............ } ........ } é€‰ç”¨Xmlæ–¹å¼è§£æbeanï¼ŒloadBeanDefinitionsï¼Œå› æ­¤ä¸»è¦çœ‹å­ç±»XmlBeanDefinitionReaderå¯¹è¯¥ç±»çš„å®ç°ï¼š EncodedResourceæ˜¯å¸¦ç¼–ç çš„Resourceå¯¹è±¡ï¼Œè¿™é‡Œå°†ä¼ å…¥çš„Resourceå°è£…æˆäº†EncodedResourceï¼š 123456789101112131415public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException { ............... try { //è·å–Resourceå¯¹è±¡ä¸­çš„xmlæ–‡ä»¶æµå¯¹è±¡ InputStream inputStream = encodedResource.getResource().getInputStream(); try { //è·å–InputSourceï¼Œç”¨äºè§£æxml InputSource inputSource = new InputSource(inputStream); ............. } //å…·ä½“åœ¨è¿™è§£æ return doLoadBeanDefinitions(inputSource, encodedResource.getResource()); } ........... } doLoadBeanDefinitions():åˆ°è¿™é‡Œï¼Œæœ€ç»ˆå°†å‰é¢çš„Resourceå°è£…æˆäº†Documentå¯¹è±¡ 1234567891011121314protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException { try { //æŠŠinputSource å°è£…æˆDocumentæ–‡ä»¶å¯¹è±¡ Document doc = doLoadDocument(inputSource, resource); //ä¸»è¦çœ‹è¯¥æ–¹æ³•ï¼Œæ ¹æ®è§£æå‡ºæ¥çš„documentå¯¹è±¡ï¼Œæ‹¿åˆ°é‡Œé¢çš„æ ‡ç­¾å…ƒç´ å°è£…æˆBeanDefinition int count = registerBeanDefinitions(doc, resource); ................ return count; } ............. } 4.registerBeanDefinitions()åˆ›å»ºBeanDefinitionDocumentReaderå¯¹è±¡ï¼Œè°ƒç”¨å…¶registerBeanDefinitionsæ–¹æ³•è§£ædocument 12345678public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException { //å§”æ‰˜BeanDefinitionDocumentReaderç±»è§£ædocument BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); int countBefore = getRegistry().getBeanDefinitionCount(); //ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•ï¼ŒcreateReaderContext(resource) XmlReaderContextä¸Šä¸‹æ–‡ï¼Œå°è£…äº†XmlBeanDefinitionReaderå¯¹è±¡ documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); return getRegistry().getBeanDefinitionCount() - countBefore;} æœ€ç»ˆä¼šè°ƒç”¨doRegisterBeanDefinitions doRegisterBeanDefinitionsrootä¸ºdocumentçš„æ ¹èŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡rootè®¿é—®æ‰€æœ‰å­©å­èŠ‚ç‚¹ BeanDefinitionParserDelegateå¯¹è±¡delegateæ˜¯ä¸€ä¸ªå§”æ‰˜ç±»ï¼Œç”¨æ¥è¾…åŠ©è§£æbean 123456789101112protected void doRegisterBeanDefinitions(Element root) { BeanDefinitionParserDelegate parent = this.delegate; this.delegate = createDelegate(getReaderContext(), root, parent); ..... preProcessXml(root); //è¯¥æ–¹æ³•å¼€å§‹è¿›è¡Œæ ‡ç­¾è§£æ parseBeanDefinitions(root, this.delegate); postProcessXml(root); this.delegate = parent; } 5.parseBeanDefinitions()è¯¥æ–¹æ³•é€šè¿‡éå†æ ¹èŠ‚ç‚¹çš„å­©å­ï¼Œè§£ææ ‡ç­¾ã€‚ æ ¹æ®ç±»å‹ä¸åŒï¼Œæœ‰å¯¹é»˜è®¤æ ‡ç­¾çš„è§£æè¿˜æœ‰å¯¹è‡ªå®šä¹‰æ ‡ç­¾çš„è§£æ 12345678910111213141516171819202122protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) { if (delegate.isDefaultNamespace(root)) { NodeList nl = root.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) { Node node = nl.item(i); if (node instanceof Element) { Element ele = (Element) node; if (delegate.isDefaultNamespace(ele)) { //è§£æé»˜è®¤æ ‡ç­¾ parseDefaultElement(ele, delegate); } else { //è§£æè‡ªå®šä¹‰æ ‡ç­¾ delegate.parseCustomElement(ele); } } } } else { delegate.parseCustomElement(root); } } 5.1parseDefaultElementè§£æé»˜è®¤æ ‡ç­¾ 123456789101112131415161718private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) { //importæ ‡ç­¾è§£æ if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) { importBeanDefinitionResource(ele); } //aliasæ ‡ç­¾è§£æ else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) { processAliasRegistration(ele); } //beanæ ‡ç­¾ else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) { processBeanDefinition(ele, delegate); } else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) { // beansæ ‡ç­¾ï¼Œé€’å½’è°ƒç”¨doRegisterBeanDefinitions doRegisterBeanDefinitions(ele); } } 5.1.1 processBeanDefinitionè§£æbeanæ ‡ç­¾ ä¸»è¦çœ‹å¯¹beanæ ‡ç­¾çš„è§£æ 123456789101112131415161718192021protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) { //***********ä»£ç 1.è§£æbeanæ ‡ç­¾ï¼Œå°è£…æˆBeanDefinition***** BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if (bdHolder != null) { //ä»£ç 2.è¿™é‡Œä¸»è¦è¿ç”¨è£…é¥°è€…è®¾è®¡æ¨¡å¼å’ŒSPIè®¾è®¡æ€æƒ³è¿›è¡Œè£…é¥° bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try { //ä»£ç 3ï¼šå¯¹BeanDefinitionå¯¹è±¡è¿›è¡Œç¼“å­˜æ³¨å†Œ // Register the final decorated instance. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); } catch (BeanDefinitionStoreException ex) { getReaderContext().error(\"Failed to register bean definition with name '\" + bdHolder.getBeanName() + \"'\", ele, ex); } // Send registration event. getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); }} parseBeanDefinitionElement å…·ä½“è§£æbeançš„æ–¹æ³•ï¼Œå…ˆå¤„ç†beanNameä»¥åŠåˆ«ååï¼Œå†è§£æbean 123456789101112131415161718192021222324252627282930public BeanDefinitionHolder parseBeanDefinitionElement(Element ele, @Nullable BeanDefinition containingBean) { //beançš„id String id = ele.getAttribute(ID_ATTRIBUTE); //beançš„name String nameAttr = ele.getAttribute(NAME_ATTRIBUTE); //beançš„åˆ«å List&lt;String&gt; aliases = new ArrayList&lt;&gt;(); if (StringUtils.hasLength(nameAttr)) { String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS); aliases.addAll(Arrays.asList(nameArr)); } String beanName = id; .......... //æ£€æŸ¥beanNameæ˜¯å¦é‡å¤ if (containingBean == null) { checkNameUniqueness(beanName, aliases, ele); } //é‡ç‚¹çœ‹è¯¥æ–¹æ³•ï¼Œè§£æå½“å‰bean AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean); ...... String[] aliasesArray = StringUtils.toStringArray(aliases); //å°†BeanDefinitionå¯¹è±¡å’ŒbeanNameå’Œåˆ«åæ•°ç»„å°è£…æˆBeanDefinitionHolderåè¿”å› return new BeanDefinitionHolder(beanDefinition, beanName, aliasesArray); } return null; } **æœ€é‡è¦çš„** A.parseBeanDefinitionElementï¼š åˆ›å»ºDefinitionBeanå¯¹è±¡ è§£æbeanæ ‡ç­¾çš„å±æ€§ è§£æbeanæ ‡ç­¾çš„å­æ ‡ç­¾ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public AbstractBeanDefinition parseBeanDefinitionElement( Element ele, String beanName, @Nullable BeanDefinition containingBean) { this.parseState.push(new BeanEntry(beanName)); String className = null; if (ele.hasAttribute(CLASS_ATTRIBUTE)) { className = ele.getAttribute(CLASS_ATTRIBUTE).trim(); } String parent = null; if (ele.hasAttribute(PARENT_ATTRIBUTE)) { parent = ele.getAttribute(PARENT_ATTRIBUTE); } try { //1.å†…éƒ¨åˆ›å»ºGenericBeanDefinitionå¯¹è±¡è¿”å› AbstractBeanDefinition bd = createBeanDefinition(className, parent); //2.è§£æbeanæ ‡ç­¾çš„å±æ€§ï¼Œå¹¶æŠŠè§£æå‡ºæ¥çš„å±æ€§ä¿å­˜åˆ°BeanDefinitionå¯¹è±¡ä¸­ parseBeanDefinitionAttributes(ele, beanName, containingBean, bd); bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT)); //ä¸‹é¢çš„éƒ½æ˜¯è§£æbeanå†…éƒ¨çš„æ ‡ç­¾ //è§£æmetaæ ‡ç­¾ parseMetaElements(ele, bd); //è§£ælookup-methodæ ‡ç­¾ ç”¨åˆ°cglib parseLookupOverrideSubElements(ele, bd.getMethodOverrides()); //è§£æreplaced-methodæ ‡ç­¾ ç”¨åˆ°cglib parseReplacedMethodSubElements(ele, bd.getMethodOverrides()); //è§£æconstructor-argæ ‡ç­¾ï¼Œ å°†æ ‡ç­¾ä¸­çš„å±æ€§å°è£…åˆ°ConstructorArgumentValuesç±»ï¼Œå†å°†è¯¥å¯¹è±¡ä¿å­˜åˆ°bd parseConstructorArgElements(ele, bd); //è§£æpropertyæ ‡ç­¾ parsePropertyElements(ele, bd); parseQualifierElements(ele, bd); bd.setResource(this.readerContext.getResource()); bd.setSource(extractSource(ele)); return bd; } .... return null; } A1.åˆ›å»ºGenericBeanDefinitionå¯¹è±¡ï¼ˆä»£ç 1ï¼‰ 123456789101112131415public static AbstractBeanDefinition createBeanDefinition( @Nullable String parentName, @Nullable String className, @Nullable ClassLoader classLoader) throws ClassNotFoundException { GenericBeanDefinition bd = new GenericBeanDefinition(); bd.setParentName(parentName); if (className != null) { if (classLoader != null) { bd.setBeanClass(ClassUtils.forName(className, classLoader)); } else { bd.setBeanClassName(className); } } return bd;} A2.parseBeanDefinitionAttributesè§£æbeanå±æ€§ä»£ç 2ï¼Œè§£æbeanæ ‡ç­¾çš„å±æ€§ï¼Œå¹¶æŠŠè§£æå‡ºæ¥çš„å±æ€§ä¿å­˜åˆ°BeanDefinitionå¯¹è±¡ä¸­ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283public AbstractBeanDefinition parseBeanDefinitionAttributes(Element ele, String beanName, @Nullable BeanDefinition containingBean, AbstractBeanDefinition bd) { if (ele.hasAttribute(SINGLETON_ATTRIBUTE)) { error(\"Old 1.x 'singleton' attribute in use - upgrade to 'scope' declaration\", ele); } //è®¾ç½®scope else if (ele.hasAttribute(SCOPE_ATTRIBUTE)) { bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE)); } else if (containingBean != null) { // Take default from containing bean in case of an inner bean definition. bd.setScope(containingBean.getScope()); } //è®¾ç½®æŠ½è±¡å±æ€§ if (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) { bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE))); } String lazyInit = ele.getAttribute(LAZY_INIT_ATTRIBUTE); if (DEFAULT_VALUE.equals(lazyInit)) { lazyInit = this.defaults.getLazyInit(); } bd.setLazyInit(TRUE_VALUE.equals(lazyInit)); String autowire = ele.getAttribute(AUTOWIRE_ATTRIBUTE); bd.setAutowireMode(getAutowireMode(autowire)); if (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) { String dependsOn = ele.getAttribute(DEPENDS_ON_ATTRIBUTE); bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, MULTI_VALUE_ATTRIBUTE_DELIMITERS)); } //autowire-candidateæ ‡ç­¾ //ä¸ºfalseæ—¶ï¼Œå®¹å™¨åœ¨æŸ¥æ‰¾è‡ªåŠ¨è£…é…å¯¹è±¡æ—¶ï¼Œå°†ä¸è€ƒè™‘è¯¥beanï¼Œå³è¯¥beanä¸ä¼šè¢«ä½œä¸ºå…¶å®ƒbeanè‡ªåŠ¨è£…é…çš„å€™é€‰è€…ï¼Œä½†è¯¥beanæœ¬èº«è¿˜æ˜¯å¯ä»¥ä½¿ç”¨è‡ªåŠ¨è£…é…æ¥ String autowireCandidate = ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE); if (\"\".equals(autowireCandidate) || DEFAULT_VALUE.equals(autowireCandidate)) { String candidatePattern = this.defaults.getAutowireCandidates(); if (candidatePattern != null) { String[] patterns = StringUtils.commaDelimitedListToStringArray(candidatePattern); bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, beanName)); } } else { bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate)); } //Primary if (ele.hasAttribute(PRIMARY_ATTRIBUTE)) { bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE))); } //init-methodå±æ€§ if (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) { String initMethodName = ele.getAttribute(INIT_METHOD_ATTRIBUTE); bd.setInitMethodName(initMethodName); } else if (this.defaults.getInitMethod() != null) { bd.setInitMethodName(this.defaults.getInitMethod()); bd.setEnforceInitMethod(false); } //destroy-methodå±æ€§ if (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) { String destroyMethodName = ele.getAttribute(DESTROY_METHOD_ATTRIBUTE); bd.setDestroyMethodName(destroyMethodName); } else if (this.defaults.getDestroyMethod() != null) { bd.setDestroyMethodName(this.defaults.getDestroyMethod()); bd.setEnforceDestroyMethod(false); } //factroy-method if (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) { bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE)); } //factroy-bean if (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) { bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE)); } return bd; } A3.è§£æbeanå­æ ‡ç­¾è§£ælookup-methodæ ‡ç­¾ï¼š 12345678910111213141516public void parseLookupOverrideSubElements(Element beanEle, MethodOverrides overrides) { NodeList nl = beanEle.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) { Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, LOOKUP_METHOD_ELEMENT)) {//lookup-method //æ‹¿åˆ°ookup-methodæ ‡ç­¾ Element ele = (Element) node; String methodName = ele.getAttribute(NAME_ATTRIBUTE);//lookup-methodä¸­çš„æ–¹æ³•ånameå±æ€§ String beanRef = ele.getAttribute(BEAN_ELEMENT);//beanå±æ€§å€¼ LookupOverride override = new LookupOverride(methodName, beanRef);//å°è£…æˆä¸€ä¸ªLookupOverride override.setSource(extractSource(ele)); //å°†overrideæ·»åŠ åˆ°MethodOverrides overrides.addOverride(override); } } } LookupOverrideæ˜¯MethodOverrideçš„å®ç°ï¼Œå¦å¤–ä¸€ä¸ªå®ç°æ˜¯ä¸‹é¢çš„ReplaceOverrideï¼› MethodOverrides: å†…éƒ¨ä½¿ç”¨é›†åˆä¿å­˜æ‰€æœ‰çš„MethodOverrideï¼Œå³æ‰€æœ‰çš„å­ç±»æ ‡ç­¾ï¼ˆè¿™é‡Œæ˜¯lookup-methodæ ‡ç­¾ï¼‰ä¿å­˜åœ¨æ­¤ 123456public class MethodOverrides { private final Set&lt;MethodOverride&gt; overrides = Collections.synchronizedSet(new LinkedHashSet&lt;&gt;(2)); private volatile boolean modified = false;} è§£æreplace-methodæ ‡ç­¾ 123456789101112131415161718192021222324252627282930public void parseReplacedMethodSubElements(Element beanEle, MethodOverrides overrides) { NodeList nl = beanEle.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) { Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, REPLACED_METHOD_ELEMENT)) { //è·å¾—å½“å‰replaced-methodæ ‡ç­¾ Element replacedMethodEle = (Element) node; String name = replacedMethodEle.getAttribute(NAME_ATTRIBUTE);//è·å¾—nameå±æ€§ String callback = replacedMethodEle.getAttribute(REPLACER_ATTRIBUTE);//è·å¾—replacerå±æ€§ //ä¸€ä¸ªreplaced-methodæ ‡ç­¾å°è£…æˆä¸€ä¸ªReplaceOverrideå¯¹è±¡ï¼Œæœ€ååŠ å…¥åˆ°BeanDefinitionå¯¹è±¡ä¸­ ReplaceOverride replaceOverride = new ReplaceOverride(name, callback); //è·å–æ‰€æœ‰arg-typeç±»å‹æ ‡ç­¾ List&lt;Element&gt; argTypeEles = DomUtils.getChildElementsByTagName(replacedMethodEle, ARG_TYPE_ELEMENT); for (Element argTypeEle : argTypeEles) { //æ ¹æ®æ–¹æ³•å‚æ•°ç±»å‹æ¥åŒºåˆ†åŒåçš„ä¸åŒçš„æ–¹æ³• String match = argTypeEle.getAttribute(ARG_TYPE_MATCH_ATTRIBUTE); match = (StringUtils.hasText(match) ? match : DomUtils.getTextValue(argTypeEle)); if (StringUtils.hasText(match)) { replaceOverride.addTypeIdentifier(match); } } replaceOverride.setSource(extractSource(replacedMethodEle)); //æ·»åŠ åˆ°overrides overrides.addOverride(replaceOverride); } } } å°†nameå’Œreplacerå°è£…åˆ°ReplaceOverride æ·»åŠ å‚æ•°ç±»å‹ å°†ReplaceOverrideæ·»åŠ åˆ°MethodOverridesçš„å¯¹è±¡overrides è§£æconstructor-argæ ‡ç­¾ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public void parseConstructorArgElement(Element ele, BeanDefinition bd) { String indexAttr = ele.getAttribute(INDEX_ATTRIBUTE); String typeAttr = ele.getAttribute(TYPE_ATTRIBUTE); String nameAttr = ele.getAttribute(NAME_ATTRIBUTE); if (StringUtils.hasLength(indexAttr)) {//æœ‰indexå±æ€§ try { int index = Integer.parseInt(indexAttr); if (index &lt; 0) { error(\"'index' cannot be lower than 0\", ele); } else { try { this.parseState.push(new ConstructorArgumentEntry(index)); Object value = parsePropertyValue(ele, bd, null); //ä¸»è¦çœ‹è¿™é‡Œ ConstructorArgumentValues.ValueHolder valueHolder = new ConstructorArgumentValues.ValueHolder(value); if (StringUtils.hasLength(typeAttr)) { //è®¾ç½®type valueHolder.setType(typeAttr); } if (StringUtils.hasLength(nameAttr)) { //è®¾ç½®name valueHolder.setName(nameAttr); } valueHolder.setSource(extractSource(ele)); if (bd.getConstructorArgumentValues().hasIndexedArgumentValue(index)) { error(\"Ambiguous constructor-arg entries for index \" + index, ele); } else { //æ·»åŠ indexå±æ€§ bd.getConstructorArgumentValues().addIndexedArgumentValue(index, valueHolder); } } finally { this.parseState.pop(); } } } catch (NumberFormatException ex) { error(\"Attribute 'index' of tag 'constructor-arg' must be an integer\", ele); } } else {//æ²¡æœ‰index try { this.parseState.push(new ConstructorArgumentEntry()); Object value = parsePropertyValue(ele, bd, null); ConstructorArgumentValues.ValueHolder valueHolder = new ConstructorArgumentValues.ValueHolder(value); if (StringUtils.hasLength(typeAttr)) { valueHolder.setType(typeAttr); } if (StringUtils.hasLength(nameAttr)) { valueHolder.setName(nameAttr); } valueHolder.setSource(extractSource(ele)); //ä¸æ·»åŠ indexï¼Œç›´æ¥æ·»åŠ valueHolder bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder); } finally { this.parseState.pop(); } } } ä¸»è¦è®°ä½ConstructorArgumentValuesç±»ï¼Œè¯¥ç±»å°†constructor-argæ ‡ç­¾çš„typeã€nameä»¥åŠindexéƒ½å°è£…èµ·æ¥ï¼Œæœ€åå°†ConstructorArgumentValuesæ·»åŠ åˆ°BeanDefinitionä¸­ 123456public class ConstructorArgumentValues { //æœ‰indexå±æ€§ï¼Œå°±ç”¨mapå­˜å‚¨ private final Map&lt;Integer, ValueHolder&gt; indexedArgumentValues = new LinkedHashMap&lt;&gt;(); //æ²¡æœ‰å°±ç›´æ¥å°†typeå’Œvalueå°è£…åˆ°ValueHolderå­˜åˆ°é›†åˆä¸­ private final List&lt;ValueHolder&gt; genericArgumentValues = new ArrayList&lt;&gt;();} è§£æpropertyæ ‡ç­¾ï¼š å°†nameå’Œvalue/refå°è£…åˆ°PropertyValueå¹¶ä¿å­˜åˆ°BeanDefinitionçš„MutablePropertyValuesä¸­ 12345678910111213141516171819202122232425public void parsePropertyElement(Element ele, BeanDefinition bd) { String propertyName = ele.getAttribute(NAME_ATTRIBUTE);//propertyçš„nameå±æ€§ if (!StringUtils.hasLength(propertyName)) { error(\"Tag 'property' must have a 'name' attribute\", ele); return; } this.parseState.push(new PropertyEntry(propertyName)); try { if (bd.getPropertyValues().contains(propertyName)) { error(\"Multiple 'property' definitions for property '\" + propertyName + \"'\", ele); return; } //è§£ævalueæˆ–ref Object val = parsePropertyValue(ele, bd, propertyName); //å°è£…åˆ°PropertyValue PropertyValue pv = new PropertyValue(propertyName, val); parseMetaElements(ele, pv); pv.setSource(extractSource(ele)); //PropertyValueä¿å­˜åˆ°bdçš„MutablePropertyValuesä¸­ bd.getPropertyValues().addPropertyValue(pv); } finally { this.parseState.pop(); } } MutablePropertyValueså†…éƒ¨ä¿å­˜äº†PropertyValueçš„é›†åˆ 12345public class MutablePropertyValues implements PropertyValues, Serializable { private final List&lt;PropertyValue&gt; propertyValueList; ...} B.decorateBeanDefinitionIfRequiredè¯¥æ–¹æ³•ä¸»è¦å¯¹beanè¿›è¡Œè£…é¥°ï¼Œè®¾è®¡è£…é¥°è€…æ¨¡å¼å’ŒSPIè®¾è®¡æ€æƒ³ã€‚ å½“æˆ‘ä»¬ä½¿ç”¨pæˆ–cå‰ç¼€æ—¶ï¼Œå¦‚ï¼š ï¼ˆpåŸºäºsetteræ³¨å…¥ï¼Œcæ˜¯æ„é€ å™¨æ³¨å…¥ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¯¹è¿™ç§å±æ€§è£…é¥°BeanDefinitionHolderï¼š 1234567891011121314151617181920212223public BeanDefinitionHolder decorateBeanDefinitionIfRequired( Element ele, BeanDefinitionHolder definitionHolder, @Nullable BeanDefinition containingBd) { BeanDefinitionHolder finalDefinition = definitionHolder; //1.å…ˆæ ¹æ®beançš„å±æ€§è£…é¥°bd NamedNodeMap attributes = ele.getAttributes(); for (int i = 0; i &lt; attributes.getLength(); i++) { Node node = attributes.item(i); finalDefinition = decorateIfRequired(node, finalDefinition, containingBd); } //2.å†æ ¹æ®å…¶å­æ ‡ç­¾è£…é¥°bd NodeList children = ele.getChildNodes(); for (int i = 0; i &lt; children.getLength(); i++) { Node node = children.item(i); if (node.getNodeType() == Node.ELEMENT_NODE) { finalDefinition = decorateIfRequired(node, finalDefinition, containingBd); } } //3.è¿”å›è£…é¥°å®Œçš„bd return finalDefinition; } B1.decorateIfRequiredpå’Œcç­‰å‰ç¼€åœ¨spring-beansä¸‹çš„META-INF/spring.handlersæ–‡ä»¶ä¸­å®šä¹‰ï¼š [å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-m1c6zYbC-1586099120460)(D:\\æ–‡æ¡£èµ„æ–™\\JAVA\\Spring\\1586008827719.png)] 123http\\://www.springframework.org/schema/c=org.springframework.beans.factory.xml.SimpleConstructorNamespaceHandlerhttp\\://www.springframework.org/schema/p=org.springframework.beans.factory.xml.SimplePropertyNamespaceHandlerhttp\\://www.springframework.org/schema/util=org.springframework.beans.factory.xml.UtilNamespaceHandler ç»“æ„ä¸ºK-Vï¼ŒKä½å‘½åç©ºé—´ï¼ŒVä¸ºå¯¹åº”çš„å¤„ç†ç±»ã€‚ 12345678910111213141516171819202122public BeanDefinitionHolder decorateIfRequired( Node node, BeanDefinitionHolder originalDef, @Nullable BeanDefinition containingBd) { //ä»£ç 1.è·å–nodeçš„å‘½åç©ºé—´ï¼Œå¦‚ä¸Šé¢çš„ï¼šhttp://www.springframework.org/schema/c String namespaceUri = getNamespaceURI(node); if (namespaceUri != null &amp;&amp; !isDefaultNamespace(namespaceUri)) { //ä»£ç 2.åŸºäºSPIæœåŠ¡å‘ç°çš„è®¾è®¡æ€æƒ³ï¼Œè·å–namespaceUriå¯¹åº”çš„å¤„ç†ç±» NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if (handler != null) { //ä»£ç 3.è°ƒç”¨å¤„ç†ç±»çš„decorateæ–¹æ³•ï¼Œå¼€å§‹è£…é¥°ï¼Œå¹¶è¿”å›è£…é¥°å®Œçš„BeanDefinitionHolderå¯¹è±¡ BeanDefinitionHolder decorated = handler.decorate(node, originalDef, new ParserContext(this.readerContext, this, containingBd)); if (decorated != null) { return decorated; } } .....é”™è¯¯å¤„ç†................. } return originalDef; } B1.1æ ¹æ®å‘½åç©ºé—´è·å–å¯¹åº”å¤„ç†ç±»ï¼š12345678910111213141516171819202122232425262728293031323334@Override @Nullable public NamespaceHandler resolve(String namespaceUri) { //å°†springçš„jarä¸‹ä¸­æ‰€æœ‰çš„ \"META-INF/spring.handlers\"æ–‡ä»¶å»ºç«‹å‘½åç©ºé—´å’Œå¤„ç†ç±»çš„æ˜ å°„å…³ç³»åè¿”å› //è¿™é‡Œä»¥spring-beansåŒ…ä¸‹çš„ä¸ºä¾‹ï¼Œå…¶ä»–çš„è¿˜æœ‰spring-contextåŒ…çš„context:/cache:ï¼ŒaopåŒ…ä¸‹çš„aop:ä»¥åŠjdbcåŒ…ä¸‹çš„jdbc:ç­‰ Map&lt;String, Object&gt; handlerMappings = getHandlerMappings(); //æ ¹æ®namespaceUriè·å–åˆ°å¯¹åº”çš„å¤„ç†ç±» Object handlerOrClassName = handlerMappings.get(namespaceUri); if (handlerOrClassName == null) { return null; } else if (handlerOrClassName instanceof NamespaceHandler) { return (NamespaceHandler) handlerOrClassName; } else { String className = (String) handlerOrClassName; try { Class&lt;?&gt; handlerClass = ClassUtils.forName(className, this.classLoader); if (!NamespaceHandler.class.isAssignableFrom(handlerClass)) { throw new FatalBeanException(\"Class [\" + className + \"] for namespace [\" + namespaceUri + \"] does not implement the [\" + NamespaceHandler.class.getName() + \"] interface\"); } //ä½¿ç”¨åå°„å®ä¾‹åŒ– NamespaceHandler namespaceHandler = (NamespaceHandler) BeanUtils.instantiateClass(handlerClass); //è°ƒç”¨å¤„ç†ç±»çš„initæ–¹æ³•ï¼Œåœ¨initæ–¹æ³•ä¸­å®Œæˆæ ‡ç­¾å…ƒç´ è§£æç±»çš„æ³¨å†Œ,ä¼šåœ¨è§£æè‡ªå®šä¹‰æ ‡ç­¾æ—¶ç”¨åˆ° namespaceHandler.init(); handlerMappings.put(namespaceUri, namespaceHandler); return namespaceHandler; } ......catch.................... } } è·å–å‘½åç©ºé—´å’Œå¤„ç†ç±»çš„æ˜ å°„å…³ç³»ï¼š 123456789101112131415161718192021222324private Map&lt;String, Object&gt; getHandlerMappings() { Map&lt;String, Object&gt; handlerMappings = this.handlerMappings; if (handlerMappings == null) { synchronized (this) { handlerMappings = this.handlerMappings; if (handlerMappings == null) { ..... try { //åŠ è½½\"spring.handlers\"æ–‡ä»¶ Properties mappings = PropertiesLoaderUtils.loadAllProperties(this.handlerMappingsLocation, this.classLoader); ..... //æ„é€ Mapï¼Œå°†é‡Œé¢çš„å‘½åç©ºé—´å’Œå¤„ç†ç±»å»ºç«‹æ˜ å°„å…³ç³» handlerMappings = new ConcurrentHashMap&lt;&gt;(mappings.size()); CollectionUtils.mergePropertiesIntoMap(mappings, handlerMappings); this.handlerMappings = handlerMappings; } .... } } }//è¿”å›map return handlerMappings; } namespaceHandler.init() è¯¥æ–¹æ³•æ˜¯åœ¨æ¥å£ä¸­çš„ï¼Œå…·ä½“å®ç°ä¸­åˆå§‹åŒ–æ ‡ç­¾ï¼š 123456789101112131415//ContextNamespaceHandlerr#init @Override public void init() { registerBeanDefinitionParser(\"property-placeholder\", new PropertyPlaceholderBeanDefinitionParser()); registerBeanDefinitionParser(\"property-override\", new PropertyOverrideBeanDefinitionParser()); registerBeanDefinitionParser(\"annotation-config\", new AnnotationConfigBeanDefinitionParser()); registerBeanDefinitionParser(\"component-scan\", new ComponentScanBeanDefinitionParser()); ...... }//CacheNamespaceHandler#init@Override public void init() { registerBeanDefinitionParser(\"annotation-driven\", new AnnotationDrivenCacheBeanDefinitionParser()); registerBeanDefinitionParser(\"advice\", new CacheAdviceParser()); } 12345private final Map&lt;String, BeanDefinitionParser&gt; parsers = new HashMap&lt;&gt;();protected final void registerBeanDefinitionParser(String elementName, BeanDefinitionParser parser) { this.parsers.put(elementName, parser); } å…¶å†…éƒ¨å°±æ˜¯å°†è‡ªå®šä¹‰æ ‡ç­¾åå’Œå…¶æ ‡ç­¾è§£æå™¨çš„æ˜ å°„å­˜åˆ°äº†ä¸€ä¸ªå«parsersçš„mapä¸­ï¼Œåé¢è§£æè‡ªå®šä¹‰æ ‡ç­¾æ—¶ä¼šç”¨åˆ°ã€‚ B1.2å…·ä½“è£…é¥°è¿‡ç¨‹ã€äº†è§£ã€‘ï¼šæ ¹æ®ä¸åŒçš„å‘½åç©ºé—´è°ƒç”¨å¯¹åº”çš„å¤„ç†ç±»çš„decorateæ–¹æ³•ï¼Œpæ ‡ç­¾å¯¹åº”çš„å°±æ˜¯SimplePropertyNamespaceHandlerï¼Œæ ¹æ®på‰ç¼€å±æ€§è£…é¥°BeanDefinitionï¼› cå‰ç¼€å°±æ˜¯SimpleConstructorNamespaceHandlerï¼Œæ ¹æ®cå‰ç¼€å±æ€§è£…é¥°BeanDefinition å¦‚ä¸‹æ˜¯SimplePropertyNamespaceHandlerçš„è£…é¥°æ–¹æ³•ï¼š ä¸»è¦å°±æ˜¯å°†p:çš„å±æ€§å’Œå€¼æ·»åŠ åˆ°BeanDefinitionçš„MutablePropertyValuesä¸­ï¼Œè¿™ä¸ªå±æ€§åœ¨è§£æpropertyæ ‡ç­¾æ—¶ï¼Œç”¨äºå°è£…è¯¥æ ‡ç­¾å±æ€§ã€‚ 1234567891011121314151617181920212223242526public BeanDefinitionHolder decorate(Node node, BeanDefinitionHolder definition, ParserContext parserContext) { if (node instanceof Attr) { //æ‹¿åˆ°å…·ä½“çš„å±æ€§ å¦‚ p:name=\"wml\" Attr attr = (Attr) node; //å±æ€§å å¦‚ä¸Šé¢çš„ name String propertyName = parserContext.getDelegate().getLocalName(attr); //å±æ€§å€¼ å¦‚ä¸Šé¢çš„ \"wml\" String propertyValue = attr.getValue(); //è·å–BeanDefinitionçš„MutablePropertyValuesï¼Œè¿™é‡Œå‰é¢è§£æpropertyæ ‡ç­¾æ—¶ç”¨äºå°è£…propertyæ ‡ç­¾ MutablePropertyValues pvs = definition.getBeanDefinition().getPropertyValues(); if (pvs.contains(propertyName)) { parserContext.getReaderContext().error(\"Property '\" + propertyName + \"' is already defined using \" + \"both &lt;property&gt; and inline syntax. Only one approach may be used per property.\", attr); } if (propertyName.endsWith(REF_SUFFIX)) { propertyName = propertyName.substring(0, propertyName.length() - REF_SUFFIX.length()); pvs.add(Conventions.attributeNameToPropertyName(propertyName), new RuntimeBeanReference(propertyValue)); } else { //å°†å±æ€§nameæ ¼å¼åŒ–ä¸€ä¸‹å’Œvalueä¸€èµ·æ·»åŠ åˆ°MutablePropertyValues pvs.add(Conventions.attributeNameToPropertyName(propertyName), propertyValue); } } //è¿”å›è£…é¥°å®Œæ¯•çš„BeanDefinition return definition; } åŒç†ï¼Œæ ¹æ®cï¼šå‰ç¼€çš„è£…é¥°ï¼Œå°±æ˜¯å°†cï¼šä¸­çš„å±æ€§å’Œå€¼æ·»åŠ åˆ°BeanDefinitionä¸­çš„ConstructorArgumentValuesä¸­ åˆ°è¿™é‡Œå¯¹BeanDefinitionçš„è£…é¥°è¿‡ç¨‹å°±ç»“æŸäº†ã€‚ æˆ‘ä»¬å†å›åˆ°5.1.1ï¼Œçœ‹æ¥ä¸‹æ¥çš„ä»£ç 3 C.registerBeanDefinitionè¯¥æ–¹æ³•å¯¹BeanDefinitionå¯¹è±¡è¿›è¡Œç¼“å­˜æ³¨å†Œ BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); 12345678910111213141516171819public static void registerBeanDefinition( BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException { //beanName String beanName = definitionHolder.getBeanName(); //è¿™é‡Œè¿›è¡Œç¼“å­˜æ³¨å†Œ registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); //å»ºç«‹åˆ«åå’Œ idçš„æ˜ å°„ï¼Œå°±å¯ä»¥æ ¹æ®åˆ«åè·å–åˆ°id // Register aliases for bean name, if any. String[] aliases = definitionHolder.getAliases(); if (aliases != null) { for (String alias : aliases) { registry.registerAlias(beanName, alias); } } } å¯¹BeanDefinitionç¼“å­˜æ³¨å†Œï¼š123456789101112131415161718192021222324252627282930@Override public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException { ....... //å…ˆåˆ¤æ–­BeanDefinitionæ˜¯å¦å·²ç»æ³¨å†Œ BeanDefinition existingDefinition = this.beanDefinitionMap.get(beanName); if (existingDefinition != null) { ..... } else { if (hasBeanCreationStarted()) { ...... } else {//é‡ç‚¹çœ‹è¿™é‡Œ //æŠŠbeanDefinitionç¼“å­˜åˆ°mapä¸­ // Still in startup registration phase this.beanDefinitionMap.put(beanName, beanDefinition); //æŠŠbeanNameæ”¾åˆ°beanDefinitionNames listä¸­ //beanDefinitionNamesæ˜¯ä¸€ä¸ªListé›†åˆï¼Œè£…äº†æ‰€æœ‰çš„beanåç§° this.beanDefinitionNames.add(beanName); //ç§»é™¤æ‰‹åŠ¨æ³¨å†Œçš„å•ä¾‹beanåï¼Œè¿™é‡Œå®ä¾‹åŒ–çš„æ—¶å€™å†å°† this.manualSingletonNames.remove(beanName); } this.frozenBeanDefinitionNames = null; }........................ } 5.2 parseCustomElementè§£æè‡ªå®šä¹‰æ ‡ç­¾ æ¯”å¦‚&lt;context:component-scan base-package=&quot;com.test&quot;/&gt; å°±æ˜¯è‡ªå®šä¹‰æ ‡ç­¾ï¼Œè”ç³»ä¸Šé¢Béƒ¨åˆ†è®²çš„è£…é¥°BeanDefinitionä¸­SPIæœåŠ¡å‘ç°æ€æƒ³ï¼Œä¸¾çš„ä¾‹å­æ˜¯æ ¹æ®beanæ ‡ç­¾ä¸­çš„p:å’Œc:ä¸¤ä¸ªå‰ç¼€çš„å±æ€§è¿›è¡Œè£…é¥°ï¼ŒåŒæ ·çš„è¿™é‡Œcontext:å‰ç¼€çš„æ ‡ç­¾ï¼ŒåŒ…æ‹¬å‰é¢æåˆ°çš„æ‰€æœ‰Springçš„jaråŒ…ä¸‹çš„spring.handleræ–‡ä»¶ä¸­å®šä¹‰çš„å‘½åç©ºé—´å‰ç¼€å’Œå¤„ç†ç±»çš„æ˜ å°„ï¼Œä»¥è¿™äº›å‰ç¼€å¼€å¤´çš„æ ‡ç­¾éƒ½å±äºè‡ªå®šä¹‰æ ‡ç­¾ã€‚ ä¸‹é¢æ˜¯è§£æè‡ªå®šä¹‰æ ‡ç­¾çš„æµç¨‹ï¼Œå‰é¢çš„æ­¥éª¤è·ŸB1éƒ¨åˆ†çš„ä»£ç 1å’Œä»£ç 2ä¸€æ¨¡ä¸€æ ·ï¼Œåªæ˜¯åœ¨æœ€åæ˜¯æ‰§è¡Œäº†handler.parseè€Œä¸æ˜¯è£…é¥°ã€‚ 12345678910111213@Nullable public BeanDefinition parseCustomElement(Element ele, @Nullable BeanDefinition containingBd) { String namespaceUri = getNamespaceURI(ele); if (namespaceUri == null) { return null; } NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if (handler == null) { error(\"Unable to locate Spring NamespaceHandler for XML schema namespace [\" + namespaceUri + \"]\", ele); return null; } return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd)); } å› æ­¤é‡ç‚¹è®²è¿™ä¸ªparse()æ–¹æ³•ï¼š 123456789101112131415public BeanDefinition parse(Element element, ParserContext parserContext) { BeanDefinitionParser parser = findParserForElement(element, parserContext); return (parser != null ? parser.parse(element, parserContext) : null); }private BeanDefinitionParser findParserForElement(Element element, ParserContext parserContext) { //è·å¾—æ ‡ç­¾å å¦‚contextä¸‹çš„component-scan String localName = parserContext.getDelegate().getLocalName(element); //ç„¶åè·å–å¯¹åº”çš„è§£æç±»BeanDefinitionParserï¼Œæ³¨æ„è¿™é‡Œçš„parsersï¼Œå°±æ˜¯å‰é¢æ‰§è¡Œhandler.init()æ–¹æ³•æ—¶ï¼Œå°†æ ‡ç­¾å…ƒç´ æ³¨å†Œåˆ°parsers(Map)ä¸­ï¼Œè¿™é‡Œå°±å¯ä»¥æ ¹æ®æ ‡ç­¾åå–åˆ°å¯¹åº”çš„è§£æå™¨ BeanDefinitionParser parser = this.parsers.get(localName); if (parser == null) { parserContext.getReaderContext().fatal( \"Cannot locate BeanDefinitionParser for element [\" + localName + \"]\", element); } return parser; } å› æ­¤ï¼Œåé¢çš„parse()æ–¹æ³•å°±æ˜¯æ ¹æ®æ ‡ç­¾å¯¹åº”çš„è§£æå™¨ï¼Œæ‰§è¡Œå…·ä½“çš„parse()ï¼Œè¿™é‡Œä»¥component-scanä¸ºä¾‹ï¼š parse()è¯¥æ ‡ç­¾çš„ä½œç”¨å°±æ˜¯æ‰«æbase-packageåŒ…ä¸‹çš„æ‰€æœ‰å¸¦æ³¨è§£çš„ç±»ï¼Œå¦‚@Serviceï¼Œ@Componentç­‰ï¼Œç„¶åå°†è¿™äº›ç±»å°è£…æˆBeanDefinitionå¯¹è±¡ï¼Œå¹¶æ³¨å†Œåˆ°Springå®¹å™¨ä¸­ï¼Œè¿™ä¹Ÿå°±æ˜¯parseæ–¹æ³•æ‰€è¦åšçš„äº‹æƒ…ã€‚ 123456789101112131415161718public BeanDefinition parse(Element element, ParserContext parserContext) { //1.è·å–basePackage String basePackage = element.getAttribute(BASE_PACKAGE_ATTRIBUTE); basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage); //1.1å› ä¸ºbase-packageä¸­å¯ä»¥å®šä¹‰å¤šä¸ªè·¯å¾„ï¼Œæ‰€ä»¥å°è£…æˆæ•°ç»„ String[] basePackages = StringUtils.tokenizeToStringArray(basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS); // Actually scan for bean definitions and register them. //2.é…ç½®æ³¨è§£æ‰«æå™¨ ClassPathBeanDefinitionScanner scanner = configureScanner(parserContext, element); //3.æ‰«æå¹¶æŠŠæ‰«æçš„ç±»å°è£…æˆbeanDefinitionå¯¹è±¡ ******å…³é”®éƒ¨åˆ† Set&lt;BeanDefinitionHolder&gt; beanDefinitions = scanner.doScan(basePackages); //4.æ³¨å†Œå°è£…å¥½çš„beanDefinitions registerComponents(parserContext.getReaderContext(), beanDefinitions, element); return null;} A. configureScanneré…ç½®æ³¨è§£æ‰«æå™¨ 1234567891011121314151617181920protected ClassPathBeanDefinitionScanner configureScanner(ParserContext parserContext, Element element) { //ä½¿ç”¨é»˜è®¤çš„è¿‡æ»¤å™¨ boolean useDefaultFilters = true; //@Service @Component if (element.hasAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE)) { useDefaultFilters = Boolean.valueOf(element.getAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE)); } //ä»£ç 1ï¼šåˆ›å»ºæ³¨è§£çš„æ‰«æå™¨ // Delegate bean definition registration to scanner class. ClassPathBeanDefinitionScanner scanner = createScanner(parserContext.getReaderContext(), useDefaultFilters); scanner.setBeanDefinitionDefaults(parserContext.getDelegate().getBeanDefinitionDefaults()); scanner.setAutowireCandidatePatterns(parserContext.getDelegate().getAutowireCandidatePatterns()); .....................ä¸­é—´çœç•¥äº†ä¸€äº›è§£æå­æ ‡ç­¾çš„å†…å®¹ï¼Œæ— å…³ç´§è¦ä¸ç”¨çœ‹................. //ä»£ç 2ï¼šè§£æinclude-filterä»¥åŠexclude-filteræ ‡ç­¾ parseTypeFilters(element, scanner, parserContext); return scanner; } 1.åˆ›å»ºæ³¨è§£æ‰«æå™¨createScanner 1234567891011121314151617protected ClassPathBeanDefinitionScanner createScanner(XmlReaderContext readerContext, boolean useDefaultFilters) { return new ClassPathBeanDefinitionScanner(readerContext.getRegistry(), useDefaultFilters, readerContext.getEnvironment(), readerContext.getResourceLoader()); }public ClassPathBeanDefinitionScanner(BeanDefinitionRegistry registry, boolean useDefaultFilters, Environment environment, @Nullable ResourceLoader resourceLoader) { Assert.notNull(registry, \"BeanDefinitionRegistry must not be null\"); this.registry = registry; //å¦‚æœä½¿ç”¨é»˜è®¤çš„è¿‡æ»¤å™¨ if (useDefaultFilters) { //è¿›è¡Œæ³¨å†Œ registerDefaultFilters(); } setEnvironment(environment); setResourceLoader(resourceLoader); } æ³¨å†Œé»˜è®¤è¿‡æ»¤å™¨ï¼š 123456protected void registerDefaultFilters() { //è¿‡æ»¤å™¨æ·»åŠ éœ€è¦æ‰«æçš„æ³¨è§£ç±»å‹ this.includeFilters.add(new AnnotationTypeFilter(Component.class)); ClassLoader cl = ClassPathScanningCandidateComponentProvider.class.getClassLoader(); .......... } è¿™é‡Œä¸ºä»€ä¹ˆåªæ·»åŠ äº†Componentï¼Œè€Œæ²¡æœ‰Serviceæ³¨è§£ï¼Œå› ä¸ºServiceä»¥åŠConfigurationç­‰æ³¨è§£éƒ½æ˜¯è¢«Componentæ ‡æ³¨çš„ï¼š 12345678910....@org.springframework.stereotype.Componentpublic @interface Service {.............}.....@Componentpublic @interface Configuration {.....} 2.è§£æinclude/exclude-filteræ ‡ç­¾å°±æ˜¯å¦‚æœæœ‰è¿™ä¸¤ä¸ªæ ‡ç­¾ï¼Œå°±å°†æ ‡ç­¾ä¸­æ¶‰åŠçš„æ³¨è§£åˆ†åˆ«æ·»åŠ åˆ°ä¸‹è¾¹è¿™ä¸¤ä¸ªé›†åˆä¸­ï¼Œå‰é¢é»˜è®¤çš„æ³¨è§£ä¹Ÿæ˜¯æ·»åŠ åˆ°includeFiltersä¸­ 12private final List&lt;TypeFilter&gt; includeFilters = new LinkedList&lt;&gt;();private final List&lt;TypeFilter&gt; excludeFilters = new LinkedList&lt;&gt;(); 12345678910111213141516protected void parseTypeFilters(Element element, ClassPathBeanDefinitionScanner scanner, ParserContext parserContext) { // Parse exclude and include filter elements. .......... if (INCLUDE_FILTER_ELEMENT.equals(localName)) { //æ‰«æinclude-filteræ ‡ç­¾ TypeFilter typeFilter = createTypeFilter((Element) node, classLoader, parserContext); scanner.addIncludeFilter(typeFilter); } else if (EXCLUDE_FILTER_ELEMENT.equals(localName)) { //æ‰«æexclude-filteræ ‡ç­¾ TypeFilter typeFilter = createTypeFilter((Element) node, classLoader, parserContext); scanner.addExcludeFilter(typeFilter); } ......... } æ€»ç»“ï¼š configureScanneræ–¹æ³•ä¸»è¦åšäº†å¦‚ä¸‹å·¥ä½œï¼š åˆ›å»ºæ³¨è§£æ‰«æå™¨ å°†è¦æ‰«æçš„æ³¨è§£æ·»åŠ åˆ°includeFilters å¦‚æœæœ‰include/exclude-filterå­æ ‡ç­¾ï¼Œå°±å°†æ ‡ç­¾ä¸­å®šä¹‰çš„æ³¨è§£åˆ†åˆ«æ·»åŠ åˆ°includeFilterså’ŒexcludeFiltersä¸­ è¿”å›æ‰«æå™¨ B.scanner.doScan()ã€*ã€‘å‰é¢å·²ç»é…ç½®å¥½äº†æ³¨è§£æ‰«æå™¨ï¼Œè¿™é‡Œå°±è¦å°†å‰é¢æ·»åŠ çš„éœ€è¦æ‰«æçš„æ³¨è§£çš„ç±»å°è£…æˆbeanDefinitionå¯¹è±¡ 123456789101112131415161718192021222324252627282930313233protected Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) { Assert.notEmpty(basePackages, \"At least one base package must be specified\"); Set&lt;BeanDefinitionHolder&gt; beanDefinitions = new LinkedHashSet&lt;&gt;(); for (String basePackage : basePackages) { //ä»£ç 1ï¼šæ‰«æåˆ°æœ‰æ³¨è§£çš„ç±»å¹¶å°è£…æˆBeanDefinitionå¯¹è±¡ Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage); for (BeanDefinition candidate : candidates) { ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate); ////è®¾ç½®scopeï¼Œé»˜è®¤singleton candidate.setScope(scopeMetadata.getScopeName()); String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry); if (candidate instanceof AbstractBeanDefinition) { //ä»£ç 2ï¼šå¯¹BeanDefinitionè®¾ç½®é»˜è®¤å€¼ postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName); } if (candidate instanceof AnnotatedBeanDefinition) { //ä»£ç 3ï¼š AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate); } if (checkCandidate(beanName, candidate)) { BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName); //ä¸çœ‹ definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry); beanDefinitions.add(definitionHolder); //æ³¨å†ŒBeanDefinition registerBeanDefinition(definitionHolder, this.registry); } } } return beanDefinitions; } B1.scanCandidateComponents123456789101112131415161718192021222324252627282930313233private Set&lt;BeanDefinition&gt; scanCandidateComponents(String basePackage) { Set&lt;BeanDefinition&gt; candidates = new LinkedHashSet&lt;&gt;(); try { //ç»“æœå°±æ˜¯ com/test/**/*.class String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +//classpath*: resolveBasePackage(basePackage)// å°†.æ¢æˆ/ + '/' + this.resourcePattern;// **/*.class //æ ¹æ®ä¸Šé¢çš„æ¨¡ç³Šè·¯å¾„é€’å½’æŸ¥è¯¢åˆ°åŒ¹é…çš„æ–‡ä»¶èµ„æº .classæ–‡ä»¶ Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath); ... for (Resource resource : resources) { .. if (resource.isReadable()) { try { //è¯¥ç±»åŒ…å«äº†ä¸€ä¸ªç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ³¨è§£ç­‰ä¿¡æ¯ MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource); //å¦‚æœç±»ä¸Šæœ‰includeFiltersæ³¨è§£ï¼Œè¯´æ˜è¯¥ç±»è¦å®ä¾‹åŒ– if (isCandidateComponent(metadataReader)) { //åˆ›å»ºScannedGenericBeanDefinition(BeanDefinitionçš„å­ç±»)ï¼Œç”¨äºå­˜å‚¨@Componentã€@Serviceã€@Controllerç­‰æ³¨è§£æ³¨é‡Šçš„ç±» ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader); sbd.setResource(resource); sbd.setSource(resource); if (isCandidateComponent(sbd)) { //æ·»åŠ åˆ°BeanDefinitioné›†åˆ candidates.add(sbd); } ........ } } //è¿”å›BeanDefinitioné›†åˆ return candidates; } æ ¹æ®è·¯å¾„é€’å½’æŸ¥è¯¢æ‰€æœ‰.classæ–‡ä»¶ï¼Œå°†å…¶å°è£…ä¸ºResourceå¯¹è±¡æ•°ç»„ éå†Resourceæ•°ç»„ï¼Œå°†ç±»ä¸Šæœ‰includeFiltersæ³¨è§£çš„ç±»å°è£…åˆ°ScannedGenericBeanDefinitionä¸­ å°†ScannedGenericBeanDefinitionæ·»åŠ åˆ°BeanDefinitioné›†åˆä¸­ï¼Œå¹¶è¿”å›è¯¥é›†åˆ B2.postProcessBeanDefinitionç®€å•çœ‹ä¸€ä¸‹ï¼Œå°±æ˜¯ç»™beanDefinitionè®¾ç½®äº†ä¸€äº›é»˜è®¤å€¼ 12345678910111213141516protected void postProcessBeanDefinition(AbstractBeanDefinition beanDefinition, String beanName) { beanDefinition.applyDefaults(this.beanDefinitionDefaults); if (this.autowireCandidatePatterns != null) { beanDefinition.setAutowireCandidate(PatternMatchUtils.simpleMatch(this.autowireCandidatePatterns, beanName)); } } */ public void applyDefaults(BeanDefinitionDefaults defaults) { setLazyInit(defaults.isLazyInit()); setAutowireMode(defaults.getAutowireMode()); setDependencyCheck(defaults.getDependencyCheck()); setInitMethodName(defaults.getInitMethodName()); setEnforceInitMethod(false); setDestroyMethodName(defaults.getDestroyMethodName()); setEnforceDestroyMethod(false); } B3.processCommonDefinitionAnnotationsè¯¥æ–¹æ³•å°†ç±»ä¸­çš„ç›¸å…³æ³¨è§£ä¿¡æ¯æ·»åŠ åˆ°BeanDefinitionçš„ç›¸åº”çš„å±æ€§ä¸­: å¦‚ï¼š@Lazyã€@Primaryã€@DependsOnç­‰ 123456789101112131415161718static void processCommonDefinitionAnnotations(AnnotatedBeanDefinition abd, AnnotatedTypeMetadata metadata) { AnnotationAttributes lazy = attributesFor(metadata, Lazy.class); if (lazy != null) {//å¦‚æœæœ‰Lazyæ³¨è§£ï¼Œå°±å°†å…¶å€¼è®¾ç½®åˆ°beanDefinitionä¸­ abd.setLazyInit(lazy.getBoolean(\"value\")); } else if (abd.getMetadata() != metadata) { lazy = attributesFor(abd.getMetadata(), Lazy.class); if (lazy != null) { abd.setLazyInit(lazy.getBoolean(\"value\")); } } //å¦‚æœæœ‰Primaryæ³¨è§£ï¼Œå°±è®¾ç½®beanDefinitionçš„Primaryä¸ºtrue if (metadata.isAnnotated(Primary.class.getName())) { abd.setPrimary(true); } ....... } æœ€åè¿˜æœ‰ä¸ªæ³¨å†ŒBeanDefinitionçš„æ–¹æ³•ï¼Œå‰é¢å·²ç»è®²è¿‡äº†ï¼Œä¸å†èµ˜è¿°ã€‚ åˆ°æ­¤doScan()æ–¹æ³•å°±ç»“æŸäº†ï¼Œæ­¤æ—¶å·²ç»å°†è¢«æ³¨è§£çš„ç±»çš„ä¿¡æ¯ï¼Œå…¨éƒ¨å°è£…åˆ°BeanDefinitionä¸­è¿”å›ã€‚ C.registerComponentsè¯¥æ–¹æ³•ä¸»è¦å°†æ‰«æçš„ç±»çš„å†…éƒ¨çš„@Autowiredã€@Resourceã€@PostConstructã€@PreDestroyç­‰æ³¨è§£æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œåé¢ä¼šè¯¦è§£è¿™ç±»æ³¨è§£ã€‚ 1234567891011121314151617181920protected void registerComponents( XmlReaderContext readerContext, Set&lt;BeanDefinitionHolder&gt; beanDefinitions, Element element) { ... // Register annotation config processors, if necessary. boolean annotationConfig = true; if (element.hasAttribute(ANNOTATION_CONFIG_ATTRIBUTE)) { annotationConfig = Boolean.valueOf(element.getAttribute(ANNOTATION_CONFIG_ATTRIBUTE)); } if (annotationConfig) { //ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³• Set&lt;BeanDefinitionHolder&gt; processorDefinitions = AnnotationConfigUtils.registerAnnotationConfigProcessors(readerContext.getRegistry(), source); for (BeanDefinitionHolder processorDefinition : processorDefinitions) { compositeDef.addNestedComponent(new BeanComponentDefinition(processorDefinition)); } } readerContext.fireComponentRegistered(compositeDef); } 12345678910111213141516171819202122232425262728293031323334public static Set&lt;BeanDefinitionHolder&gt; registerAnnotationConfigProcessors( BeanDefinitionRegistry registry, @Nullable Object source) { ...... //åˆ›å»ºBeanDefinitionHolderé›†åˆï¼Œåé¢å°±è¦å‘è¿™é‡Œé¢æ·»åŠ BeanDefinition Set&lt;BeanDefinitionHolder&gt; beanDefs = new LinkedHashSet&lt;&gt;(8); if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) { //ConfigurationClassPostProcessorï¼Œå¤„ç†@Configurationæ³¨è§£çš„ç±»ï¼Œæ³¨å†Œåˆ°å®¹å™¨ RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); } if (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) { //å¤„ç†Autowiredæ³¨è§£çš„ç±»ï¼Œæ³¨å†Œåˆ°å®¹å™¨ RootBeanDefinition def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)); } // Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor. //å’Œå®ä¾‹åŒ–æœ‰å…³çš„@PostConstructã€@PreDestroyç­‰æ³¨è§£ï¼Œæ³¨å†Œåˆ°å®¹å™¨ if (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) { RootBeanDefinition def = new RootBeanDefinition(CommonAnnotationBeanPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)); } .....å…¶ä»–çš„ä¸€äº›æ³¨è§£...... //è¿”å›è¯¥é›†åˆ return beanDefs; } å‘¼å‘¼ï¼Œåˆ°è¿™é‡ŒSpringçš„åˆå§‹åŒ–æœºåˆ¶å°±è®²å®Œäº†ï¼Œåé¢ç»§ç»­è®²beançš„å®ä¾‹åŒ–ã€‚ æ€»ç»“å¯ä»¥çœ‹åˆ°ï¼Œè§£æé…ç½®æ–‡ä»¶åˆå§‹åŒ–beançš„æµç¨‹ä¸­ï¼Œéƒ½ä¼šå°†beanå°è£…ä¸ºBeanDefinitionå¯¹è±¡ï¼Œç„¶åæ ¹æ®beançš„å±æ€§ï¼Œbeançš„å­æ ‡ç­¾ç­‰å¾…ï¼Œå°†å…¶åŒ…è£…æˆå¯¹åº”çš„ç±»ä¿å­˜åˆ°BeanDefinitionå¯¹è±¡ä¸­ï¼Œæœ€åå†å°†BeanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚ æ ¸å¿ƒæ–¹æ³•åœ¨refreshæ–¹æ³•çš„obtainFreshBeanFactoryä¸­æ‰§è¡Œ åˆ›å»ºBeanFactoryï¼Œè°ƒç”¨loadBeanDefinitionså§”æ‰˜XMLè§£æå™¨XmlBeanDefinitionReaderè¿›è¡Œè§£æ ä»loadBeanDefinitionsåˆ°çœŸæ­£å¼€å§‹è§£ææ ‡ç­¾è¿‡ç¨‹ä¸­ï¼Œå…ˆè·å–é…ç½®æ–‡ä»¶åœ°å€ï¼Œå°†å…¶å°è£…æˆResourceå¯¹è±¡ï¼Œç„¶åå†å°è£…æˆå¸¦ç¼–ç çš„EncodedResourceï¼Œå†è·å–å…¶è¾“å…¥æµInputStreamæ„é€ è§£æxmlçš„InputSourceç±»ï¼Œæœ€åå°è£…ä¸ºDocumentå¯¹è±¡ å§”æ‰˜BeanDefinitionDocumentReaderå¯¹Documentè¿›è¡Œè§£æï¼Œæ ¹æ®Documentçš„æ ¹èŠ‚ç‚¹ï¼Œè·å–å…¶æ‰€æœ‰å­èŠ‚ç‚¹å¼€å§‹è§£æ è§£æåˆ†ä¸ºé»˜è®¤æ ‡ç­¾è§£æå’Œè‡ªå®šä¹‰æ ‡ç­¾è§£æ åœ¨é»˜è®¤æ ‡ç­¾è§£æä¸­å¯¹beanæ ‡ç­¾è¿›è¡Œè§£æ è§£æbeanå¹¶å°è£…åˆ°BeanDefinitionè¿”å› åˆ›å»º==GenericBeanDefinition==å¯¹è±¡ï¼› è§£æbeançš„å±æ€§ï¼Œå¹¶ä¿å­˜åˆ°BeanDefinition **(singleton/ scope/ abstract/ lazy-init/ autowire/ depends-on / autowire-candidate/ primary/ init-method/ destroy-method/ factory-method/ factory-beanç­‰å±æ€§)** è§£æbeançš„å­æ ‡ç­¾ï¼Œå°è£…åˆ°å¯¹åº”çš„ç±»ä¸­å¹¶ä¿å­˜åˆ°BeanDefinitionä¸­ å¯¹åº”æ ‡ç­¾å°è£…ç±»ï¼š lookup-method: ==LookupOverride== replace-method: ==ReplaceOverride== constructor-arg: ==ConstructorArgumentValues== property: å°è£…åˆ° PropertyValueï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°BeanDefinitionçš„==MutablePropertyValues==ä¸­ ï¼ˆè¿˜æœ‰å…¶ä»–ä¸é‡è¦çš„æ ‡ç­¾å°±æ²¡æœ‰åˆ—ä¸¾ï¼‰ åŸºäºSPIæœåŠ¡å‘ç°å’Œè£…é¥°è€…æ¨¡å¼å¯¹BeanDefinitionè¿›è¡Œè£…é¥° è·å–å½“å‰èŠ‚ç‚¹çš„å‘½åç©ºé—´ æ‰«æSpringåŒ…ä¸‹çš„æ‰€æœ‰spring.handlersæ–‡ä»¶ï¼Œ è·å–å‘½åç©ºé—´å’Œå¯¹åº”å¤„ç†ç±»çš„æ˜ å°„å…³ï¼ˆmapï¼‰ è·å–å½“å‰æ ‡ç­¾çš„å‘½åç©ºé—´çš„å¤„ç†ç±»ï¼Œä½¿ç”¨åå°„æ–¹å¼å®ä¾‹åŒ– è°ƒç”¨handle.init()æ–¹æ³•å°†è¿™äº›å‘½åç©ºé—´ä¸‹çš„æ ‡ç­¾å…ƒç´ å’Œå…¶å¤„ç†ç±»è¿›è¡Œæ³¨å†Œï¼Œä»¥æ ‡ç­¾åå’Œå¤„ç†ç±»çš„çš„æ˜ å°„å…³ç³»æ³¨å†Œåˆ°åä¸ºparsersçš„Mapä¸­ è¿”å›å½“å‰èŠ‚ç‚¹çš„å¤„ç†ç±»è¿›è¡Œè£…é¥° è¿›è¡Œç¼“å­˜æ³¨å†Œ beanNameå’ŒBeanDefinitionæ³¨å†Œåˆ°beanDefinitionMap æŠŠbeanNameæ”¾åˆ°beanDefinitionNames ä¸­ï¼ˆä¸€ä¸ªListé›†åˆï¼Œè£…äº†æ‰€æœ‰çš„beanåç§°ï¼‰ åœ¨è‡ªå®šä¹‰æ ‡ç­¾è§£æ å†…å®¹åŒä¸Šå¤šäº†parseæ–¹æ³•ï¼š å¦‚ï¼šComponentScanBeanDefinitionParserçš„parse()ï¼ˆ&lt;context:component-scan base-package=&quot;com.test&quot; /&gt;æ ‡ç­¾çš„å¤„ç†ï¼‰ è·å–è¦æ‰«æçš„åŒ…è·¯å¾„ åˆ›å»ºæ³¨è§£æ‰«æå™¨ å¹¶ å°†è¦æ‰«æçš„é»˜è®¤æ³¨è§£æ³¨å†Œåˆ°includeFiltersï¼Œå¦‚@Component æ‰«æå­æ ‡ç­¾&lt;include-filter&gt;å’Œ&lt;exclude-filter&gt;ï¼Œå°†é…ç½®çš„æ³¨è§£åˆ†åˆ«æ³¨å†Œåˆ°includeFilterså’ŒexcludeFilters doScanï¼Œå°†å¸¦æ³¨è§£çš„ç±»å°è£…æˆBeanDefinitionå¯¹è±¡ï¼Œå¹¶æ ¹æ®ç±»ä¸­çš„ä¿¡æ¯(ç±»ä»¥åŠæ³¨è§£ä¿¡æ¯)ï¼Œå…¨éƒ¨è®¾ç½®åˆ°BeanDefinitionä¸­ï¼Œå¹¶è¿›è¡Œæ³¨å†Œï¼Œè¿”å›BeanDefinitioné›†åˆ æ³¨å†Œç±»ä¸­çš„@Configurationï¼Œ@Autowiredã€@Resourceã€@PostConstructã€@PreDestroyç­‰æ³¨è§£ æµç¨‹å›¾ï¼šã€è½¬è½½è¯·æ ‡æ˜åœ°å€ã€‘","link":"/posts/20200409-spring-container-process.html"}],"tags":[{"name":"elasticsearch","slug":"elasticsearch","link":"/tags/elasticsearch/"},{"name":"docker","slug":"docker","link":"/tags/docker/"},{"name":"centos7","slug":"centos7","link":"/tags/centos7/"},{"name":"firewall","slug":"firewall","link":"/tags/firewall/"},{"name":"linux","slug":"linux","link":"/tags/linux/"},{"name":"gulp,å‹ç¼©é™æ€èµ„æº","slug":"gulp-å‹ç¼©é™æ€èµ„æº","link":"/tags/gulp-%E5%8E%8B%E7%BC%A9%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90/"},{"name":"jib","slug":"jib","link":"/tags/jib/"},{"name":"æ–‡ä»¶ä¸Šä¼ ","slug":"æ–‡ä»¶ä¸Šä¼ ","link":"/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"},{"name":"fdfs","slug":"fdfs","link":"/tags/fdfs/"},{"name":"æ’åº","slug":"æ’åº","link":"/tags/%E6%8E%92%E5%BA%8F/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","link":"/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"äºŒå‰æ ‘","slug":"äºŒå‰æ ‘","link":"/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/"},{"name":"è°ƒåº¦ç®—æ³•","slug":"è°ƒåº¦ç®—æ³•","link":"/tags/%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/"},{"name":"åˆ†æ²»","slug":"åˆ†æ²»","link":"/tags/%E5%88%86%E6%B2%BB/"},{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","link":"/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"name":"fork/join","slug":"fork-join","link":"/tags/fork-join/"},{"name":"CountDownLatch","slug":"CountDownLatch","link":"/tags/CountDownLatch/"},{"name":"CyclicBarrier","slug":"CyclicBarrier","link":"/tags/CyclicBarrier/"},{"name":"Semaphore","slug":"Semaphore","link":"/tags/Semaphore/"},{"name":"Runnable","slug":"Runnable","link":"/tags/Runnable/"},{"name":"Callable","slug":"Callable","link":"/tags/Callable/"},{"name":"Future","slug":"Future","link":"/tags/Future/"},{"name":"FutureTask","slug":"FutureTask","link":"/tags/FutureTask/"},{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","link":"/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"},{"name":"CAS","slug":"CAS","link":"/tags/CAS/"},{"name":"åŸå­æ“ä½œç±»","slug":"åŸå­æ“ä½œç±»","link":"/tags/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%B1%BB/"},{"name":"AtomicXXX","slug":"AtomicXXX","link":"/tags/AtomicXXX/"},{"name":"AQS","slug":"AQS","link":"/tags/AQS/"},{"name":"æ˜¾ç¤ºé”Lock","slug":"æ˜¾ç¤ºé”Lock","link":"/tags/%E6%98%BE%E7%A4%BA%E9%94%81Lock/"},{"name":"LockSupport","slug":"LockSupport","link":"/tags/LockSupport/"},{"name":"ReentrantLock","slug":"ReentrantLock","link":"/tags/ReentrantLock/"},{"name":"ReentrantReadWriteLock","slug":"ReentrantReadWriteLock","link":"/tags/ReentrantReadWriteLock/"},{"name":"è¯»å†™é”","slug":"è¯»å†™é”","link":"/tags/%E8%AF%BB%E5%86%99%E9%94%81/"},{"name":"BST","slug":"BST","link":"/tags/BST/"},{"name":"äºŒå‰æŸ¥æ‰¾æ ‘","slug":"äºŒå‰æŸ¥æ‰¾æ ‘","link":"/tags/%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91/"},{"name":"AVL","slug":"AVL","link":"/tags/AVL/"},{"name":"å¹³è¡¡æ ‘","slug":"å¹³è¡¡æ ‘","link":"/tags/%E5%B9%B3%E8%A1%A1%E6%A0%91/"},{"name":"æ•£åˆ—è¡¨","slug":"æ•£åˆ—è¡¨","link":"/tags/%E6%95%A3%E5%88%97%E8%A1%A8/"},{"name":"ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—","slug":"ç´¢å¼•ä¼˜å…ˆé˜Ÿåˆ—","link":"/tags/%E7%B4%A2%E5%BC%95%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/"},{"name":"ä¼˜å…ˆé˜Ÿåˆ—","slug":"ä¼˜å…ˆé˜Ÿåˆ—","link":"/tags/%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/"},{"name":"IndexPQ","slug":"IndexPQ","link":"/tags/IndexPQ/"},{"name":"æ•°æ®ç»“æ„ä¸ç®—æ³•","slug":"æ•°æ®ç»“æ„ä¸ç®—æ³•","link":"/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"},{"name":"union-find","slug":"union-find","link":"/tags/union-find/"},{"name":"å¹¶æŸ¥é›†","slug":"å¹¶æŸ¥é›†","link":"/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/"},{"name":"è·¯å¾„å‹ç¼©","slug":"è·¯å¾„å‹ç¼©","link":"/tags/%E8%B7%AF%E5%BE%84%E5%8E%8B%E7%BC%A9/"},{"name":"æŸ¥æ‰¾","slug":"æŸ¥æ‰¾","link":"/tags/%E6%9F%A5%E6%89%BE/"},{"name":"å †","slug":"å †","link":"/tags/%E5%A0%86/"},{"name":"å †æ’åº","slug":"å †æ’åº","link":"/tags/%E5%A0%86%E6%8E%92%E5%BA%8F/"},{"name":"PriorityQueue","slug":"PriorityQueue","link":"/tags/PriorityQueue/"},{"name":"æœ€çŸ­è·¯å¾„","slug":"æœ€çŸ­è·¯å¾„","link":"/tags/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84/"},{"name":"Dijkstra","slug":"Dijkstra","link":"/tags/Dijkstra/"},{"name":"çº¢é»‘æ ‘","slug":"çº¢é»‘æ ‘","link":"/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/"},{"name":"æœ€å°ç”Ÿæˆæ ‘","slug":"æœ€å°ç”Ÿæˆæ ‘","link":"/tags/%E6%9C%80%E5%B0%8F%E7%94%9F%E6%88%90%E6%A0%91/"},{"name":"prim","slug":"prim","link":"/tags/prim/"},{"name":"kruskal","slug":"kruskal","link":"/tags/kruskal/"},{"name":"å›¾","slug":"å›¾","link":"/tags/%E5%9B%BE/"},{"name":"dfs","slug":"dfs","link":"/tags/dfs/"},{"name":"bfs","slug":"bfs","link":"/tags/bfs/"},{"name":"æ‹“æ‰‘æ’åº","slug":"æ‹“æ‰‘æ’åº","link":"/tags/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/"},{"name":"äºŒåˆ†å›¾","slug":"äºŒåˆ†å›¾","link":"/tags/%E4%BA%8C%E5%88%86%E5%9B%BE/"},{"name":"è¿é€šæ€§","slug":"è¿é€šæ€§","link":"/tags/%E8%BF%9E%E9%80%9A%E6%80%A7/"},{"name":"JVM","slug":"JVM","link":"/tags/JVM/"},{"name":"åƒåœ¾æ”¶é›†å™¨","slug":"åƒåœ¾æ”¶é›†å™¨","link":"/tags/%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/"},{"name":"GC","slug":"GC","link":"/tags/GC/"},{"name":"ä¸‰è‰²æ ‡è®°","slug":"ä¸‰è‰²æ ‡è®°","link":"/tags/%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0/"},{"name":"å››å¤§å¼•ç”¨","slug":"å››å¤§å¼•ç”¨","link":"/tags/%E5%9B%9B%E5%A4%A7%E5%BC%95%E7%94%A8/"},{"name":"spring","slug":"spring","link":"/tags/spring/"},{"name":"IOC","slug":"IOC","link":"/tags/IOC/"}],"categories":[{"name":"docker","slug":"docker","link":"/categories/docker/"},{"name":"linux","slug":"linux","link":"/categories/linux/"},{"name":"å·¥å…·","slug":"å·¥å…·","link":"/categories/%E5%B7%A5%E5%85%B7/"},{"name":"springboot","slug":"springboot","link":"/categories/springboot/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"æ’åº","slug":"æ•°æ®ç»“æ„/æ’åº","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%8E%92%E5%BA%8F/"},{"name":"äºŒå‰æ ‘","slug":"æ•°æ®ç»“æ„/äºŒå‰æ ‘","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91/"},{"name":"æ“ä½œç³»ç»Ÿ","slug":"æ“ä½œç³»ç»Ÿ","link":"/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"name":"å¹¶å‘ç¼–ç¨‹","slug":"å¹¶å‘ç¼–ç¨‹","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},{"name":"å¹¶å‘å·¥å…·ç±»","slug":"å¹¶å‘ç¼–ç¨‹/å¹¶å‘å·¥å…·ç±»","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"åŸå­æ“ä½œCAS","slug":"å¹¶å‘ç¼–ç¨‹/åŸå­æ“ä½œCAS","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9CCAS/"},{"name":"æ˜¾ç¤ºé”å’ŒAQS","slug":"å¹¶å‘ç¼–ç¨‹/æ˜¾ç¤ºé”å’ŒAQS","link":"/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E6%98%BE%E7%A4%BA%E9%94%81%E5%92%8CAQS/"},{"name":"æŸ¥æ‰¾","slug":"æ•°æ®ç»“æ„/æŸ¥æ‰¾","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%9F%A5%E6%89%BE/"},{"name":"æ•£åˆ—è¡¨","slug":"æ•°æ®ç»“æ„/æ•£åˆ—è¡¨","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%A3%E5%88%97%E8%A1%A8/"},{"name":"ä¼˜å…ˆé˜Ÿåˆ—","slug":"æ•°æ®ç»“æ„/ä¼˜å…ˆé˜Ÿåˆ—","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/"},{"name":"å¹¶æŸ¥é›†","slug":"æ•°æ®ç»“æ„/å¹¶æŸ¥é›†","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%B9%B6%E6%9F%A5%E9%9B%86/"},{"name":"å›¾","slug":"æ•°æ®ç»“æ„/å›¾","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%9B%BE/"},{"name":"JVM","slug":"JVM","link":"/categories/JVM/"},{"name":"Spring","slug":"Spring","link":"/categories/Spring/"}]}